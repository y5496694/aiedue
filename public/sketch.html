<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Excalidraw 웹 앱</title>
    
    <!-- Tailwind CSS 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React 및 ReactDOM 로드 -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Excalidraw 라이브러리 로드 -->
    <script src="https://unpkg.com/@excalidraw/excalidraw@0.17.5/dist/excalidraw.production.min.js" crossorigin></script>
    
    <!-- JSX를 브라우저에서 직접 변환하기 위한 Babel 로드 -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Excalidraw가 전체 화면을 차지하도록 스타일 설정 */
        html, body, #root {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
        }
        #root {
            display: flex;
            flex-direction: column;
        }
        .excalidraw-wrapper {
            flex-grow: 1; /* 남은 공간을 모두 차지하도록 설정 */
            position: relative; /* Excalidraw가 이 컨테이너를 기준으로 렌더링되도록 함 */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDocs, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref as storageRef, uploadBytes, getBlob } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDCeJPDQUNi-KmJ9DhkTRIu-9t2PGZCpt0",
            authDomain: "mansungcoin-c6e06.firebaseapp.com",
            projectId: "mansungcoin-c6e06",
            storageBucket: "mansungcoin-c6e06.firebasestorage.app",
            messagingSenderId: "704809284946",
            appId: "1:704809284946:web:3e71d8f38810577e1768b"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        window.addEventListener('load', () => {
            const Excalidraw = window.ExcalidrawLib.Excalidraw;

            function App() {
                const [excalidrawAPI, setExcalidrawAPI] = React.useState(null);
                const [user, setUser] = React.useState(null);
                const searchParams = React.useMemo(() => new URLSearchParams(window.location.search), []);
                const [currentSketchId, setCurrentSketchId] = React.useState(searchParams.get('sketchId'));
                
                const addFilesToScene = React.useCallback((filesData) => {
                    if (!excalidrawAPI || !filesData) return;
                    let filesArray = Array.isArray(filesData) ? filesData : Object.values(filesData || {});
                    if (filesArray.length > 0) {
                        excalidrawAPI.addFiles(filesArray);
                    }
                }, [excalidrawAPI]);

                React.useEffect(() => {
                    const unsub = onAuthStateChanged(auth, (u) => setUser(u));
                    return () => unsub();
                }, []);

                React.useEffect(() => {
                    // URL에 sketchId가 없으면 아무것도 로드하지 않습니다.
                    // 실제 앱에서는 목록 페이지나 기본 스케치로 리디렉션할 수 있습니다.
                    if (!currentSketchId) {
                         // ID가 없으면 빈 캔버스로 시작하도록 보장
                        if (excalidrawAPI) {
                            excalidrawAPI.updateScene({ elements: [], appState: { zenMode: false, viewMode: false } });
                        }
                        console.log("No sketchId found in URL.");
                    }
                }, [currentSketchId, excalidrawAPI]);


                React.useEffect(() => {
                    if (user && excalidrawAPI && currentSketchId) {
                        (async () => {
                            try {
                                const fileRef = storageRef(storage, `sketch/${user.uid}/${currentSketchId}.excalidraw`);
                                const blob = await getBlob(fileRef);
                                const text = await blob.text();
                                const data = JSON.parse(text);
                                
                                addFilesToScene(data.files);
                                
                                const appState = {
                                    ...data.appState,
                                    zenMode: false, 
                                    viewMode: false,
                                    collaborators: new Map(Object.entries(data.appState?.collaborators || {}))
                                };
                                excalidrawAPI.updateScene({ elements: data.elements, appState, commitToHistory: true });
                            } catch (error) {
                                if (error?.code === 'storage/object-not-found') {
                                    console.info('저장된 스케치가 없어 새 스케치북으로 시작합니다.');
                                    excalidrawAPI.updateScene({ elements: [], appState: { zenMode: false, viewMode: false } });
                                    return;
                                }
                                console.error('스케치북 데이터를 불러오는 중 오류가 발생했습니다.', error);
                                alert('스케치북을 불러오는 중 문제가 발생했습니다. 다시 시도해주세요.');
                            }
                        })();
                    }
                }, [user, excalidrawAPI, currentSketchId, addFilesToScene]);

                const handleSave = async () => {
                    if (!excalidrawAPI || !user || !currentSketchId) {
                        alert('저장할 수 없습니다. (사용자 또는 스케치 정보 없음)');
                        return;
                    };
                    const elements = excalidrawAPI.getSceneElements();
                    const appState = excalidrawAPI.getAppState();
                    const collaboratorsEntries = appState.collaborators instanceof Map
                        ? Array.from(appState.collaborators.entries())
                        : Object.entries(appState.collaborators || {});
                    const appStateToSave = {
                        ...appState,
                        collaborators: Object.fromEntries(collaboratorsEntries),
                    };
                    const filesMap = excalidrawAPI.getFiles ? excalidrawAPI.getFiles() : new Map();
                    const files = filesMap instanceof Map
                        ? Object.fromEntries(filesMap.entries())
                        : Object.fromEntries(Object.entries(filesMap || {}));

                    const data = JSON.stringify({
                        type: 'excalidraw', version: 2, source: 'https://gemini.google.com',
                        elements, appState: appStateToSave, files,
                    }, null, 2);

                    const fileRef = storageRef(storage, `sketch/${user.uid}/${currentSketchId}.excalidraw`);
                    await uploadBytes(fileRef, new Blob([data], { type: 'application/json' }));
                    
                    try {
                        await updateDoc(doc(db, 'users', user.uid, 'sketches', currentSketchId), {
                            updatedAt: serverTimestamp()
                        });
                    } catch (error) {
                        console.error('스케치 정보를 업데이트하는 데 실패했습니다.', error);
                    }
                    alert('저장되었습니다.');
                };

                return (
                    <>
                        {/* Excalidraw 캔버스 영역 */}
                        <div className="excalidraw-wrapper">
                            <Excalidraw
                                excalidrawAPI={(api) => setExcalidrawAPI(api)}
                                langCode="ko-KR"
                                // 젠모드와 보기모드를 비활성화하여 더블클릭 문제를 해결합니다.
                                zenModeEnabled={false}
                                viewModeEnabled={false}
                                UIOptions={{
                                    // 상단 메뉴바의 대부분 기능을 숨깁니다.
                                    canvasActions: {
                                        clearCanvas: false,
                                        export: false,
                                        loadScene: false,
                                        saveToActiveFile: false,
                                        toggleTheme: false,
                                        saveAsImage: false,
                                    },
                                    // 좌측 상단 메뉴 버튼을 숨깁니다.
                                    welcomeScreen: {
                                        hints: {
                                             menu: false,
                                             toolbar: true, // 도구모음은 계속 표시
                                             help: false
                                         }
                                    }
                                }}
                            />
                        </div>

                        {/* 오른쪽 하단에 고정된 저장 버튼 */}
                        <button
                            onClick={handleSave}
                            className="fixed bottom-8 right-8 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-5 rounded-full shadow-lg z-20 flex items-center justify-center transition-transform transform hover:scale-105"
                            title="스케치 저장"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                            <span className="ml-2">저장</span>
                        </button>
                    </>
                );
            }

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        });
    </script>
</body>
</html>

