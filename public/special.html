<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>에이두 스페셜 - 특수교사 업무 보조</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Noto Sans KR', sans-serif; }
        .content-section {
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: white;
        }
        .content-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
        }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #0ea5e9; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .nav-link { padding: 0.5rem 1rem; border-radius: 0.375rem; transition: background-color 0.2s, color 0.2s; }
        .nav-link.active { background-color: #0284c7; color: white; }
        .nav-link:not(.active):hover { background-color: #f3f4f6; }
        .tab-btn {
             transition: all 0.2s;
             border: 2px solid transparent;
        }
        .tab-btn.active {
             background-color: #0ea5e9; /* sky-500 */
             color: white;
             border-color: #0284c7; /* sky-600 */
             font-weight: 600;
        }
        .tab-btn:not(.active) {
            background-color: #f1f5f9; /* slate-100 */
            color: #475569; /* slate-600 */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="app">
        <!-- Auth View (Login/Signup) -->
        <div id="auth-view" class="min-h-screen flex items-center justify-center bg-gray-100">
            <div class="w-full max-w-md bg-white rounded-lg shadow-md p-8">
                <h2 class="text-2xl font-bold text-center text-sky-600 mb-6">에이두 스페셜 시작하기</h2>
                <form id="auth-form" onsubmit="return false;">
                    <div class="mb-4">
                        <label for="email" class="block text-gray-700 text-sm font-bold mb-2">이메일</label>
                        <input type="email" id="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-gray-700 text-sm font-bold mb-2">비밀번호</label>
                        <input type="password" id="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <p id="auth-error" class="text-red-500 text-xs italic mb-4 hidden"></p>
                    <div class="flex items-center justify-between">
                        <button type="button" id="login-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">로그인</button>
                        <button type="button" id="signup-btn" class="inline-block align-baseline font-bold text-sm text-sky-600 hover:text-sky-800">계정이 없으신가요? 회원가입</button>
                    </div>
                    <div class="my-4 flex items-center">
                        <div class="flex-grow border-t border-gray-300"></div>
                        <span class="flex-shrink mx-4 text-gray-400 text-sm">또는</span>
                        <div class="flex-grow border-t border-gray-300"></div>
                    </div>
                    <button type="button" id="google-login-btn" class="w-full bg-white border border-gray-300 text-gray-700 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline flex items-center justify-center gap-2 hover:bg-gray-50 transition-colors">
                        <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                        Google 계정으로 로그인
                    </button>
                </form>
            </div>
        </div>

        <!-- Main App View -->
        <div id="main-app-view" class="hidden flex-col min-h-screen">
            <header class="bg-white shadow-md w-full sticky top-0 z-50">
                <div class="container mx-auto px-6 py-3 flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-sky-600"><a href="#home" id="home-link">📝 에이두 스페셜</a></h1>
                    <nav class="flex items-center gap-4">
                        <span id="user-email" class="text-sm text-gray-600"></span>
                        <a href="#home" id="nav-home" class="nav-link">홈</a>
                        <a href="#my-class" id="nav-my-class" class="nav-link">내 학급 관리</a>
                        <!-- IEP navigation link; '개별화교육계획' is commonly referred to as 'IEP'. Modify this section when updating 'iep'. -->
                        <a href="#iep" id="nav-iep" class="nav-link">개별화교육계획(IEP)</a>
                        <a href="#behavior" id="nav-behavior" class="nav-link">행동 중재</a>
                        <button id="logout-btn" class="text-sm bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-md transition-colors">로그아웃</button>
                    </nav>
                </div>
            </header>
            <main class="flex-grow container mx-auto p-6">
                <!-- Home View -->
                <div id="home-view">
                    <h2 class="text-3xl font-bold mb-6">홈</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-2">안녕하세요, <span id="home-user-email"></span> 선생님!</h3>
                            <p class="text-gray-600 mb-4">에이두 스페셜과 함께 특수학급 업무를 효율적으로 관리해보세요.</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-4">업무 통계</h3>
                             <div id="stats-chart-container" class="h-48 flex items-center justify-center">
                                <canvas id="statsChart"></canvas>
                            </div>
                        </div>
                        <div class="md:col-span-2 lg:col-span-3 bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-4">내 학급 목록</h3>
                            <div id="home-class-list" class="space-y-3">
                                <!-- Class list will be dynamically inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- My Class View -->
                <div id="my-class-view" class="hidden">
                    <h2 class="text-3xl font-bold mb-6">내 학급 관리</h2>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <div id="class-header" class="flex justify-between items-center mb-4">
                            <h3 id="class-title" class="text-xl font-bold">내 학급</h3>
                            <button id="add-class-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded">내 학급 만들기</button>
                        </div>
                        <div id="class-list" class="space-y-3">
                            <!-- Class items will be dynamically inserted here -->
                        </div>
                    </div>
                </div>
                
                <!-- IEP View -->
                <div id="iep-view" class="hidden">
                     <h2 class="text-3xl font-bold mb-6">개별화교육계획(IEP) 수립</h2>
                     <div class="flex flex-col lg:flex-row gap-6">
                        <aside class="w-full lg:w-1/3 bg-white p-6 rounded-lg shadow-lg h-fit lg:sticky top-24">
                            <h3 class="text-lg font-semibold mb-4">내 학급</h3>
                            <div id="iep-student-list" class="grid grid-cols-4 gap-2">
                                <!-- 학생 목록이 여기에 표시됩니다. -->
                            </div>
                            <div id="iep-modify-section" class="mt-6 hidden">
                                <h4 class="font-semibold mb-2">출력 내용 수정</h4>
                                <textarea id="iep-modify-input" class="w-full border rounded-md p-2 text-sm" rows="3" placeholder="수정할 내용을 입력하고 Enter를 누르세요"></textarea>
                            </div>
                        </aside>
                        <section class="w-full lg:w-2/3">
                            <div id="iep-output" class="bg-white p-8 rounded-lg shadow-lg">
                                <p class="text-gray-500">학생을 선택하면 IEP 정보가 표시됩니다.</p>
                            </div>
                        </section>
                    </div>
                </div>

                <!-- Behavior Intervention View -->
                <div id="behavior-view" class="hidden">
                    <h2 class="text-3xl font-bold mb-6">행동 중재</h2>
                     <div class="flex flex-col lg:flex-row gap-6">
                        <aside class="w-full lg:w-1/3 bg-white p-6 rounded-lg shadow-lg h-fit lg:sticky top-24 space-y-6">
                            <div>
                                <h3 class="text-lg font-semibold mb-4">학생 및 행동 선택</h3>
                                <div class="space-y-4">
                                     <div>
                                        <label for="behavior-student-name" class="block text-sm font-medium text-gray-700">학생 이름</label>
                                        <input type="text" id="behavior-student-name" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="관찰할 학생 이름">
                                    </div>
                                    <div>
                                        <label for="target-behavior" class="block text-sm font-medium text-gray-700">목표 행동</label>
                                        <input type="text" id="target-behavior" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="예: 바르게 앉아 있기">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">행동 유형</label>
                                        <div id="behavior-type-buttons" class="grid grid-cols-2 gap-2">
                                            <button type="button" data-value="increase" class="tab-btn py-2 px-2 rounded text-sm active">증가시킬 행동</button>
                                            <button type="button" data-value="decrease" class="tab-btn py-2 px-2 rounded text-sm">감소시킬 행동</button>
                                        </div>
                                    </div>
                                    <button id="start-observation-btn" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg">관찰 시작</button>
                                </div>
                            </div>
                            <div id="behavior-logging-section" class="hidden">
                                <h3 class="text-lg font-semibold mb-4">행동 기록</h3>
                                <p class="text-sm text-gray-600 mb-1">학생: <span id="logging-student" class="font-bold"></span></p>
                                <p class="text-sm text-gray-600 mb-4">목표 행동: <span id="logging-behavior" class="font-bold"></span></p>
                                <button id="log-behavior-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-4 rounded-lg text-lg">행동 발생 (+1)</button>
                            </div>
                        </aside>
                        <section class="w-full lg:w-2/3">
                            <div class="content-section">
                                <h3 class="text-xl font-bold mb-4">행동 관찰 그래프</h3>
                                <div id="behavior-chart-container" class="h-96">
                                    <canvas id="behaviorChart"></canvas>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>

                <!-- Achievement Criteria View -->
                <div id="achievement-view" class="hidden">
                    <h2 class="text-3xl font-bold mb-6">성취기준 기록</h2>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <button id="back-to-class-btn" class="text-sm text-sky-600 hover:underline mb-4">&larr; 내 학급으로</button>
                        <h3 id="achievement-student" class="text-xl font-bold mb-4"></h3>
                        <div class="mb-4 space-y-4">
                            <div>
                                <span class="font-semibold mr-2">학교급</span>
                                <div id="level-buttons" class="inline-flex gap-2">
                                    <button data-value="elementary" class="tab-btn py-1 px-3 rounded active">초등학교</button>
                                    <button data-value="middle" class="tab-btn py-1 px-3 rounded">중학교</button>
                                    <button data-value="high" class="tab-btn py-1 px-3 rounded">고등학교</button>
                                </div>
                            </div>
                            <div>
                                <span class="font-semibold mr-2">교과</span>
                                <div id="subject-buttons" class="inline-flex gap-2">
                                    <button data-value="korean" class="tab-btn py-1 px-3 rounded active">국어</button>
                                    <button data-value="math" class="tab-btn py-1 px-3 rounded">수학</button>
                                </div>
                            </div>
                            <div>
                                <span class="font-semibold mr-2">학년(군)</span>
                                <div id="grade-buttons" class="inline-flex gap-2"></div>
                            </div>
                        </div>
                        <button id="save-achievement-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded mb-4">저장</button>
                        <div id="achievement-table" class="overflow-x-auto"></div>
                    </div>
                </div>

            </main>
        </div>
        
        <!-- Toast Message -->
        <div id="toast" class="fixed bottom-10 right-10 bg-gray-900 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-300">
             복사되었습니다!
        </div>
    </div>

    <script type="module">
        // Firebase v10 SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, getDocs, doc, getDoc, setDoc, updateDoc, serverTimestamp, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            // Your web app's Firebase configuration
            apiKey: "AIzaSyDCeJPDQUNi-KmJ9DhkTRIu-9t2PGZCpt0",
            authDomain: "mansungcoin-c6e06.firebaseapp.com",
            projectId: "mansungcoin-c6e06",
            storageBucket: "mansungcoin-c6e06.appspot.com",
            messagingSenderId: "704809284946",
            appId: "1:704809284946:web:54e4788586e6c68de1768b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const authView = document.getElementById('auth-view');
        const mainAppView = document.getElementById('main-app-view');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const authError = document.getElementById('auth-error');
        const userEmailSpan = document.getElementById('user-email');
        const homeUserEmailSpan = document.getElementById('home-user-email');
        const toast = document.getElementById('toast');
        const levelButtons = document.getElementById('level-buttons');
        const subjectButtons = document.getElementById('subject-buttons');
        const gradeButtons = document.getElementById('grade-buttons');
        const saveAchievementBtn = document.getElementById('save-achievement-btn');
        const achievementTableContainer = document.getElementById('achievement-table');
        const backToClassBtn = document.getElementById('back-to-class-btn');
        let currentAchievementStudent = '';
        let currentAchievementData = {};

        // Views and Navs
        const views = {
            home: document.getElementById('home-view'),
            'my-class': document.getElementById('my-class-view'),
            iep: document.getElementById('iep-view'),
            behavior: document.getElementById('behavior-view'),
            achievement: document.getElementById('achievement-view'),
        };
        const navLinks = {
            home: document.getElementById('nav-home'),
            'my-class': document.getElementById('nav-my-class'),
            iep: document.getElementById('nav-iep'),
            behavior: document.getElementById('nav-behavior'),
        };
        
        let statsChartInstance = null;
        let behaviorChartInstance = null;
        let isLoadingHomeData = false;

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, user => {
            if (user) {
                authView.classList.add('hidden');
                mainAppView.classList.remove('hidden');
                mainAppView.classList.add('flex');
                userEmailSpan.textContent = user.email;
                homeUserEmailSpan.textContent = user.email;
                // Handle routing based on hash
                const currentView = window.location.hash.replace('#', '') || 'home';
                switchView(currentView);
            } else {
                authView.classList.remove('hidden');
                mainAppView.classList.add('hidden');
                mainAppView.classList.remove('flex');
            }
        });

        signupBtn.addEventListener('click', () => {
            createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value)
                .catch(error => authError.textContent = error.message);
        });

        loginBtn.addEventListener('click', () => {
            signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value)
                .catch(error => authError.textContent = error.message);
        });

        googleLoginBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                authError.textContent = error.message;
            }
        });

        logoutBtn.addEventListener('click', () => signOut(auth));

        // --- NAVIGATION ---
        const switchView = (view) => {
            Object.values(views).forEach(v => v.classList.add('hidden'));
            Object.values(navLinks).forEach(l => l.classList.remove('active'));
            if (views[view]) {
                views[view].classList.remove('hidden');
                if (navLinks[view]) navLinks[view].classList.add('active');
                window.location.hash = view;

                // Load data for the activated view
                if (view === 'home') {
                    loadHomeData();
                } else if (view === 'my-class') {
                    loadClasses();
                } else if (view === 'iep') {
                    loadIepStudents();
                    if (iepOutputContainer) {
                        iepOutputContainer.innerHTML = '<p class="text-gray-500">학생을 선택하면 IEP 정보가 표시됩니다.</p>';
                    }
                } else if (view === 'behavior') {
                    initBehaviorChart();
                }

            } else { // Fallback to home
                views.home.classList.remove('hidden');
                if (navLinks.home) navLinks.home.classList.add('active');
                window.location.hash = 'home';
                loadHomeData();
            }
        };

        Object.entries(navLinks).forEach(([key, link]) => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                switchView(key);
            });
        });
        document.getElementById('home-link').addEventListener('click', (e) => {
             e.preventDefault();
             switchView('home');
        });

        backToClassBtn.addEventListener('click', () => switchView('my-class'));

        levelButtons.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', () => {
                setActiveButton(levelButtons, btn.dataset.value);
                updateGradeButtons();
                loadAchievementTable();
            });
        });

        subjectButtons.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', () => {
                setActiveButton(subjectButtons, btn.dataset.value);
                loadAchievementTable();
            });
        });

        saveAchievementBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) return;
            const table = achievementTableContainer.querySelector('table');
            if (!table) return;
            const rows = table.querySelectorAll('tbody tr');
            const states = Array.from(rows).map(tr => {
                // Firestore does not support nested arrays, so store each row as an object
                const rowObj = {};
                for (let i = 1; i < tr.cells.length; i++) {
                    const btn = tr.cells[i].querySelector('button');
                    rowObj[i - 1] = parseInt(btn.dataset.state || '0');
                }
                return rowObj;
            });
            const key = `${getActiveValue(levelButtons)}_${getActiveValue(subjectButtons)}`;
            currentAchievementData[key] = states;
            try {
                await setDoc(doc(db, 'users', user.uid, 'achievements', currentAchievementStudent), {
                    data: currentAchievementData
                }, { merge: true });
                showToast('저장되었습니다');
            } catch (e) {
                console.error('Error saving achievement data', e);
            }
        });

        // --- Home View Logic ---
        async function loadHomeData() {
            const user = auth.currentUser;
            if (!user || isLoadingHomeData) return;
            isLoadingHomeData = true;
            try {
         const classRef = doc(db, "classes", user.uid);
         const iepsRef = collection(db, "users", user.uid, "ieps");

         const [classSnap, iepSnap] = await Promise.all([getDoc(classRef), getDocs(iepsRef)]);

         // Update home class list
         const homeClassList = document.getElementById('home-class-list');
         homeClassList.innerHTML = '';
         if (!classSnap.exists()) {
             homeClassList.innerHTML = `<p class="text-gray-500">아직 추가된 학급이 없습니다. '내 학급 관리'에서 추가해주세요.</p>`;
         } else {
             const data = classSnap.data();
             const studentIds = data.students || [];
             if (studentIds.length === 0) {
                 homeClassList.innerHTML = '<p class="text-gray-500">학생이 없습니다.</p>';
             } else {
                 for (const sid of studentIds) {
                     try {
                         const sd = await getDoc(doc(db, 'users', sid));
                         if (sd.exists()) {
                             const s = sd.data();
                            const studentEl = document.createElement('div');
                            studentEl.className = 'p-3 border rounded-md flex justify-between items-center';
                            studentEl.innerHTML = `<span>${s.name || sid}</span><button class="achievement-btn text-sky-600 hover:underline text-sm">성취 기준</button>`;
                            studentEl.querySelector('.achievement-btn').addEventListener('click', () => {
                                openAchievementView(s.name || sid);
                            });
                            homeClassList.appendChild(studentEl);
                        }
                     } catch (err) {
                         console.error(err);
                     }
                 }
             }
         }


            // Update stats chart
         const statsData = {
             labels: ['학급', 'IEP'],
             datasets: [{
                 label: '업무 수',
                 data: [classSnap.exists() ? 1 : 0, iepSnap.size],
                 backgroundColor: ['#38bdf8', '#fbbf24'], // sky-400, amber-400
                 hoverOffset: 4
             }]
         };
            updateChart('statsChart', 'statsChartInstance', 'doughnut', statsData, {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            });
        } catch (error) {
            console.error(error);
        } finally {
            isLoadingHomeData = false;
        }

        }

        // --- My Class View Logic ---
        const addClassBtn = document.getElementById('add-class-btn');
        const classListContainer = document.getElementById('class-list');
        const classTitle = document.getElementById('class-title');
        let isLoadingClasses = false;

        async function loadClasses() {
            const user = auth.currentUser;
            if (!user || isLoadingClasses) return;
            isLoadingClasses = true;
            classListContainer.innerHTML = '<p class="text-gray-500">로딩 중...</p>';
            const classRef = doc(db, 'classes', user.uid);
            try {
                const classSnap = await getDoc(classRef);
                classListContainer.innerHTML = '';
                if (!classSnap.exists()) {
                    addClassBtn.classList.remove('hidden');
                    classTitle.textContent = '내 학급';
                    classListContainer.innerHTML = `<p class="text-gray-500">생성된 학급이 없습니다.</p>`;
                    return;
                }
                const data = classSnap.data();
                classTitle.textContent = data.name || '내 학급';
                addClassBtn.classList.add('hidden');
                const studentIds = data.students || [];
                if (studentIds.length === 0) {
                    classListContainer.innerHTML = '<p class="text-gray-500">학생이 없습니다.</p>';
                } else {
                    for (const sid of studentIds) {
                        try {
                            const sd = await getDoc(doc(db, 'users', sid));
                            if (sd.exists()) {
                                const s = sd.data();
                                const studentEl = document.createElement('div');
                                studentEl.className = 'p-3 border rounded-md flex justify-between items-center';
                                studentEl.innerHTML = `<span>${s.name || sid}</span><button class="achievement-btn text-sky-600 hover:underline text-sm">성취 기준</button>`;
                                studentEl.querySelector('.achievement-btn').addEventListener('click', () => {
                                    openAchievementView(s.name || sid);
                                });
                                classListContainer.appendChild(studentEl);
                            }
                        } catch (err) {
                            console.error(err);
                        }
                    }
                }
            } catch (error) {
                classListContainer.innerHTML = '<p class="text-red-500">학급 정보를 불러오지 못했습니다.</p>';
            } finally {
                isLoadingClasses = false;
            }
        }
        
        addClassBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) return;
            const classRef = doc(db, 'classes', user.uid);
            const classSnap = await getDoc(classRef);
             if (classSnap.exists()) {
                 alert('이미 학급이 존재합니다.');
                 return;
             }
             const className = prompt('학급 이름을 입력하세요:');
             if (className) {
                 await setDoc(classRef, { name: className, students: [] });
                 loadClasses();
                loadHomeData();
            }
        });
        const achievementTables = {
            elementary: {
                korean: `| **학년(군)** | **듣기⋅말하기** | **읽기** | **쓰기** | **문법** | **문학** | **매체** |
|---|---|---|---|---|---|---|
| 1-2학년 | [2국01-01] 중요한 내용이나 일이 일어난 순서를 고려하며 듣고 말한다. | [2국02-01] 글자, 단어, 문장, 짧은 글을 정확하게 소리 내어 읽는다. | [2국03-01] 글자와 단어를 바르게 쓴다. | [2국04-01] 한글 자모의 이름과 소릿값을 알고 정확하게 발음하고 쓴다. | [2국05-01] 말놀이, 낱말 등을 통해 말의 재미와 즐거움을 느낀다. | [2국06-01] 일상의 다양한 매체와 매체 자료에 흥미와 관심을 가진다. |
| 1-2학년 | [2국01-02] 바르고 고운 말로 서로의 감정을 나누며 듣고 말한다. | [2국02-02] 의미가 잘 드러나도록 문장과 짧은 글을 알맞게 띄어 읽는다. | [2국03-02] 쓰기에 흥미를 가지며 자신의 생각이나 느낌을 문장으로 표현한다. | [2국04-02] 소리와 표기가 다를 수 있음을 알고 단어를 바르게 읽고 쓴다. | [2국05-02] 작품을 듣거나 읽으면서 느끼거나 생각한 점을 말한다. | [2국06-02] 일상의 경험과 생각을 글과 그림으로 표현한다. |
| 1-2학년 | [2국01-03] 상대의 말을 집중하여 듣고 말차례를 지키며 대화한다. | [2국02-03] 글을 읽고 중심 내용을 확인한다. | [2국03-03] 주변 소재에 대해 소개하는 글을 쓴다. | [2국04-03] 문장과 문장 부호를 알맞게 쓰고 한글에 호기심을 가진다. | [2국05-03] 작품 속 인물의 모습, 행동, 마음을 상상하여 시, 노래, 이야기, 그림 등으로 표현한다. | |
| 1-2학년 | [2국01-04] 자신의 경험이나 생각을 바르게 자세히 발표한다. | [2국02-04] 인물의 마음이나 생각을 짐작하고 이를 자신과 비교하며 글을 읽는다. | [2국03-04] 겪은 일을 표현하는 글을 자유롭게 쓰고, 쓴 글을 함께 읽고 생각이나 느낌을 나눈다. | | [2국05-04] 시나 노래, 이야기에 흥미를 가진다. | |
| 1-2학년 | [2국01-05] 듣기와 말하기에 관심과 흥미를 가진다. | [2국02-05] 읽기에 흥미를 가지고 즐겨 읽는 태도를 지닌다. | | | | |
| 3-4학년 | [4국01-01] 중요한 내용과 주제를 파악하며 듣고 그 내용을 요약한다. | [4국02-01] 글의 의미를 파악하며 유창하게 글을 읽는다. | [4국03-01] 중심 문장과 뒷받침 문장을 갖추어 문단을 쓰고, 문장과 문단을 중심으로 고쳐 쓴다. | [4국04-01] 단어와 단어 간의 의미 관계를 파악한다. | [4국05-01] 인물과 이야기의 흐름을 중심으로 작품을 감상한다. | [4국06-01] 인터넷에서 학습에 필요한 다양한 자료를 탐색하고 목적에 맞게 자료를 선택한다. |
| 3-4학년 | [4국01-02] 원인과 결과의 관계를 고려하여 내용을 예측하며 듣고 말한다. | [4국02-02] 문단과 글에서 중심 생각을 파악하고 내용을 간추린다. | [4국03-02] 절차와 결과가 드러나게 정확한 표현으로 보고하는 글을 쓴다. | [4국04-02] 단어를 분류하고 국어사전을 활용하여 능동적인 국어 활동을 한다. | [4국05-02] 자신의 경험을 바탕으로 작품 속 세계와 현실 세계를 비교하여 작품을 감상한다. | [4국06-02] 매체를 활용하여 간단한 발표 자료를 만든다. |
| 3-4학년 | [4국01-03] 상황에 적절한 준언어⋅비언어적 표현을 활용하여 듣고 말한다. | [4국02-03] 질문을 활용하여 글을 예측하며 읽고 자신의 읽기 과정을 점검한다. | [4국03-03] 대상에 대한 자신의 의견과 그렇게 생각한 이유가 드러나게 글을 쓴다. | [4국04-03] 기본적인 문장의 짜임을 이해하고 적절하게 사용한다. | [4국05-03] 작품을 듣거나 읽고 마음에 드는 작품을 소개한다. | [4국06-03] 매체 소통 윤리를 고려하여 매체 자료를 활용하고 공유한다. |
| 3-4학년 | [4국01-04] 상황과 상대의 입장을 이해하고 예의를 지키며 대화한다. | [4국02-04] 글에 나타난 사실과 의견을 구분하고 필자와 자신의 의견을 비교한다. | [4국03-04] 목적과 주제를 고려하여 독자에게 마음을 전하는 글을 쓴다. | [4국04-04] 글과 담화에 쓰인 높임 표현과 지시⋅접속 표현을 이해하고 상황에 맞게 표현한다. | [4국05-04] 감각적 표현에 유의하여 작품을 감상하고, 감각적 표현을 활용하여 자신의 생각이나 감정을 표현한다. | |
| 3-4학년 | [4국01-05] 목적과 주제에 알맞게 자료를 정리하여 자신감 있게 발표한다. | [4국02-05] 글이나 자료의 출처가 믿을 만한지 판단한다. | [4국03-05] 자신의 쓰기 과정을 점검하며 쓰기에 자신감을 갖는다. | [4국04-05] 언어가 의사소통과 관계 형성의 수단임을 이해하고 국어를 소중히 여기는 태도를 지닌다. | [4국05-05] 재미나 감동을 느끼며 작품을 즐겨 감상하는 태도를 지닌다. | |
| 3-4학년 | [4국01-06] 주제에 적절한 의견과 이유를 제시하고 서로의 생각을 교환하며 토의한다. | [4국02-06] 바람직한 읽기 습관을 형성하고 읽기에 대한 자신감을 기른다. | | | | |
| 5-6학년 | [6국01-01] 대화에서 생략된 내용을 추론하며 듣는다. | [6국02-01] 글의 구조를 고려하며 주제나 주장을 파악하고 글 내용을 요약한다. | [6국03-01] 알맞은 내용을 선정하여 대상의 특성이 나타나게 설명하는 글을 쓴다. | [6국04-01] 음성 언어 및 문자 언어의 특성을 이해하고 다양한 매체 자료에서 표현 효과를 평가한다. | [6국05-01] 작가의 의도를 생각하며 작품을 읽는다. | [6국06-01] 정보 검색 도구를 활용하여 자신의 목적에 맞는 매체 자료를 찾는다. |
| 5-6학년 | [6국01-02] 주장을 파악하고 이유나 근거가 타당한지 평가하며 듣는다. | [6국02-02] 글에서 생략된 내용이나 함축된 표현을 문맥을 고려하여 추론한다. | [6국03-02] 적절한 근거를 사용하고 인용의 출처를 밝히며 주장하는 글을 쓴다. | [6국04-02] 표준어와 방언의 기능을 파악하고 언어 공동체와 국어생활과의 관계를 이해한다. | [6국05-02] 비유적 표현의 효과에 유의하여 작품을 감상한다. | [6국06-02] 뉴스 및 각종 정보 매체 자료의 신뢰성을 평가한다. |
| 5-6학년 | [6국01-03] 주제와 관련하여 궁금한 내용을 질문하며 적극적으로 듣고 말한다. | [6국02-03] 글이나 자료를 읽고 내용의 타당성과 표현의 적절성을 평가한다. | [6국03-03] 체험한 일에 대한 감상을 나타내는 글을 쓴다. | [6국04-03] 고유어와 관용 표현의 쓰임과 가치를 이해하고 상황에 맞게 표현한다. | [6국05-03] 소설이나 극을 읽고 인물, 사건, 배경을 파악한다. | [6국06-03] 적합한 양식과 수용자의 반응을 고려하여 복합양식 매체 자료를 제작하고 공유한다. |
| 5-6학년 | [6국01-04] 면담의 절차를 이해하고 상대와 매체를 고려하여 면담한다. | [6국02-04] 문제 상황과 관련된 다양한 관점의 글을 읽고 이를 문제 해결에 활용한다. | [6국03-04] 독자와 매체를 고려하여 내용을 생성하고 표현하며 글을 쓴다. | [6국04-04] 문장 성분을 이해하고 호응 관계가 올바른 문장을 구성한다. | [6국05-04] 인상적인 부분을 중심으로 작품에 대한 의견을 나눈다. | [6국06-04] 자신의 매체 이용 양상에 대해 성찰한다. |
| 5-6학년 | [6국01-05] 자료를 선별하여 핵심 정보를 중심으로 내용을 구성하고 매체를 활용하여 발표한다. | [6국02-05] 긍정적인 읽기 동기를 형성하고 적극적으로 읽기에 참여하는 태도를 기른다. | [6국03-05] 쓰기 과정을 점검⋅조정하며 글을 쓰고, 글 전체를 대상으로 통일성 있게 고쳐 쓴다. | [6국04-05] 글과 담화에 쓰인 시간 표현을 이해하고 상황에 맞게 표현한다. | [6국05-05] 자신의 경험을 시, 소설, 극, 수필 등 적절한 갈래로 표현한다. | |
| 5-6학년 | [6국01-06] 토의에 협력적으로 참여하며 서로의 의견을 비교하고 조정한다. | | [6국03-06] 쓰기에 적극적으로 참여하며 자신의 글을 독자와 공유하는 태도를 지닌다. | [6국04-06] 글과 담화에 쓰인 단어 및 문장, 띄어쓰기를 민감하게 살펴 바르게 고치는 태도를 지닌다. | [6국05-06] 작품을 읽고 자신의 삶과 연관 지어 성찰하는 태도를 지닌다. | |
| 5-6학년 | [6국01-07] 절차와 규칙을 지키고 타당한 이유와 근거를 제시하며 토론한다. | | | | | |
`,
                math: `| 학년(군) | 수와 연산 | 변화와 관계 | 도형과 측정 | 자료와 가능성 |
|---|---|---|---|---|
| 1-2학년 | [2수01-01] 수의 필요성을 인식하면서 0과 100까지의 수 개념을 이해하고, 수를 세고 읽고 쓸 수 있다. | [2수02-01] 물체, 무늬, 수 등의 배열에서 규칙을 찾아 여러 가지 방법으로 표현할 수 있다. | [2수03-01] 교실 및 생활 주변에서 여러 가지 물건을 관찰하여 직육면체, 원기둥, 구의 모양을 찾고, 이를 이용하여 여러 가지 모양을 만들 수 있다. | [2수04-01] 여러 가지 사물을 정해진 기준 또는 자신이 정한 기준으로 분류하여 개수를 세어 보고, 기준에 따른 결과를 말할 수 있다. |
| 1-2학년 | [2수01-02] 일, 십, 백, 천의 자릿값과 위치적 기수법을 이해하고, 네 자리 이하의 수를 읽고 쓸 수 있다. | [2수02-02] 자신이 정한 규칙에 따라 물체, 무늬, 수 등을 배열할 수 있다. | [2수03-02] 쌓기나무를 이용하여 여러 가지 입체도형의 모양을 만들고, 그 모양에 대해 위치나 방향을 이용하여 말할 수 있다. | [2수04-02] 자료를 분류하여 표로 나타내고, 자료를 표로 나타내면 편리한 점을 말할 수 있다. |
| 1-2학년 | [2수01-03] 네 자리 이하의 수의 범위에서 수의 계열을 이해하고, 수의 크기를 비교할 수 있다. | | [2수03-03] 교실 및 생활 주변에서 여러 가지 물건을 관찰하여 삼각형, 사각형, 원의 모양을 찾고, 이를 이용하여 여러 가지 모양을 만들 수 있다. | [2수04-03] 자료를 분류하여 ○, ×, / 등을 이용한 그래프로 나타내고, 자료를 그래프로 나타내면 편리한 점을 말할 수 있다. |
| 1-2학년 | [2수01-04] 하나의 수를 두 수로 분해하고 두 수를 하나의 수로 합성하는 활동을 통하여 수 감각을 기른다. | | [2수03-04] 삼각형, 사각형, 원을 직관적으로 이해하고, 그 모양을 그릴 수 있다. | |
| 1-2학년 | [2수01-05] 덧셈과 뺄셈이 이루어지는 실생활 상황과 연결하여 덧셈과 뺄셈의 의미를 이해한다. | | [2수03-05] 삼각형, 사각형에서 각각의 공통점을 찾아 말할 수 있다. | |
| 1-2학년 | [2수01-06] 두 자리 수의 범위에서 덧셈과 뺄셈의 계산 원리를 이해하고 그 계산을 할 수 있다. | | [2수03-06] 구체물의 길이, 들이, 무게, 넓이를 비교하여 각각 ‘길다, 짧다’, ‘많다, 적다’, ‘무겁다, 가볍다’, ‘넓다, 좁다’ 등을 구별하여 말할 수 있다. | |
| 1-2학년 | [2수01-07] 덧셈과 뺄셈의 관계를 이해한다. | | [2수03-07] 시계를 보고 시각을 ‘몇 시 몇 분’까지 읽을 수 있다. | |
| 1-2학년 | [2수01-08] 두 자리 수의 범위에서 세 수의 덧셈과 뺄셈을 할 수 있다. | | [2수03-08] 1시간과 1분의 관계를 이해하고, 시간을 ‘시간’, ‘분’으로 표현할 수 있다. | |
| 1-2학년 | [2수01-09] □가 사용된 덧셈식과 뺄셈식을 만들고, □의 값을 구할 수 있다. | | [2수03-09] 실생활 문제 상황과 연결하여 1분, 1시간, 1일, 1주일, 1개월, 1년 사이의 관계를 이해한다. | |
| 1-2학년 | [2수01-10] 곱셈이 이루어지는 실생활 상황과 연결하여 곱셈의 의미를 이해한다. | | [2수03-10] 길이 단위 1cm를 알고, 이를 이용하여 주변 사물의 길이를 측정할 수 있다. | |
| 1-2학년 | [2수01-11] 곱셈구구를 이해하고, 한 자리 수의 곱셈을 할 수 있다. | | [2수03-11] 1m와 cm의 관계를 이해하고, 길이를 ‘몇 m와 ‘몇 cm’로 표현할 수 있다. | |
| 1-2학년 | | | [2수03-12] 여러 가지 물건의 길이를 어림하고, 길이에 대한 감각을 기른다. | |
| 1-2학년 | | | [2수03-13] 실생활 문제 상황과 연결하여 길이의 덧셈과 뺄셈을 할 수 있다. | |
| 3-4학년 | [4수01-01] 큰 수의 필요성을 인식하면서 10000 이상의 큰 수에 대한 자릿값과 위치적 기수법을 이해하고, 수를 읽고 쓸 수 있다. | [4수02-01] 다양한 변화 규칙을 찾아 설명하고, 그 규칙을 수나 식으로 나타낼 수 있다. | [4수03-01] 직선, 선분, 반직선을 이해하고 구별할 수 있다. | [4수04-01] 자료를 수집하여 그림그래프나 막대그래프로 나타내고 해석할 수 있다. |
| 3-4학년 | [4수01-02] 다섯 자리 이상의 수의 범위에서 수의 계열을 이해하고, 수의 크기를 비교하며 그 방법을 설명할 수 있다. | [4수02-02] 계산식의 배열에서 규칙을 찾고, 계산 결과를 추측할 수 있다. | [4수03-02] 각과 직각을 이해하고, 직각과 비교하는 활동을 통하여 예각과 둔각을 구별할 수 있다. | [4수04-02] 자료를 수집하여 꺾은선그래프로 나타내고 해석할 수 있다. |
| 3-4학년 | [4수01-03] 세 자리 수의 덧셈과 뺄셈의 계산 원리를 이해하고 그 계산을 할 수 있다. | [4수02-03] 등호를 사용하여 크기가 같은 두 양의 관계를 식으로 나타낼 수 있다. | [4수03-03] 직선의 수직 관계와 평행 관계를 이해한다. | [4수04-03] 탐구 문제를 해결하기 위해 자료를 수집, 정리하여 막대그래프나 꺾은선그래프로 나타내고 해석할 수 있다. |
| 3-4학년 | [4수01-04] 곱하는 수가 한 자리 수 또는 두 자리 수인 곱셈의 계산 원리를 이해하고 그 계산을 할 수 있다. | | [4수03-04] 구체물이나 평면도형의 밀기, 뒤집기, 돌리기 활동을 통하여 그 변화를 이해한다. | |
| 3-4학년 | [4수01-05] 나눗셈이 이루어지는 실생활 상황과 연결하여 나눗셈의 의미를 알고, 곱셈과 나눗셈의 관계를 이해한다. | | [4수03-05] 평면에서 점의 이동에 대해 위치와 방향을 이용하여 설명할 수 있다. | |
| 3-4학년 | [4수01-06] 나누는 수가 한 자리 수인 나눗셈의 계산 원리를 이해하고 그 계산을 할 수 있으며, 나눗셈에서 몫과 나머지의 의미를 안다. | | [4수03-06] 원의 중심, 반지름, 지름을 이해하고, 그 성질을 안다. | |
| 3-4학년 | [4수01-07] 나누는 수가 두 자리 수인 나눗셈의 계산 원리를 이해하고 그 계산을 할 수 있다. | | [4수03-07] 컴퍼스를 이용하여 여러 가지 크기의 원을 그릴 수 있다. | |
| 3-4학년 | [4수01-08] 자연수의 덧셈, 뺄셈, 곱셈, 나눗셈과 관련한 여러 가지 상황에서 어림셈을 할 수 있다. | | [4수03-08] 여러 가지 모양의 삼각형에 대한 분류 활동을 통하여 이등변삼각형, 정삼각형을 이해하고, 그 성질을 탐구하고 설명할 수 있다. | |
| 3-4학년 | [4수01-09] 양의 등분할을 통하여 분수의 필요성을 인식하고, 분수를 이해하고 읽고 쓸 수 있다. | | [4수03-09] 여러 가지 모양의 삼각형에 대한 분류 활동을 통하여 직각삼각형, 예각삼각형, 둔각삼각형을 이해한다. | |
| 3-4학년 | [4수01-10] 단위분수, 진분수, 가분수, 대분수를 알고, 그 관계를 이해한다. | | [4수03-10] 여러 가지 모양의 사각형에 대한 분류 활동을 통하여 직사각형, 정사각형, 사다리꼴, 평행사변형, 마름모를 이해하고, 그 성질을 탐구하고 설명할 수 있다. | |
| 3-4학년 | [4수01-11] 분모가 같은 분수끼리, 단위분수끼리 크기를 비교하고 그 방법을 설명할 수 있다. | | [4수03-11] 다각형과 정다각형을 이해한다. | |
| 3-4학년 | [4수01-12] 분모가 10인 진분수와 연결하여 소수 한 자리 수를 이해하고 읽고 쓸 수 있다. | | [4수03-12] 주어진 도형을 이용하여 여러 가지 모양을 만들거나 채우고 설명할 수 있다. | |
| 3-4학년 | [4수01-13] 자릿값의 원리를 바탕으로 소수 두 자리 수와 소수 세 자리 수를 이해하고 읽고 쓸 수 있다. | | [4수03-13] 1분과 1초의 관계를 이해하고, 초 단위까지 시각을 읽을 수 있다. | |
| 3-4학년 | [4수01-14] 소수의 크기를 비교하고 그 방법을 설명할 수 있다. | | [4수03-14] 실생활 문제 상황과 연결하여 초 단위까지의 시간의 덧셈과 뺄셈을 할 수 있다. | |
| 3-4학년 | [4수01-15] 분모가 같은 분수의 덧셈과 뺄셈의 계산 원리를 이해하고 그 계산을 할 수 있다. | | [4수03-15] 길이 단위 1mm와 1km를 알고, 이를 이용하여 길이를 측정하고 어림하며 수학의 유용성을 인식할 수 있다. | |
| 3-4학년 | [4수01-16] 소수 두 자리 수의 범위에서 소수의 덧셈과 뺄셈의 계산 원리를 이해하고 그 계산을 할 수 있다. | | [4수03-16] 1cm와 1mm, 1km와 1m의 관계를 이해하고, 길이를 ‘몇 cm 몇 mm’와 ‘몇 mm’, ‘몇 km 몇 m’와 ‘몇 m’로 다양하게 표현할 수 있다. | |
| 3-4학년 | | | [4수03-17] 들이 단위 1L와 1mL를 알고, 이를 이용하여 들이를 측정하고 어림하며 수학의 유용성을 인식할 수 있다. | |
| 3-4학년 | | | [4수03-18] 1L와 1mL의 관계를 이해하고, 들이를 ‘몇 L 몇 mL’와 ‘몇 mL’로 표현할 수 있다. | |
| 3-4학년 | | | [4수03-19] 실생활 문제 상황과 연결하여 들이의 덧셈과 뺄셈을 할 수 있다. | |
| 3-4학년 | | | [4수03-20] 실생활에서 무게를 나타낼 때 사용하는 단위 1g과 1kg을 알고, 이를 이용하여 무게를 측정하고 어림하며 수학의 유용성을 인식할 수 있다. | |
| 3-4학년 | | | [4수03-21] 1kg과 1g의 관계를 이해하고, 무게를 ‘몇 kg 몇 g’과 ‘몇 g’으로 표현할 수 있다. | |
| 3-4학년 | | | [4수03-22] 실생활에서 무게를 나타낼 때 사용하는 단위 1t을 알고, 1t과 1kg의 관계를 이해한다. | |
| 3-4학년 | | | [4수03-23] 실생활 문제 상황과 연결하여 무게의 덧셈과 뺄셈을 할 수 있다. | |
| 3-4학년 | | | [4수03-24] 각의 크기의 단위인 1도(°)를 알고, 각도기를 이용하여 각의 크기를 측정하고 어림할 수 있다. | |
| 3-4학년 | | | [4수03-25] 여러 가지 방법으로 삼각형과 사각형의 내각의 크기의 합을 추론하고, 자신의 추론 과정을 설명할 수 있다. | |
| 5-6학년 | [6수01-01] 덧셈, 뺄셈, 곱셈, 나눗셈의 혼합 계산에서 계산하는 순서를 알고, 혼합 계산을 할 수 있다. | [6수02-01] 한 양이 변할 때 다른 양이 그에 종속하여 변하는 대응 관계를 나타낸 표에서 규칙을 찾아 설명하고, □, △ 등을 사용하여 식으로 나타낼 수 있다. | [6수03-01] 도형의 합동을 이해하고, 합동인 도형의 성질을 탐구하고 설명할 수 있다. | [6수04-01] 평균의 의미를 알고, 자료를 수집하여 평균을 구하고 해석할 수 있다. |
| 5-6학년 | [6수01-02] 실생활과 연결하여 이상, 이하, 초과, 미만의 의미와 쓰임을 알고, 이를 활용하여 수의 범위를 나타낼 수 있다. | [6수02-02] 두 양의 크기를 비교하는 상황을 통해 비의 개념을 이해하고, 두 양의 관계를 비로 나타낼 수 있다. | [6수03-02] 실생활과 연결하여 선대칭도형과 점대칭도형을 이해하고 그릴 수 있다. | [6수04-02] 자료를 수집하여 띠그래프나 원그래프로 나타내고 해석할 수 있다. |
| 5-6학년 | [6수01-03] 어림값을 구하기 위한 방법으로 올림, 버림, 반올림의 의미와 필요성을 알고, 이를 실생활에 활용함으로써 수학의 유용성을 인식할 수 있다. | [6수02-03] 비율을 이해하고, 비율을 분수, 소수, 백분율로 나타낼 수 있다. | [6수03-03] 직육면체와 정육면체를 이해하고, 구성 요소와 성질을 탐구하고 설명할 수 있다. | [6수04-03] 탐구 문제를 설정하고, 그에 맞는 자료를 수집, 정리하여 적절한 그래프로 나타내고 해석할 수 있다. |
| 5-6학년 | [6수01-04] 약수, 공약수, 최대공약수를 이해하고 구할 수 있다. | [6수02-04] 비례식을 알고, 그 성질을 이해하며, 이를 활용하여 간단한 비례식을 풀 수 있다. | [6수03-04] 직육면체와 정육면체의 겨냥도와 전개도를 그릴 수 있다. | [6수04-04] 사건이 일어날 가능성을 말로 표현하고 비교할 수 있다. |
| 5-6학년 | [6수01-05] 배수, 공배수, 최소공배수를 이해하고 구할 수 있다. | [6수02-05] 비례배분을 알고, 주어진 양을 비례배분 할 수 있다. | [6수03-05] 각기둥과 각뿔을 이해하고, 구성 요소와 성질을 탐구하고 설명할 수 있다. | [6수04-05] 사건이 일어날 가능성을 수로 나타낼 수 있다. |
| 5-6학년 | [6수01-06] 크기가 같은 분수를 만드는 방법을 이해하고, 분수를 약분, 통분할 수 있다. | | [6수03-06] 각기둥의 전개도를 그릴 수 있다. | [6수04-06] 자료를 이용하여 가능성을 예상하고, 가능성에 근거하여 적절한 판단을 내릴 수 있다. |
| 5-6학년 | [6수01-07] 분모가 다른 분수의 크기를 비교하고 그 방법을 설명할 수 있다. | | [6수03-07] 원기둥, 원뿔, 구를 이해하고, 구성 요소와 성질을 탐구하고 설명할 수 있다. | |
| 5-6학년 | [6수01-08] 분모가 다른 분수의 덧셈과 뺄셈의 계산 원리를 탐구하고 그 계산을 할 수 있다. | | [6수03-08] 원기둥의 전개도를 그릴 수 있다. | |
| 5-6학년 | [6수01-09] 분수의 곱셈의 계산 원리를 탐구하고 그 계산을 할 수 있다. | | [6수03-09] 쌓기나무로 만든 입체도형을 보고 사용된 쌓기나무의 개수를 구할 수 있다. | |
| 5-6학년 | [6수01-10] ‘(자연수) ÷ (자연수)’에서 나눗셈의 몫을 분수로 나타낼 수 있다. | | [6수03-10] 쌓기나무로 만든 입체도형의 위, 앞, 옆에서 본 모양을 표현할 수 있고, 이러한 표현을 보고 입체도형의 모양을 추측할 수 있다. | |
| 5-6학년 | [6수01-11] 분수의 나눗셈의 계산 원리를 탐구하고 그 계산을 할 수 있다. | | [6수03-11] 평면도형의 둘레를 이해하고, 기본적인 평면도형의 둘레를 구할 수 있다. | |
| 5-6학년 | [6수01-12] 분수와 소수의 관계를 이해하고 크기를 비교하며 그 방법을 설명할 수 있다. | | [6수03-12] 넓이 단위 1cm², 1m², 1km²를 알며, 그 관계를 이해한다. | |
| 5-6학년 | [6수01-13] 소수의 곱셈의 계산 원리를 탐구하고 그 계산을 할 수 있다. | | [6수03-13] 직사각형과 정사각형의 넓이를 구하는 방법을 이해하고, 이를 구할 수 있다. | |
| 5-6학년 | [6수01-14] ‘(자연수) ÷ (자연수)’에서 나눗셈의 몫을 소수로 나타낼 수 있다. | | [6수03-14] 평행사변형, 삼각형, 사다리꼴, 마름모의 넓이를 구하는 방법을 다양하게 추론하고, 이와 관련된 문제를 해결할 수 있다. | |
| 5-6학년 | [6수01-15] 소수의 나눗셈의 계산 원리를 탐구하고 그 계산을 할 수 있다. | | [6수03-15] 여러 가지 원 모양 물체의 원주와 지름을 측정하는 활동을 통하여, 원주율이 일정한 값임을 알고 그 근삿값을 사용할 수 있다. | |
| 5-6학년 | | | [6수03-16] 원주와 원의 넓이를 구하는 방법을 이해하고, 이를 구할 수 있다. | |
| 5-6학년 | | | [6수03-17] 직육면체와 정육면체의 겉넓이를 구하는 방법을 이해하고, 이를 구할 수 있다. | |
| 5-6학년 | | | [6수03-18] 부피 단위 1cm³, 1m³를 알며, 그 관계를 이해한다. | |
| 5-6학년 | | | [6수03-19] 직육면체와 정육면체의 부피를 구하는 방법을 이해하고, 이를 구할 수 있다. | |
`
            }
        };

        function setActiveButton(container, value) {
            container.querySelectorAll('button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === value);
            });
        }

        function getActiveValue(container) {
            const active = container.querySelector('.active');
            return active ? active.dataset.value : null;
        }

        function markdownTableToHtml(md) {
            const lines = md.trim().split('\n');
            const headers = lines[0].split('|').slice(1, -1).map(s => s.trim());
            const rows = lines.slice(2).map(line => line.split('|').slice(1, -1).map(s => s.trim()));
            let html = '<table class="min-w-full border border-gray-300 text-sm"><thead><tr>';
            headers.forEach(h => { html += `<th class="border px-2 py-1 bg-gray-100">${h.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')}</th>`; });
            html += '</tr></thead><tbody>';
            rows.forEach(row => {
                html += '<tr>';
                row.forEach(cell => {
                    html += `<td class="border px-2 py-1 align-top">${cell.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            return html;
        }

        function setButtonState(btn, state) {
            btn.dataset.state = state;
            btn.classList.remove('bg-yellow-200', 'bg-green-200', 'bg-opacity-50');
            if (state === 1) {
                btn.classList.add('bg-yellow-200', 'bg-opacity-50');
            } else if (state === 2) {
                btn.classList.add('bg-green-200', 'bg-opacity-50');
            }
        }

        function makeAchievementTableInteractive() {
            const table = achievementTableContainer.querySelector('table');
            if (!table) return;
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(tr => {
                for (let i = 1; i < tr.cells.length; i++) {
                    const cell = tr.cells[i];
                    const text = cell.textContent;
                    cell.innerHTML = `<button type="button" class="w-full text-left px-1 py-0.5 rounded" data-state="0">${text}</button>`;
                    const btn = cell.querySelector('button');
                    btn.addEventListener('click', () => {
                        let state = parseInt(btn.dataset.state);
                        state = (state + 1) % 3;
                        setButtonState(btn, state);
                    });
                }
            });
        }

        function applyAchievementStates() {
            const key = `${getActiveValue(levelButtons)}_${getActiveValue(subjectButtons)}`;
            const stateRows = currentAchievementData[key];
            if (!stateRows) return;
            const rows = achievementTableContainer.querySelectorAll('tbody tr');
            rows.forEach((tr, rowIdx) => {
                for (let i = 1; i < tr.cells.length; i++) {
                    const btn = tr.cells[i].querySelector('button');
                    const state = stateRows[rowIdx]?.[i - 1] || 0;
                    setButtonState(btn, state);
                }
            });
        }

        function applyGradeFilter() {
            const grade = getActiveValue(gradeButtons);
            const rows = achievementTableContainer.querySelectorAll('tbody tr');
            rows.forEach(tr => {
                const rowGrade = tr.cells[0].textContent.trim();
                tr.style.display = (grade === 'all' || rowGrade === grade) ? '' : 'none';
            });
        }

        function updateGradeButtons() {
            const level = getActiveValue(levelButtons);
            let options = [];
            if (level === 'elementary') {
                options = [
                    { value: 'all', label: '전체' },
                    { value: '1-2학년', label: '1-2학년' },
                    { value: '3-4학년', label: '3-4학년' },
                    { value: '5-6학년', label: '5-6학년' },
                ];
            } else {
                options = [
                    { value: 'all', label: '전체' },
                    { value: '1', label: '1' },
                    { value: '2', label: '2' },
                    { value: '3', label: '3' },
                ];
            }
            gradeButtons.innerHTML = options.map(o => `<button data-value="${o.value}" class="tab-btn py-1 px-3 rounded">${o.label}</button>`).join('');
            gradeButtons.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => {
                    setActiveButton(gradeButtons, btn.dataset.value);
                    applyGradeFilter();
                });
            });
            setActiveButton(gradeButtons, 'all');
        }

        function loadAchievementTable() {
            const level = getActiveValue(levelButtons);
            const subject = getActiveValue(subjectButtons);
            const md = achievementTables[level]?.[subject];
            if (md) {
                achievementTableContainer.innerHTML = markdownTableToHtml(md);
                makeAchievementTableInteractive();
                applyAchievementStates();
                applyGradeFilter();
            } else {
                achievementTableContainer.innerHTML = '<p class="text-gray-500">준비 중입니다.</p>';
            }
        }

        async function openAchievementView(studentName) {
            const user = auth.currentUser;
            if (!user) return;
            currentAchievementStudent = studentName;
            const docRef = doc(db, 'users', user.uid, 'achievements', studentName);
            const snap = await getDoc(docRef);
            currentAchievementData = snap.exists() ? (snap.data().data || {}) : {};
            document.getElementById('achievement-student').textContent = `${studentName} 학생`;
            setActiveButton(levelButtons, 'elementary');
            setActiveButton(subjectButtons, 'korean');
            updateGradeButtons();
            loadAchievementTable();
            switchView('achievement');
        }


        // --- IEP View Logic ---
        const iepStudentList = document.getElementById('iep-student-list');
        const iepOutputContainer = document.getElementById('iep-output');
        let currentIepStudent = '';
        let currentIepDocId = '';
        let isLoadingIepStudents = false;

        async function loadIepStudents() {
            const user = auth.currentUser;
            if (!user || isLoadingIepStudents) return;
            isLoadingIepStudents = true;
            iepStudentList.innerHTML = '<p class="text-gray-500">로딩 중...</p>';
            const classRef = doc(db, 'classes', user.uid);
            try {
                const classSnap = await getDoc(classRef);
                iepStudentList.innerHTML = '';
                if (!classSnap.exists()) {
                    iepStudentList.innerHTML = '<p class="text-gray-500">생성된 학급이 없습니다.</p>';
                    return;
                }
                const studentIds = classSnap.data().students || [];
                if (studentIds.length === 0) {
                    iepStudentList.innerHTML = '<p class="text-gray-500">학생이 없습니다.</p>';
                } else {
                    for (const sid of studentIds) {
                        try {
                            const sd = await getDoc(doc(db, 'users', sid));
                            if (sd.exists()) {
                                const s = sd.data();
                                const studentEl = document.createElement('div');
                                studentEl.className = 'p-3 border rounded-md cursor-pointer hover:bg-sky-50';
                                studentEl.textContent = s.name || sid;
                                studentEl.addEventListener('click', () => showIepList(s.name || sid));
                                iepStudentList.appendChild(studentEl);
                            }
                        } catch (err) {
                            console.error(err);
                        }
                    }
                }
            } catch (error) {
                iepStudentList.innerHTML = '<p class="text-red-500">학급 정보를 불러오지 못했습니다.</p>';
            } finally {
                isLoadingIepStudents = false;
            }
        }

        function showModifySection() {
            document.getElementById('iep-modify-section').classList.remove('hidden');
        }

        function hideModifySection() {
            document.getElementById('iep-modify-section').classList.add('hidden');
        }

        async function showIepList(studentName) {
            currentIepStudent = studentName;
            currentIepDocId = '';
            hideModifySection();
            iepOutputContainer.innerHTML = '<p class="text-gray-500">로딩 중...</p>';
            const user = auth.currentUser;
            if (!user) return;
            const iepRef = collection(db, 'users', user.uid, 'ieps');
            const q = query(iepRef, where('student', '==', studentName), orderBy('createdAt', 'desc'));
            const snap = await getDocs(q);
            let html = `<div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">${studentName} IEP 목록</h3><button id="add-iep-btn" class="bg-sky-600 hover:bg-sky-700 text-white text-sm px-3 py-1 rounded">+추가</button></div>`;
            if (snap.empty) {
                html += '<p class="text-gray-500">IEP가 없습니다.</p>';
            } else {
                html += '<ul class="space-y-2">';
                snap.forEach(doc => {
                    const d = doc.data();
                    const date = d.createdAt?.toDate ? d.createdAt.toDate().toLocaleDateString() : '';
                    html += `<li class="p-2 border rounded cursor-pointer hover:bg-sky-50" data-id="${doc.id}"><div class="flex justify-between"><span>${d.title}</span><span class="text-xs text-gray-500">${date}</span></div></li>`;
                });
                html += '</ul>';
            }
            iepOutputContainer.innerHTML = html;
            document.getElementById('add-iep-btn').addEventListener('click', () => addIep(studentName));
            iepOutputContainer.querySelectorAll('li[data-id]').forEach(el => {
                el.addEventListener('click', () => openIepDocument(el.dataset.id, studentName));
            });
        }

        async function addIep(studentName) {
            const user = auth.currentUser;
            if (!user) return;
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const semester = (month >= 8 || month <= 1) ? 2 : 1;
            const title = `${year}학년도 ${semester}학기 개별화교육계획(${studentName})`;
            const docRef = await addDoc(collection(db, 'users', user.uid, 'ieps'), {
                student: studentName,
                title,
                createdAt: serverTimestamp(),
                content: ''
            });
            showIepList(studentName);
            openIepDocument(docRef.id, studentName);
        }

        async function openIepDocument(id, studentName) {
            const user = auth.currentUser;
            if (!user) return;
            currentIepDocId = id;
            const docRef = doc(db, 'users', user.uid, 'ieps', id);
            let snap = await getDoc(docRef);
            let data = snap.data();
            if (!data.content) {
                const content = await buildIepContent(studentName);
                await updateDoc(docRef, { content });
                snap = await getDoc(docRef);
                data = snap.data();
            }
            renderIepContent(id, studentName, data);
        }

        function renderIepContent(id, studentName, data) {
            showModifySection();
            let html = `<div class="flex justify-between items-center mb-4"><div><span id="iep-title">${data.title}</span></div><div class="space-x-2"><button id="edit-iep-title" class="text-sm text-sky-600">편집</button><button id="save-iep-btn" class="bg-sky-600 hover:bg-sky-700 text-white text-sm px-3 py-1 rounded">저장</button></div></div><div id="iep-content">${data.content}</div>`;
            iepOutputContainer.innerHTML = html;
            document.getElementById('iep-achievement-btn')?.addEventListener('click', () => openAchievementView(studentName));
            document.getElementById('generate-semester-goals-btn')?.addEventListener('click', async () => {
                const content = await buildIepContent(studentName);
                const temp = document.createElement('div');
                temp.innerHTML = content;
                document.getElementById('korean-goals').innerHTML = temp.querySelector('#korean-goals').innerHTML;
                document.getElementById('math-goals').innerHTML = temp.querySelector('#math-goals').innerHTML;
            });
            const editBtn = document.getElementById('edit-iep-title');
            editBtn.addEventListener('click', () => {
                const existing = document.getElementById('iep-title');
                if (editBtn.textContent === '편집') {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = existing.textContent;
                    input.className = 'border rounded p-1 text-sm';
                    existing.replaceWith(input);
                    editBtn.textContent = '완료';
                    input.focus();
                    input.addEventListener('keydown', e => { if (e.key === 'Enter') editBtn.click(); });
                } else {
                    const input = iepOutputContainer.querySelector('input');
                    const span = document.createElement('span');
                    span.id = 'iep-title';
                    span.textContent = input.value.trim() || data.title;
                    input.replaceWith(span);
                    editBtn.textContent = '편집';
                }
            });
            document.getElementById('save-iep-btn').addEventListener('click', async () => {
                const user = auth.currentUser;
                if (!user) return;
                const docRef = doc(db, 'users', user.uid, 'ieps', id);
                const title = document.getElementById('iep-title').textContent;
                const content = document.getElementById('iep-content').innerHTML;
                await updateDoc(docRef, { title, content });
                showIepList(studentName);
                openIepDocument(id, studentName);
                alert('저장되었습니다.');
            });
        }

        const modifyInput = document.getElementById('iep-modify-input');
        modifyInput.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const instruction = modifyInput.value.trim();
                if (!instruction || !currentIepDocId) return;
                modifyInput.value = '';
                const currentContent = document.getElementById('iep-content').innerText;
                const prompt = `다음 개별화교육계획을 사용자의 수정 요구에 맞게 수정해줘. HTML 형식을 유지해줘.\n\n원본:\n${currentContent}\n\n수정 요구:${instruction}`;
                const result = await callGemini(prompt);
                document.getElementById('iep-content').innerHTML = result;
            }
        });

        async function buildIepContent(studentName) {
            const user = auth.currentUser;
            if (!user) return '';
            const docRef = doc(db, 'users', user.uid, 'achievements', studentName);
            const snap = await getDoc(docRef);
            const data = snap.exists() ? (snap.data().data || {}) : {};
            const koreanList = collectYellowAchievements(data, 'korean');
            const mathList = collectYellowAchievements(data, 'math');
            return `<div class="space-y-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">1. 학습이 필요한 성취기준</h3>
                    <button id="iep-achievement-btn" class="text-sky-600 hover:underline text-sm">성취 기준 이동</button>
                </div>
                <div>
                    <h4 class="font-semibold mt-4 mb-2">가. 국어</h4>
                    ${buildAchievementTable(koreanList)}
                </div>
                <div>
                    <h4 class="font-semibold mt-4 mb-2">나. 수학</h4>
                    ${buildAchievementTable(mathList)}
                </div>
                <div class="flex justify-between items-center mt-6">
                    <h3 class="text-xl font-bold">2. 학기 교육 목표</h3>
                    <button id="generate-semester-goals-btn" class="text-sky-600 hover:underline text-sm">생성</button>
                </div>
                <div>
                    <h4 class="font-semibold mt-4 mb-2">가. 국어</h4>
                    <div id="korean-goals"></div>
                </div>
                <div>
                    <h4 class="font-semibold mt-4 mb-2">나. 수학</h4>
                    <div id="math-goals"></div>
                </div>
                <div>
                    <h3 class="text-xl font-bold mt-6 mb-2">향후 기술</h3>
                    <p class="text-gray-500">준비 중입니다.</p>
                </div>
            </div>`;
        }

        function buildAchievementTable(list) {
            if (!list.length) {
                return '<p class="text-gray-500">학습이 필요한 성취기준이 없습니다.</p>';
            }
            let html = '<table class="w-full border border-gray-300 text-sm"><thead><tr><th class="border px-2 py-1">학년(군)</th><th class="border px-2 py-1">성취기준</th></tr></thead><tbody>';
            list.forEach(item => {
                html += `<tr><td class="border px-2 py-1">${item.grade}</td><td class="border px-2 py-1">${item.text}</td></tr>`;
            });
            html += '</tbody></table>';
            return html;
        }

        function collectYellowAchievements(data, subject) {
            const result = [];
            for (const level of Object.keys(achievementTables)) {
                const table = achievementTables[level]?.[subject];
                if (!table) continue;
                const key = `${level}_${subject}`;
                const states = data[key] || [];
                const temp = document.createElement('div');
                temp.innerHTML = markdownTableToHtml(table);
                const rows = temp.querySelectorAll('tbody tr');
                rows.forEach((tr, rowIdx) => {
                    const grade = tr.cells[0].textContent.trim();
                    for (let i = 1; i < tr.cells.length; i++) {
                        if (states[rowIdx]?.[i - 1] === 1) {
                            const text = tr.cells[i].textContent.trim();
                            result.push({ grade, text });
                        }
                    }
                });
            }
            return result;
        }

        async function callGemini(prompt, json = false) {
            const payload = { contents: [{ role: 'user', parts: [{ text: prompt }] }], generationConfig: json ? { responseMimeType: 'application/json' } : {} };
            try {
                const response = await fetch('/.netlify/functions/gemini-handler', { method: 'POST', body: JSON.stringify(payload) });
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || '';
                if (json) return JSON.parse(text);
                return text;
            } catch (e) {
                console.error('AI error', e);
                return json ? {} : '';
            }
        }

        async function generateSemesterGoals(koreanList, mathList) {
            const subjects = [
                { name: '국어', list: koreanList, targetId: 'korean-goals' },
                { name: '수학', list: mathList, targetId: 'math-goals' }
            ];
            for (const { name, list, targetId } of subjects) {
                const target = document.getElementById(targetId);
                if (!list.length) {
                    target.innerHTML = '<p class="text-gray-500">학습이 필요한 성취기준이 없습니다.</p>';
                    continue;
                }
                target.innerHTML = '<p class="text-gray-500">생성 중...</p>';
                const prompt = `다음 성취기준을 바탕으로 ${name} 교과의 학기 교육목표를 1~5개의 문장으로 작성해줘. 각 문장은 '다.' 혹은 '한다.'로 끝나도록 하고 줄바꿈으로 구분해줘.\n\n성취기준:\n${list.map((item, idx) => `${idx + 1}. ${item.text}`).join('\n')}`;
                const result = await callGemini(prompt);
                const lines = result.split(/\n+/).map(l => l.trim()).filter(Boolean).slice(0, 5);
                let md = `| ${name} 학기 교육목표 |\n| --- |\n`;
                lines.forEach(line => { md += `| ${line} |\n`; });
                target.innerHTML = markdownTableToHtml(md);
            }
        }

        // --- Behavior Intervention Logic ---
        const startObservationBtn = document.getElementById('start-observation-btn');
        const behaviorLoggingSection = document.getElementById('behavior-logging-section');
        const logBehaviorBtn = document.getElementById('log-behavior-btn');
        let currentObservation = null;

        startObservationBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if(!user) return;
            
            const studentName = document.getElementById('behavior-student-name').value;
            const behavior = document.getElementById('target-behavior').value;
            const type = document.querySelector('#behavior-type-buttons .active').dataset.value;
            
            if (!studentName || !behavior) {
                alert('학생 이름과 목표 행동을 모두 입력해주세요.');
                return;
            }
            
            // Check for existing observation
            const q = query(collection(db, "users", user.uid, "behaviors"), where("studentName", "==", studentName), where("behavior", "==", behavior));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                // Create new observation
                const docRef = await addDoc(collection(db, "users", user.uid, "behaviors"), {
                    studentName: studentName,
                    behavior: behavior,
                    type: type,
                    createdAt: serverTimestamp()
                });
                currentObservation = { id: docRef.id, studentName, behavior };
            } else {
                const doc = querySnapshot.docs[0];
                currentObservation = { id: doc.id, ...doc.data() };
            }
            
            document.getElementById('logging-student').textContent = studentName;
            document.getElementById('logging-behavior').textContent = behavior;
            behaviorLoggingSection.classList.remove('hidden');
            
            loadBehaviorLogs();
        });

        logBehaviorBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user || !currentObservation) return;
            
            await addDoc(collection(db, "users", user.uid, "behaviors", currentObservation.id, "logs"), {
                timestamp: serverTimestamp()
            });
            showToast(`${currentObservation.behavior} 행동이 기록되었습니다.`);
            loadBehaviorLogs();
        });
        
        async function loadBehaviorLogs() {
            if (!currentObservation) return;
            const user = auth.currentUser;
            if(!user) return;
            
            const logsRef = collection(db, "users", user.uid, "behaviors", currentObservation.id, "logs");
            const q = query(logsRef, orderBy("timestamp", "asc"));
            const logSnapshot = await getDocs(q);
            
            const dailyCounts = {};
            logSnapshot.forEach(doc => {
                const date = doc.data().timestamp.toDate().toLocaleDateString();
                dailyCounts[date] = (dailyCounts[date] || 0) + 1;
            });
            
            const chartLabels = Object.keys(dailyCounts);
            const chartData = Object.values(dailyCounts);
            
            updateChart('behaviorChart', 'behaviorChartInstance', 'line', {
                labels: chartLabels,
                datasets: [{
                    label: `${currentObservation.behavior} 발생 빈도`,
                    data: chartData,
                    borderColor: '#0ea5e9',
                    backgroundColor: 'rgba(14, 165, 233, 0.1)',
                    fill: true,
                    tension: 0.1
                }]
            });
        }
        
        function initBehaviorChart() {
             updateChart('behaviorChart', 'behaviorChartInstance', 'line', {
                labels: [],
                datasets: [{ label: '행동 발생 빈도', data: [] }]
            }, {
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
            });
        }

        // --- UTILITY FUNCTIONS ---
        function showToast(message) {
            toast.textContent = message;
            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 2000);
        }

        function updateChart(canvasId, instanceVar, type, data, options = {}) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            if (window[instanceVar]) {
                window[instanceVar].destroy();
            }

            window[instanceVar] = new Chart(ctx, { type, data, options });
        }
        
        // Initial load
        window.addEventListener('hashchange', () => {
            const currentView = window.location.hash.replace('#', '') || 'home';
            switchView(currentView);
        });

    </script>
</body>
</html>

