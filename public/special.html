<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>에이두 스페셜 - 특수교사 업무 보조</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Noto Sans KR', sans-serif; }
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .login-tab {
            border-bottom: 2px solid transparent;
            color: #475569;
            transition: color 0.2s, border-color 0.2s;
        }
        .login-tab.active {
            border-bottom-color: #0ea5e9;
            color: #0ea5e9;
            font-weight: 600;
        }
        .form-input {
            transition: all 0.3s;
        }
        .form-input:focus {
            border-color: #0ea5e9;
            box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.2);
            outline: none;
        }
        .btn {
            transition: background-color 0.3s, color 0.3s, opacity 0.3s;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            background-color: #0ea5e9;
            color: #ffffff;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #0284c7;
        }
        .btn-secondary {
            background-color: #e2e8f0;
            color: #1e293b;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #cbd5f5;
        }
        .content-section {
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: white;
        }
        .content-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
        }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #0ea5e9; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .nav-link { padding: 0.5rem 1rem; border-radius: 0.375rem; transition: background-color 0.2s, color 0.2s; }
        .nav-link.active { background-color: #0284c7; color: white; }
        .nav-link:not(.active):hover { background-color: #f3f4f6; }
        .tab-btn {
             transition: all 0.2s;
             border: 2px solid transparent;
        }
        .tab-btn.active {
             background-color: #0ea5e9; /* sky-500 */
             color: white;
             border-color: #0284c7; /* sky-600 */
             font-weight: 600;
        }
        .tab-btn:not(.active) {
            background-color: #f1f5f9; /* slate-100 */
            color: #475569; /* slate-600 */
        }
        .modify-target-btn {
            padding: 0.4rem 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #bae6fd;
            background-color: #f8fafc;
            color: #0369a1;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s, box-shadow 0.2s;
        }
        .modify-target-btn:hover {
            background-color: #e0f2fe;
            border-color: #7dd3fc;
        }
        .modify-target-btn.active {
            background-color: #0ea5e9;
            border-color: #0284c7;
            color: #ffffff;
            box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.2);
        }
        .manual-editing {
            outline: 2px dashed #0ea5e9;
            outline-offset: 4px;
        }
        .monthly-plan-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            font-size: 0.95rem;
        }
        .monthly-plan-table th,
        .monthly-plan-table td {
            border: 1px solid #cbd5e1;
            padding: 0.75rem;
            vertical-align: top;
        }
        .monthly-plan-table .monthly-plan-title {
            background-color: #e2e8f0;
            text-align: center;
            font-weight: 700;
            font-size: 1rem;
        }
        .monthly-plan-table .monthly-plan-section-header {
            background-color: #f1f5f9;
            text-align: center;
            font-weight: 600;
            width: 50%;
        }
        .monthly-plan-table .monthly-plan-footer {
            background-color: #dbeafe;
            text-align: center;
            font-weight: 600;
        }
        .monthly-plan-table .monthly-plan-empty {
            height: 80px;
        }
        .monthly-plan-table .data-cell {
            width: 50%;
            line-height: 1.6;
        }
        .iep-pages-wrapper {
            position: relative;
        }
        .iep-cover-actions {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            display: flex;
            gap: 0.5rem;
            z-index: 10;
        }
        .iep-cover-actions button {
            box-shadow: 0 4px 10px rgba(148, 163, 184, 0.2);
        }
        .iep-page-collection {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .iep-page {
            width: 210mm;
            min-height: 284mm;
            margin: 0 auto;
            padding: 25mm;
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .iep-page-cover {
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
        }
        .markdown-table-remove-column {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 9999px;
            border: none;
            background: transparent;
            color: #ef4444;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .markdown-table-remove-column:hover {
            background-color: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }
        .iep-cover-footer {
            margin-top: auto;
            font-weight: 500;
            align-self: flex-end;
        }
        .iep-page-inner {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .iep-page-inner table {
            width: 100%;
        }
        .iep-month-block {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .iep-month-content {
            min-height: 120px;
        }
        .iep-page + .iep-page {
            margin-top: 1.5rem;
        }
        .major-eval-page {
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            padding: 20mm;
            background-color: #ffffff;
            border: 1px solid #cbd5e1;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.1);
            box-sizing: border-box;
            position: relative;
        }
        .major-eval-page + .major-eval-page {
            margin-top: 1.5rem;
        }
        .major-eval-copy-btn {
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid #bae6fd;
            color: #0284c7;
            background-color: #f8fafc;
            border-radius: 0.375rem;
            padding: 0.35rem 0.75rem;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .major-eval-copy-btn:hover {
            background-color: #e0f2fe;
            border-color: #7dd3fc;
        }
        @media (max-width: 640px) {
            .app-header nav {
                gap: 0.2rem;
            }
            .app-header .nav-link {
                font-size: 0.625rem;
                padding: 0.25rem 0.5rem;
            }
            .app-title {
                font-size: 1rem;
            }
        }
        @media print {
            .major-eval-page {
                box-shadow: none;
                page-break-after: always;
            }
            .major-eval-page:last-child {
                page-break-after: auto;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="app">
        <!-- Auth View (Login/Signup) -->
        <div id="auth-view" class="min-h-screen flex items-center justify-center bg-gray-100">
            <div class="w-full max-w-md bg-white rounded-lg shadow-md p-8">
                <div id="login-view" class="view active">
                    <h2 class="text-2xl font-bold text-center text-sky-600 mb-6">에이두 스페셜 시작하기</h2>
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                            <button id="student-login-tab" class="login-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">🧑‍🎓 학생</button>
                            <button id="teacher-login-tab" class="login-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">🧑‍🏫 교사</button>
                        </nav>
                    </div>
                    <div id="student-login-content" class="tab-content pt-6">
                        <div class="mb-4">
                            <label for="student-code" class="block text-sm font-medium text-gray-700 mb-1">고유 숫자 코드</label>
                            <input type="text" id="student-code" class="w-full border border-gray-300 rounded-md p-2 form-input" placeholder="발급받은 코드를 입력하세요">
                        </div>
                        <p id="student-login-error" class="text-red-500 text-sm mb-4 hidden"></p>
                        <button id="student-login-btn" class="w-full py-2 rounded-md btn btn-primary font-semibold">학생 로그인</button>
                    </div>
                    <div id="teacher-login-content" class="tab-content pt-6">
                        <div class="mb-4">
                            <label for="teacher-email" class="block text-sm font-medium text-gray-700 mb-1">이메일</label>
                            <input type="email" id="teacher-email" class="w-full border border-gray-300 rounded-md p-2 form-input" placeholder="example@email.com">
                        </div>
                        <div class="mb-6">
                            <label for="teacher-password" class="block text-sm font-medium text-gray-700 mb-1">비밀번호</label>
                            <input type="password" id="teacher-password" class="w-full border border-gray-300 rounded-md p-2 form-input" placeholder="••••••••">
                        </div>
                        <p id="teacher-login-error" class="text-red-500 text-sm mb-4 hidden"></p>
                        <button id="teacher-login-btn" class="w-full py-2 rounded-md btn btn-primary font-semibold">교사 로그인</button>
                        <button id="teacher-google-login-btn" class="w-full py-2 mt-2 rounded-md btn border border-gray-300 bg-white text-gray-700 font-semibold flex items-center justify-center gap-2 hover:bg-gray-50">
                            <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                            Google 계정으로 로그인
                        </button>
                    </div>
                    <div class="mt-6 text-center space-y-2">
                        <button id="show-student-register-btn" class="w-full text-sm text-sky-600 hover:underline">처음이신가요? 학생 등록하기</button>
                        <button id="show-teacher-register-btn" class="w-full text-sm text-sky-600 hover:underline">교사이신가요? 회원가입하기</button>
                    </div>
                </div>
                <div id="student-register-view" class="view">
                    <h2 class="text-2xl font-bold text-center text-sky-600 mb-6">🧑‍🎓 학생 등록</h2>
                    <div class="mb-4">
                        <label for="student-name" class="block text-sm font-medium text-gray-700 mb-1">이름</label>
                        <input type="text" id="student-name" class="w-full border border-gray-300 rounded-md p-2 form-input" placeholder="이름을 입력하세요">
                    </div>
                    <p id="student-register-error" class="text-red-500 text-sm mb-4 hidden"></p>
                    <button id="student-register-btn" class="w-full py-2 rounded-md btn btn-primary font-semibold mb-4">등록하고 코드 받기</button>
                    <button id="back-to-login-btn" class="w-full text-sm text-gray-600 hover:underline">로그인 화면으로 돌아가기</button>
                </div>
                <div id="teacher-register-view" class="view">
                    <h2 class="text-2xl font-bold text-center text-sky-600 mb-6">🧑‍🏫 교사 회원가입</h2>
                    <div class="mb-4">
                        <label for="teacher-register-name" class="block text-sm font-medium text-gray-700 mb-1">이름</label>
                        <input type="text" id="teacher-register-name" class="w-full border border-gray-300 rounded-md p-2 form-input" placeholder="이름을 입력하세요">
                    </div>
                    <div class="mb-4">
                        <label for="teacher-register-email" class="block text-sm font-medium text-gray-700 mb-1">이메일</label>
                        <input type="email" id="teacher-register-email" class="w-full border border-gray-300 rounded-md p-2 form-input" placeholder="example@email.com">
                    </div>
                    <div class="mb-6">
                        <label for="teacher-register-password" class="block text-sm font-medium text-gray-700 mb-1">비밀번호</label>
                        <input type="password" id="teacher-register-password" class="w-full border border-gray-300 rounded-md p-2 form-input" placeholder="6자리 이상 비밀번호를 입력하세요">
                    </div>
                    <p id="teacher-register-error" class="text-red-500 text-sm mb-4 hidden"></p>
                    <button id="teacher-register-btn" class="w-full py-2 rounded-md btn btn-primary font-semibold mb-4">회원가입</button>
                    <button id="teacher-back-to-login-btn" class="w-full text-sm text-gray-600 hover:underline">로그인 화면으로 돌아가기</button>
                </div>
            </div>
        </div>

        <!-- Main App View -->
        <div id="main-app-view" class="hidden flex-col min-h-screen">
            <header class="app-header bg-white shadow-md w-full sticky top-0 z-50">
                <div class="container mx-auto px-4 sm:px-6 py-3 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                    <h1 class="app-title text-lg sm:text-2xl font-bold text-sky-600"><a href="#home" id="home-link">📝 에이두 스페셜</a></h1>
                    <nav class="flex flex-wrap items-center gap-2 sm:gap-4 text-[0.7rem] sm:text-sm">
                        <span id="user-email" class="text-[0.65rem] sm:text-xs text-gray-600"></span>
                        <a href="#home" id="nav-home" data-view="home" class="nav-link text-[0.7rem] sm:text-sm">홈</a>
                        <a href="#my-class" id="nav-my-class" data-view="my-class" class="nav-link text-[0.7rem] sm:text-sm">내 학급 관리</a>
                        <a href="#sketchbook" id="nav-sketchbook" data-view="sketchbook" class="nav-link text-[0.7rem] sm:text-sm">에이두 스케치북</a>
                        <!-- IEP navigation link; '개별화교육계획' is commonly referred to as 'IEP'. Modify this section when updating 'iep'. -->
                        <a href="#iep" id="nav-iep" data-view="iep" class="nav-link text-[0.7rem] sm:text-sm">개별화교육계획(IEP)</a>
                        <a href="#templates" id="nav-templates" data-view="templates" class="nav-link text-[0.7rem] sm:text-sm">서식 생성</a>
                        <a href="#behavior" id="nav-behavior" data-view="behavior" class="nav-link text-[0.7rem] sm:text-sm">행동 기록</a>
                        <a href="#sketchbook" id="nav-sketchbook-secondary" data-view="sketchbook" class="nav-link text-[0.7rem] sm:text-sm">에이두 스케치북</a>
                        <button id="logout-btn" class="text-xs sm:text-sm bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-md transition-colors">로그아웃</button>
                    </nav>
                </div>
            </header>
            <main class="flex-grow container mx-auto p-4 sm:p-6">
                <!-- Home View -->
                <div id="home-view" class="space-y-6">
                    <h2 class="text-3xl font-bold">홈</h2>
                    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg">
                        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between mb-4">
                            <div>
                                <h3 class="text-lg sm:text-xl font-bold text-slate-800">간편 행동 기록</h3>
                                <p class="text-xs text-slate-500">공유받은 행동과 나의 행동을 한 자리에서 빠르게 기록하세요.</p>
                            </div>
                            <button id="home-behavior-refresh" class="self-start rounded-md border border-sky-200 px-3 py-1 text-xs font-medium text-sky-600 transition hover:bg-sky-50">새로고침</button>
                        </div>
                        <div id="home-behavior-table" class="space-y-3">
                            <p class="text-sm text-gray-500">행동 기록을 불러오는 중입니다...</p>
                        </div>
                    </div>
                </div>

                <!-- Sketchbook View -->
                <div id="sketchbook-view" class="hidden space-y-6">
                    <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
                        <div>
                            <h2 class="text-3xl font-bold">에이두 스케치북</h2>
                            <p class="text-sm text-slate-500">수업 아이디어와 활동 자료를 한 곳에 모아보세요. 스케치북을 만들고 학생과 동료 교사와 손쉽게 공유할 수 있습니다.</p>
                        </div>
                        <button data-action="create-sketch" class="self-start rounded-md bg-sky-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-sky-700">새 스케치북 만들기</button>
                    </div>
                    <div class="grid gap-6 lg:grid-cols-[2fr,1fr]">
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between mb-4">
                                <div>
                                    <h3 class="text-xl font-semibold text-slate-800">내 스케치북</h3>
                                    <p class="text-sm text-slate-500">최근 순으로 정리된 스케치북 목록입니다.</p>
                                </div>
                                <button data-action="create-sketch" class="rounded-md border border-sky-200 bg-white px-3 py-1.5 text-xs font-semibold text-sky-600 transition hover:bg-sky-50">빠르게 만들기</button>
                            </div>
                            <ul id="sketchbook-list" class="space-y-3 max-h-[520px] overflow-y-auto">
                                <li class="text-sm text-gray-500">스케치북을 불러오는 중입니다...</li>
                            </ul>
                        </div>
                        <div class="space-y-6">
                            <div class="bg-white p-6 rounded-lg shadow-lg">
                                <h3 class="text-base font-semibold text-slate-800">활용 가이드</h3>
                                <ul class="mt-3 space-y-3 text-sm text-slate-600">
                                    <li class="flex items-start gap-2"><span class="mt-1 inline-flex h-2 w-2 flex-shrink-0 rounded-full bg-sky-500"></span><span>수업 전 개요, 학습 자료, 평가 계획을 레이어별로 정리해 보세요.</span></li>
                                    <li class="flex items-start gap-2"><span class="mt-1 inline-flex h-2 w-2 flex-shrink-0 rounded-full bg-emerald-500"></span><span>스케치북 코드로 동료 교사에게 공유하고 공동 작업을 진행하세요.</span></li>
                                    <li class="flex items-start gap-2"><span class="mt-1 inline-flex h-2 w-2 flex-shrink-0 rounded-full bg-amber-500"></span><span>Excalidraw 파일을 불러와 기존 아이디어를 빠르게 수정할 수 있습니다.</span></li>
                                </ul>
                            </div>
                            <div class="bg-sky-50 border border-sky-100 p-6 rounded-lg shadow-inner">
                                <h3 class="text-base font-semibold text-sky-700">공유 팁</h3>
                                <p class="mt-2 text-sm text-sky-700">공유받은 코드는 스케치북 상세 화면에서 입력할 수 있습니다. 학생과 함께 사용할 경우, 읽기 전용 링크를 복사해 안내하세요.</p>
                                <div class="mt-4 space-y-2 text-xs text-sky-800">
                                    <p class="flex items-start gap-2"><span class="mt-1 inline-flex h-2 w-2 flex-shrink-0 rounded-full bg-sky-600"></span>코드를 분실했다면 스케치북 카드에서 &lsquo;공유 코드 확인&rsquo;을 눌러 다시 확인할 수 있습니다.</p>
                                    <p class="flex items-start gap-2"><span class="mt-1 inline-flex h-2 w-2 flex-shrink-0 rounded-full bg-sky-600"></span>학생과 실시간 수업을 진행할 땐 화면 공유와 함께 드로잉 모드를 활용해보세요.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- My Class View -->
                <div id="my-class-view" class="hidden">
                    <h2 class="text-3xl font-bold mb-6">내 학급 관리</h2>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <div id="class-header" class="flex justify-between items-center mb-4">
                            <h3 id="class-title" class="text-xl font-bold">내 학급</h3>
                            <button id="add-class-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded">내 학급 만들기</button>
                        </div>
                        <div id="class-list" class="space-y-3">
                            <!-- Class items will be dynamically inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Create Class Modal -->
                <div id="create-class-modal" class="fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-50 px-4">
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-sky-700">내 학급 만들기</h3>
                            <button type="button" id="create-class-close-btn" class="text-2xl leading-none text-sky-500 hover:text-sky-700">&times;</button>
                        </div>
                        <p class="text-sm text-gray-600 mb-4">학생들과 함께 사용할 학급 이름을 입력해주세요. 학급은 한 번만 생성할 수 있습니다.</p>
                        <form id="create-class-form" class="space-y-4">
                            <div>
                                <label for="create-class-name" class="block text-sm font-medium text-gray-700 mb-1">학급 이름</label>
                                <input type="text" id="create-class-name" class="w-full border border-gray-300 rounded-md p-2 form-input" placeholder="예: 함께반" autocomplete="off">
                            </div>
                            <div class="flex justify-end gap-2">
                                <button type="button" id="create-class-cancel-btn" class="px-4 py-2 rounded-md btn btn-secondary">취소</button>
                                <button type="submit" id="create-class-confirm-btn" class="px-4 py-2 rounded-md btn btn-primary font-semibold">만들기</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- IEP View -->
                <div id="iep-view" class="hidden">
                     <h2 class="text-3xl font-bold mb-6">개별화교육계획(IEP) 수립</h2>
                     <div class="flex flex-col lg:flex-row gap-6">
                        <aside class="w-full lg:w-1/3 bg-white p-6 rounded-lg shadow-lg h-fit lg:sticky top-24">
                            <h3 class="text-lg font-semibold mb-4">내 학급</h3>
                            <div id="iep-student-list" class="grid grid-cols-4 gap-2">
                                <!-- 학생 목록이 여기에 표시됩니다. -->
                            </div>
                            <div id="iep-modify-section" class="mt-6 hidden">
                                <div id="iep-save-section" class="mb-4 hidden">
                                    <h4 class="font-semibold mb-2">저장 테이블</h4>
                                    <div class="flex flex-wrap gap-2">
                                        <button id="save-iep-btn" class="flex-1 min-w-[140px] bg-sky-600 hover:bg-sky-700 text-white text-sm font-semibold px-3 py-2 rounded transition">저장</button>
                                        <button id="save-pdf-btn" class="flex-1 min-w-[140px] bg-gray-500 hover:bg-gray-600 text-white text-sm font-semibold px-3 py-2 rounded transition">PDF 저장</button>
                                    </div>
                                </div>
                                <div id="iep-generation-section" class="mb-4 hidden">
                                    <h4 class="font-semibold mb-2">생성 테이블</h4>
                                    <div class="flex flex-wrap gap-2">
                                        <button id="iep-achievement-btn" class="flex-1 min-w-[180px] border border-sky-500 text-sky-600 text-sm font-medium px-3 py-2 rounded transition hover:bg-sky-50">성취 기준 이동</button>
                                        <button id="generate-semester-goals-btn" class="flex-1 min-w-[180px] border border-sky-500 text-sky-600 text-sm font-medium px-3 py-2 rounded transition hover:bg-sky-50">학기 교육목표 생성</button>
                                        <button id="generate-monthly-plan-btn" class="flex-1 min-w-[220px] border border-sky-500 text-sky-600 text-sm font-medium px-3 py-2 rounded transition hover:bg-sky-50 hidden">월별 교육목표/내용/방법 생성하기</button>
                                    </div>
                                </div>
                                <h4 class="font-semibold mb-2">수정 테이블</h4>
                                <div class="mb-3">
                                    <div id="iep-modify-targets" class="flex flex-wrap gap-2"></div>
                                </div>
                                <div class="flex items-start gap-2">
                                    <textarea id="iep-modify-input" class="w-full border rounded-md p-2 text-sm" rows="3" placeholder="수정할 내용을 입력하세요"></textarea>
                                    <button id="iep-modify-btn" class="bg-sky-600 hover:bg-sky-700 text-white text-sm px-3 py-1 rounded h-9">수정</button>
                                </div>
                                <div class="mt-2">
                                    <button id="iep-manual-edit-btn" class="border border-sky-500 text-sky-600 text-sm font-medium px-3 py-1 rounded transition hover:bg-sky-50">수동 편집</button>
                                </div>
                            </div>
                        </aside>
                        <section class="w-full lg:w-2/3">
                            <div id="iep-output" class="bg-white p-8 rounded-lg shadow-lg overflow-x-auto">
                                <p class="text-gray-500">학생을 선택하면 IEP 정보가 표시됩니다.</p>
                            </div>
                        </section>
                    </div>
                </div>

                <!-- Template Generator View -->
                <div id="templates-view" class="hidden">
                    <h2 class="text-3xl font-bold mb-6">AI 서식 생성</h2>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-bold mb-4">카테고리</h3>
                        <div id="template-category-buttons" class="flex flex-wrap gap-3">
                            <button type="button" data-template-category="major-eval" class="tab-btn py-2 px-4 rounded">전공과 심사표</button>
                        </div>
                    </div>
                    <div id="major-eval-workspace" class="hidden mt-6">
                        <div class="flex flex-col lg:flex-row gap-6">
                            <aside class="w-full lg:w-1/3 bg-white p-6 rounded-lg shadow-lg space-y-6">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-lg font-semibold">전공과 심사표 목록</h3>
                                    <button type="button" id="major-eval-add-btn" class="bg-sky-600 hover:bg-sky-700 text-white text-sm font-semibold px-3 py-2 rounded">추가</button>
                                </div>
                                <div>
                                    <ul id="major-eval-list" class="space-y-2"></ul>
                                    <p id="major-eval-empty" class="text-sm text-gray-500">추가 버튼을 눌러 심사표를 생성해보세요.</p>
                                </div>
                                <div id="major-eval-input-section" class="hidden space-y-4">
                                    <div>
                                        <h4 class="text-base font-semibold mb-2">입력 테이블</h4>
                                        <table class="w-full border border-gray-200 text-sm">
                                            <tbody class="divide-y divide-gray-200">
                                                <tr>
                                                    <th scope="row" class="bg-gray-50 px-3 py-2 text-left font-medium w-28">학교 이름</th>
                                                    <td class="px-3 py-2">
                                                        <input type="text" id="major-eval-school" class="w-full border border-gray-300 rounded-md p-2 text-sm" placeholder="예: 행복학교">
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th scope="row" class="bg-gray-50 px-3 py-2 text-left font-medium">영역</th>
                                                    <td class="px-3 py-2">
                                                        <input type="text" id="major-eval-domain" class="w-full border border-gray-300 rounded-md p-2 text-sm" placeholder="예: 호텔 서비스">
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th scope="row" class="bg-gray-50 px-3 py-2 text-left font-medium">문항 수</th>
                                                    <td class="px-3 py-2">
                                                        <input type="number" id="major-eval-questions" class="w-full border border-gray-300 rounded-md p-2 text-sm" min="1" value="5">
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th scope="row" class="bg-gray-50 px-3 py-2 text-left font-medium">평가 주제</th>
                                                    <td class="px-3 py-2">
                                                        <input type="text" id="major-eval-topic" class="w-full border border-gray-300 rounded-md p-2 text-sm" placeholder="예: 객실 정리">
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <button type="button" id="major-eval-generate-btn" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 rounded">생성</button>
                                </div>
                                <div id="major-eval-upload-section" class="hidden space-y-2">
                                    <button type="button" id="major-eval-upload-btn" class="inline-flex items-center gap-2 bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm font-semibold px-3 py-2 rounded transition disabled:opacity-60 disabled:cursor-not-allowed">예시 파일 업로드</button>
                                    <p id="major-eval-upload-info" class="text-xs text-gray-500 hidden"></p>
                                    <input type="file" id="major-eval-upload-input" accept="application/pdf" class="hidden">
                                </div>
                                <div id="major-eval-modify-section" class="hidden space-y-6">
                                    <div class="space-y-3">
                                        <h4 class="text-base font-semibold">저장 테이블</h4>
                                        <div class="flex flex-wrap items-center gap-2">
                                            <button type="button" id="major-eval-edit-toggle-btn" class="bg-white border border-sky-300 text-sky-600 hover:bg-sky-50 text-sm font-semibold px-3 py-2 rounded transition">편집</button>
                                            <button type="button" id="major-eval-save-btn" class="bg-sky-600 hover:bg-sky-700 text-white text-sm font-semibold px-3 py-2 rounded transition">저장</button>
                                            <button type="button" id="major-eval-pdf-btn" class="bg-amber-500 hover:bg-amber-600 text-white text-sm font-semibold px-3 py-2 rounded transition">PDF 저장</button>
                                        </div>
                                        <p class="text-xs text-gray-500">수동 편집을 완료한 후 저장 버튼을 누르면 편집 내용이 유지됩니다.</p>
                                    </div>
                                    <div class="space-y-3">
                                        <h4 class="text-base font-semibold">수정 테이블</h4>
                                        <p class="text-xs text-gray-500">수정 내용을 입력하고 엔터 또는 수정 버튼을 눌러주세요.</p>
                                        <textarea id="major-eval-modify-input" class="w-full border border-gray-300 rounded-md p-2 text-sm" rows="4" placeholder="예: 3번 문항을 난이도를 낮추어 수정해줘"></textarea>
                                        <button type="button" id="major-eval-modify-btn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 rounded">수정</button>
                                    </div>
                                    <div class="space-y-2">
                                        <div class="flex flex-wrap items-center gap-2">
                                            <input type="number" id="major-eval-question-increase" class="border border-gray-300 rounded-md p-2 text-sm w-20" min="1" value="1">
                                            <button type="button" id="major-eval-question-increase-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white text-sm font-semibold px-3 py-2 rounded transition">심사표/기록지 문항 늘리기</button>
                                        </div>
                                        <p class="text-xs text-gray-500">입력한 숫자만큼 심사표와 기록지에 빈 문항이 추가됩니다.</p>
                                    </div>
                                </div>
                            </aside>
                            <section class="flex-1">
                                <div id="major-eval-output" class="bg-white p-6 rounded-lg shadow-lg min-h-[320px] text-sm text-gray-700">
                                    <p class="text-gray-500">왼쪽 목록에서 심사표를 선택하면 결과가 표시됩니다.</p>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>

                <!-- Behavior Intervention View -->

                <div id="behavior-view" class="hidden">
                    <h2 class="text-3xl font-bold mb-6">행동 기록</h2>
                    <div class="flex flex-col lg:flex-row gap-6">
                        <aside class="w-full lg:w-1/3 bg-white p-6 rounded-lg shadow-lg h-fit lg:sticky top-24 space-y-4">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold">내 학생 목록</h3>
                                <button id="refresh-behavior-students" class="text-xs text-sky-600 hover:underline">새로고침</button>
                            </div>
                            <p class="text-sm text-gray-500">학생을 선택하면 오른쪽에서 행동 기록을 확인하고 추가할 수 있습니다.</p>
                            <div id="behavior-student-list" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2 max-h-[520px] overflow-y-auto pr-1">
                                <p class="text-sm text-gray-500">학생 목록을 불러오는 중입니다...</p>
                            </div>
                            <div>
                                <div class="mt-6 flex items-center justify-between">
                                    <h3 class="text-lg font-semibold">공유 기록 목록</h3>
                                    <button id="refresh-shared-behaviors" class="text-xs text-sky-600 hover:underline">새로고침</button>
                                </div>
                                <p class="text-sm text-gray-500">공유 받은 행동 기록을 확인할 수 있습니다.</p>
                                <div id="behavior-shared-list" class="mt-2 space-y-2 max-h-[320px] overflow-y-auto pr-1">
                                    <p class="text-sm text-gray-500">공유 받은 행동 기록이 없습니다.</p>
                                </div>
                            </div>
                        </aside>
                        <section class="w-full lg:w-2/3 space-y-6">
                            <div class="bg-white p-6 rounded-lg shadow-lg">
                                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
                                    <div>
                                        <h3 class="text-xl font-bold">행동 기록</h3>
                                        <p id="behavior-selected-student" class="text-sm text-gray-500">학생을 선택해주세요.</p>
                                    </div>
                                    <button id="open-behavior-modal" class="inline-flex items-center justify-center gap-2 rounded-lg bg-sky-600 text-white px-4 py-2 text-sm font-semibold shadow-sm hover:bg-sky-700 disabled:cursor-not-allowed disabled:opacity-50">
                                        <span>추가</span>
                                    </button>
                                </div>
                                <div id="behavior-record-list" class="mt-4 space-y-2">
                                    <p class="text-sm text-gray-500">학생을 선택하면 행동 기록이 표시됩니다.</p>
                                </div>
                            </div>
                            <div id="behavior-detail-panel" class="bg-white p-6 rounded-lg shadow-lg hidden">
                                <div class="flex flex-col gap-2 mb-6">
                                    <div class="flex flex-wrap items-start justify-between gap-2">
                                        <div class="flex flex-wrap items-center gap-2">
                                            <h3 id="behavior-detail-title" class="text-2xl font-bold text-slate-800"></h3>
                                            <span id="behavior-reinforcer-badge" class="hidden rounded-full bg-emerald-100 px-3 py-1 text-xs font-semibold text-emerald-700">강화물</span>
                                            <span id="behavior-attention-badge" class="hidden rounded-full bg-amber-100 px-3 py-1 text-xs font-semibold text-amber-700">주의 토큰</span>
                                        </div>
                                        <button id="behavior-share-btn" class="hidden inline-flex items-center gap-2 rounded-lg border border-sky-200 px-3 py-1.5 text-sm font-semibold text-sky-600 transition hover:bg-sky-50">공유</button>
                                    </div>
                                    <p id="behavior-operational-definition" class="text-sm text-gray-600 whitespace-pre-line"></p>
                                </div>
                                <div class="mb-6">
                                    <div class="flex flex-col gap-4 lg:flex-row lg:items-start">
                                        <div class="flex-1">
                                            <h4 class="text-lg font-semibold mb-2">행동 관찰 그래프</h4>
                                            <div class="h-72">
                                                <canvas id="behaviorChart"></canvas>
                                            </div>
                                        </div>
                                        <div class="w-full lg:w-56 rounded-lg border border-slate-200 bg-slate-50 p-4">
                                            <h5 class="text-sm font-semibold text-slate-700 mb-3">그래프 보기</h5>
                                            <div id="behavior-graph-view-buttons" class="space-y-2">
                                                <button type="button" data-view="hourly" class="graph-view-btn w-full rounded-md border border-sky-200 bg-white px-3 py-2 text-sm font-medium text-sky-600 transition hover:bg-sky-50">시간별</button>
                                                <button type="button" data-view="daily" class="graph-view-btn w-full rounded-md border border-sky-600 bg-sky-600 px-3 py-2 text-sm font-medium text-white transition hover:bg-sky-700">일별</button>
                                                <button type="button" data-view="monthly" class="graph-view-btn w-full rounded-md border border-sky-200 bg-white px-3 py-2 text-sm font-medium text-sky-600 transition hover:bg-sky-50">월별</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between mb-4">
                                    <span class="text-sm font-medium text-gray-700">기록 버튼</span>
                                    <button id="log-behavior-btn" class="inline-flex items-center gap-2 rounded-lg bg-emerald-500 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-emerald-600 disabled:opacity-50 disabled:cursor-not-allowed">기록</button>
                                </div>
                                <div>
                                    <h4 class="text-base font-semibold mb-3">타임스탬프 기록</h4>
                                    <ul id="behavior-log-list" class="space-y-2 max-h-64 overflow-y-auto bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm text-slate-700">
                                        <li class="text-gray-500">기록이 없습니다.</li>
                                    </ul>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
<!-- Achievement Criteria View -->
                <div id="achievement-view" class="hidden">
                    <h2 class="text-3xl font-bold mb-6">성취기준 기록</h2>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <button id="back-to-class-btn" class="text-sm text-sky-600 hover:underline mb-4">&larr; 내 학급으로</button>
                        <h3 id="achievement-student" class="text-xl font-bold mb-4"></h3>
                        <div class="mb-4 space-y-4">
                            <div>
                                <span class="font-semibold mr-2">학교급</span>
                                <div id="level-buttons" class="inline-flex gap-2">
                                    <button data-value="elementary" class="tab-btn py-1 px-3 rounded active">초등학교</button>
                                    <button data-value="middle" class="tab-btn py-1 px-3 rounded">중학교</button>
                                    <button data-value="high" class="tab-btn py-1 px-3 rounded">고등학교</button>
                                </div>
                            </div>
                            <div>
                                <span class="font-semibold mr-2">교과</span>
                                <div id="subject-buttons" class="inline-flex gap-2">
                                    <button data-value="korean" class="tab-btn py-1 px-3 rounded active">국어</button>
                                    <button data-value="math" class="tab-btn py-1 px-3 rounded">수학</button>
                                </div>
                            </div>
                            <div>
                                <span class="font-semibold mr-2">학년(군)</span>
                                <div id="grade-buttons" class="inline-flex gap-2"></div>
                            </div>
                        </div>
                        <button id="save-achievement-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded mb-4">저장</button>
                        <div id="achievement-table" class="overflow-x-auto"></div>
                    </div>
                </div>

            </main>
        </div>
        

        <!-- Behavior Entry Modal -->
        <div id="behavior-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 p-4">
            <div class="w-full max-w-md rounded-xl bg-white p-6 shadow-xl">
                <h3 class="text-xl font-semibold text-slate-800">행동 기록 추가</h3>
                <p class="mt-1 text-sm text-gray-500">선택한 학생의 행동 기록을 추가로 관리할 수 있습니다.</p>
                <div class="mt-5 space-y-4">
                    <div>
                        <label for="behavior-modal-title" class="block text-sm font-medium text-gray-700">제목</label>
                        <input id="behavior-modal-title" type="text" class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-200" placeholder="예: 수업 중 자리 이탈">
                    </div>
                    <div class="flex flex-col gap-2 rounded-lg border border-slate-200 p-3 text-sm text-slate-700">
                        <label class="inline-flex items-center gap-2">
                            <input id="behavior-modal-reinforcer" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500">
                            <span>강화물 사용</span>
                        </label>
                        <label class="inline-flex items-center gap-2">
                            <input id="behavior-modal-attention" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-amber-500 focus:ring-amber-400">
                            <span>주의 토큰 사용</span>
                        </label>
                    </div>
                    <div>
                        <label for="behavior-modal-definition" class="block text-sm font-medium text-gray-700">조작적 정의</label>
                        <textarea id="behavior-modal-definition" rows="4" class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-200" placeholder="행동을 관찰 가능하게 설명해주세요."></textarea>
                    </div>
                </div>
                <div class="mt-6 flex items-center justify-end gap-2">
                    <button id="behavior-modal-cancel" type="button" class="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-50">취소</button>
                    <button id="behavior-modal-save" type="button" class="rounded-lg bg-sky-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-sky-700">추가</button>
                </div>
            </div>
        </div>

        <!-- Behavior Share Modal -->
        <div id="behavior-share-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 p-4">
            <div class="w-full max-w-lg rounded-xl bg-white p-6 shadow-xl">
                <div class="flex items-start justify-between">
                    <div>
                        <h3 class="text-xl font-semibold text-slate-800">행동 기록 공유</h3>
                        <p class="mt-1 text-sm text-gray-500">공유할 이용자를 선택하세요.</p>
                    </div>
                    <button id="behavior-share-close" type="button" class="text-2xl font-semibold text-slate-400 hover:text-slate-600">&times;</button>
                </div>
                <div id="behavior-share-user-list" class="mt-5 max-h-72 overflow-y-auto rounded-lg border border-slate-200 p-3 text-sm text-slate-700 space-y-2">
                    <p class="text-sm text-gray-500">이용자 목록을 불러오는 중입니다...</p>
                </div>
                <div class="mt-6 flex justify-end gap-2">
                    <button id="behavior-share-cancel" type="button" class="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-50">취소</button>
                    <button id="behavior-share-confirm" type="button" class="rounded-lg bg-sky-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-sky-700">공유</button>
                </div>
            </div>
        </div>

        <!-- Behavior Log Note Modal -->
        <div id="behavior-log-note-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 p-4">
            <div class="w-full max-w-lg rounded-xl bg-white p-6 shadow-xl">
                <div class="flex items-start justify-between gap-3">
                    <div>
                        <h3 class="text-xl font-semibold text-slate-800">특이 사항 기록</h3>
                        <p id="behavior-log-note-meta" class="mt-1 text-sm text-gray-500"></p>
                    </div>
                    <button id="behavior-log-note-close" type="button" class="text-2xl font-semibold text-slate-400 hover:text-slate-600">&times;</button>
                </div>
                <div class="mt-5 space-y-3">
                    <div>
                        <label for="behavior-log-note-input" class="block text-sm font-medium text-gray-700">특이 사항</label>
                        <textarea id="behavior-log-note-input" rows="4" class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-200" placeholder="특이 사항을 기록해주세요."></textarea>
                    </div>
                </div>
                <div class="mt-6 flex items-center justify-between gap-2">
                    <button id="behavior-log-note-delete" type="button" class="hidden rounded-lg border border-red-200 px-4 py-2 text-sm font-semibold text-red-600 hover:bg-red-50">기록 삭제</button>
                    <div class="ml-auto flex gap-2">
                        <button id="behavior-log-note-cancel" type="button" class="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-50">취소</button>
                        <button id="behavior-log-note-save" type="button" class="rounded-lg bg-sky-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-sky-700">저장</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Major Evaluation Modal -->
        <div id="major-eval-modal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                <h3 class="text-xl font-semibold mb-4">전공과 심사표 추가</h3>
                <label for="major-eval-modal-title" class="block text-sm font-medium text-gray-700 mb-2">제목</label>
                <input type="text" id="major-eval-modal-title" class="w-full border border-gray-300 rounded-md p-2 text-sm" placeholder="예: 2024학년도 호텔조리 전형">
                <div class="mt-6 flex justify-end gap-2">
                    <button type="button" id="major-eval-modal-cancel" class="px-4 py-2 rounded border border-gray-300 text-sm font-medium text-gray-600 hover:bg-gray-50">취소</button>
                    <button type="button" id="major-eval-modal-confirm" class="px-4 py-2 rounded bg-sky-600 hover:bg-sky-700 text-white text-sm font-semibold">완료</button>
                </div>
            </div>
        </div>

        <!-- Toast Message -->
        <div id="toast" class="fixed bottom-10 right-10 bg-gray-900 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-300">
             복사되었습니다!
        </div>
    </div>

    <script type="module">
        // Firebase v10 SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, getDocs, doc, getDoc, setDoc, updateDoc, deleteDoc, serverTimestamp, where, orderBy, runTransaction, collectionGroup, deleteField } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref as storageRef, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        const firebaseConfig = {
            // Your web app's Firebase configuration
            apiKey: "AIzaSyDCeJPDQUNi-KmJ9DhkTRIu-9t2PGZCpt0",
            authDomain: "mansungcoin-c6e06.firebaseapp.com",
            projectId: "mansungcoin-c6e06",
            storageBucket: "mansungcoin-c6e06.appspot.com",
            messagingSenderId: "704809284946",
            appId: "1:704809284946:web:54e4788586e6c68de1768b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- DOM Elements ---
        const authView = document.getElementById('auth-view');
        const mainAppView = document.getElementById('main-app-view');
        const loginView = document.getElementById('login-view');
        const studentRegisterView = document.getElementById('student-register-view');
        const teacherRegisterView = document.getElementById('teacher-register-view');
        const studentLoginTab = document.getElementById('student-login-tab');
        const teacherLoginTab = document.getElementById('teacher-login-tab');
        const studentLoginContent = document.getElementById('student-login-content');
        const teacherLoginContent = document.getElementById('teacher-login-content');
        const studentCodeInput = document.getElementById('student-code');
        const teacherEmailInput = document.getElementById('teacher-email');
        const teacherPasswordInput = document.getElementById('teacher-password');
        const studentLoginError = document.getElementById('student-login-error');
        const teacherLoginError = document.getElementById('teacher-login-error');
        const studentNameInput = document.getElementById('student-name');
        const studentRegisterError = document.getElementById('student-register-error');
        const teacherRegisterNameInput = document.getElementById('teacher-register-name');
        const teacherRegisterEmailInput = document.getElementById('teacher-register-email');
        const teacherRegisterPasswordInput = document.getElementById('teacher-register-password');
        const teacherRegisterError = document.getElementById('teacher-register-error');
        const studentLoginBtn = document.getElementById('student-login-btn');
        const teacherLoginBtn = document.getElementById('teacher-login-btn');
        const teacherGoogleLoginBtn = document.getElementById('teacher-google-login-btn');
        const showStudentRegisterBtn = document.getElementById('show-student-register-btn');
        const showTeacherRegisterBtn = document.getElementById('show-teacher-register-btn');
        const backToLoginBtn = document.getElementById('back-to-login-btn');
        const teacherBackToLoginBtn = document.getElementById('teacher-back-to-login-btn');
        const studentRegisterBtn = document.getElementById('student-register-btn');
        const teacherRegisterBtn = document.getElementById('teacher-register-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailSpan = document.getElementById('user-email');
        const homeBehaviorTable = document.getElementById('home-behavior-table');
        const homeBehaviorRefreshBtn = document.getElementById('home-behavior-refresh');
        const sketchbookListEl = document.getElementById('sketchbook-list');
        const behaviorSketchbookListEl = document.getElementById('behavior-sketchbook-list');
        const createSketchButtons = Array.from(document.querySelectorAll('[data-action="create-sketch"]'));
        const sketchbookListContainers = [sketchbookListEl, behaviorSketchbookListEl].filter(Boolean);

        function setSketchbookListMessage(html) {
            sketchbookListContainers.forEach(container => {
                container.innerHTML = html;
            });
        }
        const toast = document.getElementById('toast');
        const levelButtons = document.getElementById('level-buttons');
        const subjectButtons = document.getElementById('subject-buttons');
        const gradeButtons = document.getElementById('grade-buttons');
        const saveAchievementBtn = document.getElementById('save-achievement-btn');
        const achievementTableContainer = document.getElementById('achievement-table');
        const backToClassBtn = document.getElementById('back-to-class-btn');
        const templateCategoryButtons = document.getElementById('template-category-buttons');
        const majorEvalWorkspace = document.getElementById('major-eval-workspace');
        const majorEvalAddBtn = document.getElementById('major-eval-add-btn');
        const majorEvalList = document.getElementById('major-eval-list');
        const majorEvalEmpty = document.getElementById('major-eval-empty');
        const majorEvalInputSection = document.getElementById('major-eval-input-section');
        const majorEvalModifySection = document.getElementById('major-eval-modify-section');
        const majorEvalOutput = document.getElementById('major-eval-output');
        const majorEvalSchoolInput = document.getElementById('major-eval-school');
        const majorEvalDomainInput = document.getElementById('major-eval-domain');
        const majorEvalQuestionsInput = document.getElementById('major-eval-questions');
        const majorEvalTopicInput = document.getElementById('major-eval-topic');
        const majorEvalGenerateBtn = document.getElementById('major-eval-generate-btn');
        const majorEvalModifyInput = document.getElementById('major-eval-modify-input');
        const majorEvalModifyBtn = document.getElementById('major-eval-modify-btn');
        const majorEvalUploadSection = document.getElementById('major-eval-upload-section');
        const majorEvalUploadBtn = document.getElementById('major-eval-upload-btn');
        const majorEvalUploadInput = document.getElementById('major-eval-upload-input');
        const majorEvalUploadInfo = document.getElementById('major-eval-upload-info');
        const majorEvalEditToggleBtn = document.getElementById('major-eval-edit-toggle-btn');
        const majorEvalSaveBtn = document.getElementById('major-eval-save-btn');
        const majorEvalPdfBtn = document.getElementById('major-eval-pdf-btn');
        const majorEvalQuestionIncreaseInput = document.getElementById('major-eval-question-increase');
        const majorEvalQuestionIncreaseBtn = document.getElementById('major-eval-question-increase-btn');
        const majorEvalModal = document.getElementById('major-eval-modal');
        const majorEvalModalTitle = document.getElementById('major-eval-modal-title');
        const majorEvalModalCancel = document.getElementById('major-eval-modal-cancel');
        const majorEvalModalConfirm = document.getElementById('major-eval-modal-confirm');
        let currentAchievementStudent = '';
        let currentAchievementData = {};

        // Views and Navs
        const views = {
            home: document.getElementById('home-view'),
            'my-class': document.getElementById('my-class-view'),
            sketchbook: document.getElementById('sketchbook-view'),
            iep: document.getElementById('iep-view'),
            templates: document.getElementById('templates-view'),
            behavior: document.getElementById('behavior-view'),
            achievement: document.getElementById('achievement-view'),
        };
        const navLinkElements = Array.from(document.querySelectorAll('a.nav-link[data-view]'));
        const navLinks = navLinkElements.reduce((acc, link) => {
            const viewName = link.dataset.view;
            if (!viewName) return acc;
            if (!acc[viewName]) acc[viewName] = [];
            acc[viewName].push(link);
            return acc;
        }, {});
        
        let statsChartInstance = null;
        let behaviorChartInstance = null;
        let currentUserProfile = null;
        let isLoadingHomeData = false;
        let isLoadingHomeBehaviors = false;
        let isLoadingSketchbooks = false;
        let homeBehaviorEntries = [];
        const MAJOR_EVAL_STORAGE_KEY = 'aiedue:major-eval:entries:v1';
        const MAJOR_EVAL_ACTIVE_STORAGE_KEY = 'aiedue:major-eval:active';
        const PDFJS_WORKER_SRC = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        let majorEvalEntries = [];
        let activeMajorEvalId = '';
        let activeTemplateCategory = '';
        let isMajorEvalGenerating = false;
        let isMajorEvalModifying = false;
        let isMajorEvalUploading = false;
        let isMajorEvalManualEditing = false;
        let majorEvalManualNode = null;
        let hasMajorEvalManualDraft = false;
        let majorEvalManualDraftHtml = '';

        if (typeof window !== 'undefined' && typeof pdfjsLib !== 'undefined' && pdfjsLib.GlobalWorkerOptions) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = PDFJS_WORKER_SRC;
        }

        // --- AUTHENTICATION ---
        const authSections = {
            login: loginView,
            studentRegister: studentRegisterView,
            teacherRegister: teacherRegisterView,
        };

        const showAuthView = (view) => {
            Object.values(authSections).forEach(section => section && section.classList.remove('active'));
            if (authSections[view]) {
                authSections[view].classList.add('active');
            }
        };

        const showError = (element, message) => {
            if (!element) return;
            if (message) {
                element.textContent = message;
                element.classList.remove('hidden');
            } else {
                element.textContent = '';
                element.classList.add('hidden');
            }
        };

        const clearAuthMessages = () => {
            showError(studentLoginError, '');
            showError(teacherLoginError, '');
            showError(studentRegisterError, '');
            showError(teacherRegisterError, '');
        };

        const switchLoginTab = (tabName) => {
            [studentLoginTab, teacherLoginTab].forEach(tab => tab && tab.classList.remove('active'));
            [studentLoginContent, teacherLoginContent].forEach(content => content && content.classList.remove('active'));

            if (tabName === 'teacher') {
                if (teacherLoginTab) teacherLoginTab.classList.add('active');
                if (teacherLoginContent) teacherLoginContent.classList.add('active');
            } else {
                if (studentLoginTab) studentLoginTab.classList.add('active');
                if (studentLoginContent) studentLoginContent.classList.add('active');
            }

            clearAuthMessages();
        };

        if (studentLoginTab) {
            studentLoginTab.addEventListener('click', () => switchLoginTab('student'));
        }
        if (teacherLoginTab) {
            teacherLoginTab.addEventListener('click', () => switchLoginTab('teacher'));
        }

        if (showStudentRegisterBtn) {
            showStudentRegisterBtn.addEventListener('click', () => {
                clearAuthMessages();
                showAuthView('studentRegister');
            });
        }

        if (showTeacherRegisterBtn) {
            showTeacherRegisterBtn.addEventListener('click', () => {
                clearAuthMessages();
                showAuthView('teacherRegister');
            });
        }

        if (backToLoginBtn) {
            backToLoginBtn.addEventListener('click', () => {
                showAuthView('login');
                switchLoginTab('student');
            });
        }

        if (teacherBackToLoginBtn) {
            teacherBackToLoginBtn.addEventListener('click', () => {
                showAuthView('login');
                switchLoginTab('teacher');
            });
        }

        if (studentRegisterBtn) {
            studentRegisterBtn.addEventListener('click', async () => {
                clearAuthMessages();
                const name = studentNameInput.value.trim();
                if (!name) {
                    showError(studentRegisterError, '이름을 입력해주세요.');
                    return;
                }

                try {
                    const counterRef = doc(db, 'metadata', 'counters');
                    const newCode = await runTransaction(db, async (transaction) => {
                        const counterDoc = await transaction.get(counterRef);
                        let nextCode = 1;
                        if (counterDoc.exists() && counterDoc.data().lastUserCode) {
                            nextCode = counterDoc.data().lastUserCode + 1;
                        }
                        transaction.set(counterRef, { lastUserCode: nextCode }, { merge: true });
                        return nextCode;
                    });

                    const email = `${newCode}@abc.com`;
                    const password = `${newCode}qwerty`;

                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);

                    await setDoc(doc(db, 'users', userCredential.user.uid), {
                        uid: userCredential.user.uid,
                        name: name,
                        email: email,
                        userCode: newCode,
                        role: 'student',
                        coins: 0,
                        balance: 0,
                        portfolio: {},
                        aeduExperience: 0,
                        aeduLevel: 1,
                        warningTokens: 0,
                        createdAt: serverTimestamp()
                    });

                    await addDoc(collection(db, 'signupLog'), {
                        name: name,
                        userCode: newCode,
                        role: 'student',
                        signedUpAt: serverTimestamp()
                    });

                    studentNameInput.value = '';
                    alert(`환영합니다, ${name} 학생!\n당신의 고유 코드는 ${newCode} 입니다.\n이 코드를 꼭 기억하고 로그인해주세요.`);
                    showAuthView('login');
                    switchLoginTab('student');
                } catch (error) {
                    console.error('Student registration error:', error);
                    if (error.code === 'auth/email-already-in-use') {
                        showError(studentRegisterError, '이미 사용 중인 계정 정보입니다. 다른 코드를 시도해주세요.');
                    } else {
                        showError(studentRegisterError, '학생 등록 중 문제가 발생했습니다.');
                    }
                }
            });
        }

        if (teacherRegisterBtn) {
            teacherRegisterBtn.addEventListener('click', async () => {
                clearAuthMessages();
                const name = teacherRegisterNameInput.value.trim();
                const email = teacherRegisterEmailInput.value.trim();
                const password = teacherRegisterPasswordInput.value;

                if (!name || !email || !password) {
                    showError(teacherRegisterError, '이름, 이메일, 비밀번호를 모두 입력해주세요.');
                    return;
                }

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);

                    await setDoc(doc(db, 'users', userCredential.user.uid), {
                        uid: userCredential.user.uid,
                        name,
                        email,
                        role: 'teacher',
                        userCode: null,
                        coins: 0,
                        balance: 0,
                        portfolio: {},
                        aeduTokens: 0,
                        aeduExperience: 0,
                        aeduLevel: 1,
                        warningTokens: 0,
                        createdAt: serverTimestamp()
                    }, { merge: true });

                    await addDoc(collection(db, 'signupLog'), {
                        name,
                        email,
                        role: 'teacher',
                        signedUpAt: serverTimestamp()
                    });

                    teacherRegisterNameInput.value = '';
                    teacherRegisterEmailInput.value = '';
                    teacherRegisterPasswordInput.value = '';
                    alert(`환영합니다, ${name} 선생님!\n이제 교사용 기능을 이용해보세요.`);
                    showAuthView('login');
                    switchLoginTab('teacher');
                } catch (error) {
                    console.error('Teacher registration error:', error);
                    if (error.code === 'auth/email-already-in-use') {
                        showError(teacherRegisterError, '이미 사용 중인 이메일입니다. 다른 이메일을 사용해주세요.');
                    } else if (error.code === 'auth/invalid-email') {
                        showError(teacherRegisterError, '유효한 이메일 주소를 입력해주세요.');
                    } else if (error.code === 'auth/weak-password') {
                        showError(teacherRegisterError, '비밀번호는 6자 이상이어야 합니다.');
                    } else {
                        showError(teacherRegisterError, '교사 회원가입 중 문제가 발생했습니다. 잠시 후 다시 시도해주세요.');
                    }
                }
            });
        }

        if (studentLoginBtn) {
            studentLoginBtn.addEventListener('click', async () => {
                clearAuthMessages();
                const codeInput = studentCodeInput.value.trim();

                const normalizedCode = codeInput.replace(/[\uFF10-\uFF19]/g, (m) => String.fromCharCode(m.charCodeAt(0) - 0xFEE0));

                if (!normalizedCode || !/^\d+$/.test(normalizedCode)) {
                    showError(studentLoginError, '유효한 숫자 코드를 입력해주세요.');
                    return;
                }

                const codeAsInt = parseInt(normalizedCode, 10);
                const email = `${codeAsInt}@abc.com`;
                const password = `${codeAsInt}qwerty`;

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error('Student login error:', error);
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                        showError(studentLoginError, '고유 코드가 올바르지 않거나 해당 학생을 찾을 수 없습니다.');
                    } else if (error.code === 'permission-denied') {
                        showError(studentLoginError, '데이터베이스 접근 권한이 없습니다. 관리자에게 문의하여 Firestore 보안 규칙을 확인해주세요.');
                    } else {
                        showError(studentLoginError, `알 수 없는 오류가 발생했습니다: ${error.message}`);
                    }
                }
            });
        }

        if (teacherLoginBtn) {
            teacherLoginBtn.addEventListener('click', async () => {
                clearAuthMessages();
                const email = teacherEmailInput.value.trim();
                const password = teacherPasswordInput.value;
                if (!email || !password) {
                    showError(teacherLoginError, '이메일과 비밀번호를 모두 입력해주세요.');
                    return;
                }
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    showError(teacherLoginError, '이메일 또는 비밀번호가 올바르지 않습니다.');
                }
            });
        }

        if (teacherGoogleLoginBtn) {
            teacherGoogleLoginBtn.addEventListener('click', async () => {
                clearAuthMessages();
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    showError(teacherLoginError, 'Google 로그인 중 오류가 발생했습니다.');
                }
            });
        }

        logoutBtn.addEventListener('click', () => signOut(auth));

        showAuthView('login');
        switchLoginTab('student');

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserProfile = null;
                teacherDirectoryLoaded = false;
                teacherDirectory = [];
                ensureCurrentUserProfile();
                authView.classList.add('hidden');
                mainAppView.classList.remove('hidden');
                mainAppView.classList.add('flex');
                if (userEmailSpan) userEmailSpan.textContent = user.email;
                const currentView = window.location.hash.replace('#', '') || 'home';
                switchView(currentView).catch(console.error);
            } else {
                currentUserProfile = null;
                authView.classList.remove('hidden');
                mainAppView.classList.add('hidden');
                mainAppView.classList.remove('flex');
                showAuthView('login');
                switchLoginTab('student');
                clearAuthMessages();
                if (studentCodeInput) studentCodeInput.value = '';
                if (teacherEmailInput) teacherEmailInput.value = '';
                if (teacherPasswordInput) teacherPasswordInput.value = '';
                if (sketchbookListContainers.length) {
                    setSketchbookListMessage('<li class="text-sm text-gray-500">스케치북을 불러오려면 로그인해주세요.</li>');
                }
            }
        });

        // --- NAVIGATION ---
        const switchView = async (view) => {
            Object.values(views).forEach(v => v.classList.add('hidden'));
            navLinkElements.forEach(link => link.classList.remove('active'));
            if (views[view]) {
                views[view].classList.remove('hidden');
                if (navLinks[view]) {
                    navLinks[view].forEach(link => link.classList.add('active'));
                }
                window.location.hash = view;

                // Load data for the activated view
                if (view === 'home') {
                    await loadHomeData();
                } else if (view === 'my-class') {
                    await loadClasses();
                } else if (view === 'sketchbook') {
                    await renderSketchbookList();
                } else if (view === 'iep') {
                    loadIepStudents();
                    if (iepOutputContainer) {
                        iepOutputContainer.innerHTML = '<p class="text-gray-500">학생을 선택하면 IEP 정보가 표시됩니다.</p>';
                    }
                } else if (view === 'templates') {
                    activateTemplateCategory('major-eval');
                } else if (view === 'behavior') {
                    await prepareBehaviorView();
                } else {
                    closeBehaviorShareModal();
                    closeBehaviorLogNoteModal();
                }

            } else { // Fallback to home
                views.home.classList.remove('hidden');
                if (navLinks.home) {
                    navLinks.home.forEach(link => link.classList.add('active'));
                }
                window.location.hash = 'home';
                await loadHomeData();
                closeBehaviorShareModal();
                closeBehaviorLogNoteModal();
            }
        };

        navLinkElements.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetView = link.dataset.view;
                if (targetView) {
                    switchView(targetView).catch(console.error);
                }
            });
        });
        document.getElementById('home-link').addEventListener('click', (e) => {
             e.preventDefault();
             switchView('home').catch(console.error);
        });

        backToClassBtn.addEventListener('click', () => switchView('my-class').catch(console.error));

        levelButtons.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', () => {
                setActiveButton(levelButtons, btn.dataset.value);
                updateGradeButtons();
                loadAchievementTable();
            });
        });

        subjectButtons.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', () => {
                setActiveButton(subjectButtons, btn.dataset.value);
                loadAchievementTable();
            });
        });

        saveAchievementBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) return;
            const table = achievementTableContainer.querySelector('table');
            if (!table) return;
            const rows = table.querySelectorAll('tbody tr');
            const states = Array.from(rows).map(tr => {
                // Firestore does not support nested arrays, so store each row as an object
                const rowObj = {};
                for (let i = 1; i < tr.cells.length; i++) {
                    const btn = tr.cells[i].querySelector('button');
                    rowObj[i - 1] = parseInt(btn.dataset.state || '0');
                }
                return rowObj;
            });
            const key = `${getActiveValue(levelButtons)}_${getActiveValue(subjectButtons)}`;
            currentAchievementData[key] = states;
            try {
                await setDoc(doc(db, 'users', user.uid, 'achievements', currentAchievementStudent), {
                    data: currentAchievementData
                }, { merge: true });
                showToast('저장되었습니다');
            } catch (e) {
                console.error('Error saving achievement data', e);
            }
        });

        // --- Home View Logic ---
        async function loadHomeData() {
            const user = auth.currentUser;
            if (!user || isLoadingHomeData) return;
            isLoadingHomeData = true;
            loadHomeBehaviorOverview();
            try {
                const classRef = doc(db, 'classes', user.uid);
                const iepsRef = collection(db, 'users', user.uid, 'ieps');

                const [classSnap, iepSnap] = await Promise.all([getDoc(classRef), getDocs(iepsRef)]);

                const statsData = {
                    labels: ['학급', 'IEP'],
                    datasets: [{
                        label: '업무 수',
                        data: [classSnap.exists() ? 1 : 0, iepSnap.size],
                        backgroundColor: ['#38bdf8', '#fbbf24'],
                        hoverOffset: 4
                    }]
                };
            updateChart('statsChart', 'statsChartInstance', 'doughnut', statsData, {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            });
        } catch (error) {
            console.error(error);
        } finally {
            isLoadingHomeData = false;
        }

        }

        async function loadHomeBehaviorOverview(options = {}) {
            const { showLoader = true, force = false } = options;
            const user = auth.currentUser;
            if (!user || !homeBehaviorTable) return;
            if (isLoadingHomeBehaviors && !force) return;
            isLoadingHomeBehaviors = true;
            if (showLoader) {
                homeBehaviorTable.innerHTML = '<p class="text-sm text-gray-500">행동 기록을 불러오는 중입니다...</p>';
            }
            try {
                const behaviorsRef = collection(db, 'users', user.uid, 'behaviors');
                const [behaviorSnapshot] = await Promise.all([
                    getDocs(behaviorsRef),
                    loadSharedBehaviors()
                ]);

                const personalEntries = behaviorSnapshot.docs.map(docSnap => {
                    const data = docSnap.data() || {};
                    const createdAt = data.updatedAt?.toMillis?.() || data.createdAt?.toMillis?.() || 0;
                    return {
                        id: docSnap.id,
                        ownerId: user.uid,
                        studentId: data.studentId || '',
                        studentName: data.studentName || data.studentId || '',
                        title: data.title || '',
                        operationalDefinition: data.operationalDefinition || '',
                        useReinforcer: !!data.useReinforcer,
                        useAttentionToken: !!data.useAttentionToken,
                        sortTime: createdAt,
                        source: 'mine'
                    };
                });

                const sharedEntries = sharedBehaviorEntries.map(entry => ({
                    id: entry.id,
                    ownerId: entry.ownerId,
                    studentId: entry.studentId || '',
                    studentName: entry.studentName || entry.studentId || '',
                    title: entry.title || '',
                    operationalDefinition: entry.operationalDefinition || '',
                    useReinforcer: !!entry.useReinforcer,
                    useAttentionToken: !!entry.useAttentionToken,
                    sortTime: entry.sharedAt?.toMillis?.() || entry.createdAt?.toMillis?.() || 0,
                    source: 'shared'
                }));

                homeBehaviorEntries = [...personalEntries, ...sharedEntries].sort((a, b) => (b.sortTime || 0) - (a.sortTime || 0));
                renderHomeBehaviorTable();
            } catch (error) {
                console.error('Failed to load home behavior overview', error);
                homeBehaviorEntries = [];
                if (homeBehaviorTable) {
                    homeBehaviorTable.innerHTML = '<p class="text-sm text-red-500">행동 기록을 불러오지 못했습니다. 새로고침을 눌러주세요.</p>';
                }
            } finally {
                isLoadingHomeBehaviors = false;
            }
        }

        function renderHomeBehaviorTable() {
            if (!homeBehaviorTable) return;
            homeBehaviorTable.innerHTML = '';
            if (!homeBehaviorEntries.length) {
                homeBehaviorTable.innerHTML = '<p class="text-sm text-gray-500">아직 등록된 행동 기록이 없습니다. 행동 기록 탭에서 새로운 행동을 추가해보세요.</p>';
                return;
            }

            homeBehaviorEntries.forEach((entry, index) => {
                const container = document.createElement('div');
                container.className = 'rounded-xl border border-slate-200 bg-slate-50 p-3';

                const badges = [];
                if (entry.source === 'shared') {
                    badges.push('<span class="rounded-full bg-indigo-100 px-2 py-0.5 text-[0.65rem] font-semibold text-indigo-600">공유</span>');
                }
                if (entry.useReinforcer) {
                    badges.push('<span class="rounded-full bg-emerald-100 px-2 py-0.5 text-[0.65rem] font-semibold text-emerald-700">강화물</span>');
                }
                if (entry.useAttentionToken) {
                    badges.push('<span class="rounded-full bg-amber-100 px-2 py-0.5 text-[0.65rem] font-semibold text-amber-700">주의 토큰</span>');
                }

                const studentLabel = escapeHtml(entry.studentName || '학생 미확인');
                const behaviorLabel = escapeHtml(entry.title || '행동 기록');
                const definitionLine = (entry.operationalDefinition || '').split('\n').map(line => line.trim()).find(Boolean) || '조작적 정의가 등록되지 않았습니다.';
                const definition = escapeHtml(definitionLine);
                const badgesHtml = badges.length ? `<div class="mt-2 flex flex-wrap items-center gap-1">${badges.join('')}</div>` : '';

                container.innerHTML = `
                    <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:gap-4">
                        <div class="flex-1 min-w-0">
                            <p class="font-semibold text-slate-800 break-words">${studentLabel}</p>
                            <p class="text-sm text-slate-600 break-words">${behaviorLabel}</p>
                            ${badgesHtml}
                            <p class="mt-2 text-xs text-slate-500 break-words">${definition}</p>
                        </div>
                        <div class="flex items-center gap-2 sm:flex-col sm:items-stretch sm:w-36">
                            <button type="button" class="w-full rounded-md border border-sky-200 bg-white px-3 py-2 text-center text-xs font-semibold text-sky-600 transition hover:bg-sky-50" data-entry-index="${index}" data-action="view">이동</button>
                            <button type="button" class="w-full rounded-md bg-emerald-500 px-3 py-2 text-center text-xs font-semibold text-white shadow-sm transition hover:bg-emerald-600" data-entry-index="${index}" data-action="log">기록</button>
                        </div>
                    </div>
                `;

                homeBehaviorTable.appendChild(container);
            });
        }

        function generateUniqueSketchCode(existingCodes = new Set()) {
            const characters = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            const codeLength = 6;
            const codes = existingCodes instanceof Set ? existingCodes : new Set(existingCodes);
            let code = '';
            do {
                code = Array.from({ length: codeLength }, () => characters[Math.floor(Math.random() * characters.length)]).join('');
            } while (codes.has(code));
            return code;
        }

        function createSketchbookListItem(sketch) {
            const li = document.createElement('li');
            li.className = 'p-3 bg-white rounded border border-slate-200 shadow-sm flex items-center justify-between gap-4';

            const infoBtn = document.createElement('button');
            infoBtn.type = 'button';
            infoBtn.className = 'flex-1 text-left';
            const sketchName = escapeHtml(sketch.name || '새 스케치북');
            const sketchCode = escapeHtml(sketch.code || '생성 중');
            infoBtn.innerHTML = `
                <div class="font-semibold text-slate-800">${sketchName}</div>
                <div class="text-xs text-slate-500 mt-1">코드: ${sketchCode}</div>
            `;
            infoBtn.addEventListener('click', () => {
                window.open(`sketch.html?sketchId=${encodeURIComponent(sketch.id)}&code=${encodeURIComponent(sketch.code || '')}`, '_blank');
            });
            li.appendChild(infoBtn);

            const buttonGroup = document.createElement('div');
            buttonGroup.className = 'flex items-center gap-3';

            const renameBtn = document.createElement('button');
            renameBtn.type = 'button';
            renameBtn.className = 'text-sm text-sky-600 hover:underline';
            renameBtn.textContent = '이름 변경';
            renameBtn.addEventListener('click', async (event) => {
                event.preventDefault();
                const user = auth.currentUser;
                if (!user) return;
                const newName = prompt('새 이름을 입력하세요', sketch.name || '새 스케치북');
                if (!newName) return;
                try {
                    await updateDoc(doc(db, 'users', user.uid, 'sketches', sketch.id), { name: newName });
                    await renderSketchbookList();
                } catch (error) {
                    console.error('Failed to rename sketchbook', error);
                    alert('스케치북 이름을 변경하지 못했습니다. 잠시 후 다시 시도해주세요.');
                }
            });
            buttonGroup.appendChild(renameBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'text-sm text-red-500 hover:underline';
            deleteBtn.textContent = '삭제';
            deleteBtn.addEventListener('click', async (event) => {
                event.preventDefault();
                const user = auth.currentUser;
                if (!user) return;
                if (!confirm('정말 삭제하시겠습니까?')) return;
                try {
                    await deleteDoc(doc(db, 'users', user.uid, 'sketches', sketch.id));
                    try {
                        await deleteObject(storageRef(storage, `sketch/${user.uid}/${sketch.id}.excalidraw`));
                    } catch (storageError) {
                        if (storageError?.code !== 'storage/object-not-found') {
                            console.error('Failed to delete sketch file', storageError);
                        }
                    }
                    await renderSketchbookList();
                } catch (error) {
                    console.error('Failed to delete sketchbook', error);
                    alert('스케치북을 삭제하지 못했습니다. 잠시 후 다시 시도해주세요.');
                }
            });
            buttonGroup.appendChild(deleteBtn);

            li.appendChild(buttonGroup);
            return li;
        }

        async function renderSketchbookList() {
            const user = auth.currentUser;
            if (!user || !sketchbookListContainers.length) return;
            if (isLoadingSketchbooks) return;
            isLoadingSketchbooks = true;
            setSketchbookListMessage('<li class="p-3 text-sm text-gray-500">스케치북을 불러오는 중입니다...</li>');
            try {
                const snap = await getDocs(collection(db, 'users', user.uid, 'sketches'));
                const sketches = [];
                const existingCodes = new Set();

                snap.forEach(docSnap => {
                    const data = docSnap.data() || {};
                    if (data.code) existingCodes.add(data.code);
                    sketches.push({ id: docSnap.id, ...data });
                });

                for (const sketch of sketches) {
                    if (!sketch.code) {
                        const newCode = generateUniqueSketchCode(existingCodes);
                        existingCodes.add(newCode);
                        try {
                            await updateDoc(doc(db, 'users', user.uid, 'sketches', sketch.id), { code: newCode });
                        } catch (error) {
                            console.error('Failed to assign sketch code', error);
                        }
                        sketch.code = newCode;
                    }
                }

                if (!sketches.length) {
                    sketchbookListContainers.forEach(container => {
                        container.innerHTML = '';
                        const emptyMessage = document.createElement('li');
                        emptyMessage.className = 'p-4 bg-slate-50 rounded text-center text-sm text-gray-500 border border-dashed border-slate-200';
                        emptyMessage.textContent = '아직 만든 스케치북이 없습니다. 새로운 스케치북을 만들어보세요!';
                        container.appendChild(emptyMessage);
                    });
                    return;
                }

                sketches.sort((a, b) => {
                    const timeA = a.createdAt?.toMillis?.() || 0;
                    const timeB = b.createdAt?.toMillis?.() || 0;
                    return timeB - timeA;
                });

                sketchbookListContainers.forEach(container => {
                    container.innerHTML = '';
                    sketches.forEach(sketch => {
                        container.appendChild(createSketchbookListItem(sketch));
                    });
                });
            } catch (error) {
                console.error('Failed to load sketchbooks', error);
                setSketchbookListMessage('<li class="p-3 text-sm text-red-500">스케치북을 불러오지 못했습니다. 잠시 후 다시 시도해주세요.</li>');
            } finally {
                isLoadingSketchbooks = false;
            }
        }

        async function logBehaviorFromHome(entry) {
            const user = auth.currentUser;
            if (!user) return;
            if (!entry?.id) {
                alert('행동 정보가 올바르지 않습니다.');
                return;
            }
            try {
                const recorderName = await getRecorderDisplayName();
                const ownerId = entry.ownerId || user.uid;
                await addDoc(collection(db, 'users', ownerId, 'behaviors', entry.id, 'logs'), {
                    timestamp: serverTimestamp(),
                    recordedBy: user.uid,
                    recordedByName: recorderName
                });
                const title = entry.title || '행동';
                showToast(`${title}이 기록되었습니다.`);
                if (currentBehaviorEntry && currentBehaviorEntry.id === entry.id) {
                    const expectedOwnerId = currentBehaviorOwnerId || user.uid;
                    if (expectedOwnerId === ownerId) {
                        loadBehaviorLogs(entry.id, ownerId);
                    }
                }
            } catch (error) {
                console.error('Failed to record behavior log from home', error);
                alert('행동을 기록하지 못했습니다. 잠시 후 다시 시도해주세요.');
            }
        }

        async function handleHomeBehaviorAction(entryIndex, action = 'view') {
            const entry = homeBehaviorEntries[entryIndex];
            if (!entry) return;

            if (action === 'log') {
                await logBehaviorFromHome(entry);
                return;
            }

            try {
                if (entry.source === 'mine') {
                    currentBehaviorStudentId = entry.studentId || '';
                } else {
                    currentBehaviorStudentId = '';
                }

                await switchView('behavior');

                if (entry.source === 'mine') {
                    if (!entry.studentId) {
                        showToast('학생 정보가 없는 행동 기록입니다.');
                        return;
                    }
                    const student = behaviorStudents.find(s => s.id === entry.studentId);
                    if (behaviorSelectedStudentLabel) {
                        behaviorSelectedStudentLabel.textContent = `${student?.name || '학생'} 학생`;
                    }
                    await loadBehaviorEntries(entry.studentId, entry.id);
                } else {
                    await loadSharedBehaviors();
                    const sharedEntry = sharedBehaviorEntries.find(item => item.id === entry.id && item.ownerId === entry.ownerId);
                    if (!sharedEntry) {
                        showToast('공유 받은 행동 기록을 불러오지 못했습니다.');
                        return;
                    }
                    selectBehaviorEntry(sharedEntry.id, { entry: sharedEntry, ownerId: sharedEntry.ownerId, source: 'shared' });
                    if (behaviorSelectedStudentLabel) {
                        const displayName = sharedEntry.studentName || sharedEntry.studentId || '학생';
                        behaviorSelectedStudentLabel.textContent = `${displayName} 학생 (공유)`;
                    }
                    updateSharedBehaviorActiveState();
                    updateBehaviorActionState();
                }
            } catch (error) {
                console.error('Failed to open behavior entry from home', error);
            }
        }

        homeBehaviorRefreshBtn?.addEventListener('click', () => {
            loadHomeBehaviorOverview({ force: true });
        });

        function setCreateSketchButtonsDisabled(disabled) {
            createSketchButtons.forEach(btn => {
                btn.disabled = disabled;
                btn.classList.toggle('opacity-50', disabled);
                btn.classList.toggle('cursor-not-allowed', disabled);
            });
        }

        createSketchButtons.forEach(button => {
            button.addEventListener('click', async () => {
                const user = auth.currentUser;
                if (!user || button.disabled) return;
                setCreateSketchButtonsDisabled(true);
                try {
                    const snap = await getDocs(collection(db, 'users', user.uid, 'sketches'));
                    const existingCodes = new Set();
                    snap.forEach(docSnap => {
                        const data = docSnap.data() || {};
                        if (data.code) existingCodes.add(data.code);
                    });
                    const newCode = generateUniqueSketchCode(existingCodes);
                    const docRef = await addDoc(collection(db, 'users', user.uid, 'sketches'), {
                        name: '새 스케치북',
                        createdAt: serverTimestamp(),
                        code: newCode
                    });
                    await renderSketchbookList();
                    window.open(`sketch.html?sketchId=${encodeURIComponent(docRef.id)}&code=${encodeURIComponent(newCode)}`, '_blank');
                } catch (error) {
                    console.error('Failed to create sketchbook', error);
                    alert('스케치북을 만들지 못했습니다. 잠시 후 다시 시도해주세요.');
                } finally {
                    setCreateSketchButtonsDisabled(false);
                }
            });
        });

        homeBehaviorTable?.addEventListener('click', async (event) => {
            const button = event.target.closest('button[data-entry-index]');
            if (!button) return;
            const index = Number(button.dataset.entryIndex);
            if (Number.isNaN(index)) return;
            const action = button.dataset.action || 'view';
            const shouldDisable = action === 'log';
            if (shouldDisable) {
                button.disabled = true;
                button.classList.add('opacity-50', 'cursor-not-allowed');
            }
            try {
                await handleHomeBehaviorAction(index, action);
            } finally {
                if (shouldDisable) {
                    button.disabled = false;
                    button.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
        });

        // --- My Class View Logic ---
        const addClassBtn = document.getElementById('add-class-btn');
        const classListContainer = document.getElementById('class-list');
        const classTitle = document.getElementById('class-title');
        const createClassModal = document.getElementById('create-class-modal');
        const createClassForm = document.getElementById('create-class-form');
        const createClassNameInput = document.getElementById('create-class-name');
        const createClassCancelBtn = document.getElementById('create-class-cancel-btn');
        const createClassCloseBtn = document.getElementById('create-class-close-btn');
        const createClassConfirmBtn = document.getElementById('create-class-confirm-btn');
        let isLoadingClasses = false;
        let isCreatingClass = false;

        function setClassCreateButtonState(canCreate) {
            if (!addClassBtn) return;
            addClassBtn.disabled = !canCreate;
            addClassBtn.classList.toggle('opacity-50', !canCreate);
            addClassBtn.classList.toggle('cursor-not-allowed', !canCreate);
        }

        function openCreateClassModal() {
            if (!auth.currentUser || !createClassModal || addClassBtn?.disabled) return;
            if (createClassNameInput) {
                createClassNameInput.value = '';
            }
            createClassModal.classList.remove('hidden');
            createClassModal.classList.add('flex');
            setTimeout(() => createClassNameInput?.focus(), 50);
        }

        function closeCreateClassModal() {
            if (!createClassModal) return;
            createClassModal.classList.add('hidden');
            createClassModal.classList.remove('flex');
            if (createClassNameInput) {
                createClassNameInput.value = '';
            }
        }

        async function handleCreateClassSubmit(event) {
            event.preventDefault();
            if (isCreatingClass) return;
            const user = auth.currentUser;
            if (!user) return;
            const className = (createClassNameInput?.value || '').trim();
            if (!className) {
                showToast('학급 이름을 입력해주세요.');
                createClassNameInput?.focus();
                return;
            }

            isCreatingClass = true;
            const originalText = createClassConfirmBtn?.textContent || '';
            if (createClassConfirmBtn) {
                createClassConfirmBtn.disabled = true;
                createClassConfirmBtn.textContent = '만드는 중...';
            }

            try {
                const classRef = doc(db, 'classes', user.uid);
                const classSnap = await getDoc(classRef);
                if (classSnap.exists()) {
                    showToast('이미 학급이 존재합니다.');
                    closeCreateClassModal();
                    return;
                }
                await setDoc(classRef, { name: className, students: [] });
                showToast('새 학급이 만들어졌습니다.');
                closeCreateClassModal();
                await loadClasses();
                await loadHomeData();
            } catch (error) {
                console.error('Failed to create class:', error);
                showToast('학급 생성에 실패했습니다. 잠시 후 다시 시도해주세요.');
            } finally {
                isCreatingClass = false;
                if (createClassConfirmBtn) {
                    createClassConfirmBtn.disabled = false;
                    createClassConfirmBtn.textContent = originalText || '만들기';
                }
            }
        }

        async function loadClasses() {
            const user = auth.currentUser;
            if (!user || isLoadingClasses) return;
            isLoadingClasses = true;
            if (classListContainer) {
                classListContainer.innerHTML = '<p class="text-gray-500">로딩 중...</p>';
            }
            const classRef = doc(db, 'classes', user.uid);
            try {
                const classSnap = await getDoc(classRef);
                if (classListContainer) {
                    classListContainer.innerHTML = '';
                }
                if (!classSnap.exists()) {
                    classTitle.textContent = '내 학급';
                    if (classListContainer) {
                        classListContainer.innerHTML = `<p class="text-gray-500">생성된 학급이 없습니다.</p>`;
                    }
                    setClassCreateButtonState(true);
                    return;
                }
                const data = classSnap.data();
                classTitle.textContent = data.name || '내 학급';
                setClassCreateButtonState(false);
                const studentIds = data.students || [];
                if (!studentIds.length) {
                    if (classListContainer) {
                        classListContainer.innerHTML = '<p class="text-gray-500">학생이 없습니다.</p>';
                    }
                } else {
                    for (const sid of studentIds) {
                        try {
                            const sd = await getDoc(doc(db, 'users', sid));
                            if (sd.exists() && classListContainer) {
                                const s = sd.data();
                                const studentEl = document.createElement('div');
                                studentEl.className = 'p-3 border rounded-md flex justify-between items-center';
                                studentEl.innerHTML = `<span>${s.name || sid}</span><button class="achievement-btn text-sky-600 hover:underline text-sm">성취 기준</button>`;
                                studentEl.querySelector('.achievement-btn').addEventListener('click', () => {
                                    openAchievementView(s.name || sid);
                                });
                                classListContainer.appendChild(studentEl);
                            }
                        } catch (err) {
                            console.error(err);
                        }
                    }
                }
            } catch (error) {
                if (classListContainer) {
                    classListContainer.innerHTML = '<p class="text-red-500">학급 정보를 불러오지 못했습니다.</p>';
                }
                setClassCreateButtonState(true);
            } finally {
                isLoadingClasses = false;
            }
        }

        if (addClassBtn) {
            addClassBtn.addEventListener('click', openCreateClassModal);
        }
        createClassCancelBtn?.addEventListener('click', closeCreateClassModal);
        createClassCloseBtn?.addEventListener('click', closeCreateClassModal);
        createClassModal?.addEventListener('click', (event) => {
            if (event.target === createClassModal) {
                closeCreateClassModal();
            }
        });
        createClassForm?.addEventListener('submit', handleCreateClassSubmit);

        // --- Template Generator Logic ---
        function activateTemplateCategory(category) {
            if (!templateCategoryButtons) return;
            activeTemplateCategory = category;
            const buttons = templateCategoryButtons.querySelectorAll('button[data-template-category]');
            buttons.forEach(btn => {
                const isActive = btn.dataset.templateCategory === category;
                btn.classList.toggle('active', isActive);
            });
            if (!majorEvalWorkspace) return;
            if (category === 'major-eval') {
                majorEvalWorkspace.classList.remove('hidden');
                renderMajorEvalList();
                updateMajorEvalWorkspace();
            } else {
                majorEvalWorkspace.classList.add('hidden');
            }
        }

        function generateMajorEvalId() {
            return `major-eval-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
        }

        function ensureMajorEvalEntryShape(entry) {
            if (!entry || typeof entry !== 'object') {
                return null;
            }
            const baseDetails = {
                schoolName: '대전해듬학교',
                domain: '',
                numQuestions: 5,
                evaluationTopic: '',
                admissionYear: '2025',
            };
            const details = Object.assign({}, baseDetails, typeof entry.details === 'object' && entry.details ? entry.details : {});
            details.numQuestions = Number(details.numQuestions) > 0 ? Number(details.numQuestions) : baseDetails.numQuestions;
            const normalized = {
                id: typeof entry.id === 'string' && entry.id ? entry.id : generateMajorEvalId(),
                title: typeof entry.title === 'string' && entry.title.trim() ? entry.title.trim() : '새 심사표',
                details,
                aiData: Array.isArray(entry.aiData) ? entry.aiData.map(item => ({
                    content: typeof item?.content === 'string' ? item.content : '',
                    materials: typeof item?.materials === 'string' ? item.materials : '',
                })) : [],
                pdfContext: typeof entry.pdfContext === 'string' ? entry.pdfContext : '',
                pdfFileName: typeof entry.pdfFileName === 'string' ? entry.pdfFileName : '',
                customHtml: typeof entry.customHtml === 'string' ? entry.customHtml : '',
            };
            return normalized;
        }

        function saveMajorEvalEntries() {
            if (typeof window === 'undefined' || !window.localStorage) return;
            try {
                const payload = majorEvalEntries.map(entry => ({
                    id: entry.id,
                    title: entry.title,
                    details: {
                        schoolName: entry.details?.schoolName || '',
                        domain: entry.details?.domain || '',
                        numQuestions: Number(entry.details?.numQuestions) || (entry.aiData?.length || 5),
                        evaluationTopic: entry.details?.evaluationTopic || '',
                        admissionYear: entry.details?.admissionYear || '2025',
                    },
                    aiData: Array.isArray(entry.aiData) ? entry.aiData : [],
                    pdfContext: entry.pdfContext || '',
                    pdfFileName: entry.pdfFileName || '',
                    customHtml: entry.customHtml || '',
                }));
                localStorage.setItem(MAJOR_EVAL_STORAGE_KEY, JSON.stringify(payload));
                if (activeMajorEvalId) {
                    localStorage.setItem(MAJOR_EVAL_ACTIVE_STORAGE_KEY, activeMajorEvalId);
                } else {
                    localStorage.removeItem(MAJOR_EVAL_ACTIVE_STORAGE_KEY);
                }
            } catch (error) {
                console.error('Failed to save major evaluation entries', error);
            }
        }

        function loadMajorEvalEntries() {
            if (typeof window === 'undefined' || !window.localStorage) return;
            try {
                const stored = localStorage.getItem(MAJOR_EVAL_STORAGE_KEY);
                if (stored) {
                    const parsed = JSON.parse(stored);
                    if (Array.isArray(parsed)) {
                        majorEvalEntries = parsed
                            .map(ensureMajorEvalEntryShape)
                            .filter(Boolean);
                    }
                }
                const savedActive = localStorage.getItem(MAJOR_EVAL_ACTIVE_STORAGE_KEY);
                if (savedActive) {
                    activeMajorEvalId = savedActive;
                }
            } catch (error) {
                console.error('Failed to load major evaluation entries', error);
                majorEvalEntries = [];
            }
            renderMajorEvalList();
            updateMajorEvalWorkspace();
            saveMajorEvalEntries();
        }

        function getMajorEvalPdfContext(entry, maxLength = 1800) {
            const raw = (entry?.pdfContext || '').replace(/\s+/g, ' ').trim();
            if (!raw) return '';
            if (raw.length <= maxLength) return raw;
            return `${raw.slice(0, maxLength)}...`;
        }

        function escapeCssSelector(value) {
            if (typeof value !== 'string') return '';
            if (window.CSS && typeof window.CSS.escape === 'function') {
                return window.CSS.escape(value);
            }
            return value.replace(/[^a-zA-Z0-9_-]/g, match => `\\${match}`);
        }

        async function copyHtmlToClipboard(html) {
            if (!html) return;
            if (navigator.clipboard && typeof navigator.clipboard.write === 'function' && typeof ClipboardItem !== 'undefined') {
                const htmlBlob = new Blob([html], { type: 'text/html' });
                const textBlob = new Blob([html], { type: 'text/plain' });
                const clipboardItem = new ClipboardItem({ 'text/html': htmlBlob, 'text/plain': textBlob });
                await navigator.clipboard.write([clipboardItem]);
                return;
            }
            if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
                await navigator.clipboard.writeText(html);
                return;
            }
            const container = document.createElement('div');
            container.innerHTML = html;
            container.setAttribute('contenteditable', 'true');
            container.style.position = 'absolute';
            container.style.left = '-9999px';
            document.body.appendChild(container);
            const range = document.createRange();
            range.selectNodeContents(container);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            document.execCommand('copy');
            selection.removeAllRanges();
            document.body.removeChild(container);
        }

        async function extractTextFromPdf(file) {
            if (!file) return '';
            if (typeof pdfjsLib === 'undefined') {
                throw new Error('pdfjsLib is not available');
            }
            const arrayBuffer = await file.arrayBuffer();
            const uint8Array = new Uint8Array(arrayBuffer);
            const pdf = await pdfjsLib.getDocument({ data: uint8Array }).promise;
            let text = '';
            for (let pageNumber = 1; pageNumber <= pdf.numPages; pageNumber++) {
                const page = await pdf.getPage(pageNumber);
                const content = await page.getTextContent();
                const pageText = content.items
                    .map(item => (typeof item.str === 'string' ? item.str : ''))
                    .join(' ')
                    .replace(/\s+/g, ' ')
                    .trim();
                if (pageText) {
                    text += pageText + '\n';
                }
            }
            return text.replace(/\s+\n/g, '\n').trim();
        }

        function getActiveMajorEvalEntry() {
            return majorEvalEntries.find(entry => entry.id === activeMajorEvalId) || null;
        }

        function renderMajorEvalList() {
            if (!majorEvalList) return;
            majorEvalList.innerHTML = '';
            if (!Array.isArray(majorEvalEntries)) {
                majorEvalEntries = [];
            }
            if (!majorEvalEntries.length) {
                activeMajorEvalId = '';
                if (majorEvalEmpty) majorEvalEmpty.classList.remove('hidden');
                if (majorEvalUploadSection) majorEvalUploadSection.classList.add('hidden');
                return;
            }

            if (majorEvalEmpty) majorEvalEmpty.classList.add('hidden');
            if (majorEvalUploadSection) majorEvalUploadSection.classList.remove('hidden');

            majorEvalEntries.forEach((entry, index) => {
                const normalizedEntry = ensureMajorEvalEntryShape(entry);
                if (!normalizedEntry) return;
                majorEvalEntries[index] = normalizedEntry;
                const li = document.createElement('li');
                li.className = 'flex items-center gap-2';

                const button = document.createElement('button');
                button.type = 'button';
                button.dataset.entryId = normalizedEntry.id;
                button.dataset.role = 'select-major-eval';
                button.className = `flex-1 text-left px-3 py-2 rounded border transition ${normalizedEntry.id === activeMajorEvalId ? 'border-sky-500 bg-sky-50 text-sky-700' : 'border-gray-200 hover:border-sky-400 hover:bg-sky-50'}`;

                const badges = [];
                if (normalizedEntry.pdfFileName) {
                    badges.push('<span class="text-xs font-medium text-sky-600">PDF</span>');
                }
                if (normalizedEntry.aiData && normalizedEntry.aiData.length) {
                    badges.push('<span class="text-xs font-medium text-emerald-600">완료</span>');
                }
                const badgeHtml = badges.length ? `<span class="flex items-center gap-1">${badges.join('')}</span>` : '';

                button.innerHTML = `
                    <div class="flex items-center justify-between gap-2">
                        <span class="truncate">${escapeHtml(normalizedEntry.title)}</span>
                        ${badgeHtml}
                    </div>
                `;

                const actions = document.createElement('div');
                actions.className = 'flex items-center gap-1 shrink-0';

                const renameBtn = document.createElement('button');
                renameBtn.type = 'button';
                renameBtn.dataset.action = 'rename';
                renameBtn.dataset.entryId = normalizedEntry.id;
                renameBtn.className = 'text-xs text-slate-500 hover:text-sky-600 px-2 py-1 rounded border border-transparent hover:border-sky-200 transition';
                renameBtn.textContent = '이름 변경';

                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.dataset.action = 'delete';
                deleteBtn.dataset.entryId = normalizedEntry.id;
                deleteBtn.className = 'text-xs text-red-500 hover:text-red-600 px-2 py-1 rounded border border-transparent hover:border-red-200 transition';
                deleteBtn.textContent = '삭제';

                actions.appendChild(renameBtn);
                actions.appendChild(deleteBtn);

                li.appendChild(button);
                li.appendChild(actions);
                majorEvalList.appendChild(li);
            });

            if (!activeMajorEvalId && majorEvalEntries.length) {
                activeMajorEvalId = majorEvalEntries[0].id;
                saveMajorEvalEntries();
            }
        }

        function hasMajorEvalOutputData(entry) {
            if (!entry) return false;
            if (Array.isArray(entry.aiData) && entry.aiData.length) return true;
            if (typeof entry.customHtml === 'string' && entry.customHtml.trim()) return true;
            return false;
        }

        function clearMajorEvalManualDraft() {
            hasMajorEvalManualDraft = false;
            majorEvalManualDraftHtml = '';
        }

        function updateMajorEvalActionButtons(entry = getActiveMajorEvalEntry()) {
            const hasData = hasMajorEvalOutputData(entry) || (hasMajorEvalManualDraft && !!majorEvalManualDraftHtml.trim());
            if (majorEvalEditToggleBtn) {
                majorEvalEditToggleBtn.disabled = !hasData;
                majorEvalEditToggleBtn.textContent = isMajorEvalManualEditing ? '완료' : '편집';
            }
            if (majorEvalSaveBtn) {
                majorEvalSaveBtn.disabled = !hasData || isMajorEvalManualEditing;
            }
            if (majorEvalPdfBtn) {
                majorEvalPdfBtn.disabled = !hasData || isMajorEvalManualEditing;
            }
            const canAdjustQuestions = Array.isArray(entry?.aiData) && entry.aiData.length > 0 && !isMajorEvalManualEditing;
            if (majorEvalQuestionIncreaseBtn) majorEvalQuestionIncreaseBtn.disabled = !canAdjustQuestions;
            if (majorEvalQuestionIncreaseInput) majorEvalQuestionIncreaseInput.disabled = !canAdjustQuestions;
        }

        function guardMajorEvalManualState(actionMessage) {
            if (isMajorEvalManualEditing) {
                alert(`수동 편집을 완료한 후 ${actionMessage}`);
                return true;
            }
            if (hasMajorEvalManualDraft) {
                alert(`편집 내용을 저장한 후 ${actionMessage}`);
                return true;
            }
            return false;
        }

        function startMajorEvalManualEdit() {
            if (isMajorEvalManualEditing) return;
            const entry = getActiveMajorEvalEntry();
            if (!hasMajorEvalOutputData(entry)) {
                alert('편집할 심사표를 먼저 생성해 주세요.');
                return;
            }
            if (!majorEvalOutput || !majorEvalOutput.innerHTML.trim()) {
                alert('편집할 내용이 없습니다.');
                return;
            }
            clearMajorEvalManualDraft();
            isMajorEvalManualEditing = true;
            majorEvalManualNode = majorEvalOutput;
            majorEvalManualNode.setAttribute('contenteditable', 'true');
            majorEvalManualNode.classList.add('manual-editing');
            if (majorEvalModifyInput) majorEvalModifyInput.disabled = true;
            if (majorEvalModifyBtn) {
                majorEvalModifyBtn.disabled = true;
                majorEvalModifyBtn.classList.add('opacity-50', 'pointer-events-none');
            }
            if (majorEvalQuestionIncreaseBtn) majorEvalQuestionIncreaseBtn.disabled = true;
            if (majorEvalQuestionIncreaseInput) majorEvalQuestionIncreaseInput.disabled = true;
            updateMajorEvalActionButtons(entry);
            setTimeout(() => {
                try {
                    majorEvalManualNode?.focus();
                } catch (error) {
                    console.warn('Unable to focus manual edit node', error);
                }
            }, 0);
        }

        function finishMajorEvalManualEdit(options = {}) {
            if (!isMajorEvalManualEditing) return;
            if (majorEvalManualNode) {
                majorEvalManualNode.removeAttribute('contenteditable');
                majorEvalManualNode.classList.remove('manual-editing');
            }
            isMajorEvalManualEditing = false;
            majorEvalManualNode = null;
            majorEvalManualDraftHtml = majorEvalOutput?.innerHTML || '';
            hasMajorEvalManualDraft = !!majorEvalManualDraftHtml.trim();
            const entry = getActiveMajorEvalEntry();
            const canModify = Array.isArray(entry?.aiData) && entry.aiData.length > 0;
            if (majorEvalModifyInput) majorEvalModifyInput.disabled = !canModify;
            if (majorEvalModifyBtn) {
                majorEvalModifyBtn.disabled = !canModify;
                majorEvalModifyBtn.classList.toggle('opacity-50', !canModify);
                majorEvalModifyBtn.classList.toggle('pointer-events-none', !canModify);
            }
            updateMajorEvalActionButtons(entry);
            if (!options.silent) {
                const message = hasMajorEvalManualDraft
                    ? '수동 편집이 완료되었습니다. 저장 버튼을 눌러주세요.'
                    : '수동 편집이 완료되었습니다.';
                showToast(message);
            }
        }

        function updateMajorEvalWorkspace() {
            if (!majorEvalWorkspace) return;
            if (!majorEvalEntries.length) {
                majorEvalInputSection?.classList.add('hidden');
                majorEvalModifySection?.classList.add('hidden');
                if (majorEvalUploadSection) majorEvalUploadSection.classList.add('hidden');
                if (majorEvalUploadBtn) majorEvalUploadBtn.disabled = true;
                if (majorEvalUploadInfo) majorEvalUploadInfo.classList.add('hidden');
                clearMajorEvalManualDraft();
                updateMajorEvalActionButtons(null);
                renderMajorEvalOutput(null);
                return;
            }

            let entry = getActiveMajorEvalEntry();
            if (!entry) {
                entry = majorEvalEntries[0];
                activeMajorEvalId = entry.id;
            }

            const entryIndex = majorEvalEntries.findIndex(item => item.id === entry.id);
            let normalizedEntry = ensureMajorEvalEntryShape(entry);
            if (!normalizedEntry) {
                normalizedEntry = {
                    id: entry.id || generateMajorEvalId(),
                    title: entry.title || '새 심사표',
                    details: { schoolName: '', domain: '', numQuestions: 5, evaluationTopic: '', admissionYear: '2025' },
                    aiData: Array.isArray(entry.aiData) ? entry.aiData : [],
                    pdfContext: '',
                    pdfFileName: '',
                    customHtml: typeof entry.customHtml === 'string' ? entry.customHtml : '',
                };
            }
            if (entryIndex !== -1) {
                majorEvalEntries[entryIndex] = normalizedEntry;
            }
            entry = normalizedEntry;

            populateMajorEvalInputs(entry);

            if (majorEvalUploadSection) majorEvalUploadSection.classList.remove('hidden');
            if (majorEvalUploadBtn) {
                majorEvalUploadBtn.disabled = !!isMajorEvalUploading;
                majorEvalUploadBtn.textContent = isMajorEvalUploading ? '추출 중...' : '예시 파일 업로드';
            }
            if (majorEvalUploadInfo) {
                if (entry.pdfFileName) {
                    majorEvalUploadInfo.textContent = `업로드된 파일: ${entry.pdfFileName}`;
                } else {
                    majorEvalUploadInfo.textContent = '업로드된 파일이 없습니다.';
                }
                majorEvalUploadInfo.classList.remove('hidden');
            }

            const hasGeneratedData = Array.isArray(entry.aiData) && entry.aiData.length > 0;
            const hasCustomOutput = typeof entry.customHtml === 'string' && entry.customHtml.trim().length > 0;

            if (hasGeneratedData || hasCustomOutput) {
                majorEvalInputSection?.classList.add('hidden');
                majorEvalModifySection?.classList.remove('hidden');
                const canModify = hasGeneratedData;
                if (majorEvalModifyInput) {
                    majorEvalModifyInput.value = '';
                    majorEvalModifyInput.disabled = !canModify;
                }
                if (majorEvalModifyBtn) {
                    majorEvalModifyBtn.disabled = !canModify;
                    majorEvalModifyBtn.classList.toggle('opacity-50', !canModify);
                    majorEvalModifyBtn.classList.toggle('pointer-events-none', !canModify);
                }
                if (majorEvalQuestionIncreaseInput && !isMajorEvalManualEditing) {
                    majorEvalQuestionIncreaseInput.value = '1';
                }
            } else {
                majorEvalInputSection?.classList.remove('hidden');
                majorEvalModifySection?.classList.add('hidden');
                if (majorEvalModifyInput) {
                    majorEvalModifyInput.value = '';
                    majorEvalModifyInput.disabled = true;
                }
                if (majorEvalModifyBtn) {
                    majorEvalModifyBtn.disabled = true;
                    majorEvalModifyBtn.classList.add('opacity-50');
                    majorEvalModifyBtn.classList.add('pointer-events-none');
                }
            }

            renderMajorEvalOutput(entry);
            updateMajorEvalActionButtons(entry);
        }

        function populateMajorEvalInputs(entry) {
            if (!entry || !entry.details) return;
            if (majorEvalSchoolInput) majorEvalSchoolInput.value = entry.details.schoolName || '';
            if (majorEvalDomainInput) majorEvalDomainInput.value = entry.details.domain || '';
            if (majorEvalQuestionsInput) majorEvalQuestionsInput.value = entry.details.numQuestions || 5;
            if (majorEvalTopicInput) majorEvalTopicInput.value = entry.details.evaluationTopic || '';
        }

        function createMajorEvalEntry(title) {
            const newEntry = ensureMajorEvalEntryShape({
                id: generateMajorEvalId(),
                title: title.trim() || '새 심사표',
                details: { schoolName: '', domain: '', numQuestions: 5, evaluationTopic: '', admissionYear: '2025' },
                aiData: [],
                pdfContext: '',
                pdfFileName: '',
            });
            majorEvalEntries = [newEntry, ...majorEvalEntries];
            activeMajorEvalId = newEntry.id;
            renderMajorEvalList();
            updateMajorEvalWorkspace();
            saveMajorEvalEntries();
        }

        function showMajorEvalModal() {
            if (!majorEvalModal) return;
            majorEvalModal.classList.remove('hidden');
            majorEvalModal.classList.add('flex');
            majorEvalModalTitle.value = '';
            setTimeout(() => majorEvalModalTitle.focus(), 50);
        }

        function hideMajorEvalModal() {
            if (!majorEvalModal) return;
            majorEvalModal.classList.add('hidden');
            majorEvalModal.classList.remove('flex');
            majorEvalModalTitle.value = '';
        }

        function renderMajorEvalOutput(entry) {
            if (!majorEvalOutput) return;
            if (hasMajorEvalManualDraft) return;
            if (!entry) {
                majorEvalOutput.innerHTML = '<p class="text-gray-500">왼쪽 목록에서 심사표를 선택하면 결과가 표시됩니다.</p>';
                return;
            }

            const customHtml = typeof entry.customHtml === 'string' ? entry.customHtml.trim() : '';
            if (customHtml && !isMajorEvalManualEditing) {
                majorEvalOutput.innerHTML = customHtml;
                return;
            }

            const details = entry.details || {};
            const items = Array.isArray(entry.aiData) ? entry.aiData : [];

            if (!items.length) {
                majorEvalOutput.innerHTML = '<p class="text-gray-500">입력 정보를 작성한 뒤 생성 버튼을 눌러 심사표를 만들어보세요.</p>';
                return;
            }

            const normalizedItems = normalizeMajorEvalData(items, details.numQuestions || items.length);
            if (!normalizedItems.length) {
                majorEvalOutput.innerHTML = '<p class="text-red-500">AI가 결과를 생성하지 못했습니다. 다시 시도해주세요.</p>';
                return;
            }

            const schoolName = details.schoolName || '대전해듬학교';
            const domain = details.domain || '영역';
            const evaluationTopic = details.evaluationTopic || '평가 주제';
            const admissionYear = details.admissionYear || '2025';
            const evaluationTableId = `${entry.id}-evaluation-table`;
            const recordTableId = `${entry.id}-record-table`;

            const evaluationRows = normalizedItems.map((item, index) => {
                const domainCell = index === 0 ? `<td rowspan="${normalizedItems.length}" class="border px-2 py-2 align-middle font-medium">${escapeHtml(domain)}</td>` : '';
                return `
                    <tr>
                        ${domainCell}
                        <td class="border px-2 py-2">${index + 1}</td>
                        <td class="border px-2 py-2 text-left">${formatCellText(item.content)}</td>
                        <td class="border px-2 py-2">2</td>
                        <td class="border px-2 py-2 text-left">${formatCellText(item.materials || '필요 준비물 없음')}</td>
                    </tr>
                `;
            }).join('');

            const recordRows = normalizedItems.map((item, index) => {
                const domainCell = index === 0 ? `<td rowspan="${normalizedItems.length}" class="border px-2 py-2 align-middle font-medium">${escapeHtml(domain)}</td>` : '';
                return `
                    <tr>
                        ${domainCell}
                        <td class="border px-2 py-2">${index + 1}</td>
                        <td class="border px-2 py-2 text-left">${formatCellText(item.content)}</td>
                        <td class="border px-2 py-2"></td>
                    </tr>
                `;
            }).join('');

            majorEvalOutput.innerHTML = `
                <div class="space-y-8">
                    <section class="major-eval-page" data-page="1">
                        <div class="text-center space-y-2 mb-6">
                            <p class="text-sm text-gray-600">${escapeHtml(admissionYear)}학년도 ${escapeHtml(schoolName)} 전공과 입학 전형</p>
                            <h3 class="text-2xl font-bold text-gray-800">직업능력평가 (실무 능력 심사표)</h3>
                            <p class="text-sm text-gray-500">평가 주제: ${escapeHtml(evaluationTopic)}</p>
                        </div>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between gap-3">
                                <h4 class="font-semibold text-lg text-gray-800">1페이지 · 직업능력평가 심사표</h4>
                                <button type="button" class="major-eval-copy-btn" data-copy-target="${evaluationTableId}">HTML 복사</button>
                            </div>
                            <div class="text-sm text-gray-600 space-y-1">
                                <p>○ 평가 기준: 100% 수행(2점), 못함(0점)</p>
                                <p>○ 제한 시간: 문항당 30초 / ○ 준비물: 초시계</p>
                            </div>
                            <table id="${evaluationTableId}" class="w-full border border-gray-300 text-sm bg-white">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="border px-2 py-2 w-32">영역</th>
                                        <th class="border px-2 py-2 w-16">문항</th>
                                        <th class="border px-2 py-2">내용</th>
                                        <th class="border px-2 py-2 w-16">배점</th>
                                        <th class="border px-2 py-2 w-32">자료(수)</th>
                                    </tr>
                                </thead>
                                <tbody>${evaluationRows}</tbody>
                            </table>
                        </div>
                    </section>
                    <section class="major-eval-page" data-page="2">
                        <div class="space-y-4">
                            <div class="flex items-center justify-between gap-3">
                                <h4 class="font-semibold text-lg text-gray-800">2페이지 · 직업능력평가 기록지</h4>
                                <button type="button" class="major-eval-copy-btn" data-copy-target="${recordTableId}">HTML 복사</button>
                            </div>
                            <table id="${recordTableId}" class="w-full border border-gray-300 text-sm bg-white">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="border px-2 py-2 w-32">영역</th>
                                        <th class="border px-2 py-2 w-16">문항</th>
                                        <th class="border px-2 py-2">내용</th>
                                        <th class="border px-2 py-2 w-24">취득점수</th>
                                    </tr>
                                </thead>
                                <tbody>${recordRows}</tbody>
                                <tfoot>
                                    <tr>
                                        <th colspan="3" class="border px-2 py-2 text-right">합계</th>
                                        <td class="border px-2 py-2"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </section>
                </div>
            `;
        }

        function normalizeMajorEvalData(raw, count) {
            let items = [];
            if (Array.isArray(raw)) {
                items = raw;
            } else if (Array.isArray(raw?.items)) {
                items = raw.items;
            } else if (Array.isArray(raw?.data)) {
                items = raw.data;
            }

            if (!items.length) {
                return [];
            }

            const total = Math.max(1, count || items.length);
            const normalized = [];

            for (let i = 0; i < total; i++) {
                const source = items[i] || {};
                const content = typeof source.content === 'string' ? source.content.trim() : '';
                const materials = typeof source.materials === 'string' ? source.materials.trim() : '';
                normalized.push({
                    content: content || '내용을 확인해주세요.',
                    materials: materials || '필요 준비물 없음'
                });
            }

            return normalized;
        }

        if (templateCategoryButtons) {
            templateCategoryButtons.addEventListener('click', (event) => {
                const button = event.target.closest('button[data-template-category]');
                if (!button) return;
                activateTemplateCategory(button.dataset.templateCategory);
            });
        }

        if (majorEvalAddBtn) {
            majorEvalAddBtn.addEventListener('click', () => {
                if (guardMajorEvalManualState('새 심사표를 추가해 주세요.')) return;
                showMajorEvalModal();
            });
        }

        if (majorEvalModalCancel) {
            majorEvalModalCancel.addEventListener('click', () => {
                hideMajorEvalModal();
            });
        }

        if (majorEvalModal) {
            majorEvalModal.addEventListener('click', (event) => {
                if (event.target === majorEvalModal) {
                    hideMajorEvalModal();
                }
            });
        }

        if (majorEvalModalConfirm) {
            majorEvalModalConfirm.addEventListener('click', () => {
                const title = majorEvalModalTitle.value.trim();
                if (!title) {
                    alert('제목을 입력해주세요.');
                    return;
                }
                createMajorEvalEntry(title);
                hideMajorEvalModal();
            });
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && majorEvalModal && !majorEvalModal.classList.contains('hidden')) {
                hideMajorEvalModal();
            }
        });

        if (majorEvalList) {
            majorEvalList.addEventListener('click', (event) => {
                const target = event.target;
                if (!(target instanceof HTMLElement)) return;

                const actionButton = target.closest('button[data-action]');
                if (actionButton) {
                    if (guardMajorEvalManualState('해당 작업을 진행해 주세요.')) return;
                    const entryId = actionButton.dataset.entryId;
                    const action = actionButton.dataset.action;
                    if (!entryId || !action) return;
                    const entryIndex = majorEvalEntries.findIndex(item => item.id === entryId);
                    if (entryIndex === -1) return;
                    const entry = majorEvalEntries[entryIndex];

                    if (action === 'rename') {
                        const newTitle = prompt('새 이름을 입력하세요.', entry.title || '');
                        if (newTitle && newTitle.trim()) {
                            entry.title = newTitle.trim();
                            saveMajorEvalEntries();
                            renderMajorEvalList();
                            updateMajorEvalWorkspace();
                        }
                    } else if (action === 'delete') {
                        const confirmed = confirm('선택한 심사표를 삭제하시겠습니까?');
                        if (!confirmed) return;
                        majorEvalEntries.splice(entryIndex, 1);
                        if (activeMajorEvalId === entryId) {
                            activeMajorEvalId = majorEvalEntries[0]?.id || '';
                        }
                        saveMajorEvalEntries();
                        renderMajorEvalList();
                        updateMajorEvalWorkspace();
                    }
                    return;
                }

                const button = target.closest('button[data-role="select-major-eval"]');
                if (!button) return;
                const entryId = button.dataset.entryId;
                if (!entryId) return;
                if (guardMajorEvalManualState('다른 심사표를 선택해 주세요.')) return;
                if (activeMajorEvalId === entryId) return;
                activeMajorEvalId = entryId;
                saveMajorEvalEntries();
                renderMajorEvalList();
                updateMajorEvalWorkspace();
            });
        }

        if (majorEvalUploadBtn && majorEvalUploadInput) {
            majorEvalUploadBtn.addEventListener('click', () => {
                if (isMajorEvalUploading) return;
                if (guardMajorEvalManualState('PDF를 업로드해 주세요.')) return;
                if (!getActiveMajorEvalEntry()) {
                    alert('먼저 심사표를 선택해 주세요.');
                    return;
                }
                majorEvalUploadInput.value = '';
                majorEvalUploadInput.click();
            });
        }

        if (majorEvalUploadInput) {
            majorEvalUploadInput.addEventListener('change', async (event) => {
                if (guardMajorEvalManualState('PDF를 업로드해 주세요.')) {
                    majorEvalUploadInput.value = '';
                    return;
                }
                const file = event.target.files && event.target.files[0];
                if (!file) return;
                const entry = getActiveMajorEvalEntry();
                if (!entry) {
                    alert('먼저 심사표를 선택해 주세요.');
                    majorEvalUploadInput.value = '';
                    return;
                }
                if (file.type !== 'application/pdf') {
                    alert('PDF 파일만 업로드할 수 있습니다.');
                    majorEvalUploadInput.value = '';
                    return;
                }

                isMajorEvalUploading = true;
                updateMajorEvalWorkspace();

                try {
                    const extractedText = await extractTextFromPdf(file);
                    if (!extractedText) {
                        throw new Error('empty');
                    }
                    const condensedText = extractedText.length > 6000 ? `${extractedText.slice(0, 6000)}...` : extractedText;
                    entry.pdfContext = condensedText;
                    entry.pdfFileName = file.name;
                    saveMajorEvalEntries();
                    updateMajorEvalWorkspace();
                    showToast('PDF에서 내용을 추출했습니다.');
                } catch (error) {
                    console.error('Failed to extract PDF text', error);
                    alert('PDF 내용을 추출하지 못했습니다. 다른 파일로 시도해 주세요.');
                } finally {
                    isMajorEvalUploading = false;
                    updateMajorEvalWorkspace();
                    majorEvalUploadInput.value = '';
                }
            });
        }

        const majorEvalInputs = [
            [majorEvalSchoolInput, 'schoolName'],
            [majorEvalDomainInput, 'domain'],
            [majorEvalQuestionsInput, 'numQuestions'],
            [majorEvalTopicInput, 'evaluationTopic']
        ];

        majorEvalInputs.forEach(([input, key]) => {
            if (!input) return;
            input.addEventListener('input', () => {
                const entry = getActiveMajorEvalEntry();
                if (!entry) return;
                if (guardMajorEvalManualState('입력 값을 수정해 주세요.')) {
                    const currentValue = key === 'numQuestions'
                        ? entry.details?.numQuestions ?? 5
                        : entry.details?.[key] ?? '';
                    input.value = key === 'numQuestions' ? String(currentValue || 1) : currentValue;
                    return;
                }
                if (!entry.details) entry.details = { schoolName: '', domain: '', numQuestions: 5, evaluationTopic: '', admissionYear: '2025' };
                if (key === 'numQuestions') {
                    let value = parseInt(input.value, 10);
                    if (!Number.isFinite(value) || value < 1) {
                        value = 1;
                    }
                    entry.details[key] = value;
                    input.value = value;
                } else {
                    entry.details[key] = input.value;
                }
                entry.customHtml = '';
                clearMajorEvalManualDraft();
                saveMajorEvalEntries();
                renderMajorEvalOutput(entry);
                updateMajorEvalActionButtons(entry);
            });
        });

        if (majorEvalGenerateBtn) {
            majorEvalGenerateBtn.addEventListener('click', async () => {
                const entry = getActiveMajorEvalEntry();
                if (!entry || isMajorEvalGenerating) return;
                if (guardMajorEvalManualState('생성 기능을 사용해 주세요.')) return;

                const schoolName = (majorEvalSchoolInput?.value || '').trim();
                const domain = (majorEvalDomainInput?.value || '').trim();
                const evaluationTopic = (majorEvalTopicInput?.value || '').trim();
                let numQuestions = parseInt(majorEvalQuestionsInput?.value || '0', 10);
                if (!Number.isFinite(numQuestions) || numQuestions < 1) {
                    numQuestions = 1;
                }

                if (!domain || !evaluationTopic) {
                    alert('영역과 평가 주제를 입력해주세요.');
                    return;
                }

                entry.details = {
                    schoolName,
                    domain,
                    evaluationTopic,
                    numQuestions,
                    admissionYear: entry.details?.admissionYear || '2025'
                };
                entry.customHtml = '';
                clearMajorEvalManualDraft();

                const pdfReference = getMajorEvalPdfContext(entry);
                const referenceBlock = pdfReference ? `\n\n참고 자료(예시 PDF에서 추출):\n${pdfReference}` : '';
                const prompt = `너는 특수학교 전공과 입학 전형 심사표를 만드는 전문가야. 아래 정보를 참고하여 직업능력평가 심사표 문항을 JSON 배열로 작성해줘.

학교 이름: ${schoolName || '[학교 이름]'}
영역: ${domain}
평가 주제: ${evaluationTopic}
문항 수: ${numQuestions}${referenceBlock}

요구사항:
1. JSON 배열의 길이는 반드시 ${numQuestions}개여야 해.
2. 각 요소는 {"content":"지시문", "materials":"준비물 목록"} 형식이어야 하며 다른 속성은 포함하지 마.
3. content는 학생에게 명확히 지시하는 문장으로 작성하고 반드시 '~하시오.'로 끝내.
4. materials는 과제 수행에 필요한 준비물을 쉼표로 구분된 한 줄 문자열로 작성해. 준비물이 없으면 '필요 준비물 없음'이라고 적어.
5. 설명이나 주석 없이 JSON 배열만 반환해.
6. 참고 자료가 제공되면 해당 표현과 절차를 참고하되, 문항은 특수학교 직업능력평가 심사표 형식에 맞게 조정해.`;

                const originalText = majorEvalGenerateBtn.textContent;
                majorEvalGenerateBtn.textContent = '생성 중...';
                majorEvalGenerateBtn.disabled = true;
                isMajorEvalGenerating = true;

                try {
                    const result = await callGemini(prompt, true);
                    const normalized = normalizeMajorEvalData(result, numQuestions);
                    if (!normalized.length) {
                        throw new Error('empty');
                    }
                    entry.aiData = normalized;
                    entry.customHtml = '';
                    clearMajorEvalManualDraft();
                    saveMajorEvalEntries();
                    renderMajorEvalList();
                    updateMajorEvalWorkspace();
                    showToast('심사표가 생성되었습니다.');
                } catch (error) {
                    console.error('Failed to generate major evaluation sheet', error);
                    alert('심사표를 생성하지 못했습니다. 잠시 후 다시 시도해주세요.');
                } finally {
                    isMajorEvalGenerating = false;
                    majorEvalGenerateBtn.disabled = false;
                    majorEvalGenerateBtn.textContent = originalText;
                }
            });
        }

        if (majorEvalModifyBtn) {
            majorEvalModifyBtn.addEventListener('click', async () => {
                if (guardMajorEvalManualState('수정 기능을 사용해 주세요.')) return;
                const entry = getActiveMajorEvalEntry();
                if (!entry || !entry.aiData?.length || isMajorEvalModifying) return;

                const instruction = (majorEvalModifyInput?.value || '').trim();
                if (!instruction) {
                    alert('수정할 내용을 입력해주세요.');
                    return;
                }

                const pdfReference = getMajorEvalPdfContext(entry);
                const referenceBlock = pdfReference ? `\n\n참고 자료(예시 PDF에서 추출):\n${pdfReference}` : '';
                const prompt = `너는 특수학교 전공과 직업능력평가 심사표를 다듬는 전문가야. 아래 JSON 데이터를 사용자의 요청에 맞게 수정해줘.${referenceBlock}

현재 데이터:
${JSON.stringify(entry.aiData, null, 2)}

사용자 요청: ${instruction}

조건:
1. 배열 길이는 ${entry.details?.numQuestions || entry.aiData.length}개로 유지해.
2. 각 요소는 {"content":"지시문", "materials":"준비물"} 형식을 따르고 다른 속성은 추가하지 마.
3. content는 '~하시오.'로 끝나는 지시문 형태로 작성하고, materials는 쉼표로 구분된 준비물 목록을 제공해. 준비물이 없다면 '필요 준비물 없음'이라고 작성해.
4. 설명 없이 JSON 배열만 반환해.`;

                const originalText = majorEvalModifyBtn.textContent;
                majorEvalModifyBtn.textContent = '수정 중...';
                majorEvalModifyBtn.disabled = true;
                isMajorEvalModifying = true;

                try {
                    const result = await callGemini(prompt, true);
                    const normalized = normalizeMajorEvalData(result, entry.details?.numQuestions || entry.aiData.length);
                    if (!normalized.length) {
                        throw new Error('empty');
                    }
                    entry.aiData = normalized;
                    entry.customHtml = '';
                    clearMajorEvalManualDraft();
                    saveMajorEvalEntries();
                    renderMajorEvalList();
                    renderMajorEvalOutput(entry);
                    if (majorEvalModifyInput) majorEvalModifyInput.value = '';
                    showToast('수정된 내용이 적용되었습니다.');
                } catch (error) {
                    console.error('Failed to modify major evaluation sheet', error);
                    alert('출력을 수정하지 못했습니다. 다시 시도해주세요.');
                } finally {
                    isMajorEvalModifying = false;
                    majorEvalModifyBtn.disabled = false;
                    majorEvalModifyBtn.textContent = originalText;
                }
            });
        }

        majorEvalEditToggleBtn?.addEventListener('click', () => {
            const entry = getActiveMajorEvalEntry();
            if (!entry || !hasMajorEvalOutputData(entry)) {
                alert('편집할 심사표를 선택해 주세요.');
                return;
            }
            if (isMajorEvalManualEditing) {
                finishMajorEvalManualEdit();
            } else {
                startMajorEvalManualEdit();
            }
        });

        majorEvalSaveBtn?.addEventListener('click', () => {
            const entry = getActiveMajorEvalEntry();
            if (!entry) {
                alert('저장할 심사표를 선택해 주세요.');
                return;
            }
            if (isMajorEvalManualEditing) {
                alert('수동 편집을 완료한 후 저장해 주세요.');
                return;
            }
            const htmlToSave = hasMajorEvalManualDraft && majorEvalManualDraftHtml.trim()
                ? majorEvalManualDraftHtml
                : (majorEvalOutput?.innerHTML || '');
            if (!htmlToSave.trim()) {
                alert('저장할 내용이 없습니다.');
                return;
            }
            entry.customHtml = htmlToSave;
            clearMajorEvalManualDraft();
            saveMajorEvalEntries();
            renderMajorEvalOutput(entry);
            updateMajorEvalActionButtons(entry);
            showToast('편집 내용이 저장되었습니다.');
        });

        majorEvalPdfBtn?.addEventListener('click', async () => {
            const entry = getActiveMajorEvalEntry();
            if (!entry) {
                alert('저장할 심사표를 선택해 주세요.');
                return;
            }
            if (isMajorEvalManualEditing) {
                alert('수동 편집을 완료한 후 PDF를 저장해 주세요.');
                return;
            }
            if (!majorEvalOutput || !majorEvalOutput.innerHTML.trim()) {
                alert('저장할 내용이 없습니다.');
                return;
            }
            const clone = majorEvalOutput.cloneNode(true);
            clone.querySelectorAll('button').forEach(btn => btn.remove());
            const schoolName = (entry.details?.schoolName || '').trim();
            const title = (entry.title || '').trim();
            const baseName = [schoolName, title || '전공과 심사표'].filter(Boolean).join('_') || '전공과_심사표';
            const filename = `${sanitizeFileName(baseName) || '전공과_심사표'}.pdf`;
            const options = {
                margin: 10,
                filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            const originalText = majorEvalPdfBtn.textContent;
            majorEvalPdfBtn.disabled = true;
            majorEvalPdfBtn.textContent = '저장 중...';
            try {
                await html2pdf().from(clone).set(options).save();
                showToast('PDF로 저장했습니다.');
            } catch (error) {
                console.error('Failed to save major evaluation PDF', error);
                alert('PDF 저장에 실패했습니다. 다시 시도해 주세요.');
            } finally {
                majorEvalPdfBtn.disabled = false;
                majorEvalPdfBtn.textContent = originalText || 'PDF 저장';
            }
        });

        majorEvalQuestionIncreaseBtn?.addEventListener('click', () => {
            if (guardMajorEvalManualState('문항을 늘려 주세요.')) return;
            const entry = getActiveMajorEvalEntry();
            if (!entry) {
                alert('문항을 늘릴 심사표를 선택해 주세요.');
                return;
            }
            if (!Array.isArray(entry.aiData) || !entry.aiData.length) {
                alert('생성된 심사표가 있어야 문항을 늘릴 수 있습니다.');
                return;
            }
            let amount = parseInt(majorEvalQuestionIncreaseInput?.value || '0', 10);
            if (!Number.isFinite(amount) || amount < 1) {
                amount = 1;
            }
            if (majorEvalQuestionIncreaseInput) {
                majorEvalQuestionIncreaseInput.value = String(amount);
            }
            const currentQuestions = Number(entry.details?.numQuestions) || entry.aiData.length;
            const newTotal = currentQuestions + amount;
            if (!entry.details) {
                entry.details = { schoolName: '', domain: '', numQuestions: newTotal, evaluationTopic: '', admissionYear: '2025' };
            }
            entry.details.numQuestions = newTotal;
            for (let i = entry.aiData.length; i < newTotal; i += 1) {
                entry.aiData.push({ content: '내용을 확인해주세요.', materials: '필요 준비물 없음' });
            }
            entry.customHtml = '';
            clearMajorEvalManualDraft();
            saveMajorEvalEntries();
            updateMajorEvalWorkspace();
            showToast(`${amount}개의 문항이 추가되었습니다.`);
        });

        if (majorEvalModifyInput) {
            majorEvalModifyInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    majorEvalModifyBtn?.click();
                }
            });
        }

        if (majorEvalOutput) {
            majorEvalOutput.addEventListener('click', async (event) => {
                const target = event.target;
                if (!(target instanceof HTMLElement)) return;
                const copyBtn = target.closest('button[data-copy-target]');
                if (!copyBtn) return;
                const targetId = copyBtn.dataset.copyTarget;
                if (!targetId) return;
                const selector = `#${escapeCssSelector(targetId)}`;
                const table = majorEvalOutput.querySelector(selector);
                if (!table) {
                    alert('복사할 표를 찾을 수 없습니다.');
                    return;
                }
                try {
                    await copyHtmlToClipboard(table.outerHTML.trim());
                    showToast('표가 클립보드에 복사되었습니다.');
                } catch (error) {
                    console.error('Failed to copy table HTML', error);
                    alert('표를 복사하지 못했습니다. 다시 시도해 주세요.');
                }
            });
        }

        loadMajorEvalEntries();

        const achievementTables = {
            elementary: {
                korean: `| **학년(군)** | **듣기⋅말하기** | **읽기** | **쓰기** | **문법** | **문학** | **매체** |
|---|---|---|---|---|---|---|
| 1-2 | [2국01-01] 중요한 내용이나 일이 일어난 순서를 고려하며 듣고 말한다. | [2국02-01] 글자, 단어, 문장, 짧은 글을 정확하게 소리 내어 읽는다. | [2국03-01] 글자와 단어를 바르게 쓴다. | [2국04-01] 한글 자모의 이름과 소릿값을 알고 정확하게 발음하고 쓴다. | [2국05-01] 말놀이, 낱말 등을 통해 말의 재미와 즐거움을 느낀다. | [2국06-01] 일상의 다양한 매체와 매체 자료에 흥미와 관심을 가진다. |
| 1-2 | [2국01-02] 바르고 고운 말로 서로의 감정을 나누며 듣고 말한다. | [2국02-02] 의미가 잘 드러나도록 문장과 짧은 글을 알맞게 띄어 읽는다. | [2국03-02] 쓰기에 흥미를 가지며 자신의 생각이나 느낌을 문장으로 표현한다. | [2국04-02] 소리와 표기가 다를 수 있음을 알고 단어를 바르게 읽고 쓴다. | [2국05-02] 작품을 듣거나 읽으면서 느끼거나 생각한 점을 말한다. | [2국06-02] 일상의 경험과 생각을 글과 그림으로 표현한다. |
| 1-2 | [2국01-03] 상대의 말을 집중하여 듣고 말차례를 지키며 대화한다. | [2국02-03] 글을 읽고 중심 내용을 확인한다. | [2국03-03] 주변 소재에 대해 소개하는 글을 쓴다. | [2국04-03] 문장과 문장 부호를 알맞게 쓰고 한글에 호기심을 가진다. | [2국05-03] 작품 속 인물의 모습, 행동, 마음을 상상하여 시, 노래, 이야기, 그림 등으로 표현한다. | |
| 1-2 | [2국01-04] 자신의 경험이나 생각을 바르게 자세히 발표한다. | [2국02-04] 인물의 마음이나 생각을 짐작하고 이를 자신과 비교하며 글을 읽는다. | [2국03-04] 겪은 일을 표현하는 글을 자유롭게 쓰고, 쓴 글을 함께 읽고 생각이나 느낌을 나눈다. | | [2국05-04] 시나 노래, 이야기에 흥미를 가진다. | |
| 1-2 | [2국01-05] 듣기와 말하기에 관심과 흥미를 가진다. | [2국02-05] 읽기에 흥미를 가지고 즐겨 읽는 태도를 지닌다. | | | | |
| 3-4 | [4국01-01] 중요한 내용과 주제를 파악하며 듣고 그 내용을 요약한다. | [4국02-01] 글의 의미를 파악하며 유창하게 글을 읽는다. | [4국03-01] 중심 문장과 뒷받침 문장을 갖추어 문단을 쓰고, 문장과 문단을 중심으로 고쳐 쓴다. | [4국04-01] 단어와 단어 간의 의미 관계를 파악한다. | [4국05-01] 인물과 이야기의 흐름을 중심으로 작품을 감상한다. | [4국06-01] 인터넷에서 학습에 필요한 다양한 자료를 탐색하고 목적에 맞게 자료를 선택한다. |
| 3-4 | [4국01-02] 원인과 결과의 관계를 고려하여 내용을 예측하며 듣고 말한다. | [4국02-02] 문단과 글에서 중심 생각을 파악하고 내용을 간추린다. | [4국03-02] 절차와 결과가 드러나게 정확한 표현으로 보고하는 글을 쓴다. | [4국04-02] 단어를 분류하고 국어사전을 활용하여 능동적인 국어 활동을 한다. | [4국05-02] 자신의 경험을 바탕으로 작품 속 세계와 현실 세계를 비교하여 작품을 감상한다. | [4국06-02] 매체를 활용하여 간단한 발표 자료를 만든다. |
| 3-4 | [4국01-03] 상황에 적절한 준언어⋅비언어적 표현을 활용하여 듣고 말한다. | [4국02-03] 질문을 활용하여 글을 예측하며 읽고 자신의 읽기 과정을 점검한다. | [4국03-03] 대상에 대한 자신의 의견과 그렇게 생각한 이유가 드러나게 글을 쓴다. | [4국04-03] 기본적인 문장의 짜임을 이해하고 적절하게 사용한다. | [4국05-03] 작품을 듣거나 읽고 마음에 드는 작품을 소개한다. | [4국06-03] 매체 소통 윤리를 고려하여 매체 자료를 활용하고 공유한다. |
| 3-4 | [4국01-04] 상황과 상대의 입장을 이해하고 예의를 지키며 대화한다. | [4국02-04] 글에 나타난 사실과 의견을 구분하고 필자와 자신의 의견을 비교한다. | [4국03-04] 목적과 주제를 고려하여 독자에게 마음을 전하는 글을 쓴다. | [4국04-04] 글과 담화에 쓰인 높임 표현과 지시⋅접속 표현을 이해하고 상황에 맞게 표현한다. | [4국05-04] 감각적 표현에 유의하여 작품을 감상하고, 감각적 표현을 활용하여 자신의 생각이나 감정을 표현한다. | |
| 3-4 | [4국01-05] 목적과 주제에 알맞게 자료를 정리하여 자신감 있게 발표한다. | [4국02-05] 글이나 자료의 출처가 믿을 만한지 판단한다. | [4국03-05] 자신의 쓰기 과정을 점검하며 쓰기에 자신감을 갖는다. | [4국04-05] 언어가 의사소통과 관계 형성의 수단임을 이해하고 국어를 소중히 여기는 태도를 지닌다. | [4국05-05] 재미나 감동을 느끼며 작품을 즐겨 감상하는 태도를 지닌다. | |
| 3-4 | [4국01-06] 주제에 적절한 의견과 이유를 제시하고 서로의 생각을 교환하며 토의한다. | [4국02-06] 바람직한 읽기 습관을 형성하고 읽기에 대한 자신감을 기른다. | | | | |
| 5-6 | [6국01-01] 대화에서 생략된 내용을 추론하며 듣는다. | [6국02-01] 글의 구조를 고려하며 주제나 주장을 파악하고 글 내용을 요약한다. | [6국03-01] 알맞은 내용을 선정하여 대상의 특성이 나타나게 설명하는 글을 쓴다. | [6국04-01] 음성 언어 및 문자 언어의 특성을 이해하고 다양한 매체 자료에서 표현 효과를 평가한다. | [6국05-01] 작가의 의도를 생각하며 작품을 읽는다. | [6국06-01] 정보 검색 도구를 활용하여 자신의 목적에 맞는 매체 자료를 찾는다. |
| 5-6 | [6국01-02] 주장을 파악하고 이유나 근거가 타당한지 평가하며 듣는다. | [6국02-02] 글에서 생략된 내용이나 함축된 표현을 문맥을 고려하여 추론한다. | [6국03-02] 적절한 근거를 사용하고 인용의 출처를 밝히며 주장하는 글을 쓴다. | [6국04-02] 표준어와 방언의 기능을 파악하고 언어 공동체와 국어생활과의 관계를 이해한다. | [6국05-02] 비유적 표현의 효과에 유의하여 작품을 감상한다. | [6국06-02] 뉴스 및 각종 정보 매체 자료의 신뢰성을 평가한다. |
| 5-6 | [6국01-03] 주제와 관련하여 궁금한 내용을 질문하며 적극적으로 듣고 말한다. | [6국02-03] 글이나 자료를 읽고 내용의 타당성과 표현의 적절성을 평가한다. | [6국03-03] 체험한 일에 대한 감상을 나타내는 글을 쓴다. | [6국04-03] 고유어와 관용 표현의 쓰임과 가치를 이해하고 상황에 맞게 표현한다. | [6국05-03] 소설이나 극을 읽고 인물, 사건, 배경을 파악한다. | [6국06-03] 적합한 양식과 수용자의 반응을 고려하여 복합양식 매체 자료를 제작하고 공유한다. |
| 5-6 | [6국01-04] 면담의 절차를 이해하고 상대와 매체를 고려하여 면담한다. | [6국02-04] 문제 상황과 관련된 다양한 관점의 글을 읽고 이를 문제 해결에 활용한다. | [6국03-04] 독자와 매체를 고려하여 내용을 생성하고 표현하며 글을 쓴다. | [6국04-04] 문장 성분을 이해하고 호응 관계가 올바른 문장을 구성한다. | [6국05-04] 인상적인 부분을 중심으로 작품에 대한 의견을 나눈다. | [6국06-04] 자신의 매체 이용 양상에 대해 성찰한다. |
| 5-6 | [6국01-05] 자료를 선별하여 핵심 정보를 중심으로 내용을 구성하고 매체를 활용하여 발표한다. | [6국02-05] 긍정적인 읽기 동기를 형성하고 적극적으로 읽기에 참여하는 태도를 기른다. | [6국03-05] 쓰기 과정을 점검⋅조정하며 글을 쓰고, 글 전체를 대상으로 통일성 있게 고쳐 쓴다. | [6국04-05] 글과 담화에 쓰인 시간 표현을 이해하고 상황에 맞게 표현한다. | [6국05-05] 자신의 경험을 시, 소설, 극, 수필 등 적절한 갈래로 표현한다. | |
| 5-6 | [6국01-06] 토의에 협력적으로 참여하며 서로의 의견을 비교하고 조정한다. | | [6국03-06] 쓰기에 적극적으로 참여하며 자신의 글을 독자와 공유하는 태도를 지닌다. | [6국04-06] 글과 담화에 쓰인 단어 및 문장, 띄어쓰기를 민감하게 살펴 바르게 고치는 태도를 지닌다. | [6국05-06] 작품을 읽고 자신의 삶과 연관 지어 성찰하는 태도를 지닌다. | |
| 5-6 | [6국01-07] 절차와 규칙을 지키고 타당한 이유와 근거를 제시하며 토론한다. | | | | | |
`,
                math: `| 학년(군) | 수와 연산 | 변화와 관계 | 도형과 측정 | 자료와 가능성 |
|---|---|---|---|---|
| 1-2 | [2수01-01] 수의 필요성을 인식하면서 0과 100까지의 수 개념을 이해하고, 수를 세고 읽고 쓸 수 있다. | [2수02-01] 물체, 무늬, 수 등의 배열에서 규칙을 찾아 여러 가지 방법으로 표현할 수 있다. | [2수03-01] 교실 및 생활 주변에서 여러 가지 물건을 관찰하여 직육면체, 원기둥, 구의 모양을 찾고, 이를 이용하여 여러 가지 모양을 만들 수 있다. | [2수04-01] 여러 가지 사물을 정해진 기준 또는 자신이 정한 기준으로 분류하여 개수를 세어 보고, 기준에 따른 결과를 말할 수 있다. |
| 1-2 | [2수01-02] 일, 십, 백, 천의 자릿값과 위치적 기수법을 이해하고, 네 자리 이하의 수를 읽고 쓸 수 있다. | [2수02-02] 자신이 정한 규칙에 따라 물체, 무늬, 수 등을 배열할 수 있다. | [2수03-02] 쌓기나무를 이용하여 여러 가지 입체도형의 모양을 만들고, 그 모양에 대해 위치나 방향을 이용하여 말할 수 있다. | [2수04-02] 자료를 분류하여 표로 나타내고, 자료를 표로 나타내면 편리한 점을 말할 수 있다. |
| 1-2 | [2수01-03] 네 자리 이하의 수의 범위에서 수의 계열을 이해하고, 수의 크기를 비교할 수 있다. | | [2수03-03] 교실 및 생활 주변에서 여러 가지 물건을 관찰하여 삼각형, 사각형, 원의 모양을 찾고, 이를 이용하여 여러 가지 모양을 만들 수 있다. | [2수04-03] 자료를 분류하여 ○, ×, / 등을 이용한 그래프로 나타내고, 자료를 그래프로 나타내면 편리한 점을 말할 수 있다. |
| 1-2 | [2수01-04] 하나의 수를 두 수로 분해하고 두 수를 하나의 수로 합성하는 활동을 통하여 수 감각을 기른다. | | [2수03-04] 삼각형, 사각형, 원을 직관적으로 이해하고, 그 모양을 그릴 수 있다. | |
| 1-2 | [2수01-05] 덧셈과 뺄셈이 이루어지는 실생활 상황과 연결하여 덧셈과 뺄셈의 의미를 이해한다. | | [2수03-05] 삼각형, 사각형에서 각각의 공통점을 찾아 말할 수 있다. | |
| 1-2 | [2수01-06] 두 자리 수의 범위에서 덧셈과 뺄셈의 계산 원리를 이해하고 그 계산을 할 수 있다. | | [2수03-06] 구체물의 길이, 들이, 무게, 넓이를 비교하여 각각 ‘길다, 짧다’, ‘많다, 적다’, ‘무겁다, 가볍다’, ‘넓다, 좁다’ 등을 구별하여 말할 수 있다. | |
| 1-2 | [2수01-07] 덧셈과 뺄셈의 관계를 이해한다. | | [2수03-07] 시계를 보고 시각을 ‘몇 시 몇 분’까지 읽을 수 있다. | |
| 1-2 | [2수01-08] 두 자리 수의 범위에서 세 수의 덧셈과 뺄셈을 할 수 있다. | | [2수03-08] 1시간과 1분의 관계를 이해하고, 시간을 ‘시간’, ‘분’으로 표현할 수 있다. | |
| 1-2 | [2수01-09] □가 사용된 덧셈식과 뺄셈식을 만들고, □의 값을 구할 수 있다. | | [2수03-09] 실생활 문제 상황과 연결하여 1분, 1시간, 1일, 1주일, 1개월, 1년 사이의 관계를 이해한다. | |
| 1-2 | [2수01-10] 곱셈이 이루어지는 실생활 상황과 연결하여 곱셈의 의미를 이해한다. | | [2수03-10] 길이 단위 1cm를 알고, 이를 이용하여 주변 사물의 길이를 측정할 수 있다. | |
| 1-2 | [2수01-11] 곱셈구구를 이해하고, 한 자리 수의 곱셈을 할 수 있다. | | [2수03-11] 1m와 cm의 관계를 이해하고, 길이를 ‘몇 m와 ‘몇 cm’로 표현할 수 있다. | |
| 1-2 | | | [2수03-12] 여러 가지 물건의 길이를 어림하고, 길이에 대한 감각을 기른다. | |
| 1-2 | | | [2수03-13] 실생활 문제 상황과 연결하여 길이의 덧셈과 뺄셈을 할 수 있다. | |
| 3-4 | [4수01-01] 큰 수의 필요성을 인식하면서 10000 이상의 큰 수에 대한 자릿값과 위치적 기수법을 이해하고, 수를 읽고 쓸 수 있다. | [4수02-01] 다양한 변화 규칙을 찾아 설명하고, 그 규칙을 수나 식으로 나타낼 수 있다. | [4수03-01] 직선, 선분, 반직선을 이해하고 구별할 수 있다. | [4수04-01] 자료를 수집하여 그림그래프나 막대그래프로 나타내고 해석할 수 있다. |
| 3-4 | [4수01-02] 다섯 자리 이상의 수의 범위에서 수의 계열을 이해하고, 수의 크기를 비교하며 그 방법을 설명할 수 있다. | [4수02-02] 계산식의 배열에서 규칙을 찾고, 계산 결과를 추측할 수 있다. | [4수03-02] 각과 직각을 이해하고, 직각과 비교하는 활동을 통하여 예각과 둔각을 구별할 수 있다. | [4수04-02] 자료를 수집하여 꺾은선그래프로 나타내고 해석할 수 있다. |
| 3-4 | [4수01-03] 세 자리 수의 덧셈과 뺄셈의 계산 원리를 이해하고 그 계산을 할 수 있다. | [4수02-03] 등호를 사용하여 크기가 같은 두 양의 관계를 식으로 나타낼 수 있다. | [4수03-03] 직선의 수직 관계와 평행 관계를 이해한다. | [4수04-03] 탐구 문제를 해결하기 위해 자료를 수집, 정리하여 막대그래프나 꺾은선그래프로 나타내고 해석할 수 있다. |
| 3-4 | [4수01-04] 곱하는 수가 한 자리 수 또는 두 자리 수인 곱셈의 계산 원리를 이해하고 그 계산을 할 수 있다. | | [4수03-04] 구체물이나 평면도형의 밀기, 뒤집기, 돌리기 활동을 통하여 그 변화를 이해한다. | |
| 3-4 | [4수01-05] 나눗셈이 이루어지는 실생활 상황과 연결하여 나눗셈의 의미를 알고, 곱셈과 나눗셈의 관계를 이해한다. | | [4수03-05] 평면에서 점의 이동에 대해 위치와 방향을 이용하여 설명할 수 있다. | |
| 3-4 | [4수01-06] 나누는 수가 한 자리 수인 나눗셈의 계산 원리를 이해하고 그 계산을 할 수 있으며, 나눗셈에서 몫과 나머지의 의미를 안다. | | [4수03-06] 원의 중심, 반지름, 지름을 이해하고, 그 성질을 안다. | |
| 3-4 | [4수01-07] 나누는 수가 두 자리 수인 나눗셈의 계산 원리를 이해하고 그 계산을 할 수 있다. | | [4수03-07] 컴퍼스를 이용하여 여러 가지 크기의 원을 그릴 수 있다. | |
| 3-4 | [4수01-08] 자연수의 덧셈, 뺄셈, 곱셈, 나눗셈과 관련한 여러 가지 상황에서 어림셈을 할 수 있다. | | [4수03-08] 여러 가지 모양의 삼각형에 대한 분류 활동을 통하여 이등변삼각형, 정삼각형을 이해하고, 그 성질을 탐구하고 설명할 수 있다. | |
| 3-4 | [4수01-09] 양의 등분할을 통하여 분수의 필요성을 인식하고, 분수를 이해하고 읽고 쓸 수 있다. | | [4수03-09] 여러 가지 모양의 삼각형에 대한 분류 활동을 통하여 직각삼각형, 예각삼각형, 둔각삼각형을 이해한다. | |
| 3-4 | [4수01-10] 단위분수, 진분수, 가분수, 대분수를 알고, 그 관계를 이해한다. | | [4수03-10] 여러 가지 모양의 사각형에 대한 분류 활동을 통하여 직사각형, 정사각형, 사다리꼴, 평행사변형, 마름모를 이해하고, 그 성질을 탐구하고 설명할 수 있다. | |
| 3-4 | [4수01-11] 분모가 같은 분수끼리, 단위분수끼리 크기를 비교하고 그 방법을 설명할 수 있다. | | [4수03-11] 다각형과 정다각형을 이해한다. | |
| 3-4 | [4수01-12] 분모가 10인 진분수와 연결하여 소수 한 자리 수를 이해하고 읽고 쓸 수 있다. | | [4수03-12] 주어진 도형을 이용하여 여러 가지 모양을 만들거나 채우고 설명할 수 있다. | |
| 3-4 | [4수01-13] 자릿값의 원리를 바탕으로 소수 두 자리 수와 소수 세 자리 수를 이해하고 읽고 쓸 수 있다. | | [4수03-13] 1분과 1초의 관계를 이해하고, 초 단위까지 시각을 읽을 수 있다. | |
| 3-4 | [4수01-14] 소수의 크기를 비교하고 그 방법을 설명할 수 있다. | | [4수03-14] 실생활 문제 상황과 연결하여 초 단위까지의 시간의 덧셈과 뺄셈을 할 수 있다. | |
| 3-4 | [4수01-15] 분모가 같은 분수의 덧셈과 뺄셈의 계산 원리를 이해하고 그 계산을 할 수 있다. | | [4수03-15] 길이 단위 1mm와 1km를 알고, 이를 이용하여 길이를 측정하고 어림하며 수학의 유용성을 인식할 수 있다. | |
| 3-4 | [4수01-16] 소수 두 자리 수의 범위에서 소수의 덧셈과 뺄셈의 계산 원리를 이해하고 그 계산을 할 수 있다. | | [4수03-16] 1cm와 1mm, 1km와 1m의 관계를 이해하고, 길이를 ‘몇 cm 몇 mm’와 ‘몇 mm’, ‘몇 km 몇 m’와 ‘몇 m’로 다양하게 표현할 수 있다. | |
| 3-4 | | | [4수03-17] 들이 단위 1L와 1mL를 알고, 이를 이용하여 들이를 측정하고 어림하며 수학의 유용성을 인식할 수 있다. | |
| 3-4 | | | [4수03-18] 1L와 1mL의 관계를 이해하고, 들이를 ‘몇 L 몇 mL’와 ‘몇 mL’로 표현할 수 있다. | |
| 3-4 | | | [4수03-19] 실생활 문제 상황과 연결하여 들이의 덧셈과 뺄셈을 할 수 있다. | |
| 3-4 | | | [4수03-20] 실생활에서 무게를 나타낼 때 사용하는 단위 1g과 1kg을 알고, 이를 이용하여 무게를 측정하고 어림하며 수학의 유용성을 인식할 수 있다. | |
| 3-4 | | | [4수03-21] 1kg과 1g의 관계를 이해하고, 무게를 ‘몇 kg 몇 g’과 ‘몇 g’으로 표현할 수 있다. | |
| 3-4 | | | [4수03-22] 실생활에서 무게를 나타낼 때 사용하는 단위 1t을 알고, 1t과 1kg의 관계를 이해한다. | |
| 3-4 | | | [4수03-23] 실생활 문제 상황과 연결하여 무게의 덧셈과 뺄셈을 할 수 있다. | |
| 3-4 | | | [4수03-24] 각의 크기의 단위인 1도(°)를 알고, 각도기를 이용하여 각의 크기를 측정하고 어림할 수 있다. | |
| 3-4 | | | [4수03-25] 여러 가지 방법으로 삼각형과 사각형의 내각의 크기의 합을 추론하고, 자신의 추론 과정을 설명할 수 있다. | |
| 5-6 | [6수01-01] 덧셈, 뺄셈, 곱셈, 나눗셈의 혼합 계산에서 계산하는 순서를 알고, 혼합 계산을 할 수 있다. | [6수02-01] 한 양이 변할 때 다른 양이 그에 종속하여 변하는 대응 관계를 나타낸 표에서 규칙을 찾아 설명하고, □, △ 등을 사용하여 식으로 나타낼 수 있다. | [6수03-01] 도형의 합동을 이해하고, 합동인 도형의 성질을 탐구하고 설명할 수 있다. | [6수04-01] 평균의 의미를 알고, 자료를 수집하여 평균을 구하고 해석할 수 있다. |
| 5-6 | [6수01-02] 실생활과 연결하여 이상, 이하, 초과, 미만의 의미와 쓰임을 알고, 이를 활용하여 수의 범위를 나타낼 수 있다. | [6수02-02] 두 양의 크기를 비교하는 상황을 통해 비의 개념을 이해하고, 두 양의 관계를 비로 나타낼 수 있다. | [6수03-02] 실생활과 연결하여 선대칭도형과 점대칭도형을 이해하고 그릴 수 있다. | [6수04-02] 자료를 수집하여 띠그래프나 원그래프로 나타내고 해석할 수 있다. |
| 5-6 | [6수01-03] 어림값을 구하기 위한 방법으로 올림, 버림, 반올림의 의미와 필요성을 알고, 이를 실생활에 활용함으로써 수학의 유용성을 인식할 수 있다. | [6수02-03] 비율을 이해하고, 비율을 분수, 소수, 백분율로 나타낼 수 있다. | [6수03-03] 직육면체와 정육면체를 이해하고, 구성 요소와 성질을 탐구하고 설명할 수 있다. | [6수04-03] 탐구 문제를 설정하고, 그에 맞는 자료를 수집, 정리하여 적절한 그래프로 나타내고 해석할 수 있다. |
| 5-6 | [6수01-04] 약수, 공약수, 최대공약수를 이해하고 구할 수 있다. | [6수02-04] 비례식을 알고, 그 성질을 이해하며, 이를 활용하여 간단한 비례식을 풀 수 있다. | [6수03-04] 직육면체와 정육면체의 겨냥도와 전개도를 그릴 수 있다. | [6수04-04] 사건이 일어날 가능성을 말로 표현하고 비교할 수 있다. |
| 5-6 | [6수01-05] 배수, 공배수, 최소공배수를 이해하고 구할 수 있다. | [6수02-05] 비례배분을 알고, 주어진 양을 비례배분 할 수 있다. | [6수03-05] 각기둥과 각뿔을 이해하고, 구성 요소와 성질을 탐구하고 설명할 수 있다. | [6수04-05] 사건이 일어날 가능성을 수로 나타낼 수 있다. |
| 5-6 | [6수01-06] 크기가 같은 분수를 만드는 방법을 이해하고, 분수를 약분, 통분할 수 있다. | | [6수03-06] 각기둥의 전개도를 그릴 수 있다. | [6수04-06] 자료를 이용하여 가능성을 예상하고, 가능성에 근거하여 적절한 판단을 내릴 수 있다. |
| 5-6 | [6수01-07] 분모가 다른 분수의 크기를 비교하고 그 방법을 설명할 수 있다. | | [6수03-07] 원기둥, 원뿔, 구를 이해하고, 구성 요소와 성질을 탐구하고 설명할 수 있다. | |
| 5-6 | [6수01-08] 분모가 다른 분수의 덧셈과 뺄셈의 계산 원리를 탐구하고 그 계산을 할 수 있다. | | [6수03-08] 원기둥의 전개도를 그릴 수 있다. | |
| 5-6 | [6수01-09] 분수의 곱셈의 계산 원리를 탐구하고 그 계산을 할 수 있다. | | [6수03-09] 쌓기나무로 만든 입체도형을 보고 사용된 쌓기나무의 개수를 구할 수 있다. | |
| 5-6 | [6수01-10] ‘(자연수) ÷ (자연수)’에서 나눗셈의 몫을 분수로 나타낼 수 있다. | | [6수03-10] 쌓기나무로 만든 입체도형의 위, 앞, 옆에서 본 모양을 표현할 수 있고, 이러한 표현을 보고 입체도형의 모양을 추측할 수 있다. | |
| 5-6 | [6수01-11] 분수의 나눗셈의 계산 원리를 탐구하고 그 계산을 할 수 있다. | | [6수03-11] 평면도형의 둘레를 이해하고, 기본적인 평면도형의 둘레를 구할 수 있다. | |
| 5-6 | [6수01-12] 분수와 소수의 관계를 이해하고 크기를 비교하며 그 방법을 설명할 수 있다. | | [6수03-12] 넓이 단위 1cm², 1m², 1km²를 알며, 그 관계를 이해한다. | |
| 5-6 | [6수01-13] 소수의 곱셈의 계산 원리를 탐구하고 그 계산을 할 수 있다. | | [6수03-13] 직사각형과 정사각형의 넓이를 구하는 방법을 이해하고, 이를 구할 수 있다. | |
| 5-6 | [6수01-14] ‘(자연수) ÷ (자연수)’에서 나눗셈의 몫을 소수로 나타낼 수 있다. | | [6수03-14] 평행사변형, 삼각형, 사다리꼴, 마름모의 넓이를 구하는 방법을 다양하게 추론하고, 이와 관련된 문제를 해결할 수 있다. | |
| 5-6 | [6수01-15] 소수의 나눗셈의 계산 원리를 탐구하고 그 계산을 할 수 있다. | | [6수03-15] 여러 가지 원 모양 물체의 원주와 지름을 측정하는 활동을 통하여, 원주율이 일정한 값임을 알고 그 근삿값을 사용할 수 있다. | |
| 5-6 | | | [6수03-16] 원주와 원의 넓이를 구하는 방법을 이해하고, 이를 구할 수 있다. | |
| 5-6 | | | [6수03-17] 직육면체와 정육면체의 겉넓이를 구하는 방법을 이해하고, 이를 구할 수 있다. | |
| 5-6 | | | [6수03-18] 부피 단위 1cm³, 1m³를 알며, 그 관계를 이해한다. | |
| 5-6 | | | [6수03-19] 직육면체와 정육면체의 부피를 구하는 방법을 이해하고, 이를 구할 수 있다. | |
`
            }
        };

        function setActiveButton(container, value) {
            container.querySelectorAll('button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === value);
            });
        }

        function getActiveValue(container) {
            const active = container.querySelector('.active');
            return active ? active.dataset.value : null;
        }

        function markdownTableToHtml(md) {
            const lines = md.trim().split('\n');
            const headers = lines[0].split('|').slice(1, -1).map(s => s.trim());
            const rows = lines.slice(2).map(line => line.split('|').slice(1, -1).map(s => s.trim()));
            const firstColWidth = 20;
            const otherColWidth = headers.length > 1 ? (80 / (headers.length - 1)) : 80;
            const firstWidthStyle = `style="width: ${headers.length === 1 ? 100 : firstColWidth}%"`;
            const otherWidthStyle = headers.length > 1 ? `style="width: ${otherColWidth.toFixed(2)}%"` : '';
            let html = '<table data-markdown-table="true" class="min-w-full border border-gray-300 text-sm"><thead><tr>';
            headers.forEach((h, idx) => {
                const widthStyle = idx === 0 ? firstWidthStyle : otherWidthStyle;
                const widthAttr = widthStyle ? `${widthStyle} ` : '';
                const headerContent = h.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                html += `<th ${widthAttr}class="border px-2 py-1 bg-gray-100"><div class="flex items-center gap-1"><button type="button" class="markdown-table-remove-column" title="열 삭제" aria-label="열 삭제">×</button><span class="flex-1">${headerContent}</span></div></th>`;
            });
            html += '</tr></thead><tbody>';
            rows.forEach(row => {
                html += '<tr>';
                row.forEach((cell, cellIdx) => {
                    const widthStyle = cellIdx === 0 ? firstWidthStyle : otherWidthStyle;
                    const widthAttr = widthStyle ? `${widthStyle} ` : '';
                    html += `<td ${widthAttr}class="border px-2 py-1 align-top">${cell.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            return html;
        }

        function adjustMarkdownTableColumnWidths(table) {
            const rows = table ? Array.from(table.querySelectorAll('tr')) : [];
            if (!rows.length) return;
            const headerRow = table.querySelector('thead tr') || rows[0];
            const colCount = headerRow ? headerRow.children.length : 0;
            if (!colCount) return;
            const firstColWidth = colCount === 1 ? 100 : 20;
            const otherColWidth = colCount > 1 ? 80 / (colCount - 1) : 0;
            rows.forEach(row => {
                Array.from(row.children).forEach((cell, idx) => {
                    if (colCount === 1) {
                        cell.style.width = '100%';
                    } else if (idx === 0) {
                        cell.style.width = `${firstColWidth}%`;
                    } else {
                        cell.style.width = `${otherColWidth.toFixed(2)}%`;
                    }
                });
            });
        }

        document.addEventListener('click', (event) => {
            const button = event.target.closest('.markdown-table-remove-column');
            if (!button) return;
            const th = button.closest('th');
            if (!th) return;
            const table = th.closest('table');
            if (!table || table.dataset.markdownTable !== 'true') return;
            const row = th.parentElement;
            const colIndex = Array.from(row.children).indexOf(th);
            if (colIndex < 0) return;
            table.querySelectorAll('tr').forEach(rowElement => {
                const cell = rowElement.children[colIndex];
                if (cell) {
                    cell.remove();
                }
            });
            adjustMarkdownTableColumnWidths(table);
        });

        function setButtonState(btn, state) {
            btn.dataset.state = state;
            btn.classList.remove('bg-yellow-200', 'bg-green-200', 'bg-opacity-50');
            if (state === 1) {
                btn.classList.add('bg-yellow-200', 'bg-opacity-50');
            } else if (state === 2) {
                btn.classList.add('bg-green-200', 'bg-opacity-50');
            }
        }

        function makeAchievementTableInteractive() {
            const table = achievementTableContainer.querySelector('table');
            if (!table) return;
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(tr => {
                for (let i = 1; i < tr.cells.length; i++) {
                    const cell = tr.cells[i];
                    const text = cell.textContent;
                    cell.innerHTML = `<button type="button" class="w-full text-left px-1 py-0.5 rounded" data-state="0">${text}</button>`;
                    const btn = cell.querySelector('button');
                    btn.addEventListener('click', () => {
                        let state = parseInt(btn.dataset.state);
                        state = (state + 1) % 3;
                        setButtonState(btn, state);
                    });
                }
            });
        }

        function applyAchievementStates() {
            const key = `${getActiveValue(levelButtons)}_${getActiveValue(subjectButtons)}`;
            const stateRows = currentAchievementData[key];
            if (!stateRows) return;
            const rows = achievementTableContainer.querySelectorAll('tbody tr');
            rows.forEach((tr, rowIdx) => {
                for (let i = 1; i < tr.cells.length; i++) {
                    const btn = tr.cells[i].querySelector('button');
                    const state = stateRows[rowIdx]?.[i - 1] || 0;
                    setButtonState(btn, state);
                }
            });
        }

        function applyGradeFilter() {
            const grade = getActiveValue(gradeButtons);
            const rows = achievementTableContainer.querySelectorAll('tbody tr');
            rows.forEach(tr => {
                const rowGrade = tr.cells[0].textContent.trim();
                tr.style.display = (grade === 'all' || rowGrade === grade) ? '' : 'none';
            });
        }

        function updateGradeButtons() {
            const level = getActiveValue(levelButtons);
            let options = [];
            if (level === 'elementary') {
                options = [
                    { value: 'all', label: '전체' },
                    { value: '1-2', label: '1-2학년' },
                    { value: '3-4', label: '3-4학년' },
                    { value: '5-6', label: '5-6학년' },
                ];
            } else {
                options = [
                    { value: 'all', label: '전체' },
                    { value: '1', label: '1' },
                    { value: '2', label: '2' },
                    { value: '3', label: '3' },
                ];
            }
            gradeButtons.innerHTML = options.map(o => `<button data-value="${o.value}" class="tab-btn py-1 px-3 rounded">${o.label}</button>`).join('');
            gradeButtons.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => {
                    setActiveButton(gradeButtons, btn.dataset.value);
                    applyGradeFilter();
                });
            });
            setActiveButton(gradeButtons, 'all');
        }

        function loadAchievementTable() {
            const level = getActiveValue(levelButtons);
            const subject = getActiveValue(subjectButtons);
            const md = achievementTables[level]?.[subject];
            if (md) {
                achievementTableContainer.innerHTML = markdownTableToHtml(md);
                makeAchievementTableInteractive();
                applyAchievementStates();
                applyGradeFilter();
            } else {
                achievementTableContainer.innerHTML = '<p class="text-gray-500">준비 중입니다.</p>';
            }
        }

        async function openAchievementView(studentName) {
            const user = auth.currentUser;
            if (!user) return;
            currentAchievementStudent = studentName;
            const docRef = doc(db, 'users', user.uid, 'achievements', studentName);
            const snap = await getDoc(docRef);
            currentAchievementData = snap.exists() ? (snap.data().data || {}) : {};
            document.getElementById('achievement-student').textContent = `${studentName} 학생`;
            setActiveButton(levelButtons, 'elementary');
            setActiveButton(subjectButtons, 'korean');
            updateGradeButtons();
            loadAchievementTable();
            switchView('achievement').catch(console.error);
        }


        // --- IEP View Logic ---
        const iepStudentList = document.getElementById('iep-student-list');
        const iepOutputContainer = document.getElementById('iep-output');
        let currentIepStudent = '';
        let currentIepDocId = '';
        let isLoadingIepStudents = false;
        let lastKoreanList = [];
        let lastMathList = [];
        let currentIepSemester = 1;
        const lastSemesterGoals = {
            korean: [],
            math: []
        };
        const pageDescriptions = {
            'page-1': '1페이지(표지)',
            'page-2': '2페이지(성취 기준 - 국어)',
            'page-3': '3페이지(성취 기준 - 수학)',
            'page-4': '4페이지(학기별 교육 목표)',
            'page-5': '5페이지(월별 교육 목표 - 국어)',
            'page-6': '6페이지(월별 교육 목표 - 수학)',
            'page-7': '7페이지(월별 교육 목표 - 국어)',
            'page-8': '8페이지(월별 교육 목표 - 수학)',
            'page-9': '9페이지(월별 교육 목표 - 국어)',
            'page-10': '10페이지(월별 교육 목표 - 수학)',
            'page-11': '11페이지(월별 교육 목표 - 국어)',
            'page-12': '12페이지(월별 교육 목표 - 수학)',
            'page-13': '13페이지(월별 교육 목표 - 국어)',
            'page-14': '14페이지(월별 교육 목표 - 수학)',
            'page-15': '15페이지(학기 평가)',
            'all': '전체'
        };

        function setBasePageDescriptions() {
            pageDescriptions['page-1'] = '1페이지(표지)';
            pageDescriptions['page-2'] = '2페이지(성취 기준 - 국어)';
            pageDescriptions['page-3'] = '3페이지(성취 기준 - 수학)';
            pageDescriptions['page-4'] = '4페이지(학기별 교육 목표)';
            Object.keys(pageDescriptions).forEach(key => {
                const match = key.match(/^page-(\d+)$/);
                if (!match) return;
                if (Number(match[1]) >= 5) {
                    delete pageDescriptions[key];
                }
            });
        }

        const modifyInput = document.getElementById('iep-modify-input');
        const modifyBtn = document.getElementById('iep-modify-btn');
        const modifyTargetsContainer = document.getElementById('iep-modify-targets');
        const generationSection = document.getElementById('iep-generation-section');
        const saveSection = document.getElementById('iep-save-section');
        const manualEditBtn = document.getElementById('iep-manual-edit-btn');
        const achievementButton = document.getElementById('iep-achievement-btn');
        const generateSemesterBtn = document.getElementById('generate-semester-goals-btn');
        const generateMonthlyBtn = document.getElementById('generate-monthly-plan-btn');
        const saveIepButton = document.getElementById('save-iep-btn');
        const savePdfButton = document.getElementById('save-pdf-btn');
        let currentModifyTarget = 'page-1';
        let manualEditMode = false;
        let manualEditNode = null;

        function getModifyTargetEntries() {
            const entries = [
                { value: 'page-1', label: '표지' },
                { value: 'page-2', label: '성취기준-국어' },
                { value: 'page-3', label: '성취기준-수학' },
                { value: 'page-4', label: '학기 교육목표' }
            ];
            const contentRoot = document.getElementById('iep-content');
            if (contentRoot) {
                const months = getSemesterMonths(currentIepSemester);
                const monthlyPages = Array.from(contentRoot.querySelectorAll('.iep-page[data-month-index]'));
                monthlyPages.sort((a, b) => {
                    const aPage = Number(a.getAttribute('data-page')) || 0;
                    const bPage = Number(b.getAttribute('data-page')) || 0;
                    return aPage - bPage;
                });
                monthlyPages.forEach(page => {
                    const pageValue = page.getAttribute('data-page');
                    if (!pageValue) return;
                    const monthIdx = Number(page.getAttribute('data-month-index')) || 0;
                    const subjectKey = page.getAttribute('data-subject') || 'korean';
                    const subjectLabel = subjectKey === 'math' ? '수학' : '국어';
                    const monthLabel = months[monthIdx]?.actual || `${monthIdx + 1}월`;
                    entries.push({ value: `page-${pageValue}`, label: `월(${monthLabel})-${subjectLabel}` });
                });
                const evaluationPage = contentRoot.querySelector('.iep-page[data-semester-evaluation="true"]');
                if (evaluationPage) {
                    const evalPageValue = evaluationPage.getAttribute('data-page');
                    if (evalPageValue) {
                        entries.push({ value: `page-${evalPageValue}`, label: '학기 평가' });
                    }
                }
            }
            entries.push({ value: 'all', label: '전체' });
            const seen = new Set();
            return entries.filter(entry => {
                if (!entry.value || seen.has(entry.value)) return false;
                seen.add(entry.value);
                return true;
            });
        }

        function renderModifyTargetButtons() {
            if (!modifyTargetsContainer) return;
            const entries = getModifyTargetEntries();
            if (!entries.length) {
                modifyTargetsContainer.innerHTML = '';
                return;
            }
            if (!entries.some(entry => entry.value === currentModifyTarget)) {
                currentModifyTarget = entries[0].value;
            }
            modifyTargetsContainer.innerHTML = '';
            entries.forEach(entry => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'modify-target-btn';
                btn.dataset.target = entry.value;
                btn.textContent = entry.label;
                if (entry.value === currentModifyTarget) {
                    btn.classList.add('active');
                }
                btn.addEventListener('click', () => handleModifyTargetSelection(entry.value));
                modifyTargetsContainer.appendChild(btn);
            });
        }

        function updateModifyTargetActiveState() {
            if (!modifyTargetsContainer) return;
            modifyTargetsContainer.querySelectorAll('button').forEach(btn => {
                if (btn.dataset.target === currentModifyTarget) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function handleModifyTargetSelection(value) {
            if (manualEditMode) {
                alert('수동 편집을 완료한 후 다른 항목을 선택해 주세요.');
                return;
            }
            currentModifyTarget = value;
            updateModifyTargetActiveState();
        }

        function exitManualEditMode(skipSync = false) {
            if (!manualEditMode) return;
            if (manualEditNode) {
                manualEditNode.removeAttribute('contenteditable');
                manualEditNode.classList.remove('manual-editing');
            }
            manualEditMode = false;
            manualEditNode = null;
            if (manualEditBtn) manualEditBtn.textContent = '수동 편집';
            if (modifyBtn) modifyBtn.disabled = false;
            if (!skipSync) {
                normalizeIepPages(document.getElementById('iep-content'));
                updateMonthlyPageDisplays();
                extractSemesterGoalsFromDom();
            }
        }

        function startManualEdit() {
            if (manualEditMode) return;
            if (!currentModifyTarget) {
                alert('수정할 항목을 선택해 주세요.');
                return;
            }
            const contentRoot = document.getElementById('iep-content');
            if (!contentRoot) {
                alert('편집할 항목이 없습니다.');
                return;
            }
            let targetNode = null;
            if (currentModifyTarget === 'all') {
                targetNode = contentRoot;
            } else {
                targetNode = findIepPageNode(currentModifyTarget);
            }
            if (!targetNode) {
                alert('선택한 항목을 찾을 수 없습니다.');
                return;
            }
            const editableNode = currentModifyTarget === 'all'
                ? targetNode
                : (targetNode.querySelector('.iep-page-inner') || targetNode);
            manualEditMode = true;
            manualEditNode = editableNode;
            editableNode.setAttribute('contenteditable', 'true');
            editableNode.classList.add('manual-editing');
            if (modifyBtn) modifyBtn.disabled = true;
            if (manualEditBtn) manualEditBtn.textContent = '완료';
            setTimeout(() => {
                try {
                    editableNode.focus();
                } catch (err) {
                    console.warn('Unable to focus editable node', err);
                }
            }, 0);
        }

        manualEditBtn?.addEventListener('click', () => {
            if (manualEditMode) {
                exitManualEditMode();
            } else {
                startManualEdit();
            }
        });

        achievementButton?.addEventListener('click', () => {
            if (manualEditMode) {
                alert('수동 편집을 완료한 후 이동해 주세요.');
                return;
            }
            if (currentIepStudent) {
                openAchievementView(currentIepStudent);
            }
        });

        generateSemesterBtn?.addEventListener('click', async () => {
            if (manualEditMode) {
                alert('수동 편집을 완료한 후 생성 기능을 사용해 주세요.');
                return;
            }
            await generateSemesterGoals(lastKoreanList, lastMathList);
            generateMonthlyBtn?.classList.remove('hidden');
        });

        generateMonthlyBtn?.addEventListener('click', async () => {
            if (manualEditMode) {
                alert('수동 편집을 완료한 후 생성 기능을 사용해 주세요.');
                return;
            }
            await generateMonthlyPlans(lastKoreanList, lastMathList);
        });

        saveIepButton?.addEventListener('click', async () => {
            if (manualEditMode) {
                alert('수동 편집을 완료한 후 저장해 주세요.');
                return;
            }
            try {
                await handleIepSave();
            } catch (error) {
                console.error('IEP 저장 중 오류:', error);
                alert('IEP 저장 중 오류가 발생했습니다.');
            }
        });

        savePdfButton?.addEventListener('click', () => {
            if (manualEditMode) {
                alert('수동 편집을 완료한 후 PDF를 저장해 주세요.');
                return;
            }
            saveIepPdf().catch(err => console.error('PDF 저장 실패', err));
        });

        async function loadIepStudents() {
            const user = auth.currentUser;
            if (!user || isLoadingIepStudents) return;
            isLoadingIepStudents = true;
            iepStudentList.innerHTML = '<p class="text-gray-500">로딩 중...</p>';
            const classRef = doc(db, 'classes', user.uid);
            try {
                const classSnap = await getDoc(classRef);
                iepStudentList.innerHTML = '';
                if (!classSnap.exists()) {
                    iepStudentList.innerHTML = '<p class="text-gray-500">생성된 학급이 없습니다.</p>';
                    return;
                }
                const studentIds = classSnap.data().students || [];
                if (studentIds.length === 0) {
                    iepStudentList.innerHTML = '<p class="text-gray-500">학생이 없습니다.</p>';
                } else {
                    for (const sid of studentIds) {
                        try {
                            const sd = await getDoc(doc(db, 'users', sid));
                            if (sd.exists()) {
                                const s = sd.data();
                                const studentEl = document.createElement('div');
                                studentEl.className = 'p-3 border rounded-md cursor-pointer hover:bg-sky-50';
                                studentEl.textContent = s.name || sid;
                                studentEl.addEventListener('click', () => showIepList(s.name || sid));
                                iepStudentList.appendChild(studentEl);
                            }
                        } catch (err) {
                            console.error(err);
                        }
                    }
                }
            } catch (error) {
                iepStudentList.innerHTML = '<p class="text-red-500">학급 정보를 불러오지 못했습니다.</p>';
            } finally {
                isLoadingIepStudents = false;
            }
        }

        function showModifySection() {
            const section = document.getElementById('iep-modify-section');
            section?.classList.remove('hidden');
            saveSection?.classList.remove('hidden');
            generationSection?.classList.remove('hidden');
            renderModifyTargetButtons();
            updateModifyTargetActiveState();
        }

        function hideModifySection() {
            const section = document.getElementById('iep-modify-section');
            section?.classList.add('hidden');
            saveSection?.classList.add('hidden');
            generationSection?.classList.add('hidden');
            generateMonthlyBtn?.classList.add('hidden');
            exitManualEditMode(true);
            currentModifyTarget = 'page-1';
            if (modifyTargetsContainer) {
                modifyTargetsContainer.innerHTML = '';
            }
        }

        async function showIepList(studentName) {
            currentIepStudent = studentName;
            currentIepDocId = '';
            hideModifySection();
            iepOutputContainer.innerHTML = '<p class="text-gray-500">로딩 중...</p>';
            const user = auth.currentUser;
            if (!user) return;
            const iepRef = collection(db, 'users', user.uid, 'ieps');
            const q = query(iepRef, where('student', '==', studentName), orderBy('createdAt', 'desc'));
            const snap = await getDocs(q);
            let html = `<div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">${studentName} IEP 목록</h3><button id="add-iep-btn" class="bg-sky-600 hover:bg-sky-700 text-white text-sm px-3 py-1 rounded">+추가</button></div>`;
            if (snap.empty) {
                html += '<p class="text-gray-500">IEP가 없습니다.</p>';
            } else {
                html += '<ul class="space-y-2">';
                snap.forEach(doc => {
                    const d = doc.data();
                    const date = d.createdAt?.toDate ? d.createdAt.toDate().toLocaleDateString() : '';
                    html += `<li class="p-2 border rounded flex justify-between items-center hover:bg-sky-50 cursor-pointer" data-id="${doc.id}">
                                <div class="flex flex-col flex-grow">
                                    <span class="iep-title">${d.title}</span>
                                    <span class="text-xs text-gray-500">${date}</span>
                                </div>
                                <div class="flex-shrink-0 space-x-1 ml-2">
                                    <button class="iep-rename-btn text-xs text-sky-600">이름 편집</button>
                                    <button class="iep-copy-btn text-xs text-green-600">복사</button>
                                    <button class="iep-delete-btn text-xs text-red-600">삭제</button>
                                </div>
                              </li>`;
                });
                html += '</ul>';
            }
            iepOutputContainer.innerHTML = html;
            pageDescriptions['page-1'] = '1페이지(표지)';
            pageDescriptions['page-2'] = '2페이지(성취 기준 - 국어)';
            pageDescriptions['page-3'] = '3페이지(성취 기준 - 수학)';
            pageDescriptions['page-4'] = '4페이지(학기별 교육 목표)';
            document.getElementById('add-iep-btn').addEventListener('click', () => addIep(studentName));
            iepOutputContainer.querySelectorAll('li[data-id]').forEach(el => {
                el.addEventListener('click', (e) => {
                    if (e.target.closest('button')) return;
                    openIepDocument(el.dataset.id, studentName);
                });
            });
            iepOutputContainer.querySelectorAll('.iep-delete-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    const id = btn.closest('li').dataset.id;
                    deleteIep(id, studentName);
                });
            });
            iepOutputContainer.querySelectorAll('.iep-rename-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    const li = btn.closest('li');
                    const id = li.dataset.id;
                    const title = li.querySelector('.iep-title').textContent;
                    renameIep(id, studentName, title);
                });
            });
            iepOutputContainer.querySelectorAll('.iep-copy-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    const id = btn.closest('li').dataset.id;
                    copyIep(id, studentName);
                });
            });
        }

        async function addIep(studentName) {
            const user = auth.currentUser;
            if (!user) return;
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const semester = (month >= 8 || month <= 1) ? 2 : 1;
            const title = `${year}학년도 ${semester}학기 개별화교육계획(${studentName})`;
            const docRef = await addDoc(collection(db, 'users', user.uid, 'ieps'), {
                student: studentName,
                title,
                createdAt: serverTimestamp(),
                content: ''
            });
            showIepList(studentName);
            openIepDocument(docRef.id, studentName);
        }

        async function deleteIep(id, studentName) {
            const user = auth.currentUser;
            if (!user) return;
            if (!confirm('삭제하시겠습니까?')) return;
            await deleteDoc(doc(db, 'users', user.uid, 'ieps', id));
            showIepList(studentName);
            showToast('삭제되었습니다');
        }

        async function renameIep(id, studentName, oldTitle) {
            const user = auth.currentUser;
            if (!user) return;
            const newTitle = prompt('새 이름을 입력하세요', oldTitle);
            if (!newTitle || !newTitle.trim()) return;
            await updateDoc(doc(db, 'users', user.uid, 'ieps', id), { title: newTitle.trim() });
            showIepList(studentName);
            showToast('이름이 변경되었습니다');
        }

        async function copyIep(id, studentName) {
            const user = auth.currentUser;
            if (!user) return;
            const docRef = doc(db, 'users', user.uid, 'ieps', id);
            const snap = await getDoc(docRef);
            if (!snap.exists()) return;
            const data = snap.data();
            const baseTitle = data.title;
            const iepRef = collection(db, 'users', user.uid, 'ieps');
            const q = query(iepRef, where('student', '==', studentName));
            const all = await getDocs(q);
            let maxCopy = 0;
            all.forEach(d => {
                const match = d.data().title.match(new RegExp(`^${baseTitle} - 복사본\\((\\d+)\\)$`));
                if (match) {
                    const num = parseInt(match[1]);
                    if (num > maxCopy) maxCopy = num;
                }
            });
            const newTitle = `${baseTitle} - 복사본(${maxCopy + 1})`;
            const newDoc = await addDoc(iepRef, {
                student: studentName,
                title: newTitle,
                createdAt: serverTimestamp(),
                content: data.content || ''
            });
            showIepList(studentName);
            openIepDocument(newDoc.id, studentName);
            showToast('복사되었습니다!');
        }

        async function openIepDocument(id, studentName) {
            const user = auth.currentUser;
            if (!user) return;
            currentIepDocId = id;
            const docRef = doc(db, 'users', user.uid, 'ieps', id);
            let snap = await getDoc(docRef);
            let data = snap.data();
            if (!data.content) {
                const content = await buildIepContent(studentName);
                await updateDoc(docRef, { content });
                snap = await getDoc(docRef);
                data = snap.data();
            }
            renderIepContent(id, studentName, data);
        }

        function renderIepContent(id, studentName, data) {
            showModifySection();
            currentIepSemester = determineSemesterFromData(data);
            lastSemesterGoals.korean = [];
            lastSemesterGoals.math = [];
            const titleMd = `| **${data.title}** |\n| --- |`;
            let titleHtml = markdownTableToHtml(titleMd)
                .replace('class="min-w-full border border-gray-300 text-sm"', 'class="mx-auto w-auto border border-gray-300 text-xl"')
                .replace('<th class="border px-2 py-1 bg-gray-100">', '<th class="border px-4 py-2 bg-gray-100 text-center text-2xl">');
            const tempWrapper = document.createElement('div');
            tempWrapper.innerHTML = data.content || '';
            tempWrapper.querySelectorAll('.iep-page[data-page="1"]').forEach(node => node.remove());
            upgradeLegacyIepStructure(tempWrapper);
            const storedPagesHtml = tempWrapper.innerHTML;
            const user = auth.currentUser;
            let teacherName = (user?.displayName || '').trim();
            if (!teacherName && user?.email) {
                teacherName = user.email.split('@')[0];
            }
            if (!teacherName) {
                teacherName = '미기재';
            }
            const html = `
                <div class="iep-pages-wrapper">
                    <div class="iep-cover-actions" id="iep-cover-actions">
                        <button id="edit-iep-title" class="text-sm text-sky-600">편집</button>
                    </div>
                    <div id="iep-content" class="iep-page-collection">
                        <section class="iep-page iep-page-cover" data-page="1">
                            <div id="iep-title">${titleHtml}</div>
                            <div class="iep-cover-footer">특수교사: <span id="iep-teacher-name">${teacherName}</span></div>
                        </section>
                        ${storedPagesHtml}
                    </div>
                </div>`;
            iepOutputContainer.innerHTML = html;
            normalizeIepPages(document.getElementById('iep-content'));
            const teacherNameNode = document.getElementById('iep-teacher-name');
            if (teacherNameNode) {
                teacherNameNode.textContent = teacherName;
            }
            const months = getSemesterMonths(currentIepSemester);
            setBasePageDescriptions();
            updateMonthlyPageDisplays(months);
            extractSemesterGoalsFromDom();
            const monthlyBtn = document.getElementById('generate-monthly-plan-btn');
            if (monthlyBtn) {
                if (lastSemesterGoals.korean.length || lastSemesterGoals.math.length) {
                    monthlyBtn.classList.remove('hidden');
                } else {
                    monthlyBtn.classList.add('hidden');
                }
            }
            currentModifyTarget = 'page-1';
            updateModifyTargetActiveState();
            const editBtn = document.getElementById('edit-iep-title');
            editBtn.addEventListener('click', () => {
                const container = document.getElementById('iep-title');
                if (editBtn.textContent === '편집') {
                    const current = container.textContent.trim();
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = current;
                    input.className = 'border rounded p-1 text-sm';
                    container.innerHTML = '';
                    container.appendChild(input);
                    editBtn.textContent = '완료';
                    input.focus();
                    input.addEventListener('keydown', e => { if (e.key === 'Enter') editBtn.click(); });
                } else {
                    const input = container.querySelector('input');
                    const value = input.value.trim() || data.title;
                    const md = `| **${value}** |\n| --- |`;
                    container.innerHTML = markdownTableToHtml(md)
                        .replace('class="min-w-full border border-gray-300 text-sm"', 'class="mx-auto w-auto border border-gray-300 text-xl"')
                        .replace('<th class="border px-2 py-1 bg-gray-100">', '<th class="border px-4 py-2 bg-gray-100 text-center text-2xl">');
                    editBtn.textContent = '편집';
                }
            });
        }

        async function handleIepSave() {
            const docId = currentIepDocId;
            const studentName = currentIepStudent;
            if (!docId || !studentName) {
                alert('저장할 IEP가 없습니다.');
                return;
            }
            const user = auth.currentUser;
            if (!user) return;
            const titleNode = document.getElementById('iep-title');
            const contentNode = document.getElementById('iep-content');
            if (!titleNode || !contentNode) {
                alert('저장할 내용이 없습니다.');
                return;
            }
            const docRef = doc(db, 'users', user.uid, 'ieps', docId);
            const title = titleNode.textContent.trim();
            const contentClone = contentNode.cloneNode(true);
            const coverPage = contentClone.querySelector('.iep-page-cover');
            if (coverPage) {
                coverPage.parentNode.removeChild(coverPage);
            }
            const content = contentClone.innerHTML;
            await updateDoc(docRef, { title, content });
            showIepList(studentName);
            openIepDocument(docId, studentName);
            alert('저장되었습니다.');
        }

        async function saveIepPdf() {
            const contentNode = document.getElementById('iep-content');
            if (!contentNode) {
                console.error('IEP 콘텐츠 노드를 찾을 수 없습니다.');
                return;
            }

            // --- UI 요소 준비 ---
            const saveBtn = document.getElementById('save-pdf-btn');
            const actionsContainer = document.getElementById('iep-cover-actions');
            const originalBtnText = saveBtn?.textContent;
            const titleText = document.getElementById('iep-title')?.textContent.trim() || '개별화교육계획';
            const filename = `${sanitizeFileName(titleText)}.pdf`;
            const pages = contentNode.querySelectorAll('.iep-page');

            // --- PDF 생성 전 처리 ---
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.textContent = '저장 중...';
            }
            // 버튼 숨기기 및 그림자 제거 (PDF에 불필요한 요소 제거)
            if (actionsContainer) actionsContainer.style.display = 'none';
            pages.forEach(page => (page.style.boxShadow = 'none'));

            // --- html2pdf 옵션 설정 ---
            const opt = {
                margin: 0,
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, scrollY: -window.scrollY },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // --- PDF 생성 및 저장 ---
            try {
                await html2pdf().from(contentNode).set(opt).save();
                showToast('PDF 저장이 완료되었습니다.');
            } catch (error) {
                console.error('PDF 저장 중 오류:', error);
                showToast('PDF 저장 중 오류가 발생했습니다.');
            } finally {
                // --- PDF 생성 후 처리 (숨겼던 요소 복원) ---
                if (actionsContainer) actionsContainer.style.display = 'flex';
                pages.forEach(page => (page.style.boxShadow = '')); // 원래 스타일로 복원

                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalBtnText;
                }
            }
        }

        async function applyModification() {
            const instruction = modifyInput.value.trim();
            if (manualEditMode) {
                alert('수동 편집을 완료한 후 수정 기능을 사용해 주세요.');
                return;
            }
            const target = currentModifyTarget;
            const contentRoot = document.getElementById('iep-content');
            if (!instruction || !currentIepDocId || !contentRoot || !target) return;

            modifyInput.value = '';
            const button = modifyBtn;
            const originalBtnText = button?.textContent;
            if (button) {
                button.disabled = true;
                button.textContent = '수정 중...';
            }

            try {
                if (target === 'all') {
                    const currentContent = contentRoot.innerHTML;
                    const prompt = `다음 개별화교육계획 HTML 전체를 사용자의 수정 요구에 맞게 수정해줘. 전체 구조와 클래스, data-* 속성, 표 구조는 유지하고 다른 페이지가 삭제되거나 순서가 바뀌지 않도록 해줘.\n\n원본:\n${currentContent}\n\n수정 요구:${instruction}`;
                    let result = await callGemini(prompt);
                    const sanitized = sanitizeAiHtmlResponse(result, currentContent);
                    if (sanitized) {
                        contentRoot.innerHTML = sanitized;
                        normalizeIepPages(contentRoot);
                    }
                    updateMonthlyPageDisplays();
                    extractSemesterGoalsFromDom();
                    return;
                }

                const pageNode = findIepPageNode(target);
                if (!pageNode) {
                    alert('선택한 페이지를 찾을 수 없습니다.');
                    return;
                }
                const targetText = pageDescriptions[target] || '선택한 영역';
                const originalOuter = pageNode.outerHTML;
                const prompt = `다음 HTML은 개별화교육계획의 '${targetText}' 영역이야. HTML 구조(태그, 클래스, data-* 속성, id)를 유지하면서 사용자 요구에 맞게 필요한 부분만 수정해줘. 다른 페이지 내용은 포함하지 마.\n\n원본:\n${originalOuter}\n\n수정 요구:${instruction}\n\n응답에는 수정된 HTML만 포함해줘.`;
                let result = await callGemini(prompt);
                const sanitized = sanitizeAiHtmlResponse(result, originalOuter);
                if (!sanitized) {
                    return;
                }
                replaceIepPageWithHtml(pageNode, sanitized);
                updateMonthlyPageDisplays();
                extractSemesterGoalsFromDom();
            } catch (error) {
                console.error('수정 적용 중 오류', error);
                alert('수정 내용을 적용하지 못했습니다. 다시 시도해 주세요.');
            } finally {
                if (button) {
                    button.disabled = false;
                    button.textContent = originalBtnText || '수정';
                }
            }
        }

        function sanitizeAiHtmlResponse(response, fallback) {
            if (typeof response !== 'string') return fallback;
            let text = response.trim();
            text = text.replace(/^```(?:html)?\s*/i, '');
            text = text.replace(/```$/i, '');
            text = text.trim();
            if (!text) return fallback;
            const lines = text.split(/\n+/)
                .map(line => line.trim())
                .filter(line => line && !line.includes('다음은') && !line.includes('수정했습니다') && !line.includes('수정되었습니다'));
            text = lines.join('\n').trim();
            return text || fallback;
        }

        function normalizeIepPages(root) {
            if (!root) return;
            Array.from(root.children).forEach(page => {
                if (!(page instanceof HTMLElement)) return;
                page.classList.add('iep-page');
                if (!page.classList.contains('iep-page-cover') && !page.querySelector('.iep-page-inner')) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'iep-page-inner';
                    while (page.firstChild) {
                        wrapper.appendChild(page.firstChild);
                    }
                    page.appendChild(wrapper);
                }
            });
        }

        function findIepPageNode(target) {
            if (!target || target === 'all') return null;
            const contentRoot = document.getElementById('iep-content');
            if (!contentRoot) return null;
            const match = target.match(/page-(\d+)/);
            if (!match) return null;
            return contentRoot.querySelector(`.iep-page[data-page="${match[1]}"]`);
        }

        function preservePageAttributes(source, target) {
            const sourceClasses = (source.getAttribute('class') || '').split(/\s+/).filter(Boolean);
            sourceClasses.forEach(cls => {
                if (!target.classList.contains(cls)) {
                    target.classList.add(cls);
                }
            });
            ['data-page', 'data-month-index', 'data-first-month', 'data-second-month', 'data-subject'].forEach(attr => {
                if (source.hasAttribute(attr)) {
                    target.setAttribute(attr, source.getAttribute(attr));
                }
            });
        }

        function replaceIepPageWithHtml(pageNode, html) {
            if (!pageNode || !html) return;
            const trimmed = html.trim();
            const template = document.createElement('template');
            template.innerHTML = trimmed;
            const newSection = template.content.querySelector('section');
            if (newSection) {
                preservePageAttributes(pageNode, newSection);
                pageNode.replaceWith(newSection);
                normalizeIepPages(document.getElementById('iep-content'));
                return;
            }
            pageNode.innerHTML = trimmed;
            normalizeIepPages(document.getElementById('iep-content'));
        }

        modifyBtn.addEventListener('click', applyModification);
        modifyInput.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                await applyModification();
            }
        });

        function sectionTitleTable(text) {
            const md = `| **${text}** |\n| --- |`;
            return markdownTableToHtml(md)
                .replace('class="min-w-full border border-gray-300 text-sm"', 'class="mx-auto w-auto border border-gray-300 text-base"')
                .replace('<th class="border px-2 py-1 bg-gray-100">', '<th class="border px-4 py-2 bg-gray-100 text-center text-lg">');
        }

        function upgradeLegacyIepStructure(wrapper) {
            if (!wrapper) return;
            const semesterPage = wrapper.querySelector('.iep-page[data-page="3"] #korean-goals')?.closest('.iep-page');
            const achievementPage = wrapper.querySelector('.iep-page[data-page="2"]');
            if (!semesterPage || !achievementPage) return;

            const achievementInner = achievementPage.querySelector('.iep-page-inner');
            if (!achievementInner) return;

            const findSubjectBlock = (label) => {
                return Array.from(achievementInner.children).find(child => {
                    if (!(child instanceof HTMLElement)) return false;
                    const heading = child.querySelector('h4');
                    return heading && heading.textContent.includes(label);
                });
            };

            let buttonContainer = achievementInner.querySelector('#iep-achievement-btn')?.parentElement;
            if (!buttonContainer) {
                buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex justify-end';
                const btn = document.createElement('button');
                btn.id = 'iep-achievement-btn';
                btn.className = 'text-sky-600 hover:underline text-sm';
                btn.textContent = '성취 기준 이동';
                buttonContainer.appendChild(btn);
            }

            const koreanBlock = findSubjectBlock('국어');
            const mathBlock = findSubjectBlock('수학');

            achievementInner.innerHTML = '';
            achievementInner.insertAdjacentHTML('beforeend', sectionTitleTable('1. 학습이 필요한 성취 기준 - 국어'));
            achievementInner.appendChild(buttonContainer);

            if (koreanBlock) {
                const heading = koreanBlock.querySelector('h4');
                if (heading) heading.textContent = '국어';
                achievementInner.appendChild(koreanBlock);
            } else {
                const fallback = document.createElement('div');
                fallback.innerHTML = '<h4 class="font-semibold">국어</h4><p class="text-gray-500">학습이 필요한 성취기준이 없습니다.</p>';
                achievementInner.appendChild(fallback);
            }

            const mathPage = document.createElement('section');
            mathPage.className = 'iep-page';
            mathPage.setAttribute('data-page', '3');
            const mathInner = document.createElement('div');
            mathInner.className = 'iep-page-inner';
            mathInner.insertAdjacentHTML('beforeend', sectionTitleTable('1. 학습이 필요한 성취 기준 - 수학'));
            if (mathBlock) {
                const heading = mathBlock.querySelector('h4');
                if (heading) heading.textContent = '수학';
                mathInner.appendChild(mathBlock);
            } else {
                const fallback = document.createElement('div');
                fallback.innerHTML = '<h4 class="font-semibold">수학</h4><p class="text-gray-500">학습이 필요한 성취기준이 없습니다.</p>';
                mathInner.appendChild(fallback);
            }
            mathPage.appendChild(mathInner);
            achievementPage.insertAdjacentElement('afterend', mathPage);

            semesterPage.setAttribute('data-page', '4');

            const monthlyPages = Array.from(wrapper.querySelectorAll('.iep-page[data-page]'))
                .filter(page => page !== semesterPage && Number(page.getAttribute('data-page')) >= 4)
                .sort((a, b) => Number(a.getAttribute('data-page')) - Number(b.getAttribute('data-page')));
            monthlyPages.forEach((page, idx) => {
                page.setAttribute('data-page', String(5 + idx));
            });
        }

        async function buildIepContent(studentName) {
            const user = auth.currentUser;
            if (!user) return '';
            const docRef = doc(db, 'users', user.uid, 'achievements', studentName);
            const snap = await getDoc(docRef);
            const data = snap.exists() ? (snap.data().data || {}) : {};
            const koreanList = collectYellowAchievements(data, 'korean');
            const mathList = collectYellowAchievements(data, 'math');
            lastKoreanList = koreanList;
            lastMathList = mathList;
            const now = new Date();
            const month = now.getMonth() + 1;
            const defaultSemester = (month >= 8 || month <= 1) ? 2 : 1;
            const months = getSemesterMonths(defaultSemester);
            const monthlyPages = months.map((info, idx) => {
                const monthDisplay = buildMonthlyDisplayText(info);
                const monthPrefix = monthDisplay ? `${monthDisplay} ` : '';
                const basePageNumber = 5 + idx * 2;
                const firstAttr = info.first ? ` data-first-month="${info.first}"` : '';
                const secondAttr = info.second ? ` data-second-month="${info.second}"` : '';
                const buildSubjectPage = (subjectKey, subjectLabel, pageNumber) => `
                <section class="iep-page" data-page="${pageNumber}" data-month-index="${idx}" data-subject="${subjectKey}"${firstAttr}${secondAttr}>
                    <div class="iep-page-inner">
                        <div class="iep-month-block" data-month-index="${idx}">
                            <div class="iep-month-subject" data-subject="${subjectKey}">
                                ${sectionTitleTable(`3. 월별 교육목표 - ${monthPrefix}${subjectLabel}`)}
                                <div id="monthly-plan-${idx}-${subjectKey}" class="iep-month-content mt-4"><p class="text-sm text-gray-500">월별 계획이 생성되지 않았습니다.</p></div>
                            </div>
                        </div>
                    </div>
                </section>`;
                return [
                    buildSubjectPage('korean', '국어', basePageNumber),
                    buildSubjectPage('math', '수학', basePageNumber + 1)
                ].join('');
            }).join('');
            const evaluationPageNumber = 5 + months.length * 2;
            const semesterEvaluationPage = `
                <section class="iep-page" data-page="${evaluationPageNumber}" data-semester-evaluation="true">
                    <div class="iep-page-inner">
                        ${sectionTitleTable('4. 학기 평가')}
                        <div class="space-y-6">
                            <div class="iep-semester-evaluation-subject" data-subject="korean">
                                <h4 class="font-semibold">가. 국어</h4>
                                ${buildSemesterEvaluationTable()}
                            </div>
                            <div class="iep-semester-evaluation-subject" data-subject="math">
                                <h4 class="font-semibold">나. 수학</h4>
                                ${buildSemesterEvaluationTable()}
                            </div>
                        </div>
                    </div>
                </section>`;
            return `
                <section class="iep-page" data-page="2">
                    <div class="iep-page-inner">
                        ${sectionTitleTable('1. 학습이 필요한 성취 기준 - 국어')}
                        <div>
                            <h4 class="font-semibold">국어</h4>
                            ${buildAchievementTable(koreanList)}
                        </div>
                    </div>
                </section>
                <section class="iep-page" data-page="3">
                    <div class="iep-page-inner">
                        ${sectionTitleTable('1. 학습이 필요한 성취 기준 - 수학')}
                        <div>
                            <h4 class="font-semibold">수학</h4>
                            ${buildAchievementTable(mathList)}
                        </div>
                    </div>
                </section>
                <section class="iep-page" data-page="4">
                    <div class="iep-page-inner">
                        ${sectionTitleTable('2. 학기별 교육 목표')}
                        <div>
                            <h4 class="font-semibold">가. 국어</h4>
                            <div id="korean-goals"></div>
                        </div>
                        <div>
                            <h4 class="font-semibold">나. 수학</h4>
                            <div id="math-goals"></div>
                        </div>
                    </div>
                </section>
                ${monthlyPages}
                ${semesterEvaluationPage}
            `;
        }

        function buildAchievementTable(list) {
            if (!list.length) {
                return '<p class="text-gray-500">학습이 필요한 성취기준이 없습니다.</p>';
            }
            let html = '<table class="w-full border border-gray-300 text-sm"><thead><tr><th class="border px-2 py-1">학년(군)</th><th class="border px-2 py-1">성취기준</th></tr></thead><tbody>';
            list.forEach(item => {
                html += `<tr><td class="border px-2 py-1">${item.grade}</td><td class="border px-2 py-1">${item.text}</td></tr>`;
            });
            html += '</tbody></table>';
            return html;
        }

        function collectYellowAchievements(data, subject) {
            const result = [];
            for (const level of Object.keys(achievementTables)) {
                const table = achievementTables[level]?.[subject];
                if (!table) continue;
                const key = `${level}_${subject}`;
                const states = data[key] || [];
                const temp = document.createElement('div');
                temp.innerHTML = markdownTableToHtml(table);
                const rows = temp.querySelectorAll('tbody tr');
                rows.forEach((tr, rowIdx) => {
                    const grade = tr.cells[0].textContent.trim();
                    for (let i = 1; i < tr.cells.length; i++) {
                        if (states[rowIdx]?.[i - 1] === 1) {
                            const text = tr.cells[i].textContent.trim();
                            result.push({ grade, text });
                        }
                    }
                });
            }
            return result;
        }

        async function callGemini(prompt, json = false) {
            const payload = { contents: [{ role: 'user', parts: [{ text: prompt }] }], generationConfig: json ? { responseMimeType: 'application/json' } : {} };
            try {
                const response = await fetch('/.netlify/functions/gemini-handler', { method: 'POST', body: JSON.stringify(payload) });
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || '';
                if (json) return JSON.parse(text);
                return text;
            } catch (e) {
                console.error('AI error', e);
                return json ? {} : '';
            }
        }

        function determineSemesterFromData(data) {
            let month = null;
            const createdAt = data?.createdAt;
            if (createdAt?.toDate) {
                month = createdAt.toDate().getMonth() + 1;
            } else if (createdAt?.seconds) {
                month = new Date(createdAt.seconds * 1000).getMonth() + 1;
            }
            if (!month) {
                const match = data?.title?.match(/([12])학기/);
                if (match) {
                    return parseInt(match[1], 10);
                }
                month = new Date().getMonth() + 1;
            }
            if (month >= 2 && month <= 7) return 1;
            return 2;
        }

        function getSemesterMonths(semester) {
            const templates = [
                { label: '가', first: '3월', second: '8월' },
                { label: '나', first: '4월', second: '9월' },
                { label: '다', first: '5월', second: '10월' },
                { label: '라', first: '6월', second: '11월' },
                { label: '마', first: '7월', second: '12월' }
            ];
            const isFirstSemester = semester === 1;
            return templates.map(template => {
                const actual = isFirstSemester ? template.first : template.second;
                const alternate = isFirstSemester ? template.second : template.first;
                const displayText = actual || '';
                return { ...template, actual, alternate, displayText };
            });
        }

        function buildMonthlyDisplayText(info) {
            if (!info) return '';
            if (info.displayText) return info.displayText;
            return info.actual || '';
        }

        function updateMonthlyPageDisplays(monthsArg) {
            const months = Array.isArray(monthsArg) ? monthsArg : getSemesterMonths(currentIepSemester);
            const contentRoot = document.getElementById('iep-content');
            const subjects = [
                { key: 'korean', label: '국어' },
                { key: 'math', label: '수학' }
            ];
            setBasePageDescriptions();
            months.forEach((info, idx) => {
                const displayText = buildMonthlyDisplayText(info);
                const monthPrefix = displayText ? `${displayText} ` : '';
                subjects.forEach((subject, subjectIdx) => {
                    const pageNumber = 5 + idx * subjects.length + subjectIdx;
                    pageDescriptions[`page-${pageNumber}`] = `${pageNumber}페이지(월별 교육 목표 - ${monthPrefix}${subject.label})`;
                    if (!contentRoot) return;
                    const selector = `.iep-page[data-month-index="${idx}"][data-subject="${subject.key}"]`;
                    const monthSection = contentRoot.querySelector(selector);
                    if (!monthSection) return;
                    monthSection.setAttribute('data-page', String(pageNumber));
                    monthSection.setAttribute('data-month-index', String(idx));
                    monthSection.setAttribute('data-subject', subject.key);
                    if (info.first) {
                        monthSection.setAttribute('data-first-month', info.first);
                    } else {
                        monthSection.removeAttribute('data-first-month');
                    }
                    if (info.second) {
                        monthSection.setAttribute('data-second-month', info.second);
                    } else {
                        monthSection.removeAttribute('data-second-month');
                    }
                    const block = monthSection.querySelector('.iep-month-block');
                    if (block) {
                        block.setAttribute('data-month-index', String(idx));
                    }
                    const subjectSection = monthSection.querySelector('.iep-month-subject');
                    if (subjectSection) {
                        subjectSection.setAttribute('data-subject', subject.key);
                        const headingStrong = subjectSection.querySelector('table thead th strong');
                        if (headingStrong) {
                            headingStrong.textContent = `3. 월별 교육목표 - ${monthPrefix}${subject.label}`;
                        }
                        const content = subjectSection.querySelector('.iep-month-content');
                        if (content) {
                            const expectedId = `monthly-plan-${idx}-${subject.key}`;
                            if (content.id !== expectedId) {
                                content.id = expectedId;
                            }
                        }
                    }
                });
            });
            const evaluationPageNumber = 5 + months.length * subjects.length;
            pageDescriptions[`page-${evaluationPageNumber}`] = `${evaluationPageNumber}페이지(학기 평가)`;
            renderModifyTargetButtons();
            updateModifyTargetActiveState();
        }

        function sanitizeFileName(text) {
            return (text || '').replace(/[\\/:*?"<>|]/g, ' ').replace(/\s+/g, ' ').trim();
        }

        async function generateSubjectMonthlyPlans(subject, months) {
            const semesterGoals = lastSemesterGoals[subject.key] || [];
            if (!semesterGoals.length) return [];
            const monthLabels = months.map(m => m.actual);
            const achievementText = subject.list.length
                ? subject.list.map((item, idx) => `${idx + 1}. ${item.text}`).join('\n')
                : '관련 성취기준 정보 없음';
            const prompt = `너는 특수교육 교사를 돕는 전문가야. 아래 정보를 참고하여 ${subject.name} 교과의 월별 계획을 JSON 배열로 작성해줘.\n\n- 학기: ${currentIepSemester}학기\n- 월 목록: ${monthLabels.join(', ')}\n- 학기 교육목표:\n${semesterGoals.map((goal, idx) => `${idx + 1}. ${goal}`).join('\n')}\n- 참고 성취기준:\n${achievementText}\n\n요구사항:\n1. 학기 교육목표의 핵심을 순서대로 ${monthLabels.length}개의 월별 교육목표로 나누어 제시한다. 필요한 경우 문장을 분할하거나 통합하되 모든 학기 목표 내용이 월별 목표에 반영되어야 한다.\n2. 각 월별 계획의 goal, content, method 값은 불릿 포인트 형식의 문자열로 작성한다. 불릿은 반드시 '○ '로 시작하고 문장마다 줄바꿈으로 구분한다.\n3. goal 항목은 2문장 이상, content와 method 항목은 각각 3문장 이상으로 작성한다.\n4. evaluation 항목을 포함하여 각 월 평가 기준을 작성한다. 평가 항목은 3문장으로 구성하고 각 문장은 '○ '로 시작하며 문장 끝은 차례대로 '~가', '~하는가', '~는가'로 끝나야 한다.\n5. content 항목의 모든 문장은 마침표 없이 '~기' 형태(예: ...하기, ...쓰기)로 끝나도록 작성한다.\n6. 모든 문장은 자연스러운 한국어로 작성한다.\n7. 응답은 반드시 JSON 배열만으로 제공하고 다른 설명은 포함하지 않는다.\n8. 배열의 각 요소는 {"month":"${monthLabels[0]}","goal":"...","content":"...","method":"...","evaluation":"..."} 형식을 따르며, month 값은 월 목록과 정확히 일치하고 순서를 유지해야 한다.`;
            const result = await callGemini(prompt, true);
            let plans = [];
            if (Array.isArray(result)) {
                plans = result;
            } else if (Array.isArray(result?.plans)) {
                plans = result.plans;
            }
            return monthLabels.map((month, idx) => {
                const plan = plans.find(p => p.month === month) || plans[idx] || {};
                return {
                    goal: formatMonthlyGoalText(plan.goal || ''),
                    content: formatMonthlyContentText(plan.content || ''),
                    method: formatMonthlyMethodText(plan.method || ''),
                    evaluation: formatMonthlyEvaluationText(plan.evaluation || '')
                };
            });
        }

        function buildMonthlyTables(month, subjectName, entry) {
            const goal = formatTableCell(entry.goal);
            const content = formatTableCell(entry.content);
            const method = formatTableCell(entry.method);
            const evaluation = formatTableCell(entry.evaluation || '');
            return `
                <table class="monthly-plan-table text-base">
                    <tbody>
                        <tr>
                            <th class="monthly-plan-title" colspan="2">${month} ${subjectName}</th>
                        </tr>
                        <tr>
                            <th class="monthly-plan-section-header">교육 목표</th>
                            <th class="monthly-plan-section-header">교육 내용</th>
                        </tr>
                        <tr>
                            <td class="data-cell">${goal}</td>
                            <td class="data-cell">${content}</td>
                        </tr>
                        <tr>
                            <th class="monthly-plan-section-header">교육 방법</th>
                            <th class="monthly-plan-section-header">교육 평가</th>
                        </tr>
                        <tr>
                            <td class="data-cell">${method}</td>
                            <td class="data-cell">${evaluation}</td>
                        </tr>
                        <tr>
                            <th class="monthly-plan-footer" colspan="2">월 평가</th>
                        </tr>
                        <tr>
                            <td class="monthly-plan-empty" colspan="2">&nbsp;</td>
                        </tr>
                    </tbody>
                </table>
            `.trim();
        }

        function buildSemesterEvaluationTable() {
            return `
                <table class="w-full border border-gray-300 text-sm semester-evaluation-table">
                    <thead>
                        <tr>
                            <th class="border px-2 py-2 bg-gray-100 text-center">평가</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="border px-2 py-10 align-top">&nbsp;</td>
                        </tr>
                    </tbody>
                </table>
            `.trim();
        }

        function formatTableCell(text) {
            if (!text) return '&nbsp;';
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\n/g, '<br>');
        }

        function splitMonthlySentences(text) {
            if (!text) return [];
            const cleaned = text
                .replace(/\r/g, '\n')
                .replace(/^\s*[-*•●○]\s*/gm, '')
                .replace(/^\s*\d+[.)]\s*/gm, '');
            const newlineParts = cleaned
                .split(/\n+/)
                .map(part => part.trim())
                .filter(Boolean);
            if (newlineParts.length > 1) {
                return newlineParts;
            }
            const normalized = cleaned.replace(/\s+/g, ' ').trim();
            if (!normalized) return [];
            const sentences = [];
            const regex = /[^.!?]+[.!?]?/g;
            let match;
            while ((match = regex.exec(normalized)) !== null) {
                const sentence = (match[0] || '').trim();
                if (sentence) sentences.push(sentence);
            }
            return sentences.length ? sentences : [normalized];
        }

        function ensureBulletString(text, { minCount = 1, endingMode = 'period' } = {}) {
            let sentences = splitMonthlySentences(text);
            if (sentences.length && sentences.length < minCount) {
                const expanded = [];
                sentences.forEach(sentence => {
                    const fragments = sentence
                        .split(/[,;·]/)
                        .map(fragment => fragment.trim())
                        .filter(fragment => fragment.length > 0);
                    if (fragments.length > 1) {
                        expanded.push(...fragments);
                    } else {
                        expanded.push(sentence);
                    }
                });
                if (expanded.length > sentences.length) {
                    sentences = expanded;
                }
            }
            const bullets = sentences.map(sentence => {
                let trimmed = sentence.trim();
                trimmed = trimmed.replace(/^[-*•●○]\s*/, '').replace(/^\d+[.)]\s*/, '').trim();
                trimmed = trimmed.replace(/\s+/g, ' ');
                if (!trimmed) return null;
                if (endingMode === 'gerund') {
                    trimmed = trimmed.replace(/[.!?]\s*$/, '');
                    trimmed = trimmed.replace(/기\s*(?:한다|합니다|함)?$/, '기');
                    trimmed = trimmed.replace(/기\s*(?:한다|합니다|함)?$/, '기');
                    trimmed = trimmed.replace(/한다$/, '한다').replace(/합니다$/, '하기');
                    trimmed = trimmed.trim();
                } else if (endingMode === 'none') {
                    trimmed = trimmed.replace(/[.!?]\s*$/, '');
                    trimmed = trimmed.trim();
                } else {
                    trimmed = trimmed.replace(/[.!?]\s*$/, '');
                    trimmed = `${trimmed}.`;
                }
                return `○ ${trimmed}`;
            }).filter(Boolean);

            if (!bullets.length) {
                let fallback = (text || '').replace(/^\s*[-*•●○]\s*/gm, '').trim();
                if (!fallback) return '';
                fallback = fallback.replace(/[.!?]\s*$/, '');
                fallback = fallback.replace(/\s+/g, ' ');
                if (endingMode === 'gerund') {
                    fallback = fallback.replace(/기\s*(?:한다|합니다|함)?$/, '기');
                    fallback = fallback.replace(/기\s*(?:한다|합니다|함)?$/, '기');
                    fallback = fallback.replace(/한다$/, '한다').replace(/합니다$/, '하기');
                }
                const sentence = endingMode === 'gerund'
                    ? fallback
                    : endingMode === 'none'
                        ? fallback
                        : `${fallback}.`;
                const bulletLine = `○ ${sentence}`;
                return Array.from({ length: Math.max(minCount, 1) }, () => bulletLine).join('\n');
            }

            if (bullets.length < minCount) {
                const last = bullets[bullets.length - 1];
                while (bullets.length < minCount) {
                    bullets.push(last);
                }
            }
            return bullets.join('\n');
        }

        function formatMonthlyGoalText(text) {
            return ensureBulletString(text, { minCount: 2, endingMode: 'period' });
        }

        function formatMonthlyContentText(text) {
            return ensureBulletString(text, { minCount: 3, endingMode: 'gerund' });
        }

        function formatMonthlyMethodText(text) {
            const bulletText = ensureBulletString(text, { minCount: 3, endingMode: 'period' });
            return enforceMethodSentenceEndings(bulletText);
        }

        function formatMonthlyEvaluationText(text) {
            const endings = ['가', '하는가', '는가'];
            const defaults = [
                '○ 학습 목표 달성 여부가',
                '○ 수업 참여 행동을 지속하는가',
                '○ 학습 내용을 실제로 이해했는가'
            ];
            const bulletText = ensureBulletString(text, { minCount: endings.length, endingMode: 'none' });
            const lines = (bulletText ? bulletText.split('\n') : [])
                .map(line => line.trim())
                .filter(Boolean);
            const normalized = [];
            for (let i = 0; i < endings.length; i++) {
                const ending = endings[i];
                let sourceLine = lines[i] || lines[lines.length - 1] || '';
                if (!sourceLine) {
                    normalized.push(defaults[i] || `○ 평가 문장${i + 1}${ending}`);
                    continue;
                }
                const match = sourceLine.match(/^(○\s*)(.*)$/);
                const prefix = match ? match[1] : '○ ';
                let sentence = match ? match[2].trim() : sourceLine.replace(/^[-*•●]\s*/, '').trim();
                if (!sentence) {
                    normalized.push(defaults[i] || `○ 평가 문장${i + 1}${ending}`);
                    continue;
                }
                sentence = sentence.replace(/[.!?]\s*$/, '');
                sentence = sentence.replace(/\s+/g, ' ').trim();
                if (!sentence.endsWith(ending)) {
                    sentence = sentence.replace(/(인가요?|인가|인지|한가요?|한가|하는가요?|하는지|는가요?|는지|수 있는가요?|수 있는가|수 있는지|가능한가요?|가능한가|가능한지|될 수 있는가|될 수 있는지|되는지)\s*$/, '').trim();
                    if (!sentence.endsWith(ending)) {
                        if (sentence.endsWith('가') && ending !== '가') {
                            sentence = sentence.slice(0, -1);
                        }
                        sentence = `${sentence}${ending}`;
                    }
                }
                normalized.push(`${prefix}${sentence}`);
            }
            return normalized.join('\n');
        }

        function enforceMethodSentenceEndings(text) {
            if (!text) return text;
            const lines = text.split('\n');
            return lines.map(line => {
                const match = line.match(/^(\s*○\s*)(.*)$/);
                if (!match) return line;
                const prefix = match[1];
                let sentence = match[2].trim();
                if (!sentence) return line;
                sentence = sentence.replace(/[.!?]\s*$/, '');
                sentence = sentence.replace(/기로\s*(?:한다|합니다|함|할 예정이다|할 계획이다|할 예정임|할 계획임)?$/, '한다');
                sentence = sentence.replace(/기\s*(?:한다|합니다|함|할 예정이다|할 계획이다|할 예정임|할 계획임)?$/, '한다');
                sentence = sentence.replace(/하도록 지도$/, '하도록 지도한다');
                sentence = sentence.replace(/지원$/, '지원한다');
                sentence = sentence.replace(/지도$/, '지도한다');
                if (!/다$/.test(sentence)) {
                    sentence = sentence.replace(/하$/, '한다');
                }
                if (!/다$/.test(sentence)) {
                    sentence += '한다';
                }
                sentence = sentence.replace(/다$/, '다.');
                return `${prefix}${sentence}`;
            }).join('\n');
        }

        function extractSemesterGoalsFromDom() {
            const subjects = [
                { key: 'korean', selector: '#korean-goals table tbody tr td' },
                { key: 'math', selector: '#math-goals table tbody tr td' }
            ];
            subjects.forEach(({ key, selector }) => {
                const cells = Array.from(document.querySelectorAll(selector));
                lastSemesterGoals[key] = cells.map(cell => cell.textContent.trim()).filter(Boolean);
            });
        }

        async function generateSemesterGoals(koreanList, mathList) {
            const subjects = [
                { name: '국어', list: koreanList, targetId: 'korean-goals', key: 'korean' },
                { name: '수학', list: mathList, targetId: 'math-goals', key: 'math' }
            ];
            for (const { name, list, targetId, key } of subjects) {
                const target = document.getElementById(targetId);
                lastSemesterGoals[key] = [];
                if (!list.length) {
                    target.innerHTML = '<p class="text-gray-500">학습이 필요한 성취기준이 없습니다.</p>';
                    continue;
                }
                target.innerHTML = '<p class="text-gray-500">생성 중...</p>';
                const prompt = `다음 성취기준을 바탕으로 ${name} 교과의 학기 교육목표를 1~5개의 문장으로 작성해줘. 각 문장은 '다.' 혹은 '한다.'로 끝나도록 하고 줄바꿈으로 구분해줘. 각 문장 앞에는 숫자나 기호를 붙이지 마.\n\n성취기준:\n${list.map((item, idx) => `${idx + 1}. ${item.text}`).join('\n')}`;
                const result = await callGemini(prompt);
                const lines = result
                    .split(/\n+/)
                    .map(l => l.trim())
                    .filter(Boolean)
                    .filter(line => !line.startsWith('다음은'))
                    .map(line => line.replace(/^[-•\d]+[.)]?\s*/, ''))
                    .slice(0, 5);
                lastSemesterGoals[key] = lines;
                if (!lines.length) {
                    target.innerHTML = '<p class="text-gray-500">학기 교육목표를 생성하지 못했습니다. 다시 시도해 주세요.</p>';
                    continue;
                }
                let md = `| ${name} 학기 교육목표 |\n| --- |\n`;
                lines.forEach(line => { md += `| ${line} |\n`; });
                target.innerHTML = markdownTableToHtml(md);
            }
            document.querySelectorAll('.iep-month-content').forEach(node => {
                node.innerHTML = '<p class="text-gray-500 text-sm">월별 계획이 생성되지 않았습니다.</p>';
            });
        }

        async function generateMonthlyPlans(koreanList, mathList) {
            const months = getSemesterMonths(currentIepSemester);
            updateMonthlyPageDisplays(months);
            if (!months.length) {
                document.querySelectorAll('.iep-month-content').forEach(node => {
                    node.innerHTML = '<p class="text-gray-500 text-sm">월 정보를 불러오지 못했습니다.</p>';
                });
                return;
            }
            const subjects = [
                { name: '국어', key: 'korean', list: koreanList },
                { name: '수학', key: 'math', list: mathList }
            ];
            const containersByMonth = {};
            months.forEach((_, idx) => {
                containersByMonth[idx] = {};
                subjects.forEach(subject => {
                    const container = document.getElementById(`monthly-plan-${idx}-${subject.key}`);
                    if (container) {
                        containersByMonth[idx][subject.key] = container;
                        container.innerHTML = '<p class="text-gray-500 text-sm">생성 중...</p>';
                    }
                });
            });

            const plansBySubject = {};
            for (const subject of subjects) {
                if (!(lastSemesterGoals[subject.key] || []).length) {
                    plansBySubject[subject.key] = null;
                    continue;
                }
                plansBySubject[subject.key] = await generateSubjectMonthlyPlans(subject, months);
            }

            months.forEach((monthInfo, idx) => {
                subjects.forEach(subject => {
                    const container = containersByMonth[idx]?.[subject.key];
                    if (!container) return;
                    const hasGoals = (lastSemesterGoals[subject.key] || []).length > 0;
                    const entry = plansBySubject[subject.key]?.[idx];
                    if (!hasGoals) {
                        container.innerHTML = '<p class="text-gray-500 text-sm">학기 교육목표를 먼저 생성해 주세요.</p>';
                    } else if (!entry || (!entry.goal && !entry.content && !entry.method)) {
                        container.innerHTML = '<p class="text-gray-500 text-sm">월별 계획을 생성하지 못했습니다. 다시 시도해 주세요.</p>';
                    } else {
                        container.innerHTML = buildMonthlyTables(monthInfo.actual, subject.name, entry);
                    }
                });
            });
        }

        // --- Behavior Intervention Logic ---
        const behaviorStudentList = document.getElementById('behavior-student-list');
        const behaviorSelectedStudentLabel = document.getElementById('behavior-selected-student');
        const behaviorRecordList = document.getElementById('behavior-record-list');
        const behaviorSharedList = document.getElementById('behavior-shared-list');
        const behaviorDetailPanel = document.getElementById('behavior-detail-panel');
        const behaviorDetailTitle = document.getElementById('behavior-detail-title');
        const behaviorOperationalDefinition = document.getElementById('behavior-operational-definition');
        const behaviorReinforcerBadge = document.getElementById('behavior-reinforcer-badge');
        const behaviorAttentionBadge = document.getElementById('behavior-attention-badge');
        const behaviorShareBtn = document.getElementById('behavior-share-btn');
        const behaviorLogList = document.getElementById('behavior-log-list');
        const behaviorGraphViewButtons = document.getElementById('behavior-graph-view-buttons');
        const openBehaviorModalBtn = document.getElementById('open-behavior-modal');
        const refreshBehaviorStudentsBtn = document.getElementById('refresh-behavior-students');
        const refreshSharedBehaviorsBtn = document.getElementById('refresh-shared-behaviors');
        const behaviorModal = document.getElementById('behavior-modal');
        const behaviorModalTitleInput = document.getElementById('behavior-modal-title');
        const behaviorModalReinforcerInput = document.getElementById('behavior-modal-reinforcer');
        const behaviorModalAttentionInput = document.getElementById('behavior-modal-attention');
        const behaviorModalDefinitionInput = document.getElementById('behavior-modal-definition');
        const behaviorModalCancelBtn = document.getElementById('behavior-modal-cancel');
        const behaviorModalSaveBtn = document.getElementById('behavior-modal-save');
        const behaviorShareModal = document.getElementById('behavior-share-modal');
        const behaviorShareUserList = document.getElementById('behavior-share-user-list');
        const behaviorShareCancelBtn = document.getElementById('behavior-share-cancel');
        const behaviorShareConfirmBtn = document.getElementById('behavior-share-confirm');
        const behaviorShareCloseBtn = document.getElementById('behavior-share-close');
        const behaviorLogNoteModal = document.getElementById('behavior-log-note-modal');
        const behaviorLogNoteInput = document.getElementById('behavior-log-note-input');
        const behaviorLogNoteMeta = document.getElementById('behavior-log-note-meta');
        const behaviorLogNoteSaveBtn = document.getElementById('behavior-log-note-save');
        const behaviorLogNoteCancelBtn = document.getElementById('behavior-log-note-cancel');
        const behaviorLogNoteDeleteBtn = document.getElementById('behavior-log-note-delete');
        const behaviorLogNoteCloseBtn = document.getElementById('behavior-log-note-close');
        const logBehaviorBtn = document.getElementById('log-behavior-btn');

        let behaviorStudents = [];
        let behaviorEntries = [];
        let sharedBehaviorEntries = [];
        let currentBehaviorStudentId = '';
        let currentBehaviorEntry = null;
        let currentBehaviorOwnerId = '';
        let currentBehaviorSource = 'own';
        let currentBehaviorLogs = [];
        let currentBehaviorChartView = 'daily';
        let currentBehaviorChartData = createEmptyBehaviorChartData();
        let currentBehaviorLogEditing = null;
        let isLoadingBehaviorStudents = false;
        let isLoadingBehaviorEntries = false;
        let isLoadingSharedBehaviors = false;
        let isLoadingTeacherDirectory = false;
        let teacherDirectoryLoaded = false;
        let teacherDirectory = [];
        let isUpdatingBehaviorShare = false;

        function resetBehaviorDetail() {
            currentBehaviorEntry = null;
            currentBehaviorOwnerId = '';
            currentBehaviorSource = 'own';
            currentBehaviorLogs = [];
            currentBehaviorChartView = 'daily';
            currentBehaviorChartData = createEmptyBehaviorChartData();
            setBehaviorChartView('daily', false);
            currentBehaviorLogEditing = null;
            if (behaviorDetailPanel) {
                behaviorDetailPanel.classList.add('hidden');
            }
            if (behaviorDetailTitle) behaviorDetailTitle.textContent = '';
            if (behaviorOperationalDefinition) behaviorOperationalDefinition.textContent = '';
            if (behaviorReinforcerBadge) behaviorReinforcerBadge.classList.add('hidden');
            if (behaviorAttentionBadge) behaviorAttentionBadge.classList.add('hidden');
            if (behaviorLogList) {
                behaviorLogList.innerHTML = '<li class="text-gray-500">행동 기록을 선택해주세요.</li>';
            }
            if (window.behaviorChartInstance) {
                window.behaviorChartInstance.destroy();
                window.behaviorChartInstance = null;
            }
            if (logBehaviorBtn) {
                logBehaviorBtn.disabled = true;
            }
            closeBehaviorLogNoteModal();
            updateSharedBehaviorActiveState();
            updateBehaviorShareButtonState();
        }

        function updateBehaviorActionState() {
            if (openBehaviorModalBtn) {
                openBehaviorModalBtn.disabled = !currentBehaviorStudentId;
            }
            if (logBehaviorBtn) {
                logBehaviorBtn.disabled = !currentBehaviorEntry;
            }
            updateBehaviorShareButtonState();
        }

        async function ensureCurrentUserProfile() {
            const user = auth.currentUser;
            if (!user) return null;
            if (currentUserProfile) return currentUserProfile;
            try {
                const snap = await getDoc(doc(db, 'users', user.uid));
                if (snap.exists()) {
                    currentUserProfile = snap.data();
                }
            } catch (error) {
                console.error('Failed to load user profile', error);
            }
            return currentUserProfile;
        }

        function updateBehaviorStudentActiveState() {
            if (!behaviorStudentList) return;
            const buttons = behaviorStudentList.querySelectorAll('button[data-student-id]');
            buttons.forEach(button => {
                const isActive = currentBehaviorStudentId && button.dataset.studentId === currentBehaviorStudentId;
                button.classList.toggle('border-sky-500', isActive);
                button.classList.toggle('bg-sky-50', isActive);
                button.classList.toggle('text-sky-700', isActive);
            });
        }

        function updateBehaviorEntriesActiveState() {
            if (!behaviorRecordList) return;
            behaviorRecordList.querySelectorAll('button[data-behavior-id]').forEach(button => {
                const isActive = currentBehaviorEntry && button.dataset.behaviorId === currentBehaviorEntry.id;
                button.classList.toggle('border-sky-500', isActive);
                button.classList.toggle('bg-sky-50', isActive);
                button.classList.toggle('text-sky-700', isActive);
            });
        }

        function updateSharedBehaviorActiveState() {
            if (!behaviorSharedList) return;
            behaviorSharedList.querySelectorAll('button[data-shared-behavior-id]').forEach(button => {
                const isActive = currentBehaviorEntry && currentBehaviorSource === 'shared' && button.dataset.sharedBehaviorId === currentBehaviorEntry.id && button.dataset.ownerId === currentBehaviorOwnerId;
                button.classList.toggle('border-sky-500', isActive);
                button.classList.toggle('bg-sky-50', isActive);
                button.classList.toggle('text-sky-700', isActive);
            });
        }

        function updateBehaviorShareButtonState() {
            if (!behaviorShareBtn) return;
            const user = auth.currentUser;
            const isOwner = !!currentBehaviorEntry && user && currentBehaviorOwnerId === user.uid;
            behaviorShareBtn.classList.toggle('hidden', !isOwner);
            behaviorShareBtn.disabled = !isOwner;
        }

        function renderBehaviorStudents() {
            if (!behaviorStudentList) return;
            behaviorStudentList.innerHTML = '';
            if (!behaviorStudents.length) {
                behaviorStudentList.innerHTML = '<p class="text-sm text-gray-500">학생이 없습니다.</p>';
                return;
            }
            behaviorStudents.forEach(student => {
                const button = document.createElement('button');
                button.type = 'button';
                button.dataset.studentId = student.id;
                button.className = 'flex w-full items-center justify-between rounded-lg border border-slate-200 bg-white px-3 py-2 text-left text-sm transition hover:border-sky-400 hover:bg-sky-50';
                button.innerHTML = `<span class="font-medium text-slate-700">${escapeHtml(student.name || '이름 미확인')}</span>`;
                behaviorStudentList.appendChild(button);
            });
            updateBehaviorStudentActiveState();
        }

        function renderBehaviorEntries() {
            if (!behaviorRecordList) return;
            behaviorRecordList.innerHTML = '';
            if (!behaviorEntries.length) {
                behaviorRecordList.innerHTML = '<p class="text-sm text-gray-500">등록된 행동 기록이 없습니다. 상단의 추가 버튼을 눌러 작성해보세요.</p>';
                return;
            }
            behaviorEntries.forEach(entry => {
                const button = document.createElement('button');
                button.type = 'button';
                button.dataset.behaviorId = entry.id;
                button.className = 'w-full rounded-lg border border-slate-200 bg-white p-3 text-left transition hover:border-sky-400 hover:bg-sky-50';
                const badges = [];
                if (entry.useReinforcer) {
                    badges.push('<span class="rounded-full bg-emerald-100 px-2.5 py-0.5 text-xs font-medium text-emerald-700">강화물</span>');
                }
                if (entry.useAttentionToken) {
                    badges.push('<span class="rounded-full bg-amber-100 px-2.5 py-0.5 text-xs font-medium text-amber-700">주의 토큰</span>');
                }
                const firstLine = (entry.operationalDefinition || '').split('\n')[0].trim();
                const description = firstLine ? escapeHtml(firstLine) : '조작적 정의가 등록되지 않았습니다.';
                button.innerHTML = `
                    <div class="flex items-start justify-between gap-3">
                        <div class="min-w-0">
                            <p class="font-semibold text-slate-800">${escapeHtml(entry.title || '행동 기록')}</p>
                            <p class="mt-1 text-xs text-slate-500 break-words">${description}</p>
                        </div>
                        <div class="flex flex-col items-end gap-1 text-xs font-medium text-slate-500">${badges.join('')}</div>
                    </div>
                `;
                behaviorRecordList.appendChild(button);
            });
            updateBehaviorEntriesActiveState();
        }

        function renderSharedBehaviorList() {
            if (!behaviorSharedList) return;
            behaviorSharedList.innerHTML = '';
            if (!sharedBehaviorEntries.length) {
                behaviorSharedList.innerHTML = '<p class="text-sm text-gray-500">공유 받은 행동 기록이 없습니다.</p>';
                return;
            }
            sharedBehaviorEntries.forEach(entry => {
                const button = document.createElement('button');
                button.type = 'button';
                button.dataset.sharedBehaviorId = entry.id;
                button.dataset.ownerId = entry.ownerId;
                button.className = 'w-full rounded-lg border border-slate-200 bg-white p-3 text-left transition hover:border-sky-400 hover:bg-sky-50';
                const studentName = escapeHtml(entry.studentName || '학생 미확인');
                const title = escapeHtml(entry.title || '행동 기록');
                button.innerHTML = `
                    <div class="flex flex-col gap-1">
                        <p class="font-semibold text-slate-800">${studentName}</p>
                        <p class="text-xs text-slate-500">${title}</p>
                    </div>
                `;
                behaviorSharedList.appendChild(button);
            });
            updateSharedBehaviorActiveState();
        }

        async function loadBehaviorStudents() {
            const user = auth.currentUser;
            if (!user || !behaviorStudentList || isLoadingBehaviorStudents) return;
            isLoadingBehaviorStudents = true;
            behaviorStudentList.innerHTML = '<p class="text-sm text-gray-500">학생 목록을 불러오는 중입니다...</p>';
            try {
                const classSnap = await getDoc(doc(db, 'classes', user.uid));
                if (!classSnap.exists()) {
                    behaviorStudents = [];
                    behaviorStudentList.innerHTML = '<p class="text-sm text-gray-500">학급 정보가 없습니다. 먼저 학급을 생성해주세요.</p>';
                    currentBehaviorStudentId = '';
                    if (behaviorRecordList) behaviorRecordList.innerHTML = '<p class="text-sm text-gray-500">학생을 선택하면 행동 기록이 표시됩니다.</p>';
                    if (behaviorSelectedStudentLabel) behaviorSelectedStudentLabel.textContent = '학생을 선택해주세요.';
                    resetBehaviorDetail();
                    updateBehaviorActionState();
                    return;
                }
                const studentIds = classSnap.data().students || [];
                if (!studentIds.length) {
                    behaviorStudents = [];
                    behaviorStudentList.innerHTML = '<p class="text-sm text-gray-500">등록된 학생이 없습니다.</p>';
                    currentBehaviorStudentId = '';
                    if (behaviorRecordList) behaviorRecordList.innerHTML = '<p class="text-sm text-gray-500">학생을 선택하면 행동 기록이 표시됩니다.</p>';
                    if (behaviorSelectedStudentLabel) behaviorSelectedStudentLabel.textContent = '학생을 선택해주세요.';
                    resetBehaviorDetail();
                    updateBehaviorActionState();
                    return;
                }
                const studentDocs = await Promise.all(studentIds.map(async (sid) => {
                    try {
                        const snap = await getDoc(doc(db, 'users', sid));
                        if (snap.exists()) {
                            const data = snap.data();
                            return { id: sid, name: data.name || data.userCode || sid };
                        }
                    } catch (error) {
                        console.error('Failed to load student info', error);
                    }
                    return { id: sid, name: sid };
                }));
                behaviorStudents = studentDocs.filter(Boolean);
                renderBehaviorStudents();
                const hasSelectedStudent = currentBehaviorStudentId && behaviorStudents.some(student => student.id === currentBehaviorStudentId);
                if (hasSelectedStudent) {
                    updateBehaviorStudentActiveState();
                    const student = behaviorStudents.find(s => s.id === currentBehaviorStudentId);
                    if (behaviorSelectedStudentLabel) {
                        behaviorSelectedStudentLabel.textContent = `${student?.name || '학생'} 학생`;
                    }
                    await loadBehaviorEntries(currentBehaviorStudentId);
                } else {
                    currentBehaviorStudentId = '';
                    if (behaviorRecordList) behaviorRecordList.innerHTML = '<p class="text-sm text-gray-500">학생을 선택하면 행동 기록이 표시됩니다.</p>';
                    if (behaviorSelectedStudentLabel) behaviorSelectedStudentLabel.textContent = '학생을 선택해주세요.';
                    resetBehaviorDetail();
                    updateBehaviorActionState();
                }
            } catch (error) {
                console.error('Failed to load behavior students', error);
                behaviorStudents = [];
                if (behaviorStudentList) {
                    behaviorStudentList.innerHTML = '<p class="text-sm text-red-500">학생 목록을 불러오지 못했습니다.</p>';
                }
                currentBehaviorStudentId = '';
                if (behaviorRecordList) behaviorRecordList.innerHTML = '<p class="text-sm text-gray-500">학생을 선택하면 행동 기록이 표시됩니다.</p>';
                if (behaviorSelectedStudentLabel) behaviorSelectedStudentLabel.textContent = '학생을 선택해주세요.';
                resetBehaviorDetail();
                updateBehaviorActionState();
            } finally {
                isLoadingBehaviorStudents = false;
            }
        }

        async function loadBehaviorEntries(studentId, behaviorIdToSelect = '') {
            const user = auth.currentUser;
            if (!user || !behaviorRecordList || isLoadingBehaviorEntries) return;
            isLoadingBehaviorEntries = true;
            behaviorRecordList.innerHTML = '<p class="text-sm text-gray-500">행동 기록을 불러오는 중입니다...</p>';
            try {
                const behaviorsRef = collection(db, 'users', user.uid, 'behaviors');
                const q = query(behaviorsRef, where('studentId', '==', studentId));
                const snapshot = await getDocs(q);
                behaviorEntries = snapshot.docs.map(docSnap => {
                    const data = docSnap.data();
                    return {
                        id: docSnap.id,
                        ...data,
                        ownerId: data.ownerId || user.uid,
                        sharedWith: Array.isArray(data.sharedWith) ? data.sharedWith : [],
                    };
                });
                behaviorEntries.sort((a, b) => {
                    const aTime = a.createdAt?.toMillis?.() || 0;
                    const bTime = b.createdAt?.toMillis?.() || 0;
                    return bTime - aTime;
                });
                if (!behaviorEntries.length) {
                    const student = behaviorStudents.find(s => s.id === studentId);
                    if (student?.name) {
                        const legacySnapshot = await getDocs(query(behaviorsRef, where('studentName', '==', student.name)));
                        const legacyUpdates = [];
                        legacySnapshot.forEach(docSnap => {
                            const data = docSnap.data();
                            behaviorEntries.push({
                                id: docSnap.id,
                                ...data,
                                ownerId: data.ownerId || user.uid,
                                sharedWith: Array.isArray(data.sharedWith) ? data.sharedWith : [],
                            });
                            if (!data.studentId) {
                                legacyUpdates.push(updateDoc(doc(db, 'users', user.uid, 'behaviors', docSnap.id), {
                                    studentId,
                                    studentName: student.name
                                }).catch(() => {}));
                            }
                        });
                        if (legacyUpdates.length) {
                            await Promise.allSettled(legacyUpdates);
                        }
                        behaviorEntries.sort((a, b) => {
                            const aTime = a.createdAt?.toMillis?.() || 0;
                            const bTime = b.createdAt?.toMillis?.() || 0;
                            return bTime - aTime;
                        });
                    }
                }
                renderBehaviorEntries();
                const targetId = behaviorIdToSelect || (currentBehaviorEntry && behaviorEntries.some(entry => entry.id === currentBehaviorEntry.id) ? currentBehaviorEntry.id : '');
                if (targetId) {
                    selectBehaviorEntry(targetId);
                } else {
                    currentBehaviorEntry = null;
                    resetBehaviorDetail();
                    updateBehaviorActionState();
                }
            } catch (error) {
                console.error('Failed to load behavior entries', error);
                behaviorRecordList.innerHTML = '<p class="text-sm text-red-500">행동 기록을 불러오지 못했습니다.</p>';
                behaviorEntries = [];
                currentBehaviorEntry = null;
                resetBehaviorDetail();
            } finally {
                isLoadingBehaviorEntries = false;
                updateBehaviorActionState();
            }
        }

        async function loadSharedBehaviors() {
            const user = auth.currentUser;
            if (!user || !behaviorSharedList || isLoadingSharedBehaviors) return;
            isLoadingSharedBehaviors = true;
            behaviorSharedList.innerHTML = '<p class="text-sm text-gray-500">공유 받은 행동 기록을 불러오는 중입니다...</p>';
            try {
                let inboxEntries = [];
                try {
                    const sharedInboxRef = collection(db, 'users', user.uid, 'sharedBehaviors');
                    const sharedInboxSnapshot = await getDocs(query(sharedInboxRef, orderBy('sharedAt', 'desc')));
                    inboxEntries = sharedInboxSnapshot.docs
                        .map(docSnap => {
                            const data = docSnap.data();
                            const ownerId = data.ownerId || '';
                            const behaviorId = data.behaviorId || '';
                            return {
                                id: behaviorId || docSnap.id,
                                ownerId,
                                studentId: data.studentId || '',
                                studentName: data.studentName || data.studentId || '',
                                title: data.title || '',
                                operationalDefinition: data.operationalDefinition || '',
                                useReinforcer: !!data.useReinforcer,
                                useAttentionToken: !!data.useAttentionToken,
                                sharedWith: Array.isArray(data.sharedWith) ? data.sharedWith : [],
                                createdAt: data.createdAt,
                                sharedAt: data.sharedAt || data.updatedAt || data.createdAt,
                            };
                        })
                        .filter(entry => entry.id && entry.ownerId);
                } catch (error) {
                    if (error?.code === 'permission-denied') {
                        console.warn('Permission denied when loading shared behavior inbox, falling back to legacy query.', error);
                    } else {
                        throw error;
                    }
                }
                sharedBehaviorEntries = inboxEntries;

                if (!sharedBehaviorEntries.length) {
                    const legacyQuery = query(collectionGroup(db, 'behaviors'), where('sharedWith', 'array-contains', user.uid));
                    const snapshot = await getDocs(legacyQuery);
                    sharedBehaviorEntries = snapshot.docs.map(docSnap => {
                        const data = docSnap.data();
                        const ownerRef = docSnap.ref.parent?.parent;
                        const ownerId = ownerRef?.id || data.ownerId || '';
                        return {
                            id: docSnap.id,
                            ownerId,
                            studentId: data.studentId || '',
                            studentName: data.studentName || data.studentId || '',
                            title: data.title || '',
                            operationalDefinition: data.operationalDefinition || '',
                            useReinforcer: !!data.useReinforcer,
                            useAttentionToken: !!data.useAttentionToken,
                            sharedWith: Array.isArray(data.sharedWith) ? data.sharedWith : [],
                            createdAt: data.createdAt,
                        };
                    });
                    sharedBehaviorEntries.sort((a, b) => {
                        const aTime = a.createdAt?.toMillis?.() || 0;
                        const bTime = b.createdAt?.toMillis?.() || 0;
                        return bTime - aTime;
                    });
                    if (sharedBehaviorEntries.length) {
                        await Promise.allSettled(sharedBehaviorEntries.map(entry => cacheSharedBehaviorEntry(user.uid, entry)));
                    }
                } else {
                    sharedBehaviorEntries.sort((a, b) => {
                        const aTime = a.sharedAt?.toMillis?.() || a.createdAt?.toMillis?.() || 0;
                        const bTime = b.sharedAt?.toMillis?.() || b.createdAt?.toMillis?.() || 0;
                        return bTime - aTime;
                    });
                }
                if (currentBehaviorSource === 'shared') {
                    const stillExists = sharedBehaviorEntries.some(entry => entry.id === currentBehaviorEntry?.id && entry.ownerId === currentBehaviorOwnerId);
                    if (!stillExists) {
                        resetBehaviorDetail();
                        if (behaviorSelectedStudentLabel) {
                            behaviorSelectedStudentLabel.textContent = '학생을 선택해주세요.';
                        }
                    }
                }
                renderSharedBehaviorList();
            } catch (error) {
                console.error('Failed to load shared behaviors', error);
                sharedBehaviorEntries = [];
                if (behaviorSharedList) {
                    behaviorSharedList.innerHTML = '<p class="text-sm text-red-500">공유 받은 행동 기록을 불러오지 못했습니다.</p>';
                }
            } finally {
                isLoadingSharedBehaviors = false;
            }
        }

        function getSharedBehaviorDocId(ownerId, behaviorId) {
            return `${ownerId}_${behaviorId}`;
        }

        async function cacheSharedBehaviorEntry(recipientId, entry) {
            try {
                const docId = getSharedBehaviorDocId(entry.ownerId, entry.id);
                const sharedRef = doc(db, 'users', recipientId, 'sharedBehaviors', docId);
                await setDoc(sharedRef, {
                    ownerId: entry.ownerId,
                    behaviorId: entry.id,
                    studentId: entry.studentId || '',
                    studentName: entry.studentName || '',
                    title: entry.title || '',
                    operationalDefinition: entry.operationalDefinition || '',
                    useReinforcer: !!entry.useReinforcer,
                    useAttentionToken: !!entry.useAttentionToken,
                    sharedWith: Array.isArray(entry.sharedWith) ? entry.sharedWith : [],
                    createdAt: entry.createdAt || serverTimestamp(),
                    sharedAt: entry.sharedAt || entry.createdAt || serverTimestamp(),
                    updatedAt: serverTimestamp()
                }, { merge: true });
            } catch (error) {
                console.warn('Failed to cache shared behavior entry', error);
            }
        }

        async function loadTeacherDirectory() {
            const user = auth.currentUser;
            if (!user) return [];
            if (teacherDirectoryLoaded || isLoadingTeacherDirectory) {
                return teacherDirectory;
            }
            isLoadingTeacherDirectory = true;
            try {
                const snapshot = await getDocs(query(collection(db, 'users'), where('role', '==', 'teacher')));
                teacherDirectory = snapshot.docs
                    .map(docSnap => {
                        const data = docSnap.data();
                        return {
                            id: docSnap.id,
                            name: data.name || '',
                            email: data.email || '',
                        };
                    })
                    .filter(person => person.id && person.id !== user.uid);
                teacherDirectory.sort((a, b) => {
                    const nameA = (a.name || a.email || '').toLowerCase();
                    const nameB = (b.name || b.email || '').toLowerCase();
                    return nameA.localeCompare(nameB);
                });
                teacherDirectoryLoaded = true;
            } catch (error) {
                console.error('Failed to load teacher directory', error);
                teacherDirectory = [];
            } finally {
                isLoadingTeacherDirectory = false;
            }
            return teacherDirectory;
        }

        function renderBehaviorShareUserList(selectedIds = []) {
            if (!behaviorShareUserList) return;
            behaviorShareUserList.innerHTML = '';
            if (!teacherDirectory.length) {
                behaviorShareUserList.innerHTML = '<p class="text-sm text-gray-500">공유 가능한 이용자가 없습니다.</p>';
                return;
            }
            teacherDirectory.forEach(user => {
                const isChecked = selectedIds.includes(user.id);
                const label = document.createElement('label');
                label.className = 'flex items-center gap-3 rounded-lg border border-slate-200 px-3 py-2 transition hover:border-sky-300';
                label.innerHTML = `
                    <input type="checkbox" value="${user.id}" class="h-4 w-4 rounded border-gray-300 text-sky-600 focus:ring-sky-500" ${isChecked ? 'checked' : ''}>
                    <div class="flex flex-col">
                        <span class="font-medium text-slate-700">${escapeHtml(user.name || user.email || '이름 미확인')}</span>
                        ${user.email ? `<span class="text-xs text-slate-500">${escapeHtml(user.email)}</span>` : ''}
                    </div>
                `;
                behaviorShareUserList.appendChild(label);
            });
        }

        function openBehaviorShareModal() {
            const user = auth.currentUser;
            if (!behaviorShareModal || !behaviorShareBtn || !behaviorShareUserList || !currentBehaviorEntry || !user) return;
            if (currentBehaviorOwnerId !== user.uid) return;
            behaviorShareModal.classList.remove('hidden');
            behaviorShareModal.classList.add('flex');
            if (behaviorShareConfirmBtn) behaviorShareConfirmBtn.disabled = true;
            behaviorShareUserList.innerHTML = '<p class="text-sm text-gray-500">이용자 목록을 불러오는 중입니다...</p>';
            loadTeacherDirectory().then(() => {
                renderBehaviorShareUserList(currentBehaviorEntry.sharedWith || []);
                if (behaviorShareConfirmBtn) behaviorShareConfirmBtn.disabled = false;
            });
        }

        function closeBehaviorShareModal() {
            if (!behaviorShareModal) return;
            behaviorShareModal.classList.add('hidden');
            behaviorShareModal.classList.remove('flex');
        }

        async function handleBehaviorShareConfirm() {
            const user = auth.currentUser;
            if (!user || !currentBehaviorEntry || currentBehaviorOwnerId !== user.uid || !behaviorShareUserList) return;
            if (isUpdatingBehaviorShare) return;
            const selectedIds = Array.from(behaviorShareUserList.querySelectorAll('input[type="checkbox"]:checked')).map(input => input.value);
            const previousSharedWith = Array.isArray(currentBehaviorEntry.sharedWith) ? [...currentBehaviorEntry.sharedWith] : [];
            isUpdatingBehaviorShare = true;
            if (behaviorShareConfirmBtn) behaviorShareConfirmBtn.disabled = true;
            try {
                const behaviorRef = doc(db, 'users', user.uid, 'behaviors', currentBehaviorEntry.id);
                await updateDoc(behaviorRef, {
                    sharedWith: selectedIds,
                    ownerId: user.uid,
                });
                currentBehaviorEntry.sharedWith = selectedIds;
                const entryIndex = behaviorEntries.findIndex(entry => entry.id === currentBehaviorEntry.id);
                if (entryIndex !== -1) {
                    behaviorEntries[entryIndex].sharedWith = selectedIds;
                }
                await syncSharedBehaviorInbox(user.uid, selectedIds, previousSharedWith);
                showToast('공유 설정이 저장되었습니다.');
                closeBehaviorShareModal();
                loadSharedBehaviors();
            } catch (error) {
                console.error('Failed to update behavior sharing', error);
                alert('공유 설정을 저장하지 못했습니다. 잠시 후 다시 시도해주세요.');
            } finally {
                isUpdatingBehaviorShare = false;
                if (behaviorShareConfirmBtn) behaviorShareConfirmBtn.disabled = false;
            }
        }

        async function syncSharedBehaviorInbox(ownerId, selectedIds, previousSharedWith) {
            if (!currentBehaviorEntry || !Array.isArray(selectedIds)) return;
            const tasks = [];
            const uniqueSelected = selectedIds.filter((teacherId, index, arr) => teacherId && arr.indexOf(teacherId) === index && teacherId !== ownerId);
            const removed = Array.isArray(previousSharedWith)
                ? previousSharedWith.filter(id => id && id !== ownerId && !uniqueSelected.includes(id))
                : [];

            const payload = {
                ownerId,
                behaviorId: currentBehaviorEntry.id,
                studentId: currentBehaviorEntry.studentId || '',
                studentName: currentBehaviorEntry.studentName || '',
                title: currentBehaviorEntry.title || '',
                operationalDefinition: currentBehaviorEntry.operationalDefinition || '',
                useReinforcer: !!currentBehaviorEntry.useReinforcer,
                useAttentionToken: !!currentBehaviorEntry.useAttentionToken,
                sharedWith: uniqueSelected,
                createdAt: currentBehaviorEntry.createdAt || serverTimestamp(),
                sharedAt: serverTimestamp(),
                updatedAt: serverTimestamp()
            };

            uniqueSelected.forEach(teacherId => {
                const docId = getSharedBehaviorDocId(ownerId, currentBehaviorEntry.id);
                const sharedRef = doc(db, 'users', teacherId, 'sharedBehaviors', docId);
                tasks.push(setDoc(sharedRef, payload, { merge: true }));
            });

            removed.forEach(teacherId => {
                const docId = getSharedBehaviorDocId(ownerId, currentBehaviorEntry.id);
                const sharedRef = doc(db, 'users', teacherId, 'sharedBehaviors', docId);
                tasks.push(deleteDoc(sharedRef).catch(() => {}));
            });

            if (tasks.length) {
                await Promise.allSettled(tasks);
            }
        }

        function canEditLogItem(logItem) {
            const user = auth.currentUser;
            if (!user) return false;
            if (currentBehaviorOwnerId === user.uid) return true;
            return logItem.recordedBy === user.uid;
        }

        function canDeleteLogItem(logItem) {
            const user = auth.currentUser;
            if (!user) return false;
            return currentBehaviorOwnerId === user.uid;
        }

        function openBehaviorLogNoteModal(logId) {
            if (!behaviorLogNoteModal || !currentBehaviorEntry) return;
            const logItem = currentBehaviorLogs.find(item => item.id === logId);
            if (!logItem) return;
            if (!canEditLogItem(logItem)) {
                alert('해당 기록에 특이 사항을 남길 권한이 없습니다.');
                return;
            }
            currentBehaviorLogEditing = logItem;
            const name = logItem.recordedByName || '기록자 미상';
            const time = logItem.timestamp ? formatTimestamp(logItem.timestamp) : '시간 정보 없음';
            if (behaviorLogNoteMeta) {
                behaviorLogNoteMeta.textContent = `${name} · ${time}`;
            }
            if (behaviorLogNoteInput) {
                behaviorLogNoteInput.value = logItem.note || '';
            }
            if (behaviorLogNoteDeleteBtn) {
                behaviorLogNoteDeleteBtn.classList.toggle('hidden', !canDeleteLogItem(logItem));
            }
            behaviorLogNoteModal.classList.remove('hidden');
            behaviorLogNoteModal.classList.add('flex');
            setTimeout(() => behaviorLogNoteInput?.focus(), 50);
        }

        function closeBehaviorLogNoteModal() {
            if (!behaviorLogNoteModal) return;
            currentBehaviorLogEditing = null;
            behaviorLogNoteModal.classList.add('hidden');
            behaviorLogNoteModal.classList.remove('flex');
        }

        async function saveBehaviorLogNote() {
            const user = auth.currentUser;
            if (!user || !currentBehaviorEntry || !currentBehaviorLogEditing) return;
            if (!canEditLogItem(currentBehaviorLogEditing)) {
                alert('해당 기록에 특이 사항을 남길 권한이 없습니다.');
                return;
            }
            const noteValue = (behaviorLogNoteInput?.value || '').trim();
            const ownerId = currentBehaviorOwnerId || user.uid;
            try {
                const logRef = doc(db, 'users', ownerId, 'behaviors', currentBehaviorEntry.id, 'logs', currentBehaviorLogEditing.id);
                if (noteValue) {
                    await updateDoc(logRef, { note: noteValue });
                } else {
                    await updateDoc(logRef, { note: deleteField() });
                }
                showToast('특이 사항이 저장되었습니다.');
                closeBehaviorLogNoteModal();
                loadBehaviorLogs(currentBehaviorEntry.id, currentBehaviorOwnerId);
            } catch (error) {
                console.error('Failed to save behavior log note', error);
                alert('특이 사항을 저장하지 못했습니다. 잠시 후 다시 시도해주세요.');
            }
        }

        async function deleteBehaviorLogEntry() {
            const user = auth.currentUser;
            if (!user || !currentBehaviorEntry || !currentBehaviorLogEditing) return;
            if (!canDeleteLogItem(currentBehaviorLogEditing)) {
                alert('행동 기록을 삭제할 권한이 없습니다.');
                return;
            }
            if (!confirm('해당 행동 기록을 삭제하시겠습니까?')) return;
            const ownerId = currentBehaviorOwnerId || user.uid;
            try {
                await deleteDoc(doc(db, 'users', ownerId, 'behaviors', currentBehaviorEntry.id, 'logs', currentBehaviorLogEditing.id));
                showToast('행동 기록이 삭제되었습니다.');
                closeBehaviorLogNoteModal();
                loadBehaviorLogs(currentBehaviorEntry.id, currentBehaviorOwnerId);
            } catch (error) {
                console.error('Failed to delete behavior log', error);
                alert('행동 기록을 삭제하지 못했습니다. 잠시 후 다시 시도해주세요.');
            }
        }

        function selectBehaviorEntry(behaviorId, options = {}) {
            const entry = options.entry || behaviorEntries.find(item => item.id === behaviorId);
            if (!entry) return;
            currentBehaviorEntry = entry;
            const user = auth.currentUser;
            currentBehaviorOwnerId = options.ownerId || entry.ownerId || user?.uid || '';
            currentBehaviorSource = options.source || 'own';
            updateBehaviorEntriesActiveState();
            updateSharedBehaviorActiveState();
            showBehaviorDetail(entry);
        }

        function showBehaviorDetail(entry) {
            if (!behaviorDetailPanel) return;
            behaviorDetailPanel.classList.remove('hidden');
            if (behaviorDetailTitle) behaviorDetailTitle.textContent = entry.title || '행동 기록';
            if (behaviorOperationalDefinition) {
                const definition = (entry.operationalDefinition || '').trim();
                behaviorOperationalDefinition.textContent = definition || '조작적 정의가 등록되지 않았습니다.';
            }
            if (behaviorReinforcerBadge) {
                behaviorReinforcerBadge.classList.toggle('hidden', !entry.useReinforcer);
            }
            if (behaviorAttentionBadge) {
                behaviorAttentionBadge.classList.toggle('hidden', !entry.useAttentionToken);
            }
            if (behaviorLogList) {
                behaviorLogList.innerHTML = '<li class="text-gray-500">기록을 불러오는 중입니다...</li>';
            }
            currentBehaviorChartData = createEmptyBehaviorChartData();
            currentBehaviorChartView = 'daily';
            setBehaviorChartView('daily');
            updateBehaviorActionState();
            loadBehaviorLogs(entry.id, currentBehaviorOwnerId);
        }

        async function loadBehaviorLogs(behaviorId, ownerId) {
            if (!currentBehaviorEntry || currentBehaviorEntry.id !== behaviorId) return;
            const user = auth.currentUser;
            if (!user) return;
            const targetOwnerId = ownerId || currentBehaviorOwnerId || user.uid;
            if (!targetOwnerId) return;
            currentBehaviorChartData = createEmptyBehaviorChartData();
            try {
                const logsRef = collection(db, 'users', targetOwnerId, 'behaviors', behaviorId, 'logs');
                const logSnapshot = await getDocs(query(logsRef, orderBy('timestamp', 'asc')));
                const dailyCounts = new Map();
                const monthlyCounts = new Map();
                const hourlyCounts = new Map();
                const logItems = [];
                let latestDateKey = '';
                let latestTimestamp = null;

                logSnapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const timestamp = data.timestamp?.toDate?.() || null;
                    let dateKey = '';
                    let hour = null;
                    if (timestamp) {
                        dateKey = formatDateKey(timestamp);
                        hour = timestamp.getHours();
                        const dayLabel = timestamp.toLocaleDateString('ko-KR');
                        dailyCounts.set(dayLabel, (dailyCounts.get(dayLabel) || 0) + 1);
                        const monthKey = `${timestamp.getFullYear()}-${String(timestamp.getMonth() + 1).padStart(2, '0')}`;
                        monthlyCounts.set(monthKey, (monthlyCounts.get(monthKey) || 0) + 1);
                        if (!latestTimestamp || timestamp > latestTimestamp) {
                            latestTimestamp = timestamp;
                            latestDateKey = dateKey;
                        }
                    }
                    logItems.push({
                        id: docSnap.id,
                        timestamp,
                        recordedByName: data.recordedByName || '',
                        recordedBy: data.recordedBy || '',
                        note: data.note || '',
                        dateKey,
                        hour
                    });
                });

                if (latestDateKey) {
                    logItems.forEach(item => {
                        if (item.dateKey === latestDateKey && item.hour !== null) {
                            const label = `${String(item.hour).padStart(2, '0')}시`;
                            hourlyCounts.set(label, (hourlyCounts.get(label) || 0) + 1);
                        }
                    });
                }

                currentBehaviorLogs = logItems.map(({ dateKey, hour, ...rest }) => rest);
                renderBehaviorLogList(currentBehaviorLogs);

                const hourlyLabels = Array.from(hourlyCounts.keys());
                const dailyLabels = Array.from(dailyCounts.keys());
                const monthlyKeys = Array.from(monthlyCounts.keys());

                currentBehaviorChartData = {
                    hourly: {
                        labels: hourlyLabels,
                        data: hourlyLabels.map(label => hourlyCounts.get(label) || 0)
                    },
                    daily: {
                        labels: dailyLabels,
                        data: dailyLabels.map(label => dailyCounts.get(label) || 0)
                    },
                    monthly: {
                        labels: monthlyKeys.map(formatMonthLabel),
                        data: monthlyKeys.map(key => monthlyCounts.get(key) || 0)
                    }
                };

                setBehaviorChartView(currentBehaviorChartView, true);
            } catch (error) {
                console.error('Failed to load behavior logs', error);
                currentBehaviorLogs = [];
                currentBehaviorChartData = createEmptyBehaviorChartData();
                setBehaviorChartView(currentBehaviorChartView, true);
                if (behaviorLogList) {
                    behaviorLogList.innerHTML = '<li class="text-sm text-red-500">기록을 불러오지 못했습니다.</li>';
                }
            }
        }

        function renderBehaviorLogList(logItems) {
            if (!behaviorLogList) return;
            behaviorLogList.innerHTML = '';
            if (!logItems.length) {
                behaviorLogList.innerHTML = '<li class="text-gray-500">기록 버튼을 눌러 첫 기록을 남겨보세요.</li>';
                return;
            }
            logItems.slice().reverse().forEach(item => {
                const li = document.createElement('li');
                li.className = 'rounded-lg border border-slate-200 bg-white px-3 py-2 shadow-sm';
                const name = escapeHtml(item.recordedByName || '기록자 미상');
                const time = item.timestamp ? formatTimestamp(item.timestamp) : '시간 정보 없음';
                const note = (item.note || '').trim();
                const noteContent = note
                    ? `<p class="text-sm text-slate-600 whitespace-pre-line">특이 사항: ${escapeHtml(note)}</p>`
                    : '<p class="text-xs text-sky-600">특이 사항을 추가하려면 클릭하세요.</p>';
                li.innerHTML = `
                    <button type="button" data-log-id="${item.id}" class="flex w-full flex-col gap-1 text-left">
                        <span class="font-semibold text-slate-700">${name}</span>
                        <span class="text-xs text-slate-500">${escapeHtml(time)}</span>
                        ${noteContent}
                    </button>
                `;
                behaviorLogList.appendChild(li);
            });
        }

        function createEmptyBehaviorChartData() {
            return {
                hourly: { labels: [], data: [] },
                daily: { labels: [], data: [] },
                monthly: { labels: [], data: [] }
            };
        }

        function setBehaviorChartView(view, render = true) {
            if (!['hourly', 'daily', 'monthly'].includes(view)) {
                view = 'daily';
            }
            currentBehaviorChartView = view;
            if (behaviorGraphViewButtons) {
                behaviorGraphViewButtons.querySelectorAll('button[data-view]').forEach(button => {
                    const isActive = button.dataset.view === view;
                    if (isActive) {
                        button.classList.add('bg-sky-600', 'border-sky-600', 'text-white', 'hover:bg-sky-700');
                        button.classList.remove('bg-white', 'text-sky-600', 'border-sky-200', 'hover:bg-sky-50');
                    } else {
                        button.classList.remove('bg-sky-600', 'border-sky-600', 'text-white', 'hover:bg-sky-700');
                        button.classList.add('bg-white', 'text-sky-600', 'border-sky-200', 'hover:bg-sky-50');
                    }
                });
            }
            if (render) {
                const dataset = currentBehaviorChartData[view] || { labels: [], data: [] };
                const labelText = currentBehaviorEntry?.title || '';
                renderBehaviorChart(dataset.labels, dataset.data, labelText);
            }
        }

        function renderBehaviorChart(labels, dataPoints, labelText) {
            const datasetLabel = labelText ? `${labelText} 발생 빈도` : '행동 발생 빈도';
            const chartData = {
                labels,
                datasets: [{
                    label: datasetLabel,
                    data: dataPoints,
                    borderColor: '#0ea5e9',
                    backgroundColor: 'rgba(14, 165, 233, 0.15)',
                    fill: true,
                    tension: 0.15,
                    pointRadius: 3
                }]
            };
            const options = {
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 }
                    }
                }
            };
            updateChart('behaviorChart', 'behaviorChartInstance', 'line', chartData, options);
        }

        function openBehaviorModal() {
            if (!behaviorModal) return;
            behaviorModal.classList.remove('hidden');
            behaviorModal.classList.add('flex');
            if (behaviorModalTitleInput) behaviorModalTitleInput.value = '';
            if (behaviorModalDefinitionInput) behaviorModalDefinitionInput.value = '';
            if (behaviorModalReinforcerInput) behaviorModalReinforcerInput.checked = false;
            if (behaviorModalAttentionInput) behaviorModalAttentionInput.checked = false;
            setTimeout(() => behaviorModalTitleInput?.focus(), 50);
        }

        function closeBehaviorModal() {
            if (!behaviorModal) return;
            behaviorModal.classList.add('hidden');
            behaviorModal.classList.remove('flex');
        }

        async function handleBehaviorModalSave() {
            if (!currentBehaviorStudentId) {
                alert('학생을 먼저 선택해주세요.');
                return;
            }
            const title = (behaviorModalTitleInput?.value || '').trim();
            const operationalDefinition = (behaviorModalDefinitionInput?.value || '').trim();
            const useReinforcer = !!behaviorModalReinforcerInput?.checked;
            const useAttentionToken = !!behaviorModalAttentionInput?.checked;
            if (!title) {
                alert('제목을 입력해주세요.');
                behaviorModalTitleInput?.focus();
                return;
            }
            const user = auth.currentUser;
            if (!user) return;
            const student = behaviorStudents.find(s => s.id === currentBehaviorStudentId);
            try {
                const docRef = await addDoc(collection(db, 'users', user.uid, 'behaviors'), {
                    title,
                    studentId: currentBehaviorStudentId,
                    studentName: student?.name || '',
                    useReinforcer,
                    useAttentionToken,
                    operationalDefinition,
                    createdAt: serverTimestamp()
                });
                showToast('행동 기록이 추가되었습니다.');
                closeBehaviorModal();
                await loadBehaviorEntries(currentBehaviorStudentId, docRef.id);
            } catch (error) {
                console.error('Failed to add behavior entry', error);
                alert('행동 기록을 추가하지 못했습니다. 잠시 후 다시 시도해주세요.');
            }
        }

        async function getRecorderDisplayName() {
            const user = auth.currentUser;
            if (!user) return '기록자';
            const profile = await ensureCurrentUserProfile();
            if (profile?.name) return profile.name;
            if (user.displayName) return user.displayName;
            if (profile?.email) return profile.email.split('@')[0];
            if (user.email) return user.email.split('@')[0];
            return '기록자';
        }

        if (behaviorStudentList) {
            behaviorStudentList.addEventListener('click', (event) => {
                const button = event.target.closest('button[data-student-id]');
                if (!button) return;
                const studentId = button.dataset.studentId;
                currentBehaviorStudentId = studentId;
                const student = behaviorStudents.find(s => s.id === studentId);
                if (behaviorSelectedStudentLabel) {
                    behaviorSelectedStudentLabel.textContent = `${student?.name || '학생'} 학생`;
                }
                updateBehaviorStudentActiveState();
                resetBehaviorDetail();
                loadBehaviorEntries(studentId);
                updateBehaviorActionState();
            });
        }

        if (behaviorRecordList) {
            behaviorRecordList.addEventListener('click', (event) => {
                const button = event.target.closest('button[data-behavior-id]');
                if (!button) return;
                selectBehaviorEntry(button.dataset.behaviorId);
            });
        }

        if (behaviorSharedList) {
            behaviorSharedList.addEventListener('click', (event) => {
                const button = event.target.closest('button[data-shared-behavior-id]');
                if (!button) return;
                const behaviorId = button.dataset.sharedBehaviorId;
                const ownerId = button.dataset.ownerId;
                const entry = sharedBehaviorEntries.find(item => item.id === behaviorId && item.ownerId === ownerId);
                if (!entry) return;
                if (behaviorSelectedStudentLabel) {
                    const displayName = entry.studentName || '학생';
                    behaviorSelectedStudentLabel.textContent = `${displayName} 학생 (공유)`;
                }
                currentBehaviorStudentId = '';
                selectBehaviorEntry(behaviorId, { entry, ownerId, source: 'shared' });
                updateBehaviorActionState();
            });
        }

        behaviorGraphViewButtons?.addEventListener('click', (event) => {
            const button = event.target.closest('button[data-view]');
            if (!button) return;
            setBehaviorChartView(button.dataset.view);
        });

        refreshBehaviorStudentsBtn?.addEventListener('click', () => {
            loadBehaviorStudents();
            loadSharedBehaviors();
        });
        refreshSharedBehaviorsBtn?.addEventListener('click', () => loadSharedBehaviors());

        openBehaviorModalBtn?.addEventListener('click', () => {
            if (!currentBehaviorStudentId) {
                alert('학생을 먼저 선택해주세요.');
                return;
            }
            openBehaviorModal();
        });

        behaviorModalCancelBtn?.addEventListener('click', closeBehaviorModal);
        behaviorModal?.addEventListener('click', (event) => {
            if (event.target === behaviorModal) {
                closeBehaviorModal();
            }
        });
        behaviorModalSaveBtn?.addEventListener('click', handleBehaviorModalSave);

        behaviorShareBtn?.addEventListener('click', openBehaviorShareModal);
        behaviorShareCancelBtn?.addEventListener('click', closeBehaviorShareModal);
        behaviorShareCloseBtn?.addEventListener('click', closeBehaviorShareModal);
        behaviorShareModal?.addEventListener('click', (event) => {
            if (event.target === behaviorShareModal) {
                closeBehaviorShareModal();
            }
        });
        behaviorShareConfirmBtn?.addEventListener('click', handleBehaviorShareConfirm);

        if (behaviorLogList) {
            behaviorLogList.addEventListener('click', (event) => {
                const button = event.target.closest('button[data-log-id]');
                if (!button) return;
                openBehaviorLogNoteModal(button.dataset.logId);
            });
        }

        behaviorLogNoteCancelBtn?.addEventListener('click', closeBehaviorLogNoteModal);
        behaviorLogNoteCloseBtn?.addEventListener('click', closeBehaviorLogNoteModal);
        behaviorLogNoteModal?.addEventListener('click', (event) => {
            if (event.target === behaviorLogNoteModal) {
                closeBehaviorLogNoteModal();
            }
        });
        behaviorLogNoteSaveBtn?.addEventListener('click', saveBehaviorLogNote);
        behaviorLogNoteDeleteBtn?.addEventListener('click', deleteBehaviorLogEntry);

        if (logBehaviorBtn) {
            logBehaviorBtn.addEventListener('click', async () => {
                if (!currentBehaviorEntry) {
                    alert('행동 기록을 선택해주세요.');
                    return;
                }
                const user = auth.currentUser;
                if (!user) return;
                const recorderName = await getRecorderDisplayName();
                try {
                    const ownerId = currentBehaviorOwnerId || user.uid;
                    await addDoc(collection(db, 'users', ownerId, 'behaviors', currentBehaviorEntry.id, 'logs'), {
                        timestamp: serverTimestamp(),
                        recordedBy: user.uid,
                        recordedByName: recorderName
                    });
                    const title = currentBehaviorEntry.title || '행동';
                    showToast(`${title}이 기록되었습니다.`);
                    loadBehaviorLogs(currentBehaviorEntry.id, currentBehaviorOwnerId);
                } catch (error) {
                    console.error('Failed to record behavior log', error);
                    alert('행동을 기록하지 못했습니다. 잠시 후 다시 시도해주세요.');
                }
            });
        }

        window.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && behaviorModal && !behaviorModal.classList.contains('hidden')) {
                closeBehaviorModal();
            } else if (event.key === 'Escape' && behaviorShareModal && !behaviorShareModal.classList.contains('hidden')) {
                closeBehaviorShareModal();
            } else if (event.key === 'Escape' && behaviorLogNoteModal && !behaviorLogNoteModal.classList.contains('hidden')) {
                closeBehaviorLogNoteModal();
            }
        });

        async function prepareBehaviorView() {
            if (behaviorSelectedStudentLabel && !currentBehaviorStudentId) {
                behaviorSelectedStudentLabel.textContent = '학생을 선택해주세요.';
            }
            resetBehaviorDetail();
            updateBehaviorActionState();
            await Promise.all([loadBehaviorStudents(), loadSharedBehaviors(), renderSketchbookList()]);
        }

        // --- UTILITY FUNCTIONS ---
        function formatDateKey(date) {
            if (!(date instanceof Date)) return '';
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatMonthLabel(key = '') {
            const [year, month] = key.split('-');
            if (!year || !month) return key || '';
            const yearNum = Number(year);
            const monthNum = Number(month);
            if (Number.isNaN(yearNum) || Number.isNaN(monthNum)) return key;
            return `${yearNum}년 ${monthNum}월`;
        }

        function formatTimestamp(date) {
            if (!(date instanceof Date)) {
                return '시간 정보 없음';
            }
            return date.toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        function escapeHtml(text) {
            return (text || '').replace(/[&<>"']/g, (char) => {
                switch (char) {
                    case '&': return '&amp;';
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '"': return '&quot;';
                    case "'": return '&#39;';
                    default: return char;
                }
            });
        }

        function formatCellText(text) {
            return escapeHtml(text || '').replace(/\n/g, '<br>');
        }

        function showToast(message) {
            toast.textContent = message;
            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 2000);
        }

        function updateChart(canvasId, instanceVar, type, data, options = {}) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            if (window[instanceVar]) {
                window[instanceVar].destroy();
            }

            window[instanceVar] = new Chart(ctx, { type, data, options });
        }
        
        // Initial load
        window.addEventListener('hashchange', () => {
            const currentView = window.location.hash.replace('#', '') || 'home';
            switchView(currentView).catch(console.error);
        });

    </script>
</body>
</html>

