<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—ì´ë‘ ìŠ¤í˜ì…œ - íŠ¹ìˆ˜êµì‚¬ ì—…ë¬´ ë³´ì¡°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Noto Sans KR', sans-serif; }
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .login-tab {
            border-bottom: 2px solid transparent;
            color: #475569;
            transition: color 0.2s, border-color 0.2s;
        }
        .login-tab.active {
            border-bottom-color: #0ea5e9;
            color: #0ea5e9;
            font-weight: 600;
        }
        .form-input {
            transition: all 0.3s;
        }
        .form-input:focus {
            border-color: #0ea5e9;
            box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.2);
            outline: none;
        }
        .btn {
            transition: background-color 0.3s, color 0.3s, opacity 0.3s;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            background-color: #0ea5e9;
            color: #ffffff;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #0284c7;
        }
        .btn-secondary {
            background-color: #e2e8f0;
            color: #1e293b;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #cbd5f5;
        }
        .content-section {
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: white;
        }
        .content-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
        }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #0ea5e9; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .nav-link { padding: 0.5rem 1rem; border-radius: 0.375rem; transition: background-color 0.2s, color 0.2s; }
        .nav-link.active { background-color: #0284c7; color: white; }
        .nav-link:not(.active):hover { background-color: #f3f4f6; }
        .tab-btn {
             transition: all 0.2s;
             border: 2px solid transparent;
        }
        .tab-btn.active {
             background-color: #0ea5e9; /* sky-500 */
             color: white;
             border-color: #0284c7; /* sky-600 */
             font-weight: 600;
        }
        .tab-btn:not(.active) {
            background-color: #f1f5f9; /* slate-100 */
            color: #475569; /* slate-600 */
        }
        .modify-target-btn {
            padding: 0.4rem 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #bae6fd;
            background-color: #f8fafc;
            color: #0369a1;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s, box-shadow 0.2s;
        }
        .modify-target-btn:hover {
            background-color: #e0f2fe;
            border-color: #7dd3fc;
        }
        .modify-target-btn.active {
            background-color: #0ea5e9;
            border-color: #0284c7;
            color: #ffffff;
            box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.2);
        }
        .manual-editing {
            outline: 2px dashed #0ea5e9;
            outline-offset: 4px;
        }
        .monthly-plan-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            font-size: 0.95rem;
        }
        .monthly-plan-table th,
        .monthly-plan-table td {
            border: 1px solid #cbd5e1;
            padding: 0.75rem;
            vertical-align: top;
        }
        .monthly-plan-table .monthly-plan-title {
            background-color: #e2e8f0;
            text-align: center;
            font-weight: 700;
            font-size: 1rem;
        }
        .monthly-plan-table .monthly-plan-section-header {
            background-color: #f1f5f9;
            text-align: center;
            font-weight: 600;
            width: 50%;
        }
        .monthly-plan-table .monthly-plan-footer {
            background-color: #dbeafe;
            text-align: center;
            font-weight: 600;
        }
        .monthly-plan-table .monthly-plan-empty {
            height: 80px;
        }
        .monthly-plan-table .data-cell {
            width: 50%;
            line-height: 1.6;
        }
        .iep-pages-wrapper {
            position: relative;
        }
        .iep-cover-actions {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            display: flex;
            gap: 0.5rem;
            z-index: 10;
        }
        .iep-cover-actions button {
            box-shadow: 0 4px 10px rgba(148, 163, 184, 0.2);
        }
        .iep-page-collection {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .iep-page {
            width: 210mm;
            min-height: 284mm;
            margin: 0 auto;
            padding: 25mm;
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .iep-page-cover {
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
        }
        .markdown-table-remove-column {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 9999px;
            border: none;
            background: transparent;
            color: #ef4444;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .markdown-table-remove-column:hover {
            background-color: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }
        .iep-cover-footer {
            margin-top: auto;
            font-weight: 500;
            align-self: flex-end;
        }
        .iep-page-inner {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .iep-page-inner table {
            width: 100%;
        }
        .iep-month-block {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .iep-month-content {
            min-height: 120px;
        }
        .iep-page + .iep-page {
            margin-top: 1.5rem;
        }
        .major-eval-page {
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            padding: 20mm;
            background-color: #ffffff;
            border: 1px solid #cbd5e1;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.1);
            box-sizing: border-box;
            position: relative;
        }
        .major-eval-page + .major-eval-page {
            margin-top: 1.5rem;
        }
        .major-eval-copy-btn {
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid #bae6fd;
            color: #0284c7;
            background-color: #f8fafc;
            border-radius: 0.375rem;
            padding: 0.35rem 0.75rem;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .major-eval-copy-btn:hover {
            background-color: #e0f2fe;
            border-color: #7dd3fc;
        }
        @media (max-width: 640px) {
            .app-header nav {
                gap: 0.2rem;
            }
            .app-header .nav-link {
                font-size: 0.625rem;
                padding: 0.25rem 0.5rem;
            }
            .app-title {
                font-size: 1rem;
            }
        }
        @media print {
            .major-eval-page {
                box-shadow: none;
                page-break-after: always;
            }
            .major-eval-page:last-child {
                page-break-after: auto;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="app">
        <!-- Auth View (Login/Signup) -->
        <div id="auth-view" class="min-h-screen flex items-center justify-center bg-gray-100">
            <div class="w-full max-w-md bg-white rounded-lg shadow-md p-8">
                <div id="login-view" class="view active">
                    <h2 class="text-2xl font-bold text-center text-sky-600 mb-6">ì—ì´ë‘ ìŠ¤í˜ì…œ ì‹œì‘í•˜ê¸°</h2>
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                            <button id="student-login-tab" class="login-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">ğŸ§‘â€ğŸ“ í•™ìƒ</button>
                            <button id="teacher-login-tab" class="login-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">ğŸ§‘â€ğŸ« êµì‚¬</button>
                        </nav>
                    </div>
                    <div id="student-login-content" class="tab-content pt-6">
                        <div class="mb-4">
                            <label for="student-code" class="block text-sm font-medium text-gray-700 mb-1">ê³ ìœ  ìˆ«ì ì½”ë“œ</label>
                            <input type="text" id="student-code" class="w-full border border-gray-300 rounded-md p-2 form-input" placeholder="ë°œê¸‰ë°›ì€ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        <p id="student-login-error" class="text-red-500 text-sm mb-4 hidden"></p>
                        <button id="student-login-btn" class="w-full py-2 rounded-md btn btn-primary font-semibold">í•™ìƒ ë¡œê·¸ì¸</button>
                    </div>
                    <div id="teacher-login-content" class="tab-content pt-6">
                        <div class="mb-4">
                            <label for="teacher-email" class="block text-sm font-medium text-gray-700 mb-1">ì´ë©”ì¼</label>
                            <input type="email" id="teacher-email" class="w-full border border-gray-300 rounded-md p-2 form-input" placeholder="example@email.com">
                        </div>
                        <div class="mb-6">
                            <label for="teacher-password" class="block text-sm font-medium text-gray-700 mb-1">ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" id="teacher-password" class="w-full border border-gray-300 rounded-md p-2 form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                        </div>
                        <p id="teacher-login-error" class="text-red-500 text-sm mb-4 hidden"></p>
                        <button id="teacher-login-btn" class="w-full py-2 rounded-md btn btn-primary font-semibold">êµì‚¬ ë¡œê·¸ì¸</button>
                        <button id="teacher-google-login-btn" class="w-full py-2 mt-2 rounded-md btn border border-gray-300 bg-white text-gray-700 font-semibold flex items-center justify-center gap-2 hover:bg-gray-50">
                            <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                            Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
                        </button>
                    </div>
                    <div class="mt-6 text-center space-y-2">
                        <button id="show-student-register-btn" class="w-full text-sm text-sky-600 hover:underline">ì²˜ìŒì´ì‹ ê°€ìš”? í•™ìƒ ë“±ë¡í•˜ê¸°</button>
                        <button id="show-teacher-register-btn" class="w-full text-sm text-sky-600 hover:underline">êµì‚¬ì´ì‹ ê°€ìš”? íšŒì›ê°€ì…í•˜ê¸°</button>
                    </div>
                </div>
                <div id="student-register-view" class="view">
                    <h2 class="text-2xl font-bold text-center text-sky-600 mb-6">ğŸ§‘â€ğŸ“ í•™ìƒ ë“±ë¡</h2>
                    <div class="mb-4">
                        <label for="student-name" class="block text-sm font-medium text-gray-700 mb-1">ì´ë¦„</label>
                        <input type="text" id="student-name" class="w-full border border-gray-300 rounded-md p-2 form-input" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <p id="student-register-error" class="text-red-500 text-sm mb-4 hidden"></p>
                    <button id="student-register-btn" class="w-full py-2 rounded-md btn btn-primary font-semibold mb-4">ë“±ë¡í•˜ê³  ì½”ë“œ ë°›ê¸°</button>
                    <button id="back-to-login-btn" class="w-full text-sm text-gray-600 hover:underline">ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
                </div>
                <div id="teacher-register-view" class="view">
                    <h2 class="text-2xl font-bold text-center text-sky-600 mb-6">ğŸ§‘â€ğŸ« êµì‚¬ íšŒì›ê°€ì…</h2>
                    <div class="mb-4">
                        <label for="teacher-register-name" class="block text-sm font-medium text-gray-700 mb-1">ì´ë¦„</label>
                        <input type="text" id="teacher-register-name" class="w-full border border-gray-300 rounded-md p-2 form-input" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <div class="mb-4">
                        <label for="teacher-register-email" class="block text-sm font-medium text-gray-700 mb-1">ì´ë©”ì¼</label>
                        <input type="email" id="teacher-register-email" class="w-full border border-gray-300 rounded-md p-2 form-input" placeholder="example@email.com">
                    </div>
                    <div class="mb-6">
                        <label for="teacher-register-password" class="block text-sm font-medium text-gray-700 mb-1">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="teacher-register-password" class="w-full border border-gray-300 rounded-md p-2 form-input" placeholder="6ìë¦¬ ì´ìƒ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <p id="teacher-register-error" class="text-red-500 text-sm mb-4 hidden"></p>
                    <button id="teacher-register-btn" class="w-full py-2 rounded-md btn btn-primary font-semibold mb-4">íšŒì›ê°€ì…</button>
                    <button id="teacher-back-to-login-btn" class="w-full text-sm text-gray-600 hover:underline">ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
                </div>
            </div>
        </div>

        <!-- Main App View -->
        <div id="main-app-view" class="hidden flex-col min-h-screen">
            <header class="app-header bg-white shadow-md w-full sticky top-0 z-50">
                <div class="container mx-auto px-4 sm:px-6 py-3 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                    <h1 class="app-title text-lg sm:text-2xl font-bold text-sky-600"><a href="#home" id="home-link">ğŸ“ ì—ì´ë‘ ìŠ¤í˜ì…œ</a></h1>
                    <nav class="flex flex-wrap items-center gap-2 sm:gap-4 text-[0.7rem] sm:text-sm">
                        <span id="user-email" class="text-[0.65rem] sm:text-xs text-gray-600"></span>
                        <a href="#home" id="nav-home" data-view="home" class="nav-link text-[0.7rem] sm:text-sm">í™ˆ</a>
                        <a href="#my-class" id="nav-my-class" data-view="my-class" class="nav-link text-[0.7rem] sm:text-sm">ë‚´ í•™ê¸‰ ê´€ë¦¬</a>
                        <a href="#sketchbook" id="nav-sketchbook" data-view="sketchbook" class="nav-link text-[0.7rem] sm:text-sm">ì—ì´ë‘ ìŠ¤ì¼€ì¹˜ë¶</a>
                        <!-- IEP navigation link; 'ê°œë³„í™”êµìœ¡ê³„íš' is commonly referred to as 'IEP'. Modify this section when updating 'iep'. -->
                        <a href="#iep" id="nav-iep" data-view="iep" class="nav-link text-[0.7rem] sm:text-sm">ê°œë³„í™”êµìœ¡ê³„íš(IEP)</a>
                        <a href="#templates" id="nav-templates" data-view="templates" class="nav-link text-[0.7rem] sm:text-sm">ì„œì‹ ìƒì„±</a>
                        <a href="#behavior" id="nav-behavior" data-view="behavior" class="nav-link text-[0.7rem] sm:text-sm">í–‰ë™ ê¸°ë¡</a>
                        <a href="#sketchbook" id="nav-sketchbook-secondary" data-view="sketchbook" class="nav-link text-[0.7rem] sm:text-sm">ì—ì´ë‘ ìŠ¤ì¼€ì¹˜ë¶</a>
                        <button id="logout-btn" class="text-xs sm:text-sm bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-md transition-colors">ë¡œê·¸ì•„ì›ƒ</button>
                    </nav>
                </div>
            </header>
            <main class="flex-grow container mx-auto p-4 sm:p-6">
                <!-- Home View -->
                <div id="home-view" class="space-y-6">
                    <h2 class="text-3xl font-bold">í™ˆ</h2>
                    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg">
                        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between mb-4">
                            <div>
                                <h3 class="text-lg sm:text-xl font-bold text-slate-800">ê°„í¸ í–‰ë™ ê¸°ë¡</h3>
                                <p class="text-xs text-slate-500">ê³µìœ ë°›ì€ í–‰ë™ê³¼ ë‚˜ì˜ í–‰ë™ì„ í•œ ìë¦¬ì—ì„œ ë¹ ë¥´ê²Œ ê¸°ë¡í•˜ì„¸ìš”.</p>
                            </div>
                            <button id="home-behavior-refresh" class="self-start rounded-md border border-sky-200 px-3 py-1 text-xs font-medium text-sky-600 transition hover:bg-sky-50">ìƒˆë¡œê³ ì¹¨</button>
                        </div>
                        <div id="home-behavior-table" class="space-y-3">
                            <p class="text-sm text-gray-500">í–‰ë™ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
                        </div>
                    </div>
                </div>

                <!-- Sketchbook View -->
                <div id="sketchbook-view" class="hidden space-y-6">
                    <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
                        <div>
                            <h2 class="text-3xl font-bold">ì—ì´ë‘ ìŠ¤ì¼€ì¹˜ë¶</h2>
                            <p class="text-sm text-slate-500">ìˆ˜ì—… ì•„ì´ë””ì–´ì™€ í™œë™ ìë£Œë¥¼ í•œ ê³³ì— ëª¨ì•„ë³´ì„¸ìš”. ìŠ¤ì¼€ì¹˜ë¶ì„ ë§Œë“¤ê³  í•™ìƒê³¼ ë™ë£Œ êµì‚¬ì™€ ì†ì‰½ê²Œ ê³µìœ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        </div>
                        <button data-action="create-sketch" class="self-start rounded-md bg-sky-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-sky-700">ìƒˆ ìŠ¤ì¼€ì¹˜ë¶ ë§Œë“¤ê¸°</button>
                    </div>
                    <div class="grid gap-6 lg:grid-cols-[2fr,1fr]">
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between mb-4">
                                <div>
                                    <h3 class="text-xl font-semibold text-slate-800">ë‚´ ìŠ¤ì¼€ì¹˜ë¶</h3>
                                    <p class="text-sm text-slate-500">ìµœê·¼ ìˆœìœ¼ë¡œ ì •ë¦¬ëœ ìŠ¤ì¼€ì¹˜ë¶ ëª©ë¡ì…ë‹ˆë‹¤.</p>
                                </div>
                                <button data-action="create-sketch" class="rounded-md border border-sky-200 bg-white px-3 py-1.5 text-xs font-semibold text-sky-600 transition hover:bg-sky-50">ë¹ ë¥´ê²Œ ë§Œë“¤ê¸°</button>
                            </div>
                            <ul id="sketchbook-list" class="space-y-3 max-h-[520px] overflow-y-auto">
                                <li class="text-sm text-gray-500">ìŠ¤ì¼€ì¹˜ë¶ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</li>
                            </ul>
                        </div>
                        <div class="space-y-6">
                            <div class="bg-white p-6 rounded-lg shadow-lg">
                                <h3 class="text-base font-semibold text-slate-800">í™œìš© ê°€ì´ë“œ</h3>
                                <ul class="mt-3 space-y-3 text-sm text-slate-600">
                                    <li class="flex items-start gap-2"><span class="mt-1 inline-flex h-2 w-2 flex-shrink-0 rounded-full bg-sky-500"></span><span>ìˆ˜ì—… ì „ ê°œìš”, í•™ìŠµ ìë£Œ, í‰ê°€ ê³„íšì„ ë ˆì´ì–´ë³„ë¡œ ì •ë¦¬í•´ ë³´ì„¸ìš”.</span></li>
                                    <li class="flex items-start gap-2"><span class="mt-1 inline-flex h-2 w-2 flex-shrink-0 rounded-full bg-emerald-500"></span><span>ìŠ¤ì¼€ì¹˜ë¶ ì½”ë“œë¡œ ë™ë£Œ êµì‚¬ì—ê²Œ ê³µìœ í•˜ê³  ê³µë™ ì‘ì—…ì„ ì§„í–‰í•˜ì„¸ìš”.</span></li>
                                    <li class="flex items-start gap-2"><span class="mt-1 inline-flex h-2 w-2 flex-shrink-0 rounded-full bg-amber-500"></span><span>Excalidraw íŒŒì¼ì„ ë¶ˆëŸ¬ì™€ ê¸°ì¡´ ì•„ì´ë””ì–´ë¥¼ ë¹ ë¥´ê²Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span></li>
                                </ul>
                            </div>
                            <div class="bg-sky-50 border border-sky-100 p-6 rounded-lg shadow-inner">
                                <h3 class="text-base font-semibold text-sky-700">ê³µìœ  íŒ</h3>
                                <p class="mt-2 text-sm text-sky-700">ê³µìœ ë°›ì€ ì½”ë“œëŠ” ìŠ¤ì¼€ì¹˜ë¶ ìƒì„¸ í™”ë©´ì—ì„œ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•™ìƒê³¼ í•¨ê»˜ ì‚¬ìš©í•  ê²½ìš°, ì½ê¸° ì „ìš© ë§í¬ë¥¼ ë³µì‚¬í•´ ì•ˆë‚´í•˜ì„¸ìš”.</p>
                                <div class="mt-4 space-y-2 text-xs text-sky-800">
                                    <p class="flex items-start gap-2"><span class="mt-1 inline-flex h-2 w-2 flex-shrink-0 rounded-full bg-sky-600"></span>ì½”ë“œë¥¼ ë¶„ì‹¤í–ˆë‹¤ë©´ ìŠ¤ì¼€ì¹˜ë¶ ì¹´ë“œì—ì„œ &lsquo;ê³µìœ  ì½”ë“œ í™•ì¸&rsquo;ì„ ëˆŒëŸ¬ ë‹¤ì‹œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                                    <p class="flex items-start gap-2"><span class="mt-1 inline-flex h-2 w-2 flex-shrink-0 rounded-full bg-sky-600"></span>í•™ìƒê³¼ ì‹¤ì‹œê°„ ìˆ˜ì—…ì„ ì§„í–‰í•  ë• í™”ë©´ ê³µìœ ì™€ í•¨ê»˜ ë“œë¡œì‰ ëª¨ë“œë¥¼ í™œìš©í•´ë³´ì„¸ìš”.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- My Class View -->
                <div id="my-class-view" class="hidden">
                    <h2 class="text-3xl font-bold mb-6">ë‚´ í•™ê¸‰ ê´€ë¦¬</h2>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <div id="class-header" class="flex justify-between items-center mb-4">
                            <h3 id="class-title" class="text-xl font-bold">ë‚´ í•™ê¸‰</h3>
                            <button id="add-class-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded">ë‚´ í•™ê¸‰ ë§Œë“¤ê¸°</button>
                        </div>
                        <div id="class-list" class="space-y-3">
                            <!-- Class items will be dynamically inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Create Class Modal -->
                <div id="create-class-modal" class="fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-50 px-4">
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-sky-700">ë‚´ í•™ê¸‰ ë§Œë“¤ê¸°</h3>
                            <button type="button" id="create-class-close-btn" class="text-2xl leading-none text-sky-500 hover:text-sky-700">&times;</button>
                        </div>
                        <p class="text-sm text-gray-600 mb-4">í•™ìƒë“¤ê³¼ í•¨ê»˜ ì‚¬ìš©í•  í•™ê¸‰ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. í•™ê¸‰ì€ í•œ ë²ˆë§Œ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        <form id="create-class-form" class="space-y-4">
                            <div>
                                <label for="create-class-name" class="block text-sm font-medium text-gray-700 mb-1">í•™ê¸‰ ì´ë¦„</label>
                                <input type="text" id="create-class-name" class="w-full border border-gray-300 rounded-md p-2 form-input" placeholder="ì˜ˆ: í•¨ê»˜ë°˜" autocomplete="off">
                            </div>
                            <div class="flex justify-end gap-2">
                                <button type="button" id="create-class-cancel-btn" class="px-4 py-2 rounded-md btn btn-secondary">ì·¨ì†Œ</button>
                                <button type="submit" id="create-class-confirm-btn" class="px-4 py-2 rounded-md btn btn-primary font-semibold">ë§Œë“¤ê¸°</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- IEP View -->
                <div id="iep-view" class="hidden">
                     <h2 class="text-3xl font-bold mb-6">ê°œë³„í™”êµìœ¡ê³„íš(IEP) ìˆ˜ë¦½</h2>
                     <div class="flex flex-col lg:flex-row gap-6">
                        <aside class="w-full lg:w-1/3 bg-white p-6 rounded-lg shadow-lg h-fit lg:sticky top-24">
                            <h3 class="text-lg font-semibold mb-4">ë‚´ í•™ê¸‰</h3>
                            <div id="iep-student-list" class="grid grid-cols-4 gap-2">
                                <!-- í•™ìƒ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. -->
                            </div>
                            <div id="iep-modify-section" class="mt-6 hidden">
                                <div id="iep-save-section" class="mb-4 hidden">
                                    <h4 class="font-semibold mb-2">ì €ì¥ í…Œì´ë¸”</h4>
                                    <div class="flex flex-wrap gap-2">
                                        <button id="save-iep-btn" class="flex-1 min-w-[140px] bg-sky-600 hover:bg-sky-700 text-white text-sm font-semibold px-3 py-2 rounded transition">ì €ì¥</button>
                                        <button id="save-pdf-btn" class="flex-1 min-w-[140px] bg-gray-500 hover:bg-gray-600 text-white text-sm font-semibold px-3 py-2 rounded transition">PDF ì €ì¥</button>
                                    </div>
                                </div>
                                <div id="iep-generation-section" class="mb-4 hidden">
                                    <h4 class="font-semibold mb-2">ìƒì„± í…Œì´ë¸”</h4>
                                    <div class="flex flex-wrap gap-2">
                                        <button id="iep-achievement-btn" class="flex-1 min-w-[180px] border border-sky-500 text-sky-600 text-sm font-medium px-3 py-2 rounded transition hover:bg-sky-50">ì„±ì·¨ ê¸°ì¤€ ì´ë™</button>
                                        <button id="generate-semester-goals-btn" class="flex-1 min-w-[180px] border border-sky-500 text-sky-600 text-sm font-medium px-3 py-2 rounded transition hover:bg-sky-50">í•™ê¸° êµìœ¡ëª©í‘œ ìƒì„±</button>
                                        <button id="generate-monthly-plan-btn" class="flex-1 min-w-[220px] border border-sky-500 text-sky-600 text-sm font-medium px-3 py-2 rounded transition hover:bg-sky-50 hidden">ì›”ë³„ êµìœ¡ëª©í‘œ/ë‚´ìš©/ë°©ë²• ìƒì„±í•˜ê¸°</button>
                                    </div>
                                </div>
                                <h4 class="font-semibold mb-2">ìˆ˜ì • í…Œì´ë¸”</h4>
                                <div class="mb-3">
                                    <div id="iep-modify-targets" class="flex flex-wrap gap-2"></div>
                                </div>
                                <div class="flex items-start gap-2">
                                    <textarea id="iep-modify-input" class="w-full border rounded-md p-2 text-sm" rows="3" placeholder="ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                                    <button id="iep-modify-btn" class="bg-sky-600 hover:bg-sky-700 text-white text-sm px-3 py-1 rounded h-9">ìˆ˜ì •</button>
                                </div>
                                <div class="mt-2">
                                    <button id="iep-manual-edit-btn" class="border border-sky-500 text-sky-600 text-sm font-medium px-3 py-1 rounded transition hover:bg-sky-50">ìˆ˜ë™ í¸ì§‘</button>
                                </div>
                            </div>
                        </aside>
                        <section class="w-full lg:w-2/3">
                            <div id="iep-output" class="bg-white p-8 rounded-lg shadow-lg overflow-x-auto">
                                <p class="text-gray-500">í•™ìƒì„ ì„ íƒí•˜ë©´ IEP ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                            </div>
                        </section>
                    </div>
                </div>

                <!-- Template Generator View -->
                <div id="templates-view" class="hidden">
                    <h2 class="text-3xl font-bold mb-6">AI ì„œì‹ ìƒì„±</h2>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-bold mb-4">ì¹´í…Œê³ ë¦¬</h3>
                        <div id="template-category-buttons" class="flex flex-wrap gap-3">
                            <button type="button" data-template-category="major-eval" class="tab-btn py-2 px-4 rounded">ì „ê³µê³¼ ì‹¬ì‚¬í‘œ</button>
                        </div>
                    </div>
                    <div id="major-eval-workspace" class="hidden mt-6">
                        <div class="flex flex-col lg:flex-row gap-6">
                            <aside class="w-full lg:w-1/3 bg-white p-6 rounded-lg shadow-lg space-y-6">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-lg font-semibold">ì „ê³µê³¼ ì‹¬ì‚¬í‘œ ëª©ë¡</h3>
                                    <button type="button" id="major-eval-add-btn" class="bg-sky-600 hover:bg-sky-700 text-white text-sm font-semibold px-3 py-2 rounded">ì¶”ê°€</button>
                                </div>
                                <div>
                                    <ul id="major-eval-list" class="space-y-2"></ul>
                                    <p id="major-eval-empty" class="text-sm text-gray-500">ì¶”ê°€ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹¬ì‚¬í‘œë¥¼ ìƒì„±í•´ë³´ì„¸ìš”.</p>
                                </div>
                                <div id="major-eval-input-section" class="hidden space-y-4">
                                    <div>
                                        <h4 class="text-base font-semibold mb-2">ì…ë ¥ í…Œì´ë¸”</h4>
                                        <table class="w-full border border-gray-200 text-sm">
                                            <tbody class="divide-y divide-gray-200">
                                                <tr>
                                                    <th scope="row" class="bg-gray-50 px-3 py-2 text-left font-medium w-28">í•™êµ ì´ë¦„</th>
                                                    <td class="px-3 py-2">
                                                        <input type="text" id="major-eval-school" class="w-full border border-gray-300 rounded-md p-2 text-sm" placeholder="ì˜ˆ: í–‰ë³µí•™êµ">
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th scope="row" class="bg-gray-50 px-3 py-2 text-left font-medium">ì˜ì—­</th>
                                                    <td class="px-3 py-2">
                                                        <input type="text" id="major-eval-domain" class="w-full border border-gray-300 rounded-md p-2 text-sm" placeholder="ì˜ˆ: í˜¸í…” ì„œë¹„ìŠ¤">
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th scope="row" class="bg-gray-50 px-3 py-2 text-left font-medium">ë¬¸í•­ ìˆ˜</th>
                                                    <td class="px-3 py-2">
                                                        <input type="number" id="major-eval-questions" class="w-full border border-gray-300 rounded-md p-2 text-sm" min="1" value="5">
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th scope="row" class="bg-gray-50 px-3 py-2 text-left font-medium">í‰ê°€ ì£¼ì œ</th>
                                                    <td class="px-3 py-2">
                                                        <input type="text" id="major-eval-topic" class="w-full border border-gray-300 rounded-md p-2 text-sm" placeholder="ì˜ˆ: ê°ì‹¤ ì •ë¦¬">
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <button type="button" id="major-eval-generate-btn" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 rounded">ìƒì„±</button>
                                </div>
                                <div id="major-eval-upload-section" class="hidden space-y-2">
                                    <button type="button" id="major-eval-upload-btn" class="inline-flex items-center gap-2 bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm font-semibold px-3 py-2 rounded transition disabled:opacity-60 disabled:cursor-not-allowed">ì˜ˆì‹œ íŒŒì¼ ì—…ë¡œë“œ</button>
                                    <p id="major-eval-upload-info" class="text-xs text-gray-500 hidden"></p>
                                    <input type="file" id="major-eval-upload-input" accept="application/pdf" class="hidden">
                                </div>
                                <div id="major-eval-modify-section" class="hidden space-y-6">
                                    <div class="space-y-3">
                                        <h4 class="text-base font-semibold">ì €ì¥ í…Œì´ë¸”</h4>
                                        <div class="flex flex-wrap items-center gap-2">
                                            <button type="button" id="major-eval-edit-toggle-btn" class="bg-white border border-sky-300 text-sky-600 hover:bg-sky-50 text-sm font-semibold px-3 py-2 rounded transition">í¸ì§‘</button>
                                            <button type="button" id="major-eval-save-btn" class="bg-sky-600 hover:bg-sky-700 text-white text-sm font-semibold px-3 py-2 rounded transition">ì €ì¥</button>
                                            <button type="button" id="major-eval-pdf-btn" class="bg-amber-500 hover:bg-amber-600 text-white text-sm font-semibold px-3 py-2 rounded transition">PDF ì €ì¥</button>
                                        </div>
                                        <p class="text-xs text-gray-500">ìˆ˜ë™ í¸ì§‘ì„ ì™„ë£Œí•œ í›„ ì €ì¥ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ í¸ì§‘ ë‚´ìš©ì´ ìœ ì§€ë©ë‹ˆë‹¤.</p>
                                    </div>
                                    <div class="space-y-3">
                                        <h4 class="text-base font-semibold">ìˆ˜ì • í…Œì´ë¸”</h4>
                                        <p class="text-xs text-gray-500">ìˆ˜ì • ë‚´ìš©ì„ ì…ë ¥í•˜ê³  ì—”í„° ë˜ëŠ” ìˆ˜ì • ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
                                        <textarea id="major-eval-modify-input" class="w-full border border-gray-300 rounded-md p-2 text-sm" rows="4" placeholder="ì˜ˆ: 3ë²ˆ ë¬¸í•­ì„ ë‚œì´ë„ë¥¼ ë‚®ì¶”ì–´ ìˆ˜ì •í•´ì¤˜"></textarea>
                                        <button type="button" id="major-eval-modify-btn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 rounded">ìˆ˜ì •</button>
                                    </div>
                                    <div class="space-y-2">
                                        <div class="flex flex-wrap items-center gap-2">
                                            <input type="number" id="major-eval-question-increase" class="border border-gray-300 rounded-md p-2 text-sm w-20" min="1" value="1">
                                            <button type="button" id="major-eval-question-increase-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white text-sm font-semibold px-3 py-2 rounded transition">ì‹¬ì‚¬í‘œ/ê¸°ë¡ì§€ ë¬¸í•­ ëŠ˜ë¦¬ê¸°</button>
                                        </div>
                                        <p class="text-xs text-gray-500">ì…ë ¥í•œ ìˆ«ìë§Œí¼ ì‹¬ì‚¬í‘œì™€ ê¸°ë¡ì§€ì— ë¹ˆ ë¬¸í•­ì´ ì¶”ê°€ë©ë‹ˆë‹¤.</p>
                                    </div>
                                </div>
                            </aside>
                            <section class="flex-1">
                                <div id="major-eval-output" class="bg-white p-6 rounded-lg shadow-lg min-h-[320px] text-sm text-gray-700">
                                    <p class="text-gray-500">ì™¼ìª½ ëª©ë¡ì—ì„œ ì‹¬ì‚¬í‘œë¥¼ ì„ íƒí•˜ë©´ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>

                <!-- Behavior Intervention View -->

                <div id="behavior-view" class="hidden">
                    <h2 class="text-3xl font-bold mb-6">í–‰ë™ ê¸°ë¡</h2>
                    <div class="flex flex-col lg:flex-row gap-6">
                        <aside class="w-full lg:w-1/3 bg-white p-6 rounded-lg shadow-lg h-fit lg:sticky top-24 space-y-4">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold">ë‚´ í•™ìƒ ëª©ë¡</h3>
                                <button id="refresh-behavior-students" class="text-xs text-sky-600 hover:underline">ìƒˆë¡œê³ ì¹¨</button>
                            </div>
                            <p class="text-sm text-gray-500">í•™ìƒì„ ì„ íƒí•˜ë©´ ì˜¤ë¥¸ìª½ì—ì„œ í–‰ë™ ê¸°ë¡ì„ í™•ì¸í•˜ê³  ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                            <div id="behavior-student-list" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2 max-h-[520px] overflow-y-auto pr-1">
                                <p class="text-sm text-gray-500">í•™ìƒ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
                            </div>
                            <div>
                                <div class="mt-6 flex items-center justify-between">
                                    <h3 class="text-lg font-semibold">ê³µìœ  ê¸°ë¡ ëª©ë¡</h3>
                                    <button id="refresh-shared-behaviors" class="text-xs text-sky-600 hover:underline">ìƒˆë¡œê³ ì¹¨</button>
                                </div>
                                <p class="text-sm text-gray-500">ê³µìœ  ë°›ì€ í–‰ë™ ê¸°ë¡ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                                <div id="behavior-shared-list" class="mt-2 space-y-2 max-h-[320px] overflow-y-auto pr-1">
                                    <p class="text-sm text-gray-500">ê³µìœ  ë°›ì€ í–‰ë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                                </div>
                            </div>
                        </aside>
                        <section class="w-full lg:w-2/3 space-y-6">
                            <div class="bg-white p-6 rounded-lg shadow-lg">
                                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
                                    <div>
                                        <h3 class="text-xl font-bold">í–‰ë™ ê¸°ë¡</h3>
                                        <p id="behavior-selected-student" class="text-sm text-gray-500">í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                                    </div>
                                    <button id="open-behavior-modal" class="inline-flex items-center justify-center gap-2 rounded-lg bg-sky-600 text-white px-4 py-2 text-sm font-semibold shadow-sm hover:bg-sky-700 disabled:cursor-not-allowed disabled:opacity-50">
                                        <span>ì¶”ê°€</span>
                                    </button>
                                </div>
                                <div id="behavior-record-list" class="mt-4 space-y-2">
                                    <p class="text-sm text-gray-500">í•™ìƒì„ ì„ íƒí•˜ë©´ í–‰ë™ ê¸°ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
                                </div>
                            </div>
                            <div id="behavior-detail-panel" class="bg-white p-6 rounded-lg shadow-lg hidden">
                                <div class="flex flex-col gap-2 mb-6">
                                    <div class="flex flex-wrap items-start justify-between gap-2">
                                        <div class="flex flex-wrap items-center gap-2">
                                            <h3 id="behavior-detail-title" class="text-2xl font-bold text-slate-800"></h3>
                                            <span id="behavior-reinforcer-badge" class="hidden rounded-full bg-emerald-100 px-3 py-1 text-xs font-semibold text-emerald-700">ê°•í™”ë¬¼</span>
                                            <span id="behavior-attention-badge" class="hidden rounded-full bg-amber-100 px-3 py-1 text-xs font-semibold text-amber-700">ì£¼ì˜ í† í°</span>
                                        </div>
                                        <button id="behavior-share-btn" class="hidden inline-flex items-center gap-2 rounded-lg border border-sky-200 px-3 py-1.5 text-sm font-semibold text-sky-600 transition hover:bg-sky-50">ê³µìœ </button>
                                    </div>
                                    <p id="behavior-operational-definition" class="text-sm text-gray-600 whitespace-pre-line"></p>
                                </div>
                                <div class="mb-6">
                                    <div class="flex flex-col gap-4 lg:flex-row lg:items-start">
                                        <div class="flex-1">
                                            <h4 class="text-lg font-semibold mb-2">í–‰ë™ ê´€ì°° ê·¸ë˜í”„</h4>
                                            <div class="h-72">
                                                <canvas id="behaviorChart"></canvas>
                                            </div>
                                        </div>
                                        <div class="w-full lg:w-56 rounded-lg border border-slate-200 bg-slate-50 p-4">
                                            <h5 class="text-sm font-semibold text-slate-700 mb-3">ê·¸ë˜í”„ ë³´ê¸°</h5>
                                            <div id="behavior-graph-view-buttons" class="space-y-2">
                                                <button type="button" data-view="hourly" class="graph-view-btn w-full rounded-md border border-sky-200 bg-white px-3 py-2 text-sm font-medium text-sky-600 transition hover:bg-sky-50">ì‹œê°„ë³„</button>
                                                <button type="button" data-view="daily" class="graph-view-btn w-full rounded-md border border-sky-600 bg-sky-600 px-3 py-2 text-sm font-medium text-white transition hover:bg-sky-700">ì¼ë³„</button>
                                                <button type="button" data-view="monthly" class="graph-view-btn w-full rounded-md border border-sky-200 bg-white px-3 py-2 text-sm font-medium text-sky-600 transition hover:bg-sky-50">ì›”ë³„</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between mb-4">
                                    <span class="text-sm font-medium text-gray-700">ê¸°ë¡ ë²„íŠ¼</span>
                                    <button id="log-behavior-btn" class="inline-flex items-center gap-2 rounded-lg bg-emerald-500 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-emerald-600 disabled:opacity-50 disabled:cursor-not-allowed">ê¸°ë¡</button>
                                </div>
                                <div>
                                    <h4 class="text-base font-semibold mb-3">íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë¡</h4>
                                    <ul id="behavior-log-list" class="space-y-2 max-h-64 overflow-y-auto bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm text-slate-700">
                                        <li class="text-gray-500">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</li>
                                    </ul>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
<!-- Achievement Criteria View -->
                <div id="achievement-view" class="hidden">
                    <h2 class="text-3xl font-bold mb-6">ì„±ì·¨ê¸°ì¤€ ê¸°ë¡</h2>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <button id="back-to-class-btn" class="text-sm text-sky-600 hover:underline mb-4">&larr; ë‚´ í•™ê¸‰ìœ¼ë¡œ</button>
                        <h3 id="achievement-student" class="text-xl font-bold mb-4"></h3>
                        <div class="mb-4 space-y-4">
                            <div>
                                <span class="font-semibold mr-2">í•™êµê¸‰</span>
                                <div id="level-buttons" class="inline-flex gap-2">
                                    <button data-value="elementary" class="tab-btn py-1 px-3 rounded active">ì´ˆë“±í•™êµ</button>
                                    <button data-value="middle" class="tab-btn py-1 px-3 rounded">ì¤‘í•™êµ</button>
                                    <button data-value="high" class="tab-btn py-1 px-3 rounded">ê³ ë“±í•™êµ</button>
                                </div>
                            </div>
                            <div>
                                <span class="font-semibold mr-2">êµê³¼</span>
                                <div id="subject-buttons" class="inline-flex gap-2">
                                    <button data-value="korean" class="tab-btn py-1 px-3 rounded active">êµ­ì–´</button>
                                    <button data-value="math" class="tab-btn py-1 px-3 rounded">ìˆ˜í•™</button>
                                </div>
                            </div>
                            <div>
                                <span class="font-semibold mr-2">í•™ë…„(êµ°)</span>
                                <div id="grade-buttons" class="inline-flex gap-2"></div>
                            </div>
                        </div>
                        <button id="save-achievement-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded mb-4">ì €ì¥</button>
                        <div id="achievement-table" class="overflow-x-auto"></div>
                    </div>
                </div>

            </main>
        </div>
        

        <!-- Behavior Entry Modal -->
        <div id="behavior-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 p-4">
            <div class="w-full max-w-md rounded-xl bg-white p-6 shadow-xl">
                <h3 class="text-xl font-semibold text-slate-800">í–‰ë™ ê¸°ë¡ ì¶”ê°€</h3>
                <p class="mt-1 text-sm text-gray-500">ì„ íƒí•œ í•™ìƒì˜ í–‰ë™ ê¸°ë¡ì„ ì¶”ê°€ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <div class="mt-5 space-y-4">
                    <div>
                        <label for="behavior-modal-title" class="block text-sm font-medium text-gray-700">ì œëª©</label>
                        <input id="behavior-modal-title" type="text" class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-200" placeholder="ì˜ˆ: ìˆ˜ì—… ì¤‘ ìë¦¬ ì´íƒˆ">
                    </div>
                    <div class="flex flex-col gap-2 rounded-lg border border-slate-200 p-3 text-sm text-slate-700">
                        <label class="inline-flex items-center gap-2">
                            <input id="behavior-modal-reinforcer" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500">
                            <span>ê°•í™”ë¬¼ ì‚¬ìš©</span>
                        </label>
                        <label class="inline-flex items-center gap-2">
                            <input id="behavior-modal-attention" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-amber-500 focus:ring-amber-400">
                            <span>ì£¼ì˜ í† í° ì‚¬ìš©</span>
                        </label>
                    </div>
                    <div>
                        <label for="behavior-modal-definition" class="block text-sm font-medium text-gray-700">ì¡°ì‘ì  ì •ì˜</label>
                        <textarea id="behavior-modal-definition" rows="4" class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-200" placeholder="í–‰ë™ì„ ê´€ì°° ê°€ëŠ¥í•˜ê²Œ ì„¤ëª…í•´ì£¼ì„¸ìš”."></textarea>
                    </div>
                </div>
                <div class="mt-6 flex items-center justify-end gap-2">
                    <button id="behavior-modal-cancel" type="button" class="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-50">ì·¨ì†Œ</button>
                    <button id="behavior-modal-save" type="button" class="rounded-lg bg-sky-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-sky-700">ì¶”ê°€</button>
                </div>
            </div>
        </div>

        <!-- Behavior Share Modal -->
        <div id="behavior-share-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 p-4">
            <div class="w-full max-w-lg rounded-xl bg-white p-6 shadow-xl">
                <div class="flex items-start justify-between">
                    <div>
                        <h3 class="text-xl font-semibold text-slate-800">í–‰ë™ ê¸°ë¡ ê³µìœ </h3>
                        <p class="mt-1 text-sm text-gray-500">ê³µìœ í•  ì´ìš©ìë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
                    </div>
                    <button id="behavior-share-close" type="button" class="text-2xl font-semibold text-slate-400 hover:text-slate-600">&times;</button>
                </div>
                <div id="behavior-share-user-list" class="mt-5 max-h-72 overflow-y-auto rounded-lg border border-slate-200 p-3 text-sm text-slate-700 space-y-2">
                    <p class="text-sm text-gray-500">ì´ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
                </div>
                <div class="mt-6 flex justify-end gap-2">
                    <button id="behavior-share-cancel" type="button" class="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-50">ì·¨ì†Œ</button>
                    <button id="behavior-share-confirm" type="button" class="rounded-lg bg-sky-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-sky-700">ê³µìœ </button>
                </div>
            </div>
        </div>

        <!-- Behavior Log Note Modal -->
        <div id="behavior-log-note-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 p-4">
            <div class="w-full max-w-lg rounded-xl bg-white p-6 shadow-xl">
                <div class="flex items-start justify-between gap-3">
                    <div>
                        <h3 class="text-xl font-semibold text-slate-800">íŠ¹ì´ ì‚¬í•­ ê¸°ë¡</h3>
                        <p id="behavior-log-note-meta" class="mt-1 text-sm text-gray-500"></p>
                    </div>
                    <button id="behavior-log-note-close" type="button" class="text-2xl font-semibold text-slate-400 hover:text-slate-600">&times;</button>
                </div>
                <div class="mt-5 space-y-3">
                    <div>
                        <label for="behavior-log-note-input" class="block text-sm font-medium text-gray-700">íŠ¹ì´ ì‚¬í•­</label>
                        <textarea id="behavior-log-note-input" rows="4" class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-200" placeholder="íŠ¹ì´ ì‚¬í•­ì„ ê¸°ë¡í•´ì£¼ì„¸ìš”."></textarea>
                    </div>
                </div>
                <div class="mt-6 flex items-center justify-between gap-2">
                    <button id="behavior-log-note-delete" type="button" class="hidden rounded-lg border border-red-200 px-4 py-2 text-sm font-semibold text-red-600 hover:bg-red-50">ê¸°ë¡ ì‚­ì œ</button>
                    <div class="ml-auto flex gap-2">
                        <button id="behavior-log-note-cancel" type="button" class="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-50">ì·¨ì†Œ</button>
                        <button id="behavior-log-note-save" type="button" class="rounded-lg bg-sky-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-sky-700">ì €ì¥</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Major Evaluation Modal -->
        <div id="major-eval-modal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                <h3 class="text-xl font-semibold mb-4">ì „ê³µê³¼ ì‹¬ì‚¬í‘œ ì¶”ê°€</h3>
                <label for="major-eval-modal-title" class="block text-sm font-medium text-gray-700 mb-2">ì œëª©</label>
                <input type="text" id="major-eval-modal-title" class="w-full border border-gray-300 rounded-md p-2 text-sm" placeholder="ì˜ˆ: 2024í•™ë…„ë„ í˜¸í…”ì¡°ë¦¬ ì „í˜•">
                <div class="mt-6 flex justify-end gap-2">
                    <button type="button" id="major-eval-modal-cancel" class="px-4 py-2 rounded border border-gray-300 text-sm font-medium text-gray-600 hover:bg-gray-50">ì·¨ì†Œ</button>
                    <button type="button" id="major-eval-modal-confirm" class="px-4 py-2 rounded bg-sky-600 hover:bg-sky-700 text-white text-sm font-semibold">ì™„ë£Œ</button>
                </div>
            </div>
        </div>

        <!-- Toast Message -->
        <div id="toast" class="fixed bottom-10 right-10 bg-gray-900 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-300">
             ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!
        </div>
    </div>

    <script type="module">
        // Firebase v10 SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, getDocs, doc, getDoc, setDoc, updateDoc, deleteDoc, serverTimestamp, where, orderBy, runTransaction, collectionGroup, deleteField } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref as storageRef, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        const firebaseConfig = {
            // Your web app's Firebase configuration
            apiKey: "AIzaSyDCeJPDQUNi-KmJ9DhkTRIu-9t2PGZCpt0",
            authDomain: "mansungcoin-c6e06.firebaseapp.com",
            projectId: "mansungcoin-c6e06",
            storageBucket: "mansungcoin-c6e06.appspot.com",
            messagingSenderId: "704809284946",
            appId: "1:704809284946:web:54e4788586e6c68de1768b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- DOM Elements ---
        const authView = document.getElementById('auth-view');
        const mainAppView = document.getElementById('main-app-view');
        const loginView = document.getElementById('login-view');
        const studentRegisterView = document.getElementById('student-register-view');
        const teacherRegisterView = document.getElementById('teacher-register-view');
        const studentLoginTab = document.getElementById('student-login-tab');
        const teacherLoginTab = document.getElementById('teacher-login-tab');
        const studentLoginContent = document.getElementById('student-login-content');
        const teacherLoginContent = document.getElementById('teacher-login-content');
        const studentCodeInput = document.getElementById('student-code');
        const teacherEmailInput = document.getElementById('teacher-email');
        const teacherPasswordInput = document.getElementById('teacher-password');
        const studentLoginError = document.getElementById('student-login-error');
        const teacherLoginError = document.getElementById('teacher-login-error');
        const studentNameInput = document.getElementById('student-name');
        const studentRegisterError = document.getElementById('student-register-error');
        const teacherRegisterNameInput = document.getElementById('teacher-register-name');
        const teacherRegisterEmailInput = document.getElementById('teacher-register-email');
        const teacherRegisterPasswordInput = document.getElementById('teacher-register-password');
        const teacherRegisterError = document.getElementById('teacher-register-error');
        const studentLoginBtn = document.getElementById('student-login-btn');
        const teacherLoginBtn = document.getElementById('teacher-login-btn');
        const teacherGoogleLoginBtn = document.getElementById('teacher-google-login-btn');
        const showStudentRegisterBtn = document.getElementById('show-student-register-btn');
        const showTeacherRegisterBtn = document.getElementById('show-teacher-register-btn');
        const backToLoginBtn = document.getElementById('back-to-login-btn');
        const teacherBackToLoginBtn = document.getElementById('teacher-back-to-login-btn');
        const studentRegisterBtn = document.getElementById('student-register-btn');
        const teacherRegisterBtn = document.getElementById('teacher-register-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailSpan = document.getElementById('user-email');
        const homeBehaviorTable = document.getElementById('home-behavior-table');
        const homeBehaviorRefreshBtn = document.getElementById('home-behavior-refresh');
        const sketchbookListEl = document.getElementById('sketchbook-list');
        const behaviorSketchbookListEl = document.getElementById('behavior-sketchbook-list');
        const createSketchButtons = Array.from(document.querySelectorAll('[data-action="create-sketch"]'));
        const sketchbookListContainers = [sketchbookListEl, behaviorSketchbookListEl].filter(Boolean);

        function setSketchbookListMessage(html) {
            sketchbookListContainers.forEach(container => {
                container.innerHTML = html;
            });
        }
        const toast = document.getElementById('toast');
        const levelButtons = document.getElementById('level-buttons');
        const subjectButtons = document.getElementById('subject-buttons');
        const gradeButtons = document.getElementById('grade-buttons');
        const saveAchievementBtn = document.getElementById('save-achievement-btn');
        const achievementTableContainer = document.getElementById('achievement-table');
        const backToClassBtn = document.getElementById('back-to-class-btn');
        const templateCategoryButtons = document.getElementById('template-category-buttons');
        const majorEvalWorkspace = document.getElementById('major-eval-workspace');
        const majorEvalAddBtn = document.getElementById('major-eval-add-btn');
        const majorEvalList = document.getElementById('major-eval-list');
        const majorEvalEmpty = document.getElementById('major-eval-empty');
        const majorEvalInputSection = document.getElementById('major-eval-input-section');
        const majorEvalModifySection = document.getElementById('major-eval-modify-section');
        const majorEvalOutput = document.getElementById('major-eval-output');
        const majorEvalSchoolInput = document.getElementById('major-eval-school');
        const majorEvalDomainInput = document.getElementById('major-eval-domain');
        const majorEvalQuestionsInput = document.getElementById('major-eval-questions');
        const majorEvalTopicInput = document.getElementById('major-eval-topic');
        const majorEvalGenerateBtn = document.getElementById('major-eval-generate-btn');
        const majorEvalModifyInput = document.getElementById('major-eval-modify-input');
        const majorEvalModifyBtn = document.getElementById('major-eval-modify-btn');
        const majorEvalUploadSection = document.getElementById('major-eval-upload-section');
        const majorEvalUploadBtn = document.getElementById('major-eval-upload-btn');
        const majorEvalUploadInput = document.getElementById('major-eval-upload-input');
        const majorEvalUploadInfo = document.getElementById('major-eval-upload-info');
        const majorEvalEditToggleBtn = document.getElementById('major-eval-edit-toggle-btn');
        const majorEvalSaveBtn = document.getElementById('major-eval-save-btn');
        const majorEvalPdfBtn = document.getElementById('major-eval-pdf-btn');
        const majorEvalQuestionIncreaseInput = document.getElementById('major-eval-question-increase');
        const majorEvalQuestionIncreaseBtn = document.getElementById('major-eval-question-increase-btn');
        const majorEvalModal = document.getElementById('major-eval-modal');
        const majorEvalModalTitle = document.getElementById('major-eval-modal-title');
        const majorEvalModalCancel = document.getElementById('major-eval-modal-cancel');
        const majorEvalModalConfirm = document.getElementById('major-eval-modal-confirm');
        let currentAchievementStudent = '';
        let currentAchievementData = {};

        // Views and Navs
        const views = {
            home: document.getElementById('home-view'),
            'my-class': document.getElementById('my-class-view'),
            sketchbook: document.getElementById('sketchbook-view'),
            iep: document.getElementById('iep-view'),
            templates: document.getElementById('templates-view'),
            behavior: document.getElementById('behavior-view'),
            achievement: document.getElementById('achievement-view'),
        };
        const navLinkElements = Array.from(document.querySelectorAll('a.nav-link[data-view]'));
        const navLinks = navLinkElements.reduce((acc, link) => {
            const viewName = link.dataset.view;
            if (!viewName) return acc;
            if (!acc[viewName]) acc[viewName] = [];
            acc[viewName].push(link);
            return acc;
        }, {});
        
        let statsChartInstance = null;
        let behaviorChartInstance = null;
        let currentUserProfile = null;
        let isLoadingHomeData = false;
        let isLoadingHomeBehaviors = false;
        let isLoadingSketchbooks = false;
        let homeBehaviorEntries = [];
        const MAJOR_EVAL_STORAGE_KEY = 'aiedue:major-eval:entries:v1';
        const MAJOR_EVAL_ACTIVE_STORAGE_KEY = 'aiedue:major-eval:active';
        const PDFJS_WORKER_SRC = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        let majorEvalEntries = [];
        let activeMajorEvalId = '';
        let activeTemplateCategory = '';
        let isMajorEvalGenerating = false;
        let isMajorEvalModifying = false;
        let isMajorEvalUploading = false;
        let isMajorEvalManualEditing = false;
        let majorEvalManualNode = null;
        let hasMajorEvalManualDraft = false;
        let majorEvalManualDraftHtml = '';

        if (typeof window !== 'undefined' && typeof pdfjsLib !== 'undefined' && pdfjsLib.GlobalWorkerOptions) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = PDFJS_WORKER_SRC;
        }

        // --- AUTHENTICATION ---
        const authSections = {
            login: loginView,
            studentRegister: studentRegisterView,
            teacherRegister: teacherRegisterView,
        };

        const showAuthView = (view) => {
            Object.values(authSections).forEach(section => section && section.classList.remove('active'));
            if (authSections[view]) {
                authSections[view].classList.add('active');
            }
        };

        const showError = (element, message) => {
            if (!element) return;
            if (message) {
                element.textContent = message;
                element.classList.remove('hidden');
            } else {
                element.textContent = '';
                element.classList.add('hidden');
            }
        };

        const clearAuthMessages = () => {
            showError(studentLoginError, '');
            showError(teacherLoginError, '');
            showError(studentRegisterError, '');
            showError(teacherRegisterError, '');
        };

        const switchLoginTab = (tabName) => {
            [studentLoginTab, teacherLoginTab].forEach(tab => tab && tab.classList.remove('active'));
            [studentLoginContent, teacherLoginContent].forEach(content => content && content.classList.remove('active'));

            if (tabName === 'teacher') {
                if (teacherLoginTab) teacherLoginTab.classList.add('active');
                if (teacherLoginContent) teacherLoginContent.classList.add('active');
            } else {
                if (studentLoginTab) studentLoginTab.classList.add('active');
                if (studentLoginContent) studentLoginContent.classList.add('active');
            }

            clearAuthMessages();
        };

        if (studentLoginTab) {
            studentLoginTab.addEventListener('click', () => switchLoginTab('student'));
        }
        if (teacherLoginTab) {
            teacherLoginTab.addEventListener('click', () => switchLoginTab('teacher'));
        }

        if (showStudentRegisterBtn) {
            showStudentRegisterBtn.addEventListener('click', () => {
                clearAuthMessages();
                showAuthView('studentRegister');
            });
        }

        if (showTeacherRegisterBtn) {
            showTeacherRegisterBtn.addEventListener('click', () => {
                clearAuthMessages();
                showAuthView('teacherRegister');
            });
        }

        if (backToLoginBtn) {
            backToLoginBtn.addEventListener('click', () => {
                showAuthView('login');
                switchLoginTab('student');
            });
        }

        if (teacherBackToLoginBtn) {
            teacherBackToLoginBtn.addEventListener('click', () => {
                showAuthView('login');
                switchLoginTab('teacher');
            });
        }

        if (studentRegisterBtn) {
            studentRegisterBtn.addEventListener('click', async () => {
                clearAuthMessages();
                const name = studentNameInput.value.trim();
                if (!name) {
                    showError(studentRegisterError, 'ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                try {
                    const counterRef = doc(db, 'metadata', 'counters');
                    const newCode = await runTransaction(db, async (transaction) => {
                        const counterDoc = await transaction.get(counterRef);
                        let nextCode = 1;
                        if (counterDoc.exists() && counterDoc.data().lastUserCode) {
                            nextCode = counterDoc.data().lastUserCode + 1;
                        }
                        transaction.set(counterRef, { lastUserCode: nextCode }, { merge: true });
                        return nextCode;
                    });

                    const email = `${newCode}@abc.com`;
                    const password = `${newCode}qwerty`;

                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);

                    await setDoc(doc(db, 'users', userCredential.user.uid), {
                        uid: userCredential.user.uid,
                        name: name,
                        email: email,
                        userCode: newCode,
                        role: 'student',
                        coins: 0,
                        balance: 0,
                        portfolio: {},
                        aeduExperience: 0,
                        aeduLevel: 1,
                        warningTokens: 0,
                        createdAt: serverTimestamp()
                    });

                    await addDoc(collection(db, 'signupLog'), {
                        name: name,
                        userCode: newCode,
                        role: 'student',
                        signedUpAt: serverTimestamp()
                    });

                    studentNameInput.value = '';
                    alert(`í™˜ì˜í•©ë‹ˆë‹¤, ${name} í•™ìƒ!\në‹¹ì‹ ì˜ ê³ ìœ  ì½”ë“œëŠ” ${newCode} ì…ë‹ˆë‹¤.\nì´ ì½”ë“œë¥¼ ê¼­ ê¸°ì–µí•˜ê³  ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.`);
                    showAuthView('login');
                    switchLoginTab('student');
                } catch (error) {
                    console.error('Student registration error:', error);
                    if (error.code === 'auth/email-already-in-use') {
                        showError(studentRegisterError, 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ê³„ì • ì •ë³´ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì½”ë“œë¥¼ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    } else {
                        showError(studentRegisterError, 'í•™ìƒ ë“±ë¡ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                }
            });
        }

        if (teacherRegisterBtn) {
            teacherRegisterBtn.addEventListener('click', async () => {
                clearAuthMessages();
                const name = teacherRegisterNameInput.value.trim();
                const email = teacherRegisterEmailInput.value.trim();
                const password = teacherRegisterPasswordInput.value;

                if (!name || !email || !password) {
                    showError(teacherRegisterError, 'ì´ë¦„, ì´ë©”ì¼, ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);

                    await setDoc(doc(db, 'users', userCredential.user.uid), {
                        uid: userCredential.user.uid,
                        name,
                        email,
                        role: 'teacher',
                        userCode: null,
                        coins: 0,
                        balance: 0,
                        portfolio: {},
                        aeduTokens: 0,
                        aeduExperience: 0,
                        aeduLevel: 1,
                        warningTokens: 0,
                        createdAt: serverTimestamp()
                    }, { merge: true });

                    await addDoc(collection(db, 'signupLog'), {
                        name,
                        email,
                        role: 'teacher',
                        signedUpAt: serverTimestamp()
                    });

                    teacherRegisterNameInput.value = '';
                    teacherRegisterEmailInput.value = '';
                    teacherRegisterPasswordInput.value = '';
                    alert(`í™˜ì˜í•©ë‹ˆë‹¤, ${name} ì„ ìƒë‹˜!\nì´ì œ êµì‚¬ìš© ê¸°ëŠ¥ì„ ì´ìš©í•´ë³´ì„¸ìš”.`);
                    showAuthView('login');
                    switchLoginTab('teacher');
                } catch (error) {
                    console.error('Teacher registration error:', error);
                    if (error.code === 'auth/email-already-in-use') {
                        showError(teacherRegisterError, 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë©”ì¼ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
                    } else if (error.code === 'auth/invalid-email') {
                        showError(teacherRegisterError, 'ìœ íš¨í•œ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    } else if (error.code === 'auth/weak-password') {
                        showError(teacherRegisterError, 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                    } else {
                        showError(teacherRegisterError, 'êµì‚¬ íšŒì›ê°€ì… ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    }
                }
            });
        }

        if (studentLoginBtn) {
            studentLoginBtn.addEventListener('click', async () => {
                clearAuthMessages();
                const codeInput = studentCodeInput.value.trim();

                const normalizedCode = codeInput.replace(/[\uFF10-\uFF19]/g, (m) => String.fromCharCode(m.charCodeAt(0) - 0xFEE0));

                if (!normalizedCode || !/^\d+$/.test(normalizedCode)) {
                    showError(studentLoginError, 'ìœ íš¨í•œ ìˆ«ì ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                const codeAsInt = parseInt(normalizedCode, 10);
                const email = `${codeAsInt}@abc.com`;
                const password = `${codeAsInt}qwerty`;

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error('Student login error:', error);
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                        showError(studentLoginError, 'ê³ ìœ  ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•Šê±°ë‚˜ í•´ë‹¹ í•™ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    } else if (error.code === 'permission-denied') {
                        showError(studentLoginError, 'ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì—¬ Firestore ë³´ì•ˆ ê·œì¹™ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    } else {
                        showError(studentLoginError, `ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                    }
                }
            });
        }

        if (teacherLoginBtn) {
            teacherLoginBtn.addEventListener('click', async () => {
                clearAuthMessages();
                const email = teacherEmailInput.value.trim();
                const password = teacherPasswordInput.value;
                if (!email || !password) {
                    showError(teacherLoginError, 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    showError(teacherLoginError, 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            });
        }

        if (teacherGoogleLoginBtn) {
            teacherGoogleLoginBtn.addEventListener('click', async () => {
                clearAuthMessages();
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    showError(teacherLoginError, 'Google ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            });
        }

        logoutBtn.addEventListener('click', () => signOut(auth));

        showAuthView('login');
        switchLoginTab('student');

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserProfile = null;
                teacherDirectoryLoaded = false;
                teacherDirectory = [];
                ensureCurrentUserProfile();
                authView.classList.add('hidden');
                mainAppView.classList.remove('hidden');
                mainAppView.classList.add('flex');
                if (userEmailSpan) userEmailSpan.textContent = user.email;
                const currentView = window.location.hash.replace('#', '') || 'home';
                switchView(currentView).catch(console.error);
            } else {
                currentUserProfile = null;
                authView.classList.remove('hidden');
                mainAppView.classList.add('hidden');
                mainAppView.classList.remove('flex');
                showAuthView('login');
                switchLoginTab('student');
                clearAuthMessages();
                if (studentCodeInput) studentCodeInput.value = '';
                if (teacherEmailInput) teacherEmailInput.value = '';
                if (teacherPasswordInput) teacherPasswordInput.value = '';
                if (sketchbookListContainers.length) {
                    setSketchbookListMessage('<li class="text-sm text-gray-500">ìŠ¤ì¼€ì¹˜ë¶ì„ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</li>');
                }
            }
        });

        // --- NAVIGATION ---
        const switchView = async (view) => {
            Object.values(views).forEach(v => v.classList.add('hidden'));
            navLinkElements.forEach(link => link.classList.remove('active'));
            if (views[view]) {
                views[view].classList.remove('hidden');
                if (navLinks[view]) {
                    navLinks[view].forEach(link => link.classList.add('active'));
                }
                window.location.hash = view;

                // Load data for the activated view
                if (view === 'home') {
                    await loadHomeData();
                } else if (view === 'my-class') {
                    await loadClasses();
                } else if (view === 'sketchbook') {
                    await renderSketchbookList();
                } else if (view === 'iep') {
                    loadIepStudents();
                    if (iepOutputContainer) {
                        iepOutputContainer.innerHTML = '<p class="text-gray-500">í•™ìƒì„ ì„ íƒí•˜ë©´ IEP ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>';
                    }
                } else if (view === 'templates') {
                    activateTemplateCategory('major-eval');
                } else if (view === 'behavior') {
                    await prepareBehaviorView();
                } else {
                    closeBehaviorShareModal();
                    closeBehaviorLogNoteModal();
                }

            } else { // Fallback to home
                views.home.classList.remove('hidden');
                if (navLinks.home) {
                    navLinks.home.forEach(link => link.classList.add('active'));
                }
                window.location.hash = 'home';
                await loadHomeData();
                closeBehaviorShareModal();
                closeBehaviorLogNoteModal();
            }
        };

        navLinkElements.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetView = link.dataset.view;
                if (targetView) {
                    switchView(targetView).catch(console.error);
                }
            });
        });
        document.getElementById('home-link').addEventListener('click', (e) => {
             e.preventDefault();
             switchView('home').catch(console.error);
        });

        backToClassBtn.addEventListener('click', () => switchView('my-class').catch(console.error));

        levelButtons.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', () => {
                setActiveButton(levelButtons, btn.dataset.value);
                updateGradeButtons();
                loadAchievementTable();
            });
        });

        subjectButtons.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', () => {
                setActiveButton(subjectButtons, btn.dataset.value);
                loadAchievementTable();
            });
        });

        saveAchievementBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) return;
            const table = achievementTableContainer.querySelector('table');
            if (!table) return;
            const rows = table.querySelectorAll('tbody tr');
            const states = Array.from(rows).map(tr => {
                // Firestore does not support nested arrays, so store each row as an object
                const rowObj = {};
                for (let i = 1; i < tr.cells.length; i++) {
                    const btn = tr.cells[i].querySelector('button');
                    rowObj[i - 1] = parseInt(btn.dataset.state || '0');
                }
                return rowObj;
            });
            const key = `${getActiveValue(levelButtons)}_${getActiveValue(subjectButtons)}`;
            currentAchievementData[key] = states;
            try {
                await setDoc(doc(db, 'users', user.uid, 'achievements', currentAchievementStudent), {
                    data: currentAchievementData
                }, { merge: true });
                showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
            } catch (e) {
                console.error('Error saving achievement data', e);
            }
        });

        // --- Home View Logic ---
        async function loadHomeData() {
            const user = auth.currentUser;
            if (!user || isLoadingHomeData) return;
            isLoadingHomeData = true;
            loadHomeBehaviorOverview();
            try {
                const classRef = doc(db, 'classes', user.uid);
                const iepsRef = collection(db, 'users', user.uid, 'ieps');

                const [classSnap, iepSnap] = await Promise.all([getDoc(classRef), getDocs(iepsRef)]);

                const statsData = {
                    labels: ['í•™ê¸‰', 'IEP'],
                    datasets: [{
                        label: 'ì—…ë¬´ ìˆ˜',
                        data: [classSnap.exists() ? 1 : 0, iepSnap.size],
                        backgroundColor: ['#38bdf8', '#fbbf24'],
                        hoverOffset: 4
                    }]
                };
            updateChart('statsChart', 'statsChartInstance', 'doughnut', statsData, {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            });
        } catch (error) {
            console.error(error);
        } finally {
            isLoadingHomeData = false;
        }

        }

        async function loadHomeBehaviorOverview(options = {}) {
            const { showLoader = true, force = false } = options;
            const user = auth.currentUser;
            if (!user || !homeBehaviorTable) return;
            if (isLoadingHomeBehaviors && !force) return;
            isLoadingHomeBehaviors = true;
            if (showLoader) {
                homeBehaviorTable.innerHTML = '<p class="text-sm text-gray-500">í–‰ë™ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>';
            }
            try {
                const behaviorsRef = collection(db, 'users', user.uid, 'behaviors');
                const [behaviorSnapshot] = await Promise.all([
                    getDocs(behaviorsRef),
                    loadSharedBehaviors()
                ]);

                const personalEntries = behaviorSnapshot.docs.map(docSnap => {
                    const data = docSnap.data() || {};
                    const createdAt = data.updatedAt?.toMillis?.() || data.createdAt?.toMillis?.() || 0;
                    return {
                        id: docSnap.id,
                        ownerId: user.uid,
                        studentId: data.studentId || '',
                        studentName: data.studentName || data.studentId || '',
                        title: data.title || '',
                        operationalDefinition: data.operationalDefinition || '',
                        useReinforcer: !!data.useReinforcer,
                        useAttentionToken: !!data.useAttentionToken,
                        sortTime: createdAt,
                        source: 'mine'
                    };
                });

                const sharedEntries = sharedBehaviorEntries.map(entry => ({
                    id: entry.id,
                    ownerId: entry.ownerId,
                    studentId: entry.studentId || '',
                    studentName: entry.studentName || entry.studentId || '',
                    title: entry.title || '',
                    operationalDefinition: entry.operationalDefinition || '',
                    useReinforcer: !!entry.useReinforcer,
                    useAttentionToken: !!entry.useAttentionToken,
                    sortTime: entry.sharedAt?.toMillis?.() || entry.createdAt?.toMillis?.() || 0,
                    source: 'shared'
                }));

                homeBehaviorEntries = [...personalEntries, ...sharedEntries].sort((a, b) => (b.sortTime || 0) - (a.sortTime || 0));
                renderHomeBehaviorTable();
            } catch (error) {
                console.error('Failed to load home behavior overview', error);
                homeBehaviorEntries = [];
                if (homeBehaviorTable) {
                    homeBehaviorTable.innerHTML = '<p class="text-sm text-red-500">í–‰ë™ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>';
                }
            } finally {
                isLoadingHomeBehaviors = false;
            }
        }

        function renderHomeBehaviorTable() {
            if (!homeBehaviorTable) return;
            homeBehaviorTable.innerHTML = '';
            if (!homeBehaviorEntries.length) {
                homeBehaviorTable.innerHTML = '<p class="text-sm text-gray-500">ì•„ì§ ë“±ë¡ëœ í–‰ë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. í–‰ë™ ê¸°ë¡ íƒ­ì—ì„œ ìƒˆë¡œìš´ í–‰ë™ì„ ì¶”ê°€í•´ë³´ì„¸ìš”.</p>';
                return;
            }

            homeBehaviorEntries.forEach((entry, index) => {
                const container = document.createElement('div');
                container.className = 'rounded-xl border border-slate-200 bg-slate-50 p-3';

                const badges = [];
                if (entry.source === 'shared') {
                    badges.push('<span class="rounded-full bg-indigo-100 px-2 py-0.5 text-[0.65rem] font-semibold text-indigo-600">ê³µìœ </span>');
                }
                if (entry.useReinforcer) {
                    badges.push('<span class="rounded-full bg-emerald-100 px-2 py-0.5 text-[0.65rem] font-semibold text-emerald-700">ê°•í™”ë¬¼</span>');
                }
                if (entry.useAttentionToken) {
                    badges.push('<span class="rounded-full bg-amber-100 px-2 py-0.5 text-[0.65rem] font-semibold text-amber-700">ì£¼ì˜ í† í°</span>');
                }

                const studentLabel = escapeHtml(entry.studentName || 'í•™ìƒ ë¯¸í™•ì¸');
                const behaviorLabel = escapeHtml(entry.title || 'í–‰ë™ ê¸°ë¡');
                const definitionLine = (entry.operationalDefinition || '').split('\n').map(line => line.trim()).find(Boolean) || 'ì¡°ì‘ì  ì •ì˜ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
                const definition = escapeHtml(definitionLine);
                const badgesHtml = badges.length ? `<div class="mt-2 flex flex-wrap items-center gap-1">${badges.join('')}</div>` : '';

                container.innerHTML = `
                    <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:gap-4">
                        <div class="flex-1 min-w-0">
                            <p class="font-semibold text-slate-800 break-words">${studentLabel}</p>
                            <p class="text-sm text-slate-600 break-words">${behaviorLabel}</p>
                            ${badgesHtml}
                            <p class="mt-2 text-xs text-slate-500 break-words">${definition}</p>
                        </div>
                        <div class="flex items-center gap-2 sm:flex-col sm:items-stretch sm:w-36">
                            <button type="button" class="w-full rounded-md border border-sky-200 bg-white px-3 py-2 text-center text-xs font-semibold text-sky-600 transition hover:bg-sky-50" data-entry-index="${index}" data-action="view">ì´ë™</button>
                            <button type="button" class="w-full rounded-md bg-emerald-500 px-3 py-2 text-center text-xs font-semibold text-white shadow-sm transition hover:bg-emerald-600" data-entry-index="${index}" data-action="log">ê¸°ë¡</button>
                        </div>
                    </div>
                `;

                homeBehaviorTable.appendChild(container);
            });
        }

        function generateUniqueSketchCode(existingCodes = new Set()) {
            const characters = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            const codeLength = 6;
            const codes = existingCodes instanceof Set ? existingCodes : new Set(existingCodes);
            let code = '';
            do {
                code = Array.from({ length: codeLength }, () => characters[Math.floor(Math.random() * characters.length)]).join('');
            } while (codes.has(code));
            return code;
        }

        function createSketchbookListItem(sketch) {
            const li = document.createElement('li');
            li.className = 'p-3 bg-white rounded border border-slate-200 shadow-sm flex items-center justify-between gap-4';

            const infoBtn = document.createElement('button');
            infoBtn.type = 'button';
            infoBtn.className = 'flex-1 text-left';
            const sketchName = escapeHtml(sketch.name || 'ìƒˆ ìŠ¤ì¼€ì¹˜ë¶');
            const sketchCode = escapeHtml(sketch.code || 'ìƒì„± ì¤‘');
            infoBtn.innerHTML = `
                <div class="font-semibold text-slate-800">${sketchName}</div>
                <div class="text-xs text-slate-500 mt-1">ì½”ë“œ: ${sketchCode}</div>
            `;
            infoBtn.addEventListener('click', () => {
                window.open(`sketch.html?sketchId=${encodeURIComponent(sketch.id)}&code=${encodeURIComponent(sketch.code || '')}`, '_blank');
            });
            li.appendChild(infoBtn);

            const buttonGroup = document.createElement('div');
            buttonGroup.className = 'flex items-center gap-3';

            const renameBtn = document.createElement('button');
            renameBtn.type = 'button';
            renameBtn.className = 'text-sm text-sky-600 hover:underline';
            renameBtn.textContent = 'ì´ë¦„ ë³€ê²½';
            renameBtn.addEventListener('click', async (event) => {
                event.preventDefault();
                const user = auth.currentUser;
                if (!user) return;
                const newName = prompt('ìƒˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', sketch.name || 'ìƒˆ ìŠ¤ì¼€ì¹˜ë¶');
                if (!newName) return;
                try {
                    await updateDoc(doc(db, 'users', user.uid, 'sketches', sketch.id), { name: newName });
                    await renderSketchbookList();
                } catch (error) {
                    console.error('Failed to rename sketchbook', error);
                    alert('ìŠ¤ì¼€ì¹˜ë¶ ì´ë¦„ì„ ë³€ê²½í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            });
            buttonGroup.appendChild(renameBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'text-sm text-red-500 hover:underline';
            deleteBtn.textContent = 'ì‚­ì œ';
            deleteBtn.addEventListener('click', async (event) => {
                event.preventDefault();
                const user = auth.currentUser;
                if (!user) return;
                if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                try {
                    await deleteDoc(doc(db, 'users', user.uid, 'sketches', sketch.id));
                    try {
                        await deleteObject(storageRef(storage, `sketch/${user.uid}/${sketch.id}.excalidraw`));
                    } catch (storageError) {
                        if (storageError?.code !== 'storage/object-not-found') {
                            console.error('Failed to delete sketch file', storageError);
                        }
                    }
                    await renderSketchbookList();
                } catch (error) {
                    console.error('Failed to delete sketchbook', error);
                    alert('ìŠ¤ì¼€ì¹˜ë¶ì„ ì‚­ì œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            });
            buttonGroup.appendChild(deleteBtn);

            li.appendChild(buttonGroup);
            return li;
        }

        async function renderSketchbookList() {
            const user = auth.currentUser;
            if (!user || !sketchbookListContainers.length) return;
            if (isLoadingSketchbooks) return;
            isLoadingSketchbooks = true;
            setSketchbookListMessage('<li class="p-3 text-sm text-gray-500">ìŠ¤ì¼€ì¹˜ë¶ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</li>');
            try {
                const snap = await getDocs(collection(db, 'users', user.uid, 'sketches'));
                const sketches = [];
                const existingCodes = new Set();

                snap.forEach(docSnap => {
                    const data = docSnap.data() || {};
                    if (data.code) existingCodes.add(data.code);
                    sketches.push({ id: docSnap.id, ...data });
                });

                for (const sketch of sketches) {
                    if (!sketch.code) {
                        const newCode = generateUniqueSketchCode(existingCodes);
                        existingCodes.add(newCode);
                        try {
                            await updateDoc(doc(db, 'users', user.uid, 'sketches', sketch.id), { code: newCode });
                        } catch (error) {
                            console.error('Failed to assign sketch code', error);
                        }
                        sketch.code = newCode;
                    }
                }

                if (!sketches.length) {
                    sketchbookListContainers.forEach(container => {
                        container.innerHTML = '';
                        const emptyMessage = document.createElement('li');
                        emptyMessage.className = 'p-4 bg-slate-50 rounded text-center text-sm text-gray-500 border border-dashed border-slate-200';
                        emptyMessage.textContent = 'ì•„ì§ ë§Œë“  ìŠ¤ì¼€ì¹˜ë¶ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ìŠ¤ì¼€ì¹˜ë¶ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!';
                        container.appendChild(emptyMessage);
                    });
                    return;
                }

                sketches.sort((a, b) => {
                    const timeA = a.createdAt?.toMillis?.() || 0;
                    const timeB = b.createdAt?.toMillis?.() || 0;
                    return timeB - timeA;
                });

                sketchbookListContainers.forEach(container => {
                    container.innerHTML = '';
                    sketches.forEach(sketch => {
                        container.appendChild(createSketchbookListItem(sketch));
                    });
                });
            } catch (error) {
                console.error('Failed to load sketchbooks', error);
                setSketchbookListMessage('<li class="p-3 text-sm text-red-500">ìŠ¤ì¼€ì¹˜ë¶ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</li>');
            } finally {
                isLoadingSketchbooks = false;
            }
        }

        async function logBehaviorFromHome(entry) {
            const user = auth.currentUser;
            if (!user) return;
            if (!entry?.id) {
                alert('í–‰ë™ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }
            try {
                const recorderName = await getRecorderDisplayName();
                const ownerId = entry.ownerId || user.uid;
                await addDoc(collection(db, 'users', ownerId, 'behaviors', entry.id, 'logs'), {
                    timestamp: serverTimestamp(),
                    recordedBy: user.uid,
                    recordedByName: recorderName
                });
                const title = entry.title || 'í–‰ë™';
                showToast(`${title}ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                if (currentBehaviorEntry && currentBehaviorEntry.id === entry.id) {
                    const expectedOwnerId = currentBehaviorOwnerId || user.uid;
                    if (expectedOwnerId === ownerId) {
                        loadBehaviorLogs(entry.id, ownerId);
                    }
                }
            } catch (error) {
                console.error('Failed to record behavior log from home', error);
                alert('í–‰ë™ì„ ê¸°ë¡í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        async function handleHomeBehaviorAction(entryIndex, action = 'view') {
            const entry = homeBehaviorEntries[entryIndex];
            if (!entry) return;

            if (action === 'log') {
                await logBehaviorFromHome(entry);
                return;
            }

            try {
                if (entry.source === 'mine') {
                    currentBehaviorStudentId = entry.studentId || '';
                } else {
                    currentBehaviorStudentId = '';
                }

                await switchView('behavior');

                if (entry.source === 'mine') {
                    if (!entry.studentId) {
                        showToast('í•™ìƒ ì •ë³´ê°€ ì—†ëŠ” í–‰ë™ ê¸°ë¡ì…ë‹ˆë‹¤.');
                        return;
                    }
                    const student = behaviorStudents.find(s => s.id === entry.studentId);
                    if (behaviorSelectedStudentLabel) {
                        behaviorSelectedStudentLabel.textContent = `${student?.name || 'í•™ìƒ'} í•™ìƒ`;
                    }
                    await loadBehaviorEntries(entry.studentId, entry.id);
                } else {
                    await loadSharedBehaviors();
                    const sharedEntry = sharedBehaviorEntries.find(item => item.id === entry.id && item.ownerId === entry.ownerId);
                    if (!sharedEntry) {
                        showToast('ê³µìœ  ë°›ì€ í–‰ë™ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                        return;
                    }
                    selectBehaviorEntry(sharedEntry.id, { entry: sharedEntry, ownerId: sharedEntry.ownerId, source: 'shared' });
                    if (behaviorSelectedStudentLabel) {
                        const displayName = sharedEntry.studentName || sharedEntry.studentId || 'í•™ìƒ';
                        behaviorSelectedStudentLabel.textContent = `${displayName} í•™ìƒ (ê³µìœ )`;
                    }
                    updateSharedBehaviorActiveState();
                    updateBehaviorActionState();
                }
            } catch (error) {
                console.error('Failed to open behavior entry from home', error);
            }
        }

        homeBehaviorRefreshBtn?.addEventListener('click', () => {
            loadHomeBehaviorOverview({ force: true });
        });

        function setCreateSketchButtonsDisabled(disabled) {
            createSketchButtons.forEach(btn => {
                btn.disabled = disabled;
                btn.classList.toggle('opacity-50', disabled);
                btn.classList.toggle('cursor-not-allowed', disabled);
            });
        }

        createSketchButtons.forEach(button => {
            button.addEventListener('click', async () => {
                const user = auth.currentUser;
                if (!user || button.disabled) return;
                setCreateSketchButtonsDisabled(true);
                try {
                    const snap = await getDocs(collection(db, 'users', user.uid, 'sketches'));
                    const existingCodes = new Set();
                    snap.forEach(docSnap => {
                        const data = docSnap.data() || {};
                        if (data.code) existingCodes.add(data.code);
                    });
                    const newCode = generateUniqueSketchCode(existingCodes);
                    const docRef = await addDoc(collection(db, 'users', user.uid, 'sketches'), {
                        name: 'ìƒˆ ìŠ¤ì¼€ì¹˜ë¶',
                        createdAt: serverTimestamp(),
                        code: newCode
                    });
                    await renderSketchbookList();
                    window.open(`sketch.html?sketchId=${encodeURIComponent(docRef.id)}&code=${encodeURIComponent(newCode)}`, '_blank');
                } catch (error) {
                    console.error('Failed to create sketchbook', error);
                    alert('ìŠ¤ì¼€ì¹˜ë¶ì„ ë§Œë“¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                } finally {
                    setCreateSketchButtonsDisabled(false);
                }
            });
        });

        homeBehaviorTable?.addEventListener('click', async (event) => {
            const button = event.target.closest('button[data-entry-index]');
            if (!button) return;
            const index = Number(button.dataset.entryIndex);
            if (Number.isNaN(index)) return;
            const action = button.dataset.action || 'view';
            const shouldDisable = action === 'log';
            if (shouldDisable) {
                button.disabled = true;
                button.classList.add('opacity-50', 'cursor-not-allowed');
            }
            try {
                await handleHomeBehaviorAction(index, action);
            } finally {
                if (shouldDisable) {
                    button.disabled = false;
                    button.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
        });

        // --- My Class View Logic ---
        const addClassBtn = document.getElementById('add-class-btn');
        const classListContainer = document.getElementById('class-list');
        const classTitle = document.getElementById('class-title');
        const createClassModal = document.getElementById('create-class-modal');
        const createClassForm = document.getElementById('create-class-form');
        const createClassNameInput = document.getElementById('create-class-name');
        const createClassCancelBtn = document.getElementById('create-class-cancel-btn');
        const createClassCloseBtn = document.getElementById('create-class-close-btn');
        const createClassConfirmBtn = document.getElementById('create-class-confirm-btn');
        let isLoadingClasses = false;
        let isCreatingClass = false;

        function setClassCreateButtonState(canCreate) {
            if (!addClassBtn) return;
            addClassBtn.disabled = !canCreate;
            addClassBtn.classList.toggle('opacity-50', !canCreate);
            addClassBtn.classList.toggle('cursor-not-allowed', !canCreate);
        }

        function openCreateClassModal() {
            if (!auth.currentUser || !createClassModal || addClassBtn?.disabled) return;
            if (createClassNameInput) {
                createClassNameInput.value = '';
            }
            createClassModal.classList.remove('hidden');
            createClassModal.classList.add('flex');
            setTimeout(() => createClassNameInput?.focus(), 50);
        }

        function closeCreateClassModal() {
            if (!createClassModal) return;
            createClassModal.classList.add('hidden');
            createClassModal.classList.remove('flex');
            if (createClassNameInput) {
                createClassNameInput.value = '';
            }
        }

        async function handleCreateClassSubmit(event) {
            event.preventDefault();
            if (isCreatingClass) return;
            const user = auth.currentUser;
            if (!user) return;
            const className = (createClassNameInput?.value || '').trim();
            if (!className) {
                showToast('í•™ê¸‰ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                createClassNameInput?.focus();
                return;
            }

            isCreatingClass = true;
            const originalText = createClassConfirmBtn?.textContent || '';
            if (createClassConfirmBtn) {
                createClassConfirmBtn.disabled = true;
                createClassConfirmBtn.textContent = 'ë§Œë“œëŠ” ì¤‘...';
            }

            try {
                const classRef = doc(db, 'classes', user.uid);
                const classSnap = await getDoc(classRef);
                if (classSnap.exists()) {
                    showToast('ì´ë¯¸ í•™ê¸‰ì´ ì¡´ì¬í•©ë‹ˆë‹¤.');
                    closeCreateClassModal();
                    return;
                }
                await setDoc(classRef, { name: className, students: [] });
                showToast('ìƒˆ í•™ê¸‰ì´ ë§Œë“¤ì–´ì¡ŒìŠµë‹ˆë‹¤.');
                closeCreateClassModal();
                await loadClasses();
                await loadHomeData();
            } catch (error) {
                console.error('Failed to create class:', error);
                showToast('í•™ê¸‰ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            } finally {
                isCreatingClass = false;
                if (createClassConfirmBtn) {
                    createClassConfirmBtn.disabled = false;
                    createClassConfirmBtn.textContent = originalText || 'ë§Œë“¤ê¸°';
                }
            }
        }

        async function loadClasses() {
            const user = auth.currentUser;
            if (!user || isLoadingClasses) return;
            isLoadingClasses = true;
            if (classListContainer) {
                classListContainer.innerHTML = '<p class="text-gray-500">ë¡œë”© ì¤‘...</p>';
            }
            const classRef = doc(db, 'classes', user.uid);
            try {
                const classSnap = await getDoc(classRef);
                if (classListContainer) {
                    classListContainer.innerHTML = '';
                }
                if (!classSnap.exists()) {
                    classTitle.textContent = 'ë‚´ í•™ê¸‰';
                    if (classListContainer) {
                        classListContainer.innerHTML = `<p class="text-gray-500">ìƒì„±ëœ í•™ê¸‰ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                    }
                    setClassCreateButtonState(true);
                    return;
                }
                const data = classSnap.data();
                classTitle.textContent = data.name || 'ë‚´ í•™ê¸‰';
                setClassCreateButtonState(false);
                const studentIds = data.students || [];
                if (!studentIds.length) {
                    if (classListContainer) {
                        classListContainer.innerHTML = '<p class="text-gray-500">í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    }
                } else {
                    for (const sid of studentIds) {
                        try {
                            const sd = await getDoc(doc(db, 'users', sid));
                            if (sd.exists() && classListContainer) {
                                const s = sd.data();
                                const studentEl = document.createElement('div');
                                studentEl.className = 'p-3 border rounded-md flex justify-between items-center';
                                studentEl.innerHTML = `<span>${s.name || sid}</span><button class="achievement-btn text-sky-600 hover:underline text-sm">ì„±ì·¨ ê¸°ì¤€</button>`;
                                studentEl.querySelector('.achievement-btn').addEventListener('click', () => {
                                    openAchievementView(s.name || sid);
                                });
                                classListContainer.appendChild(studentEl);
                            }
                        } catch (err) {
                            console.error(err);
                        }
                    }
                }
            } catch (error) {
                if (classListContainer) {
                    classListContainer.innerHTML = '<p class="text-red-500">í•™ê¸‰ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
                }
                setClassCreateButtonState(true);
            } finally {
                isLoadingClasses = false;
            }
        }

        if (addClassBtn) {
            addClassBtn.addEventListener('click', openCreateClassModal);
        }
        createClassCancelBtn?.addEventListener('click', closeCreateClassModal);
        createClassCloseBtn?.addEventListener('click', closeCreateClassModal);
        createClassModal?.addEventListener('click', (event) => {
            if (event.target === createClassModal) {
                closeCreateClassModal();
            }
        });
        createClassForm?.addEventListener('submit', handleCreateClassSubmit);

        // --- Template Generator Logic ---
        function activateTemplateCategory(category) {
            if (!templateCategoryButtons) return;
            activeTemplateCategory = category;
            const buttons = templateCategoryButtons.querySelectorAll('button[data-template-category]');
            buttons.forEach(btn => {
                const isActive = btn.dataset.templateCategory === category;
                btn.classList.toggle('active', isActive);
            });
            if (!majorEvalWorkspace) return;
            if (category === 'major-eval') {
                majorEvalWorkspace.classList.remove('hidden');
                renderMajorEvalList();
                updateMajorEvalWorkspace();
            } else {
                majorEvalWorkspace.classList.add('hidden');
            }
        }

        function generateMajorEvalId() {
            return `major-eval-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
        }

        function ensureMajorEvalEntryShape(entry) {
            if (!entry || typeof entry !== 'object') {
                return null;
            }
            const baseDetails = {
                schoolName: 'ëŒ€ì „í•´ë“¬í•™êµ',
                domain: '',
                numQuestions: 5,
                evaluationTopic: '',
                admissionYear: '2025',
            };
            const details = Object.assign({}, baseDetails, typeof entry.details === 'object' && entry.details ? entry.details : {});
            details.numQuestions = Number(details.numQuestions) > 0 ? Number(details.numQuestions) : baseDetails.numQuestions;
            const normalized = {
                id: typeof entry.id === 'string' && entry.id ? entry.id : generateMajorEvalId(),
                title: typeof entry.title === 'string' && entry.title.trim() ? entry.title.trim() : 'ìƒˆ ì‹¬ì‚¬í‘œ',
                details,
                aiData: Array.isArray(entry.aiData) ? entry.aiData.map(item => ({
                    content: typeof item?.content === 'string' ? item.content : '',
                    materials: typeof item?.materials === 'string' ? item.materials : '',
                })) : [],
                pdfContext: typeof entry.pdfContext === 'string' ? entry.pdfContext : '',
                pdfFileName: typeof entry.pdfFileName === 'string' ? entry.pdfFileName : '',
                customHtml: typeof entry.customHtml === 'string' ? entry.customHtml : '',
            };
            return normalized;
        }

        function saveMajorEvalEntries() {
            if (typeof window === 'undefined' || !window.localStorage) return;
            try {
                const payload = majorEvalEntries.map(entry => ({
                    id: entry.id,
                    title: entry.title,
                    details: {
                        schoolName: entry.details?.schoolName || '',
                        domain: entry.details?.domain || '',
                        numQuestions: Number(entry.details?.numQuestions) || (entry.aiData?.length || 5),
                        evaluationTopic: entry.details?.evaluationTopic || '',
                        admissionYear: entry.details?.admissionYear || '2025',
                    },
                    aiData: Array.isArray(entry.aiData) ? entry.aiData : [],
                    pdfContext: entry.pdfContext || '',
                    pdfFileName: entry.pdfFileName || '',
                    customHtml: entry.customHtml || '',
                }));
                localStorage.setItem(MAJOR_EVAL_STORAGE_KEY, JSON.stringify(payload));
                if (activeMajorEvalId) {
                    localStorage.setItem(MAJOR_EVAL_ACTIVE_STORAGE_KEY, activeMajorEvalId);
                } else {
                    localStorage.removeItem(MAJOR_EVAL_ACTIVE_STORAGE_KEY);
                }
            } catch (error) {
                console.error('Failed to save major evaluation entries', error);
            }
        }

        function loadMajorEvalEntries() {
            if (typeof window === 'undefined' || !window.localStorage) return;
            try {
                const stored = localStorage.getItem(MAJOR_EVAL_STORAGE_KEY);
                if (stored) {
                    const parsed = JSON.parse(stored);
                    if (Array.isArray(parsed)) {
                        majorEvalEntries = parsed
                            .map(ensureMajorEvalEntryShape)
                            .filter(Boolean);
                    }
                }
                const savedActive = localStorage.getItem(MAJOR_EVAL_ACTIVE_STORAGE_KEY);
                if (savedActive) {
                    activeMajorEvalId = savedActive;
                }
            } catch (error) {
                console.error('Failed to load major evaluation entries', error);
                majorEvalEntries = [];
            }
            renderMajorEvalList();
            updateMajorEvalWorkspace();
            saveMajorEvalEntries();
        }

        function getMajorEvalPdfContext(entry, maxLength = 1800) {
            const raw = (entry?.pdfContext || '').replace(/\s+/g, ' ').trim();
            if (!raw) return '';
            if (raw.length <= maxLength) return raw;
            return `${raw.slice(0, maxLength)}...`;
        }

        function escapeCssSelector(value) {
            if (typeof value !== 'string') return '';
            if (window.CSS && typeof window.CSS.escape === 'function') {
                return window.CSS.escape(value);
            }
            return value.replace(/[^a-zA-Z0-9_-]/g, match => `\\${match}`);
        }

        async function copyHtmlToClipboard(html) {
            if (!html) return;
            if (navigator.clipboard && typeof navigator.clipboard.write === 'function' && typeof ClipboardItem !== 'undefined') {
                const htmlBlob = new Blob([html], { type: 'text/html' });
                const textBlob = new Blob([html], { type: 'text/plain' });
                const clipboardItem = new ClipboardItem({ 'text/html': htmlBlob, 'text/plain': textBlob });
                await navigator.clipboard.write([clipboardItem]);
                return;
            }
            if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
                await navigator.clipboard.writeText(html);
                return;
            }
            const container = document.createElement('div');
            container.innerHTML = html;
            container.setAttribute('contenteditable', 'true');
            container.style.position = 'absolute';
            container.style.left = '-9999px';
            document.body.appendChild(container);
            const range = document.createRange();
            range.selectNodeContents(container);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            document.execCommand('copy');
            selection.removeAllRanges();
            document.body.removeChild(container);
        }

        async function extractTextFromPdf(file) {
            if (!file) return '';
            if (typeof pdfjsLib === 'undefined') {
                throw new Error('pdfjsLib is not available');
            }
            const arrayBuffer = await file.arrayBuffer();
            const uint8Array = new Uint8Array(arrayBuffer);
            const pdf = await pdfjsLib.getDocument({ data: uint8Array }).promise;
            let text = '';
            for (let pageNumber = 1; pageNumber <= pdf.numPages; pageNumber++) {
                const page = await pdf.getPage(pageNumber);
                const content = await page.getTextContent();
                const pageText = content.items
                    .map(item => (typeof item.str === 'string' ? item.str : ''))
                    .join(' ')
                    .replace(/\s+/g, ' ')
                    .trim();
                if (pageText) {
                    text += pageText + '\n';
                }
            }
            return text.replace(/\s+\n/g, '\n').trim();
        }

        function getActiveMajorEvalEntry() {
            return majorEvalEntries.find(entry => entry.id === activeMajorEvalId) || null;
        }

        function renderMajorEvalList() {
            if (!majorEvalList) return;
            majorEvalList.innerHTML = '';
            if (!Array.isArray(majorEvalEntries)) {
                majorEvalEntries = [];
            }
            if (!majorEvalEntries.length) {
                activeMajorEvalId = '';
                if (majorEvalEmpty) majorEvalEmpty.classList.remove('hidden');
                if (majorEvalUploadSection) majorEvalUploadSection.classList.add('hidden');
                return;
            }

            if (majorEvalEmpty) majorEvalEmpty.classList.add('hidden');
            if (majorEvalUploadSection) majorEvalUploadSection.classList.remove('hidden');

            majorEvalEntries.forEach((entry, index) => {
                const normalizedEntry = ensureMajorEvalEntryShape(entry);
                if (!normalizedEntry) return;
                majorEvalEntries[index] = normalizedEntry;
                const li = document.createElement('li');
                li.className = 'flex items-center gap-2';

                const button = document.createElement('button');
                button.type = 'button';
                button.dataset.entryId = normalizedEntry.id;
                button.dataset.role = 'select-major-eval';
                button.className = `flex-1 text-left px-3 py-2 rounded border transition ${normalizedEntry.id === activeMajorEvalId ? 'border-sky-500 bg-sky-50 text-sky-700' : 'border-gray-200 hover:border-sky-400 hover:bg-sky-50'}`;

                const badges = [];
                if (normalizedEntry.pdfFileName) {
                    badges.push('<span class="text-xs font-medium text-sky-600">PDF</span>');
                }
                if (normalizedEntry.aiData && normalizedEntry.aiData.length) {
                    badges.push('<span class="text-xs font-medium text-emerald-600">ì™„ë£Œ</span>');
                }
                const badgeHtml = badges.length ? `<span class="flex items-center gap-1">${badges.join('')}</span>` : '';

                button.innerHTML = `
                    <div class="flex items-center justify-between gap-2">
                        <span class="truncate">${escapeHtml(normalizedEntry.title)}</span>
                        ${badgeHtml}
                    </div>
                `;

                const actions = document.createElement('div');
                actions.className = 'flex items-center gap-1 shrink-0';

                const renameBtn = document.createElement('button');
                renameBtn.type = 'button';
                renameBtn.dataset.action = 'rename';
                renameBtn.dataset.entryId = normalizedEntry.id;
                renameBtn.className = 'text-xs text-slate-500 hover:text-sky-600 px-2 py-1 rounded border border-transparent hover:border-sky-200 transition';
                renameBtn.textContent = 'ì´ë¦„ ë³€ê²½';

                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.dataset.action = 'delete';
                deleteBtn.dataset.entryId = normalizedEntry.id;
                deleteBtn.className = 'text-xs text-red-500 hover:text-red-600 px-2 py-1 rounded border border-transparent hover:border-red-200 transition';
                deleteBtn.textContent = 'ì‚­ì œ';

                actions.appendChild(renameBtn);
                actions.appendChild(deleteBtn);

                li.appendChild(button);
                li.appendChild(actions);
                majorEvalList.appendChild(li);
            });

            if (!activeMajorEvalId && majorEvalEntries.length) {
                activeMajorEvalId = majorEvalEntries[0].id;
                saveMajorEvalEntries();
            }
        }

        function hasMajorEvalOutputData(entry) {
            if (!entry) return false;
            if (Array.isArray(entry.aiData) && entry.aiData.length) return true;
            if (typeof entry.customHtml === 'string' && entry.customHtml.trim()) return true;
            return false;
        }

        function clearMajorEvalManualDraft() {
            hasMajorEvalManualDraft = false;
            majorEvalManualDraftHtml = '';
        }

        function updateMajorEvalActionButtons(entry = getActiveMajorEvalEntry()) {
            const hasData = hasMajorEvalOutputData(entry) || (hasMajorEvalManualDraft && !!majorEvalManualDraftHtml.trim());
            if (majorEvalEditToggleBtn) {
                majorEvalEditToggleBtn.disabled = !hasData;
                majorEvalEditToggleBtn.textContent = isMajorEvalManualEditing ? 'ì™„ë£Œ' : 'í¸ì§‘';
            }
            if (majorEvalSaveBtn) {
                majorEvalSaveBtn.disabled = !hasData || isMajorEvalManualEditing;
            }
            if (majorEvalPdfBtn) {
                majorEvalPdfBtn.disabled = !hasData || isMajorEvalManualEditing;
            }
            const canAdjustQuestions = Array.isArray(entry?.aiData) && entry.aiData.length > 0 && !isMajorEvalManualEditing;
            if (majorEvalQuestionIncreaseBtn) majorEvalQuestionIncreaseBtn.disabled = !canAdjustQuestions;
            if (majorEvalQuestionIncreaseInput) majorEvalQuestionIncreaseInput.disabled = !canAdjustQuestions;
        }

        function guardMajorEvalManualState(actionMessage) {
            if (isMajorEvalManualEditing) {
                alert(`ìˆ˜ë™ í¸ì§‘ì„ ì™„ë£Œí•œ í›„ ${actionMessage}`);
                return true;
            }
            if (hasMajorEvalManualDraft) {
                alert(`í¸ì§‘ ë‚´ìš©ì„ ì €ì¥í•œ í›„ ${actionMessage}`);
                return true;
            }
            return false;
        }

        function startMajorEvalManualEdit() {
            if (isMajorEvalManualEditing) return;
            const entry = getActiveMajorEvalEntry();
            if (!hasMajorEvalOutputData(entry)) {
                alert('í¸ì§‘í•  ì‹¬ì‚¬í‘œë¥¼ ë¨¼ì € ìƒì„±í•´ ì£¼ì„¸ìš”.');
                return;
            }
            if (!majorEvalOutput || !majorEvalOutput.innerHTML.trim()) {
                alert('í¸ì§‘í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            clearMajorEvalManualDraft();
            isMajorEvalManualEditing = true;
            majorEvalManualNode = majorEvalOutput;
            majorEvalManualNode.setAttribute('contenteditable', 'true');
            majorEvalManualNode.classList.add('manual-editing');
            if (majorEvalModifyInput) majorEvalModifyInput.disabled = true;
            if (majorEvalModifyBtn) {
                majorEvalModifyBtn.disabled = true;
                majorEvalModifyBtn.classList.add('opacity-50', 'pointer-events-none');
            }
            if (majorEvalQuestionIncreaseBtn) majorEvalQuestionIncreaseBtn.disabled = true;
            if (majorEvalQuestionIncreaseInput) majorEvalQuestionIncreaseInput.disabled = true;
            updateMajorEvalActionButtons(entry);
            setTimeout(() => {
                try {
                    majorEvalManualNode?.focus();
                } catch (error) {
                    console.warn('Unable to focus manual edit node', error);
                }
            }, 0);
        }

        function finishMajorEvalManualEdit(options = {}) {
            if (!isMajorEvalManualEditing) return;
            if (majorEvalManualNode) {
                majorEvalManualNode.removeAttribute('contenteditable');
                majorEvalManualNode.classList.remove('manual-editing');
            }
            isMajorEvalManualEditing = false;
            majorEvalManualNode = null;
            majorEvalManualDraftHtml = majorEvalOutput?.innerHTML || '';
            hasMajorEvalManualDraft = !!majorEvalManualDraftHtml.trim();
            const entry = getActiveMajorEvalEntry();
            const canModify = Array.isArray(entry?.aiData) && entry.aiData.length > 0;
            if (majorEvalModifyInput) majorEvalModifyInput.disabled = !canModify;
            if (majorEvalModifyBtn) {
                majorEvalModifyBtn.disabled = !canModify;
                majorEvalModifyBtn.classList.toggle('opacity-50', !canModify);
                majorEvalModifyBtn.classList.toggle('pointer-events-none', !canModify);
            }
            updateMajorEvalActionButtons(entry);
            if (!options.silent) {
                const message = hasMajorEvalManualDraft
                    ? 'ìˆ˜ë™ í¸ì§‘ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.'
                    : 'ìˆ˜ë™ í¸ì§‘ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
                showToast(message);
            }
        }

        function updateMajorEvalWorkspace() {
            if (!majorEvalWorkspace) return;
            if (!majorEvalEntries.length) {
                majorEvalInputSection?.classList.add('hidden');
                majorEvalModifySection?.classList.add('hidden');
                if (majorEvalUploadSection) majorEvalUploadSection.classList.add('hidden');
                if (majorEvalUploadBtn) majorEvalUploadBtn.disabled = true;
                if (majorEvalUploadInfo) majorEvalUploadInfo.classList.add('hidden');
                clearMajorEvalManualDraft();
                updateMajorEvalActionButtons(null);
                renderMajorEvalOutput(null);
                return;
            }

            let entry = getActiveMajorEvalEntry();
            if (!entry) {
                entry = majorEvalEntries[0];
                activeMajorEvalId = entry.id;
            }

            const entryIndex = majorEvalEntries.findIndex(item => item.id === entry.id);
            let normalizedEntry = ensureMajorEvalEntryShape(entry);
            if (!normalizedEntry) {
                normalizedEntry = {
                    id: entry.id || generateMajorEvalId(),
                    title: entry.title || 'ìƒˆ ì‹¬ì‚¬í‘œ',
                    details: { schoolName: '', domain: '', numQuestions: 5, evaluationTopic: '', admissionYear: '2025' },
                    aiData: Array.isArray(entry.aiData) ? entry.aiData : [],
                    pdfContext: '',
                    pdfFileName: '',
                    customHtml: typeof entry.customHtml === 'string' ? entry.customHtml : '',
                };
            }
            if (entryIndex !== -1) {
                majorEvalEntries[entryIndex] = normalizedEntry;
            }
            entry = normalizedEntry;

            populateMajorEvalInputs(entry);

            if (majorEvalUploadSection) majorEvalUploadSection.classList.remove('hidden');
            if (majorEvalUploadBtn) {
                majorEvalUploadBtn.disabled = !!isMajorEvalUploading;
                majorEvalUploadBtn.textContent = isMajorEvalUploading ? 'ì¶”ì¶œ ì¤‘...' : 'ì˜ˆì‹œ íŒŒì¼ ì—…ë¡œë“œ';
            }
            if (majorEvalUploadInfo) {
                if (entry.pdfFileName) {
                    majorEvalUploadInfo.textContent = `ì—…ë¡œë“œëœ íŒŒì¼: ${entry.pdfFileName}`;
                } else {
                    majorEvalUploadInfo.textContent = 'ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.';
                }
                majorEvalUploadInfo.classList.remove('hidden');
            }

            const hasGeneratedData = Array.isArray(entry.aiData) && entry.aiData.length > 0;
            const hasCustomOutput = typeof entry.customHtml === 'string' && entry.customHtml.trim().length > 0;

            if (hasGeneratedData || hasCustomOutput) {
                majorEvalInputSection?.classList.add('hidden');
                majorEvalModifySection?.classList.remove('hidden');
                const canModify = hasGeneratedData;
                if (majorEvalModifyInput) {
                    majorEvalModifyInput.value = '';
                    majorEvalModifyInput.disabled = !canModify;
                }
                if (majorEvalModifyBtn) {
                    majorEvalModifyBtn.disabled = !canModify;
                    majorEvalModifyBtn.classList.toggle('opacity-50', !canModify);
                    majorEvalModifyBtn.classList.toggle('pointer-events-none', !canModify);
                }
                if (majorEvalQuestionIncreaseInput && !isMajorEvalManualEditing) {
                    majorEvalQuestionIncreaseInput.value = '1';
                }
            } else {
                majorEvalInputSection?.classList.remove('hidden');
                majorEvalModifySection?.classList.add('hidden');
                if (majorEvalModifyInput) {
                    majorEvalModifyInput.value = '';
                    majorEvalModifyInput.disabled = true;
                }
                if (majorEvalModifyBtn) {
                    majorEvalModifyBtn.disabled = true;
                    majorEvalModifyBtn.classList.add('opacity-50');
                    majorEvalModifyBtn.classList.add('pointer-events-none');
                }
            }

            renderMajorEvalOutput(entry);
            updateMajorEvalActionButtons(entry);
        }

        function populateMajorEvalInputs(entry) {
            if (!entry || !entry.details) return;
            if (majorEvalSchoolInput) majorEvalSchoolInput.value = entry.details.schoolName || '';
            if (majorEvalDomainInput) majorEvalDomainInput.value = entry.details.domain || '';
            if (majorEvalQuestionsInput) majorEvalQuestionsInput.value = entry.details.numQuestions || 5;
            if (majorEvalTopicInput) majorEvalTopicInput.value = entry.details.evaluationTopic || '';
        }

        function createMajorEvalEntry(title) {
            const newEntry = ensureMajorEvalEntryShape({
                id: generateMajorEvalId(),
                title: title.trim() || 'ìƒˆ ì‹¬ì‚¬í‘œ',
                details: { schoolName: '', domain: '', numQuestions: 5, evaluationTopic: '', admissionYear: '2025' },
                aiData: [],
                pdfContext: '',
                pdfFileName: '',
            });
            majorEvalEntries = [newEntry, ...majorEvalEntries];
            activeMajorEvalId = newEntry.id;
            renderMajorEvalList();
            updateMajorEvalWorkspace();
            saveMajorEvalEntries();
        }

        function showMajorEvalModal() {
            if (!majorEvalModal) return;
            majorEvalModal.classList.remove('hidden');
            majorEvalModal.classList.add('flex');
            majorEvalModalTitle.value = '';
            setTimeout(() => majorEvalModalTitle.focus(), 50);
        }

        function hideMajorEvalModal() {
            if (!majorEvalModal) return;
            majorEvalModal.classList.add('hidden');
            majorEvalModal.classList.remove('flex');
            majorEvalModalTitle.value = '';
        }

        function renderMajorEvalOutput(entry) {
            if (!majorEvalOutput) return;
            if (hasMajorEvalManualDraft) return;
            if (!entry) {
                majorEvalOutput.innerHTML = '<p class="text-gray-500">ì™¼ìª½ ëª©ë¡ì—ì„œ ì‹¬ì‚¬í‘œë¥¼ ì„ íƒí•˜ë©´ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>';
                return;
            }

            const customHtml = typeof entry.customHtml === 'string' ? entry.customHtml.trim() : '';
            if (customHtml && !isMajorEvalManualEditing) {
                majorEvalOutput.innerHTML = customHtml;
                return;
            }

            const details = entry.details || {};
            const items = Array.isArray(entry.aiData) ? entry.aiData : [];

            if (!items.length) {
                majorEvalOutput.innerHTML = '<p class="text-gray-500">ì…ë ¥ ì •ë³´ë¥¼ ì‘ì„±í•œ ë’¤ ìƒì„± ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹¬ì‚¬í‘œë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”.</p>';
                return;
            }

            const normalizedItems = normalizeMajorEvalData(items, details.numQuestions || items.length);
            if (!normalizedItems.length) {
                majorEvalOutput.innerHTML = '<p class="text-red-500">AIê°€ ê²°ê³¼ë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>';
                return;
            }

            const schoolName = details.schoolName || 'ëŒ€ì „í•´ë“¬í•™êµ';
            const domain = details.domain || 'ì˜ì—­';
            const evaluationTopic = details.evaluationTopic || 'í‰ê°€ ì£¼ì œ';
            const admissionYear = details.admissionYear || '2025';
            const evaluationTableId = `${entry.id}-evaluation-table`;
            const recordTableId = `${entry.id}-record-table`;

            const evaluationRows = normalizedItems.map((item, index) => {
                const domainCell = index === 0 ? `<td rowspan="${normalizedItems.length}" class="border px-2 py-2 align-middle font-medium">${escapeHtml(domain)}</td>` : '';
                return `
                    <tr>
                        ${domainCell}
                        <td class="border px-2 py-2">${index + 1}</td>
                        <td class="border px-2 py-2 text-left">${formatCellText(item.content)}</td>
                        <td class="border px-2 py-2">2</td>
                        <td class="border px-2 py-2 text-left">${formatCellText(item.materials || 'í•„ìš” ì¤€ë¹„ë¬¼ ì—†ìŒ')}</td>
                    </tr>
                `;
            }).join('');

            const recordRows = normalizedItems.map((item, index) => {
                const domainCell = index === 0 ? `<td rowspan="${normalizedItems.length}" class="border px-2 py-2 align-middle font-medium">${escapeHtml(domain)}</td>` : '';
                return `
                    <tr>
                        ${domainCell}
                        <td class="border px-2 py-2">${index + 1}</td>
                        <td class="border px-2 py-2 text-left">${formatCellText(item.content)}</td>
                        <td class="border px-2 py-2"></td>
                    </tr>
                `;
            }).join('');

            majorEvalOutput.innerHTML = `
                <div class="space-y-8">
                    <section class="major-eval-page" data-page="1">
                        <div class="text-center space-y-2 mb-6">
                            <p class="text-sm text-gray-600">${escapeHtml(admissionYear)}í•™ë…„ë„ ${escapeHtml(schoolName)} ì „ê³µê³¼ ì…í•™ ì „í˜•</p>
                            <h3 class="text-2xl font-bold text-gray-800">ì§ì—…ëŠ¥ë ¥í‰ê°€ (ì‹¤ë¬´ ëŠ¥ë ¥ ì‹¬ì‚¬í‘œ)</h3>
                            <p class="text-sm text-gray-500">í‰ê°€ ì£¼ì œ: ${escapeHtml(evaluationTopic)}</p>
                        </div>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between gap-3">
                                <h4 class="font-semibold text-lg text-gray-800">1í˜ì´ì§€ Â· ì§ì—…ëŠ¥ë ¥í‰ê°€ ì‹¬ì‚¬í‘œ</h4>
                                <button type="button" class="major-eval-copy-btn" data-copy-target="${evaluationTableId}">HTML ë³µì‚¬</button>
                            </div>
                            <div class="text-sm text-gray-600 space-y-1">
                                <p>â—‹ í‰ê°€ ê¸°ì¤€: 100% ìˆ˜í–‰(2ì ), ëª»í•¨(0ì )</p>
                                <p>â—‹ ì œí•œ ì‹œê°„: ë¬¸í•­ë‹¹ 30ì´ˆ / â—‹ ì¤€ë¹„ë¬¼: ì´ˆì‹œê³„</p>
                            </div>
                            <table id="${evaluationTableId}" class="w-full border border-gray-300 text-sm bg-white">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="border px-2 py-2 w-32">ì˜ì—­</th>
                                        <th class="border px-2 py-2 w-16">ë¬¸í•­</th>
                                        <th class="border px-2 py-2">ë‚´ìš©</th>
                                        <th class="border px-2 py-2 w-16">ë°°ì </th>
                                        <th class="border px-2 py-2 w-32">ìë£Œ(ìˆ˜)</th>
                                    </tr>
                                </thead>
                                <tbody>${evaluationRows}</tbody>
                            </table>
                        </div>
                    </section>
                    <section class="major-eval-page" data-page="2">
                        <div class="space-y-4">
                            <div class="flex items-center justify-between gap-3">
                                <h4 class="font-semibold text-lg text-gray-800">2í˜ì´ì§€ Â· ì§ì—…ëŠ¥ë ¥í‰ê°€ ê¸°ë¡ì§€</h4>
                                <button type="button" class="major-eval-copy-btn" data-copy-target="${recordTableId}">HTML ë³µì‚¬</button>
                            </div>
                            <table id="${recordTableId}" class="w-full border border-gray-300 text-sm bg-white">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="border px-2 py-2 w-32">ì˜ì—­</th>
                                        <th class="border px-2 py-2 w-16">ë¬¸í•­</th>
                                        <th class="border px-2 py-2">ë‚´ìš©</th>
                                        <th class="border px-2 py-2 w-24">ì·¨ë“ì ìˆ˜</th>
                                    </tr>
                                </thead>
                                <tbody>${recordRows}</tbody>
                                <tfoot>
                                    <tr>
                                        <th colspan="3" class="border px-2 py-2 text-right">í•©ê³„</th>
                                        <td class="border px-2 py-2"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </section>
                </div>
            `;
        }

        function normalizeMajorEvalData(raw, count) {
            let items = [];
            if (Array.isArray(raw)) {
                items = raw;
            } else if (Array.isArray(raw?.items)) {
                items = raw.items;
            } else if (Array.isArray(raw?.data)) {
                items = raw.data;
            }

            if (!items.length) {
                return [];
            }

            const total = Math.max(1, count || items.length);
            const normalized = [];

            for (let i = 0; i < total; i++) {
                const source = items[i] || {};
                const content = typeof source.content === 'string' ? source.content.trim() : '';
                const materials = typeof source.materials === 'string' ? source.materials.trim() : '';
                normalized.push({
                    content: content || 'ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”.',
                    materials: materials || 'í•„ìš” ì¤€ë¹„ë¬¼ ì—†ìŒ'
                });
            }

            return normalized;
        }

        if (templateCategoryButtons) {
            templateCategoryButtons.addEventListener('click', (event) => {
                const button = event.target.closest('button[data-template-category]');
                if (!button) return;
                activateTemplateCategory(button.dataset.templateCategory);
            });
        }

        if (majorEvalAddBtn) {
            majorEvalAddBtn.addEventListener('click', () => {
                if (guardMajorEvalManualState('ìƒˆ ì‹¬ì‚¬í‘œë¥¼ ì¶”ê°€í•´ ì£¼ì„¸ìš”.')) return;
                showMajorEvalModal();
            });
        }

        if (majorEvalModalCancel) {
            majorEvalModalCancel.addEventListener('click', () => {
                hideMajorEvalModal();
            });
        }

        if (majorEvalModal) {
            majorEvalModal.addEventListener('click', (event) => {
                if (event.target === majorEvalModal) {
                    hideMajorEvalModal();
                }
            });
        }

        if (majorEvalModalConfirm) {
            majorEvalModalConfirm.addEventListener('click', () => {
                const title = majorEvalModalTitle.value.trim();
                if (!title) {
                    alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                createMajorEvalEntry(title);
                hideMajorEvalModal();
            });
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && majorEvalModal && !majorEvalModal.classList.contains('hidden')) {
                hideMajorEvalModal();
            }
        });

        if (majorEvalList) {
            majorEvalList.addEventListener('click', (event) => {
                const target = event.target;
                if (!(target instanceof HTMLElement)) return;

                const actionButton = target.closest('button[data-action]');
                if (actionButton) {
                    if (guardMajorEvalManualState('í•´ë‹¹ ì‘ì—…ì„ ì§„í–‰í•´ ì£¼ì„¸ìš”.')) return;
                    const entryId = actionButton.dataset.entryId;
                    const action = actionButton.dataset.action;
                    if (!entryId || !action) return;
                    const entryIndex = majorEvalEntries.findIndex(item => item.id === entryId);
                    if (entryIndex === -1) return;
                    const entry = majorEvalEntries[entryIndex];

                    if (action === 'rename') {
                        const newTitle = prompt('ìƒˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.', entry.title || '');
                        if (newTitle && newTitle.trim()) {
                            entry.title = newTitle.trim();
                            saveMajorEvalEntries();
                            renderMajorEvalList();
                            updateMajorEvalWorkspace();
                        }
                    } else if (action === 'delete') {
                        const confirmed = confirm('ì„ íƒí•œ ì‹¬ì‚¬í‘œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
                        if (!confirmed) return;
                        majorEvalEntries.splice(entryIndex, 1);
                        if (activeMajorEvalId === entryId) {
                            activeMajorEvalId = majorEvalEntries[0]?.id || '';
                        }
                        saveMajorEvalEntries();
                        renderMajorEvalList();
                        updateMajorEvalWorkspace();
                    }
                    return;
                }

                const button = target.closest('button[data-role="select-major-eval"]');
                if (!button) return;
                const entryId = button.dataset.entryId;
                if (!entryId) return;
                if (guardMajorEvalManualState('ë‹¤ë¥¸ ì‹¬ì‚¬í‘œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.')) return;
                if (activeMajorEvalId === entryId) return;
                activeMajorEvalId = entryId;
                saveMajorEvalEntries();
                renderMajorEvalList();
                updateMajorEvalWorkspace();
            });
        }

        if (majorEvalUploadBtn && majorEvalUploadInput) {
            majorEvalUploadBtn.addEventListener('click', () => {
                if (isMajorEvalUploading) return;
                if (guardMajorEvalManualState('PDFë¥¼ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.')) return;
                if (!getActiveMajorEvalEntry()) {
                    alert('ë¨¼ì € ì‹¬ì‚¬í‘œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
                    return;
                }
                majorEvalUploadInput.value = '';
                majorEvalUploadInput.click();
            });
        }

        if (majorEvalUploadInput) {
            majorEvalUploadInput.addEventListener('change', async (event) => {
                if (guardMajorEvalManualState('PDFë¥¼ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.')) {
                    majorEvalUploadInput.value = '';
                    return;
                }
                const file = event.target.files && event.target.files[0];
                if (!file) return;
                const entry = getActiveMajorEvalEntry();
                if (!entry) {
                    alert('ë¨¼ì € ì‹¬ì‚¬í‘œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
                    majorEvalUploadInput.value = '';
                    return;
                }
                if (file.type !== 'application/pdf') {
                    alert('PDF íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    majorEvalUploadInput.value = '';
                    return;
                }

                isMajorEvalUploading = true;
                updateMajorEvalWorkspace();

                try {
                    const extractedText = await extractTextFromPdf(file);
                    if (!extractedText) {
                        throw new Error('empty');
                    }
                    const condensedText = extractedText.length > 6000 ? `${extractedText.slice(0, 6000)}...` : extractedText;
                    entry.pdfContext = condensedText;
                    entry.pdfFileName = file.name;
                    saveMajorEvalEntries();
                    updateMajorEvalWorkspace();
                    showToast('PDFì—ì„œ ë‚´ìš©ì„ ì¶”ì¶œí–ˆìŠµë‹ˆë‹¤.');
                } catch (error) {
                    console.error('Failed to extract PDF text', error);
                    alert('PDF ë‚´ìš©ì„ ì¶”ì¶œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ íŒŒì¼ë¡œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
                } finally {
                    isMajorEvalUploading = false;
                    updateMajorEvalWorkspace();
                    majorEvalUploadInput.value = '';
                }
            });
        }

        const majorEvalInputs = [
            [majorEvalSchoolInput, 'schoolName'],
            [majorEvalDomainInput, 'domain'],
            [majorEvalQuestionsInput, 'numQuestions'],
            [majorEvalTopicInput, 'evaluationTopic']
        ];

        majorEvalInputs.forEach(([input, key]) => {
            if (!input) return;
            input.addEventListener('input', () => {
                const entry = getActiveMajorEvalEntry();
                if (!entry) return;
                if (guardMajorEvalManualState('ì…ë ¥ ê°’ì„ ìˆ˜ì •í•´ ì£¼ì„¸ìš”.')) {
                    const currentValue = key === 'numQuestions'
                        ? entry.details?.numQuestions ?? 5
                        : entry.details?.[key] ?? '';
                    input.value = key === 'numQuestions' ? String(currentValue || 1) : currentValue;
                    return;
                }
                if (!entry.details) entry.details = { schoolName: '', domain: '', numQuestions: 5, evaluationTopic: '', admissionYear: '2025' };
                if (key === 'numQuestions') {
                    let value = parseInt(input.value, 10);
                    if (!Number.isFinite(value) || value < 1) {
                        value = 1;
                    }
                    entry.details[key] = value;
                    input.value = value;
                } else {
                    entry.details[key] = input.value;
                }
                entry.customHtml = '';
                clearMajorEvalManualDraft();
                saveMajorEvalEntries();
                renderMajorEvalOutput(entry);
                updateMajorEvalActionButtons(entry);
            });
        });

        if (majorEvalGenerateBtn) {
            majorEvalGenerateBtn.addEventListener('click', async () => {
                const entry = getActiveMajorEvalEntry();
                if (!entry || isMajorEvalGenerating) return;
                if (guardMajorEvalManualState('ìƒì„± ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.')) return;

                const schoolName = (majorEvalSchoolInput?.value || '').trim();
                const domain = (majorEvalDomainInput?.value || '').trim();
                const evaluationTopic = (majorEvalTopicInput?.value || '').trim();
                let numQuestions = parseInt(majorEvalQuestionsInput?.value || '0', 10);
                if (!Number.isFinite(numQuestions) || numQuestions < 1) {
                    numQuestions = 1;
                }

                if (!domain || !evaluationTopic) {
                    alert('ì˜ì—­ê³¼ í‰ê°€ ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                entry.details = {
                    schoolName,
                    domain,
                    evaluationTopic,
                    numQuestions,
                    admissionYear: entry.details?.admissionYear || '2025'
                };
                entry.customHtml = '';
                clearMajorEvalManualDraft();

                const pdfReference = getMajorEvalPdfContext(entry);
                const referenceBlock = pdfReference ? `\n\nì°¸ê³  ìë£Œ(ì˜ˆì‹œ PDFì—ì„œ ì¶”ì¶œ):\n${pdfReference}` : '';
                const prompt = `ë„ˆëŠ” íŠ¹ìˆ˜í•™êµ ì „ê³µê³¼ ì…í•™ ì „í˜• ì‹¬ì‚¬í‘œë¥¼ ë§Œë“œëŠ” ì „ë¬¸ê°€ì•¼. ì•„ë˜ ì •ë³´ë¥¼ ì°¸ê³ í•˜ì—¬ ì§ì—…ëŠ¥ë ¥í‰ê°€ ì‹¬ì‚¬í‘œ ë¬¸í•­ì„ JSON ë°°ì—´ë¡œ ì‘ì„±í•´ì¤˜.

í•™êµ ì´ë¦„: ${schoolName || '[í•™êµ ì´ë¦„]'}
ì˜ì—­: ${domain}
í‰ê°€ ì£¼ì œ: ${evaluationTopic}
ë¬¸í•­ ìˆ˜: ${numQuestions}${referenceBlock}

ìš”êµ¬ì‚¬í•­:
1. JSON ë°°ì—´ì˜ ê¸¸ì´ëŠ” ë°˜ë“œì‹œ ${numQuestions}ê°œì—¬ì•¼ í•´.
2. ê° ìš”ì†ŒëŠ” {"content":"ì§€ì‹œë¬¸", "materials":"ì¤€ë¹„ë¬¼ ëª©ë¡"} í˜•ì‹ì´ì–´ì•¼ í•˜ë©° ë‹¤ë¥¸ ì†ì„±ì€ í¬í•¨í•˜ì§€ ë§ˆ.
3. contentëŠ” í•™ìƒì—ê²Œ ëª…í™•íˆ ì§€ì‹œí•˜ëŠ” ë¬¸ì¥ìœ¼ë¡œ ì‘ì„±í•˜ê³  ë°˜ë“œì‹œ '~í•˜ì‹œì˜¤.'ë¡œ ëë‚´.
4. materialsëŠ” ê³¼ì œ ìˆ˜í–‰ì— í•„ìš”í•œ ì¤€ë¹„ë¬¼ì„ ì‰¼í‘œë¡œ êµ¬ë¶„ëœ í•œ ì¤„ ë¬¸ìì—´ë¡œ ì‘ì„±í•´. ì¤€ë¹„ë¬¼ì´ ì—†ìœ¼ë©´ 'í•„ìš” ì¤€ë¹„ë¬¼ ì—†ìŒ'ì´ë¼ê³  ì ì–´.
5. ì„¤ëª…ì´ë‚˜ ì£¼ì„ ì—†ì´ JSON ë°°ì—´ë§Œ ë°˜í™˜í•´.
6. ì°¸ê³  ìë£Œê°€ ì œê³µë˜ë©´ í•´ë‹¹ í‘œí˜„ê³¼ ì ˆì°¨ë¥¼ ì°¸ê³ í•˜ë˜, ë¬¸í•­ì€ íŠ¹ìˆ˜í•™êµ ì§ì—…ëŠ¥ë ¥í‰ê°€ ì‹¬ì‚¬í‘œ í˜•ì‹ì— ë§ê²Œ ì¡°ì •í•´.`;

                const originalText = majorEvalGenerateBtn.textContent;
                majorEvalGenerateBtn.textContent = 'ìƒì„± ì¤‘...';
                majorEvalGenerateBtn.disabled = true;
                isMajorEvalGenerating = true;

                try {
                    const result = await callGemini(prompt, true);
                    const normalized = normalizeMajorEvalData(result, numQuestions);
                    if (!normalized.length) {
                        throw new Error('empty');
                    }
                    entry.aiData = normalized;
                    entry.customHtml = '';
                    clearMajorEvalManualDraft();
                    saveMajorEvalEntries();
                    renderMajorEvalList();
                    updateMajorEvalWorkspace();
                    showToast('ì‹¬ì‚¬í‘œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } catch (error) {
                    console.error('Failed to generate major evaluation sheet', error);
                    alert('ì‹¬ì‚¬í‘œë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                } finally {
                    isMajorEvalGenerating = false;
                    majorEvalGenerateBtn.disabled = false;
                    majorEvalGenerateBtn.textContent = originalText;
                }
            });
        }

        if (majorEvalModifyBtn) {
            majorEvalModifyBtn.addEventListener('click', async () => {
                if (guardMajorEvalManualState('ìˆ˜ì • ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.')) return;
                const entry = getActiveMajorEvalEntry();
                if (!entry || !entry.aiData?.length || isMajorEvalModifying) return;

                const instruction = (majorEvalModifyInput?.value || '').trim();
                if (!instruction) {
                    alert('ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                const pdfReference = getMajorEvalPdfContext(entry);
                const referenceBlock = pdfReference ? `\n\nì°¸ê³  ìë£Œ(ì˜ˆì‹œ PDFì—ì„œ ì¶”ì¶œ):\n${pdfReference}` : '';
                const prompt = `ë„ˆëŠ” íŠ¹ìˆ˜í•™êµ ì „ê³µê³¼ ì§ì—…ëŠ¥ë ¥í‰ê°€ ì‹¬ì‚¬í‘œë¥¼ ë‹¤ë“¬ëŠ” ì „ë¬¸ê°€ì•¼. ì•„ë˜ JSON ë°ì´í„°ë¥¼ ì‚¬ìš©ìì˜ ìš”ì²­ì— ë§ê²Œ ìˆ˜ì •í•´ì¤˜.${referenceBlock}

í˜„ì¬ ë°ì´í„°:
${JSON.stringify(entry.aiData, null, 2)}

ì‚¬ìš©ì ìš”ì²­: ${instruction}

ì¡°ê±´:
1. ë°°ì—´ ê¸¸ì´ëŠ” ${entry.details?.numQuestions || entry.aiData.length}ê°œë¡œ ìœ ì§€í•´.
2. ê° ìš”ì†ŒëŠ” {"content":"ì§€ì‹œë¬¸", "materials":"ì¤€ë¹„ë¬¼"} í˜•ì‹ì„ ë”°ë¥´ê³  ë‹¤ë¥¸ ì†ì„±ì€ ì¶”ê°€í•˜ì§€ ë§ˆ.
3. contentëŠ” '~í•˜ì‹œì˜¤.'ë¡œ ëë‚˜ëŠ” ì§€ì‹œë¬¸ í˜•íƒœë¡œ ì‘ì„±í•˜ê³ , materialsëŠ” ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ì¤€ë¹„ë¬¼ ëª©ë¡ì„ ì œê³µí•´. ì¤€ë¹„ë¬¼ì´ ì—†ë‹¤ë©´ 'í•„ìš” ì¤€ë¹„ë¬¼ ì—†ìŒ'ì´ë¼ê³  ì‘ì„±í•´.
4. ì„¤ëª… ì—†ì´ JSON ë°°ì—´ë§Œ ë°˜í™˜í•´.`;

                const originalText = majorEvalModifyBtn.textContent;
                majorEvalModifyBtn.textContent = 'ìˆ˜ì • ì¤‘...';
                majorEvalModifyBtn.disabled = true;
                isMajorEvalModifying = true;

                try {
                    const result = await callGemini(prompt, true);
                    const normalized = normalizeMajorEvalData(result, entry.details?.numQuestions || entry.aiData.length);
                    if (!normalized.length) {
                        throw new Error('empty');
                    }
                    entry.aiData = normalized;
                    entry.customHtml = '';
                    clearMajorEvalManualDraft();
                    saveMajorEvalEntries();
                    renderMajorEvalList();
                    renderMajorEvalOutput(entry);
                    if (majorEvalModifyInput) majorEvalModifyInput.value = '';
                    showToast('ìˆ˜ì •ëœ ë‚´ìš©ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } catch (error) {
                    console.error('Failed to modify major evaluation sheet', error);
                    alert('ì¶œë ¥ì„ ìˆ˜ì •í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                } finally {
                    isMajorEvalModifying = false;
                    majorEvalModifyBtn.disabled = false;
                    majorEvalModifyBtn.textContent = originalText;
                }
            });
        }

        majorEvalEditToggleBtn?.addEventListener('click', () => {
            const entry = getActiveMajorEvalEntry();
            if (!entry || !hasMajorEvalOutputData(entry)) {
                alert('í¸ì§‘í•  ì‹¬ì‚¬í‘œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
                return;
            }
            if (isMajorEvalManualEditing) {
                finishMajorEvalManualEdit();
            } else {
                startMajorEvalManualEdit();
            }
        });

        majorEvalSaveBtn?.addEventListener('click', () => {
            const entry = getActiveMajorEvalEntry();
            if (!entry) {
                alert('ì €ì¥í•  ì‹¬ì‚¬í‘œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
                return;
            }
            if (isMajorEvalManualEditing) {
                alert('ìˆ˜ë™ í¸ì§‘ì„ ì™„ë£Œí•œ í›„ ì €ì¥í•´ ì£¼ì„¸ìš”.');
                return;
            }
            const htmlToSave = hasMajorEvalManualDraft && majorEvalManualDraftHtml.trim()
                ? majorEvalManualDraftHtml
                : (majorEvalOutput?.innerHTML || '');
            if (!htmlToSave.trim()) {
                alert('ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            entry.customHtml = htmlToSave;
            clearMajorEvalManualDraft();
            saveMajorEvalEntries();
            renderMajorEvalOutput(entry);
            updateMajorEvalActionButtons(entry);
            showToast('í¸ì§‘ ë‚´ìš©ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        });

        majorEvalPdfBtn?.addEventListener('click', async () => {
            const entry = getActiveMajorEvalEntry();
            if (!entry) {
                alert('ì €ì¥í•  ì‹¬ì‚¬í‘œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
                return;
            }
            if (isMajorEvalManualEditing) {
                alert('ìˆ˜ë™ í¸ì§‘ì„ ì™„ë£Œí•œ í›„ PDFë¥¼ ì €ì¥í•´ ì£¼ì„¸ìš”.');
                return;
            }
            if (!majorEvalOutput || !majorEvalOutput.innerHTML.trim()) {
                alert('ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const clone = majorEvalOutput.cloneNode(true);
            clone.querySelectorAll('button').forEach(btn => btn.remove());
            const schoolName = (entry.details?.schoolName || '').trim();
            const title = (entry.title || '').trim();
            const baseName = [schoolName, title || 'ì „ê³µê³¼ ì‹¬ì‚¬í‘œ'].filter(Boolean).join('_') || 'ì „ê³µê³¼_ì‹¬ì‚¬í‘œ';
            const filename = `${sanitizeFileName(baseName) || 'ì „ê³µê³¼_ì‹¬ì‚¬í‘œ'}.pdf`;
            const options = {
                margin: 10,
                filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            const originalText = majorEvalPdfBtn.textContent;
            majorEvalPdfBtn.disabled = true;
            majorEvalPdfBtn.textContent = 'ì €ì¥ ì¤‘...';
            try {
                await html2pdf().from(clone).set(options).save();
                showToast('PDFë¡œ ì €ì¥í–ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('Failed to save major evaluation PDF', error);
                alert('PDF ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
            } finally {
                majorEvalPdfBtn.disabled = false;
                majorEvalPdfBtn.textContent = originalText || 'PDF ì €ì¥';
            }
        });

        majorEvalQuestionIncreaseBtn?.addEventListener('click', () => {
            if (guardMajorEvalManualState('ë¬¸í•­ì„ ëŠ˜ë ¤ ì£¼ì„¸ìš”.')) return;
            const entry = getActiveMajorEvalEntry();
            if (!entry) {
                alert('ë¬¸í•­ì„ ëŠ˜ë¦´ ì‹¬ì‚¬í‘œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
                return;
            }
            if (!Array.isArray(entry.aiData) || !entry.aiData.length) {
                alert('ìƒì„±ëœ ì‹¬ì‚¬í‘œê°€ ìˆì–´ì•¼ ë¬¸í•­ì„ ëŠ˜ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            let amount = parseInt(majorEvalQuestionIncreaseInput?.value || '0', 10);
            if (!Number.isFinite(amount) || amount < 1) {
                amount = 1;
            }
            if (majorEvalQuestionIncreaseInput) {
                majorEvalQuestionIncreaseInput.value = String(amount);
            }
            const currentQuestions = Number(entry.details?.numQuestions) || entry.aiData.length;
            const newTotal = currentQuestions + amount;
            if (!entry.details) {
                entry.details = { schoolName: '', domain: '', numQuestions: newTotal, evaluationTopic: '', admissionYear: '2025' };
            }
            entry.details.numQuestions = newTotal;
            for (let i = entry.aiData.length; i < newTotal; i += 1) {
                entry.aiData.push({ content: 'ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', materials: 'í•„ìš” ì¤€ë¹„ë¬¼ ì—†ìŒ' });
            }
            entry.customHtml = '';
            clearMajorEvalManualDraft();
            saveMajorEvalEntries();
            updateMajorEvalWorkspace();
            showToast(`${amount}ê°œì˜ ë¬¸í•­ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        });

        if (majorEvalModifyInput) {
            majorEvalModifyInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    majorEvalModifyBtn?.click();
                }
            });
        }

        if (majorEvalOutput) {
            majorEvalOutput.addEventListener('click', async (event) => {
                const target = event.target;
                if (!(target instanceof HTMLElement)) return;
                const copyBtn = target.closest('button[data-copy-target]');
                if (!copyBtn) return;
                const targetId = copyBtn.dataset.copyTarget;
                if (!targetId) return;
                const selector = `#${escapeCssSelector(targetId)}`;
                const table = majorEvalOutput.querySelector(selector);
                if (!table) {
                    alert('ë³µì‚¬í•  í‘œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                try {
                    await copyHtmlToClipboard(table.outerHTML.trim());
                    showToast('í‘œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } catch (error) {
                    console.error('Failed to copy table HTML', error);
                    alert('í‘œë¥¼ ë³µì‚¬í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
                }
            });
        }

        loadMajorEvalEntries();

        const achievementTables = {
            elementary: {
                korean: `| **í•™ë…„(êµ°)** | **ë“£ê¸°â‹…ë§í•˜ê¸°** | **ì½ê¸°** | **ì“°ê¸°** | **ë¬¸ë²•** | **ë¬¸í•™** | **ë§¤ì²´** |
|---|---|---|---|---|---|---|
| 1-2 | [2êµ­01-01] ì¤‘ìš”í•œ ë‚´ìš©ì´ë‚˜ ì¼ì´ ì¼ì–´ë‚œ ìˆœì„œë¥¼ ê³ ë ¤í•˜ë©° ë“£ê³  ë§í•œë‹¤. | [2êµ­02-01] ê¸€ì, ë‹¨ì–´, ë¬¸ì¥, ì§§ì€ ê¸€ì„ ì •í™•í•˜ê²Œ ì†Œë¦¬ ë‚´ì–´ ì½ëŠ”ë‹¤. | [2êµ­03-01] ê¸€ìì™€ ë‹¨ì–´ë¥¼ ë°”ë¥´ê²Œ ì“´ë‹¤. | [2êµ­04-01] í•œê¸€ ìëª¨ì˜ ì´ë¦„ê³¼ ì†Œë¦¿ê°’ì„ ì•Œê³  ì •í™•í•˜ê²Œ ë°œìŒí•˜ê³  ì“´ë‹¤. | [2êµ­05-01] ë§ë†€ì´, ë‚±ë§ ë“±ì„ í†µí•´ ë§ì˜ ì¬ë¯¸ì™€ ì¦ê±°ì›€ì„ ëŠë‚€ë‹¤. | [2êµ­06-01] ì¼ìƒì˜ ë‹¤ì–‘í•œ ë§¤ì²´ì™€ ë§¤ì²´ ìë£Œì— í¥ë¯¸ì™€ ê´€ì‹¬ì„ ê°€ì§„ë‹¤. |
| 1-2 | [2êµ­01-02] ë°”ë¥´ê³  ê³ ìš´ ë§ë¡œ ì„œë¡œì˜ ê°ì •ì„ ë‚˜ëˆ„ë©° ë“£ê³  ë§í•œë‹¤. | [2êµ­02-02] ì˜ë¯¸ê°€ ì˜ ë“œëŸ¬ë‚˜ë„ë¡ ë¬¸ì¥ê³¼ ì§§ì€ ê¸€ì„ ì•Œë§ê²Œ ë„ì–´ ì½ëŠ”ë‹¤. | [2êµ­03-02] ì“°ê¸°ì— í¥ë¯¸ë¥¼ ê°€ì§€ë©° ìì‹ ì˜ ìƒê°ì´ë‚˜ ëŠë‚Œì„ ë¬¸ì¥ìœ¼ë¡œ í‘œí˜„í•œë‹¤. | [2êµ­04-02] ì†Œë¦¬ì™€ í‘œê¸°ê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìŒì„ ì•Œê³  ë‹¨ì–´ë¥¼ ë°”ë¥´ê²Œ ì½ê³  ì“´ë‹¤. | [2êµ­05-02] ì‘í’ˆì„ ë“£ê±°ë‚˜ ì½ìœ¼ë©´ì„œ ëŠë¼ê±°ë‚˜ ìƒê°í•œ ì ì„ ë§í•œë‹¤. | [2êµ­06-02] ì¼ìƒì˜ ê²½í—˜ê³¼ ìƒê°ì„ ê¸€ê³¼ ê·¸ë¦¼ìœ¼ë¡œ í‘œí˜„í•œë‹¤. |
| 1-2 | [2êµ­01-03] ìƒëŒ€ì˜ ë§ì„ ì§‘ì¤‘í•˜ì—¬ ë“£ê³  ë§ì°¨ë¡€ë¥¼ ì§€í‚¤ë©° ëŒ€í™”í•œë‹¤. | [2êµ­02-03] ê¸€ì„ ì½ê³  ì¤‘ì‹¬ ë‚´ìš©ì„ í™•ì¸í•œë‹¤. | [2êµ­03-03] ì£¼ë³€ ì†Œì¬ì— ëŒ€í•´ ì†Œê°œí•˜ëŠ” ê¸€ì„ ì“´ë‹¤. | [2êµ­04-03] ë¬¸ì¥ê³¼ ë¬¸ì¥ ë¶€í˜¸ë¥¼ ì•Œë§ê²Œ ì“°ê³  í•œê¸€ì— í˜¸ê¸°ì‹¬ì„ ê°€ì§„ë‹¤. | [2êµ­05-03] ì‘í’ˆ ì† ì¸ë¬¼ì˜ ëª¨ìŠµ, í–‰ë™, ë§ˆìŒì„ ìƒìƒí•˜ì—¬ ì‹œ, ë…¸ë˜, ì´ì•¼ê¸°, ê·¸ë¦¼ ë“±ìœ¼ë¡œ í‘œí˜„í•œë‹¤. | |
| 1-2 | [2êµ­01-04] ìì‹ ì˜ ê²½í—˜ì´ë‚˜ ìƒê°ì„ ë°”ë¥´ê²Œ ìì„¸íˆ ë°œí‘œí•œë‹¤. | [2êµ­02-04] ì¸ë¬¼ì˜ ë§ˆìŒì´ë‚˜ ìƒê°ì„ ì§ì‘í•˜ê³  ì´ë¥¼ ìì‹ ê³¼ ë¹„êµí•˜ë©° ê¸€ì„ ì½ëŠ”ë‹¤. | [2êµ­03-04] ê²ªì€ ì¼ì„ í‘œí˜„í•˜ëŠ” ê¸€ì„ ììœ ë¡­ê²Œ ì“°ê³ , ì“´ ê¸€ì„ í•¨ê»˜ ì½ê³  ìƒê°ì´ë‚˜ ëŠë‚Œì„ ë‚˜ëˆˆë‹¤. | | [2êµ­05-04] ì‹œë‚˜ ë…¸ë˜, ì´ì•¼ê¸°ì— í¥ë¯¸ë¥¼ ê°€ì§„ë‹¤. | |
| 1-2 | [2êµ­01-05] ë“£ê¸°ì™€ ë§í•˜ê¸°ì— ê´€ì‹¬ê³¼ í¥ë¯¸ë¥¼ ê°€ì§„ë‹¤. | [2êµ­02-05] ì½ê¸°ì— í¥ë¯¸ë¥¼ ê°€ì§€ê³  ì¦ê²¨ ì½ëŠ” íƒœë„ë¥¼ ì§€ë‹Œë‹¤. | | | | |
| 3-4 | [4êµ­01-01] ì¤‘ìš”í•œ ë‚´ìš©ê³¼ ì£¼ì œë¥¼ íŒŒì•…í•˜ë©° ë“£ê³  ê·¸ ë‚´ìš©ì„ ìš”ì•½í•œë‹¤. | [4êµ­02-01] ê¸€ì˜ ì˜ë¯¸ë¥¼ íŒŒì•…í•˜ë©° ìœ ì°½í•˜ê²Œ ê¸€ì„ ì½ëŠ”ë‹¤. | [4êµ­03-01] ì¤‘ì‹¬ ë¬¸ì¥ê³¼ ë’·ë°›ì¹¨ ë¬¸ì¥ì„ ê°–ì¶”ì–´ ë¬¸ë‹¨ì„ ì“°ê³ , ë¬¸ì¥ê³¼ ë¬¸ë‹¨ì„ ì¤‘ì‹¬ìœ¼ë¡œ ê³ ì³ ì“´ë‹¤. | [4êµ­04-01] ë‹¨ì–´ì™€ ë‹¨ì–´ ê°„ì˜ ì˜ë¯¸ ê´€ê³„ë¥¼ íŒŒì•…í•œë‹¤. | [4êµ­05-01] ì¸ë¬¼ê³¼ ì´ì•¼ê¸°ì˜ íë¦„ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì‘í’ˆì„ ê°ìƒí•œë‹¤. | [4êµ­06-01] ì¸í„°ë„·ì—ì„œ í•™ìŠµì— í•„ìš”í•œ ë‹¤ì–‘í•œ ìë£Œë¥¼ íƒìƒ‰í•˜ê³  ëª©ì ì— ë§ê²Œ ìë£Œë¥¼ ì„ íƒí•œë‹¤. |
| 3-4 | [4êµ­01-02] ì›ì¸ê³¼ ê²°ê³¼ì˜ ê´€ê³„ë¥¼ ê³ ë ¤í•˜ì—¬ ë‚´ìš©ì„ ì˜ˆì¸¡í•˜ë©° ë“£ê³  ë§í•œë‹¤. | [4êµ­02-02] ë¬¸ë‹¨ê³¼ ê¸€ì—ì„œ ì¤‘ì‹¬ ìƒê°ì„ íŒŒì•…í•˜ê³  ë‚´ìš©ì„ ê°„ì¶”ë¦°ë‹¤. | [4êµ­03-02] ì ˆì°¨ì™€ ê²°ê³¼ê°€ ë“œëŸ¬ë‚˜ê²Œ ì •í™•í•œ í‘œí˜„ìœ¼ë¡œ ë³´ê³ í•˜ëŠ” ê¸€ì„ ì“´ë‹¤. | [4êµ­04-02] ë‹¨ì–´ë¥¼ ë¶„ë¥˜í•˜ê³  êµ­ì–´ì‚¬ì „ì„ í™œìš©í•˜ì—¬ ëŠ¥ë™ì ì¸ êµ­ì–´ í™œë™ì„ í•œë‹¤. | [4êµ­05-02] ìì‹ ì˜ ê²½í—˜ì„ ë°”íƒ•ìœ¼ë¡œ ì‘í’ˆ ì† ì„¸ê³„ì™€ í˜„ì‹¤ ì„¸ê³„ë¥¼ ë¹„êµí•˜ì—¬ ì‘í’ˆì„ ê°ìƒí•œë‹¤. | [4êµ­06-02] ë§¤ì²´ë¥¼ í™œìš©í•˜ì—¬ ê°„ë‹¨í•œ ë°œí‘œ ìë£Œë¥¼ ë§Œë“ ë‹¤. |
| 3-4 | [4êµ­01-03] ìƒí™©ì— ì ì ˆí•œ ì¤€ì–¸ì–´â‹…ë¹„ì–¸ì–´ì  í‘œí˜„ì„ í™œìš©í•˜ì—¬ ë“£ê³  ë§í•œë‹¤. | [4êµ­02-03] ì§ˆë¬¸ì„ í™œìš©í•˜ì—¬ ê¸€ì„ ì˜ˆì¸¡í•˜ë©° ì½ê³  ìì‹ ì˜ ì½ê¸° ê³¼ì •ì„ ì ê²€í•œë‹¤. | [4êµ­03-03] ëŒ€ìƒì— ëŒ€í•œ ìì‹ ì˜ ì˜ê²¬ê³¼ ê·¸ë ‡ê²Œ ìƒê°í•œ ì´ìœ ê°€ ë“œëŸ¬ë‚˜ê²Œ ê¸€ì„ ì“´ë‹¤. | [4êµ­04-03] ê¸°ë³¸ì ì¸ ë¬¸ì¥ì˜ ì§œì„ì„ ì´í•´í•˜ê³  ì ì ˆí•˜ê²Œ ì‚¬ìš©í•œë‹¤. | [4êµ­05-03] ì‘í’ˆì„ ë“£ê±°ë‚˜ ì½ê³  ë§ˆìŒì— ë“œëŠ” ì‘í’ˆì„ ì†Œê°œí•œë‹¤. | [4êµ­06-03] ë§¤ì²´ ì†Œí†µ ìœ¤ë¦¬ë¥¼ ê³ ë ¤í•˜ì—¬ ë§¤ì²´ ìë£Œë¥¼ í™œìš©í•˜ê³  ê³µìœ í•œë‹¤. |
| 3-4 | [4êµ­01-04] ìƒí™©ê³¼ ìƒëŒ€ì˜ ì…ì¥ì„ ì´í•´í•˜ê³  ì˜ˆì˜ë¥¼ ì§€í‚¤ë©° ëŒ€í™”í•œë‹¤. | [4êµ­02-04] ê¸€ì— ë‚˜íƒ€ë‚œ ì‚¬ì‹¤ê³¼ ì˜ê²¬ì„ êµ¬ë¶„í•˜ê³  í•„ìì™€ ìì‹ ì˜ ì˜ê²¬ì„ ë¹„êµí•œë‹¤. | [4êµ­03-04] ëª©ì ê³¼ ì£¼ì œë¥¼ ê³ ë ¤í•˜ì—¬ ë…ìì—ê²Œ ë§ˆìŒì„ ì „í•˜ëŠ” ê¸€ì„ ì“´ë‹¤. | [4êµ­04-04] ê¸€ê³¼ ë‹´í™”ì— ì“°ì¸ ë†’ì„ í‘œí˜„ê³¼ ì§€ì‹œâ‹…ì ‘ì† í‘œí˜„ì„ ì´í•´í•˜ê³  ìƒí™©ì— ë§ê²Œ í‘œí˜„í•œë‹¤. | [4êµ­05-04] ê°ê°ì  í‘œí˜„ì— ìœ ì˜í•˜ì—¬ ì‘í’ˆì„ ê°ìƒí•˜ê³ , ê°ê°ì  í‘œí˜„ì„ í™œìš©í•˜ì—¬ ìì‹ ì˜ ìƒê°ì´ë‚˜ ê°ì •ì„ í‘œí˜„í•œë‹¤. | |
| 3-4 | [4êµ­01-05] ëª©ì ê³¼ ì£¼ì œì— ì•Œë§ê²Œ ìë£Œë¥¼ ì •ë¦¬í•˜ì—¬ ìì‹ ê° ìˆê²Œ ë°œí‘œí•œë‹¤. | [4êµ­02-05] ê¸€ì´ë‚˜ ìë£Œì˜ ì¶œì²˜ê°€ ë¯¿ì„ ë§Œí•œì§€ íŒë‹¨í•œë‹¤. | [4êµ­03-05] ìì‹ ì˜ ì“°ê¸° ê³¼ì •ì„ ì ê²€í•˜ë©° ì“°ê¸°ì— ìì‹ ê°ì„ ê°–ëŠ”ë‹¤. | [4êµ­04-05] ì–¸ì–´ê°€ ì˜ì‚¬ì†Œí†µê³¼ ê´€ê³„ í˜•ì„±ì˜ ìˆ˜ë‹¨ì„ì„ ì´í•´í•˜ê³  êµ­ì–´ë¥¼ ì†Œì¤‘íˆ ì—¬ê¸°ëŠ” íƒœë„ë¥¼ ì§€ë‹Œë‹¤. | [4êµ­05-05] ì¬ë¯¸ë‚˜ ê°ë™ì„ ëŠë¼ë©° ì‘í’ˆì„ ì¦ê²¨ ê°ìƒí•˜ëŠ” íƒœë„ë¥¼ ì§€ë‹Œë‹¤. | |
| 3-4 | [4êµ­01-06] ì£¼ì œì— ì ì ˆí•œ ì˜ê²¬ê³¼ ì´ìœ ë¥¼ ì œì‹œí•˜ê³  ì„œë¡œì˜ ìƒê°ì„ êµí™˜í•˜ë©° í† ì˜í•œë‹¤. | [4êµ­02-06] ë°”ëŒì§í•œ ì½ê¸° ìŠµê´€ì„ í˜•ì„±í•˜ê³  ì½ê¸°ì— ëŒ€í•œ ìì‹ ê°ì„ ê¸°ë¥¸ë‹¤. | | | | |
| 5-6 | [6êµ­01-01] ëŒ€í™”ì—ì„œ ìƒëµëœ ë‚´ìš©ì„ ì¶”ë¡ í•˜ë©° ë“£ëŠ”ë‹¤. | [6êµ­02-01] ê¸€ì˜ êµ¬ì¡°ë¥¼ ê³ ë ¤í•˜ë©° ì£¼ì œë‚˜ ì£¼ì¥ì„ íŒŒì•…í•˜ê³  ê¸€ ë‚´ìš©ì„ ìš”ì•½í•œë‹¤. | [6êµ­03-01] ì•Œë§ì€ ë‚´ìš©ì„ ì„ ì •í•˜ì—¬ ëŒ€ìƒì˜ íŠ¹ì„±ì´ ë‚˜íƒ€ë‚˜ê²Œ ì„¤ëª…í•˜ëŠ” ê¸€ì„ ì“´ë‹¤. | [6êµ­04-01] ìŒì„± ì–¸ì–´ ë° ë¬¸ì ì–¸ì–´ì˜ íŠ¹ì„±ì„ ì´í•´í•˜ê³  ë‹¤ì–‘í•œ ë§¤ì²´ ìë£Œì—ì„œ í‘œí˜„ íš¨ê³¼ë¥¼ í‰ê°€í•œë‹¤. | [6êµ­05-01] ì‘ê°€ì˜ ì˜ë„ë¥¼ ìƒê°í•˜ë©° ì‘í’ˆì„ ì½ëŠ”ë‹¤. | [6êµ­06-01] ì •ë³´ ê²€ìƒ‰ ë„êµ¬ë¥¼ í™œìš©í•˜ì—¬ ìì‹ ì˜ ëª©ì ì— ë§ëŠ” ë§¤ì²´ ìë£Œë¥¼ ì°¾ëŠ”ë‹¤. |
| 5-6 | [6êµ­01-02] ì£¼ì¥ì„ íŒŒì•…í•˜ê³  ì´ìœ ë‚˜ ê·¼ê±°ê°€ íƒ€ë‹¹í•œì§€ í‰ê°€í•˜ë©° ë“£ëŠ”ë‹¤. | [6êµ­02-02] ê¸€ì—ì„œ ìƒëµëœ ë‚´ìš©ì´ë‚˜ í•¨ì¶•ëœ í‘œí˜„ì„ ë¬¸ë§¥ì„ ê³ ë ¤í•˜ì—¬ ì¶”ë¡ í•œë‹¤. | [6êµ­03-02] ì ì ˆí•œ ê·¼ê±°ë¥¼ ì‚¬ìš©í•˜ê³  ì¸ìš©ì˜ ì¶œì²˜ë¥¼ ë°íˆë©° ì£¼ì¥í•˜ëŠ” ê¸€ì„ ì“´ë‹¤. | [6êµ­04-02] í‘œì¤€ì–´ì™€ ë°©ì–¸ì˜ ê¸°ëŠ¥ì„ íŒŒì•…í•˜ê³  ì–¸ì–´ ê³µë™ì²´ì™€ êµ­ì–´ìƒí™œê³¼ì˜ ê´€ê³„ë¥¼ ì´í•´í•œë‹¤. | [6êµ­05-02] ë¹„ìœ ì  í‘œí˜„ì˜ íš¨ê³¼ì— ìœ ì˜í•˜ì—¬ ì‘í’ˆì„ ê°ìƒí•œë‹¤. | [6êµ­06-02] ë‰´ìŠ¤ ë° ê°ì¢… ì •ë³´ ë§¤ì²´ ìë£Œì˜ ì‹ ë¢°ì„±ì„ í‰ê°€í•œë‹¤. |
| 5-6 | [6êµ­01-03] ì£¼ì œì™€ ê´€ë ¨í•˜ì—¬ ê¶ê¸ˆí•œ ë‚´ìš©ì„ ì§ˆë¬¸í•˜ë©° ì ê·¹ì ìœ¼ë¡œ ë“£ê³  ë§í•œë‹¤. | [6êµ­02-03] ê¸€ì´ë‚˜ ìë£Œë¥¼ ì½ê³  ë‚´ìš©ì˜ íƒ€ë‹¹ì„±ê³¼ í‘œí˜„ì˜ ì ì ˆì„±ì„ í‰ê°€í•œë‹¤. | [6êµ­03-03] ì²´í—˜í•œ ì¼ì— ëŒ€í•œ ê°ìƒì„ ë‚˜íƒ€ë‚´ëŠ” ê¸€ì„ ì“´ë‹¤. | [6êµ­04-03] ê³ ìœ ì–´ì™€ ê´€ìš© í‘œí˜„ì˜ ì“°ì„ê³¼ ê°€ì¹˜ë¥¼ ì´í•´í•˜ê³  ìƒí™©ì— ë§ê²Œ í‘œí˜„í•œë‹¤. | [6êµ­05-03] ì†Œì„¤ì´ë‚˜ ê·¹ì„ ì½ê³  ì¸ë¬¼, ì‚¬ê±´, ë°°ê²½ì„ íŒŒì•…í•œë‹¤. | [6êµ­06-03] ì í•©í•œ ì–‘ì‹ê³¼ ìˆ˜ìš©ìì˜ ë°˜ì‘ì„ ê³ ë ¤í•˜ì—¬ ë³µí•©ì–‘ì‹ ë§¤ì²´ ìë£Œë¥¼ ì œì‘í•˜ê³  ê³µìœ í•œë‹¤. |
| 5-6 | [6êµ­01-04] ë©´ë‹´ì˜ ì ˆì°¨ë¥¼ ì´í•´í•˜ê³  ìƒëŒ€ì™€ ë§¤ì²´ë¥¼ ê³ ë ¤í•˜ì—¬ ë©´ë‹´í•œë‹¤. | [6êµ­02-04] ë¬¸ì œ ìƒí™©ê³¼ ê´€ë ¨ëœ ë‹¤ì–‘í•œ ê´€ì ì˜ ê¸€ì„ ì½ê³  ì´ë¥¼ ë¬¸ì œ í•´ê²°ì— í™œìš©í•œë‹¤. | [6êµ­03-04] ë…ìì™€ ë§¤ì²´ë¥¼ ê³ ë ¤í•˜ì—¬ ë‚´ìš©ì„ ìƒì„±í•˜ê³  í‘œí˜„í•˜ë©° ê¸€ì„ ì“´ë‹¤. | [6êµ­04-04] ë¬¸ì¥ ì„±ë¶„ì„ ì´í•´í•˜ê³  í˜¸ì‘ ê´€ê³„ê°€ ì˜¬ë°”ë¥¸ ë¬¸ì¥ì„ êµ¬ì„±í•œë‹¤. | [6êµ­05-04] ì¸ìƒì ì¸ ë¶€ë¶„ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì‘í’ˆì— ëŒ€í•œ ì˜ê²¬ì„ ë‚˜ëˆˆë‹¤. | [6êµ­06-04] ìì‹ ì˜ ë§¤ì²´ ì´ìš© ì–‘ìƒì— ëŒ€í•´ ì„±ì°°í•œë‹¤. |
| 5-6 | [6êµ­01-05] ìë£Œë¥¼ ì„ ë³„í•˜ì—¬ í•µì‹¬ ì •ë³´ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ë‚´ìš©ì„ êµ¬ì„±í•˜ê³  ë§¤ì²´ë¥¼ í™œìš©í•˜ì—¬ ë°œí‘œí•œë‹¤. | [6êµ­02-05] ê¸ì •ì ì¸ ì½ê¸° ë™ê¸°ë¥¼ í˜•ì„±í•˜ê³  ì ê·¹ì ìœ¼ë¡œ ì½ê¸°ì— ì°¸ì—¬í•˜ëŠ” íƒœë„ë¥¼ ê¸°ë¥¸ë‹¤. | [6êµ­03-05] ì“°ê¸° ê³¼ì •ì„ ì ê²€â‹…ì¡°ì •í•˜ë©° ê¸€ì„ ì“°ê³ , ê¸€ ì „ì²´ë¥¼ ëŒ€ìƒìœ¼ë¡œ í†µì¼ì„± ìˆê²Œ ê³ ì³ ì“´ë‹¤. | [6êµ­04-05] ê¸€ê³¼ ë‹´í™”ì— ì“°ì¸ ì‹œê°„ í‘œí˜„ì„ ì´í•´í•˜ê³  ìƒí™©ì— ë§ê²Œ í‘œí˜„í•œë‹¤. | [6êµ­05-05] ìì‹ ì˜ ê²½í—˜ì„ ì‹œ, ì†Œì„¤, ê·¹, ìˆ˜í•„ ë“± ì ì ˆí•œ ê°ˆë˜ë¡œ í‘œí˜„í•œë‹¤. | |
| 5-6 | [6êµ­01-06] í† ì˜ì— í˜‘ë ¥ì ìœ¼ë¡œ ì°¸ì—¬í•˜ë©° ì„œë¡œì˜ ì˜ê²¬ì„ ë¹„êµí•˜ê³  ì¡°ì •í•œë‹¤. | | [6êµ­03-06] ì“°ê¸°ì— ì ê·¹ì ìœ¼ë¡œ ì°¸ì—¬í•˜ë©° ìì‹ ì˜ ê¸€ì„ ë…ìì™€ ê³µìœ í•˜ëŠ” íƒœë„ë¥¼ ì§€ë‹Œë‹¤. | [6êµ­04-06] ê¸€ê³¼ ë‹´í™”ì— ì“°ì¸ ë‹¨ì–´ ë° ë¬¸ì¥, ë„ì–´ì“°ê¸°ë¥¼ ë¯¼ê°í•˜ê²Œ ì‚´í´ ë°”ë¥´ê²Œ ê³ ì¹˜ëŠ” íƒœë„ë¥¼ ì§€ë‹Œë‹¤. | [6êµ­05-06] ì‘í’ˆì„ ì½ê³  ìì‹ ì˜ ì‚¶ê³¼ ì—°ê´€ ì§€ì–´ ì„±ì°°í•˜ëŠ” íƒœë„ë¥¼ ì§€ë‹Œë‹¤. | |
| 5-6 | [6êµ­01-07] ì ˆì°¨ì™€ ê·œì¹™ì„ ì§€í‚¤ê³  íƒ€ë‹¹í•œ ì´ìœ ì™€ ê·¼ê±°ë¥¼ ì œì‹œí•˜ë©° í† ë¡ í•œë‹¤. | | | | | |
`,
                math: `| í•™ë…„(êµ°) | ìˆ˜ì™€ ì—°ì‚° | ë³€í™”ì™€ ê´€ê³„ | ë„í˜•ê³¼ ì¸¡ì • | ìë£Œì™€ ê°€ëŠ¥ì„± |
|---|---|---|---|---|
| 1-2 | [2ìˆ˜01-01] ìˆ˜ì˜ í•„ìš”ì„±ì„ ì¸ì‹í•˜ë©´ì„œ 0ê³¼ 100ê¹Œì§€ì˜ ìˆ˜ ê°œë…ì„ ì´í•´í•˜ê³ , ìˆ˜ë¥¼ ì„¸ê³  ì½ê³  ì“¸ ìˆ˜ ìˆë‹¤. | [2ìˆ˜02-01] ë¬¼ì²´, ë¬´ëŠ¬, ìˆ˜ ë“±ì˜ ë°°ì—´ì—ì„œ ê·œì¹™ì„ ì°¾ì•„ ì—¬ëŸ¬ ê°€ì§€ ë°©ë²•ìœ¼ë¡œ í‘œí˜„í•  ìˆ˜ ìˆë‹¤. | [2ìˆ˜03-01] êµì‹¤ ë° ìƒí™œ ì£¼ë³€ì—ì„œ ì—¬ëŸ¬ ê°€ì§€ ë¬¼ê±´ì„ ê´€ì°°í•˜ì—¬ ì§ìœ¡ë©´ì²´, ì›ê¸°ë‘¥, êµ¬ì˜ ëª¨ì–‘ì„ ì°¾ê³ , ì´ë¥¼ ì´ìš©í•˜ì—¬ ì—¬ëŸ¬ ê°€ì§€ ëª¨ì–‘ì„ ë§Œë“¤ ìˆ˜ ìˆë‹¤. | [2ìˆ˜04-01] ì—¬ëŸ¬ ê°€ì§€ ì‚¬ë¬¼ì„ ì •í•´ì§„ ê¸°ì¤€ ë˜ëŠ” ìì‹ ì´ ì •í•œ ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¥˜í•˜ì—¬ ê°œìˆ˜ë¥¼ ì„¸ì–´ ë³´ê³ , ê¸°ì¤€ì— ë”°ë¥¸ ê²°ê³¼ë¥¼ ë§í•  ìˆ˜ ìˆë‹¤. |
| 1-2 | [2ìˆ˜01-02] ì¼, ì‹­, ë°±, ì²œì˜ ìë¦¿ê°’ê³¼ ìœ„ì¹˜ì  ê¸°ìˆ˜ë²•ì„ ì´í•´í•˜ê³ , ë„¤ ìë¦¬ ì´í•˜ì˜ ìˆ˜ë¥¼ ì½ê³  ì“¸ ìˆ˜ ìˆë‹¤. | [2ìˆ˜02-02] ìì‹ ì´ ì •í•œ ê·œì¹™ì— ë”°ë¼ ë¬¼ì²´, ë¬´ëŠ¬, ìˆ˜ ë“±ì„ ë°°ì—´í•  ìˆ˜ ìˆë‹¤. | [2ìˆ˜03-02] ìŒ“ê¸°ë‚˜ë¬´ë¥¼ ì´ìš©í•˜ì—¬ ì—¬ëŸ¬ ê°€ì§€ ì…ì²´ë„í˜•ì˜ ëª¨ì–‘ì„ ë§Œë“¤ê³ , ê·¸ ëª¨ì–‘ì— ëŒ€í•´ ìœ„ì¹˜ë‚˜ ë°©í–¥ì„ ì´ìš©í•˜ì—¬ ë§í•  ìˆ˜ ìˆë‹¤. | [2ìˆ˜04-02] ìë£Œë¥¼ ë¶„ë¥˜í•˜ì—¬ í‘œë¡œ ë‚˜íƒ€ë‚´ê³ , ìë£Œë¥¼ í‘œë¡œ ë‚˜íƒ€ë‚´ë©´ í¸ë¦¬í•œ ì ì„ ë§í•  ìˆ˜ ìˆë‹¤. |
| 1-2 | [2ìˆ˜01-03] ë„¤ ìë¦¬ ì´í•˜ì˜ ìˆ˜ì˜ ë²”ìœ„ì—ì„œ ìˆ˜ì˜ ê³„ì—´ì„ ì´í•´í•˜ê³ , ìˆ˜ì˜ í¬ê¸°ë¥¼ ë¹„êµí•  ìˆ˜ ìˆë‹¤. | | [2ìˆ˜03-03] êµì‹¤ ë° ìƒí™œ ì£¼ë³€ì—ì„œ ì—¬ëŸ¬ ê°€ì§€ ë¬¼ê±´ì„ ê´€ì°°í•˜ì—¬ ì‚¼ê°í˜•, ì‚¬ê°í˜•, ì›ì˜ ëª¨ì–‘ì„ ì°¾ê³ , ì´ë¥¼ ì´ìš©í•˜ì—¬ ì—¬ëŸ¬ ê°€ì§€ ëª¨ì–‘ì„ ë§Œë“¤ ìˆ˜ ìˆë‹¤. | [2ìˆ˜04-03] ìë£Œë¥¼ ë¶„ë¥˜í•˜ì—¬ â—‹, Ã—, / ë“±ì„ ì´ìš©í•œ ê·¸ë˜í”„ë¡œ ë‚˜íƒ€ë‚´ê³ , ìë£Œë¥¼ ê·¸ë˜í”„ë¡œ ë‚˜íƒ€ë‚´ë©´ í¸ë¦¬í•œ ì ì„ ë§í•  ìˆ˜ ìˆë‹¤. |
| 1-2 | [2ìˆ˜01-04] í•˜ë‚˜ì˜ ìˆ˜ë¥¼ ë‘ ìˆ˜ë¡œ ë¶„í•´í•˜ê³  ë‘ ìˆ˜ë¥¼ í•˜ë‚˜ì˜ ìˆ˜ë¡œ í•©ì„±í•˜ëŠ” í™œë™ì„ í†µí•˜ì—¬ ìˆ˜ ê°ê°ì„ ê¸°ë¥¸ë‹¤. | | [2ìˆ˜03-04] ì‚¼ê°í˜•, ì‚¬ê°í˜•, ì›ì„ ì§ê´€ì ìœ¼ë¡œ ì´í•´í•˜ê³ , ê·¸ ëª¨ì–‘ì„ ê·¸ë¦´ ìˆ˜ ìˆë‹¤. | |
| 1-2 | [2ìˆ˜01-05] ë§ì…ˆê³¼ ëº„ì…ˆì´ ì´ë£¨ì–´ì§€ëŠ” ì‹¤ìƒí™œ ìƒí™©ê³¼ ì—°ê²°í•˜ì—¬ ë§ì…ˆê³¼ ëº„ì…ˆì˜ ì˜ë¯¸ë¥¼ ì´í•´í•œë‹¤. | | [2ìˆ˜03-05] ì‚¼ê°í˜•, ì‚¬ê°í˜•ì—ì„œ ê°ê°ì˜ ê³µí†µì ì„ ì°¾ì•„ ë§í•  ìˆ˜ ìˆë‹¤. | |
| 1-2 | [2ìˆ˜01-06] ë‘ ìë¦¬ ìˆ˜ì˜ ë²”ìœ„ì—ì„œ ë§ì…ˆê³¼ ëº„ì…ˆì˜ ê³„ì‚° ì›ë¦¬ë¥¼ ì´í•´í•˜ê³  ê·¸ ê³„ì‚°ì„ í•  ìˆ˜ ìˆë‹¤. | | [2ìˆ˜03-06] êµ¬ì²´ë¬¼ì˜ ê¸¸ì´, ë“¤ì´, ë¬´ê²Œ, ë„“ì´ë¥¼ ë¹„êµí•˜ì—¬ ê°ê° â€˜ê¸¸ë‹¤, ì§§ë‹¤â€™, â€˜ë§ë‹¤, ì ë‹¤â€™, â€˜ë¬´ê²ë‹¤, ê°€ë³ë‹¤â€™, â€˜ë„“ë‹¤, ì¢ë‹¤â€™ ë“±ì„ êµ¬ë³„í•˜ì—¬ ë§í•  ìˆ˜ ìˆë‹¤. | |
| 1-2 | [2ìˆ˜01-07] ë§ì…ˆê³¼ ëº„ì…ˆì˜ ê´€ê³„ë¥¼ ì´í•´í•œë‹¤. | | [2ìˆ˜03-07] ì‹œê³„ë¥¼ ë³´ê³  ì‹œê°ì„ â€˜ëª‡ ì‹œ ëª‡ ë¶„â€™ê¹Œì§€ ì½ì„ ìˆ˜ ìˆë‹¤. | |
| 1-2 | [2ìˆ˜01-08] ë‘ ìë¦¬ ìˆ˜ì˜ ë²”ìœ„ì—ì„œ ì„¸ ìˆ˜ì˜ ë§ì…ˆê³¼ ëº„ì…ˆì„ í•  ìˆ˜ ìˆë‹¤. | | [2ìˆ˜03-08] 1ì‹œê°„ê³¼ 1ë¶„ì˜ ê´€ê³„ë¥¼ ì´í•´í•˜ê³ , ì‹œê°„ì„ â€˜ì‹œê°„â€™, â€˜ë¶„â€™ìœ¼ë¡œ í‘œí˜„í•  ìˆ˜ ìˆë‹¤. | |
| 1-2 | [2ìˆ˜01-09] â–¡ê°€ ì‚¬ìš©ëœ ë§ì…ˆì‹ê³¼ ëº„ì…ˆì‹ì„ ë§Œë“¤ê³ , â–¡ì˜ ê°’ì„ êµ¬í•  ìˆ˜ ìˆë‹¤. | | [2ìˆ˜03-09] ì‹¤ìƒí™œ ë¬¸ì œ ìƒí™©ê³¼ ì—°ê²°í•˜ì—¬ 1ë¶„, 1ì‹œê°„, 1ì¼, 1ì£¼ì¼, 1ê°œì›”, 1ë…„ ì‚¬ì´ì˜ ê´€ê³„ë¥¼ ì´í•´í•œë‹¤. | |
| 1-2 | [2ìˆ˜01-10] ê³±ì…ˆì´ ì´ë£¨ì–´ì§€ëŠ” ì‹¤ìƒí™œ ìƒí™©ê³¼ ì—°ê²°í•˜ì—¬ ê³±ì…ˆì˜ ì˜ë¯¸ë¥¼ ì´í•´í•œë‹¤. | | [2ìˆ˜03-10] ê¸¸ì´ ë‹¨ìœ„ 1cmë¥¼ ì•Œê³ , ì´ë¥¼ ì´ìš©í•˜ì—¬ ì£¼ë³€ ì‚¬ë¬¼ì˜ ê¸¸ì´ë¥¼ ì¸¡ì •í•  ìˆ˜ ìˆë‹¤. | |
| 1-2 | [2ìˆ˜01-11] ê³±ì…ˆêµ¬êµ¬ë¥¼ ì´í•´í•˜ê³ , í•œ ìë¦¬ ìˆ˜ì˜ ê³±ì…ˆì„ í•  ìˆ˜ ìˆë‹¤. | | [2ìˆ˜03-11] 1mì™€ cmì˜ ê´€ê³„ë¥¼ ì´í•´í•˜ê³ , ê¸¸ì´ë¥¼ â€˜ëª‡ mì™€ â€˜ëª‡ cmâ€™ë¡œ í‘œí˜„í•  ìˆ˜ ìˆë‹¤. | |
| 1-2 | | | [2ìˆ˜03-12] ì—¬ëŸ¬ ê°€ì§€ ë¬¼ê±´ì˜ ê¸¸ì´ë¥¼ ì–´ë¦¼í•˜ê³ , ê¸¸ì´ì— ëŒ€í•œ ê°ê°ì„ ê¸°ë¥¸ë‹¤. | |
| 1-2 | | | [2ìˆ˜03-13] ì‹¤ìƒí™œ ë¬¸ì œ ìƒí™©ê³¼ ì—°ê²°í•˜ì—¬ ê¸¸ì´ì˜ ë§ì…ˆê³¼ ëº„ì…ˆì„ í•  ìˆ˜ ìˆë‹¤. | |
| 3-4 | [4ìˆ˜01-01] í° ìˆ˜ì˜ í•„ìš”ì„±ì„ ì¸ì‹í•˜ë©´ì„œ 10000 ì´ìƒì˜ í° ìˆ˜ì— ëŒ€í•œ ìë¦¿ê°’ê³¼ ìœ„ì¹˜ì  ê¸°ìˆ˜ë²•ì„ ì´í•´í•˜ê³ , ìˆ˜ë¥¼ ì½ê³  ì“¸ ìˆ˜ ìˆë‹¤. | [4ìˆ˜02-01] ë‹¤ì–‘í•œ ë³€í™” ê·œì¹™ì„ ì°¾ì•„ ì„¤ëª…í•˜ê³ , ê·¸ ê·œì¹™ì„ ìˆ˜ë‚˜ ì‹ìœ¼ë¡œ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆë‹¤. | [4ìˆ˜03-01] ì§ì„ , ì„ ë¶„, ë°˜ì§ì„ ì„ ì´í•´í•˜ê³  êµ¬ë³„í•  ìˆ˜ ìˆë‹¤. | [4ìˆ˜04-01] ìë£Œë¥¼ ìˆ˜ì§‘í•˜ì—¬ ê·¸ë¦¼ê·¸ë˜í”„ë‚˜ ë§‰ëŒ€ê·¸ë˜í”„ë¡œ ë‚˜íƒ€ë‚´ê³  í•´ì„í•  ìˆ˜ ìˆë‹¤. |
| 3-4 | [4ìˆ˜01-02] ë‹¤ì„¯ ìë¦¬ ì´ìƒì˜ ìˆ˜ì˜ ë²”ìœ„ì—ì„œ ìˆ˜ì˜ ê³„ì—´ì„ ì´í•´í•˜ê³ , ìˆ˜ì˜ í¬ê¸°ë¥¼ ë¹„êµí•˜ë©° ê·¸ ë°©ë²•ì„ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. | [4ìˆ˜02-02] ê³„ì‚°ì‹ì˜ ë°°ì—´ì—ì„œ ê·œì¹™ì„ ì°¾ê³ , ê³„ì‚° ê²°ê³¼ë¥¼ ì¶”ì¸¡í•  ìˆ˜ ìˆë‹¤. | [4ìˆ˜03-02] ê°ê³¼ ì§ê°ì„ ì´í•´í•˜ê³ , ì§ê°ê³¼ ë¹„êµí•˜ëŠ” í™œë™ì„ í†µí•˜ì—¬ ì˜ˆê°ê³¼ ë‘”ê°ì„ êµ¬ë³„í•  ìˆ˜ ìˆë‹¤. | [4ìˆ˜04-02] ìë£Œë¥¼ ìˆ˜ì§‘í•˜ì—¬ êº¾ì€ì„ ê·¸ë˜í”„ë¡œ ë‚˜íƒ€ë‚´ê³  í•´ì„í•  ìˆ˜ ìˆë‹¤. |
| 3-4 | [4ìˆ˜01-03] ì„¸ ìë¦¬ ìˆ˜ì˜ ë§ì…ˆê³¼ ëº„ì…ˆì˜ ê³„ì‚° ì›ë¦¬ë¥¼ ì´í•´í•˜ê³  ê·¸ ê³„ì‚°ì„ í•  ìˆ˜ ìˆë‹¤. | [4ìˆ˜02-03] ë“±í˜¸ë¥¼ ì‚¬ìš©í•˜ì—¬ í¬ê¸°ê°€ ê°™ì€ ë‘ ì–‘ì˜ ê´€ê³„ë¥¼ ì‹ìœ¼ë¡œ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆë‹¤. | [4ìˆ˜03-03] ì§ì„ ì˜ ìˆ˜ì§ ê´€ê³„ì™€ í‰í–‰ ê´€ê³„ë¥¼ ì´í•´í•œë‹¤. | [4ìˆ˜04-03] íƒêµ¬ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ìë£Œë¥¼ ìˆ˜ì§‘, ì •ë¦¬í•˜ì—¬ ë§‰ëŒ€ê·¸ë˜í”„ë‚˜ êº¾ì€ì„ ê·¸ë˜í”„ë¡œ ë‚˜íƒ€ë‚´ê³  í•´ì„í•  ìˆ˜ ìˆë‹¤. |
| 3-4 | [4ìˆ˜01-04] ê³±í•˜ëŠ” ìˆ˜ê°€ í•œ ìë¦¬ ìˆ˜ ë˜ëŠ” ë‘ ìë¦¬ ìˆ˜ì¸ ê³±ì…ˆì˜ ê³„ì‚° ì›ë¦¬ë¥¼ ì´í•´í•˜ê³  ê·¸ ê³„ì‚°ì„ í•  ìˆ˜ ìˆë‹¤. | | [4ìˆ˜03-04] êµ¬ì²´ë¬¼ì´ë‚˜ í‰ë©´ë„í˜•ì˜ ë°€ê¸°, ë’¤ì§‘ê¸°, ëŒë¦¬ê¸° í™œë™ì„ í†µí•˜ì—¬ ê·¸ ë³€í™”ë¥¼ ì´í•´í•œë‹¤. | |
| 3-4 | [4ìˆ˜01-05] ë‚˜ëˆ—ì…ˆì´ ì´ë£¨ì–´ì§€ëŠ” ì‹¤ìƒí™œ ìƒí™©ê³¼ ì—°ê²°í•˜ì—¬ ë‚˜ëˆ—ì…ˆì˜ ì˜ë¯¸ë¥¼ ì•Œê³ , ê³±ì…ˆê³¼ ë‚˜ëˆ—ì…ˆì˜ ê´€ê³„ë¥¼ ì´í•´í•œë‹¤. | | [4ìˆ˜03-05] í‰ë©´ì—ì„œ ì ì˜ ì´ë™ì— ëŒ€í•´ ìœ„ì¹˜ì™€ ë°©í–¥ì„ ì´ìš©í•˜ì—¬ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. | |
| 3-4 | [4ìˆ˜01-06] ë‚˜ëˆ„ëŠ” ìˆ˜ê°€ í•œ ìë¦¬ ìˆ˜ì¸ ë‚˜ëˆ—ì…ˆì˜ ê³„ì‚° ì›ë¦¬ë¥¼ ì´í•´í•˜ê³  ê·¸ ê³„ì‚°ì„ í•  ìˆ˜ ìˆìœ¼ë©°, ë‚˜ëˆ—ì…ˆì—ì„œ ëª«ê³¼ ë‚˜ë¨¸ì§€ì˜ ì˜ë¯¸ë¥¼ ì•ˆë‹¤. | | [4ìˆ˜03-06] ì›ì˜ ì¤‘ì‹¬, ë°˜ì§€ë¦„, ì§€ë¦„ì„ ì´í•´í•˜ê³ , ê·¸ ì„±ì§ˆì„ ì•ˆë‹¤. | |
| 3-4 | [4ìˆ˜01-07] ë‚˜ëˆ„ëŠ” ìˆ˜ê°€ ë‘ ìë¦¬ ìˆ˜ì¸ ë‚˜ëˆ—ì…ˆì˜ ê³„ì‚° ì›ë¦¬ë¥¼ ì´í•´í•˜ê³  ê·¸ ê³„ì‚°ì„ í•  ìˆ˜ ìˆë‹¤. | | [4ìˆ˜03-07] ì»´í¼ìŠ¤ë¥¼ ì´ìš©í•˜ì—¬ ì—¬ëŸ¬ ê°€ì§€ í¬ê¸°ì˜ ì›ì„ ê·¸ë¦´ ìˆ˜ ìˆë‹¤. | |
| 3-4 | [4ìˆ˜01-08] ìì—°ìˆ˜ì˜ ë§ì…ˆ, ëº„ì…ˆ, ê³±ì…ˆ, ë‚˜ëˆ—ì…ˆê³¼ ê´€ë ¨í•œ ì—¬ëŸ¬ ê°€ì§€ ìƒí™©ì—ì„œ ì–´ë¦¼ì…ˆì„ í•  ìˆ˜ ìˆë‹¤. | | [4ìˆ˜03-08] ì—¬ëŸ¬ ê°€ì§€ ëª¨ì–‘ì˜ ì‚¼ê°í˜•ì— ëŒ€í•œ ë¶„ë¥˜ í™œë™ì„ í†µí•˜ì—¬ ì´ë“±ë³€ì‚¼ê°í˜•, ì •ì‚¼ê°í˜•ì„ ì´í•´í•˜ê³ , ê·¸ ì„±ì§ˆì„ íƒêµ¬í•˜ê³  ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. | |
| 3-4 | [4ìˆ˜01-09] ì–‘ì˜ ë“±ë¶„í• ì„ í†µí•˜ì—¬ ë¶„ìˆ˜ì˜ í•„ìš”ì„±ì„ ì¸ì‹í•˜ê³ , ë¶„ìˆ˜ë¥¼ ì´í•´í•˜ê³  ì½ê³  ì“¸ ìˆ˜ ìˆë‹¤. | | [4ìˆ˜03-09] ì—¬ëŸ¬ ê°€ì§€ ëª¨ì–‘ì˜ ì‚¼ê°í˜•ì— ëŒ€í•œ ë¶„ë¥˜ í™œë™ì„ í†µí•˜ì—¬ ì§ê°ì‚¼ê°í˜•, ì˜ˆê°ì‚¼ê°í˜•, ë‘”ê°ì‚¼ê°í˜•ì„ ì´í•´í•œë‹¤. | |
| 3-4 | [4ìˆ˜01-10] ë‹¨ìœ„ë¶„ìˆ˜, ì§„ë¶„ìˆ˜, ê°€ë¶„ìˆ˜, ëŒ€ë¶„ìˆ˜ë¥¼ ì•Œê³ , ê·¸ ê´€ê³„ë¥¼ ì´í•´í•œë‹¤. | | [4ìˆ˜03-10] ì—¬ëŸ¬ ê°€ì§€ ëª¨ì–‘ì˜ ì‚¬ê°í˜•ì— ëŒ€í•œ ë¶„ë¥˜ í™œë™ì„ í†µí•˜ì—¬ ì§ì‚¬ê°í˜•, ì •ì‚¬ê°í˜•, ì‚¬ë‹¤ë¦¬ê¼´, í‰í–‰ì‚¬ë³€í˜•, ë§ˆë¦„ëª¨ë¥¼ ì´í•´í•˜ê³ , ê·¸ ì„±ì§ˆì„ íƒêµ¬í•˜ê³  ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. | |
| 3-4 | [4ìˆ˜01-11] ë¶„ëª¨ê°€ ê°™ì€ ë¶„ìˆ˜ë¼ë¦¬, ë‹¨ìœ„ë¶„ìˆ˜ë¼ë¦¬ í¬ê¸°ë¥¼ ë¹„êµí•˜ê³  ê·¸ ë°©ë²•ì„ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. | | [4ìˆ˜03-11] ë‹¤ê°í˜•ê³¼ ì •ë‹¤ê°í˜•ì„ ì´í•´í•œë‹¤. | |
| 3-4 | [4ìˆ˜01-12] ë¶„ëª¨ê°€ 10ì¸ ì§„ë¶„ìˆ˜ì™€ ì—°ê²°í•˜ì—¬ ì†Œìˆ˜ í•œ ìë¦¬ ìˆ˜ë¥¼ ì´í•´í•˜ê³  ì½ê³  ì“¸ ìˆ˜ ìˆë‹¤. | | [4ìˆ˜03-12] ì£¼ì–´ì§„ ë„í˜•ì„ ì´ìš©í•˜ì—¬ ì—¬ëŸ¬ ê°€ì§€ ëª¨ì–‘ì„ ë§Œë“¤ê±°ë‚˜ ì±„ìš°ê³  ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. | |
| 3-4 | [4ìˆ˜01-13] ìë¦¿ê°’ì˜ ì›ë¦¬ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì†Œìˆ˜ ë‘ ìë¦¬ ìˆ˜ì™€ ì†Œìˆ˜ ì„¸ ìë¦¬ ìˆ˜ë¥¼ ì´í•´í•˜ê³  ì½ê³  ì“¸ ìˆ˜ ìˆë‹¤. | | [4ìˆ˜03-13] 1ë¶„ê³¼ 1ì´ˆì˜ ê´€ê³„ë¥¼ ì´í•´í•˜ê³ , ì´ˆ ë‹¨ìœ„ê¹Œì§€ ì‹œê°ì„ ì½ì„ ìˆ˜ ìˆë‹¤. | |
| 3-4 | [4ìˆ˜01-14] ì†Œìˆ˜ì˜ í¬ê¸°ë¥¼ ë¹„êµí•˜ê³  ê·¸ ë°©ë²•ì„ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. | | [4ìˆ˜03-14] ì‹¤ìƒí™œ ë¬¸ì œ ìƒí™©ê³¼ ì—°ê²°í•˜ì—¬ ì´ˆ ë‹¨ìœ„ê¹Œì§€ì˜ ì‹œê°„ì˜ ë§ì…ˆê³¼ ëº„ì…ˆì„ í•  ìˆ˜ ìˆë‹¤. | |
| 3-4 | [4ìˆ˜01-15] ë¶„ëª¨ê°€ ê°™ì€ ë¶„ìˆ˜ì˜ ë§ì…ˆê³¼ ëº„ì…ˆì˜ ê³„ì‚° ì›ë¦¬ë¥¼ ì´í•´í•˜ê³  ê·¸ ê³„ì‚°ì„ í•  ìˆ˜ ìˆë‹¤. | | [4ìˆ˜03-15] ê¸¸ì´ ë‹¨ìœ„ 1mmì™€ 1kmë¥¼ ì•Œê³ , ì´ë¥¼ ì´ìš©í•˜ì—¬ ê¸¸ì´ë¥¼ ì¸¡ì •í•˜ê³  ì–´ë¦¼í•˜ë©° ìˆ˜í•™ì˜ ìœ ìš©ì„±ì„ ì¸ì‹í•  ìˆ˜ ìˆë‹¤. | |
| 3-4 | [4ìˆ˜01-16] ì†Œìˆ˜ ë‘ ìë¦¬ ìˆ˜ì˜ ë²”ìœ„ì—ì„œ ì†Œìˆ˜ì˜ ë§ì…ˆê³¼ ëº„ì…ˆì˜ ê³„ì‚° ì›ë¦¬ë¥¼ ì´í•´í•˜ê³  ê·¸ ê³„ì‚°ì„ í•  ìˆ˜ ìˆë‹¤. | | [4ìˆ˜03-16] 1cmì™€ 1mm, 1kmì™€ 1mì˜ ê´€ê³„ë¥¼ ì´í•´í•˜ê³ , ê¸¸ì´ë¥¼ â€˜ëª‡ cm ëª‡ mmâ€™ì™€ â€˜ëª‡ mmâ€™, â€˜ëª‡ km ëª‡ mâ€™ì™€ â€˜ëª‡ mâ€™ë¡œ ë‹¤ì–‘í•˜ê²Œ í‘œí˜„í•  ìˆ˜ ìˆë‹¤. | |
| 3-4 | | | [4ìˆ˜03-17] ë“¤ì´ ë‹¨ìœ„ 1Lì™€ 1mLë¥¼ ì•Œê³ , ì´ë¥¼ ì´ìš©í•˜ì—¬ ë“¤ì´ë¥¼ ì¸¡ì •í•˜ê³  ì–´ë¦¼í•˜ë©° ìˆ˜í•™ì˜ ìœ ìš©ì„±ì„ ì¸ì‹í•  ìˆ˜ ìˆë‹¤. | |
| 3-4 | | | [4ìˆ˜03-18] 1Lì™€ 1mLì˜ ê´€ê³„ë¥¼ ì´í•´í•˜ê³ , ë“¤ì´ë¥¼ â€˜ëª‡ L ëª‡ mLâ€™ì™€ â€˜ëª‡ mLâ€™ë¡œ í‘œí˜„í•  ìˆ˜ ìˆë‹¤. | |
| 3-4 | | | [4ìˆ˜03-19] ì‹¤ìƒí™œ ë¬¸ì œ ìƒí™©ê³¼ ì—°ê²°í•˜ì—¬ ë“¤ì´ì˜ ë§ì…ˆê³¼ ëº„ì…ˆì„ í•  ìˆ˜ ìˆë‹¤. | |
| 3-4 | | | [4ìˆ˜03-20] ì‹¤ìƒí™œì—ì„œ ë¬´ê²Œë¥¼ ë‚˜íƒ€ë‚¼ ë•Œ ì‚¬ìš©í•˜ëŠ” ë‹¨ìœ„ 1gê³¼ 1kgì„ ì•Œê³ , ì´ë¥¼ ì´ìš©í•˜ì—¬ ë¬´ê²Œë¥¼ ì¸¡ì •í•˜ê³  ì–´ë¦¼í•˜ë©° ìˆ˜í•™ì˜ ìœ ìš©ì„±ì„ ì¸ì‹í•  ìˆ˜ ìˆë‹¤. | |
| 3-4 | | | [4ìˆ˜03-21] 1kgê³¼ 1gì˜ ê´€ê³„ë¥¼ ì´í•´í•˜ê³ , ë¬´ê²Œë¥¼ â€˜ëª‡ kg ëª‡ gâ€™ê³¼ â€˜ëª‡ gâ€™ìœ¼ë¡œ í‘œí˜„í•  ìˆ˜ ìˆë‹¤. | |
| 3-4 | | | [4ìˆ˜03-22] ì‹¤ìƒí™œì—ì„œ ë¬´ê²Œë¥¼ ë‚˜íƒ€ë‚¼ ë•Œ ì‚¬ìš©í•˜ëŠ” ë‹¨ìœ„ 1tì„ ì•Œê³ , 1tê³¼ 1kgì˜ ê´€ê³„ë¥¼ ì´í•´í•œë‹¤. | |
| 3-4 | | | [4ìˆ˜03-23] ì‹¤ìƒí™œ ë¬¸ì œ ìƒí™©ê³¼ ì—°ê²°í•˜ì—¬ ë¬´ê²Œì˜ ë§ì…ˆê³¼ ëº„ì…ˆì„ í•  ìˆ˜ ìˆë‹¤. | |
| 3-4 | | | [4ìˆ˜03-24] ê°ì˜ í¬ê¸°ì˜ ë‹¨ìœ„ì¸ 1ë„(Â°)ë¥¼ ì•Œê³ , ê°ë„ê¸°ë¥¼ ì´ìš©í•˜ì—¬ ê°ì˜ í¬ê¸°ë¥¼ ì¸¡ì •í•˜ê³  ì–´ë¦¼í•  ìˆ˜ ìˆë‹¤. | |
| 3-4 | | | [4ìˆ˜03-25] ì—¬ëŸ¬ ê°€ì§€ ë°©ë²•ìœ¼ë¡œ ì‚¼ê°í˜•ê³¼ ì‚¬ê°í˜•ì˜ ë‚´ê°ì˜ í¬ê¸°ì˜ í•©ì„ ì¶”ë¡ í•˜ê³ , ìì‹ ì˜ ì¶”ë¡  ê³¼ì •ì„ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. | |
| 5-6 | [6ìˆ˜01-01] ë§ì…ˆ, ëº„ì…ˆ, ê³±ì…ˆ, ë‚˜ëˆ—ì…ˆì˜ í˜¼í•© ê³„ì‚°ì—ì„œ ê³„ì‚°í•˜ëŠ” ìˆœì„œë¥¼ ì•Œê³ , í˜¼í•© ê³„ì‚°ì„ í•  ìˆ˜ ìˆë‹¤. | [6ìˆ˜02-01] í•œ ì–‘ì´ ë³€í•  ë•Œ ë‹¤ë¥¸ ì–‘ì´ ê·¸ì— ì¢…ì†í•˜ì—¬ ë³€í•˜ëŠ” ëŒ€ì‘ ê´€ê³„ë¥¼ ë‚˜íƒ€ë‚¸ í‘œì—ì„œ ê·œì¹™ì„ ì°¾ì•„ ì„¤ëª…í•˜ê³ , â–¡, â–³ ë“±ì„ ì‚¬ìš©í•˜ì—¬ ì‹ìœ¼ë¡œ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆë‹¤. | [6ìˆ˜03-01] ë„í˜•ì˜ í•©ë™ì„ ì´í•´í•˜ê³ , í•©ë™ì¸ ë„í˜•ì˜ ì„±ì§ˆì„ íƒêµ¬í•˜ê³  ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. | [6ìˆ˜04-01] í‰ê· ì˜ ì˜ë¯¸ë¥¼ ì•Œê³ , ìë£Œë¥¼ ìˆ˜ì§‘í•˜ì—¬ í‰ê· ì„ êµ¬í•˜ê³  í•´ì„í•  ìˆ˜ ìˆë‹¤. |
| 5-6 | [6ìˆ˜01-02] ì‹¤ìƒí™œê³¼ ì—°ê²°í•˜ì—¬ ì´ìƒ, ì´í•˜, ì´ˆê³¼, ë¯¸ë§Œì˜ ì˜ë¯¸ì™€ ì“°ì„ì„ ì•Œê³ , ì´ë¥¼ í™œìš©í•˜ì—¬ ìˆ˜ì˜ ë²”ìœ„ë¥¼ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆë‹¤. | [6ìˆ˜02-02] ë‘ ì–‘ì˜ í¬ê¸°ë¥¼ ë¹„êµí•˜ëŠ” ìƒí™©ì„ í†µí•´ ë¹„ì˜ ê°œë…ì„ ì´í•´í•˜ê³ , ë‘ ì–‘ì˜ ê´€ê³„ë¥¼ ë¹„ë¡œ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆë‹¤. | [6ìˆ˜03-02] ì‹¤ìƒí™œê³¼ ì—°ê²°í•˜ì—¬ ì„ ëŒ€ì¹­ë„í˜•ê³¼ ì ëŒ€ì¹­ë„í˜•ì„ ì´í•´í•˜ê³  ê·¸ë¦´ ìˆ˜ ìˆë‹¤. | [6ìˆ˜04-02] ìë£Œë¥¼ ìˆ˜ì§‘í•˜ì—¬ ë ê·¸ë˜í”„ë‚˜ ì›ê·¸ë˜í”„ë¡œ ë‚˜íƒ€ë‚´ê³  í•´ì„í•  ìˆ˜ ìˆë‹¤. |
| 5-6 | [6ìˆ˜01-03] ì–´ë¦¼ê°’ì„ êµ¬í•˜ê¸° ìœ„í•œ ë°©ë²•ìœ¼ë¡œ ì˜¬ë¦¼, ë²„ë¦¼, ë°˜ì˜¬ë¦¼ì˜ ì˜ë¯¸ì™€ í•„ìš”ì„±ì„ ì•Œê³ , ì´ë¥¼ ì‹¤ìƒí™œì— í™œìš©í•¨ìœ¼ë¡œì¨ ìˆ˜í•™ì˜ ìœ ìš©ì„±ì„ ì¸ì‹í•  ìˆ˜ ìˆë‹¤. | [6ìˆ˜02-03] ë¹„ìœ¨ì„ ì´í•´í•˜ê³ , ë¹„ìœ¨ì„ ë¶„ìˆ˜, ì†Œìˆ˜, ë°±ë¶„ìœ¨ë¡œ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆë‹¤. | [6ìˆ˜03-03] ì§ìœ¡ë©´ì²´ì™€ ì •ìœ¡ë©´ì²´ë¥¼ ì´í•´í•˜ê³ , êµ¬ì„± ìš”ì†Œì™€ ì„±ì§ˆì„ íƒêµ¬í•˜ê³  ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. | [6ìˆ˜04-03] íƒêµ¬ ë¬¸ì œë¥¼ ì„¤ì •í•˜ê³ , ê·¸ì— ë§ëŠ” ìë£Œë¥¼ ìˆ˜ì§‘, ì •ë¦¬í•˜ì—¬ ì ì ˆí•œ ê·¸ë˜í”„ë¡œ ë‚˜íƒ€ë‚´ê³  í•´ì„í•  ìˆ˜ ìˆë‹¤. |
| 5-6 | [6ìˆ˜01-04] ì•½ìˆ˜, ê³µì•½ìˆ˜, ìµœëŒ€ê³µì•½ìˆ˜ë¥¼ ì´í•´í•˜ê³  êµ¬í•  ìˆ˜ ìˆë‹¤. | [6ìˆ˜02-04] ë¹„ë¡€ì‹ì„ ì•Œê³ , ê·¸ ì„±ì§ˆì„ ì´í•´í•˜ë©°, ì´ë¥¼ í™œìš©í•˜ì—¬ ê°„ë‹¨í•œ ë¹„ë¡€ì‹ì„ í’€ ìˆ˜ ìˆë‹¤. | [6ìˆ˜03-04] ì§ìœ¡ë©´ì²´ì™€ ì •ìœ¡ë©´ì²´ì˜ ê²¨ëƒ¥ë„ì™€ ì „ê°œë„ë¥¼ ê·¸ë¦´ ìˆ˜ ìˆë‹¤. | [6ìˆ˜04-04] ì‚¬ê±´ì´ ì¼ì–´ë‚  ê°€ëŠ¥ì„±ì„ ë§ë¡œ í‘œí˜„í•˜ê³  ë¹„êµí•  ìˆ˜ ìˆë‹¤. |
| 5-6 | [6ìˆ˜01-05] ë°°ìˆ˜, ê³µë°°ìˆ˜, ìµœì†Œê³µë°°ìˆ˜ë¥¼ ì´í•´í•˜ê³  êµ¬í•  ìˆ˜ ìˆë‹¤. | [6ìˆ˜02-05] ë¹„ë¡€ë°°ë¶„ì„ ì•Œê³ , ì£¼ì–´ì§„ ì–‘ì„ ë¹„ë¡€ë°°ë¶„ í•  ìˆ˜ ìˆë‹¤. | [6ìˆ˜03-05] ê°ê¸°ë‘¥ê³¼ ê°ë¿”ì„ ì´í•´í•˜ê³ , êµ¬ì„± ìš”ì†Œì™€ ì„±ì§ˆì„ íƒêµ¬í•˜ê³  ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. | [6ìˆ˜04-05] ì‚¬ê±´ì´ ì¼ì–´ë‚  ê°€ëŠ¥ì„±ì„ ìˆ˜ë¡œ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆë‹¤. |
| 5-6 | [6ìˆ˜01-06] í¬ê¸°ê°€ ê°™ì€ ë¶„ìˆ˜ë¥¼ ë§Œë“œëŠ” ë°©ë²•ì„ ì´í•´í•˜ê³ , ë¶„ìˆ˜ë¥¼ ì•½ë¶„, í†µë¶„í•  ìˆ˜ ìˆë‹¤. | | [6ìˆ˜03-06] ê°ê¸°ë‘¥ì˜ ì „ê°œë„ë¥¼ ê·¸ë¦´ ìˆ˜ ìˆë‹¤. | [6ìˆ˜04-06] ìë£Œë¥¼ ì´ìš©í•˜ì—¬ ê°€ëŠ¥ì„±ì„ ì˜ˆìƒí•˜ê³ , ê°€ëŠ¥ì„±ì— ê·¼ê±°í•˜ì—¬ ì ì ˆí•œ íŒë‹¨ì„ ë‚´ë¦´ ìˆ˜ ìˆë‹¤. |
| 5-6 | [6ìˆ˜01-07] ë¶„ëª¨ê°€ ë‹¤ë¥¸ ë¶„ìˆ˜ì˜ í¬ê¸°ë¥¼ ë¹„êµí•˜ê³  ê·¸ ë°©ë²•ì„ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. | | [6ìˆ˜03-07] ì›ê¸°ë‘¥, ì›ë¿”, êµ¬ë¥¼ ì´í•´í•˜ê³ , êµ¬ì„± ìš”ì†Œì™€ ì„±ì§ˆì„ íƒêµ¬í•˜ê³  ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. | |
| 5-6 | [6ìˆ˜01-08] ë¶„ëª¨ê°€ ë‹¤ë¥¸ ë¶„ìˆ˜ì˜ ë§ì…ˆê³¼ ëº„ì…ˆì˜ ê³„ì‚° ì›ë¦¬ë¥¼ íƒêµ¬í•˜ê³  ê·¸ ê³„ì‚°ì„ í•  ìˆ˜ ìˆë‹¤. | | [6ìˆ˜03-08] ì›ê¸°ë‘¥ì˜ ì „ê°œë„ë¥¼ ê·¸ë¦´ ìˆ˜ ìˆë‹¤. | |
| 5-6 | [6ìˆ˜01-09] ë¶„ìˆ˜ì˜ ê³±ì…ˆì˜ ê³„ì‚° ì›ë¦¬ë¥¼ íƒêµ¬í•˜ê³  ê·¸ ê³„ì‚°ì„ í•  ìˆ˜ ìˆë‹¤. | | [6ìˆ˜03-09] ìŒ“ê¸°ë‚˜ë¬´ë¡œ ë§Œë“  ì…ì²´ë„í˜•ì„ ë³´ê³  ì‚¬ìš©ëœ ìŒ“ê¸°ë‚˜ë¬´ì˜ ê°œìˆ˜ë¥¼ êµ¬í•  ìˆ˜ ìˆë‹¤. | |
| 5-6 | [6ìˆ˜01-10] â€˜(ìì—°ìˆ˜) Ã· (ìì—°ìˆ˜)â€™ì—ì„œ ë‚˜ëˆ—ì…ˆì˜ ëª«ì„ ë¶„ìˆ˜ë¡œ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆë‹¤. | | [6ìˆ˜03-10] ìŒ“ê¸°ë‚˜ë¬´ë¡œ ë§Œë“  ì…ì²´ë„í˜•ì˜ ìœ„, ì•, ì˜†ì—ì„œ ë³¸ ëª¨ì–‘ì„ í‘œí˜„í•  ìˆ˜ ìˆê³ , ì´ëŸ¬í•œ í‘œí˜„ì„ ë³´ê³  ì…ì²´ë„í˜•ì˜ ëª¨ì–‘ì„ ì¶”ì¸¡í•  ìˆ˜ ìˆë‹¤. | |
| 5-6 | [6ìˆ˜01-11] ë¶„ìˆ˜ì˜ ë‚˜ëˆ—ì…ˆì˜ ê³„ì‚° ì›ë¦¬ë¥¼ íƒêµ¬í•˜ê³  ê·¸ ê³„ì‚°ì„ í•  ìˆ˜ ìˆë‹¤. | | [6ìˆ˜03-11] í‰ë©´ë„í˜•ì˜ ë‘˜ë ˆë¥¼ ì´í•´í•˜ê³ , ê¸°ë³¸ì ì¸ í‰ë©´ë„í˜•ì˜ ë‘˜ë ˆë¥¼ êµ¬í•  ìˆ˜ ìˆë‹¤. | |
| 5-6 | [6ìˆ˜01-12] ë¶„ìˆ˜ì™€ ì†Œìˆ˜ì˜ ê´€ê³„ë¥¼ ì´í•´í•˜ê³  í¬ê¸°ë¥¼ ë¹„êµí•˜ë©° ê·¸ ë°©ë²•ì„ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. | | [6ìˆ˜03-12] ë„“ì´ ë‹¨ìœ„ 1cmÂ², 1mÂ², 1kmÂ²ë¥¼ ì•Œë©°, ê·¸ ê´€ê³„ë¥¼ ì´í•´í•œë‹¤. | |
| 5-6 | [6ìˆ˜01-13] ì†Œìˆ˜ì˜ ê³±ì…ˆì˜ ê³„ì‚° ì›ë¦¬ë¥¼ íƒêµ¬í•˜ê³  ê·¸ ê³„ì‚°ì„ í•  ìˆ˜ ìˆë‹¤. | | [6ìˆ˜03-13] ì§ì‚¬ê°í˜•ê³¼ ì •ì‚¬ê°í˜•ì˜ ë„“ì´ë¥¼ êµ¬í•˜ëŠ” ë°©ë²•ì„ ì´í•´í•˜ê³ , ì´ë¥¼ êµ¬í•  ìˆ˜ ìˆë‹¤. | |
| 5-6 | [6ìˆ˜01-14] â€˜(ìì—°ìˆ˜) Ã· (ìì—°ìˆ˜)â€™ì—ì„œ ë‚˜ëˆ—ì…ˆì˜ ëª«ì„ ì†Œìˆ˜ë¡œ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆë‹¤. | | [6ìˆ˜03-14] í‰í–‰ì‚¬ë³€í˜•, ì‚¼ê°í˜•, ì‚¬ë‹¤ë¦¬ê¼´, ë§ˆë¦„ëª¨ì˜ ë„“ì´ë¥¼ êµ¬í•˜ëŠ” ë°©ë²•ì„ ë‹¤ì–‘í•˜ê²Œ ì¶”ë¡ í•˜ê³ , ì´ì™€ ê´€ë ¨ëœ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆë‹¤. | |
| 5-6 | [6ìˆ˜01-15] ì†Œìˆ˜ì˜ ë‚˜ëˆ—ì…ˆì˜ ê³„ì‚° ì›ë¦¬ë¥¼ íƒêµ¬í•˜ê³  ê·¸ ê³„ì‚°ì„ í•  ìˆ˜ ìˆë‹¤. | | [6ìˆ˜03-15] ì—¬ëŸ¬ ê°€ì§€ ì› ëª¨ì–‘ ë¬¼ì²´ì˜ ì›ì£¼ì™€ ì§€ë¦„ì„ ì¸¡ì •í•˜ëŠ” í™œë™ì„ í†µí•˜ì—¬, ì›ì£¼ìœ¨ì´ ì¼ì •í•œ ê°’ì„ì„ ì•Œê³  ê·¸ ê·¼ì‚¿ê°’ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. | |
| 5-6 | | | [6ìˆ˜03-16] ì›ì£¼ì™€ ì›ì˜ ë„“ì´ë¥¼ êµ¬í•˜ëŠ” ë°©ë²•ì„ ì´í•´í•˜ê³ , ì´ë¥¼ êµ¬í•  ìˆ˜ ìˆë‹¤. | |
| 5-6 | | | [6ìˆ˜03-17] ì§ìœ¡ë©´ì²´ì™€ ì •ìœ¡ë©´ì²´ì˜ ê²‰ë„“ì´ë¥¼ êµ¬í•˜ëŠ” ë°©ë²•ì„ ì´í•´í•˜ê³ , ì´ë¥¼ êµ¬í•  ìˆ˜ ìˆë‹¤. | |
| 5-6 | | | [6ìˆ˜03-18] ë¶€í”¼ ë‹¨ìœ„ 1cmÂ³, 1mÂ³ë¥¼ ì•Œë©°, ê·¸ ê´€ê³„ë¥¼ ì´í•´í•œë‹¤. | |
| 5-6 | | | [6ìˆ˜03-19] ì§ìœ¡ë©´ì²´ì™€ ì •ìœ¡ë©´ì²´ì˜ ë¶€í”¼ë¥¼ êµ¬í•˜ëŠ” ë°©ë²•ì„ ì´í•´í•˜ê³ , ì´ë¥¼ êµ¬í•  ìˆ˜ ìˆë‹¤. | |
`
            }
        };

        function setActiveButton(container, value) {
            container.querySelectorAll('button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === value);
            });
        }

        function getActiveValue(container) {
            const active = container.querySelector('.active');
            return active ? active.dataset.value : null;
        }

        function markdownTableToHtml(md) {
            const lines = md.trim().split('\n');
            const headers = lines[0].split('|').slice(1, -1).map(s => s.trim());
            const rows = lines.slice(2).map(line => line.split('|').slice(1, -1).map(s => s.trim()));
            const firstColWidth = 20;
            const otherColWidth = headers.length > 1 ? (80 / (headers.length - 1)) : 80;
            const firstWidthStyle = `style="width: ${headers.length === 1 ? 100 : firstColWidth}%"`;
            const otherWidthStyle = headers.length > 1 ? `style="width: ${otherColWidth.toFixed(2)}%"` : '';
            let html = '<table data-markdown-table="true" class="min-w-full border border-gray-300 text-sm"><thead><tr>';
            headers.forEach((h, idx) => {
                const widthStyle = idx === 0 ? firstWidthStyle : otherWidthStyle;
                const widthAttr = widthStyle ? `${widthStyle} ` : '';
                const headerContent = h.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                html += `<th ${widthAttr}class="border px-2 py-1 bg-gray-100"><div class="flex items-center gap-1"><button type="button" class="markdown-table-remove-column" title="ì—´ ì‚­ì œ" aria-label="ì—´ ì‚­ì œ">Ã—</button><span class="flex-1">${headerContent}</span></div></th>`;
            });
            html += '</tr></thead><tbody>';
            rows.forEach(row => {
                html += '<tr>';
                row.forEach((cell, cellIdx) => {
                    const widthStyle = cellIdx === 0 ? firstWidthStyle : otherWidthStyle;
                    const widthAttr = widthStyle ? `${widthStyle} ` : '';
                    html += `<td ${widthAttr}class="border px-2 py-1 align-top">${cell.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            return html;
        }

        function adjustMarkdownTableColumnWidths(table) {
            const rows = table ? Array.from(table.querySelectorAll('tr')) : [];
            if (!rows.length) return;
            const headerRow = table.querySelector('thead tr') || rows[0];
            const colCount = headerRow ? headerRow.children.length : 0;
            if (!colCount) return;
            const firstColWidth = colCount === 1 ? 100 : 20;
            const otherColWidth = colCount > 1 ? 80 / (colCount - 1) : 0;
            rows.forEach(row => {
                Array.from(row.children).forEach((cell, idx) => {
                    if (colCount === 1) {
                        cell.style.width = '100%';
                    } else if (idx === 0) {
                        cell.style.width = `${firstColWidth}%`;
                    } else {
                        cell.style.width = `${otherColWidth.toFixed(2)}%`;
                    }
                });
            });
        }

        document.addEventListener('click', (event) => {
            const button = event.target.closest('.markdown-table-remove-column');
            if (!button) return;
            const th = button.closest('th');
            if (!th) return;
            const table = th.closest('table');
            if (!table || table.dataset.markdownTable !== 'true') return;
            const row = th.parentElement;
            const colIndex = Array.from(row.children).indexOf(th);
            if (colIndex < 0) return;
            table.querySelectorAll('tr').forEach(rowElement => {
                const cell = rowElement.children[colIndex];
                if (cell) {
                    cell.remove();
                }
            });
            adjustMarkdownTableColumnWidths(table);
        });

        function setButtonState(btn, state) {
            btn.dataset.state = state;
            btn.classList.remove('bg-yellow-200', 'bg-green-200', 'bg-opacity-50');
            if (state === 1) {
                btn.classList.add('bg-yellow-200', 'bg-opacity-50');
            } else if (state === 2) {
                btn.classList.add('bg-green-200', 'bg-opacity-50');
            }
        }

        function makeAchievementTableInteractive() {
            const table = achievementTableContainer.querySelector('table');
            if (!table) return;
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(tr => {
                for (let i = 1; i < tr.cells.length; i++) {
                    const cell = tr.cells[i];
                    const text = cell.textContent;
                    cell.innerHTML = `<button type="button" class="w-full text-left px-1 py-0.5 rounded" data-state="0">${text}</button>`;
                    const btn = cell.querySelector('button');
                    btn.addEventListener('click', () => {
                        let state = parseInt(btn.dataset.state);
                        state = (state + 1) % 3;
                        setButtonState(btn, state);
                    });
                }
            });
        }

        function applyAchievementStates() {
            const key = `${getActiveValue(levelButtons)}_${getActiveValue(subjectButtons)}`;
            const stateRows = currentAchievementData[key];
            if (!stateRows) return;
            const rows = achievementTableContainer.querySelectorAll('tbody tr');
            rows.forEach((tr, rowIdx) => {
                for (let i = 1; i < tr.cells.length; i++) {
                    const btn = tr.cells[i].querySelector('button');
                    const state = stateRows[rowIdx]?.[i - 1] || 0;
                    setButtonState(btn, state);
                }
            });
        }

        function applyGradeFilter() {
            const grade = getActiveValue(gradeButtons);
            const rows = achievementTableContainer.querySelectorAll('tbody tr');
            rows.forEach(tr => {
                const rowGrade = tr.cells[0].textContent.trim();
                tr.style.display = (grade === 'all' || rowGrade === grade) ? '' : 'none';
            });
        }

        function updateGradeButtons() {
            const level = getActiveValue(levelButtons);
            let options = [];
            if (level === 'elementary') {
                options = [
                    { value: 'all', label: 'ì „ì²´' },
                    { value: '1-2', label: '1-2í•™ë…„' },
                    { value: '3-4', label: '3-4í•™ë…„' },
                    { value: '5-6', label: '5-6í•™ë…„' },
                ];
            } else {
                options = [
                    { value: 'all', label: 'ì „ì²´' },
                    { value: '1', label: '1' },
                    { value: '2', label: '2' },
                    { value: '3', label: '3' },
                ];
            }
            gradeButtons.innerHTML = options.map(o => `<button data-value="${o.value}" class="tab-btn py-1 px-3 rounded">${o.label}</button>`).join('');
            gradeButtons.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => {
                    setActiveButton(gradeButtons, btn.dataset.value);
                    applyGradeFilter();
                });
            });
            setActiveButton(gradeButtons, 'all');
        }

        function loadAchievementTable() {
            const level = getActiveValue(levelButtons);
            const subject = getActiveValue(subjectButtons);
            const md = achievementTables[level]?.[subject];
            if (md) {
                achievementTableContainer.innerHTML = markdownTableToHtml(md);
                makeAchievementTableInteractive();
                applyAchievementStates();
                applyGradeFilter();
            } else {
                achievementTableContainer.innerHTML = '<p class="text-gray-500">ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</p>';
            }
        }

        async function openAchievementView(studentName) {
            const user = auth.currentUser;
            if (!user) return;
            currentAchievementStudent = studentName;
            const docRef = doc(db, 'users', user.uid, 'achievements', studentName);
            const snap = await getDoc(docRef);
            currentAchievementData = snap.exists() ? (snap.data().data || {}) : {};
            document.getElementById('achievement-student').textContent = `${studentName} í•™ìƒ`;
            setActiveButton(levelButtons, 'elementary');
            setActiveButton(subjectButtons, 'korean');
            updateGradeButtons();
            loadAchievementTable();
            switchView('achievement').catch(console.error);
        }


        // --- IEP View Logic ---
        const iepStudentList = document.getElementById('iep-student-list');
        const iepOutputContainer = document.getElementById('iep-output');
        let currentIepStudent = '';
        let currentIepDocId = '';
        let isLoadingIepStudents = false;
        let lastKoreanList = [];
        let lastMathList = [];
        let currentIepSemester = 1;
        const lastSemesterGoals = {
            korean: [],
            math: []
        };
        const pageDescriptions = {
            'page-1': '1í˜ì´ì§€(í‘œì§€)',
            'page-2': '2í˜ì´ì§€(ì„±ì·¨ ê¸°ì¤€ - êµ­ì–´)',
            'page-3': '3í˜ì´ì§€(ì„±ì·¨ ê¸°ì¤€ - ìˆ˜í•™)',
            'page-4': '4í˜ì´ì§€(í•™ê¸°ë³„ êµìœ¡ ëª©í‘œ)',
            'page-5': '5í˜ì´ì§€(ì›”ë³„ êµìœ¡ ëª©í‘œ - êµ­ì–´)',
            'page-6': '6í˜ì´ì§€(ì›”ë³„ êµìœ¡ ëª©í‘œ - ìˆ˜í•™)',
            'page-7': '7í˜ì´ì§€(ì›”ë³„ êµìœ¡ ëª©í‘œ - êµ­ì–´)',
            'page-8': '8í˜ì´ì§€(ì›”ë³„ êµìœ¡ ëª©í‘œ - ìˆ˜í•™)',
            'page-9': '9í˜ì´ì§€(ì›”ë³„ êµìœ¡ ëª©í‘œ - êµ­ì–´)',
            'page-10': '10í˜ì´ì§€(ì›”ë³„ êµìœ¡ ëª©í‘œ - ìˆ˜í•™)',
            'page-11': '11í˜ì´ì§€(ì›”ë³„ êµìœ¡ ëª©í‘œ - êµ­ì–´)',
            'page-12': '12í˜ì´ì§€(ì›”ë³„ êµìœ¡ ëª©í‘œ - ìˆ˜í•™)',
            'page-13': '13í˜ì´ì§€(ì›”ë³„ êµìœ¡ ëª©í‘œ - êµ­ì–´)',
            'page-14': '14í˜ì´ì§€(ì›”ë³„ êµìœ¡ ëª©í‘œ - ìˆ˜í•™)',
            'page-15': '15í˜ì´ì§€(í•™ê¸° í‰ê°€)',
            'all': 'ì „ì²´'
        };

        function setBasePageDescriptions() {
            pageDescriptions['page-1'] = '1í˜ì´ì§€(í‘œì§€)';
            pageDescriptions['page-2'] = '2í˜ì´ì§€(ì„±ì·¨ ê¸°ì¤€ - êµ­ì–´)';
            pageDescriptions['page-3'] = '3í˜ì´ì§€(ì„±ì·¨ ê¸°ì¤€ - ìˆ˜í•™)';
            pageDescriptions['page-4'] = '4í˜ì´ì§€(í•™ê¸°ë³„ êµìœ¡ ëª©í‘œ)';
            Object.keys(pageDescriptions).forEach(key => {
                const match = key.match(/^page-(\d+)$/);
                if (!match) return;
                if (Number(match[1]) >= 5) {
                    delete pageDescriptions[key];
                }
            });
        }

        const modifyInput = document.getElementById('iep-modify-input');
        const modifyBtn = document.getElementById('iep-modify-btn');
        const modifyTargetsContainer = document.getElementById('iep-modify-targets');
        const generationSection = document.getElementById('iep-generation-section');
        const saveSection = document.getElementById('iep-save-section');
        const manualEditBtn = document.getElementById('iep-manual-edit-btn');
        const achievementButton = document.getElementById('iep-achievement-btn');
        const generateSemesterBtn = document.getElementById('generate-semester-goals-btn');
        const generateMonthlyBtn = document.getElementById('generate-monthly-plan-btn');
        const saveIepButton = document.getElementById('save-iep-btn');
        const savePdfButton = document.getElementById('save-pdf-btn');
        let currentModifyTarget = 'page-1';
        let manualEditMode = false;
        let manualEditNode = null;

        function getModifyTargetEntries() {
            const entries = [
                { value: 'page-1', label: 'í‘œì§€' },
                { value: 'page-2', label: 'ì„±ì·¨ê¸°ì¤€-êµ­ì–´' },
                { value: 'page-3', label: 'ì„±ì·¨ê¸°ì¤€-ìˆ˜í•™' },
                { value: 'page-4', label: 'í•™ê¸° êµìœ¡ëª©í‘œ' }
            ];
            const contentRoot = document.getElementById('iep-content');
            if (contentRoot) {
                const months = getSemesterMonths(currentIepSemester);
                const monthlyPages = Array.from(contentRoot.querySelectorAll('.iep-page[data-month-index]'));
                monthlyPages.sort((a, b) => {
                    const aPage = Number(a.getAttribute('data-page')) || 0;
                    const bPage = Number(b.getAttribute('data-page')) || 0;
                    return aPage - bPage;
                });
                monthlyPages.forEach(page => {
                    const pageValue = page.getAttribute('data-page');
                    if (!pageValue) return;
                    const monthIdx = Number(page.getAttribute('data-month-index')) || 0;
                    const subjectKey = page.getAttribute('data-subject') || 'korean';
                    const subjectLabel = subjectKey === 'math' ? 'ìˆ˜í•™' : 'êµ­ì–´';
                    const monthLabel = months[monthIdx]?.actual || `${monthIdx + 1}ì›”`;
                    entries.push({ value: `page-${pageValue}`, label: `ì›”(${monthLabel})-${subjectLabel}` });
                });
                const evaluationPage = contentRoot.querySelector('.iep-page[data-semester-evaluation="true"]');
                if (evaluationPage) {
                    const evalPageValue = evaluationPage.getAttribute('data-page');
                    if (evalPageValue) {
                        entries.push({ value: `page-${evalPageValue}`, label: 'í•™ê¸° í‰ê°€' });
                    }
                }
            }
            entries.push({ value: 'all', label: 'ì „ì²´' });
            const seen = new Set();
            return entries.filter(entry => {
                if (!entry.value || seen.has(entry.value)) return false;
                seen.add(entry.value);
                return true;
            });
        }

        function renderModifyTargetButtons() {
            if (!modifyTargetsContainer) return;
            const entries = getModifyTargetEntries();
            if (!entries.length) {
                modifyTargetsContainer.innerHTML = '';
                return;
            }
            if (!entries.some(entry => entry.value === currentModifyTarget)) {
                currentModifyTarget = entries[0].value;
            }
            modifyTargetsContainer.innerHTML = '';
            entries.forEach(entry => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'modify-target-btn';
                btn.dataset.target = entry.value;
                btn.textContent = entry.label;
                if (entry.value === currentModifyTarget) {
                    btn.classList.add('active');
                }
                btn.addEventListener('click', () => handleModifyTargetSelection(entry.value));
                modifyTargetsContainer.appendChild(btn);
            });
        }

        function updateModifyTargetActiveState() {
            if (!modifyTargetsContainer) return;
            modifyTargetsContainer.querySelectorAll('button').forEach(btn => {
                if (btn.dataset.target === currentModifyTarget) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function handleModifyTargetSelection(value) {
            if (manualEditMode) {
                alert('ìˆ˜ë™ í¸ì§‘ì„ ì™„ë£Œí•œ í›„ ë‹¤ë¥¸ í•­ëª©ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
                return;
            }
            currentModifyTarget = value;
            updateModifyTargetActiveState();
        }

        function exitManualEditMode(skipSync = false) {
            if (!manualEditMode) return;
            if (manualEditNode) {
                manualEditNode.removeAttribute('contenteditable');
                manualEditNode.classList.remove('manual-editing');
            }
            manualEditMode = false;
            manualEditNode = null;
            if (manualEditBtn) manualEditBtn.textContent = 'ìˆ˜ë™ í¸ì§‘';
            if (modifyBtn) modifyBtn.disabled = false;
            if (!skipSync) {
                normalizeIepPages(document.getElementById('iep-content'));
                updateMonthlyPageDisplays();
                extractSemesterGoalsFromDom();
            }
        }

        function startManualEdit() {
            if (manualEditMode) return;
            if (!currentModifyTarget) {
                alert('ìˆ˜ì •í•  í•­ëª©ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
                return;
            }
            const contentRoot = document.getElementById('iep-content');
            if (!contentRoot) {
                alert('í¸ì§‘í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            let targetNode = null;
            if (currentModifyTarget === 'all') {
                targetNode = contentRoot;
            } else {
                targetNode = findIepPageNode(currentModifyTarget);
            }
            if (!targetNode) {
                alert('ì„ íƒí•œ í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const editableNode = currentModifyTarget === 'all'
                ? targetNode
                : (targetNode.querySelector('.iep-page-inner') || targetNode);
            manualEditMode = true;
            manualEditNode = editableNode;
            editableNode.setAttribute('contenteditable', 'true');
            editableNode.classList.add('manual-editing');
            if (modifyBtn) modifyBtn.disabled = true;
            if (manualEditBtn) manualEditBtn.textContent = 'ì™„ë£Œ';
            setTimeout(() => {
                try {
                    editableNode.focus();
                } catch (err) {
                    console.warn('Unable to focus editable node', err);
                }
            }, 0);
        }

        manualEditBtn?.addEventListener('click', () => {
            if (manualEditMode) {
                exitManualEditMode();
            } else {
                startManualEdit();
            }
        });

        achievementButton?.addEventListener('click', () => {
            if (manualEditMode) {
                alert('ìˆ˜ë™ í¸ì§‘ì„ ì™„ë£Œí•œ í›„ ì´ë™í•´ ì£¼ì„¸ìš”.');
                return;
            }
            if (currentIepStudent) {
                openAchievementView(currentIepStudent);
            }
        });

        generateSemesterBtn?.addEventListener('click', async () => {
            if (manualEditMode) {
                alert('ìˆ˜ë™ í¸ì§‘ì„ ì™„ë£Œí•œ í›„ ìƒì„± ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.');
                return;
            }
            await generateSemesterGoals(lastKoreanList, lastMathList);
            generateMonthlyBtn?.classList.remove('hidden');
        });

        generateMonthlyBtn?.addEventListener('click', async () => {
            if (manualEditMode) {
                alert('ìˆ˜ë™ í¸ì§‘ì„ ì™„ë£Œí•œ í›„ ìƒì„± ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.');
                return;
            }
            await generateMonthlyPlans(lastKoreanList, lastMathList);
        });

        saveIepButton?.addEventListener('click', async () => {
            if (manualEditMode) {
                alert('ìˆ˜ë™ í¸ì§‘ì„ ì™„ë£Œí•œ í›„ ì €ì¥í•´ ì£¼ì„¸ìš”.');
                return;
            }
            try {
                await handleIepSave();
            } catch (error) {
                console.error('IEP ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
                alert('IEP ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        savePdfButton?.addEventListener('click', () => {
            if (manualEditMode) {
                alert('ìˆ˜ë™ í¸ì§‘ì„ ì™„ë£Œí•œ í›„ PDFë¥¼ ì €ì¥í•´ ì£¼ì„¸ìš”.');
                return;
            }
            saveIepPdf().catch(err => console.error('PDF ì €ì¥ ì‹¤íŒ¨', err));
        });

        async function loadIepStudents() {
            const user = auth.currentUser;
            if (!user || isLoadingIepStudents) return;
            isLoadingIepStudents = true;
            iepStudentList.innerHTML = '<p class="text-gray-500">ë¡œë”© ì¤‘...</p>';
            const classRef = doc(db, 'classes', user.uid);
            try {
                const classSnap = await getDoc(classRef);
                iepStudentList.innerHTML = '';
                if (!classSnap.exists()) {
                    iepStudentList.innerHTML = '<p class="text-gray-500">ìƒì„±ëœ í•™ê¸‰ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }
                const studentIds = classSnap.data().students || [];
                if (studentIds.length === 0) {
                    iepStudentList.innerHTML = '<p class="text-gray-500">í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    for (const sid of studentIds) {
                        try {
                            const sd = await getDoc(doc(db, 'users', sid));
                            if (sd.exists()) {
                                const s = sd.data();
                                const studentEl = document.createElement('div');
                                studentEl.className = 'p-3 border rounded-md cursor-pointer hover:bg-sky-50';
                                studentEl.textContent = s.name || sid;
                                studentEl.addEventListener('click', () => showIepList(s.name || sid));
                                iepStudentList.appendChild(studentEl);
                            }
                        } catch (err) {
                            console.error(err);
                        }
                    }
                }
            } catch (error) {
                iepStudentList.innerHTML = '<p class="text-red-500">í•™ê¸‰ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
            } finally {
                isLoadingIepStudents = false;
            }
        }

        function showModifySection() {
            const section = document.getElementById('iep-modify-section');
            section?.classList.remove('hidden');
            saveSection?.classList.remove('hidden');
            generationSection?.classList.remove('hidden');
            renderModifyTargetButtons();
            updateModifyTargetActiveState();
        }

        function hideModifySection() {
            const section = document.getElementById('iep-modify-section');
            section?.classList.add('hidden');
            saveSection?.classList.add('hidden');
            generationSection?.classList.add('hidden');
            generateMonthlyBtn?.classList.add('hidden');
            exitManualEditMode(true);
            currentModifyTarget = 'page-1';
            if (modifyTargetsContainer) {
                modifyTargetsContainer.innerHTML = '';
            }
        }

        async function showIepList(studentName) {
            currentIepStudent = studentName;
            currentIepDocId = '';
            hideModifySection();
            iepOutputContainer.innerHTML = '<p class="text-gray-500">ë¡œë”© ì¤‘...</p>';
            const user = auth.currentUser;
            if (!user) return;
            const iepRef = collection(db, 'users', user.uid, 'ieps');
            const q = query(iepRef, where('student', '==', studentName), orderBy('createdAt', 'desc'));
            const snap = await getDocs(q);
            let html = `<div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">${studentName} IEP ëª©ë¡</h3><button id="add-iep-btn" class="bg-sky-600 hover:bg-sky-700 text-white text-sm px-3 py-1 rounded">+ì¶”ê°€</button></div>`;
            if (snap.empty) {
                html += '<p class="text-gray-500">IEPê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                html += '<ul class="space-y-2">';
                snap.forEach(doc => {
                    const d = doc.data();
                    const date = d.createdAt?.toDate ? d.createdAt.toDate().toLocaleDateString() : '';
                    html += `<li class="p-2 border rounded flex justify-between items-center hover:bg-sky-50 cursor-pointer" data-id="${doc.id}">
                                <div class="flex flex-col flex-grow">
                                    <span class="iep-title">${d.title}</span>
                                    <span class="text-xs text-gray-500">${date}</span>
                                </div>
                                <div class="flex-shrink-0 space-x-1 ml-2">
                                    <button class="iep-rename-btn text-xs text-sky-600">ì´ë¦„ í¸ì§‘</button>
                                    <button class="iep-copy-btn text-xs text-green-600">ë³µì‚¬</button>
                                    <button class="iep-delete-btn text-xs text-red-600">ì‚­ì œ</button>
                                </div>
                              </li>`;
                });
                html += '</ul>';
            }
            iepOutputContainer.innerHTML = html;
            pageDescriptions['page-1'] = '1í˜ì´ì§€(í‘œì§€)';
            pageDescriptions['page-2'] = '2í˜ì´ì§€(ì„±ì·¨ ê¸°ì¤€ - êµ­ì–´)';
            pageDescriptions['page-3'] = '3í˜ì´ì§€(ì„±ì·¨ ê¸°ì¤€ - ìˆ˜í•™)';
            pageDescriptions['page-4'] = '4í˜ì´ì§€(í•™ê¸°ë³„ êµìœ¡ ëª©í‘œ)';
            document.getElementById('add-iep-btn').addEventListener('click', () => addIep(studentName));
            iepOutputContainer.querySelectorAll('li[data-id]').forEach(el => {
                el.addEventListener('click', (e) => {
                    if (e.target.closest('button')) return;
                    openIepDocument(el.dataset.id, studentName);
                });
            });
            iepOutputContainer.querySelectorAll('.iep-delete-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    const id = btn.closest('li').dataset.id;
                    deleteIep(id, studentName);
                });
            });
            iepOutputContainer.querySelectorAll('.iep-rename-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    const li = btn.closest('li');
                    const id = li.dataset.id;
                    const title = li.querySelector('.iep-title').textContent;
                    renameIep(id, studentName, title);
                });
            });
            iepOutputContainer.querySelectorAll('.iep-copy-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    const id = btn.closest('li').dataset.id;
                    copyIep(id, studentName);
                });
            });
        }

        async function addIep(studentName) {
            const user = auth.currentUser;
            if (!user) return;
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const semester = (month >= 8 || month <= 1) ? 2 : 1;
            const title = `${year}í•™ë…„ë„ ${semester}í•™ê¸° ê°œë³„í™”êµìœ¡ê³„íš(${studentName})`;
            const docRef = await addDoc(collection(db, 'users', user.uid, 'ieps'), {
                student: studentName,
                title,
                createdAt: serverTimestamp(),
                content: ''
            });
            showIepList(studentName);
            openIepDocument(docRef.id, studentName);
        }

        async function deleteIep(id, studentName) {
            const user = auth.currentUser;
            if (!user) return;
            if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            await deleteDoc(doc(db, 'users', user.uid, 'ieps', id));
            showIepList(studentName);
            showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        }

        async function renameIep(id, studentName, oldTitle) {
            const user = auth.currentUser;
            if (!user) return;
            const newTitle = prompt('ìƒˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', oldTitle);
            if (!newTitle || !newTitle.trim()) return;
            await updateDoc(doc(db, 'users', user.uid, 'ieps', id), { title: newTitle.trim() });
            showIepList(studentName);
            showToast('ì´ë¦„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤');
        }

        async function copyIep(id, studentName) {
            const user = auth.currentUser;
            if (!user) return;
            const docRef = doc(db, 'users', user.uid, 'ieps', id);
            const snap = await getDoc(docRef);
            if (!snap.exists()) return;
            const data = snap.data();
            const baseTitle = data.title;
            const iepRef = collection(db, 'users', user.uid, 'ieps');
            const q = query(iepRef, where('student', '==', studentName));
            const all = await getDocs(q);
            let maxCopy = 0;
            all.forEach(d => {
                const match = d.data().title.match(new RegExp(`^${baseTitle} - ë³µì‚¬ë³¸\\((\\d+)\\)$`));
                if (match) {
                    const num = parseInt(match[1]);
                    if (num > maxCopy) maxCopy = num;
                }
            });
            const newTitle = `${baseTitle} - ë³µì‚¬ë³¸(${maxCopy + 1})`;
            const newDoc = await addDoc(iepRef, {
                student: studentName,
                title: newTitle,
                createdAt: serverTimestamp(),
                content: data.content || ''
            });
            showIepList(studentName);
            openIepDocument(newDoc.id, studentName);
            showToast('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        async function openIepDocument(id, studentName) {
            const user = auth.currentUser;
            if (!user) return;
            currentIepDocId = id;
            const docRef = doc(db, 'users', user.uid, 'ieps', id);
            let snap = await getDoc(docRef);
            let data = snap.data();
            if (!data.content) {
                const content = await buildIepContent(studentName);
                await updateDoc(docRef, { content });
                snap = await getDoc(docRef);
                data = snap.data();
            }
            renderIepContent(id, studentName, data);
        }

        function renderIepContent(id, studentName, data) {
            showModifySection();
            currentIepSemester = determineSemesterFromData(data);
            lastSemesterGoals.korean = [];
            lastSemesterGoals.math = [];
            const titleMd = `| **${data.title}** |\n| --- |`;
            let titleHtml = markdownTableToHtml(titleMd)
                .replace('class="min-w-full border border-gray-300 text-sm"', 'class="mx-auto w-auto border border-gray-300 text-xl"')
                .replace('<th class="border px-2 py-1 bg-gray-100">', '<th class="border px-4 py-2 bg-gray-100 text-center text-2xl">');
            const tempWrapper = document.createElement('div');
            tempWrapper.innerHTML = data.content || '';
            tempWrapper.querySelectorAll('.iep-page[data-page="1"]').forEach(node => node.remove());
            upgradeLegacyIepStructure(tempWrapper);
            const storedPagesHtml = tempWrapper.innerHTML;
            const user = auth.currentUser;
            let teacherName = (user?.displayName || '').trim();
            if (!teacherName && user?.email) {
                teacherName = user.email.split('@')[0];
            }
            if (!teacherName) {
                teacherName = 'ë¯¸ê¸°ì¬';
            }
            const html = `
                <div class="iep-pages-wrapper">
                    <div class="iep-cover-actions" id="iep-cover-actions">
                        <button id="edit-iep-title" class="text-sm text-sky-600">í¸ì§‘</button>
                    </div>
                    <div id="iep-content" class="iep-page-collection">
                        <section class="iep-page iep-page-cover" data-page="1">
                            <div id="iep-title">${titleHtml}</div>
                            <div class="iep-cover-footer">íŠ¹ìˆ˜êµì‚¬: <span id="iep-teacher-name">${teacherName}</span></div>
                        </section>
                        ${storedPagesHtml}
                    </div>
                </div>`;
            iepOutputContainer.innerHTML = html;
            normalizeIepPages(document.getElementById('iep-content'));
            const teacherNameNode = document.getElementById('iep-teacher-name');
            if (teacherNameNode) {
                teacherNameNode.textContent = teacherName;
            }
            const months = getSemesterMonths(currentIepSemester);
            setBasePageDescriptions();
            updateMonthlyPageDisplays(months);
            extractSemesterGoalsFromDom();
            const monthlyBtn = document.getElementById('generate-monthly-plan-btn');
            if (monthlyBtn) {
                if (lastSemesterGoals.korean.length || lastSemesterGoals.math.length) {
                    monthlyBtn.classList.remove('hidden');
                } else {
                    monthlyBtn.classList.add('hidden');
                }
            }
            currentModifyTarget = 'page-1';
            updateModifyTargetActiveState();
            const editBtn = document.getElementById('edit-iep-title');
            editBtn.addEventListener('click', () => {
                const container = document.getElementById('iep-title');
                if (editBtn.textContent === 'í¸ì§‘') {
                    const current = container.textContent.trim();
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = current;
                    input.className = 'border rounded p-1 text-sm';
                    container.innerHTML = '';
                    container.appendChild(input);
                    editBtn.textContent = 'ì™„ë£Œ';
                    input.focus();
                    input.addEventListener('keydown', e => { if (e.key === 'Enter') editBtn.click(); });
                } else {
                    const input = container.querySelector('input');
                    const value = input.value.trim() || data.title;
                    const md = `| **${value}** |\n| --- |`;
                    container.innerHTML = markdownTableToHtml(md)
                        .replace('class="min-w-full border border-gray-300 text-sm"', 'class="mx-auto w-auto border border-gray-300 text-xl"')
                        .replace('<th class="border px-2 py-1 bg-gray-100">', '<th class="border px-4 py-2 bg-gray-100 text-center text-2xl">');
                    editBtn.textContent = 'í¸ì§‘';
                }
            });
        }

        async function handleIepSave() {
            const docId = currentIepDocId;
            const studentName = currentIepStudent;
            if (!docId || !studentName) {
                alert('ì €ì¥í•  IEPê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const user = auth.currentUser;
            if (!user) return;
            const titleNode = document.getElementById('iep-title');
            const contentNode = document.getElementById('iep-content');
            if (!titleNode || !contentNode) {
                alert('ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const docRef = doc(db, 'users', user.uid, 'ieps', docId);
            const title = titleNode.textContent.trim();
            const contentClone = contentNode.cloneNode(true);
            const coverPage = contentClone.querySelector('.iep-page-cover');
            if (coverPage) {
                coverPage.parentNode.removeChild(coverPage);
            }
            const content = contentClone.innerHTML;
            await updateDoc(docRef, { title, content });
            showIepList(studentName);
            openIepDocument(docId, studentName);
            alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        async function saveIepPdf() {
            const contentNode = document.getElementById('iep-content');
            if (!contentNode) {
                console.error('IEP ì½˜í…ì¸  ë…¸ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // --- UI ìš”ì†Œ ì¤€ë¹„ ---
            const saveBtn = document.getElementById('save-pdf-btn');
            const actionsContainer = document.getElementById('iep-cover-actions');
            const originalBtnText = saveBtn?.textContent;
            const titleText = document.getElementById('iep-title')?.textContent.trim() || 'ê°œë³„í™”êµìœ¡ê³„íš';
            const filename = `${sanitizeFileName(titleText)}.pdf`;
            const pages = contentNode.querySelectorAll('.iep-page');

            // --- PDF ìƒì„± ì „ ì²˜ë¦¬ ---
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.textContent = 'ì €ì¥ ì¤‘...';
            }
            // ë²„íŠ¼ ìˆ¨ê¸°ê¸° ë° ê·¸ë¦¼ì ì œê±° (PDFì— ë¶ˆí•„ìš”í•œ ìš”ì†Œ ì œê±°)
            if (actionsContainer) actionsContainer.style.display = 'none';
            pages.forEach(page => (page.style.boxShadow = 'none'));

            // --- html2pdf ì˜µì…˜ ì„¤ì • ---
            const opt = {
                margin: 0,
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, scrollY: -window.scrollY },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // --- PDF ìƒì„± ë° ì €ì¥ ---
            try {
                await html2pdf().from(contentNode).set(opt).save();
                showToast('PDF ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('PDF ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
                showToast('PDF ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                // --- PDF ìƒì„± í›„ ì²˜ë¦¬ (ìˆ¨ê²¼ë˜ ìš”ì†Œ ë³µì›) ---
                if (actionsContainer) actionsContainer.style.display = 'flex';
                pages.forEach(page => (page.style.boxShadow = '')); // ì›ë˜ ìŠ¤íƒ€ì¼ë¡œ ë³µì›

                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalBtnText;
                }
            }
        }

        async function applyModification() {
            const instruction = modifyInput.value.trim();
            if (manualEditMode) {
                alert('ìˆ˜ë™ í¸ì§‘ì„ ì™„ë£Œí•œ í›„ ìˆ˜ì • ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.');
                return;
            }
            const target = currentModifyTarget;
            const contentRoot = document.getElementById('iep-content');
            if (!instruction || !currentIepDocId || !contentRoot || !target) return;

            modifyInput.value = '';
            const button = modifyBtn;
            const originalBtnText = button?.textContent;
            if (button) {
                button.disabled = true;
                button.textContent = 'ìˆ˜ì • ì¤‘...';
            }

            try {
                if (target === 'all') {
                    const currentContent = contentRoot.innerHTML;
                    const prompt = `ë‹¤ìŒ ê°œë³„í™”êµìœ¡ê³„íš HTML ì „ì²´ë¥¼ ì‚¬ìš©ìì˜ ìˆ˜ì • ìš”êµ¬ì— ë§ê²Œ ìˆ˜ì •í•´ì¤˜. ì „ì²´ êµ¬ì¡°ì™€ í´ë˜ìŠ¤, data-* ì†ì„±, í‘œ êµ¬ì¡°ëŠ” ìœ ì§€í•˜ê³  ë‹¤ë¥¸ í˜ì´ì§€ê°€ ì‚­ì œë˜ê±°ë‚˜ ìˆœì„œê°€ ë°”ë€Œì§€ ì•Šë„ë¡ í•´ì¤˜.\n\nì›ë³¸:\n${currentContent}\n\nìˆ˜ì • ìš”êµ¬:${instruction}`;
                    let result = await callGemini(prompt);
                    const sanitized = sanitizeAiHtmlResponse(result, currentContent);
                    if (sanitized) {
                        contentRoot.innerHTML = sanitized;
                        normalizeIepPages(contentRoot);
                    }
                    updateMonthlyPageDisplays();
                    extractSemesterGoalsFromDom();
                    return;
                }

                const pageNode = findIepPageNode(target);
                if (!pageNode) {
                    alert('ì„ íƒí•œ í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                const targetText = pageDescriptions[target] || 'ì„ íƒí•œ ì˜ì—­';
                const originalOuter = pageNode.outerHTML;
                const prompt = `ë‹¤ìŒ HTMLì€ ê°œë³„í™”êµìœ¡ê³„íšì˜ '${targetText}' ì˜ì—­ì´ì•¼. HTML êµ¬ì¡°(íƒœê·¸, í´ë˜ìŠ¤, data-* ì†ì„±, id)ë¥¼ ìœ ì§€í•˜ë©´ì„œ ì‚¬ìš©ì ìš”êµ¬ì— ë§ê²Œ í•„ìš”í•œ ë¶€ë¶„ë§Œ ìˆ˜ì •í•´ì¤˜. ë‹¤ë¥¸ í˜ì´ì§€ ë‚´ìš©ì€ í¬í•¨í•˜ì§€ ë§ˆ.\n\nì›ë³¸:\n${originalOuter}\n\nìˆ˜ì • ìš”êµ¬:${instruction}\n\nì‘ë‹µì—ëŠ” ìˆ˜ì •ëœ HTMLë§Œ í¬í•¨í•´ì¤˜.`;
                let result = await callGemini(prompt);
                const sanitized = sanitizeAiHtmlResponse(result, originalOuter);
                if (!sanitized) {
                    return;
                }
                replaceIepPageWithHtml(pageNode, sanitized);
                updateMonthlyPageDisplays();
                extractSemesterGoalsFromDom();
            } catch (error) {
                console.error('ìˆ˜ì • ì ìš© ì¤‘ ì˜¤ë¥˜', error);
                alert('ìˆ˜ì • ë‚´ìš©ì„ ì ìš©í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
            } finally {
                if (button) {
                    button.disabled = false;
                    button.textContent = originalBtnText || 'ìˆ˜ì •';
                }
            }
        }

        function sanitizeAiHtmlResponse(response, fallback) {
            if (typeof response !== 'string') return fallback;
            let text = response.trim();
            text = text.replace(/^```(?:html)?\s*/i, '');
            text = text.replace(/```$/i, '');
            text = text.trim();
            if (!text) return fallback;
            const lines = text.split(/\n+/)
                .map(line => line.trim())
                .filter(line => line && !line.includes('ë‹¤ìŒì€') && !line.includes('ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤') && !line.includes('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤'));
            text = lines.join('\n').trim();
            return text || fallback;
        }

        function normalizeIepPages(root) {
            if (!root) return;
            Array.from(root.children).forEach(page => {
                if (!(page instanceof HTMLElement)) return;
                page.classList.add('iep-page');
                if (!page.classList.contains('iep-page-cover') && !page.querySelector('.iep-page-inner')) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'iep-page-inner';
                    while (page.firstChild) {
                        wrapper.appendChild(page.firstChild);
                    }
                    page.appendChild(wrapper);
                }
            });
        }

        function findIepPageNode(target) {
            if (!target || target === 'all') return null;
            const contentRoot = document.getElementById('iep-content');
            if (!contentRoot) return null;
            const match = target.match(/page-(\d+)/);
            if (!match) return null;
            return contentRoot.querySelector(`.iep-page[data-page="${match[1]}"]`);
        }

        function preservePageAttributes(source, target) {
            const sourceClasses = (source.getAttribute('class') || '').split(/\s+/).filter(Boolean);
            sourceClasses.forEach(cls => {
                if (!target.classList.contains(cls)) {
                    target.classList.add(cls);
                }
            });
            ['data-page', 'data-month-index', 'data-first-month', 'data-second-month', 'data-subject'].forEach(attr => {
                if (source.hasAttribute(attr)) {
                    target.setAttribute(attr, source.getAttribute(attr));
                }
            });
        }

        function replaceIepPageWithHtml(pageNode, html) {
            if (!pageNode || !html) return;
            const trimmed = html.trim();
            const template = document.createElement('template');
            template.innerHTML = trimmed;
            const newSection = template.content.querySelector('section');
            if (newSection) {
                preservePageAttributes(pageNode, newSection);
                pageNode.replaceWith(newSection);
                normalizeIepPages(document.getElementById('iep-content'));
                return;
            }
            pageNode.innerHTML = trimmed;
            normalizeIepPages(document.getElementById('iep-content'));
        }

        modifyBtn.addEventListener('click', applyModification);
        modifyInput.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                await applyModification();
            }
        });

        function sectionTitleTable(text) {
            const md = `| **${text}** |\n| --- |`;
            return markdownTableToHtml(md)
                .replace('class="min-w-full border border-gray-300 text-sm"', 'class="mx-auto w-auto border border-gray-300 text-base"')
                .replace('<th class="border px-2 py-1 bg-gray-100">', '<th class="border px-4 py-2 bg-gray-100 text-center text-lg">');
        }

        function upgradeLegacyIepStructure(wrapper) {
            if (!wrapper) return;
            const semesterPage = wrapper.querySelector('.iep-page[data-page="3"] #korean-goals')?.closest('.iep-page');
            const achievementPage = wrapper.querySelector('.iep-page[data-page="2"]');
            if (!semesterPage || !achievementPage) return;

            const achievementInner = achievementPage.querySelector('.iep-page-inner');
            if (!achievementInner) return;

            const findSubjectBlock = (label) => {
                return Array.from(achievementInner.children).find(child => {
                    if (!(child instanceof HTMLElement)) return false;
                    const heading = child.querySelector('h4');
                    return heading && heading.textContent.includes(label);
                });
            };

            let buttonContainer = achievementInner.querySelector('#iep-achievement-btn')?.parentElement;
            if (!buttonContainer) {
                buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex justify-end';
                const btn = document.createElement('button');
                btn.id = 'iep-achievement-btn';
                btn.className = 'text-sky-600 hover:underline text-sm';
                btn.textContent = 'ì„±ì·¨ ê¸°ì¤€ ì´ë™';
                buttonContainer.appendChild(btn);
            }

            const koreanBlock = findSubjectBlock('êµ­ì–´');
            const mathBlock = findSubjectBlock('ìˆ˜í•™');

            achievementInner.innerHTML = '';
            achievementInner.insertAdjacentHTML('beforeend', sectionTitleTable('1. í•™ìŠµì´ í•„ìš”í•œ ì„±ì·¨ ê¸°ì¤€ - êµ­ì–´'));
            achievementInner.appendChild(buttonContainer);

            if (koreanBlock) {
                const heading = koreanBlock.querySelector('h4');
                if (heading) heading.textContent = 'êµ­ì–´';
                achievementInner.appendChild(koreanBlock);
            } else {
                const fallback = document.createElement('div');
                fallback.innerHTML = '<h4 class="font-semibold">êµ­ì–´</h4><p class="text-gray-500">í•™ìŠµì´ í•„ìš”í•œ ì„±ì·¨ê¸°ì¤€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                achievementInner.appendChild(fallback);
            }

            const mathPage = document.createElement('section');
            mathPage.className = 'iep-page';
            mathPage.setAttribute('data-page', '3');
            const mathInner = document.createElement('div');
            mathInner.className = 'iep-page-inner';
            mathInner.insertAdjacentHTML('beforeend', sectionTitleTable('1. í•™ìŠµì´ í•„ìš”í•œ ì„±ì·¨ ê¸°ì¤€ - ìˆ˜í•™'));
            if (mathBlock) {
                const heading = mathBlock.querySelector('h4');
                if (heading) heading.textContent = 'ìˆ˜í•™';
                mathInner.appendChild(mathBlock);
            } else {
                const fallback = document.createElement('div');
                fallback.innerHTML = '<h4 class="font-semibold">ìˆ˜í•™</h4><p class="text-gray-500">í•™ìŠµì´ í•„ìš”í•œ ì„±ì·¨ê¸°ì¤€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                mathInner.appendChild(fallback);
            }
            mathPage.appendChild(mathInner);
            achievementPage.insertAdjacentElement('afterend', mathPage);

            semesterPage.setAttribute('data-page', '4');

            const monthlyPages = Array.from(wrapper.querySelectorAll('.iep-page[data-page]'))
                .filter(page => page !== semesterPage && Number(page.getAttribute('data-page')) >= 4)
                .sort((a, b) => Number(a.getAttribute('data-page')) - Number(b.getAttribute('data-page')));
            monthlyPages.forEach((page, idx) => {
                page.setAttribute('data-page', String(5 + idx));
            });
        }

        async function buildIepContent(studentName) {
            const user = auth.currentUser;
            if (!user) return '';
            const docRef = doc(db, 'users', user.uid, 'achievements', studentName);
            const snap = await getDoc(docRef);
            const data = snap.exists() ? (snap.data().data || {}) : {};
            const koreanList = collectYellowAchievements(data, 'korean');
            const mathList = collectYellowAchievements(data, 'math');
            lastKoreanList = koreanList;
            lastMathList = mathList;
            const now = new Date();
            const month = now.getMonth() + 1;
            const defaultSemester = (month >= 8 || month <= 1) ? 2 : 1;
            const months = getSemesterMonths(defaultSemester);
            const monthlyPages = months.map((info, idx) => {
                const monthDisplay = buildMonthlyDisplayText(info);
                const monthPrefix = monthDisplay ? `${monthDisplay} ` : '';
                const basePageNumber = 5 + idx * 2;
                const firstAttr = info.first ? ` data-first-month="${info.first}"` : '';
                const secondAttr = info.second ? ` data-second-month="${info.second}"` : '';
                const buildSubjectPage = (subjectKey, subjectLabel, pageNumber) => `
                <section class="iep-page" data-page="${pageNumber}" data-month-index="${idx}" data-subject="${subjectKey}"${firstAttr}${secondAttr}>
                    <div class="iep-page-inner">
                        <div class="iep-month-block" data-month-index="${idx}">
                            <div class="iep-month-subject" data-subject="${subjectKey}">
                                ${sectionTitleTable(`3. ì›”ë³„ êµìœ¡ëª©í‘œ - ${monthPrefix}${subjectLabel}`)}
                                <div id="monthly-plan-${idx}-${subjectKey}" class="iep-month-content mt-4"><p class="text-sm text-gray-500">ì›”ë³„ ê³„íšì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p></div>
                            </div>
                        </div>
                    </div>
                </section>`;
                return [
                    buildSubjectPage('korean', 'êµ­ì–´', basePageNumber),
                    buildSubjectPage('math', 'ìˆ˜í•™', basePageNumber + 1)
                ].join('');
            }).join('');
            const evaluationPageNumber = 5 + months.length * 2;
            const semesterEvaluationPage = `
                <section class="iep-page" data-page="${evaluationPageNumber}" data-semester-evaluation="true">
                    <div class="iep-page-inner">
                        ${sectionTitleTable('4. í•™ê¸° í‰ê°€')}
                        <div class="space-y-6">
                            <div class="iep-semester-evaluation-subject" data-subject="korean">
                                <h4 class="font-semibold">ê°€. êµ­ì–´</h4>
                                ${buildSemesterEvaluationTable()}
                            </div>
                            <div class="iep-semester-evaluation-subject" data-subject="math">
                                <h4 class="font-semibold">ë‚˜. ìˆ˜í•™</h4>
                                ${buildSemesterEvaluationTable()}
                            </div>
                        </div>
                    </div>
                </section>`;
            return `
                <section class="iep-page" data-page="2">
                    <div class="iep-page-inner">
                        ${sectionTitleTable('1. í•™ìŠµì´ í•„ìš”í•œ ì„±ì·¨ ê¸°ì¤€ - êµ­ì–´')}
                        <div>
                            <h4 class="font-semibold">êµ­ì–´</h4>
                            ${buildAchievementTable(koreanList)}
                        </div>
                    </div>
                </section>
                <section class="iep-page" data-page="3">
                    <div class="iep-page-inner">
                        ${sectionTitleTable('1. í•™ìŠµì´ í•„ìš”í•œ ì„±ì·¨ ê¸°ì¤€ - ìˆ˜í•™')}
                        <div>
                            <h4 class="font-semibold">ìˆ˜í•™</h4>
                            ${buildAchievementTable(mathList)}
                        </div>
                    </div>
                </section>
                <section class="iep-page" data-page="4">
                    <div class="iep-page-inner">
                        ${sectionTitleTable('2. í•™ê¸°ë³„ êµìœ¡ ëª©í‘œ')}
                        <div>
                            <h4 class="font-semibold">ê°€. êµ­ì–´</h4>
                            <div id="korean-goals"></div>
                        </div>
                        <div>
                            <h4 class="font-semibold">ë‚˜. ìˆ˜í•™</h4>
                            <div id="math-goals"></div>
                        </div>
                    </div>
                </section>
                ${monthlyPages}
                ${semesterEvaluationPage}
            `;
        }

        function buildAchievementTable(list) {
            if (!list.length) {
                return '<p class="text-gray-500">í•™ìŠµì´ í•„ìš”í•œ ì„±ì·¨ê¸°ì¤€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
            let html = '<table class="w-full border border-gray-300 text-sm"><thead><tr><th class="border px-2 py-1">í•™ë…„(êµ°)</th><th class="border px-2 py-1">ì„±ì·¨ê¸°ì¤€</th></tr></thead><tbody>';
            list.forEach(item => {
                html += `<tr><td class="border px-2 py-1">${item.grade}</td><td class="border px-2 py-1">${item.text}</td></tr>`;
            });
            html += '</tbody></table>';
            return html;
        }

        function collectYellowAchievements(data, subject) {
            const result = [];
            for (const level of Object.keys(achievementTables)) {
                const table = achievementTables[level]?.[subject];
                if (!table) continue;
                const key = `${level}_${subject}`;
                const states = data[key] || [];
                const temp = document.createElement('div');
                temp.innerHTML = markdownTableToHtml(table);
                const rows = temp.querySelectorAll('tbody tr');
                rows.forEach((tr, rowIdx) => {
                    const grade = tr.cells[0].textContent.trim();
                    for (let i = 1; i < tr.cells.length; i++) {
                        if (states[rowIdx]?.[i - 1] === 1) {
                            const text = tr.cells[i].textContent.trim();
                            result.push({ grade, text });
                        }
                    }
                });
            }
            return result;
        }

        async function callGemini(prompt, json = false) {
            const payload = { contents: [{ role: 'user', parts: [{ text: prompt }] }], generationConfig: json ? { responseMimeType: 'application/json' } : {} };
            try {
                const response = await fetch('/.netlify/functions/gemini-handler', { method: 'POST', body: JSON.stringify(payload) });
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || '';
                if (json) return JSON.parse(text);
                return text;
            } catch (e) {
                console.error('AI error', e);
                return json ? {} : '';
            }
        }

        function determineSemesterFromData(data) {
            let month = null;
            const createdAt = data?.createdAt;
            if (createdAt?.toDate) {
                month = createdAt.toDate().getMonth() + 1;
            } else if (createdAt?.seconds) {
                month = new Date(createdAt.seconds * 1000).getMonth() + 1;
            }
            if (!month) {
                const match = data?.title?.match(/([12])í•™ê¸°/);
                if (match) {
                    return parseInt(match[1], 10);
                }
                month = new Date().getMonth() + 1;
            }
            if (month >= 2 && month <= 7) return 1;
            return 2;
        }

        function getSemesterMonths(semester) {
            const templates = [
                { label: 'ê°€', first: '3ì›”', second: '8ì›”' },
                { label: 'ë‚˜', first: '4ì›”', second: '9ì›”' },
                { label: 'ë‹¤', first: '5ì›”', second: '10ì›”' },
                { label: 'ë¼', first: '6ì›”', second: '11ì›”' },
                { label: 'ë§ˆ', first: '7ì›”', second: '12ì›”' }
            ];
            const isFirstSemester = semester === 1;
            return templates.map(template => {
                const actual = isFirstSemester ? template.first : template.second;
                const alternate = isFirstSemester ? template.second : template.first;
                const displayText = actual || '';
                return { ...template, actual, alternate, displayText };
            });
        }

        function buildMonthlyDisplayText(info) {
            if (!info) return '';
            if (info.displayText) return info.displayText;
            return info.actual || '';
        }

        function updateMonthlyPageDisplays(monthsArg) {
            const months = Array.isArray(monthsArg) ? monthsArg : getSemesterMonths(currentIepSemester);
            const contentRoot = document.getElementById('iep-content');
            const subjects = [
                { key: 'korean', label: 'êµ­ì–´' },
                { key: 'math', label: 'ìˆ˜í•™' }
            ];
            setBasePageDescriptions();
            months.forEach((info, idx) => {
                const displayText = buildMonthlyDisplayText(info);
                const monthPrefix = displayText ? `${displayText} ` : '';
                subjects.forEach((subject, subjectIdx) => {
                    const pageNumber = 5 + idx * subjects.length + subjectIdx;
                    pageDescriptions[`page-${pageNumber}`] = `${pageNumber}í˜ì´ì§€(ì›”ë³„ êµìœ¡ ëª©í‘œ - ${monthPrefix}${subject.label})`;
                    if (!contentRoot) return;
                    const selector = `.iep-page[data-month-index="${idx}"][data-subject="${subject.key}"]`;
                    const monthSection = contentRoot.querySelector(selector);
                    if (!monthSection) return;
                    monthSection.setAttribute('data-page', String(pageNumber));
                    monthSection.setAttribute('data-month-index', String(idx));
                    monthSection.setAttribute('data-subject', subject.key);
                    if (info.first) {
                        monthSection.setAttribute('data-first-month', info.first);
                    } else {
                        monthSection.removeAttribute('data-first-month');
                    }
                    if (info.second) {
                        monthSection.setAttribute('data-second-month', info.second);
                    } else {
                        monthSection.removeAttribute('data-second-month');
                    }
                    const block = monthSection.querySelector('.iep-month-block');
                    if (block) {
                        block.setAttribute('data-month-index', String(idx));
                    }
                    const subjectSection = monthSection.querySelector('.iep-month-subject');
                    if (subjectSection) {
                        subjectSection.setAttribute('data-subject', subject.key);
                        const headingStrong = subjectSection.querySelector('table thead th strong');
                        if (headingStrong) {
                            headingStrong.textContent = `3. ì›”ë³„ êµìœ¡ëª©í‘œ - ${monthPrefix}${subject.label}`;
                        }
                        const content = subjectSection.querySelector('.iep-month-content');
                        if (content) {
                            const expectedId = `monthly-plan-${idx}-${subject.key}`;
                            if (content.id !== expectedId) {
                                content.id = expectedId;
                            }
                        }
                    }
                });
            });
            const evaluationPageNumber = 5 + months.length * subjects.length;
            pageDescriptions[`page-${evaluationPageNumber}`] = `${evaluationPageNumber}í˜ì´ì§€(í•™ê¸° í‰ê°€)`;
            renderModifyTargetButtons();
            updateModifyTargetActiveState();
        }

        function sanitizeFileName(text) {
            return (text || '').replace(/[\\/:*?"<>|]/g, ' ').replace(/\s+/g, ' ').trim();
        }

        async function generateSubjectMonthlyPlans(subject, months) {
            const semesterGoals = lastSemesterGoals[subject.key] || [];
            if (!semesterGoals.length) return [];
            const monthLabels = months.map(m => m.actual);
            const achievementText = subject.list.length
                ? subject.list.map((item, idx) => `${idx + 1}. ${item.text}`).join('\n')
                : 'ê´€ë ¨ ì„±ì·¨ê¸°ì¤€ ì •ë³´ ì—†ìŒ';
            const prompt = `ë„ˆëŠ” íŠ¹ìˆ˜êµìœ¡ êµì‚¬ë¥¼ ë•ëŠ” ì „ë¬¸ê°€ì•¼. ì•„ë˜ ì •ë³´ë¥¼ ì°¸ê³ í•˜ì—¬ ${subject.name} êµê³¼ì˜ ì›”ë³„ ê³„íšì„ JSON ë°°ì—´ë¡œ ì‘ì„±í•´ì¤˜.\n\n- í•™ê¸°: ${currentIepSemester}í•™ê¸°\n- ì›” ëª©ë¡: ${monthLabels.join(', ')}\n- í•™ê¸° êµìœ¡ëª©í‘œ:\n${semesterGoals.map((goal, idx) => `${idx + 1}. ${goal}`).join('\n')}\n- ì°¸ê³  ì„±ì·¨ê¸°ì¤€:\n${achievementText}\n\nìš”êµ¬ì‚¬í•­:\n1. í•™ê¸° êµìœ¡ëª©í‘œì˜ í•µì‹¬ì„ ìˆœì„œëŒ€ë¡œ ${monthLabels.length}ê°œì˜ ì›”ë³„ êµìœ¡ëª©í‘œë¡œ ë‚˜ëˆ„ì–´ ì œì‹œí•œë‹¤. í•„ìš”í•œ ê²½ìš° ë¬¸ì¥ì„ ë¶„í• í•˜ê±°ë‚˜ í†µí•©í•˜ë˜ ëª¨ë“  í•™ê¸° ëª©í‘œ ë‚´ìš©ì´ ì›”ë³„ ëª©í‘œì— ë°˜ì˜ë˜ì–´ì•¼ í•œë‹¤.\n2. ê° ì›”ë³„ ê³„íšì˜ goal, content, method ê°’ì€ ë¶ˆë¦¿ í¬ì¸íŠ¸ í˜•ì‹ì˜ ë¬¸ìì—´ë¡œ ì‘ì„±í•œë‹¤. ë¶ˆë¦¿ì€ ë°˜ë“œì‹œ 'â—‹ 'ë¡œ ì‹œì‘í•˜ê³  ë¬¸ì¥ë§ˆë‹¤ ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„í•œë‹¤.\n3. goal í•­ëª©ì€ 2ë¬¸ì¥ ì´ìƒ, contentì™€ method í•­ëª©ì€ ê°ê° 3ë¬¸ì¥ ì´ìƒìœ¼ë¡œ ì‘ì„±í•œë‹¤.\n4. evaluation í•­ëª©ì„ í¬í•¨í•˜ì—¬ ê° ì›” í‰ê°€ ê¸°ì¤€ì„ ì‘ì„±í•œë‹¤. í‰ê°€ í•­ëª©ì€ 3ë¬¸ì¥ìœ¼ë¡œ êµ¬ì„±í•˜ê³  ê° ë¬¸ì¥ì€ 'â—‹ 'ë¡œ ì‹œì‘í•˜ë©° ë¬¸ì¥ ëì€ ì°¨ë¡€ëŒ€ë¡œ '~ê°€', '~í•˜ëŠ”ê°€', '~ëŠ”ê°€'ë¡œ ëë‚˜ì•¼ í•œë‹¤.\n5. content í•­ëª©ì˜ ëª¨ë“  ë¬¸ì¥ì€ ë§ˆì¹¨í‘œ ì—†ì´ '~ê¸°' í˜•íƒœ(ì˜ˆ: ...í•˜ê¸°, ...ì“°ê¸°)ë¡œ ëë‚˜ë„ë¡ ì‘ì„±í•œë‹¤.\n6. ëª¨ë“  ë¬¸ì¥ì€ ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ë¡œ ì‘ì„±í•œë‹¤.\n7. ì‘ë‹µì€ ë°˜ë“œì‹œ JSON ë°°ì—´ë§Œìœ¼ë¡œ ì œê³µí•˜ê³  ë‹¤ë¥¸ ì„¤ëª…ì€ í¬í•¨í•˜ì§€ ì•ŠëŠ”ë‹¤.\n8. ë°°ì—´ì˜ ê° ìš”ì†ŒëŠ” {"month":"${monthLabels[0]}","goal":"...","content":"...","method":"...","evaluation":"..."} í˜•ì‹ì„ ë”°ë¥´ë©°, month ê°’ì€ ì›” ëª©ë¡ê³¼ ì •í™•íˆ ì¼ì¹˜í•˜ê³  ìˆœì„œë¥¼ ìœ ì§€í•´ì•¼ í•œë‹¤.`;
            const result = await callGemini(prompt, true);
            let plans = [];
            if (Array.isArray(result)) {
                plans = result;
            } else if (Array.isArray(result?.plans)) {
                plans = result.plans;
            }
            return monthLabels.map((month, idx) => {
                const plan = plans.find(p => p.month === month) || plans[idx] || {};
                return {
                    goal: formatMonthlyGoalText(plan.goal || ''),
                    content: formatMonthlyContentText(plan.content || ''),
                    method: formatMonthlyMethodText(plan.method || ''),
                    evaluation: formatMonthlyEvaluationText(plan.evaluation || '')
                };
            });
        }

        function buildMonthlyTables(month, subjectName, entry) {
            const goal = formatTableCell(entry.goal);
            const content = formatTableCell(entry.content);
            const method = formatTableCell(entry.method);
            const evaluation = formatTableCell(entry.evaluation || '');
            return `
                <table class="monthly-plan-table text-base">
                    <tbody>
                        <tr>
                            <th class="monthly-plan-title" colspan="2">${month} ${subjectName}</th>
                        </tr>
                        <tr>
                            <th class="monthly-plan-section-header">êµìœ¡ ëª©í‘œ</th>
                            <th class="monthly-plan-section-header">êµìœ¡ ë‚´ìš©</th>
                        </tr>
                        <tr>
                            <td class="data-cell">${goal}</td>
                            <td class="data-cell">${content}</td>
                        </tr>
                        <tr>
                            <th class="monthly-plan-section-header">êµìœ¡ ë°©ë²•</th>
                            <th class="monthly-plan-section-header">êµìœ¡ í‰ê°€</th>
                        </tr>
                        <tr>
                            <td class="data-cell">${method}</td>
                            <td class="data-cell">${evaluation}</td>
                        </tr>
                        <tr>
                            <th class="monthly-plan-footer" colspan="2">ì›” í‰ê°€</th>
                        </tr>
                        <tr>
                            <td class="monthly-plan-empty" colspan="2">&nbsp;</td>
                        </tr>
                    </tbody>
                </table>
            `.trim();
        }

        function buildSemesterEvaluationTable() {
            return `
                <table class="w-full border border-gray-300 text-sm semester-evaluation-table">
                    <thead>
                        <tr>
                            <th class="border px-2 py-2 bg-gray-100 text-center">í‰ê°€</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="border px-2 py-10 align-top">&nbsp;</td>
                        </tr>
                    </tbody>
                </table>
            `.trim();
        }

        function formatTableCell(text) {
            if (!text) return '&nbsp;';
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\n/g, '<br>');
        }

        function splitMonthlySentences(text) {
            if (!text) return [];
            const cleaned = text
                .replace(/\r/g, '\n')
                .replace(/^\s*[-*â€¢â—â—‹]\s*/gm, '')
                .replace(/^\s*\d+[.)]\s*/gm, '');
            const newlineParts = cleaned
                .split(/\n+/)
                .map(part => part.trim())
                .filter(Boolean);
            if (newlineParts.length > 1) {
                return newlineParts;
            }
            const normalized = cleaned.replace(/\s+/g, ' ').trim();
            if (!normalized) return [];
            const sentences = [];
            const regex = /[^.!?]+[.!?]?/g;
            let match;
            while ((match = regex.exec(normalized)) !== null) {
                const sentence = (match[0] || '').trim();
                if (sentence) sentences.push(sentence);
            }
            return sentences.length ? sentences : [normalized];
        }

        function ensureBulletString(text, { minCount = 1, endingMode = 'period' } = {}) {
            let sentences = splitMonthlySentences(text);
            if (sentences.length && sentences.length < minCount) {
                const expanded = [];
                sentences.forEach(sentence => {
                    const fragments = sentence
                        .split(/[,;Â·]/)
                        .map(fragment => fragment.trim())
                        .filter(fragment => fragment.length > 0);
                    if (fragments.length > 1) {
                        expanded.push(...fragments);
                    } else {
                        expanded.push(sentence);
                    }
                });
                if (expanded.length > sentences.length) {
                    sentences = expanded;
                }
            }
            const bullets = sentences.map(sentence => {
                let trimmed = sentence.trim();
                trimmed = trimmed.replace(/^[-*â€¢â—â—‹]\s*/, '').replace(/^\d+[.)]\s*/, '').trim();
                trimmed = trimmed.replace(/\s+/g, ' ');
                if (!trimmed) return null;
                if (endingMode === 'gerund') {
                    trimmed = trimmed.replace(/[.!?]\s*$/, '');
                    trimmed = trimmed.replace(/ê¸°\s*(?:í•œë‹¤|í•©ë‹ˆë‹¤|í•¨)?$/, 'ê¸°');
                    trimmed = trimmed.replace(/ê¸°\s*(?:í•œë‹¤|í•©ë‹ˆë‹¤|í•¨)?$/, 'ê¸°');
                    trimmed = trimmed.replace(/í•œë‹¤$/, 'í•œë‹¤').replace(/í•©ë‹ˆë‹¤$/, 'í•˜ê¸°');
                    trimmed = trimmed.trim();
                } else if (endingMode === 'none') {
                    trimmed = trimmed.replace(/[.!?]\s*$/, '');
                    trimmed = trimmed.trim();
                } else {
                    trimmed = trimmed.replace(/[.!?]\s*$/, '');
                    trimmed = `${trimmed}.`;
                }
                return `â—‹ ${trimmed}`;
            }).filter(Boolean);

            if (!bullets.length) {
                let fallback = (text || '').replace(/^\s*[-*â€¢â—â—‹]\s*/gm, '').trim();
                if (!fallback) return '';
                fallback = fallback.replace(/[.!?]\s*$/, '');
                fallback = fallback.replace(/\s+/g, ' ');
                if (endingMode === 'gerund') {
                    fallback = fallback.replace(/ê¸°\s*(?:í•œë‹¤|í•©ë‹ˆë‹¤|í•¨)?$/, 'ê¸°');
                    fallback = fallback.replace(/ê¸°\s*(?:í•œë‹¤|í•©ë‹ˆë‹¤|í•¨)?$/, 'ê¸°');
                    fallback = fallback.replace(/í•œë‹¤$/, 'í•œë‹¤').replace(/í•©ë‹ˆë‹¤$/, 'í•˜ê¸°');
                }
                const sentence = endingMode === 'gerund'
                    ? fallback
                    : endingMode === 'none'
                        ? fallback
                        : `${fallback}.`;
                const bulletLine = `â—‹ ${sentence}`;
                return Array.from({ length: Math.max(minCount, 1) }, () => bulletLine).join('\n');
            }

            if (bullets.length < minCount) {
                const last = bullets[bullets.length - 1];
                while (bullets.length < minCount) {
                    bullets.push(last);
                }
            }
            return bullets.join('\n');
        }

        function formatMonthlyGoalText(text) {
            return ensureBulletString(text, { minCount: 2, endingMode: 'period' });
        }

        function formatMonthlyContentText(text) {
            return ensureBulletString(text, { minCount: 3, endingMode: 'gerund' });
        }

        function formatMonthlyMethodText(text) {
            const bulletText = ensureBulletString(text, { minCount: 3, endingMode: 'period' });
            return enforceMethodSentenceEndings(bulletText);
        }

        function formatMonthlyEvaluationText(text) {
            const endings = ['ê°€', 'í•˜ëŠ”ê°€', 'ëŠ”ê°€'];
            const defaults = [
                'â—‹ í•™ìŠµ ëª©í‘œ ë‹¬ì„± ì—¬ë¶€ê°€',
                'â—‹ ìˆ˜ì—… ì°¸ì—¬ í–‰ë™ì„ ì§€ì†í•˜ëŠ”ê°€',
                'â—‹ í•™ìŠµ ë‚´ìš©ì„ ì‹¤ì œë¡œ ì´í•´í–ˆëŠ”ê°€'
            ];
            const bulletText = ensureBulletString(text, { minCount: endings.length, endingMode: 'none' });
            const lines = (bulletText ? bulletText.split('\n') : [])
                .map(line => line.trim())
                .filter(Boolean);
            const normalized = [];
            for (let i = 0; i < endings.length; i++) {
                const ending = endings[i];
                let sourceLine = lines[i] || lines[lines.length - 1] || '';
                if (!sourceLine) {
                    normalized.push(defaults[i] || `â—‹ í‰ê°€ ë¬¸ì¥${i + 1}${ending}`);
                    continue;
                }
                const match = sourceLine.match(/^(â—‹\s*)(.*)$/);
                const prefix = match ? match[1] : 'â—‹ ';
                let sentence = match ? match[2].trim() : sourceLine.replace(/^[-*â€¢â—]\s*/, '').trim();
                if (!sentence) {
                    normalized.push(defaults[i] || `â—‹ í‰ê°€ ë¬¸ì¥${i + 1}${ending}`);
                    continue;
                }
                sentence = sentence.replace(/[.!?]\s*$/, '');
                sentence = sentence.replace(/\s+/g, ' ').trim();
                if (!sentence.endsWith(ending)) {
                    sentence = sentence.replace(/(ì¸ê°€ìš”?|ì¸ê°€|ì¸ì§€|í•œê°€ìš”?|í•œê°€|í•˜ëŠ”ê°€ìš”?|í•˜ëŠ”ì§€|ëŠ”ê°€ìš”?|ëŠ”ì§€|ìˆ˜ ìˆëŠ”ê°€ìš”?|ìˆ˜ ìˆëŠ”ê°€|ìˆ˜ ìˆëŠ”ì§€|ê°€ëŠ¥í•œê°€ìš”?|ê°€ëŠ¥í•œê°€|ê°€ëŠ¥í•œì§€|ë  ìˆ˜ ìˆëŠ”ê°€|ë  ìˆ˜ ìˆëŠ”ì§€|ë˜ëŠ”ì§€)\s*$/, '').trim();
                    if (!sentence.endsWith(ending)) {
                        if (sentence.endsWith('ê°€') && ending !== 'ê°€') {
                            sentence = sentence.slice(0, -1);
                        }
                        sentence = `${sentence}${ending}`;
                    }
                }
                normalized.push(`${prefix}${sentence}`);
            }
            return normalized.join('\n');
        }

        function enforceMethodSentenceEndings(text) {
            if (!text) return text;
            const lines = text.split('\n');
            return lines.map(line => {
                const match = line.match(/^(\s*â—‹\s*)(.*)$/);
                if (!match) return line;
                const prefix = match[1];
                let sentence = match[2].trim();
                if (!sentence) return line;
                sentence = sentence.replace(/[.!?]\s*$/, '');
                sentence = sentence.replace(/ê¸°ë¡œ\s*(?:í•œë‹¤|í•©ë‹ˆë‹¤|í•¨|í•  ì˜ˆì •ì´ë‹¤|í•  ê³„íšì´ë‹¤|í•  ì˜ˆì •ì„|í•  ê³„íšì„)?$/, 'í•œë‹¤');
                sentence = sentence.replace(/ê¸°\s*(?:í•œë‹¤|í•©ë‹ˆë‹¤|í•¨|í•  ì˜ˆì •ì´ë‹¤|í•  ê³„íšì´ë‹¤|í•  ì˜ˆì •ì„|í•  ê³„íšì„)?$/, 'í•œë‹¤');
                sentence = sentence.replace(/í•˜ë„ë¡ ì§€ë„$/, 'í•˜ë„ë¡ ì§€ë„í•œë‹¤');
                sentence = sentence.replace(/ì§€ì›$/, 'ì§€ì›í•œë‹¤');
                sentence = sentence.replace(/ì§€ë„$/, 'ì§€ë„í•œë‹¤');
                if (!/ë‹¤$/.test(sentence)) {
                    sentence = sentence.replace(/í•˜$/, 'í•œë‹¤');
                }
                if (!/ë‹¤$/.test(sentence)) {
                    sentence += 'í•œë‹¤';
                }
                sentence = sentence.replace(/ë‹¤$/, 'ë‹¤.');
                return `${prefix}${sentence}`;
            }).join('\n');
        }

        function extractSemesterGoalsFromDom() {
            const subjects = [
                { key: 'korean', selector: '#korean-goals table tbody tr td' },
                { key: 'math', selector: '#math-goals table tbody tr td' }
            ];
            subjects.forEach(({ key, selector }) => {
                const cells = Array.from(document.querySelectorAll(selector));
                lastSemesterGoals[key] = cells.map(cell => cell.textContent.trim()).filter(Boolean);
            });
        }

        async function generateSemesterGoals(koreanList, mathList) {
            const subjects = [
                { name: 'êµ­ì–´', list: koreanList, targetId: 'korean-goals', key: 'korean' },
                { name: 'ìˆ˜í•™', list: mathList, targetId: 'math-goals', key: 'math' }
            ];
            for (const { name, list, targetId, key } of subjects) {
                const target = document.getElementById(targetId);
                lastSemesterGoals[key] = [];
                if (!list.length) {
                    target.innerHTML = '<p class="text-gray-500">í•™ìŠµì´ í•„ìš”í•œ ì„±ì·¨ê¸°ì¤€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    continue;
                }
                target.innerHTML = '<p class="text-gray-500">ìƒì„± ì¤‘...</p>';
                const prompt = `ë‹¤ìŒ ì„±ì·¨ê¸°ì¤€ì„ ë°”íƒ•ìœ¼ë¡œ ${name} êµê³¼ì˜ í•™ê¸° êµìœ¡ëª©í‘œë¥¼ 1~5ê°œì˜ ë¬¸ì¥ìœ¼ë¡œ ì‘ì„±í•´ì¤˜. ê° ë¬¸ì¥ì€ 'ë‹¤.' í˜¹ì€ 'í•œë‹¤.'ë¡œ ëë‚˜ë„ë¡ í•˜ê³  ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„í•´ì¤˜. ê° ë¬¸ì¥ ì•ì—ëŠ” ìˆ«ìë‚˜ ê¸°í˜¸ë¥¼ ë¶™ì´ì§€ ë§ˆ.\n\nì„±ì·¨ê¸°ì¤€:\n${list.map((item, idx) => `${idx + 1}. ${item.text}`).join('\n')}`;
                const result = await callGemini(prompt);
                const lines = result
                    .split(/\n+/)
                    .map(l => l.trim())
                    .filter(Boolean)
                    .filter(line => !line.startsWith('ë‹¤ìŒì€'))
                    .map(line => line.replace(/^[-â€¢\d]+[.)]?\s*/, ''))
                    .slice(0, 5);
                lastSemesterGoals[key] = lines;
                if (!lines.length) {
                    target.innerHTML = '<p class="text-gray-500">í•™ê¸° êµìœ¡ëª©í‘œë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</p>';
                    continue;
                }
                let md = `| ${name} í•™ê¸° êµìœ¡ëª©í‘œ |\n| --- |\n`;
                lines.forEach(line => { md += `| ${line} |\n`; });
                target.innerHTML = markdownTableToHtml(md);
            }
            document.querySelectorAll('.iep-month-content').forEach(node => {
                node.innerHTML = '<p class="text-gray-500 text-sm">ì›”ë³„ ê³„íšì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>';
            });
        }

        async function generateMonthlyPlans(koreanList, mathList) {
            const months = getSemesterMonths(currentIepSemester);
            updateMonthlyPageDisplays(months);
            if (!months.length) {
                document.querySelectorAll('.iep-month-content').forEach(node => {
                    node.innerHTML = '<p class="text-gray-500 text-sm">ì›” ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
                });
                return;
            }
            const subjects = [
                { name: 'êµ­ì–´', key: 'korean', list: koreanList },
                { name: 'ìˆ˜í•™', key: 'math', list: mathList }
            ];
            const containersByMonth = {};
            months.forEach((_, idx) => {
                containersByMonth[idx] = {};
                subjects.forEach(subject => {
                    const container = document.getElementById(`monthly-plan-${idx}-${subject.key}`);
                    if (container) {
                        containersByMonth[idx][subject.key] = container;
                        container.innerHTML = '<p class="text-gray-500 text-sm">ìƒì„± ì¤‘...</p>';
                    }
                });
            });

            const plansBySubject = {};
            for (const subject of subjects) {
                if (!(lastSemesterGoals[subject.key] || []).length) {
                    plansBySubject[subject.key] = null;
                    continue;
                }
                plansBySubject[subject.key] = await generateSubjectMonthlyPlans(subject, months);
            }

            months.forEach((monthInfo, idx) => {
                subjects.forEach(subject => {
                    const container = containersByMonth[idx]?.[subject.key];
                    if (!container) return;
                    const hasGoals = (lastSemesterGoals[subject.key] || []).length > 0;
                    const entry = plansBySubject[subject.key]?.[idx];
                    if (!hasGoals) {
                        container.innerHTML = '<p class="text-gray-500 text-sm">í•™ê¸° êµìœ¡ëª©í‘œë¥¼ ë¨¼ì € ìƒì„±í•´ ì£¼ì„¸ìš”.</p>';
                    } else if (!entry || (!entry.goal && !entry.content && !entry.method)) {
                        container.innerHTML = '<p class="text-gray-500 text-sm">ì›”ë³„ ê³„íšì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</p>';
                    } else {
                        container.innerHTML = buildMonthlyTables(monthInfo.actual, subject.name, entry);
                    }
                });
            });
        }

        // --- Behavior Intervention Logic ---
        const behaviorStudentList = document.getElementById('behavior-student-list');
        const behaviorSelectedStudentLabel = document.getElementById('behavior-selected-student');
        const behaviorRecordList = document.getElementById('behavior-record-list');
        const behaviorSharedList = document.getElementById('behavior-shared-list');
        const behaviorDetailPanel = document.getElementById('behavior-detail-panel');
        const behaviorDetailTitle = document.getElementById('behavior-detail-title');
        const behaviorOperationalDefinition = document.getElementById('behavior-operational-definition');
        const behaviorReinforcerBadge = document.getElementById('behavior-reinforcer-badge');
        const behaviorAttentionBadge = document.getElementById('behavior-attention-badge');
        const behaviorShareBtn = document.getElementById('behavior-share-btn');
        const behaviorLogList = document.getElementById('behavior-log-list');
        const behaviorGraphViewButtons = document.getElementById('behavior-graph-view-buttons');
        const openBehaviorModalBtn = document.getElementById('open-behavior-modal');
        const refreshBehaviorStudentsBtn = document.getElementById('refresh-behavior-students');
        const refreshSharedBehaviorsBtn = document.getElementById('refresh-shared-behaviors');
        const behaviorModal = document.getElementById('behavior-modal');
        const behaviorModalTitleInput = document.getElementById('behavior-modal-title');
        const behaviorModalReinforcerInput = document.getElementById('behavior-modal-reinforcer');
        const behaviorModalAttentionInput = document.getElementById('behavior-modal-attention');
        const behaviorModalDefinitionInput = document.getElementById('behavior-modal-definition');
        const behaviorModalCancelBtn = document.getElementById('behavior-modal-cancel');
        const behaviorModalSaveBtn = document.getElementById('behavior-modal-save');
        const behaviorShareModal = document.getElementById('behavior-share-modal');
        const behaviorShareUserList = document.getElementById('behavior-share-user-list');
        const behaviorShareCancelBtn = document.getElementById('behavior-share-cancel');
        const behaviorShareConfirmBtn = document.getElementById('behavior-share-confirm');
        const behaviorShareCloseBtn = document.getElementById('behavior-share-close');
        const behaviorLogNoteModal = document.getElementById('behavior-log-note-modal');
        const behaviorLogNoteInput = document.getElementById('behavior-log-note-input');
        const behaviorLogNoteMeta = document.getElementById('behavior-log-note-meta');
        const behaviorLogNoteSaveBtn = document.getElementById('behavior-log-note-save');
        const behaviorLogNoteCancelBtn = document.getElementById('behavior-log-note-cancel');
        const behaviorLogNoteDeleteBtn = document.getElementById('behavior-log-note-delete');
        const behaviorLogNoteCloseBtn = document.getElementById('behavior-log-note-close');
        const logBehaviorBtn = document.getElementById('log-behavior-btn');

        let behaviorStudents = [];
        let behaviorEntries = [];
        let sharedBehaviorEntries = [];
        let currentBehaviorStudentId = '';
        let currentBehaviorEntry = null;
        let currentBehaviorOwnerId = '';
        let currentBehaviorSource = 'own';
        let currentBehaviorLogs = [];
        let currentBehaviorChartView = 'daily';
        let currentBehaviorChartData = createEmptyBehaviorChartData();
        let currentBehaviorLogEditing = null;
        let isLoadingBehaviorStudents = false;
        let isLoadingBehaviorEntries = false;
        let isLoadingSharedBehaviors = false;
        let isLoadingTeacherDirectory = false;
        let teacherDirectoryLoaded = false;
        let teacherDirectory = [];
        let isUpdatingBehaviorShare = false;

        function resetBehaviorDetail() {
            currentBehaviorEntry = null;
            currentBehaviorOwnerId = '';
            currentBehaviorSource = 'own';
            currentBehaviorLogs = [];
            currentBehaviorChartView = 'daily';
            currentBehaviorChartData = createEmptyBehaviorChartData();
            setBehaviorChartView('daily', false);
            currentBehaviorLogEditing = null;
            if (behaviorDetailPanel) {
                behaviorDetailPanel.classList.add('hidden');
            }
            if (behaviorDetailTitle) behaviorDetailTitle.textContent = '';
            if (behaviorOperationalDefinition) behaviorOperationalDefinition.textContent = '';
            if (behaviorReinforcerBadge) behaviorReinforcerBadge.classList.add('hidden');
            if (behaviorAttentionBadge) behaviorAttentionBadge.classList.add('hidden');
            if (behaviorLogList) {
                behaviorLogList.innerHTML = '<li class="text-gray-500">í–‰ë™ ê¸°ë¡ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</li>';
            }
            if (window.behaviorChartInstance) {
                window.behaviorChartInstance.destroy();
                window.behaviorChartInstance = null;
            }
            if (logBehaviorBtn) {
                logBehaviorBtn.disabled = true;
            }
            closeBehaviorLogNoteModal();
            updateSharedBehaviorActiveState();
            updateBehaviorShareButtonState();
        }

        function updateBehaviorActionState() {
            if (openBehaviorModalBtn) {
                openBehaviorModalBtn.disabled = !currentBehaviorStudentId;
            }
            if (logBehaviorBtn) {
                logBehaviorBtn.disabled = !currentBehaviorEntry;
            }
            updateBehaviorShareButtonState();
        }

        async function ensureCurrentUserProfile() {
            const user = auth.currentUser;
            if (!user) return null;
            if (currentUserProfile) return currentUserProfile;
            try {
                const snap = await getDoc(doc(db, 'users', user.uid));
                if (snap.exists()) {
                    currentUserProfile = snap.data();
                }
            } catch (error) {
                console.error('Failed to load user profile', error);
            }
            return currentUserProfile;
        }

        function updateBehaviorStudentActiveState() {
            if (!behaviorStudentList) return;
            const buttons = behaviorStudentList.querySelectorAll('button[data-student-id]');
            buttons.forEach(button => {
                const isActive = currentBehaviorStudentId && button.dataset.studentId === currentBehaviorStudentId;
                button.classList.toggle('border-sky-500', isActive);
                button.classList.toggle('bg-sky-50', isActive);
                button.classList.toggle('text-sky-700', isActive);
            });
        }

        function updateBehaviorEntriesActiveState() {
            if (!behaviorRecordList) return;
            behaviorRecordList.querySelectorAll('button[data-behavior-id]').forEach(button => {
                const isActive = currentBehaviorEntry && button.dataset.behaviorId === currentBehaviorEntry.id;
                button.classList.toggle('border-sky-500', isActive);
                button.classList.toggle('bg-sky-50', isActive);
                button.classList.toggle('text-sky-700', isActive);
            });
        }

        function updateSharedBehaviorActiveState() {
            if (!behaviorSharedList) return;
            behaviorSharedList.querySelectorAll('button[data-shared-behavior-id]').forEach(button => {
                const isActive = currentBehaviorEntry && currentBehaviorSource === 'shared' && button.dataset.sharedBehaviorId === currentBehaviorEntry.id && button.dataset.ownerId === currentBehaviorOwnerId;
                button.classList.toggle('border-sky-500', isActive);
                button.classList.toggle('bg-sky-50', isActive);
                button.classList.toggle('text-sky-700', isActive);
            });
        }

        function updateBehaviorShareButtonState() {
            if (!behaviorShareBtn) return;
            const user = auth.currentUser;
            const isOwner = !!currentBehaviorEntry && user && currentBehaviorOwnerId === user.uid;
            behaviorShareBtn.classList.toggle('hidden', !isOwner);
            behaviorShareBtn.disabled = !isOwner;
        }

        function renderBehaviorStudents() {
            if (!behaviorStudentList) return;
            behaviorStudentList.innerHTML = '';
            if (!behaviorStudents.length) {
                behaviorStudentList.innerHTML = '<p class="text-sm text-gray-500">í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            behaviorStudents.forEach(student => {
                const button = document.createElement('button');
                button.type = 'button';
                button.dataset.studentId = student.id;
                button.className = 'flex w-full items-center justify-between rounded-lg border border-slate-200 bg-white px-3 py-2 text-left text-sm transition hover:border-sky-400 hover:bg-sky-50';
                button.innerHTML = `<span class="font-medium text-slate-700">${escapeHtml(student.name || 'ì´ë¦„ ë¯¸í™•ì¸')}</span>`;
                behaviorStudentList.appendChild(button);
            });
            updateBehaviorStudentActiveState();
        }

        function renderBehaviorEntries() {
            if (!behaviorRecordList) return;
            behaviorRecordList.innerHTML = '';
            if (!behaviorEntries.length) {
                behaviorRecordList.innerHTML = '<p class="text-sm text-gray-500">ë“±ë¡ëœ í–‰ë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ìƒë‹¨ì˜ ì¶”ê°€ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‘ì„±í•´ë³´ì„¸ìš”.</p>';
                return;
            }
            behaviorEntries.forEach(entry => {
                const button = document.createElement('button');
                button.type = 'button';
                button.dataset.behaviorId = entry.id;
                button.className = 'w-full rounded-lg border border-slate-200 bg-white p-3 text-left transition hover:border-sky-400 hover:bg-sky-50';
                const badges = [];
                if (entry.useReinforcer) {
                    badges.push('<span class="rounded-full bg-emerald-100 px-2.5 py-0.5 text-xs font-medium text-emerald-700">ê°•í™”ë¬¼</span>');
                }
                if (entry.useAttentionToken) {
                    badges.push('<span class="rounded-full bg-amber-100 px-2.5 py-0.5 text-xs font-medium text-amber-700">ì£¼ì˜ í† í°</span>');
                }
                const firstLine = (entry.operationalDefinition || '').split('\n')[0].trim();
                const description = firstLine ? escapeHtml(firstLine) : 'ì¡°ì‘ì  ì •ì˜ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
                button.innerHTML = `
                    <div class="flex items-start justify-between gap-3">
                        <div class="min-w-0">
                            <p class="font-semibold text-slate-800">${escapeHtml(entry.title || 'í–‰ë™ ê¸°ë¡')}</p>
                            <p class="mt-1 text-xs text-slate-500 break-words">${description}</p>
                        </div>
                        <div class="flex flex-col items-end gap-1 text-xs font-medium text-slate-500">${badges.join('')}</div>
                    </div>
                `;
                behaviorRecordList.appendChild(button);
            });
            updateBehaviorEntriesActiveState();
        }

        function renderSharedBehaviorList() {
            if (!behaviorSharedList) return;
            behaviorSharedList.innerHTML = '';
            if (!sharedBehaviorEntries.length) {
                behaviorSharedList.innerHTML = '<p class="text-sm text-gray-500">ê³µìœ  ë°›ì€ í–‰ë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            sharedBehaviorEntries.forEach(entry => {
                const button = document.createElement('button');
                button.type = 'button';
                button.dataset.sharedBehaviorId = entry.id;
                button.dataset.ownerId = entry.ownerId;
                button.className = 'w-full rounded-lg border border-slate-200 bg-white p-3 text-left transition hover:border-sky-400 hover:bg-sky-50';
                const studentName = escapeHtml(entry.studentName || 'í•™ìƒ ë¯¸í™•ì¸');
                const title = escapeHtml(entry.title || 'í–‰ë™ ê¸°ë¡');
                button.innerHTML = `
                    <div class="flex flex-col gap-1">
                        <p class="font-semibold text-slate-800">${studentName}</p>
                        <p class="text-xs text-slate-500">${title}</p>
                    </div>
                `;
                behaviorSharedList.appendChild(button);
            });
            updateSharedBehaviorActiveState();
        }

        async function loadBehaviorStudents() {
            const user = auth.currentUser;
            if (!user || !behaviorStudentList || isLoadingBehaviorStudents) return;
            isLoadingBehaviorStudents = true;
            behaviorStudentList.innerHTML = '<p class="text-sm text-gray-500">í•™ìƒ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>';
            try {
                const classSnap = await getDoc(doc(db, 'classes', user.uid));
                if (!classSnap.exists()) {
                    behaviorStudents = [];
                    behaviorStudentList.innerHTML = '<p class="text-sm text-gray-500">í•™ê¸‰ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € í•™ê¸‰ì„ ìƒì„±í•´ì£¼ì„¸ìš”.</p>';
                    currentBehaviorStudentId = '';
                    if (behaviorRecordList) behaviorRecordList.innerHTML = '<p class="text-sm text-gray-500">í•™ìƒì„ ì„ íƒí•˜ë©´ í–‰ë™ ê¸°ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>';
                    if (behaviorSelectedStudentLabel) behaviorSelectedStudentLabel.textContent = 'í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
                    resetBehaviorDetail();
                    updateBehaviorActionState();
                    return;
                }
                const studentIds = classSnap.data().students || [];
                if (!studentIds.length) {
                    behaviorStudents = [];
                    behaviorStudentList.innerHTML = '<p class="text-sm text-gray-500">ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    currentBehaviorStudentId = '';
                    if (behaviorRecordList) behaviorRecordList.innerHTML = '<p class="text-sm text-gray-500">í•™ìƒì„ ì„ íƒí•˜ë©´ í–‰ë™ ê¸°ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>';
                    if (behaviorSelectedStudentLabel) behaviorSelectedStudentLabel.textContent = 'í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
                    resetBehaviorDetail();
                    updateBehaviorActionState();
                    return;
                }
                const studentDocs = await Promise.all(studentIds.map(async (sid) => {
                    try {
                        const snap = await getDoc(doc(db, 'users', sid));
                        if (snap.exists()) {
                            const data = snap.data();
                            return { id: sid, name: data.name || data.userCode || sid };
                        }
                    } catch (error) {
                        console.error('Failed to load student info', error);
                    }
                    return { id: sid, name: sid };
                }));
                behaviorStudents = studentDocs.filter(Boolean);
                renderBehaviorStudents();
                const hasSelectedStudent = currentBehaviorStudentId && behaviorStudents.some(student => student.id === currentBehaviorStudentId);
                if (hasSelectedStudent) {
                    updateBehaviorStudentActiveState();
                    const student = behaviorStudents.find(s => s.id === currentBehaviorStudentId);
                    if (behaviorSelectedStudentLabel) {
                        behaviorSelectedStudentLabel.textContent = `${student?.name || 'í•™ìƒ'} í•™ìƒ`;
                    }
                    await loadBehaviorEntries(currentBehaviorStudentId);
                } else {
                    currentBehaviorStudentId = '';
                    if (behaviorRecordList) behaviorRecordList.innerHTML = '<p class="text-sm text-gray-500">í•™ìƒì„ ì„ íƒí•˜ë©´ í–‰ë™ ê¸°ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>';
                    if (behaviorSelectedStudentLabel) behaviorSelectedStudentLabel.textContent = 'í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
                    resetBehaviorDetail();
                    updateBehaviorActionState();
                }
            } catch (error) {
                console.error('Failed to load behavior students', error);
                behaviorStudents = [];
                if (behaviorStudentList) {
                    behaviorStudentList.innerHTML = '<p class="text-sm text-red-500">í•™ìƒ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
                }
                currentBehaviorStudentId = '';
                if (behaviorRecordList) behaviorRecordList.innerHTML = '<p class="text-sm text-gray-500">í•™ìƒì„ ì„ íƒí•˜ë©´ í–‰ë™ ê¸°ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>';
                if (behaviorSelectedStudentLabel) behaviorSelectedStudentLabel.textContent = 'í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
                resetBehaviorDetail();
                updateBehaviorActionState();
            } finally {
                isLoadingBehaviorStudents = false;
            }
        }

        async function loadBehaviorEntries(studentId, behaviorIdToSelect = '') {
            const user = auth.currentUser;
            if (!user || !behaviorRecordList || isLoadingBehaviorEntries) return;
            isLoadingBehaviorEntries = true;
            behaviorRecordList.innerHTML = '<p class="text-sm text-gray-500">í–‰ë™ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>';
            try {
                const behaviorsRef = collection(db, 'users', user.uid, 'behaviors');
                const q = query(behaviorsRef, where('studentId', '==', studentId));
                const snapshot = await getDocs(q);
                behaviorEntries = snapshot.docs.map(docSnap => {
                    const data = docSnap.data();
                    return {
                        id: docSnap.id,
                        ...data,
                        ownerId: data.ownerId || user.uid,
                        sharedWith: Array.isArray(data.sharedWith) ? data.sharedWith : [],
                    };
                });
                behaviorEntries.sort((a, b) => {
                    const aTime = a.createdAt?.toMillis?.() || 0;
                    const bTime = b.createdAt?.toMillis?.() || 0;
                    return bTime - aTime;
                });
                if (!behaviorEntries.length) {
                    const student = behaviorStudents.find(s => s.id === studentId);
                    if (student?.name) {
                        const legacySnapshot = await getDocs(query(behaviorsRef, where('studentName', '==', student.name)));
                        const legacyUpdates = [];
                        legacySnapshot.forEach(docSnap => {
                            const data = docSnap.data();
                            behaviorEntries.push({
                                id: docSnap.id,
                                ...data,
                                ownerId: data.ownerId || user.uid,
                                sharedWith: Array.isArray(data.sharedWith) ? data.sharedWith : [],
                            });
                            if (!data.studentId) {
                                legacyUpdates.push(updateDoc(doc(db, 'users', user.uid, 'behaviors', docSnap.id), {
                                    studentId,
                                    studentName: student.name
                                }).catch(() => {}));
                            }
                        });
                        if (legacyUpdates.length) {
                            await Promise.allSettled(legacyUpdates);
                        }
                        behaviorEntries.sort((a, b) => {
                            const aTime = a.createdAt?.toMillis?.() || 0;
                            const bTime = b.createdAt?.toMillis?.() || 0;
                            return bTime - aTime;
                        });
                    }
                }
                renderBehaviorEntries();
                const targetId = behaviorIdToSelect || (currentBehaviorEntry && behaviorEntries.some(entry => entry.id === currentBehaviorEntry.id) ? currentBehaviorEntry.id : '');
                if (targetId) {
                    selectBehaviorEntry(targetId);
                } else {
                    currentBehaviorEntry = null;
                    resetBehaviorDetail();
                    updateBehaviorActionState();
                }
            } catch (error) {
                console.error('Failed to load behavior entries', error);
                behaviorRecordList.innerHTML = '<p class="text-sm text-red-500">í–‰ë™ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
                behaviorEntries = [];
                currentBehaviorEntry = null;
                resetBehaviorDetail();
            } finally {
                isLoadingBehaviorEntries = false;
                updateBehaviorActionState();
            }
        }

        async function loadSharedBehaviors() {
            const user = auth.currentUser;
            if (!user || !behaviorSharedList || isLoadingSharedBehaviors) return;
            isLoadingSharedBehaviors = true;
            behaviorSharedList.innerHTML = '<p class="text-sm text-gray-500">ê³µìœ  ë°›ì€ í–‰ë™ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>';
            try {
                let inboxEntries = [];
                try {
                    const sharedInboxRef = collection(db, 'users', user.uid, 'sharedBehaviors');
                    const sharedInboxSnapshot = await getDocs(query(sharedInboxRef, orderBy('sharedAt', 'desc')));
                    inboxEntries = sharedInboxSnapshot.docs
                        .map(docSnap => {
                            const data = docSnap.data();
                            const ownerId = data.ownerId || '';
                            const behaviorId = data.behaviorId || '';
                            return {
                                id: behaviorId || docSnap.id,
                                ownerId,
                                studentId: data.studentId || '',
                                studentName: data.studentName || data.studentId || '',
                                title: data.title || '',
                                operationalDefinition: data.operationalDefinition || '',
                                useReinforcer: !!data.useReinforcer,
                                useAttentionToken: !!data.useAttentionToken,
                                sharedWith: Array.isArray(data.sharedWith) ? data.sharedWith : [],
                                createdAt: data.createdAt,
                                sharedAt: data.sharedAt || data.updatedAt || data.createdAt,
                            };
                        })
                        .filter(entry => entry.id && entry.ownerId);
                } catch (error) {
                    if (error?.code === 'permission-denied') {
                        console.warn('Permission denied when loading shared behavior inbox, falling back to legacy query.', error);
                    } else {
                        throw error;
                    }
                }
                sharedBehaviorEntries = inboxEntries;

                if (!sharedBehaviorEntries.length) {
                    const legacyQuery = query(collectionGroup(db, 'behaviors'), where('sharedWith', 'array-contains', user.uid));
                    const snapshot = await getDocs(legacyQuery);
                    sharedBehaviorEntries = snapshot.docs.map(docSnap => {
                        const data = docSnap.data();
                        const ownerRef = docSnap.ref.parent?.parent;
                        const ownerId = ownerRef?.id || data.ownerId || '';
                        return {
                            id: docSnap.id,
                            ownerId,
                            studentId: data.studentId || '',
                            studentName: data.studentName || data.studentId || '',
                            title: data.title || '',
                            operationalDefinition: data.operationalDefinition || '',
                            useReinforcer: !!data.useReinforcer,
                            useAttentionToken: !!data.useAttentionToken,
                            sharedWith: Array.isArray(data.sharedWith) ? data.sharedWith : [],
                            createdAt: data.createdAt,
                        };
                    });
                    sharedBehaviorEntries.sort((a, b) => {
                        const aTime = a.createdAt?.toMillis?.() || 0;
                        const bTime = b.createdAt?.toMillis?.() || 0;
                        return bTime - aTime;
                    });
                    if (sharedBehaviorEntries.length) {
                        await Promise.allSettled(sharedBehaviorEntries.map(entry => cacheSharedBehaviorEntry(user.uid, entry)));
                    }
                } else {
                    sharedBehaviorEntries.sort((a, b) => {
                        const aTime = a.sharedAt?.toMillis?.() || a.createdAt?.toMillis?.() || 0;
                        const bTime = b.sharedAt?.toMillis?.() || b.createdAt?.toMillis?.() || 0;
                        return bTime - aTime;
                    });
                }
                if (currentBehaviorSource === 'shared') {
                    const stillExists = sharedBehaviorEntries.some(entry => entry.id === currentBehaviorEntry?.id && entry.ownerId === currentBehaviorOwnerId);
                    if (!stillExists) {
                        resetBehaviorDetail();
                        if (behaviorSelectedStudentLabel) {
                            behaviorSelectedStudentLabel.textContent = 'í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
                        }
                    }
                }
                renderSharedBehaviorList();
            } catch (error) {
                console.error('Failed to load shared behaviors', error);
                sharedBehaviorEntries = [];
                if (behaviorSharedList) {
                    behaviorSharedList.innerHTML = '<p class="text-sm text-red-500">ê³µìœ  ë°›ì€ í–‰ë™ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
                }
            } finally {
                isLoadingSharedBehaviors = false;
            }
        }

        function getSharedBehaviorDocId(ownerId, behaviorId) {
            return `${ownerId}_${behaviorId}`;
        }

        async function cacheSharedBehaviorEntry(recipientId, entry) {
            try {
                const docId = getSharedBehaviorDocId(entry.ownerId, entry.id);
                const sharedRef = doc(db, 'users', recipientId, 'sharedBehaviors', docId);
                await setDoc(sharedRef, {
                    ownerId: entry.ownerId,
                    behaviorId: entry.id,
                    studentId: entry.studentId || '',
                    studentName: entry.studentName || '',
                    title: entry.title || '',
                    operationalDefinition: entry.operationalDefinition || '',
                    useReinforcer: !!entry.useReinforcer,
                    useAttentionToken: !!entry.useAttentionToken,
                    sharedWith: Array.isArray(entry.sharedWith) ? entry.sharedWith : [],
                    createdAt: entry.createdAt || serverTimestamp(),
                    sharedAt: entry.sharedAt || entry.createdAt || serverTimestamp(),
                    updatedAt: serverTimestamp()
                }, { merge: true });
            } catch (error) {
                console.warn('Failed to cache shared behavior entry', error);
            }
        }

        async function loadTeacherDirectory() {
            const user = auth.currentUser;
            if (!user) return [];
            if (teacherDirectoryLoaded || isLoadingTeacherDirectory) {
                return teacherDirectory;
            }
            isLoadingTeacherDirectory = true;
            try {
                const snapshot = await getDocs(query(collection(db, 'users'), where('role', '==', 'teacher')));
                teacherDirectory = snapshot.docs
                    .map(docSnap => {
                        const data = docSnap.data();
                        return {
                            id: docSnap.id,
                            name: data.name || '',
                            email: data.email || '',
                        };
                    })
                    .filter(person => person.id && person.id !== user.uid);
                teacherDirectory.sort((a, b) => {
                    const nameA = (a.name || a.email || '').toLowerCase();
                    const nameB = (b.name || b.email || '').toLowerCase();
                    return nameA.localeCompare(nameB);
                });
                teacherDirectoryLoaded = true;
            } catch (error) {
                console.error('Failed to load teacher directory', error);
                teacherDirectory = [];
            } finally {
                isLoadingTeacherDirectory = false;
            }
            return teacherDirectory;
        }

        function renderBehaviorShareUserList(selectedIds = []) {
            if (!behaviorShareUserList) return;
            behaviorShareUserList.innerHTML = '';
            if (!teacherDirectory.length) {
                behaviorShareUserList.innerHTML = '<p class="text-sm text-gray-500">ê³µìœ  ê°€ëŠ¥í•œ ì´ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            teacherDirectory.forEach(user => {
                const isChecked = selectedIds.includes(user.id);
                const label = document.createElement('label');
                label.className = 'flex items-center gap-3 rounded-lg border border-slate-200 px-3 py-2 transition hover:border-sky-300';
                label.innerHTML = `
                    <input type="checkbox" value="${user.id}" class="h-4 w-4 rounded border-gray-300 text-sky-600 focus:ring-sky-500" ${isChecked ? 'checked' : ''}>
                    <div class="flex flex-col">
                        <span class="font-medium text-slate-700">${escapeHtml(user.name || user.email || 'ì´ë¦„ ë¯¸í™•ì¸')}</span>
                        ${user.email ? `<span class="text-xs text-slate-500">${escapeHtml(user.email)}</span>` : ''}
                    </div>
                `;
                behaviorShareUserList.appendChild(label);
            });
        }

        function openBehaviorShareModal() {
            const user = auth.currentUser;
            if (!behaviorShareModal || !behaviorShareBtn || !behaviorShareUserList || !currentBehaviorEntry || !user) return;
            if (currentBehaviorOwnerId !== user.uid) return;
            behaviorShareModal.classList.remove('hidden');
            behaviorShareModal.classList.add('flex');
            if (behaviorShareConfirmBtn) behaviorShareConfirmBtn.disabled = true;
            behaviorShareUserList.innerHTML = '<p class="text-sm text-gray-500">ì´ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>';
            loadTeacherDirectory().then(() => {
                renderBehaviorShareUserList(currentBehaviorEntry.sharedWith || []);
                if (behaviorShareConfirmBtn) behaviorShareConfirmBtn.disabled = false;
            });
        }

        function closeBehaviorShareModal() {
            if (!behaviorShareModal) return;
            behaviorShareModal.classList.add('hidden');
            behaviorShareModal.classList.remove('flex');
        }

        async function handleBehaviorShareConfirm() {
            const user = auth.currentUser;
            if (!user || !currentBehaviorEntry || currentBehaviorOwnerId !== user.uid || !behaviorShareUserList) return;
            if (isUpdatingBehaviorShare) return;
            const selectedIds = Array.from(behaviorShareUserList.querySelectorAll('input[type="checkbox"]:checked')).map(input => input.value);
            const previousSharedWith = Array.isArray(currentBehaviorEntry.sharedWith) ? [...currentBehaviorEntry.sharedWith] : [];
            isUpdatingBehaviorShare = true;
            if (behaviorShareConfirmBtn) behaviorShareConfirmBtn.disabled = true;
            try {
                const behaviorRef = doc(db, 'users', user.uid, 'behaviors', currentBehaviorEntry.id);
                await updateDoc(behaviorRef, {
                    sharedWith: selectedIds,
                    ownerId: user.uid,
                });
                currentBehaviorEntry.sharedWith = selectedIds;
                const entryIndex = behaviorEntries.findIndex(entry => entry.id === currentBehaviorEntry.id);
                if (entryIndex !== -1) {
                    behaviorEntries[entryIndex].sharedWith = selectedIds;
                }
                await syncSharedBehaviorInbox(user.uid, selectedIds, previousSharedWith);
                showToast('ê³µìœ  ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeBehaviorShareModal();
                loadSharedBehaviors();
            } catch (error) {
                console.error('Failed to update behavior sharing', error);
                alert('ê³µìœ  ì„¤ì •ì„ ì €ì¥í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            } finally {
                isUpdatingBehaviorShare = false;
                if (behaviorShareConfirmBtn) behaviorShareConfirmBtn.disabled = false;
            }
        }

        async function syncSharedBehaviorInbox(ownerId, selectedIds, previousSharedWith) {
            if (!currentBehaviorEntry || !Array.isArray(selectedIds)) return;
            const tasks = [];
            const uniqueSelected = selectedIds.filter((teacherId, index, arr) => teacherId && arr.indexOf(teacherId) === index && teacherId !== ownerId);
            const removed = Array.isArray(previousSharedWith)
                ? previousSharedWith.filter(id => id && id !== ownerId && !uniqueSelected.includes(id))
                : [];

            const payload = {
                ownerId,
                behaviorId: currentBehaviorEntry.id,
                studentId: currentBehaviorEntry.studentId || '',
                studentName: currentBehaviorEntry.studentName || '',
                title: currentBehaviorEntry.title || '',
                operationalDefinition: currentBehaviorEntry.operationalDefinition || '',
                useReinforcer: !!currentBehaviorEntry.useReinforcer,
                useAttentionToken: !!currentBehaviorEntry.useAttentionToken,
                sharedWith: uniqueSelected,
                createdAt: currentBehaviorEntry.createdAt || serverTimestamp(),
                sharedAt: serverTimestamp(),
                updatedAt: serverTimestamp()
            };

            uniqueSelected.forEach(teacherId => {
                const docId = getSharedBehaviorDocId(ownerId, currentBehaviorEntry.id);
                const sharedRef = doc(db, 'users', teacherId, 'sharedBehaviors', docId);
                tasks.push(setDoc(sharedRef, payload, { merge: true }));
            });

            removed.forEach(teacherId => {
                const docId = getSharedBehaviorDocId(ownerId, currentBehaviorEntry.id);
                const sharedRef = doc(db, 'users', teacherId, 'sharedBehaviors', docId);
                tasks.push(deleteDoc(sharedRef).catch(() => {}));
            });

            if (tasks.length) {
                await Promise.allSettled(tasks);
            }
        }

        function canEditLogItem(logItem) {
            const user = auth.currentUser;
            if (!user) return false;
            if (currentBehaviorOwnerId === user.uid) return true;
            return logItem.recordedBy === user.uid;
        }

        function canDeleteLogItem(logItem) {
            const user = auth.currentUser;
            if (!user) return false;
            return currentBehaviorOwnerId === user.uid;
        }

        function openBehaviorLogNoteModal(logId) {
            if (!behaviorLogNoteModal || !currentBehaviorEntry) return;
            const logItem = currentBehaviorLogs.find(item => item.id === logId);
            if (!logItem) return;
            if (!canEditLogItem(logItem)) {
                alert('í•´ë‹¹ ê¸°ë¡ì— íŠ¹ì´ ì‚¬í•­ì„ ë‚¨ê¸¸ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            currentBehaviorLogEditing = logItem;
            const name = logItem.recordedByName || 'ê¸°ë¡ì ë¯¸ìƒ';
            const time = logItem.timestamp ? formatTimestamp(logItem.timestamp) : 'ì‹œê°„ ì •ë³´ ì—†ìŒ';
            if (behaviorLogNoteMeta) {
                behaviorLogNoteMeta.textContent = `${name} Â· ${time}`;
            }
            if (behaviorLogNoteInput) {
                behaviorLogNoteInput.value = logItem.note || '';
            }
            if (behaviorLogNoteDeleteBtn) {
                behaviorLogNoteDeleteBtn.classList.toggle('hidden', !canDeleteLogItem(logItem));
            }
            behaviorLogNoteModal.classList.remove('hidden');
            behaviorLogNoteModal.classList.add('flex');
            setTimeout(() => behaviorLogNoteInput?.focus(), 50);
        }

        function closeBehaviorLogNoteModal() {
            if (!behaviorLogNoteModal) return;
            currentBehaviorLogEditing = null;
            behaviorLogNoteModal.classList.add('hidden');
            behaviorLogNoteModal.classList.remove('flex');
        }

        async function saveBehaviorLogNote() {
            const user = auth.currentUser;
            if (!user || !currentBehaviorEntry || !currentBehaviorLogEditing) return;
            if (!canEditLogItem(currentBehaviorLogEditing)) {
                alert('í•´ë‹¹ ê¸°ë¡ì— íŠ¹ì´ ì‚¬í•­ì„ ë‚¨ê¸¸ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const noteValue = (behaviorLogNoteInput?.value || '').trim();
            const ownerId = currentBehaviorOwnerId || user.uid;
            try {
                const logRef = doc(db, 'users', ownerId, 'behaviors', currentBehaviorEntry.id, 'logs', currentBehaviorLogEditing.id);
                if (noteValue) {
                    await updateDoc(logRef, { note: noteValue });
                } else {
                    await updateDoc(logRef, { note: deleteField() });
                }
                showToast('íŠ¹ì´ ì‚¬í•­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeBehaviorLogNoteModal();
                loadBehaviorLogs(currentBehaviorEntry.id, currentBehaviorOwnerId);
            } catch (error) {
                console.error('Failed to save behavior log note', error);
                alert('íŠ¹ì´ ì‚¬í•­ì„ ì €ì¥í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        async function deleteBehaviorLogEntry() {
            const user = auth.currentUser;
            if (!user || !currentBehaviorEntry || !currentBehaviorLogEditing) return;
            if (!canDeleteLogItem(currentBehaviorLogEditing)) {
                alert('í–‰ë™ ê¸°ë¡ì„ ì‚­ì œí•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            if (!confirm('í•´ë‹¹ í–‰ë™ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const ownerId = currentBehaviorOwnerId || user.uid;
            try {
                await deleteDoc(doc(db, 'users', ownerId, 'behaviors', currentBehaviorEntry.id, 'logs', currentBehaviorLogEditing.id));
                showToast('í–‰ë™ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeBehaviorLogNoteModal();
                loadBehaviorLogs(currentBehaviorEntry.id, currentBehaviorOwnerId);
            } catch (error) {
                console.error('Failed to delete behavior log', error);
                alert('í–‰ë™ ê¸°ë¡ì„ ì‚­ì œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        function selectBehaviorEntry(behaviorId, options = {}) {
            const entry = options.entry || behaviorEntries.find(item => item.id === behaviorId);
            if (!entry) return;
            currentBehaviorEntry = entry;
            const user = auth.currentUser;
            currentBehaviorOwnerId = options.ownerId || entry.ownerId || user?.uid || '';
            currentBehaviorSource = options.source || 'own';
            updateBehaviorEntriesActiveState();
            updateSharedBehaviorActiveState();
            showBehaviorDetail(entry);
        }

        function showBehaviorDetail(entry) {
            if (!behaviorDetailPanel) return;
            behaviorDetailPanel.classList.remove('hidden');
            if (behaviorDetailTitle) behaviorDetailTitle.textContent = entry.title || 'í–‰ë™ ê¸°ë¡';
            if (behaviorOperationalDefinition) {
                const definition = (entry.operationalDefinition || '').trim();
                behaviorOperationalDefinition.textContent = definition || 'ì¡°ì‘ì  ì •ì˜ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
            }
            if (behaviorReinforcerBadge) {
                behaviorReinforcerBadge.classList.toggle('hidden', !entry.useReinforcer);
            }
            if (behaviorAttentionBadge) {
                behaviorAttentionBadge.classList.toggle('hidden', !entry.useAttentionToken);
            }
            if (behaviorLogList) {
                behaviorLogList.innerHTML = '<li class="text-gray-500">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</li>';
            }
            currentBehaviorChartData = createEmptyBehaviorChartData();
            currentBehaviorChartView = 'daily';
            setBehaviorChartView('daily');
            updateBehaviorActionState();
            loadBehaviorLogs(entry.id, currentBehaviorOwnerId);
        }

        async function loadBehaviorLogs(behaviorId, ownerId) {
            if (!currentBehaviorEntry || currentBehaviorEntry.id !== behaviorId) return;
            const user = auth.currentUser;
            if (!user) return;
            const targetOwnerId = ownerId || currentBehaviorOwnerId || user.uid;
            if (!targetOwnerId) return;
            currentBehaviorChartData = createEmptyBehaviorChartData();
            try {
                const logsRef = collection(db, 'users', targetOwnerId, 'behaviors', behaviorId, 'logs');
                const logSnapshot = await getDocs(query(logsRef, orderBy('timestamp', 'asc')));
                const dailyCounts = new Map();
                const monthlyCounts = new Map();
                const hourlyCounts = new Map();
                const logItems = [];
                let latestDateKey = '';
                let latestTimestamp = null;

                logSnapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const timestamp = data.timestamp?.toDate?.() || null;
                    let dateKey = '';
                    let hour = null;
                    if (timestamp) {
                        dateKey = formatDateKey(timestamp);
                        hour = timestamp.getHours();
                        const dayLabel = timestamp.toLocaleDateString('ko-KR');
                        dailyCounts.set(dayLabel, (dailyCounts.get(dayLabel) || 0) + 1);
                        const monthKey = `${timestamp.getFullYear()}-${String(timestamp.getMonth() + 1).padStart(2, '0')}`;
                        monthlyCounts.set(monthKey, (monthlyCounts.get(monthKey) || 0) + 1);
                        if (!latestTimestamp || timestamp > latestTimestamp) {
                            latestTimestamp = timestamp;
                            latestDateKey = dateKey;
                        }
                    }
                    logItems.push({
                        id: docSnap.id,
                        timestamp,
                        recordedByName: data.recordedByName || '',
                        recordedBy: data.recordedBy || '',
                        note: data.note || '',
                        dateKey,
                        hour
                    });
                });

                if (latestDateKey) {
                    logItems.forEach(item => {
                        if (item.dateKey === latestDateKey && item.hour !== null) {
                            const label = `${String(item.hour).padStart(2, '0')}ì‹œ`;
                            hourlyCounts.set(label, (hourlyCounts.get(label) || 0) + 1);
                        }
                    });
                }

                currentBehaviorLogs = logItems.map(({ dateKey, hour, ...rest }) => rest);
                renderBehaviorLogList(currentBehaviorLogs);

                const hourlyLabels = Array.from(hourlyCounts.keys());
                const dailyLabels = Array.from(dailyCounts.keys());
                const monthlyKeys = Array.from(monthlyCounts.keys());

                currentBehaviorChartData = {
                    hourly: {
                        labels: hourlyLabels,
                        data: hourlyLabels.map(label => hourlyCounts.get(label) || 0)
                    },
                    daily: {
                        labels: dailyLabels,
                        data: dailyLabels.map(label => dailyCounts.get(label) || 0)
                    },
                    monthly: {
                        labels: monthlyKeys.map(formatMonthLabel),
                        data: monthlyKeys.map(key => monthlyCounts.get(key) || 0)
                    }
                };

                setBehaviorChartView(currentBehaviorChartView, true);
            } catch (error) {
                console.error('Failed to load behavior logs', error);
                currentBehaviorLogs = [];
                currentBehaviorChartData = createEmptyBehaviorChartData();
                setBehaviorChartView(currentBehaviorChartView, true);
                if (behaviorLogList) {
                    behaviorLogList.innerHTML = '<li class="text-sm text-red-500">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</li>';
                }
            }
        }

        function renderBehaviorLogList(logItems) {
            if (!behaviorLogList) return;
            behaviorLogList.innerHTML = '';
            if (!logItems.length) {
                behaviorLogList.innerHTML = '<li class="text-gray-500">ê¸°ë¡ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì²« ê¸°ë¡ì„ ë‚¨ê²¨ë³´ì„¸ìš”.</li>';
                return;
            }
            logItems.slice().reverse().forEach(item => {
                const li = document.createElement('li');
                li.className = 'rounded-lg border border-slate-200 bg-white px-3 py-2 shadow-sm';
                const name = escapeHtml(item.recordedByName || 'ê¸°ë¡ì ë¯¸ìƒ');
                const time = item.timestamp ? formatTimestamp(item.timestamp) : 'ì‹œê°„ ì •ë³´ ì—†ìŒ';
                const note = (item.note || '').trim();
                const noteContent = note
                    ? `<p class="text-sm text-slate-600 whitespace-pre-line">íŠ¹ì´ ì‚¬í•­: ${escapeHtml(note)}</p>`
                    : '<p class="text-xs text-sky-600">íŠ¹ì´ ì‚¬í•­ì„ ì¶”ê°€í•˜ë ¤ë©´ í´ë¦­í•˜ì„¸ìš”.</p>';
                li.innerHTML = `
                    <button type="button" data-log-id="${item.id}" class="flex w-full flex-col gap-1 text-left">
                        <span class="font-semibold text-slate-700">${name}</span>
                        <span class="text-xs text-slate-500">${escapeHtml(time)}</span>
                        ${noteContent}
                    </button>
                `;
                behaviorLogList.appendChild(li);
            });
        }

        function createEmptyBehaviorChartData() {
            return {
                hourly: { labels: [], data: [] },
                daily: { labels: [], data: [] },
                monthly: { labels: [], data: [] }
            };
        }

        function setBehaviorChartView(view, render = true) {
            if (!['hourly', 'daily', 'monthly'].includes(view)) {
                view = 'daily';
            }
            currentBehaviorChartView = view;
            if (behaviorGraphViewButtons) {
                behaviorGraphViewButtons.querySelectorAll('button[data-view]').forEach(button => {
                    const isActive = button.dataset.view === view;
                    if (isActive) {
                        button.classList.add('bg-sky-600', 'border-sky-600', 'text-white', 'hover:bg-sky-700');
                        button.classList.remove('bg-white', 'text-sky-600', 'border-sky-200', 'hover:bg-sky-50');
                    } else {
                        button.classList.remove('bg-sky-600', 'border-sky-600', 'text-white', 'hover:bg-sky-700');
                        button.classList.add('bg-white', 'text-sky-600', 'border-sky-200', 'hover:bg-sky-50');
                    }
                });
            }
            if (render) {
                const dataset = currentBehaviorChartData[view] || { labels: [], data: [] };
                const labelText = currentBehaviorEntry?.title || '';
                renderBehaviorChart(dataset.labels, dataset.data, labelText);
            }
        }

        function renderBehaviorChart(labels, dataPoints, labelText) {
            const datasetLabel = labelText ? `${labelText} ë°œìƒ ë¹ˆë„` : 'í–‰ë™ ë°œìƒ ë¹ˆë„';
            const chartData = {
                labels,
                datasets: [{
                    label: datasetLabel,
                    data: dataPoints,
                    borderColor: '#0ea5e9',
                    backgroundColor: 'rgba(14, 165, 233, 0.15)',
                    fill: true,
                    tension: 0.15,
                    pointRadius: 3
                }]
            };
            const options = {
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 }
                    }
                }
            };
            updateChart('behaviorChart', 'behaviorChartInstance', 'line', chartData, options);
        }

        function openBehaviorModal() {
            if (!behaviorModal) return;
            behaviorModal.classList.remove('hidden');
            behaviorModal.classList.add('flex');
            if (behaviorModalTitleInput) behaviorModalTitleInput.value = '';
            if (behaviorModalDefinitionInput) behaviorModalDefinitionInput.value = '';
            if (behaviorModalReinforcerInput) behaviorModalReinforcerInput.checked = false;
            if (behaviorModalAttentionInput) behaviorModalAttentionInput.checked = false;
            setTimeout(() => behaviorModalTitleInput?.focus(), 50);
        }

        function closeBehaviorModal() {
            if (!behaviorModal) return;
            behaviorModal.classList.add('hidden');
            behaviorModal.classList.remove('flex');
        }

        async function handleBehaviorModalSave() {
            if (!currentBehaviorStudentId) {
                alert('í•™ìƒì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            const title = (behaviorModalTitleInput?.value || '').trim();
            const operationalDefinition = (behaviorModalDefinitionInput?.value || '').trim();
            const useReinforcer = !!behaviorModalReinforcerInput?.checked;
            const useAttentionToken = !!behaviorModalAttentionInput?.checked;
            if (!title) {
                alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                behaviorModalTitleInput?.focus();
                return;
            }
            const user = auth.currentUser;
            if (!user) return;
            const student = behaviorStudents.find(s => s.id === currentBehaviorStudentId);
            try {
                const docRef = await addDoc(collection(db, 'users', user.uid, 'behaviors'), {
                    title,
                    studentId: currentBehaviorStudentId,
                    studentName: student?.name || '',
                    useReinforcer,
                    useAttentionToken,
                    operationalDefinition,
                    createdAt: serverTimestamp()
                });
                showToast('í–‰ë™ ê¸°ë¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeBehaviorModal();
                await loadBehaviorEntries(currentBehaviorStudentId, docRef.id);
            } catch (error) {
                console.error('Failed to add behavior entry', error);
                alert('í–‰ë™ ê¸°ë¡ì„ ì¶”ê°€í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        async function getRecorderDisplayName() {
            const user = auth.currentUser;
            if (!user) return 'ê¸°ë¡ì';
            const profile = await ensureCurrentUserProfile();
            if (profile?.name) return profile.name;
            if (user.displayName) return user.displayName;
            if (profile?.email) return profile.email.split('@')[0];
            if (user.email) return user.email.split('@')[0];
            return 'ê¸°ë¡ì';
        }

        if (behaviorStudentList) {
            behaviorStudentList.addEventListener('click', (event) => {
                const button = event.target.closest('button[data-student-id]');
                if (!button) return;
                const studentId = button.dataset.studentId;
                currentBehaviorStudentId = studentId;
                const student = behaviorStudents.find(s => s.id === studentId);
                if (behaviorSelectedStudentLabel) {
                    behaviorSelectedStudentLabel.textContent = `${student?.name || 'í•™ìƒ'} í•™ìƒ`;
                }
                updateBehaviorStudentActiveState();
                resetBehaviorDetail();
                loadBehaviorEntries(studentId);
                updateBehaviorActionState();
            });
        }

        if (behaviorRecordList) {
            behaviorRecordList.addEventListener('click', (event) => {
                const button = event.target.closest('button[data-behavior-id]');
                if (!button) return;
                selectBehaviorEntry(button.dataset.behaviorId);
            });
        }

        if (behaviorSharedList) {
            behaviorSharedList.addEventListener('click', (event) => {
                const button = event.target.closest('button[data-shared-behavior-id]');
                if (!button) return;
                const behaviorId = button.dataset.sharedBehaviorId;
                const ownerId = button.dataset.ownerId;
                const entry = sharedBehaviorEntries.find(item => item.id === behaviorId && item.ownerId === ownerId);
                if (!entry) return;
                if (behaviorSelectedStudentLabel) {
                    const displayName = entry.studentName || 'í•™ìƒ';
                    behaviorSelectedStudentLabel.textContent = `${displayName} í•™ìƒ (ê³µìœ )`;
                }
                currentBehaviorStudentId = '';
                selectBehaviorEntry(behaviorId, { entry, ownerId, source: 'shared' });
                updateBehaviorActionState();
            });
        }

        behaviorGraphViewButtons?.addEventListener('click', (event) => {
            const button = event.target.closest('button[data-view]');
            if (!button) return;
            setBehaviorChartView(button.dataset.view);
        });

        refreshBehaviorStudentsBtn?.addEventListener('click', () => {
            loadBehaviorStudents();
            loadSharedBehaviors();
        });
        refreshSharedBehaviorsBtn?.addEventListener('click', () => loadSharedBehaviors());

        openBehaviorModalBtn?.addEventListener('click', () => {
            if (!currentBehaviorStudentId) {
                alert('í•™ìƒì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            openBehaviorModal();
        });

        behaviorModalCancelBtn?.addEventListener('click', closeBehaviorModal);
        behaviorModal?.addEventListener('click', (event) => {
            if (event.target === behaviorModal) {
                closeBehaviorModal();
            }
        });
        behaviorModalSaveBtn?.addEventListener('click', handleBehaviorModalSave);

        behaviorShareBtn?.addEventListener('click', openBehaviorShareModal);
        behaviorShareCancelBtn?.addEventListener('click', closeBehaviorShareModal);
        behaviorShareCloseBtn?.addEventListener('click', closeBehaviorShareModal);
        behaviorShareModal?.addEventListener('click', (event) => {
            if (event.target === behaviorShareModal) {
                closeBehaviorShareModal();
            }
        });
        behaviorShareConfirmBtn?.addEventListener('click', handleBehaviorShareConfirm);

        if (behaviorLogList) {
            behaviorLogList.addEventListener('click', (event) => {
                const button = event.target.closest('button[data-log-id]');
                if (!button) return;
                openBehaviorLogNoteModal(button.dataset.logId);
            });
        }

        behaviorLogNoteCancelBtn?.addEventListener('click', closeBehaviorLogNoteModal);
        behaviorLogNoteCloseBtn?.addEventListener('click', closeBehaviorLogNoteModal);
        behaviorLogNoteModal?.addEventListener('click', (event) => {
            if (event.target === behaviorLogNoteModal) {
                closeBehaviorLogNoteModal();
            }
        });
        behaviorLogNoteSaveBtn?.addEventListener('click', saveBehaviorLogNote);
        behaviorLogNoteDeleteBtn?.addEventListener('click', deleteBehaviorLogEntry);

        if (logBehaviorBtn) {
            logBehaviorBtn.addEventListener('click', async () => {
                if (!currentBehaviorEntry) {
                    alert('í–‰ë™ ê¸°ë¡ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                const user = auth.currentUser;
                if (!user) return;
                const recorderName = await getRecorderDisplayName();
                try {
                    const ownerId = currentBehaviorOwnerId || user.uid;
                    await addDoc(collection(db, 'users', ownerId, 'behaviors', currentBehaviorEntry.id, 'logs'), {
                        timestamp: serverTimestamp(),
                        recordedBy: user.uid,
                        recordedByName: recorderName
                    });
                    const title = currentBehaviorEntry.title || 'í–‰ë™';
                    showToast(`${title}ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    loadBehaviorLogs(currentBehaviorEntry.id, currentBehaviorOwnerId);
                } catch (error) {
                    console.error('Failed to record behavior log', error);
                    alert('í–‰ë™ì„ ê¸°ë¡í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            });
        }

        window.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && behaviorModal && !behaviorModal.classList.contains('hidden')) {
                closeBehaviorModal();
            } else if (event.key === 'Escape' && behaviorShareModal && !behaviorShareModal.classList.contains('hidden')) {
                closeBehaviorShareModal();
            } else if (event.key === 'Escape' && behaviorLogNoteModal && !behaviorLogNoteModal.classList.contains('hidden')) {
                closeBehaviorLogNoteModal();
            }
        });

        async function prepareBehaviorView() {
            if (behaviorSelectedStudentLabel && !currentBehaviorStudentId) {
                behaviorSelectedStudentLabel.textContent = 'í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
            }
            resetBehaviorDetail();
            updateBehaviorActionState();
            await Promise.all([loadBehaviorStudents(), loadSharedBehaviors(), renderSketchbookList()]);
        }

        // --- UTILITY FUNCTIONS ---
        function formatDateKey(date) {
            if (!(date instanceof Date)) return '';
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatMonthLabel(key = '') {
            const [year, month] = key.split('-');
            if (!year || !month) return key || '';
            const yearNum = Number(year);
            const monthNum = Number(month);
            if (Number.isNaN(yearNum) || Number.isNaN(monthNum)) return key;
            return `${yearNum}ë…„ ${monthNum}ì›”`;
        }

        function formatTimestamp(date) {
            if (!(date instanceof Date)) {
                return 'ì‹œê°„ ì •ë³´ ì—†ìŒ';
            }
            return date.toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        function escapeHtml(text) {
            return (text || '').replace(/[&<>"']/g, (char) => {
                switch (char) {
                    case '&': return '&amp;';
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '"': return '&quot;';
                    case "'": return '&#39;';
                    default: return char;
                }
            });
        }

        function formatCellText(text) {
            return escapeHtml(text || '').replace(/\n/g, '<br>');
        }

        function showToast(message) {
            toast.textContent = message;
            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 2000);
        }

        function updateChart(canvasId, instanceVar, type, data, options = {}) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            if (window[instanceVar]) {
                window[instanceVar].destroy();
            }

            window[instanceVar] = new Chart(ctx, { type, data, options });
        }
        
        // Initial load
        window.addEventListener('hashchange', () => {
            const currentView = window.location.hash.replace('#', '') || 'home';
            switchView(currentView).catch(console.error);
        });

    </script>
</body>
</html>

