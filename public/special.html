<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—ì´ë‘ ìŠ¤í˜ì…œ - íŠ¹ìˆ˜êµì‚¬ ì—…ë¬´ ë³´ì¡°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Noto Sans KR', sans-serif; }
        .content-section {
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: white;
        }
        .content-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
        }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #0ea5e9; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .nav-link { padding: 0.5rem 1rem; border-radius: 0.375rem; transition: background-color 0.2s, color 0.2s; }
        .nav-link.active { background-color: #0284c7; color: white; }
        .nav-link:not(.active):hover { background-color: #f3f4f6; }
        .tab-btn {
             transition: all 0.2s;
             border: 2px solid transparent;
        }
        .tab-btn.active {
             background-color: #0ea5e9; /* sky-500 */
             color: white;
             border-color: #0284c7; /* sky-600 */
             font-weight: 600;
        }
        .tab-btn:not(.active) {
            background-color: #f1f5f9; /* slate-100 */
            color: #475569; /* slate-600 */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="app">
        <!-- Auth View (Login/Signup) -->
        <div id="auth-view" class="min-h-screen flex items-center justify-center bg-gray-100">
            <div class="w-full max-w-md bg-white rounded-lg shadow-md p-8">
                <h2 class="text-2xl font-bold text-center text-sky-600 mb-6">ì—ì´ë‘ ìŠ¤í˜ì…œ ì‹œì‘í•˜ê¸°</h2>
                <form id="auth-form" onsubmit="return false;">
                    <div class="mb-4">
                        <label for="email" class="block text-gray-700 text-sm font-bold mb-2">ì´ë©”ì¼</label>
                        <input type="email" id="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-gray-700 text-sm font-bold mb-2">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <p id="auth-error" class="text-red-500 text-xs italic mb-4 hidden"></p>
                    <div class="flex items-center justify-between">
                        <button type="button" id="login-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">ë¡œê·¸ì¸</button>
                        <button type="button" id="signup-btn" class="inline-block align-baseline font-bold text-sm text-sky-600 hover:text-sky-800">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? íšŒì›ê°€ì…</button>
                    </div>
                    <div class="my-4 flex items-center">
                        <div class="flex-grow border-t border-gray-300"></div>
                        <span class="flex-shrink mx-4 text-gray-400 text-sm">ë˜ëŠ”</span>
                        <div class="flex-grow border-t border-gray-300"></div>
                    </div>
                    <button type="button" id="google-login-btn" class="w-full bg-white border border-gray-300 text-gray-700 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline flex items-center justify-center gap-2 hover:bg-gray-50 transition-colors">
                        <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                        Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
                    </button>
                </form>
            </div>
        </div>

        <!-- Main App View -->
        <div id="main-app-view" class="hidden flex-col min-h-screen">
            <header class="bg-white shadow-md w-full sticky top-0 z-50">
                <div class="container mx-auto px-6 py-3 flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-sky-600"><a href="#home" id="home-link">ğŸ“ ì—ì´ë‘ ìŠ¤í˜ì…œ</a></h1>
                    <nav class="flex items-center gap-4">
                        <span id="user-email" class="text-sm text-gray-600"></span>
                        <a href="#home" id="nav-home" class="nav-link">í™ˆ</a>
                        <a href="#my-class" id="nav-my-class" class="nav-link">ë‚´ í•™ê¸‰ ê´€ë¦¬</a>
                        <a href="#iep" id="nav-iep" class="nav-link">ê°œë³„í™”êµìœ¡ê³„íš</a>
                        <a href="#behavior" id="nav-behavior" class="nav-link">í–‰ë™ ì¤‘ì¬</a>
                        <button id="logout-btn" class="text-sm bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-md transition-colors">ë¡œê·¸ì•„ì›ƒ</button>
                    </nav>
                </div>
            </header>
            <main class="flex-grow container mx-auto p-6">
                <!-- Home View -->
                <div id="home-view">
                    <h2 class="text-3xl font-bold mb-6">í™ˆ</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-2">ì•ˆë…•í•˜ì„¸ìš”, <span id="home-user-email"></span> ì„ ìƒë‹˜!</h3>
                            <p class="text-gray-600 mb-4">ì—ì´ë‘ ìŠ¤í˜ì…œê³¼ í•¨ê»˜ íŠ¹ìˆ˜í•™ê¸‰ ì—…ë¬´ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬í•´ë³´ì„¸ìš”.</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-4">ì—…ë¬´ í†µê³„</h3>
                             <div id="stats-chart-container" class="h-48 flex items-center justify-center">
                                <canvas id="statsChart"></canvas>
                            </div>
                        </div>
                        <div class="md:col-span-2 lg:col-span-3 bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-4">ë‚´ í•™ê¸‰ ëª©ë¡</h3>
                            <div id="home-class-list" class="space-y-3">
                                <!-- Class list will be dynamically inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- My Class View -->
                <div id="my-class-view" class="hidden">
                    <h2 class="text-3xl font-bold mb-6">ë‚´ í•™ê¸‰ ê´€ë¦¬</h2>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">í•™ê¸‰ ëª©ë¡</h3>
                            <button id="add-class-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded">ìƒˆ í•™ê¸‰ ì¶”ê°€</button>
                        </div>
                        <div id="class-list" class="space-y-4">
                            <!-- Class items will be dynamically inserted here -->
                        </div>
                    </div>
                </div>
                
                <!-- IEP View -->
                <div id="iep-view" class="hidden">
                     <h2 class="text-3xl font-bold mb-6">ê°œë³„í™”êµìœ¡ê³„íš(IEP) ìˆ˜ë¦½</h2>
                     <div class="flex flex-col lg:flex-row gap-6">
                        <aside class="w-full lg:w-1/3 bg-white p-6 rounded-lg shadow-lg h-fit lg:sticky top-24">
                            <h3 class="text-lg font-semibold mb-4">í•™ìƒ ì •ë³´ ì…ë ¥</h3>
                            <form id="iep-form" class="space-y-4">
                                <div>
                                    <label for="student-name" class="block text-sm font-medium text-gray-700">í•™ìƒ ì´ë¦„</label>
                                    <input type="text" id="student-name" class="mt-1 block w-full border border-gray-300 rounded-md p-2" required>
                                </div>
                                <div>
                                    <label for="student-grade" class="block text-sm font-medium text-gray-700">í•™ë…„</label>
                                    <input type="text" id="student-grade" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                                </div>
                                <div>
                                    <label for="iep-period" class="block text-sm font-medium text-gray-700">ê³„íš ê¸°ê°„</label>
                                    <input type="text" id="iep-period" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="ì˜ˆ: 2025.03.01 ~ 2026.02.28">
                                </div>
                                 <div>
                                    <label for="student-needs" class="block text-sm font-medium text-gray-700">í•™ìƒ ìš”êµ¬ì‚¬í•­ ë° ê°•ì </label>
                                    <textarea id="student-needs" rows="4" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="í•™ìƒì˜ íŠ¹ë³„í•œ êµìœ¡ì  ìš”êµ¬, ê°•ì , í¥ë¯¸ ë“±ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
                                </div>
                                <button type="submit" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-4 rounded-lg">AI ê°œë³„í™”êµìœ¡ê³„íš ì´ˆì•ˆ ìƒì„±</button>
                            </form>
                        </aside>
                        <section class="w-full lg:w-2/3">
                            <div id="iep-initial-message" class="bg-white p-8 rounded-lg shadow-lg text-center">
                                <h2 class="text-2xl font-bold text-gray-800">AIê°€ ìƒì„±í•œ IEP ì´ˆì•ˆì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</h2>
                                <p class="mt-2 text-gray-600">ì¢Œì¸¡ì— í•™ìƒ ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  ìƒì„± ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
                            </div>
                             <div id="iep-loading" class="hidden flex-col items-center justify-center text-center py-16">
                                <div class="loader"></div>
                                <p class="mt-4 text-lg font-semibold text-gray-700">AIê°€ IEP ì´ˆì•ˆì„ ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                            </div>
                            <div id="iep-output" class="hidden content-section">
                                <!-- IEP content will be injected here -->
                            </div>
                        </section>
                     </div>
                </div>

                <!-- Behavior Intervention View -->
                <div id="behavior-view" class="hidden">
                    <h2 class="text-3xl font-bold mb-6">í–‰ë™ ì¤‘ì¬</h2>
                     <div class="flex flex-col lg:flex-row gap-6">
                        <aside class="w-full lg:w-1/3 bg-white p-6 rounded-lg shadow-lg h-fit lg:sticky top-24 space-y-6">
                            <div>
                                <h3 class="text-lg font-semibold mb-4">í•™ìƒ ë° í–‰ë™ ì„ íƒ</h3>
                                <div class="space-y-4">
                                     <div>
                                        <label for="behavior-student-name" class="block text-sm font-medium text-gray-700">í•™ìƒ ì´ë¦„</label>
                                        <input type="text" id="behavior-student-name" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="ê´€ì°°í•  í•™ìƒ ì´ë¦„">
                                    </div>
                                    <div>
                                        <label for="target-behavior" class="block text-sm font-medium text-gray-700">ëª©í‘œ í–‰ë™</label>
                                        <input type="text" id="target-behavior" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="ì˜ˆ: ë°”ë¥´ê²Œ ì•‰ì•„ ìˆê¸°">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">í–‰ë™ ìœ í˜•</label>
                                        <div id="behavior-type-buttons" class="grid grid-cols-2 gap-2">
                                            <button type="button" data-value="increase" class="tab-btn py-2 px-2 rounded text-sm active">ì¦ê°€ì‹œí‚¬ í–‰ë™</button>
                                            <button type="button" data-value="decrease" class="tab-btn py-2 px-2 rounded text-sm">ê°ì†Œì‹œí‚¬ í–‰ë™</button>
                                        </div>
                                    </div>
                                    <button id="start-observation-btn" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg">ê´€ì°° ì‹œì‘</button>
                                </div>
                            </div>
                            <div id="behavior-logging-section" class="hidden">
                                <h3 class="text-lg font-semibold mb-4">í–‰ë™ ê¸°ë¡</h3>
                                <p class="text-sm text-gray-600 mb-1">í•™ìƒ: <span id="logging-student" class="font-bold"></span></p>
                                <p class="text-sm text-gray-600 mb-4">ëª©í‘œ í–‰ë™: <span id="logging-behavior" class="font-bold"></span></p>
                                <button id="log-behavior-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-4 rounded-lg text-lg">í–‰ë™ ë°œìƒ (+1)</button>
                            </div>
                        </aside>
                        <section class="w-full lg:w-2/3">
                            <div class="content-section">
                                <h3 class="text-xl font-bold mb-4">í–‰ë™ ê´€ì°° ê·¸ë˜í”„</h3>
                                <div id="behavior-chart-container" class="h-96">
                                    <canvas id="behaviorChart"></canvas>
                                </div>
                            </div>
                        </section>
                     </div>
                </div>

            </main>
        </div>
        
        <!-- Toast Message -->
        <div id="toast" class="fixed bottom-10 right-10 bg-gray-900 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-300">
             ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!
        </div>
    </div>

    <script type="module">
        // Firebase v10 SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, getDocs, doc, getDoc, deleteDoc, updateDoc, serverTimestamp, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            // Your web app's Firebase configuration
            apiKey: "AIzaSyDCeJPDQUNi-KmJ9DhkTRIu-9t2PGZCpt0",
            authDomain: "mansungcoin-c6e06.firebaseapp.com",
            projectId: "mansungcoin-c6e06",
            storageBucket: "mansungcoin-c6e06.appspot.com",
            messagingSenderId: "704809284946",
            appId: "1:704809284946:web:54e4788586e6c68de1768b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const authView = document.getElementById('auth-view');
        const mainAppView = document.getElementById('main-app-view');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const authError = document.getElementById('auth-error');
        const userEmailSpan = document.getElementById('user-email');
        const homeUserEmailSpan = document.getElementById('home-user-email');
        const toast = document.getElementById('toast');

        // Views and Navs
        const views = {
            home: document.getElementById('home-view'),
            'my-class': document.getElementById('my-class-view'),
            iep: document.getElementById('iep-view'),
            behavior: document.getElementById('behavior-view'),
        };
        const navLinks = {
            home: document.getElementById('nav-home'),
            'my-class': document.getElementById('nav-my-class'),
            iep: document.getElementById('nav-iep'),
            behavior: document.getElementById('nav-behavior'),
        };
        
        let statsChartInstance = null;
        let behaviorChartInstance = null;

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, user => {
            if (user) {
                authView.classList.add('hidden');
                mainAppView.classList.remove('hidden');
                mainAppView.classList.add('flex');
                userEmailSpan.textContent = user.email;
                homeUserEmailSpan.textContent = user.email;
                // Handle routing based on hash
                const currentView = window.location.hash.replace('#', '') || 'home';
                switchView(currentView);
            } else {
                authView.classList.remove('hidden');
                mainAppView.classList.add('hidden');
                mainAppView.classList.remove('flex');
            }
        });

        signupBtn.addEventListener('click', () => {
            createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value)
                .catch(error => authError.textContent = error.message);
        });

        loginBtn.addEventListener('click', () => {
            signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value)
                .catch(error => authError.textContent = error.message);
        });

        googleLoginBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                authError.textContent = error.message;
            }
        });

        logoutBtn.addEventListener('click', () => signOut(auth));

        // --- NAVIGATION ---
        const switchView = (view) => {
            Object.values(views).forEach(v => v.classList.add('hidden'));
            Object.values(navLinks).forEach(l => l.classList.remove('active'));
            if (views[view]) {
                views[view].classList.remove('hidden');
                navLinks[view].classList.add('active');
                window.location.hash = view;

                // Load data for the activated view
                if (view === 'home') {
                    loadHomeData();
                } else if (view === 'my-class') {
                    loadClasses();
                } else if (view === 'behavior') {
                    initBehaviorChart();
                }

            } else { // Fallback to home
                views.home.classList.remove('hidden');
                navLinks.home.classList.add('active');
                window.location.hash = 'home';
                loadHomeData();
            }
        };

        Object.entries(navLinks).forEach(([key, link]) => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                switchView(key);
            });
        });
        document.getElementById('home-link').addEventListener('click', (e) => {
             e.preventDefault();
             switchView('home');
        });

        // --- Home View Logic ---
        async function loadHomeData() {
            const user = auth.currentUser;
            if (!user) return;

            const classesRef = collection(db, "users", user.uid, "classes");
            const iepsRef = collection(db, "users", user.uid, "ieps");
            
            const [classSnap, iepSnap] = await Promise.all([getDocs(classesRef), getDocs(iepsRef)]);
            
            const classes = [];
            classSnap.forEach(doc => classes.push({ id: doc.id, ...doc.data() }));

            // Update home class list
            const homeClassList = document.getElementById('home-class-list');
            homeClassList.innerHTML = '';
             if (classes.length === 0) {
                 homeClassList.innerHTML = `<p class="text-gray-500">ì•„ì§ ì¶”ê°€ëœ í•™ê¸‰ì´ ì—†ìŠµë‹ˆë‹¤. 'ë‚´ í•™ê¸‰ ê´€ë¦¬'ì—ì„œ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>`;
             } else {
                classes.forEach(c => {
                    const classEl = document.createElement('div');
                    classEl.className = 'p-3 border rounded-md';
                    classEl.innerHTML = `<p class="font-semibold">${c.name} (${c.year}í•™ë…„ë„)</p>`;
                    homeClassList.appendChild(classEl);
                });
            }


            // Update stats chart
            const statsData = {
                labels: ['í•™ê¸‰', 'IEP'],
                datasets: [{
                    label: 'ì—…ë¬´ ìˆ˜',
                    data: [classSnap.size, iepSnap.size],
                    backgroundColor: ['#38bdf8', '#fbbf24'], // sky-400, amber-400
                    hoverOffset: 4
                }]
            };
            updateChart('statsChart', 'statsChartInstance', 'doughnut', statsData, {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            });
        }
        
        // --- My Class View Logic ---
        const addClassBtn = document.getElementById('add-class-btn');
        const classListContainer = document.getElementById('class-list');

        async function loadClasses() {
            const user = auth.currentUser;
            if (!user) return;
            const q = query(collection(db, "users", user.uid, "classes"), orderBy("createdAt", "desc"));
            const querySnapshot = await getDocs(q);
            classListContainer.innerHTML = '';
            if (querySnapshot.empty) {
                classListContainer.innerHTML = `<p class="text-gray-500">ìƒì„±ëœ í•™ê¸‰ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                return;
            }
            querySnapshot.forEach(doc => {
                const classData = doc.data();
                const classEl = document.createElement('div');
                classEl.className = 'flex justify-between items-center p-4 border rounded-lg';
                classEl.innerHTML = `
                    <div>
                        <p class="text-lg font-bold">${classData.name}</p>
                        <p class="text-sm text-gray-500">${classData.year}í•™ë…„ë„</p>
                    </div>
                    <div>
                        <button class="delete-class-btn text-red-500 hover:text-red-700" data-id="${doc.id}">ì‚­ì œ</button>
                    </div>
                `;
                classListContainer.appendChild(classEl);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-class-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const docId = e.target.dataset.id;
                    if(confirm('ì •ë§ë¡œ ì´ í•™ê¸‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        await deleteDoc(doc(db, "users", user.uid, "classes", docId));
                        loadClasses(); // Refresh list
                    }
                });
            });
        }
        
        addClassBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) return;
            const className = prompt("ìƒˆ í•™ê¸‰ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:");
            const classYear = prompt("í•™ë…„ë„ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 2025):");

            if (className && classYear) {
                await addDoc(collection(db, "users", user.uid, "classes"), {
                    name: className,
                    year: classYear,
                    createdAt: serverTimestamp()
                });
                loadClasses(); // Refresh list
            }
        });


        // --- IEP View Logic ---
        const iepForm = document.getElementById('iep-form');
        const iepOutputContainer = document.getElementById('iep-output');
        const iepInitialMessage = document.getElementById('iep-initial-message');
        const iepLoading = document.getElementById('iep-loading');

        iepForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;

            const studentName = document.getElementById('student-name').value;
            const studentNeeds = document.getElementById('student-needs').value;

            iepInitialMessage.classList.add('hidden');
            iepOutputContainer.classList.add('hidden');
            iepLoading.classList.remove('hidden');

            // Simplified prompt for generating IEP structure
            const prompt = `
                íŠ¹ìˆ˜êµìœ¡ëŒ€ìƒí•™ìƒ '${studentName}'ì˜ ê°œë³„í™”êµìœ¡ê³„íš(IEP) ì´ˆì•ˆì„ ì‘ì„±í•´ì¤˜.
                í•™ìƒì˜ ìš”êµ¬ì‚¬í•­ ë° ê°•ì : ${studentNeeds}.
                
                ë‹¤ìŒ ëª©ì°¨ì— ë”°ë¼ êµ¬ì²´ì ì¸ ë‚´ìš©ì„ í¬í•¨í•˜ì—¬ ì‘ì„±í•´ì¤˜:
                1. í•™ìƒ ì¸ì ì‚¬í•­
                2. í˜„ì¬ í•™ìŠµ ìˆ˜í–‰ ìˆ˜ì¤€ (í•™ì—…, ì‹ ì²´, ì˜ì‚¬ì†Œí†µ, ì‚¬íšŒì„± ë“± ì˜ì—­ë³„ë¡œ ê¸°ìˆ )
                3. ì¥ê¸° êµìœ¡ ëª©í‘œ (1ë…„ ë‹¨ìœ„)
                4. ë‹¨ê¸° êµìœ¡ ëª©í‘œ (í•™ê¸° ë‹¨ìœ„, ì¥ê¸° ëª©í‘œì™€ ì—°ê³„)
                5. í‰ê°€ ê³„íš
                6. íŠ¹ìˆ˜êµìœ¡ ê´€ë ¨ ì„œë¹„ìŠ¤ (ì¹˜ë£Œì§€ì›, ë³´ì¡°ê³µí•™ê¸°ê¸° ë“±)

                ê° í•­ëª©ì€ h3 ì œëª©(###)ìœ¼ë¡œ êµ¬ë¶„í•˜ê³ , ë‚´ìš©ì€ ì¤„ ë°”ê¿ˆê³¼ ê¸€ë¨¸ë¦¬ ê¸°í˜¸ë¥¼ ì‚¬ìš©í•´ì„œ ê°€ë…ì„± ìˆê²Œ ì‘ì„±í•´ì¤˜.
            `;
            
            // This is a placeholder for the actual API call.
            // In a real implementation, you would call your backend/serverless function here.
            setTimeout(() => {
                const mockResponse = `
                    ### 1. í•™ìƒ ì¸ì ì‚¬í•­
                    - ì„±ëª…: ${studentName}
                    - í•™ë…„: ${document.getElementById('student-grade').value || 'ë¯¸ì…ë ¥'}
                    - ê³„íš ê¸°ê°„: ${document.getElementById('iep-period').value || 'ë¯¸ì…ë ¥'}

                    ### 2. í˜„ì¬ í•™ìŠµ ìˆ˜í–‰ ìˆ˜ì¤€
                    - **í•™ì—…**: ê¸°ì´ˆì ì¸ ì½ê¸° ë° ì“°ê¸° ê°€ëŠ¥. ë‘ ìë¦¬ ìˆ˜ ë§ì…ˆì— ì–´ë ¤ì›€ì„ ë³´ì„.
                    - **ì˜ì‚¬ì†Œí†µ**: ê°„ë‹¨í•œ ë¬¸ì¥ìœ¼ë¡œ ìì‹ ì˜ ì˜ì‚¬ë¥¼ í‘œí˜„í•  ìˆ˜ ìˆìœ¼ë‚˜, ë³µì¡í•œ ëŒ€í™” ì°¸ì—¬ì— ì†Œê·¹ì ì„.
                    - **ì‚¬íšŒì„±**: ë˜ë˜ì™€ ì–´ìš¸ë¦¬ê³  ì‹¶ì–´í•˜ì§€ë§Œ, ê´€ê³„ í˜•ì„± ê¸°ìˆ ì´ ë¯¸ìˆ™í•˜ì—¬ ë„ì›€ì´ í•„ìš”í•¨.

                    ### 3. ì¥ê¸° êµìœ¡ ëª©í‘œ
                    - 1) ë‘ ìë¦¬ ìˆ˜ ë§ì…ˆê³¼ ëº„ì…ˆ ë¬¸ì œë¥¼ 80% ì´ìƒì˜ ì •í™•ë„ë¡œ í•´ê²°í•  ìˆ˜ ìˆë‹¤.
                    - 2) ì„¸ ë¬¸ì¥ ì´ìƒì˜ ì—°ê²°ëœ ë¬¸ì¥ìœ¼ë¡œ ìì‹ ì˜ ê²½í—˜ì„ ì´ì•¼ê¸°í•  ìˆ˜ ìˆë‹¤.
                    - 3) ì¹œêµ¬ì˜ ë†€ì´ ì œì•ˆì— ê¸ì •ì ìœ¼ë¡œ ë°˜ì‘í•˜ê³ , 5ë¶„ ì´ìƒ ë†€ì´ë¥¼ ì§€ì†í•  ìˆ˜ ìˆë‹¤.

                    ### 4. ë‹¨ê¸° êµìœ¡ ëª©í‘œ
                    - **1í•™ê¸°**:
                      - ê°€) ë°›ì•„ì˜¬ë¦¼ì´ ì—†ëŠ” ë‘ ìë¦¬ ìˆ˜ ë§ì…ˆì„ 90% ì •í™•ë„ë¡œ í•´ê²°í•œë‹¤.
                      - ë‚˜) ê·¸ë¦¼ì„ ë³´ê³  ë‘ ë¬¸ì¥ìœ¼ë¡œ ìƒí™©ì„ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤.
                      - ë‹¤) êµì‚¬ì˜ ì§€ì› í•˜ì— ì¹œêµ¬ì—ê²Œ ë†€ì´ë¥¼ ì œì•ˆí•  ìˆ˜ ìˆë‹¤.
                    - **2í•™ê¸°**:
                      - ê°€) ë°›ì•„ë‚´ë¦¼ì´ ì—†ëŠ” ë‘ ìë¦¬ ìˆ˜ ëº„ì…ˆì„ 90% ì •í™•ë„ë¡œ í•´ê²°í•œë‹¤.
                      - ë‚˜) ì§ˆë¬¸ì— ë‘ ë¬¸ì¥ ì´ìƒìœ¼ë¡œ ëŒ€ë‹µí•  ìˆ˜ ìˆë‹¤.
                      - ë‹¤) ìŠ¤ìŠ¤ë¡œ ì¹œêµ¬ì˜ ë†€ì´ì— ì°¸ì—¬í•˜ì—¬ 5ë¶„ ì´ìƒ ìƒí˜¸ì‘ìš©í•œë‹¤.

                    ### 5. í‰ê°€ ê³„íš
                    - **ë°©ë²•**: ê´€ì°°, í¬íŠ¸í´ë¦¬ì˜¤, ìˆ˜í–‰í‰ê°€
                    - **ì‹œê¸°**: ë§¤ì›” ë§, í•™ê¸° ë§

                    ### 6. íŠ¹ìˆ˜êµìœ¡ ê´€ë ¨ ì„œë¹„ìŠ¤
                    - ì–¸ì–´ì¹˜ë£Œ: ì£¼ 2íšŒ (íšŒë‹¹ 40ë¶„)
                    - ë³´ì¡°ê³µí•™ê¸°ê¸°: í•™ìŠµìš© íƒœë¸”ë¦¿ PC ë° ì†Œë¦¬íœ ì§€ì›
                `;
                iepOutputContainer.innerHTML = mockResponse.replace(/\n/g, '<br>');
                iepLoading.classList.add('hidden');
                iepOutputContainer.classList.remove('hidden');
                
                // Save to Firestore
                 addDoc(collection(db, "users", user.uid, "ieps"), {
                    studentName: studentName,
                    content: mockResponse,
                    createdAt: serverTimestamp()
                });

            }, 2000); // Simulating network delay
        });
        
        // --- Behavior Intervention Logic ---
        const startObservationBtn = document.getElementById('start-observation-btn');
        const behaviorLoggingSection = document.getElementById('behavior-logging-section');
        const logBehaviorBtn = document.getElementById('log-behavior-btn');
        let currentObservation = null;

        startObservationBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if(!user) return;
            
            const studentName = document.getElementById('behavior-student-name').value;
            const behavior = document.getElementById('target-behavior').value;
            const type = document.querySelector('#behavior-type-buttons .active').dataset.value;
            
            if (!studentName || !behavior) {
                alert('í•™ìƒ ì´ë¦„ê³¼ ëª©í‘œ í–‰ë™ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // Check for existing observation
            const q = query(collection(db, "users", user.uid, "behaviors"), where("studentName", "==", studentName), where("behavior", "==", behavior));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                // Create new observation
                const docRef = await addDoc(collection(db, "users", user.uid, "behaviors"), {
                    studentName: studentName,
                    behavior: behavior,
                    type: type,
                    createdAt: serverTimestamp()
                });
                currentObservation = { id: docRef.id, studentName, behavior };
            } else {
                const doc = querySnapshot.docs[0];
                currentObservation = { id: doc.id, ...doc.data() };
            }
            
            document.getElementById('logging-student').textContent = studentName;
            document.getElementById('logging-behavior').textContent = behavior;
            behaviorLoggingSection.classList.remove('hidden');
            
            loadBehaviorLogs();
        });

        logBehaviorBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user || !currentObservation) return;
            
            await addDoc(collection(db, "users", user.uid, "behaviors", currentObservation.id, "logs"), {
                timestamp: serverTimestamp()
            });
            showToast(`${currentObservation.behavior} í–‰ë™ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            loadBehaviorLogs();
        });
        
        async function loadBehaviorLogs() {
            if (!currentObservation) return;
            const user = auth.currentUser;
            if(!user) return;
            
            const logsRef = collection(db, "users", user.uid, "behaviors", currentObservation.id, "logs");
            const q = query(logsRef, orderBy("timestamp", "asc"));
            const logSnapshot = await getDocs(q);
            
            const dailyCounts = {};
            logSnapshot.forEach(doc => {
                const date = doc.data().timestamp.toDate().toLocaleDateString();
                dailyCounts[date] = (dailyCounts[date] || 0) + 1;
            });
            
            const chartLabels = Object.keys(dailyCounts);
            const chartData = Object.values(dailyCounts);
            
            updateChart('behaviorChart', 'behaviorChartInstance', 'line', {
                labels: chartLabels,
                datasets: [{
                    label: `${currentObservation.behavior} ë°œìƒ ë¹ˆë„`,
                    data: chartData,
                    borderColor: '#0ea5e9',
                    backgroundColor: 'rgba(14, 165, 233, 0.1)',
                    fill: true,
                    tension: 0.1
                }]
            });
        }
        
        function initBehaviorChart() {
             updateChart('behaviorChart', 'behaviorChartInstance', 'line', {
                labels: [],
                datasets: [{ label: 'í–‰ë™ ë°œìƒ ë¹ˆë„', data: [] }]
            }, {
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
            });
        }

        // --- UTILITY FUNCTIONS ---
        function showToast(message) {
            toast.textContent = message;
            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 2000);
        }

        function updateChart(canvasId, instanceVar, type, data, options = {}) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            if (window[instanceVar]) {
                window[instanceVar].destroy();
            }

            window[instanceVar] = new Chart(ctx, { type, data, options });
        }
        
        // Initial load
        window.addEventListener('hashchange', () => {
            const currentView = window.location.hash.replace('#', '') || 'home';
            switchView(currentView);
        });

    </script>
</body>
</html>

