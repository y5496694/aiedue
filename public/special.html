<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—ì´ë‘ ìŠ¤í˜ì…œ - íŠ¹ìˆ˜êµì‚¬ ì—…ë¬´ ë³´ì¡°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Noto Sans KR', sans-serif; }
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .login-tab {
            border-bottom: 2px solid transparent;
            color: #475569;
            transition: color 0.2s, border-color 0.2s;
        }
        .login-tab.active {
            border-bottom-color: #0ea5e9;
            color: #0ea5e9;
            font-weight: 600;
        }
        .form-input {
            transition: all 0.3s;
        }
        .form-input:focus {
            border-color: #0ea5e9;
            box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.2);
            outline: none;
        }
        .btn {
            transition: background-color 0.3s, color 0.3s, opacity 0.3s;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            background-color: #0ea5e9;
            color: #ffffff;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #0284c7;
        }
        .btn-secondary {
            background-color: #e2e8f0;
            color: #1e293b;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #cbd5f5;
        }
        .content-section {
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: white;
        }
        .content-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
        }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #0ea5e9; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .nav-link { padding: 0.5rem 1rem; border-radius: 0.375rem; transition: background-color 0.2s, color 0.2s; }
        .nav-link.active { background-color: #0284c7; color: white; }
        .nav-link:not(.active):hover { background-color: #f3f4f6; }
        .tab-btn {
             transition: all 0.2s;
             border: 2px solid transparent;
        }
        .tab-btn.active {
             background-color: #0ea5e9; /* sky-500 */
             color: white;
             border-color: #0284c7; /* sky-600 */
             font-weight: 600;
        }
        .tab-btn:not(.active) {
            background-color: #f1f5f9; /* slate-100 */
            color: #475569; /* slate-600 */
        }
        .modify-target-btn {
            padding: 0.4rem 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #bae6fd;
            background-color: #f8fafc;
            color: #0369a1;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s, box-shadow 0.2s;
        }
        .modify-target-btn:hover {
            background-color: #e0f2fe;
            border-color: #7dd3fc;
        }
        .modify-target-btn.active {
            background-color: #0ea5e9;
            border-color: #0284c7;
            color: #ffffff;
            box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.2);
        }
        .manual-editing {
            outline: 2px dashed #0ea5e9;
            outline-offset: 4px;
        }
        .monthly-plan-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            font-size: 0.95rem;
        }
        .monthly-plan-table th,
        .monthly-plan-table td {
            border: 1px solid #cbd5e1;
            padding: 0.75rem;
            vertical-align: top;
        }
        .monthly-plan-table .monthly-plan-title {
            background-color: #e2e8f0;
            text-align: center;
            font-weight: 700;
            font-size: 1rem;
        }
        .monthly-plan-table .monthly-plan-section-header {
            background-color: #f1f5f9;
            text-align: center;
            font-weight: 600;
            width: 50%;
        }
        .monthly-plan-table .monthly-plan-footer {
            background-color: #dbeafe;
            text-align: center;
            font-weight: 600;
        }
        .monthly-plan-table .monthly-plan-empty {
            height: 80px;
        }
        .monthly-plan-table .data-cell {
            width: 50%;
            line-height: 1.6;
        }
        .iep-pages-wrapper {
            position: relative;
        }
        .iep-cover-actions {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            display: flex;
            gap: 0.5rem;
            z-index: 10;
        }
        .iep-cover-actions button {
            box-shadow: 0 4px 10px rgba(148, 163, 184, 0.2);
        }
        .iep-page-collection {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .iep-page {
            width: 210mm;
            min-height: 284mm;
            margin: 0 auto;
            padding: 25mm;
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .iep-page-cover {
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
        }
        .iep-cover-footer {
            margin-top: auto;
            font-weight: 500;
            align-self: flex-end;
        }
        .iep-page-inner {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .iep-page-inner table {
            width: 100%;
        }
        .iep-month-block {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .iep-month-content {
            min-height: 120px;
        }
        .iep-page + .iep-page {
            margin-top: 1.5rem;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="app">
        <!-- Auth View (Login/Signup) -->
        <div id="auth-view" class="min-h-screen flex items-center justify-center bg-gray-100">
            <div class="w-full max-w-md bg-white rounded-lg shadow-md p-8">
                <div id="login-view" class="view active">
                    <h2 class="text-2xl font-bold text-center text-sky-600 mb-6">ì—ì´ë‘ ìŠ¤í˜ì…œ ì‹œì‘í•˜ê¸°</h2>
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                            <button id="student-login-tab" class="login-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">ğŸ§‘â€ğŸ“ í•™ìƒ</button>
                            <button id="teacher-login-tab" class="login-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">ğŸ§‘â€ğŸ« êµì‚¬</button>
                        </nav>
                    </div>
                    <div id="student-login-content" class="tab-content pt-6">
                        <div class="mb-4">
                            <label for="student-code" class="block text-sm font-medium text-gray-700 mb-1">ê³ ìœ  ìˆ«ì ì½”ë“œ</label>
                            <input type="text" id="student-code" class="w-full border border-gray-300 rounded-md p-2 form-input" placeholder="ë°œê¸‰ë°›ì€ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        <p id="student-login-error" class="text-red-500 text-sm mb-4 hidden"></p>
                        <button id="student-login-btn" class="w-full py-2 rounded-md btn btn-primary font-semibold">í•™ìƒ ë¡œê·¸ì¸</button>
                    </div>
                    <div id="teacher-login-content" class="tab-content pt-6">
                        <div class="mb-4">
                            <label for="teacher-email" class="block text-sm font-medium text-gray-700 mb-1">ì´ë©”ì¼</label>
                            <input type="email" id="teacher-email" class="w-full border border-gray-300 rounded-md p-2 form-input" placeholder="example@email.com">
                        </div>
                        <div class="mb-6">
                            <label for="teacher-password" class="block text-sm font-medium text-gray-700 mb-1">ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" id="teacher-password" class="w-full border border-gray-300 rounded-md p-2 form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                        </div>
                        <p id="teacher-login-error" class="text-red-500 text-sm mb-4 hidden"></p>
                        <button id="teacher-login-btn" class="w-full py-2 rounded-md btn btn-primary font-semibold">êµì‚¬ ë¡œê·¸ì¸</button>
                        <button id="teacher-google-login-btn" class="w-full py-2 mt-2 rounded-md btn border border-gray-300 bg-white text-gray-700 font-semibold flex items-center justify-center gap-2 hover:bg-gray-50">
                            <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                            Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
                        </button>
                    </div>
                    <div class="mt-6 text-center space-y-2">
                        <button id="show-student-register-btn" class="w-full text-sm text-sky-600 hover:underline">ì²˜ìŒì´ì‹ ê°€ìš”? í•™ìƒ ë“±ë¡í•˜ê¸°</button>
                        <button id="show-teacher-register-btn" class="w-full text-sm text-sky-600 hover:underline">êµì‚¬ì´ì‹ ê°€ìš”? íšŒì›ê°€ì…í•˜ê¸°</button>
                    </div>
                </div>
                <div id="student-register-view" class="view">
                    <h2 class="text-2xl font-bold text-center text-sky-600 mb-6">ğŸ§‘â€ğŸ“ í•™ìƒ ë“±ë¡</h2>
                    <div class="mb-4">
                        <label for="student-name" class="block text-sm font-medium text-gray-700 mb-1">ì´ë¦„</label>
                        <input type="text" id="student-name" class="w-full border border-gray-300 rounded-md p-2 form-input" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <p id="student-register-error" class="text-red-500 text-sm mb-4 hidden"></p>
                    <button id="student-register-btn" class="w-full py-2 rounded-md btn btn-primary font-semibold mb-4">ë“±ë¡í•˜ê³  ì½”ë“œ ë°›ê¸°</button>
                    <button id="back-to-login-btn" class="w-full text-sm text-gray-600 hover:underline">ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
                </div>
                <div id="teacher-register-view" class="view">
                    <h2 class="text-2xl font-bold text-center text-sky-600 mb-6">ğŸ§‘â€ğŸ« êµì‚¬ íšŒì›ê°€ì…</h2>
                    <div class="mb-4">
                        <label for="teacher-register-name" class="block text-sm font-medium text-gray-700 mb-1">ì´ë¦„</label>
                        <input type="text" id="teacher-register-name" class="w-full border border-gray-300 rounded-md p-2 form-input" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <div class="mb-4">
                        <label for="teacher-register-email" class="block text-sm font-medium text-gray-700 mb-1">ì´ë©”ì¼</label>
                        <input type="email" id="teacher-register-email" class="w-full border border-gray-300 rounded-md p-2 form-input" placeholder="example@email.com">
                    </div>
                    <div class="mb-6">
                        <label for="teacher-register-password" class="block text-sm font-medium text-gray-700 mb-1">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="teacher-register-password" class="w-full border border-gray-300 rounded-md p-2 form-input" placeholder="6ìë¦¬ ì´ìƒ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <p id="teacher-register-error" class="text-red-500 text-sm mb-4 hidden"></p>
                    <button id="teacher-register-btn" class="w-full py-2 rounded-md btn btn-primary font-semibold mb-4">íšŒì›ê°€ì…</button>
                    <button id="teacher-back-to-login-btn" class="w-full text-sm text-gray-600 hover:underline">ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
                </div>
            </div>
        </div>

        <!-- Main App View -->
        <div id="main-app-view" class="hidden flex-col min-h-screen">
            <header class="bg-white shadow-md w-full sticky top-0 z-50">
                <div class="container mx-auto px-6 py-3 flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-sky-600"><a href="#home" id="home-link">ğŸ“ ì—ì´ë‘ ìŠ¤í˜ì…œ</a></h1>
                    <nav class="flex items-center gap-4">
                        <span id="user-email" class="text-sm text-gray-600"></span>
                        <a href="#home" id="nav-home" class="nav-link">í™ˆ</a>
                        <a href="#my-class" id="nav-my-class" class="nav-link">ë‚´ í•™ê¸‰ ê´€ë¦¬</a>
                        <!-- IEP navigation link; 'ê°œë³„í™”êµìœ¡ê³„íš' is commonly referred to as 'IEP'. Modify this section when updating 'iep'. -->
                        <a href="#iep" id="nav-iep" class="nav-link">ê°œë³„í™”êµìœ¡ê³„íš(IEP)</a>
                        <a href="#templates" id="nav-templates" class="nav-link">ì„œì‹ ìƒì„±</a>
                        <a href="#behavior" id="nav-behavior" class="nav-link">í–‰ë™ ì¤‘ì¬</a>
                        <button id="logout-btn" class="text-sm bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-md transition-colors">ë¡œê·¸ì•„ì›ƒ</button>
                    </nav>
                </div>
            </header>
            <main class="flex-grow container mx-auto p-6">
                <!-- Home View -->
                <div id="home-view">
                    <h2 class="text-3xl font-bold mb-6">í™ˆ</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-2">ì•ˆë…•í•˜ì„¸ìš”, <span id="home-user-email"></span> ì„ ìƒë‹˜!</h3>
                            <p class="text-gray-600 mb-4">ì—ì´ë‘ ìŠ¤í˜ì…œê³¼ í•¨ê»˜ íŠ¹ìˆ˜í•™ê¸‰ ì—…ë¬´ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬í•´ë³´ì„¸ìš”.</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-4">ì—…ë¬´ í†µê³„</h3>
                             <div id="stats-chart-container" class="h-48 flex items-center justify-center">
                                <canvas id="statsChart"></canvas>
                            </div>
                        </div>
                        <div class="md:col-span-2 lg:col-span-3 bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-4">ë‚´ í•™ê¸‰ ëª©ë¡</h3>
                            <div id="home-class-list" class="space-y-3">
                                <!-- Class list will be dynamically inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- My Class View -->
                <div id="my-class-view" class="hidden">
                    <h2 class="text-3xl font-bold mb-6">ë‚´ í•™ê¸‰ ê´€ë¦¬</h2>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <div id="class-header" class="flex justify-between items-center mb-4">
                            <h3 id="class-title" class="text-xl font-bold">ë‚´ í•™ê¸‰</h3>
                            <button id="add-class-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded">ë‚´ í•™ê¸‰ ë§Œë“¤ê¸°</button>
                        </div>
                        <div id="class-list" class="space-y-3">
                            <!-- Class items will be dynamically inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Create Class Modal -->
                <div id="create-class-modal" class="fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-50 px-4">
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-sky-700">ë‚´ í•™ê¸‰ ë§Œë“¤ê¸°</h3>
                            <button type="button" id="create-class-close-btn" class="text-2xl leading-none text-sky-500 hover:text-sky-700">&times;</button>
                        </div>
                        <p class="text-sm text-gray-600 mb-4">í•™ìƒë“¤ê³¼ í•¨ê»˜ ì‚¬ìš©í•  í•™ê¸‰ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. í•™ê¸‰ì€ í•œ ë²ˆë§Œ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        <form id="create-class-form" class="space-y-4">
                            <div>
                                <label for="create-class-name" class="block text-sm font-medium text-gray-700 mb-1">í•™ê¸‰ ì´ë¦„</label>
                                <input type="text" id="create-class-name" class="w-full border border-gray-300 rounded-md p-2 form-input" placeholder="ì˜ˆ: í•¨ê»˜ë°˜" autocomplete="off">
                            </div>
                            <div class="flex justify-end gap-2">
                                <button type="button" id="create-class-cancel-btn" class="px-4 py-2 rounded-md btn btn-secondary">ì·¨ì†Œ</button>
                                <button type="submit" id="create-class-confirm-btn" class="px-4 py-2 rounded-md btn btn-primary font-semibold">ë§Œë“¤ê¸°</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- IEP View -->
                <div id="iep-view" class="hidden">
                     <h2 class="text-3xl font-bold mb-6">ê°œë³„í™”êµìœ¡ê³„íš(IEP) ìˆ˜ë¦½</h2>
                     <div class="flex flex-col lg:flex-row gap-6">
                        <aside class="w-full lg:w-1/3 bg-white p-6 rounded-lg shadow-lg h-fit lg:sticky top-24">
                            <h3 class="text-lg font-semibold mb-4">ë‚´ í•™ê¸‰</h3>
                            <div id="iep-student-list" class="grid grid-cols-4 gap-2">
                                <!-- í•™ìƒ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. -->
                            </div>
                            <div id="iep-modify-section" class="mt-6 hidden">
                                <div id="iep-save-section" class="mb-4 hidden">
                                    <h4 class="font-semibold mb-2">ì €ì¥ í…Œì´ë¸”</h4>
                                    <div class="flex flex-wrap gap-2">
                                        <button id="save-iep-btn" class="flex-1 min-w-[140px] bg-sky-600 hover:bg-sky-700 text-white text-sm font-semibold px-3 py-2 rounded transition">ì €ì¥</button>
                                        <button id="save-pdf-btn" class="flex-1 min-w-[140px] bg-gray-500 hover:bg-gray-600 text-white text-sm font-semibold px-3 py-2 rounded transition">PDF ì €ì¥</button>
                                    </div>
                                </div>
                                <div id="iep-generation-section" class="mb-4 hidden">
                                    <h4 class="font-semibold mb-2">ìƒì„± í…Œì´ë¸”</h4>
                                    <div class="flex flex-wrap gap-2">
                                        <button id="iep-achievement-btn" class="flex-1 min-w-[180px] border border-sky-500 text-sky-600 text-sm font-medium px-3 py-2 rounded transition hover:bg-sky-50">ì„±ì·¨ ê¸°ì¤€ ì´ë™</button>
                                        <button id="generate-semester-goals-btn" class="flex-1 min-w-[180px] border border-sky-500 text-sky-600 text-sm font-medium px-3 py-2 rounded transition hover:bg-sky-50">í•™ê¸° êµìœ¡ëª©í‘œ ìƒì„±</button>
                                        <button id="generate-monthly-plan-btn" class="flex-1 min-w-[220px] border border-sky-500 text-sky-600 text-sm font-medium px-3 py-2 rounded transition hover:bg-sky-50 hidden">ì›”ë³„ êµìœ¡ëª©í‘œ/ë‚´ìš©/ë°©ë²• ìƒì„±í•˜ê¸°</button>
                                    </div>
                                </div>
                                <h4 class="font-semibold mb-2">ìˆ˜ì • í…Œì´ë¸”</h4>
                                <div class="mb-3">
                                    <div id="iep-modify-targets" class="flex flex-wrap gap-2"></div>
                                </div>
                                <div class="flex items-start gap-2">
                                    <textarea id="iep-modify-input" class="w-full border rounded-md p-2 text-sm" rows="3" placeholder="ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                                    <button id="iep-modify-btn" class="bg-sky-600 hover:bg-sky-700 text-white text-sm px-3 py-1 rounded h-9">ìˆ˜ì •</button>
                                </div>
                                <div class="mt-2">
                                    <button id="iep-manual-edit-btn" class="border border-sky-500 text-sky-600 text-sm font-medium px-3 py-1 rounded transition hover:bg-sky-50">ìˆ˜ë™ í¸ì§‘</button>
                                </div>
                            </div>
                        </aside>
                        <section class="w-full lg:w-2/3">
                            <div id="iep-output" class="bg-white p-8 rounded-lg shadow-lg overflow-x-auto">
                                <p class="text-gray-500">í•™ìƒì„ ì„ íƒí•˜ë©´ IEP ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                            </div>
                        </section>
                    </div>
                </div>

                <!-- Template Generator View -->
                <div id="templates-view" class="hidden">
                    <h2 class="text-3xl font-bold mb-6">AI ì„œì‹ ìƒì„±</h2>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-bold mb-4">ì¹´í…Œê³ ë¦¬</h3>
                        <div id="template-category-buttons" class="flex flex-wrap gap-3">
                            <button type="button" data-template-category="major-eval" class="tab-btn py-2 px-4 rounded">ì „ê³µê³¼ ì‹¬ì‚¬í‘œ</button>
                        </div>
                    </div>
                    <div id="major-eval-workspace" class="hidden mt-6">
                        <div class="flex flex-col lg:flex-row gap-6">
                            <aside class="w-full lg:w-1/3 bg-white p-6 rounded-lg shadow-lg space-y-6">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-lg font-semibold">ì „ê³µê³¼ ì‹¬ì‚¬í‘œ ëª©ë¡</h3>
                                    <button type="button" id="major-eval-add-btn" class="bg-sky-600 hover:bg-sky-700 text-white text-sm font-semibold px-3 py-2 rounded">ì¶”ê°€</button>
                                </div>
                                <div>
                                    <ul id="major-eval-list" class="space-y-2"></ul>
                                    <p id="major-eval-empty" class="text-sm text-gray-500">ì¶”ê°€ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹¬ì‚¬í‘œë¥¼ ìƒì„±í•´ë³´ì„¸ìš”.</p>
                                </div>
                                <div id="major-eval-input-section" class="hidden space-y-4">
                                    <div>
                                        <h4 class="text-base font-semibold mb-2">ì…ë ¥ í…Œì´ë¸”</h4>
                                        <table class="w-full border border-gray-200 text-sm">
                                            <tbody class="divide-y divide-gray-200">
                                                <tr>
                                                    <th scope="row" class="bg-gray-50 px-3 py-2 text-left font-medium w-28">í•™êµ ì´ë¦„</th>
                                                    <td class="px-3 py-2">
                                                        <input type="text" id="major-eval-school" class="w-full border border-gray-300 rounded-md p-2 text-sm" placeholder="ì˜ˆ: í–‰ë³µí•™êµ">
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th scope="row" class="bg-gray-50 px-3 py-2 text-left font-medium">ì˜ì—­</th>
                                                    <td class="px-3 py-2">
                                                        <input type="text" id="major-eval-domain" class="w-full border border-gray-300 rounded-md p-2 text-sm" placeholder="ì˜ˆ: í˜¸í…” ì„œë¹„ìŠ¤">
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th scope="row" class="bg-gray-50 px-3 py-2 text-left font-medium">ë¬¸í•­ ìˆ˜</th>
                                                    <td class="px-3 py-2">
                                                        <input type="number" id="major-eval-questions" class="w-full border border-gray-300 rounded-md p-2 text-sm" min="1" value="5">
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th scope="row" class="bg-gray-50 px-3 py-2 text-left font-medium">í‰ê°€ ì£¼ì œ</th>
                                                    <td class="px-3 py-2">
                                                        <input type="text" id="major-eval-topic" class="w-full border border-gray-300 rounded-md p-2 text-sm" placeholder="ì˜ˆ: ê°ì‹¤ ì •ë¦¬">
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <button type="button" id="major-eval-generate-btn" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 rounded">ìƒì„±</button>
                                </div>
                                <div id="major-eval-modify-section" class="hidden space-y-3">
                                    <h4 class="text-base font-semibold">ìˆ˜ì • í…Œì´ë¸”</h4>
                                    <p class="text-xs text-gray-500">ìˆ˜ì • ë‚´ìš©ì„ ì…ë ¥í•˜ê³  ì—”í„° ë˜ëŠ” ìˆ˜ì • ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
                                    <textarea id="major-eval-modify-input" class="w-full border border-gray-300 rounded-md p-2 text-sm" rows="4" placeholder="ì˜ˆ: 3ë²ˆ ë¬¸í•­ì„ ë‚œì´ë„ë¥¼ ë‚®ì¶”ì–´ ìˆ˜ì •í•´ì¤˜"></textarea>
                                    <button type="button" id="major-eval-modify-btn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 rounded">ìˆ˜ì •</button>
                                </div>
                            </aside>
                            <section class="flex-1">
                                <div id="major-eval-output" class="bg-white p-6 rounded-lg shadow-lg min-h-[320px] text-sm text-gray-700">
                                    <p class="text-gray-500">ì™¼ìª½ ëª©ë¡ì—ì„œ ì‹¬ì‚¬í‘œë¥¼ ì„ íƒí•˜ë©´ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>

                <!-- Behavior Intervention View -->
                <div id="behavior-view" class="hidden">
                    <h2 class="text-3xl font-bold mb-6">í–‰ë™ ì¤‘ì¬</h2>
                     <div class="flex flex-col lg:flex-row gap-6">
                        <aside class="w-full lg:w-1/3 bg-white p-6 rounded-lg shadow-lg h-fit lg:sticky top-24 space-y-6">
                            <div>
                                <h3 class="text-lg font-semibold mb-4">í•™ìƒ ë° í–‰ë™ ì„ íƒ</h3>
                                <div class="space-y-4">
                                     <div>
                                        <label for="behavior-student-name" class="block text-sm font-medium text-gray-700">í•™ìƒ ì´ë¦„</label>
                                        <input type="text" id="behavior-student-name" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="ê´€ì°°í•  í•™ìƒ ì´ë¦„">
                                    </div>
                                    <div>
                                        <label for="target-behavior" class="block text-sm font-medium text-gray-700">ëª©í‘œ í–‰ë™</label>
                                        <input type="text" id="target-behavior" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="ì˜ˆ: ë°”ë¥´ê²Œ ì•‰ì•„ ìˆê¸°">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">í–‰ë™ ìœ í˜•</label>
                                        <div id="behavior-type-buttons" class="grid grid-cols-2 gap-2">
                                            <button type="button" data-value="increase" class="tab-btn py-2 px-2 rounded text-sm active">ì¦ê°€ì‹œí‚¬ í–‰ë™</button>
                                            <button type="button" data-value="decrease" class="tab-btn py-2 px-2 rounded text-sm">ê°ì†Œì‹œí‚¬ í–‰ë™</button>
                                        </div>
                                    </div>
                                    <button id="start-observation-btn" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg">ê´€ì°° ì‹œì‘</button>
                                </div>
                            </div>
                            <div id="behavior-logging-section" class="hidden">
                                <h3 class="text-lg font-semibold mb-4">í–‰ë™ ê¸°ë¡</h3>
                                <p class="text-sm text-gray-600 mb-1">í•™ìƒ: <span id="logging-student" class="font-bold"></span></p>
                                <p class="text-sm text-gray-600 mb-4">ëª©í‘œ í–‰ë™: <span id="logging-behavior" class="font-bold"></span></p>
                                <button id="log-behavior-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-4 rounded-lg text-lg">í–‰ë™ ë°œìƒ (+1)</button>
                            </div>
                        </aside>
                        <section class="w-full lg:w-2/3">
                            <div class="content-section">
                                <h3 class="text-xl font-bold mb-4">í–‰ë™ ê´€ì°° ê·¸ë˜í”„</h3>
                                <div id="behavior-chart-container" class="h-96">
                                    <canvas id="behaviorChart"></canvas>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>

                <!-- Achievement Criteria View -->
                <div id="achievement-view" class="hidden">
                    <h2 class="text-3xl font-bold mb-6">ì„±ì·¨ê¸°ì¤€ ê¸°ë¡</h2>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <button id="back-to-class-btn" class="text-sm text-sky-600 hover:underline mb-4">&larr; ë‚´ í•™ê¸‰ìœ¼ë¡œ</button>
                        <h3 id="achievement-student" class="text-xl font-bold mb-4"></h3>
                        <div class="mb-4 space-y-4">
                            <div>
                                <span class="font-semibold mr-2">í•™êµê¸‰</span>
                                <div id="level-buttons" class="inline-flex gap-2">
                                    <button data-value="elementary" class="tab-btn py-1 px-3 rounded active">ì´ˆë“±í•™êµ</button>
                                    <button data-value="middle" class="tab-btn py-1 px-3 rounded">ì¤‘í•™êµ</button>
                                    <button data-value="high" class="tab-btn py-1 px-3 rounded">ê³ ë“±í•™êµ</button>
                                </div>
                            </div>
                            <div>
                                <span class="font-semibold mr-2">êµê³¼</span>
                                <div id="subject-buttons" class="inline-flex gap-2">
                                    <button data-value="korean" class="tab-btn py-1 px-3 rounded active">êµ­ì–´</button>
                                    <button data-value="math" class="tab-btn py-1 px-3 rounded">ìˆ˜í•™</button>
                                </div>
                            </div>
                            <div>
                                <span class="font-semibold mr-2">í•™ë…„(êµ°)</span>
                                <div id="grade-buttons" class="inline-flex gap-2"></div>
                            </div>
                        </div>
                        <button id="save-achievement-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded mb-4">ì €ì¥</button>
                        <div id="achievement-table" class="overflow-x-auto"></div>
                    </div>
                </div>

            </main>
        </div>
        
        <!-- Major Evaluation Modal -->
        <div id="major-eval-modal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                <h3 class="text-xl font-semibold mb-4">ì „ê³µê³¼ ì‹¬ì‚¬í‘œ ì¶”ê°€</h3>
                <label for="major-eval-modal-title" class="block text-sm font-medium text-gray-700 mb-2">ì œëª©</label>
                <input type="text" id="major-eval-modal-title" class="w-full border border-gray-300 rounded-md p-2 text-sm" placeholder="ì˜ˆ: 2024í•™ë…„ë„ í˜¸í…”ì¡°ë¦¬ ì „í˜•">
                <div class="mt-6 flex justify-end gap-2">
                    <button type="button" id="major-eval-modal-cancel" class="px-4 py-2 rounded border border-gray-300 text-sm font-medium text-gray-600 hover:bg-gray-50">ì·¨ì†Œ</button>
                    <button type="button" id="major-eval-modal-confirm" class="px-4 py-2 rounded bg-sky-600 hover:bg-sky-700 text-white text-sm font-semibold">ì™„ë£Œ</button>
                </div>
            </div>
        </div>

        <!-- Toast Message -->
        <div id="toast" class="fixed bottom-10 right-10 bg-gray-900 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-300">
             ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!
        </div>
    </div>

    <script type="module">
        // Firebase v10 SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, getDocs, doc, getDoc, setDoc, updateDoc, deleteDoc, serverTimestamp, where, orderBy, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            // Your web app's Firebase configuration
            apiKey: "AIzaSyDCeJPDQUNi-KmJ9DhkTRIu-9t2PGZCpt0",
            authDomain: "mansungcoin-c6e06.firebaseapp.com",
            projectId: "mansungcoin-c6e06",
            storageBucket: "mansungcoin-c6e06.appspot.com",
            messagingSenderId: "704809284946",
            appId: "1:704809284946:web:54e4788586e6c68de1768b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const authView = document.getElementById('auth-view');
        const mainAppView = document.getElementById('main-app-view');
        const loginView = document.getElementById('login-view');
        const studentRegisterView = document.getElementById('student-register-view');
        const teacherRegisterView = document.getElementById('teacher-register-view');
        const studentLoginTab = document.getElementById('student-login-tab');
        const teacherLoginTab = document.getElementById('teacher-login-tab');
        const studentLoginContent = document.getElementById('student-login-content');
        const teacherLoginContent = document.getElementById('teacher-login-content');
        const studentCodeInput = document.getElementById('student-code');
        const teacherEmailInput = document.getElementById('teacher-email');
        const teacherPasswordInput = document.getElementById('teacher-password');
        const studentLoginError = document.getElementById('student-login-error');
        const teacherLoginError = document.getElementById('teacher-login-error');
        const studentNameInput = document.getElementById('student-name');
        const studentRegisterError = document.getElementById('student-register-error');
        const teacherRegisterNameInput = document.getElementById('teacher-register-name');
        const teacherRegisterEmailInput = document.getElementById('teacher-register-email');
        const teacherRegisterPasswordInput = document.getElementById('teacher-register-password');
        const teacherRegisterError = document.getElementById('teacher-register-error');
        const studentLoginBtn = document.getElementById('student-login-btn');
        const teacherLoginBtn = document.getElementById('teacher-login-btn');
        const teacherGoogleLoginBtn = document.getElementById('teacher-google-login-btn');
        const showStudentRegisterBtn = document.getElementById('show-student-register-btn');
        const showTeacherRegisterBtn = document.getElementById('show-teacher-register-btn');
        const backToLoginBtn = document.getElementById('back-to-login-btn');
        const teacherBackToLoginBtn = document.getElementById('teacher-back-to-login-btn');
        const studentRegisterBtn = document.getElementById('student-register-btn');
        const teacherRegisterBtn = document.getElementById('teacher-register-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailSpan = document.getElementById('user-email');
        const homeUserEmailSpan = document.getElementById('home-user-email');
        const toast = document.getElementById('toast');
        const levelButtons = document.getElementById('level-buttons');
        const subjectButtons = document.getElementById('subject-buttons');
        const gradeButtons = document.getElementById('grade-buttons');
        const saveAchievementBtn = document.getElementById('save-achievement-btn');
        const achievementTableContainer = document.getElementById('achievement-table');
        const backToClassBtn = document.getElementById('back-to-class-btn');
        const templateCategoryButtons = document.getElementById('template-category-buttons');
        const majorEvalWorkspace = document.getElementById('major-eval-workspace');
        const majorEvalAddBtn = document.getElementById('major-eval-add-btn');
        const majorEvalList = document.getElementById('major-eval-list');
        const majorEvalEmpty = document.getElementById('major-eval-empty');
        const majorEvalInputSection = document.getElementById('major-eval-input-section');
        const majorEvalModifySection = document.getElementById('major-eval-modify-section');
        const majorEvalOutput = document.getElementById('major-eval-output');
        const majorEvalSchoolInput = document.getElementById('major-eval-school');
        const majorEvalDomainInput = document.getElementById('major-eval-domain');
        const majorEvalQuestionsInput = document.getElementById('major-eval-questions');
        const majorEvalTopicInput = document.getElementById('major-eval-topic');
        const majorEvalGenerateBtn = document.getElementById('major-eval-generate-btn');
        const majorEvalModifyInput = document.getElementById('major-eval-modify-input');
        const majorEvalModifyBtn = document.getElementById('major-eval-modify-btn');
        const majorEvalModal = document.getElementById('major-eval-modal');
        const majorEvalModalTitle = document.getElementById('major-eval-modal-title');
        const majorEvalModalCancel = document.getElementById('major-eval-modal-cancel');
        const majorEvalModalConfirm = document.getElementById('major-eval-modal-confirm');
        let currentAchievementStudent = '';
        let currentAchievementData = {};

        // Views and Navs
        const views = {
            home: document.getElementById('home-view'),
            'my-class': document.getElementById('my-class-view'),
            iep: document.getElementById('iep-view'),
            templates: document.getElementById('templates-view'),
            behavior: document.getElementById('behavior-view'),
            achievement: document.getElementById('achievement-view'),
        };
        const navLinks = {
            home: document.getElementById('nav-home'),
            'my-class': document.getElementById('nav-my-class'),
            iep: document.getElementById('nav-iep'),
            templates: document.getElementById('nav-templates'),
            behavior: document.getElementById('nav-behavior'),
        };
        
        let statsChartInstance = null;
        let behaviorChartInstance = null;
        let isLoadingHomeData = false;
        let majorEvalEntries = [];
        let activeMajorEvalId = '';
        let activeTemplateCategory = '';
        let isMajorEvalGenerating = false;
        let isMajorEvalModifying = false;

        // --- AUTHENTICATION ---
        const authSections = {
            login: loginView,
            studentRegister: studentRegisterView,
            teacherRegister: teacherRegisterView,
        };

        const showAuthView = (view) => {
            Object.values(authSections).forEach(section => section && section.classList.remove('active'));
            if (authSections[view]) {
                authSections[view].classList.add('active');
            }
        };

        const showError = (element, message) => {
            if (!element) return;
            if (message) {
                element.textContent = message;
                element.classList.remove('hidden');
            } else {
                element.textContent = '';
                element.classList.add('hidden');
            }
        };

        const clearAuthMessages = () => {
            showError(studentLoginError, '');
            showError(teacherLoginError, '');
            showError(studentRegisterError, '');
            showError(teacherRegisterError, '');
        };

        const switchLoginTab = (tabName) => {
            [studentLoginTab, teacherLoginTab].forEach(tab => tab && tab.classList.remove('active'));
            [studentLoginContent, teacherLoginContent].forEach(content => content && content.classList.remove('active'));

            if (tabName === 'teacher') {
                if (teacherLoginTab) teacherLoginTab.classList.add('active');
                if (teacherLoginContent) teacherLoginContent.classList.add('active');
            } else {
                if (studentLoginTab) studentLoginTab.classList.add('active');
                if (studentLoginContent) studentLoginContent.classList.add('active');
            }

            clearAuthMessages();
        };

        if (studentLoginTab) {
            studentLoginTab.addEventListener('click', () => switchLoginTab('student'));
        }
        if (teacherLoginTab) {
            teacherLoginTab.addEventListener('click', () => switchLoginTab('teacher'));
        }

        if (showStudentRegisterBtn) {
            showStudentRegisterBtn.addEventListener('click', () => {
                clearAuthMessages();
                showAuthView('studentRegister');
            });
        }

        if (showTeacherRegisterBtn) {
            showTeacherRegisterBtn.addEventListener('click', () => {
                clearAuthMessages();
                showAuthView('teacherRegister');
            });
        }

        if (backToLoginBtn) {
            backToLoginBtn.addEventListener('click', () => {
                showAuthView('login');
                switchLoginTab('student');
            });
        }

        if (teacherBackToLoginBtn) {
            teacherBackToLoginBtn.addEventListener('click', () => {
                showAuthView('login');
                switchLoginTab('teacher');
            });
        }

        if (studentRegisterBtn) {
            studentRegisterBtn.addEventListener('click', async () => {
                clearAuthMessages();
                const name = studentNameInput.value.trim();
                if (!name) {
                    showError(studentRegisterError, 'ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                try {
                    const counterRef = doc(db, 'metadata', 'counters');
                    const newCode = await runTransaction(db, async (transaction) => {
                        const counterDoc = await transaction.get(counterRef);
                        let nextCode = 1;
                        if (counterDoc.exists() && counterDoc.data().lastUserCode) {
                            nextCode = counterDoc.data().lastUserCode + 1;
                        }
                        transaction.set(counterRef, { lastUserCode: nextCode }, { merge: true });
                        return nextCode;
                    });

                    const email = `${newCode}@abc.com`;
                    const password = `${newCode}qwerty`;

                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);

                    await setDoc(doc(db, 'users', userCredential.user.uid), {
                        uid: userCredential.user.uid,
                        name: name,
                        email: email,
                        userCode: newCode,
                        role: 'student',
                        coins: 0,
                        balance: 0,
                        portfolio: {},
                        aeduExperience: 0,
                        aeduLevel: 1,
                        warningTokens: 0,
                        createdAt: serverTimestamp()
                    });

                    await addDoc(collection(db, 'signupLog'), {
                        name: name,
                        userCode: newCode,
                        role: 'student',
                        signedUpAt: serverTimestamp()
                    });

                    studentNameInput.value = '';
                    alert(`í™˜ì˜í•©ë‹ˆë‹¤, ${name} í•™ìƒ!\në‹¹ì‹ ì˜ ê³ ìœ  ì½”ë“œëŠ” ${newCode} ì…ë‹ˆë‹¤.\nì´ ì½”ë“œë¥¼ ê¼­ ê¸°ì–µí•˜ê³  ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.`);
                    showAuthView('login');
                    switchLoginTab('student');
                } catch (error) {
                    console.error('Student registration error:', error);
                    if (error.code === 'auth/email-already-in-use') {
                        showError(studentRegisterError, 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ê³„ì • ì •ë³´ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì½”ë“œë¥¼ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    } else {
                        showError(studentRegisterError, 'í•™ìƒ ë“±ë¡ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                }
            });
        }

        if (teacherRegisterBtn) {
            teacherRegisterBtn.addEventListener('click', async () => {
                clearAuthMessages();
                const name = teacherRegisterNameInput.value.trim();
                const email = teacherRegisterEmailInput.value.trim();
                const password = teacherRegisterPasswordInput.value;

                if (!name || !email || !password) {
                    showError(teacherRegisterError, 'ì´ë¦„, ì´ë©”ì¼, ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);

                    await setDoc(doc(db, 'users', userCredential.user.uid), {
                        uid: userCredential.user.uid,
                        name,
                        email,
                        role: 'teacher',
                        userCode: null,
                        coins: 0,
                        balance: 0,
                        portfolio: {},
                        aeduTokens: 0,
                        aeduExperience: 0,
                        aeduLevel: 1,
                        warningTokens: 0,
                        createdAt: serverTimestamp()
                    }, { merge: true });

                    await addDoc(collection(db, 'signupLog'), {
                        name,
                        email,
                        role: 'teacher',
                        signedUpAt: serverTimestamp()
                    });

                    teacherRegisterNameInput.value = '';
                    teacherRegisterEmailInput.value = '';
                    teacherRegisterPasswordInput.value = '';
                    alert(`í™˜ì˜í•©ë‹ˆë‹¤, ${name} ì„ ìƒë‹˜!\nì´ì œ êµì‚¬ìš© ê¸°ëŠ¥ì„ ì´ìš©í•´ë³´ì„¸ìš”.`);
                    showAuthView('login');
                    switchLoginTab('teacher');
                } catch (error) {
                    console.error('Teacher registration error:', error);
                    if (error.code === 'auth/email-already-in-use') {
                        showError(teacherRegisterError, 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë©”ì¼ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
                    } else if (error.code === 'auth/invalid-email') {
                        showError(teacherRegisterError, 'ìœ íš¨í•œ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    } else if (error.code === 'auth/weak-password') {
                        showError(teacherRegisterError, 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                    } else {
                        showError(teacherRegisterError, 'êµì‚¬ íšŒì›ê°€ì… ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    }
                }
            });
        }

        if (studentLoginBtn) {
            studentLoginBtn.addEventListener('click', async () => {
                clearAuthMessages();
                const codeInput = studentCodeInput.value.trim();

                const normalizedCode = codeInput.replace(/[\uFF10-\uFF19]/g, (m) => String.fromCharCode(m.charCodeAt(0) - 0xFEE0));

                if (!normalizedCode || !/^\d+$/.test(normalizedCode)) {
                    showError(studentLoginError, 'ìœ íš¨í•œ ìˆ«ì ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                const codeAsInt = parseInt(normalizedCode, 10);
                const email = `${codeAsInt}@abc.com`;
                const password = `${codeAsInt}qwerty`;

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error('Student login error:', error);
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                        showError(studentLoginError, 'ê³ ìœ  ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•Šê±°ë‚˜ í•´ë‹¹ í•™ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    } else if (error.code === 'permission-denied') {
                        showError(studentLoginError, 'ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì—¬ Firestore ë³´ì•ˆ ê·œì¹™ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    } else {
                        showError(studentLoginError, `ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                    }
                }
            });
        }

        if (teacherLoginBtn) {
            teacherLoginBtn.addEventListener('click', async () => {
                clearAuthMessages();
                const email = teacherEmailInput.value.trim();
                const password = teacherPasswordInput.value;
                if (!email || !password) {
                    showError(teacherLoginError, 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    showError(teacherLoginError, 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            });
        }

        if (teacherGoogleLoginBtn) {
            teacherGoogleLoginBtn.addEventListener('click', async () => {
                clearAuthMessages();
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    showError(teacherLoginError, 'Google ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            });
        }

        logoutBtn.addEventListener('click', () => signOut(auth));

        showAuthView('login');
        switchLoginTab('student');

        onAuthStateChanged(auth, user => {
            if (user) {
                authView.classList.add('hidden');
                mainAppView.classList.remove('hidden');
                mainAppView.classList.add('flex');
                userEmailSpan.textContent = user.email;
                homeUserEmailSpan.textContent = user.email;
                const currentView = window.location.hash.replace('#', '') || 'home';
                switchView(currentView);
            } else {
                authView.classList.remove('hidden');
                mainAppView.classList.add('hidden');
                mainAppView.classList.remove('flex');
                showAuthView('login');
                switchLoginTab('student');
                clearAuthMessages();
                if (studentCodeInput) studentCodeInput.value = '';
                if (teacherEmailInput) teacherEmailInput.value = '';
                if (teacherPasswordInput) teacherPasswordInput.value = '';
            }
        });

        // --- NAVIGATION ---
        const switchView = (view) => {
            Object.values(views).forEach(v => v.classList.add('hidden'));
            Object.values(navLinks).forEach(l => l.classList.remove('active'));
            if (views[view]) {
                views[view].classList.remove('hidden');
                if (navLinks[view]) navLinks[view].classList.add('active');
                window.location.hash = view;

                // Load data for the activated view
                if (view === 'home') {
                    loadHomeData();
                } else if (view === 'my-class') {
                    loadClasses();
                } else if (view === 'iep') {
                    loadIepStudents();
                    if (iepOutputContainer) {
                        iepOutputContainer.innerHTML = '<p class="text-gray-500">í•™ìƒì„ ì„ íƒí•˜ë©´ IEP ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>';
                    }
                } else if (view === 'templates') {
                    activateTemplateCategory('major-eval');
                } else if (view === 'behavior') {
                    initBehaviorChart();
                }

            } else { // Fallback to home
                views.home.classList.remove('hidden');
                if (navLinks.home) navLinks.home.classList.add('active');
                window.location.hash = 'home';
                loadHomeData();
            }
        };

        Object.entries(navLinks).forEach(([key, link]) => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                switchView(key);
            });
        });
        document.getElementById('home-link').addEventListener('click', (e) => {
             e.preventDefault();
             switchView('home');
        });

        backToClassBtn.addEventListener('click', () => switchView('my-class'));

        levelButtons.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', () => {
                setActiveButton(levelButtons, btn.dataset.value);
                updateGradeButtons();
                loadAchievementTable();
            });
        });

        subjectButtons.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', () => {
                setActiveButton(subjectButtons, btn.dataset.value);
                loadAchievementTable();
            });
        });

        saveAchievementBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) return;
            const table = achievementTableContainer.querySelector('table');
            if (!table) return;
            const rows = table.querySelectorAll('tbody tr');
            const states = Array.from(rows).map(tr => {
                // Firestore does not support nested arrays, so store each row as an object
                const rowObj = {};
                for (let i = 1; i < tr.cells.length; i++) {
                    const btn = tr.cells[i].querySelector('button');
                    rowObj[i - 1] = parseInt(btn.dataset.state || '0');
                }
                return rowObj;
            });
            const key = `${getActiveValue(levelButtons)}_${getActiveValue(subjectButtons)}`;
            currentAchievementData[key] = states;
            try {
                await setDoc(doc(db, 'users', user.uid, 'achievements', currentAchievementStudent), {
                    data: currentAchievementData
                }, { merge: true });
                showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
            } catch (e) {
                console.error('Error saving achievement data', e);
            }
        });

        // --- Home View Logic ---
        async function loadHomeData() {
            const user = auth.currentUser;
            if (!user || isLoadingHomeData) return;
            isLoadingHomeData = true;
            try {
         const classRef = doc(db, "classes", user.uid);
         const iepsRef = collection(db, "users", user.uid, "ieps");

         const [classSnap, iepSnap] = await Promise.all([getDoc(classRef), getDocs(iepsRef)]);

         // Update home class list
         const homeClassList = document.getElementById('home-class-list');
         homeClassList.innerHTML = '';
         if (!classSnap.exists()) {
             homeClassList.innerHTML = `<p class="text-gray-500">ì•„ì§ ì¶”ê°€ëœ í•™ê¸‰ì´ ì—†ìŠµë‹ˆë‹¤. 'ë‚´ í•™ê¸‰ ê´€ë¦¬'ì—ì„œ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>`;
         } else {
             const data = classSnap.data();
             const studentIds = data.students || [];
             if (studentIds.length === 0) {
                 homeClassList.innerHTML = '<p class="text-gray-500">í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
             } else {
                 for (const sid of studentIds) {
                     try {
                         const sd = await getDoc(doc(db, 'users', sid));
                         if (sd.exists()) {
                             const s = sd.data();
                            const studentEl = document.createElement('div');
                            studentEl.className = 'p-3 border rounded-md flex justify-between items-center';
                            studentEl.innerHTML = `<span>${s.name || sid}</span><button class="achievement-btn text-sky-600 hover:underline text-sm">ì„±ì·¨ ê¸°ì¤€</button>`;
                            studentEl.querySelector('.achievement-btn').addEventListener('click', () => {
                                openAchievementView(s.name || sid);
                            });
                            homeClassList.appendChild(studentEl);
                        }
                     } catch (err) {
                         console.error(err);
                     }
                 }
             }
         }


            // Update stats chart
         const statsData = {
             labels: ['í•™ê¸‰', 'IEP'],
             datasets: [{
                 label: 'ì—…ë¬´ ìˆ˜',
                 data: [classSnap.exists() ? 1 : 0, iepSnap.size],
                 backgroundColor: ['#38bdf8', '#fbbf24'], // sky-400, amber-400
                 hoverOffset: 4
             }]
         };
            updateChart('statsChart', 'statsChartInstance', 'doughnut', statsData, {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            });
        } catch (error) {
            console.error(error);
        } finally {
            isLoadingHomeData = false;
        }

        }

        // --- My Class View Logic ---
        const addClassBtn = document.getElementById('add-class-btn');
        const classListContainer = document.getElementById('class-list');
        const classTitle = document.getElementById('class-title');
        const createClassModal = document.getElementById('create-class-modal');
        const createClassForm = document.getElementById('create-class-form');
        const createClassNameInput = document.getElementById('create-class-name');
        const createClassCancelBtn = document.getElementById('create-class-cancel-btn');
        const createClassCloseBtn = document.getElementById('create-class-close-btn');
        const createClassConfirmBtn = document.getElementById('create-class-confirm-btn');
        let isLoadingClasses = false;
        let isCreatingClass = false;

        function setClassCreateButtonState(canCreate) {
            if (!addClassBtn) return;
            addClassBtn.disabled = !canCreate;
            addClassBtn.classList.toggle('opacity-50', !canCreate);
            addClassBtn.classList.toggle('cursor-not-allowed', !canCreate);
        }

        function openCreateClassModal() {
            if (!auth.currentUser || !createClassModal || addClassBtn?.disabled) return;
            if (createClassNameInput) {
                createClassNameInput.value = '';
            }
            createClassModal.classList.remove('hidden');
            createClassModal.classList.add('flex');
            setTimeout(() => createClassNameInput?.focus(), 50);
        }

        function closeCreateClassModal() {
            if (!createClassModal) return;
            createClassModal.classList.add('hidden');
            createClassModal.classList.remove('flex');
            if (createClassNameInput) {
                createClassNameInput.value = '';
            }
        }

        async function handleCreateClassSubmit(event) {
            event.preventDefault();
            if (isCreatingClass) return;
            const user = auth.currentUser;
            if (!user) return;
            const className = (createClassNameInput?.value || '').trim();
            if (!className) {
                showToast('í•™ê¸‰ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                createClassNameInput?.focus();
                return;
            }

            isCreatingClass = true;
            const originalText = createClassConfirmBtn?.textContent || '';
            if (createClassConfirmBtn) {
                createClassConfirmBtn.disabled = true;
                createClassConfirmBtn.textContent = 'ë§Œë“œëŠ” ì¤‘...';
            }

            try {
                const classRef = doc(db, 'classes', user.uid);
                const classSnap = await getDoc(classRef);
                if (classSnap.exists()) {
                    showToast('ì´ë¯¸ í•™ê¸‰ì´ ì¡´ì¬í•©ë‹ˆë‹¤.');
                    closeCreateClassModal();
                    return;
                }
                await setDoc(classRef, { name: className, students: [] });
                showToast('ìƒˆ í•™ê¸‰ì´ ë§Œë“¤ì–´ì¡ŒìŠµë‹ˆë‹¤.');
                closeCreateClassModal();
                await loadClasses();
                await loadHomeData();
            } catch (error) {
                console.error('Failed to create class:', error);
                showToast('í•™ê¸‰ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            } finally {
                isCreatingClass = false;
                if (createClassConfirmBtn) {
                    createClassConfirmBtn.disabled = false;
                    createClassConfirmBtn.textContent = originalText || 'ë§Œë“¤ê¸°';
                }
            }
        }

        async function loadClasses() {
            const user = auth.currentUser;
            if (!user || isLoadingClasses) return;
            isLoadingClasses = true;
            if (classListContainer) {
                classListContainer.innerHTML = '<p class="text-gray-500">ë¡œë”© ì¤‘...</p>';
            }
            const classRef = doc(db, 'classes', user.uid);
            try {
                const classSnap = await getDoc(classRef);
                if (classListContainer) {
                    classListContainer.innerHTML = '';
                }
                if (!classSnap.exists()) {
                    classTitle.textContent = 'ë‚´ í•™ê¸‰';
                    if (classListContainer) {
                        classListContainer.innerHTML = `<p class="text-gray-500">ìƒì„±ëœ í•™ê¸‰ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                    }
                    setClassCreateButtonState(true);
                    return;
                }
                const data = classSnap.data();
                classTitle.textContent = data.name || 'ë‚´ í•™ê¸‰';
                setClassCreateButtonState(false);
                const studentIds = data.students || [];
                if (!studentIds.length) {
                    if (classListContainer) {
                        classListContainer.innerHTML = '<p class="text-gray-500">í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    }
                } else {
                    for (const sid of studentIds) {
                        try {
                            const sd = await getDoc(doc(db, 'users', sid));
                            if (sd.exists() && classListContainer) {
                                const s = sd.data();
                                const studentEl = document.createElement('div');
                                studentEl.className = 'p-3 border rounded-md flex justify-between items-center';
                                studentEl.innerHTML = `<span>${s.name || sid}</span><button class="achievement-btn text-sky-600 hover:underline text-sm">ì„±ì·¨ ê¸°ì¤€</button>`;
                                studentEl.querySelector('.achievement-btn').addEventListener('click', () => {
                                    openAchievementView(s.name || sid);
                                });
                                classListContainer.appendChild(studentEl);
                            }
                        } catch (err) {
                            console.error(err);
                        }
                    }
                }
            } catch (error) {
                if (classListContainer) {
                    classListContainer.innerHTML = '<p class="text-red-500">í•™ê¸‰ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
                }
                setClassCreateButtonState(true);
            } finally {
                isLoadingClasses = false;
            }
        }

        if (addClassBtn) {
            addClassBtn.addEventListener('click', openCreateClassModal);
        }
        createClassCancelBtn?.addEventListener('click', closeCreateClassModal);
        createClassCloseBtn?.addEventListener('click', closeCreateClassModal);
        createClassModal?.addEventListener('click', (event) => {
            if (event.target === createClassModal) {
                closeCreateClassModal();
            }
        });
        createClassForm?.addEventListener('submit', handleCreateClassSubmit);

        // --- Template Generator Logic ---
        function activateTemplateCategory(category) {
            if (!templateCategoryButtons) return;
            activeTemplateCategory = category;
            const buttons = templateCategoryButtons.querySelectorAll('button[data-template-category]');
            buttons.forEach(btn => {
                const isActive = btn.dataset.templateCategory === category;
                btn.classList.toggle('active', isActive);
            });
            if (!majorEvalWorkspace) return;
            if (category === 'major-eval') {
                majorEvalWorkspace.classList.remove('hidden');
                renderMajorEvalList();
                updateMajorEvalWorkspace();
            } else {
                majorEvalWorkspace.classList.add('hidden');
            }
        }

        function getActiveMajorEvalEntry() {
            return majorEvalEntries.find(entry => entry.id === activeMajorEvalId) || null;
        }

        function renderMajorEvalList() {
            if (!majorEvalList) return;
            majorEvalList.innerHTML = '';
            if (!Array.isArray(majorEvalEntries)) {
                majorEvalEntries = [];
            }
            if (!majorEvalEntries.length) {
                activeMajorEvalId = '';
                if (majorEvalEmpty) majorEvalEmpty.classList.remove('hidden');
                return;
            }

            if (majorEvalEmpty) majorEvalEmpty.classList.add('hidden');

            majorEvalEntries.forEach(entry => {
                const li = document.createElement('li');
                const button = document.createElement('button');
                button.type = 'button';
                button.dataset.entryId = entry.id;
                button.className = `w-full text-left px-3 py-2 rounded border transition ${entry.id === activeMajorEvalId ? 'border-sky-500 bg-sky-50 text-sky-700' : 'border-gray-200 hover:border-sky-400 hover:bg-sky-50'}`;
                const statusBadge = entry.aiData && entry.aiData.length ? '<span class="text-xs font-medium text-emerald-600">ì™„ë£Œ</span>' : '';
                button.innerHTML = `
                    <div class="flex items-center justify-between gap-2">
                        <span class="truncate">${escapeHtml(entry.title)}</span>
                        ${statusBadge}
                    </div>
                `;
                li.appendChild(button);
                majorEvalList.appendChild(li);
            });

            if (!activeMajorEvalId && majorEvalEntries.length) {
                activeMajorEvalId = majorEvalEntries[0].id;
            }
        }

        function updateMajorEvalWorkspace() {
            if (!majorEvalWorkspace) return;
            if (!majorEvalEntries.length) {
                majorEvalInputSection?.classList.add('hidden');
                majorEvalModifySection?.classList.add('hidden');
                renderMajorEvalOutput(null);
                return;
            }

            let entry = getActiveMajorEvalEntry();
            if (!entry) {
                entry = majorEvalEntries[0];
                activeMajorEvalId = entry.id;
            }

            if (!entry.details) {
                entry.details = { schoolName: '', domain: '', numQuestions: 5, evaluationTopic: '' };
            }

            populateMajorEvalInputs(entry);

            if (entry.aiData && entry.aiData.length) {
                majorEvalInputSection?.classList.add('hidden');
                majorEvalModifySection?.classList.remove('hidden');
                if (majorEvalModifyInput) majorEvalModifyInput.value = '';
            } else {
                majorEvalInputSection?.classList.remove('hidden');
                majorEvalModifySection?.classList.add('hidden');
            }

            renderMajorEvalOutput(entry);
        }

        function populateMajorEvalInputs(entry) {
            if (!entry || !entry.details) return;
            if (majorEvalSchoolInput) majorEvalSchoolInput.value = entry.details.schoolName || '';
            if (majorEvalDomainInput) majorEvalDomainInput.value = entry.details.domain || '';
            if (majorEvalQuestionsInput) majorEvalQuestionsInput.value = entry.details.numQuestions || 5;
            if (majorEvalTopicInput) majorEvalTopicInput.value = entry.details.evaluationTopic || '';
        }

        function createMajorEvalEntry(title) {
            const newEntry = {
                id: `major-eval-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
                title: title.trim() || 'ìƒˆ ì‹¬ì‚¬í‘œ',
                details: { schoolName: '', domain: '', numQuestions: 5, evaluationTopic: '' },
                aiData: []
            };
            majorEvalEntries = [newEntry, ...majorEvalEntries];
            activeMajorEvalId = newEntry.id;
            renderMajorEvalList();
            updateMajorEvalWorkspace();
        }

        function showMajorEvalModal() {
            if (!majorEvalModal) return;
            majorEvalModal.classList.remove('hidden');
            majorEvalModal.classList.add('flex');
            majorEvalModalTitle.value = '';
            setTimeout(() => majorEvalModalTitle.focus(), 50);
        }

        function hideMajorEvalModal() {
            if (!majorEvalModal) return;
            majorEvalModal.classList.add('hidden');
            majorEvalModal.classList.remove('flex');
            majorEvalModalTitle.value = '';
        }

        function renderMajorEvalOutput(entry) {
            if (!majorEvalOutput) return;
            if (!entry) {
                majorEvalOutput.innerHTML = '<p class="text-gray-500">ì™¼ìª½ ëª©ë¡ì—ì„œ ì‹¬ì‚¬í‘œë¥¼ ì„ íƒí•˜ë©´ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>';
                return;
            }

            const details = entry.details || {};
            const items = Array.isArray(entry.aiData) ? entry.aiData : [];

            if (!items.length) {
                majorEvalOutput.innerHTML = '<p class="text-gray-500">ì…ë ¥ ì •ë³´ë¥¼ ì‘ì„±í•œ ë’¤ ìƒì„± ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹¬ì‚¬í‘œë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”.</p>';
                return;
            }

            const normalizedItems = normalizeMajorEvalData(items, details.numQuestions || items.length);
            if (!normalizedItems.length) {
                majorEvalOutput.innerHTML = '<p class="text-red-500">AIê°€ ê²°ê³¼ë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>';
                return;
            }

            const currentYear = new Date().getFullYear();
            const schoolName = details.schoolName || '[í•™êµ ì´ë¦„]';
            const domain = details.domain || 'ì˜ì—­';
            const evaluationTopic = details.evaluationTopic || 'í‰ê°€ ì£¼ì œ';

            const evaluationRows = normalizedItems.map((item, index) => {
                const domainCell = index === 0 ? `<td rowspan="${normalizedItems.length}" class="border px-2 py-2 align-middle font-medium">${escapeHtml(domain)}</td>` : '';
                return `
                    <tr>
                        ${domainCell}
                        <td class="border px-2 py-2">${index + 1}</td>
                        <td class="border px-2 py-2 text-left">${formatCellText(item.content)}</td>
                        <td class="border px-2 py-2">2</td>
                        <td class="border px-2 py-2 text-left">${formatCellText(item.materials || 'í•„ìš” ì¤€ë¹„ë¬¼ ì—†ìŒ')}</td>
                    </tr>
                `;
            }).join('');

            const recordRows = normalizedItems.map((item, index) => {
                const domainCell = index === 0 ? `<td rowspan="${normalizedItems.length}" class="border px-2 py-2 align-middle font-medium">${escapeHtml(domain)}</td>` : '';
                return `
                    <tr>
                        ${domainCell}
                        <td class="border px-2 py-2">${index + 1}</td>
                        <td class="border px-2 py-2 text-left">${formatCellText(item.content)}</td>
                        <td class="border px-2 py-2"></td>
                    </tr>
                `;
            }).join('');

            majorEvalOutput.innerHTML = `
                <div class="space-y-6">
                    <div class="text-center space-y-1">
                        <p class="text-sm text-gray-600">${currentYear}í•™ë…„ë„ ${escapeHtml(schoolName)} ì „ê³µê³¼ ì…í•™ ì „í˜•</p>
                        <h3 class="text-xl font-bold text-gray-800">ì§ì—…ëŠ¥ë ¥í‰ê°€ (${escapeHtml(evaluationTopic)} ì‹¬ì‚¬í‘œ)</h3>
                    </div>
                    <div class="space-y-3">
                        <h4 class="font-semibold text-lg text-gray-800">1í˜ì´ì§€ Â· ì§ì—…ëŠ¥ë ¥í‰ê°€ ì‹¬ì‚¬í‘œ</h4>
                        <div class="text-sm text-gray-600">
                            <p>â—‹ í‰ê°€ ê¸°ì¤€: 100% ìˆ˜í–‰(2ì ), ëª»í•¨(0ì )</p>
                            <p>â—‹ ì œí•œ ì‹œê°„: ë¬¸í•­ë‹¹ 30ì´ˆ / â—‹ ì¤€ë¹„ë¬¼: ì´ˆì‹œê³„</p>
                        </div>
                        <table class="w-full border border-gray-300 text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="border px-2 py-2 w-32">ì˜ì—­</th>
                                    <th class="border px-2 py-2 w-16">ë¬¸í•­</th>
                                    <th class="border px-2 py-2">ë‚´ìš©</th>
                                    <th class="border px-2 py-2 w-16">ë°°ì </th>
                                    <th class="border px-2 py-2 w-32">ìë£Œ(ìˆ˜)</th>
                                </tr>
                            </thead>
                            <tbody>${evaluationRows}</tbody>
                        </table>
                    </div>
                    <div class="space-y-3">
                        <h4 class="font-semibold text-lg text-gray-800">2í˜ì´ì§€ Â· ì§ì—…ëŠ¥ë ¥í‰ê°€ ê¸°ë¡ì§€</h4>
                        <table class="w-full border border-gray-300 text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="border px-2 py-2 w-32">ì˜ì—­</th>
                                    <th class="border px-2 py-2 w-16">ë¬¸í•­</th>
                                    <th class="border px-2 py-2">ë‚´ìš©</th>
                                    <th class="border px-2 py-2 w-24">ì·¨ë“ì ìˆ˜</th>
                                </tr>
                            </thead>
                            <tbody>${recordRows}</tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="3" class="border px-2 py-2 text-right">í•©ê³„</th>
                                    <td class="border px-2 py-2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            `;
        }

        function normalizeMajorEvalData(raw, count) {
            let items = [];
            if (Array.isArray(raw)) {
                items = raw;
            } else if (Array.isArray(raw?.items)) {
                items = raw.items;
            } else if (Array.isArray(raw?.data)) {
                items = raw.data;
            }

            if (!items.length) {
                return [];
            }

            const total = Math.max(1, count || items.length);
            const normalized = [];

            for (let i = 0; i < total; i++) {
                const source = items[i] || {};
                const content = typeof source.content === 'string' ? source.content.trim() : '';
                const materials = typeof source.materials === 'string' ? source.materials.trim() : '';
                normalized.push({
                    content: content || 'ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”.',
                    materials: materials || 'í•„ìš” ì¤€ë¹„ë¬¼ ì—†ìŒ'
                });
            }

            return normalized;
        }

        if (templateCategoryButtons) {
            templateCategoryButtons.addEventListener('click', (event) => {
                const button = event.target.closest('button[data-template-category]');
                if (!button) return;
                activateTemplateCategory(button.dataset.templateCategory);
            });
        }

        if (majorEvalAddBtn) {
            majorEvalAddBtn.addEventListener('click', () => {
                showMajorEvalModal();
            });
        }

        if (majorEvalModalCancel) {
            majorEvalModalCancel.addEventListener('click', () => {
                hideMajorEvalModal();
            });
        }

        if (majorEvalModal) {
            majorEvalModal.addEventListener('click', (event) => {
                if (event.target === majorEvalModal) {
                    hideMajorEvalModal();
                }
            });
        }

        if (majorEvalModalConfirm) {
            majorEvalModalConfirm.addEventListener('click', () => {
                const title = majorEvalModalTitle.value.trim();
                if (!title) {
                    alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                createMajorEvalEntry(title);
                hideMajorEvalModal();
            });
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && majorEvalModal && !majorEvalModal.classList.contains('hidden')) {
                hideMajorEvalModal();
            }
        });

        if (majorEvalList) {
            majorEvalList.addEventListener('click', (event) => {
                const button = event.target.closest('button[data-entry-id]');
                if (!button) return;
                activeMajorEvalId = button.dataset.entryId;
                renderMajorEvalList();
                updateMajorEvalWorkspace();
            });
        }

        const majorEvalInputs = [
            [majorEvalSchoolInput, 'schoolName'],
            [majorEvalDomainInput, 'domain'],
            [majorEvalQuestionsInput, 'numQuestions'],
            [majorEvalTopicInput, 'evaluationTopic']
        ];

        majorEvalInputs.forEach(([input, key]) => {
            if (!input) return;
            input.addEventListener('input', () => {
                const entry = getActiveMajorEvalEntry();
                if (!entry) return;
                if (!entry.details) entry.details = { schoolName: '', domain: '', numQuestions: 5, evaluationTopic: '' };
                if (key === 'numQuestions') {
                    let value = parseInt(input.value, 10);
                    if (!Number.isFinite(value) || value < 1) {
                        value = 1;
                    }
                    entry.details[key] = value;
                    input.value = value;
                } else {
                    entry.details[key] = input.value;
                }
            });
        });

        if (majorEvalGenerateBtn) {
            majorEvalGenerateBtn.addEventListener('click', async () => {
                const entry = getActiveMajorEvalEntry();
                if (!entry || isMajorEvalGenerating) return;

                const schoolName = (majorEvalSchoolInput?.value || '').trim();
                const domain = (majorEvalDomainInput?.value || '').trim();
                const evaluationTopic = (majorEvalTopicInput?.value || '').trim();
                let numQuestions = parseInt(majorEvalQuestionsInput?.value || '0', 10);
                if (!Number.isFinite(numQuestions) || numQuestions < 1) {
                    numQuestions = 1;
                }

                if (!domain || !evaluationTopic) {
                    alert('ì˜ì—­ê³¼ í‰ê°€ ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                entry.details = {
                    schoolName,
                    domain,
                    evaluationTopic,
                    numQuestions
                };

                const prompt = `ë„ˆëŠ” íŠ¹ìˆ˜í•™êµ ì „ê³µê³¼ ì…í•™ ì „í˜• ì‹¬ì‚¬í‘œë¥¼ ë§Œë“œëŠ” ì „ë¬¸ê°€ì•¼. ì•„ë˜ ì •ë³´ë¥¼ ì°¸ê³ í•˜ì—¬ ì§ì—…ëŠ¥ë ¥í‰ê°€ ì‹¬ì‚¬í‘œ ë¬¸í•­ì„ JSON ë°°ì—´ë¡œ ì‘ì„±í•´ì¤˜.

í•™êµ ì´ë¦„: ${schoolName || '[í•™êµ ì´ë¦„]'}
ì˜ì—­: ${domain}
í‰ê°€ ì£¼ì œ: ${evaluationTopic}
ë¬¸í•­ ìˆ˜: ${numQuestions}

ìš”êµ¬ì‚¬í•­:
1. JSON ë°°ì—´ì˜ ê¸¸ì´ëŠ” ë°˜ë“œì‹œ ${numQuestions}ê°œì—¬ì•¼ í•´.
2. ê° ìš”ì†ŒëŠ” {"content":"ì§€ì‹œë¬¸", "materials":"ì¤€ë¹„ë¬¼ ëª©ë¡"} í˜•ì‹ì´ì–´ì•¼ í•˜ë©° ë‹¤ë¥¸ ì†ì„±ì€ í¬í•¨í•˜ì§€ ë§ˆ.
3. contentëŠ” í•™ìƒì—ê²Œ ëª…í™•íˆ ì§€ì‹œí•˜ëŠ” ë¬¸ì¥ìœ¼ë¡œ ì‘ì„±í•˜ê³  ë°˜ë“œì‹œ '~í•˜ì‹œì˜¤.'ë¡œ ëë‚´.
4. materialsëŠ” ê³¼ì œ ìˆ˜í–‰ì— í•„ìš”í•œ ì¤€ë¹„ë¬¼ì„ ì‰¼í‘œë¡œ êµ¬ë¶„ëœ í•œ ì¤„ ë¬¸ìì—´ë¡œ ì‘ì„±í•´. ì¤€ë¹„ë¬¼ì´ ì—†ìœ¼ë©´ 'í•„ìš” ì¤€ë¹„ë¬¼ ì—†ìŒ'ì´ë¼ê³  ì ì–´.
5. ì„¤ëª…ì´ë‚˜ ì£¼ì„ ì—†ì´ JSON ë°°ì—´ë§Œ ë°˜í™˜í•´.`;

                const originalText = majorEvalGenerateBtn.textContent;
                majorEvalGenerateBtn.textContent = 'ìƒì„± ì¤‘...';
                majorEvalGenerateBtn.disabled = true;
                isMajorEvalGenerating = true;

                try {
                    const result = await callGemini(prompt, true);
                    const normalized = normalizeMajorEvalData(result, numQuestions);
                    if (!normalized.length) {
                        throw new Error('empty');
                    }
                    entry.aiData = normalized;
                    renderMajorEvalList();
                    updateMajorEvalWorkspace();
                    showToast('ì‹¬ì‚¬í‘œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } catch (error) {
                    console.error('Failed to generate major evaluation sheet', error);
                    alert('ì‹¬ì‚¬í‘œë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                } finally {
                    isMajorEvalGenerating = false;
                    majorEvalGenerateBtn.disabled = false;
                    majorEvalGenerateBtn.textContent = originalText;
                }
            });
        }

        if (majorEvalModifyBtn) {
            majorEvalModifyBtn.addEventListener('click', async () => {
                const entry = getActiveMajorEvalEntry();
                if (!entry || !entry.aiData?.length || isMajorEvalModifying) return;

                const instruction = (majorEvalModifyInput?.value || '').trim();
                if (!instruction) {
                    alert('ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                const prompt = `ë„ˆëŠ” íŠ¹ìˆ˜í•™êµ ì „ê³µê³¼ ì§ì—…ëŠ¥ë ¥í‰ê°€ ì‹¬ì‚¬í‘œë¥¼ ë‹¤ë“¬ëŠ” ì „ë¬¸ê°€ì•¼. ì•„ë˜ JSON ë°ì´í„°ë¥¼ ì‚¬ìš©ìì˜ ìš”ì²­ì— ë§ê²Œ ìˆ˜ì •í•´ì¤˜.

í˜„ì¬ ë°ì´í„°:
${JSON.stringify(entry.aiData, null, 2)}

ì‚¬ìš©ì ìš”ì²­: ${instruction}

ì¡°ê±´:
1. ë°°ì—´ ê¸¸ì´ëŠ” ${entry.details?.numQuestions || entry.aiData.length}ê°œë¡œ ìœ ì§€í•´.
2. ê° ìš”ì†ŒëŠ” {"content":"ì§€ì‹œë¬¸", "materials":"ì¤€ë¹„ë¬¼"} í˜•ì‹ì„ ë”°ë¥´ê³  ë‹¤ë¥¸ ì†ì„±ì€ ì¶”ê°€í•˜ì§€ ë§ˆ.
3. contentëŠ” '~í•˜ì‹œì˜¤.'ë¡œ ëë‚˜ëŠ” ì§€ì‹œë¬¸ í˜•íƒœë¡œ ì‘ì„±í•˜ê³ , materialsëŠ” ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ì¤€ë¹„ë¬¼ ëª©ë¡ì„ ì œê³µí•´. ì¤€ë¹„ë¬¼ì´ ì—†ë‹¤ë©´ 'í•„ìš” ì¤€ë¹„ë¬¼ ì—†ìŒ'ì´ë¼ê³  ì‘ì„±í•´.
4. ì„¤ëª… ì—†ì´ JSON ë°°ì—´ë§Œ ë°˜í™˜í•´.`;

                const originalText = majorEvalModifyBtn.textContent;
                majorEvalModifyBtn.textContent = 'ìˆ˜ì • ì¤‘...';
                majorEvalModifyBtn.disabled = true;
                isMajorEvalModifying = true;

                try {
                    const result = await callGemini(prompt, true);
                    const normalized = normalizeMajorEvalData(result, entry.details?.numQuestions || entry.aiData.length);
                    if (!normalized.length) {
                        throw new Error('empty');
                    }
                    entry.aiData = normalized;
                    renderMajorEvalList();
                    renderMajorEvalOutput(entry);
                    if (majorEvalModifyInput) majorEvalModifyInput.value = '';
                    showToast('ìˆ˜ì •ëœ ë‚´ìš©ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } catch (error) {
                    console.error('Failed to modify major evaluation sheet', error);
                    alert('ì¶œë ¥ì„ ìˆ˜ì •í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                } finally {
                    isMajorEvalModifying = false;
                    majorEvalModifyBtn.disabled = false;
                    majorEvalModifyBtn.textContent = originalText;
                }
            });
        }

        if (majorEvalModifyInput) {
            majorEvalModifyInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    majorEvalModifyBtn?.click();
                }
            });
        }
        const achievementTables = {
            elementary: {
                korean: `| **í•™ë…„(êµ°)** | **ë“£ê¸°â‹…ë§í•˜ê¸°** | **ì½ê¸°** | **ì“°ê¸°** | **ë¬¸ë²•** | **ë¬¸í•™** | **ë§¤ì²´** |
|---|---|---|---|---|---|---|
| 1-2 | [2êµ­01-01] ì¤‘ìš”í•œ ë‚´ìš©ì´ë‚˜ ì¼ì´ ì¼ì–´ë‚œ ìˆœì„œë¥¼ ê³ ë ¤í•˜ë©° ë“£ê³  ë§í•œë‹¤. | [2êµ­02-01] ê¸€ì, ë‹¨ì–´, ë¬¸ì¥, ì§§ì€ ê¸€ì„ ì •í™•í•˜ê²Œ ì†Œë¦¬ ë‚´ì–´ ì½ëŠ”ë‹¤. | [2êµ­03-01] ê¸€ìì™€ ë‹¨ì–´ë¥¼ ë°”ë¥´ê²Œ ì“´ë‹¤. | [2êµ­04-01] í•œê¸€ ìëª¨ì˜ ì´ë¦„ê³¼ ì†Œë¦¿ê°’ì„ ì•Œê³  ì •í™•í•˜ê²Œ ë°œìŒí•˜ê³  ì“´ë‹¤. | [2êµ­05-01] ë§ë†€ì´, ë‚±ë§ ë“±ì„ í†µí•´ ë§ì˜ ì¬ë¯¸ì™€ ì¦ê±°ì›€ì„ ëŠë‚€ë‹¤. | [2êµ­06-01] ì¼ìƒì˜ ë‹¤ì–‘í•œ ë§¤ì²´ì™€ ë§¤ì²´ ìë£Œì— í¥ë¯¸ì™€ ê´€ì‹¬ì„ ê°€ì§„ë‹¤. |
| 1-2 | [2êµ­01-02] ë°”ë¥´ê³  ê³ ìš´ ë§ë¡œ ì„œë¡œì˜ ê°ì •ì„ ë‚˜ëˆ„ë©° ë“£ê³  ë§í•œë‹¤. | [2êµ­02-02] ì˜ë¯¸ê°€ ì˜ ë“œëŸ¬ë‚˜ë„ë¡ ë¬¸ì¥ê³¼ ì§§ì€ ê¸€ì„ ì•Œë§ê²Œ ë„ì–´ ì½ëŠ”ë‹¤. | [2êµ­03-02] ì“°ê¸°ì— í¥ë¯¸ë¥¼ ê°€ì§€ë©° ìì‹ ì˜ ìƒê°ì´ë‚˜ ëŠë‚Œì„ ë¬¸ì¥ìœ¼ë¡œ í‘œí˜„í•œë‹¤. | [2êµ­04-02] ì†Œë¦¬ì™€ í‘œê¸°ê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìŒì„ ì•Œê³  ë‹¨ì–´ë¥¼ ë°”ë¥´ê²Œ ì½ê³  ì“´ë‹¤. | [2êµ­05-02] ì‘í’ˆì„ ë“£ê±°ë‚˜ ì½ìœ¼ë©´ì„œ ëŠë¼ê±°ë‚˜ ìƒê°í•œ ì ì„ ë§í•œë‹¤. | [2êµ­06-02] ì¼ìƒì˜ ê²½í—˜ê³¼ ìƒê°ì„ ê¸€ê³¼ ê·¸ë¦¼ìœ¼ë¡œ í‘œí˜„í•œë‹¤. |
| 1-2 | [2êµ­01-03] ìƒëŒ€ì˜ ë§ì„ ì§‘ì¤‘í•˜ì—¬ ë“£ê³  ë§ì°¨ë¡€ë¥¼ ì§€í‚¤ë©° ëŒ€í™”í•œë‹¤. | [2êµ­02-03] ê¸€ì„ ì½ê³  ì¤‘ì‹¬ ë‚´ìš©ì„ í™•ì¸í•œë‹¤. | [2êµ­03-03] ì£¼ë³€ ì†Œì¬ì— ëŒ€í•´ ì†Œê°œí•˜ëŠ” ê¸€ì„ ì“´ë‹¤. | [2êµ­04-03] ë¬¸ì¥ê³¼ ë¬¸ì¥ ë¶€í˜¸ë¥¼ ì•Œë§ê²Œ ì“°ê³  í•œê¸€ì— í˜¸ê¸°ì‹¬ì„ ê°€ì§„ë‹¤. | [2êµ­05-03] ì‘í’ˆ ì† ì¸ë¬¼ì˜ ëª¨ìŠµ, í–‰ë™, ë§ˆìŒì„ ìƒìƒí•˜ì—¬ ì‹œ, ë…¸ë˜, ì´ì•¼ê¸°, ê·¸ë¦¼ ë“±ìœ¼ë¡œ í‘œí˜„í•œë‹¤. | |
| 1-2 | [2êµ­01-04] ìì‹ ì˜ ê²½í—˜ì´ë‚˜ ìƒê°ì„ ë°”ë¥´ê²Œ ìì„¸íˆ ë°œí‘œí•œë‹¤. | [2êµ­02-04] ì¸ë¬¼ì˜ ë§ˆìŒì´ë‚˜ ìƒê°ì„ ì§ì‘í•˜ê³  ì´ë¥¼ ìì‹ ê³¼ ë¹„êµí•˜ë©° ê¸€ì„ ì½ëŠ”ë‹¤. | [2êµ­03-04] ê²ªì€ ì¼ì„ í‘œí˜„í•˜ëŠ” ê¸€ì„ ììœ ë¡­ê²Œ ì“°ê³ , ì“´ ê¸€ì„ í•¨ê»˜ ì½ê³  ìƒê°ì´ë‚˜ ëŠë‚Œì„ ë‚˜ëˆˆë‹¤. | | [2êµ­05-04] ì‹œë‚˜ ë…¸ë˜, ì´ì•¼ê¸°ì— í¥ë¯¸ë¥¼ ê°€ì§„ë‹¤. | |
| 1-2 | [2êµ­01-05] ë“£ê¸°ì™€ ë§í•˜ê¸°ì— ê´€ì‹¬ê³¼ í¥ë¯¸ë¥¼ ê°€ì§„ë‹¤. | [2êµ­02-05] ì½ê¸°ì— í¥ë¯¸ë¥¼ ê°€ì§€ê³  ì¦ê²¨ ì½ëŠ” íƒœë„ë¥¼ ì§€ë‹Œë‹¤. | | | | |
| 3-4 | [4êµ­01-01] ì¤‘ìš”í•œ ë‚´ìš©ê³¼ ì£¼ì œë¥¼ íŒŒì•…í•˜ë©° ë“£ê³  ê·¸ ë‚´ìš©ì„ ìš”ì•½í•œë‹¤. | [4êµ­02-01] ê¸€ì˜ ì˜ë¯¸ë¥¼ íŒŒì•…í•˜ë©° ìœ ì°½í•˜ê²Œ ê¸€ì„ ì½ëŠ”ë‹¤. | [4êµ­03-01] ì¤‘ì‹¬ ë¬¸ì¥ê³¼ ë’·ë°›ì¹¨ ë¬¸ì¥ì„ ê°–ì¶”ì–´ ë¬¸ë‹¨ì„ ì“°ê³ , ë¬¸ì¥ê³¼ ë¬¸ë‹¨ì„ ì¤‘ì‹¬ìœ¼ë¡œ ê³ ì³ ì“´ë‹¤. | [4êµ­04-01] ë‹¨ì–´ì™€ ë‹¨ì–´ ê°„ì˜ ì˜ë¯¸ ê´€ê³„ë¥¼ íŒŒì•…í•œë‹¤. | [4êµ­05-01] ì¸ë¬¼ê³¼ ì´ì•¼ê¸°ì˜ íë¦„ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì‘í’ˆì„ ê°ìƒí•œë‹¤. | [4êµ­06-01] ì¸í„°ë„·ì—ì„œ í•™ìŠµì— í•„ìš”í•œ ë‹¤ì–‘í•œ ìë£Œë¥¼ íƒìƒ‰í•˜ê³  ëª©ì ì— ë§ê²Œ ìë£Œë¥¼ ì„ íƒí•œë‹¤. |
| 3-4 | [4êµ­01-02] ì›ì¸ê³¼ ê²°ê³¼ì˜ ê´€ê³„ë¥¼ ê³ ë ¤í•˜ì—¬ ë‚´ìš©ì„ ì˜ˆì¸¡í•˜ë©° ë“£ê³  ë§í•œë‹¤. | [4êµ­02-02] ë¬¸ë‹¨ê³¼ ê¸€ì—ì„œ ì¤‘ì‹¬ ìƒê°ì„ íŒŒì•…í•˜ê³  ë‚´ìš©ì„ ê°„ì¶”ë¦°ë‹¤. | [4êµ­03-02] ì ˆì°¨ì™€ ê²°ê³¼ê°€ ë“œëŸ¬ë‚˜ê²Œ ì •í™•í•œ í‘œí˜„ìœ¼ë¡œ ë³´ê³ í•˜ëŠ” ê¸€ì„ ì“´ë‹¤. | [4êµ­04-02] ë‹¨ì–´ë¥¼ ë¶„ë¥˜í•˜ê³  êµ­ì–´ì‚¬ì „ì„ í™œìš©í•˜ì—¬ ëŠ¥ë™ì ì¸ êµ­ì–´ í™œë™ì„ í•œë‹¤. | [4êµ­05-02] ìì‹ ì˜ ê²½í—˜ì„ ë°”íƒ•ìœ¼ë¡œ ì‘í’ˆ ì† ì„¸ê³„ì™€ í˜„ì‹¤ ì„¸ê³„ë¥¼ ë¹„êµí•˜ì—¬ ì‘í’ˆì„ ê°ìƒí•œë‹¤. | [4êµ­06-02] ë§¤ì²´ë¥¼ í™œìš©í•˜ì—¬ ê°„ë‹¨í•œ ë°œí‘œ ìë£Œë¥¼ ë§Œë“ ë‹¤. |
| 3-4 | [4êµ­01-03] ìƒí™©ì— ì ì ˆí•œ ì¤€ì–¸ì–´â‹…ë¹„ì–¸ì–´ì  í‘œí˜„ì„ í™œìš©í•˜ì—¬ ë“£ê³  ë§í•œë‹¤. | [4êµ­02-03] ì§ˆë¬¸ì„ í™œìš©í•˜ì—¬ ê¸€ì„ ì˜ˆì¸¡í•˜ë©° ì½ê³  ìì‹ ì˜ ì½ê¸° ê³¼ì •ì„ ì ê²€í•œë‹¤. | [4êµ­03-03] ëŒ€ìƒì— ëŒ€í•œ ìì‹ ì˜ ì˜ê²¬ê³¼ ê·¸ë ‡ê²Œ ìƒê°í•œ ì´ìœ ê°€ ë“œëŸ¬ë‚˜ê²Œ ê¸€ì„ ì“´ë‹¤. | [4êµ­04-03] ê¸°ë³¸ì ì¸ ë¬¸ì¥ì˜ ì§œì„ì„ ì´í•´í•˜ê³  ì ì ˆí•˜ê²Œ ì‚¬ìš©í•œë‹¤. | [4êµ­05-03] ì‘í’ˆì„ ë“£ê±°ë‚˜ ì½ê³  ë§ˆìŒì— ë“œëŠ” ì‘í’ˆì„ ì†Œê°œí•œë‹¤. | [4êµ­06-03] ë§¤ì²´ ì†Œí†µ ìœ¤ë¦¬ë¥¼ ê³ ë ¤í•˜ì—¬ ë§¤ì²´ ìë£Œë¥¼ í™œìš©í•˜ê³  ê³µìœ í•œë‹¤. |
| 3-4 | [4êµ­01-04] ìƒí™©ê³¼ ìƒëŒ€ì˜ ì…ì¥ì„ ì´í•´í•˜ê³  ì˜ˆì˜ë¥¼ ì§€í‚¤ë©° ëŒ€í™”í•œë‹¤. | [4êµ­02-04] ê¸€ì— ë‚˜íƒ€ë‚œ ì‚¬ì‹¤ê³¼ ì˜ê²¬ì„ êµ¬ë¶„í•˜ê³  í•„ìì™€ ìì‹ ì˜ ì˜ê²¬ì„ ë¹„êµí•œë‹¤. | [4êµ­03-04] ëª©ì ê³¼ ì£¼ì œë¥¼ ê³ ë ¤í•˜ì—¬ ë…ìì—ê²Œ ë§ˆìŒì„ ì „í•˜ëŠ” ê¸€ì„ ì“´ë‹¤. | [4êµ­04-04] ê¸€ê³¼ ë‹´í™”ì— ì“°ì¸ ë†’ì„ í‘œí˜„ê³¼ ì§€ì‹œâ‹…ì ‘ì† í‘œí˜„ì„ ì´í•´í•˜ê³  ìƒí™©ì— ë§ê²Œ í‘œí˜„í•œë‹¤. | [4êµ­05-04] ê°ê°ì  í‘œí˜„ì— ìœ ì˜í•˜ì—¬ ì‘í’ˆì„ ê°ìƒí•˜ê³ , ê°ê°ì  í‘œí˜„ì„ í™œìš©í•˜ì—¬ ìì‹ ì˜ ìƒê°ì´ë‚˜ ê°ì •ì„ í‘œí˜„í•œë‹¤. | |
| 3-4 | [4êµ­01-05] ëª©ì ê³¼ ì£¼ì œì— ì•Œë§ê²Œ ìë£Œë¥¼ ì •ë¦¬í•˜ì—¬ ìì‹ ê° ìˆê²Œ ë°œí‘œí•œë‹¤. | [4êµ­02-05] ê¸€ì´ë‚˜ ìë£Œì˜ ì¶œì²˜ê°€ ë¯¿ì„ ë§Œí•œì§€ íŒë‹¨í•œë‹¤. | [4êµ­03-05] ìì‹ ì˜ ì“°ê¸° ê³¼ì •ì„ ì ê²€í•˜ë©° ì“°ê¸°ì— ìì‹ ê°ì„ ê°–ëŠ”ë‹¤. | [4êµ­04-05] ì–¸ì–´ê°€ ì˜ì‚¬ì†Œí†µê³¼ ê´€ê³„ í˜•ì„±ì˜ ìˆ˜ë‹¨ì„ì„ ì´í•´í•˜ê³  êµ­ì–´ë¥¼ ì†Œì¤‘íˆ ì—¬ê¸°ëŠ” íƒœë„ë¥¼ ì§€ë‹Œë‹¤. | [4êµ­05-05] ì¬ë¯¸ë‚˜ ê°ë™ì„ ëŠë¼ë©° ì‘í’ˆì„ ì¦ê²¨ ê°ìƒí•˜ëŠ” íƒœë„ë¥¼ ì§€ë‹Œë‹¤. | |
| 3-4 | [4êµ­01-06] ì£¼ì œì— ì ì ˆí•œ ì˜ê²¬ê³¼ ì´ìœ ë¥¼ ì œì‹œí•˜ê³  ì„œë¡œì˜ ìƒê°ì„ êµí™˜í•˜ë©° í† ì˜í•œë‹¤. | [4êµ­02-06] ë°”ëŒì§í•œ ì½ê¸° ìŠµê´€ì„ í˜•ì„±í•˜ê³  ì½ê¸°ì— ëŒ€í•œ ìì‹ ê°ì„ ê¸°ë¥¸ë‹¤. | | | | |
| 5-6 | [6êµ­01-01] ëŒ€í™”ì—ì„œ ìƒëµëœ ë‚´ìš©ì„ ì¶”ë¡ í•˜ë©° ë“£ëŠ”ë‹¤. | [6êµ­02-01] ê¸€ì˜ êµ¬ì¡°ë¥¼ ê³ ë ¤í•˜ë©° ì£¼ì œë‚˜ ì£¼ì¥ì„ íŒŒì•…í•˜ê³  ê¸€ ë‚´ìš©ì„ ìš”ì•½í•œë‹¤. | [6êµ­03-01] ì•Œë§ì€ ë‚´ìš©ì„ ì„ ì •í•˜ì—¬ ëŒ€ìƒì˜ íŠ¹ì„±ì´ ë‚˜íƒ€ë‚˜ê²Œ ì„¤ëª…í•˜ëŠ” ê¸€ì„ ì“´ë‹¤. | [6êµ­04-01] ìŒì„± ì–¸ì–´ ë° ë¬¸ì ì–¸ì–´ì˜ íŠ¹ì„±ì„ ì´í•´í•˜ê³  ë‹¤ì–‘í•œ ë§¤ì²´ ìë£Œì—ì„œ í‘œí˜„ íš¨ê³¼ë¥¼ í‰ê°€í•œë‹¤. | [6êµ­05-01] ì‘ê°€ì˜ ì˜ë„ë¥¼ ìƒê°í•˜ë©° ì‘í’ˆì„ ì½ëŠ”ë‹¤. | [6êµ­06-01] ì •ë³´ ê²€ìƒ‰ ë„êµ¬ë¥¼ í™œìš©í•˜ì—¬ ìì‹ ì˜ ëª©ì ì— ë§ëŠ” ë§¤ì²´ ìë£Œë¥¼ ì°¾ëŠ”ë‹¤. |
| 5-6 | [6êµ­01-02] ì£¼ì¥ì„ íŒŒì•…í•˜ê³  ì´ìœ ë‚˜ ê·¼ê±°ê°€ íƒ€ë‹¹í•œì§€ í‰ê°€í•˜ë©° ë“£ëŠ”ë‹¤. | [6êµ­02-02] ê¸€ì—ì„œ ìƒëµëœ ë‚´ìš©ì´ë‚˜ í•¨ì¶•ëœ í‘œí˜„ì„ ë¬¸ë§¥ì„ ê³ ë ¤í•˜ì—¬ ì¶”ë¡ í•œë‹¤. | [6êµ­03-02] ì ì ˆí•œ ê·¼ê±°ë¥¼ ì‚¬ìš©í•˜ê³  ì¸ìš©ì˜ ì¶œì²˜ë¥¼ ë°íˆë©° ì£¼ì¥í•˜ëŠ” ê¸€ì„ ì“´ë‹¤. | [6êµ­04-02] í‘œì¤€ì–´ì™€ ë°©ì–¸ì˜ ê¸°ëŠ¥ì„ íŒŒì•…í•˜ê³  ì–¸ì–´ ê³µë™ì²´ì™€ êµ­ì–´ìƒí™œê³¼ì˜ ê´€ê³„ë¥¼ ì´í•´í•œë‹¤. | [6êµ­05-02] ë¹„ìœ ì  í‘œí˜„ì˜ íš¨ê³¼ì— ìœ ì˜í•˜ì—¬ ì‘í’ˆì„ ê°ìƒí•œë‹¤. | [6êµ­06-02] ë‰´ìŠ¤ ë° ê°ì¢… ì •ë³´ ë§¤ì²´ ìë£Œì˜ ì‹ ë¢°ì„±ì„ í‰ê°€í•œë‹¤. |
| 5-6 | [6êµ­01-03] ì£¼ì œì™€ ê´€ë ¨í•˜ì—¬ ê¶ê¸ˆí•œ ë‚´ìš©ì„ ì§ˆë¬¸í•˜ë©° ì ê·¹ì ìœ¼ë¡œ ë“£ê³  ë§í•œë‹¤. | [6êµ­02-03] ê¸€ì´ë‚˜ ìë£Œë¥¼ ì½ê³  ë‚´ìš©ì˜ íƒ€ë‹¹ì„±ê³¼ í‘œí˜„ì˜ ì ì ˆì„±ì„ í‰ê°€í•œë‹¤. | [6êµ­03-03] ì²´í—˜í•œ ì¼ì— ëŒ€í•œ ê°ìƒì„ ë‚˜íƒ€ë‚´ëŠ” ê¸€ì„ ì“´ë‹¤. | [6êµ­04-03] ê³ ìœ ì–´ì™€ ê´€ìš© í‘œí˜„ì˜ ì“°ì„ê³¼ ê°€ì¹˜ë¥¼ ì´í•´í•˜ê³  ìƒí™©ì— ë§ê²Œ í‘œí˜„í•œë‹¤. | [6êµ­05-03] ì†Œì„¤ì´ë‚˜ ê·¹ì„ ì½ê³  ì¸ë¬¼, ì‚¬ê±´, ë°°ê²½ì„ íŒŒì•…í•œë‹¤. | [6êµ­06-03] ì í•©í•œ ì–‘ì‹ê³¼ ìˆ˜ìš©ìì˜ ë°˜ì‘ì„ ê³ ë ¤í•˜ì—¬ ë³µí•©ì–‘ì‹ ë§¤ì²´ ìë£Œë¥¼ ì œì‘í•˜ê³  ê³µìœ í•œë‹¤. |
| 5-6 | [6êµ­01-04] ë©´ë‹´ì˜ ì ˆì°¨ë¥¼ ì´í•´í•˜ê³  ìƒëŒ€ì™€ ë§¤ì²´ë¥¼ ê³ ë ¤í•˜ì—¬ ë©´ë‹´í•œë‹¤. | [6êµ­02-04] ë¬¸ì œ ìƒí™©ê³¼ ê´€ë ¨ëœ ë‹¤ì–‘í•œ ê´€ì ì˜ ê¸€ì„ ì½ê³  ì´ë¥¼ ë¬¸ì œ í•´ê²°ì— í™œìš©í•œë‹¤. | [6êµ­03-04] ë…ìì™€ ë§¤ì²´ë¥¼ ê³ ë ¤í•˜ì—¬ ë‚´ìš©ì„ ìƒì„±í•˜ê³  í‘œí˜„í•˜ë©° ê¸€ì„ ì“´ë‹¤. | [6êµ­04-04] ë¬¸ì¥ ì„±ë¶„ì„ ì´í•´í•˜ê³  í˜¸ì‘ ê´€ê³„ê°€ ì˜¬ë°”ë¥¸ ë¬¸ì¥ì„ êµ¬ì„±í•œë‹¤. | [6êµ­05-04] ì¸ìƒì ì¸ ë¶€ë¶„ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì‘í’ˆì— ëŒ€í•œ ì˜ê²¬ì„ ë‚˜ëˆˆë‹¤. | [6êµ­06-04] ìì‹ ì˜ ë§¤ì²´ ì´ìš© ì–‘ìƒì— ëŒ€í•´ ì„±ì°°í•œë‹¤. |
| 5-6 | [6êµ­01-05] ìë£Œë¥¼ ì„ ë³„í•˜ì—¬ í•µì‹¬ ì •ë³´ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ë‚´ìš©ì„ êµ¬ì„±í•˜ê³  ë§¤ì²´ë¥¼ í™œìš©í•˜ì—¬ ë°œí‘œí•œë‹¤. | [6êµ­02-05] ê¸ì •ì ì¸ ì½ê¸° ë™ê¸°ë¥¼ í˜•ì„±í•˜ê³  ì ê·¹ì ìœ¼ë¡œ ì½ê¸°ì— ì°¸ì—¬í•˜ëŠ” íƒœë„ë¥¼ ê¸°ë¥¸ë‹¤. | [6êµ­03-05] ì“°ê¸° ê³¼ì •ì„ ì ê²€â‹…ì¡°ì •í•˜ë©° ê¸€ì„ ì“°ê³ , ê¸€ ì „ì²´ë¥¼ ëŒ€ìƒìœ¼ë¡œ í†µì¼ì„± ìˆê²Œ ê³ ì³ ì“´ë‹¤. | [6êµ­04-05] ê¸€ê³¼ ë‹´í™”ì— ì“°ì¸ ì‹œê°„ í‘œí˜„ì„ ì´í•´í•˜ê³  ìƒí™©ì— ë§ê²Œ í‘œí˜„í•œë‹¤. | [6êµ­05-05] ìì‹ ì˜ ê²½í—˜ì„ ì‹œ, ì†Œì„¤, ê·¹, ìˆ˜í•„ ë“± ì ì ˆí•œ ê°ˆë˜ë¡œ í‘œí˜„í•œë‹¤. | |
| 5-6 | [6êµ­01-06] í† ì˜ì— í˜‘ë ¥ì ìœ¼ë¡œ ì°¸ì—¬í•˜ë©° ì„œë¡œì˜ ì˜ê²¬ì„ ë¹„êµí•˜ê³  ì¡°ì •í•œë‹¤. | | [6êµ­03-06] ì“°ê¸°ì— ì ê·¹ì ìœ¼ë¡œ ì°¸ì—¬í•˜ë©° ìì‹ ì˜ ê¸€ì„ ë…ìì™€ ê³µìœ í•˜ëŠ” íƒœë„ë¥¼ ì§€ë‹Œë‹¤. | [6êµ­04-06] ê¸€ê³¼ ë‹´í™”ì— ì“°ì¸ ë‹¨ì–´ ë° ë¬¸ì¥, ë„ì–´ì“°ê¸°ë¥¼ ë¯¼ê°í•˜ê²Œ ì‚´í´ ë°”ë¥´ê²Œ ê³ ì¹˜ëŠ” íƒœë„ë¥¼ ì§€ë‹Œë‹¤. | [6êµ­05-06] ì‘í’ˆì„ ì½ê³  ìì‹ ì˜ ì‚¶ê³¼ ì—°ê´€ ì§€ì–´ ì„±ì°°í•˜ëŠ” íƒœë„ë¥¼ ì§€ë‹Œë‹¤. | |
| 5-6 | [6êµ­01-07] ì ˆì°¨ì™€ ê·œì¹™ì„ ì§€í‚¤ê³  íƒ€ë‹¹í•œ ì´ìœ ì™€ ê·¼ê±°ë¥¼ ì œì‹œí•˜ë©° í† ë¡ í•œë‹¤. | | | | | |
`,
                math: `| í•™ë…„(êµ°) | ìˆ˜ì™€ ì—°ì‚° | ë³€í™”ì™€ ê´€ê³„ | ë„í˜•ê³¼ ì¸¡ì • | ìë£Œì™€ ê°€ëŠ¥ì„± |
|---|---|---|---|---|
| 1-2 | [2ìˆ˜01-01] ìˆ˜ì˜ í•„ìš”ì„±ì„ ì¸ì‹í•˜ë©´ì„œ 0ê³¼ 100ê¹Œì§€ì˜ ìˆ˜ ê°œë…ì„ ì´í•´í•˜ê³ , ìˆ˜ë¥¼ ì„¸ê³  ì½ê³  ì“¸ ìˆ˜ ìˆë‹¤. | [2ìˆ˜02-01] ë¬¼ì²´, ë¬´ëŠ¬, ìˆ˜ ë“±ì˜ ë°°ì—´ì—ì„œ ê·œì¹™ì„ ì°¾ì•„ ì—¬ëŸ¬ ê°€ì§€ ë°©ë²•ìœ¼ë¡œ í‘œí˜„í•  ìˆ˜ ìˆë‹¤. | [2ìˆ˜03-01] êµì‹¤ ë° ìƒí™œ ì£¼ë³€ì—ì„œ ì—¬ëŸ¬ ê°€ì§€ ë¬¼ê±´ì„ ê´€ì°°í•˜ì—¬ ì§ìœ¡ë©´ì²´, ì›ê¸°ë‘¥, êµ¬ì˜ ëª¨ì–‘ì„ ì°¾ê³ , ì´ë¥¼ ì´ìš©í•˜ì—¬ ì—¬ëŸ¬ ê°€ì§€ ëª¨ì–‘ì„ ë§Œë“¤ ìˆ˜ ìˆë‹¤. | [2ìˆ˜04-01] ì—¬ëŸ¬ ê°€ì§€ ì‚¬ë¬¼ì„ ì •í•´ì§„ ê¸°ì¤€ ë˜ëŠ” ìì‹ ì´ ì •í•œ ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¥˜í•˜ì—¬ ê°œìˆ˜ë¥¼ ì„¸ì–´ ë³´ê³ , ê¸°ì¤€ì— ë”°ë¥¸ ê²°ê³¼ë¥¼ ë§í•  ìˆ˜ ìˆë‹¤. |
| 1-2 | [2ìˆ˜01-02] ì¼, ì‹­, ë°±, ì²œì˜ ìë¦¿ê°’ê³¼ ìœ„ì¹˜ì  ê¸°ìˆ˜ë²•ì„ ì´í•´í•˜ê³ , ë„¤ ìë¦¬ ì´í•˜ì˜ ìˆ˜ë¥¼ ì½ê³  ì“¸ ìˆ˜ ìˆë‹¤. | [2ìˆ˜02-02] ìì‹ ì´ ì •í•œ ê·œì¹™ì— ë”°ë¼ ë¬¼ì²´, ë¬´ëŠ¬, ìˆ˜ ë“±ì„ ë°°ì—´í•  ìˆ˜ ìˆë‹¤. | [2ìˆ˜03-02] ìŒ“ê¸°ë‚˜ë¬´ë¥¼ ì´ìš©í•˜ì—¬ ì—¬ëŸ¬ ê°€ì§€ ì…ì²´ë„í˜•ì˜ ëª¨ì–‘ì„ ë§Œë“¤ê³ , ê·¸ ëª¨ì–‘ì— ëŒ€í•´ ìœ„ì¹˜ë‚˜ ë°©í–¥ì„ ì´ìš©í•˜ì—¬ ë§í•  ìˆ˜ ìˆë‹¤. | [2ìˆ˜04-02] ìë£Œë¥¼ ë¶„ë¥˜í•˜ì—¬ í‘œë¡œ ë‚˜íƒ€ë‚´ê³ , ìë£Œë¥¼ í‘œë¡œ ë‚˜íƒ€ë‚´ë©´ í¸ë¦¬í•œ ì ì„ ë§í•  ìˆ˜ ìˆë‹¤. |
| 1-2 | [2ìˆ˜01-03] ë„¤ ìë¦¬ ì´í•˜ì˜ ìˆ˜ì˜ ë²”ìœ„ì—ì„œ ìˆ˜ì˜ ê³„ì—´ì„ ì´í•´í•˜ê³ , ìˆ˜ì˜ í¬ê¸°ë¥¼ ë¹„êµí•  ìˆ˜ ìˆë‹¤. | | [2ìˆ˜03-03] êµì‹¤ ë° ìƒí™œ ì£¼ë³€ì—ì„œ ì—¬ëŸ¬ ê°€ì§€ ë¬¼ê±´ì„ ê´€ì°°í•˜ì—¬ ì‚¼ê°í˜•, ì‚¬ê°í˜•, ì›ì˜ ëª¨ì–‘ì„ ì°¾ê³ , ì´ë¥¼ ì´ìš©í•˜ì—¬ ì—¬ëŸ¬ ê°€ì§€ ëª¨ì–‘ì„ ë§Œë“¤ ìˆ˜ ìˆë‹¤. | [2ìˆ˜04-03] ìë£Œë¥¼ ë¶„ë¥˜í•˜ì—¬ â—‹, Ã—, / ë“±ì„ ì´ìš©í•œ ê·¸ë˜í”„ë¡œ ë‚˜íƒ€ë‚´ê³ , ìë£Œë¥¼ ê·¸ë˜í”„ë¡œ ë‚˜íƒ€ë‚´ë©´ í¸ë¦¬í•œ ì ì„ ë§í•  ìˆ˜ ìˆë‹¤. |
| 1-2 | [2ìˆ˜01-04] í•˜ë‚˜ì˜ ìˆ˜ë¥¼ ë‘ ìˆ˜ë¡œ ë¶„í•´í•˜ê³  ë‘ ìˆ˜ë¥¼ í•˜ë‚˜ì˜ ìˆ˜ë¡œ í•©ì„±í•˜ëŠ” í™œë™ì„ í†µí•˜ì—¬ ìˆ˜ ê°ê°ì„ ê¸°ë¥¸ë‹¤. | | [2ìˆ˜03-04] ì‚¼ê°í˜•, ì‚¬ê°í˜•, ì›ì„ ì§ê´€ì ìœ¼ë¡œ ì´í•´í•˜ê³ , ê·¸ ëª¨ì–‘ì„ ê·¸ë¦´ ìˆ˜ ìˆë‹¤. | |
| 1-2 | [2ìˆ˜01-05] ë§ì…ˆê³¼ ëº„ì…ˆì´ ì´ë£¨ì–´ì§€ëŠ” ì‹¤ìƒí™œ ìƒí™©ê³¼ ì—°ê²°í•˜ì—¬ ë§ì…ˆê³¼ ëº„ì…ˆì˜ ì˜ë¯¸ë¥¼ ì´í•´í•œë‹¤. | | [2ìˆ˜03-05] ì‚¼ê°í˜•, ì‚¬ê°í˜•ì—ì„œ ê°ê°ì˜ ê³µí†µì ì„ ì°¾ì•„ ë§í•  ìˆ˜ ìˆë‹¤. | |
| 1-2 | [2ìˆ˜01-06] ë‘ ìë¦¬ ìˆ˜ì˜ ë²”ìœ„ì—ì„œ ë§ì…ˆê³¼ ëº„ì…ˆì˜ ê³„ì‚° ì›ë¦¬ë¥¼ ì´í•´í•˜ê³  ê·¸ ê³„ì‚°ì„ í•  ìˆ˜ ìˆë‹¤. | | [2ìˆ˜03-06] êµ¬ì²´ë¬¼ì˜ ê¸¸ì´, ë“¤ì´, ë¬´ê²Œ, ë„“ì´ë¥¼ ë¹„êµí•˜ì—¬ ê°ê° â€˜ê¸¸ë‹¤, ì§§ë‹¤â€™, â€˜ë§ë‹¤, ì ë‹¤â€™, â€˜ë¬´ê²ë‹¤, ê°€ë³ë‹¤â€™, â€˜ë„“ë‹¤, ì¢ë‹¤â€™ ë“±ì„ êµ¬ë³„í•˜ì—¬ ë§í•  ìˆ˜ ìˆë‹¤. | |
| 1-2 | [2ìˆ˜01-07] ë§ì…ˆê³¼ ëº„ì…ˆì˜ ê´€ê³„ë¥¼ ì´í•´í•œë‹¤. | | [2ìˆ˜03-07] ì‹œê³„ë¥¼ ë³´ê³  ì‹œê°ì„ â€˜ëª‡ ì‹œ ëª‡ ë¶„â€™ê¹Œì§€ ì½ì„ ìˆ˜ ìˆë‹¤. | |
| 1-2 | [2ìˆ˜01-08] ë‘ ìë¦¬ ìˆ˜ì˜ ë²”ìœ„ì—ì„œ ì„¸ ìˆ˜ì˜ ë§ì…ˆê³¼ ëº„ì…ˆì„ í•  ìˆ˜ ìˆë‹¤. | | [2ìˆ˜03-08] 1ì‹œê°„ê³¼ 1ë¶„ì˜ ê´€ê³„ë¥¼ ì´í•´í•˜ê³ , ì‹œê°„ì„ â€˜ì‹œê°„â€™, â€˜ë¶„â€™ìœ¼ë¡œ í‘œí˜„í•  ìˆ˜ ìˆë‹¤. | |
| 1-2 | [2ìˆ˜01-09] â–¡ê°€ ì‚¬ìš©ëœ ë§ì…ˆì‹ê³¼ ëº„ì…ˆì‹ì„ ë§Œë“¤ê³ , â–¡ì˜ ê°’ì„ êµ¬í•  ìˆ˜ ìˆë‹¤. | | [2ìˆ˜03-09] ì‹¤ìƒí™œ ë¬¸ì œ ìƒí™©ê³¼ ì—°ê²°í•˜ì—¬ 1ë¶„, 1ì‹œê°„, 1ì¼, 1ì£¼ì¼, 1ê°œì›”, 1ë…„ ì‚¬ì´ì˜ ê´€ê³„ë¥¼ ì´í•´í•œë‹¤. | |
| 1-2 | [2ìˆ˜01-10] ê³±ì…ˆì´ ì´ë£¨ì–´ì§€ëŠ” ì‹¤ìƒí™œ ìƒí™©ê³¼ ì—°ê²°í•˜ì—¬ ê³±ì…ˆì˜ ì˜ë¯¸ë¥¼ ì´í•´í•œë‹¤. | | [2ìˆ˜03-10] ê¸¸ì´ ë‹¨ìœ„ 1cmë¥¼ ì•Œê³ , ì´ë¥¼ ì´ìš©í•˜ì—¬ ì£¼ë³€ ì‚¬ë¬¼ì˜ ê¸¸ì´ë¥¼ ì¸¡ì •í•  ìˆ˜ ìˆë‹¤. | |
| 1-2 | [2ìˆ˜01-11] ê³±ì…ˆêµ¬êµ¬ë¥¼ ì´í•´í•˜ê³ , í•œ ìë¦¬ ìˆ˜ì˜ ê³±ì…ˆì„ í•  ìˆ˜ ìˆë‹¤. | | [2ìˆ˜03-11] 1mì™€ cmì˜ ê´€ê³„ë¥¼ ì´í•´í•˜ê³ , ê¸¸ì´ë¥¼ â€˜ëª‡ mì™€ â€˜ëª‡ cmâ€™ë¡œ í‘œí˜„í•  ìˆ˜ ìˆë‹¤. | |
| 1-2 | | | [2ìˆ˜03-12] ì—¬ëŸ¬ ê°€ì§€ ë¬¼ê±´ì˜ ê¸¸ì´ë¥¼ ì–´ë¦¼í•˜ê³ , ê¸¸ì´ì— ëŒ€í•œ ê°ê°ì„ ê¸°ë¥¸ë‹¤. | |
| 1-2 | | | [2ìˆ˜03-13] ì‹¤ìƒí™œ ë¬¸ì œ ìƒí™©ê³¼ ì—°ê²°í•˜ì—¬ ê¸¸ì´ì˜ ë§ì…ˆê³¼ ëº„ì…ˆì„ í•  ìˆ˜ ìˆë‹¤. | |
| 3-4 | [4ìˆ˜01-01] í° ìˆ˜ì˜ í•„ìš”ì„±ì„ ì¸ì‹í•˜ë©´ì„œ 10000 ì´ìƒì˜ í° ìˆ˜ì— ëŒ€í•œ ìë¦¿ê°’ê³¼ ìœ„ì¹˜ì  ê¸°ìˆ˜ë²•ì„ ì´í•´í•˜ê³ , ìˆ˜ë¥¼ ì½ê³  ì“¸ ìˆ˜ ìˆë‹¤. | [4ìˆ˜02-01] ë‹¤ì–‘í•œ ë³€í™” ê·œì¹™ì„ ì°¾ì•„ ì„¤ëª…í•˜ê³ , ê·¸ ê·œì¹™ì„ ìˆ˜ë‚˜ ì‹ìœ¼ë¡œ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆë‹¤. | [4ìˆ˜03-01] ì§ì„ , ì„ ë¶„, ë°˜ì§ì„ ì„ ì´í•´í•˜ê³  êµ¬ë³„í•  ìˆ˜ ìˆë‹¤. | [4ìˆ˜04-01] ìë£Œë¥¼ ìˆ˜ì§‘í•˜ì—¬ ê·¸ë¦¼ê·¸ë˜í”„ë‚˜ ë§‰ëŒ€ê·¸ë˜í”„ë¡œ ë‚˜íƒ€ë‚´ê³  í•´ì„í•  ìˆ˜ ìˆë‹¤. |
| 3-4 | [4ìˆ˜01-02] ë‹¤ì„¯ ìë¦¬ ì´ìƒì˜ ìˆ˜ì˜ ë²”ìœ„ì—ì„œ ìˆ˜ì˜ ê³„ì—´ì„ ì´í•´í•˜ê³ , ìˆ˜ì˜ í¬ê¸°ë¥¼ ë¹„êµí•˜ë©° ê·¸ ë°©ë²•ì„ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. | [4ìˆ˜02-02] ê³„ì‚°ì‹ì˜ ë°°ì—´ì—ì„œ ê·œì¹™ì„ ì°¾ê³ , ê³„ì‚° ê²°ê³¼ë¥¼ ì¶”ì¸¡í•  ìˆ˜ ìˆë‹¤. | [4ìˆ˜03-02] ê°ê³¼ ì§ê°ì„ ì´í•´í•˜ê³ , ì§ê°ê³¼ ë¹„êµí•˜ëŠ” í™œë™ì„ í†µí•˜ì—¬ ì˜ˆê°ê³¼ ë‘”ê°ì„ êµ¬ë³„í•  ìˆ˜ ìˆë‹¤. | [4ìˆ˜04-02] ìë£Œë¥¼ ìˆ˜ì§‘í•˜ì—¬ êº¾ì€ì„ ê·¸ë˜í”„ë¡œ ë‚˜íƒ€ë‚´ê³  í•´ì„í•  ìˆ˜ ìˆë‹¤. |
| 3-4 | [4ìˆ˜01-03] ì„¸ ìë¦¬ ìˆ˜ì˜ ë§ì…ˆê³¼ ëº„ì…ˆì˜ ê³„ì‚° ì›ë¦¬ë¥¼ ì´í•´í•˜ê³  ê·¸ ê³„ì‚°ì„ í•  ìˆ˜ ìˆë‹¤. | [4ìˆ˜02-03] ë“±í˜¸ë¥¼ ì‚¬ìš©í•˜ì—¬ í¬ê¸°ê°€ ê°™ì€ ë‘ ì–‘ì˜ ê´€ê³„ë¥¼ ì‹ìœ¼ë¡œ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆë‹¤. | [4ìˆ˜03-03] ì§ì„ ì˜ ìˆ˜ì§ ê´€ê³„ì™€ í‰í–‰ ê´€ê³„ë¥¼ ì´í•´í•œë‹¤. | [4ìˆ˜04-03] íƒêµ¬ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ìë£Œë¥¼ ìˆ˜ì§‘, ì •ë¦¬í•˜ì—¬ ë§‰ëŒ€ê·¸ë˜í”„ë‚˜ êº¾ì€ì„ ê·¸ë˜í”„ë¡œ ë‚˜íƒ€ë‚´ê³  í•´ì„í•  ìˆ˜ ìˆë‹¤. |
| 3-4 | [4ìˆ˜01-04] ê³±í•˜ëŠ” ìˆ˜ê°€ í•œ ìë¦¬ ìˆ˜ ë˜ëŠ” ë‘ ìë¦¬ ìˆ˜ì¸ ê³±ì…ˆì˜ ê³„ì‚° ì›ë¦¬ë¥¼ ì´í•´í•˜ê³  ê·¸ ê³„ì‚°ì„ í•  ìˆ˜ ìˆë‹¤. | | [4ìˆ˜03-04] êµ¬ì²´ë¬¼ì´ë‚˜ í‰ë©´ë„í˜•ì˜ ë°€ê¸°, ë’¤ì§‘ê¸°, ëŒë¦¬ê¸° í™œë™ì„ í†µí•˜ì—¬ ê·¸ ë³€í™”ë¥¼ ì´í•´í•œë‹¤. | |
| 3-4 | [4ìˆ˜01-05] ë‚˜ëˆ—ì…ˆì´ ì´ë£¨ì–´ì§€ëŠ” ì‹¤ìƒí™œ ìƒí™©ê³¼ ì—°ê²°í•˜ì—¬ ë‚˜ëˆ—ì…ˆì˜ ì˜ë¯¸ë¥¼ ì•Œê³ , ê³±ì…ˆê³¼ ë‚˜ëˆ—ì…ˆì˜ ê´€ê³„ë¥¼ ì´í•´í•œë‹¤. | | [4ìˆ˜03-05] í‰ë©´ì—ì„œ ì ì˜ ì´ë™ì— ëŒ€í•´ ìœ„ì¹˜ì™€ ë°©í–¥ì„ ì´ìš©í•˜ì—¬ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. | |
| 3-4 | [4ìˆ˜01-06] ë‚˜ëˆ„ëŠ” ìˆ˜ê°€ í•œ ìë¦¬ ìˆ˜ì¸ ë‚˜ëˆ—ì…ˆì˜ ê³„ì‚° ì›ë¦¬ë¥¼ ì´í•´í•˜ê³  ê·¸ ê³„ì‚°ì„ í•  ìˆ˜ ìˆìœ¼ë©°, ë‚˜ëˆ—ì…ˆì—ì„œ ëª«ê³¼ ë‚˜ë¨¸ì§€ì˜ ì˜ë¯¸ë¥¼ ì•ˆë‹¤. | | [4ìˆ˜03-06] ì›ì˜ ì¤‘ì‹¬, ë°˜ì§€ë¦„, ì§€ë¦„ì„ ì´í•´í•˜ê³ , ê·¸ ì„±ì§ˆì„ ì•ˆë‹¤. | |
| 3-4 | [4ìˆ˜01-07] ë‚˜ëˆ„ëŠ” ìˆ˜ê°€ ë‘ ìë¦¬ ìˆ˜ì¸ ë‚˜ëˆ—ì…ˆì˜ ê³„ì‚° ì›ë¦¬ë¥¼ ì´í•´í•˜ê³  ê·¸ ê³„ì‚°ì„ í•  ìˆ˜ ìˆë‹¤. | | [4ìˆ˜03-07] ì»´í¼ìŠ¤ë¥¼ ì´ìš©í•˜ì—¬ ì—¬ëŸ¬ ê°€ì§€ í¬ê¸°ì˜ ì›ì„ ê·¸ë¦´ ìˆ˜ ìˆë‹¤. | |
| 3-4 | [4ìˆ˜01-08] ìì—°ìˆ˜ì˜ ë§ì…ˆ, ëº„ì…ˆ, ê³±ì…ˆ, ë‚˜ëˆ—ì…ˆê³¼ ê´€ë ¨í•œ ì—¬ëŸ¬ ê°€ì§€ ìƒí™©ì—ì„œ ì–´ë¦¼ì…ˆì„ í•  ìˆ˜ ìˆë‹¤. | | [4ìˆ˜03-08] ì—¬ëŸ¬ ê°€ì§€ ëª¨ì–‘ì˜ ì‚¼ê°í˜•ì— ëŒ€í•œ ë¶„ë¥˜ í™œë™ì„ í†µí•˜ì—¬ ì´ë“±ë³€ì‚¼ê°í˜•, ì •ì‚¼ê°í˜•ì„ ì´í•´í•˜ê³ , ê·¸ ì„±ì§ˆì„ íƒêµ¬í•˜ê³  ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. | |
| 3-4 | [4ìˆ˜01-09] ì–‘ì˜ ë“±ë¶„í• ì„ í†µí•˜ì—¬ ë¶„ìˆ˜ì˜ í•„ìš”ì„±ì„ ì¸ì‹í•˜ê³ , ë¶„ìˆ˜ë¥¼ ì´í•´í•˜ê³  ì½ê³  ì“¸ ìˆ˜ ìˆë‹¤. | | [4ìˆ˜03-09] ì—¬ëŸ¬ ê°€ì§€ ëª¨ì–‘ì˜ ì‚¼ê°í˜•ì— ëŒ€í•œ ë¶„ë¥˜ í™œë™ì„ í†µí•˜ì—¬ ì§ê°ì‚¼ê°í˜•, ì˜ˆê°ì‚¼ê°í˜•, ë‘”ê°ì‚¼ê°í˜•ì„ ì´í•´í•œë‹¤. | |
| 3-4 | [4ìˆ˜01-10] ë‹¨ìœ„ë¶„ìˆ˜, ì§„ë¶„ìˆ˜, ê°€ë¶„ìˆ˜, ëŒ€ë¶„ìˆ˜ë¥¼ ì•Œê³ , ê·¸ ê´€ê³„ë¥¼ ì´í•´í•œë‹¤. | | [4ìˆ˜03-10] ì—¬ëŸ¬ ê°€ì§€ ëª¨ì–‘ì˜ ì‚¬ê°í˜•ì— ëŒ€í•œ ë¶„ë¥˜ í™œë™ì„ í†µí•˜ì—¬ ì§ì‚¬ê°í˜•, ì •ì‚¬ê°í˜•, ì‚¬ë‹¤ë¦¬ê¼´, í‰í–‰ì‚¬ë³€í˜•, ë§ˆë¦„ëª¨ë¥¼ ì´í•´í•˜ê³ , ê·¸ ì„±ì§ˆì„ íƒêµ¬í•˜ê³  ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. | |
| 3-4 | [4ìˆ˜01-11] ë¶„ëª¨ê°€ ê°™ì€ ë¶„ìˆ˜ë¼ë¦¬, ë‹¨ìœ„ë¶„ìˆ˜ë¼ë¦¬ í¬ê¸°ë¥¼ ë¹„êµí•˜ê³  ê·¸ ë°©ë²•ì„ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. | | [4ìˆ˜03-11] ë‹¤ê°í˜•ê³¼ ì •ë‹¤ê°í˜•ì„ ì´í•´í•œë‹¤. | |
| 3-4 | [4ìˆ˜01-12] ë¶„ëª¨ê°€ 10ì¸ ì§„ë¶„ìˆ˜ì™€ ì—°ê²°í•˜ì—¬ ì†Œìˆ˜ í•œ ìë¦¬ ìˆ˜ë¥¼ ì´í•´í•˜ê³  ì½ê³  ì“¸ ìˆ˜ ìˆë‹¤. | | [4ìˆ˜03-12] ì£¼ì–´ì§„ ë„í˜•ì„ ì´ìš©í•˜ì—¬ ì—¬ëŸ¬ ê°€ì§€ ëª¨ì–‘ì„ ë§Œë“¤ê±°ë‚˜ ì±„ìš°ê³  ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. | |
| 3-4 | [4ìˆ˜01-13] ìë¦¿ê°’ì˜ ì›ë¦¬ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì†Œìˆ˜ ë‘ ìë¦¬ ìˆ˜ì™€ ì†Œìˆ˜ ì„¸ ìë¦¬ ìˆ˜ë¥¼ ì´í•´í•˜ê³  ì½ê³  ì“¸ ìˆ˜ ìˆë‹¤. | | [4ìˆ˜03-13] 1ë¶„ê³¼ 1ì´ˆì˜ ê´€ê³„ë¥¼ ì´í•´í•˜ê³ , ì´ˆ ë‹¨ìœ„ê¹Œì§€ ì‹œê°ì„ ì½ì„ ìˆ˜ ìˆë‹¤. | |
| 3-4 | [4ìˆ˜01-14] ì†Œìˆ˜ì˜ í¬ê¸°ë¥¼ ë¹„êµí•˜ê³  ê·¸ ë°©ë²•ì„ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. | | [4ìˆ˜03-14] ì‹¤ìƒí™œ ë¬¸ì œ ìƒí™©ê³¼ ì—°ê²°í•˜ì—¬ ì´ˆ ë‹¨ìœ„ê¹Œì§€ì˜ ì‹œê°„ì˜ ë§ì…ˆê³¼ ëº„ì…ˆì„ í•  ìˆ˜ ìˆë‹¤. | |
| 3-4 | [4ìˆ˜01-15] ë¶„ëª¨ê°€ ê°™ì€ ë¶„ìˆ˜ì˜ ë§ì…ˆê³¼ ëº„ì…ˆì˜ ê³„ì‚° ì›ë¦¬ë¥¼ ì´í•´í•˜ê³  ê·¸ ê³„ì‚°ì„ í•  ìˆ˜ ìˆë‹¤. | | [4ìˆ˜03-15] ê¸¸ì´ ë‹¨ìœ„ 1mmì™€ 1kmë¥¼ ì•Œê³ , ì´ë¥¼ ì´ìš©í•˜ì—¬ ê¸¸ì´ë¥¼ ì¸¡ì •í•˜ê³  ì–´ë¦¼í•˜ë©° ìˆ˜í•™ì˜ ìœ ìš©ì„±ì„ ì¸ì‹í•  ìˆ˜ ìˆë‹¤. | |
| 3-4 | [4ìˆ˜01-16] ì†Œìˆ˜ ë‘ ìë¦¬ ìˆ˜ì˜ ë²”ìœ„ì—ì„œ ì†Œìˆ˜ì˜ ë§ì…ˆê³¼ ëº„ì…ˆì˜ ê³„ì‚° ì›ë¦¬ë¥¼ ì´í•´í•˜ê³  ê·¸ ê³„ì‚°ì„ í•  ìˆ˜ ìˆë‹¤. | | [4ìˆ˜03-16] 1cmì™€ 1mm, 1kmì™€ 1mì˜ ê´€ê³„ë¥¼ ì´í•´í•˜ê³ , ê¸¸ì´ë¥¼ â€˜ëª‡ cm ëª‡ mmâ€™ì™€ â€˜ëª‡ mmâ€™, â€˜ëª‡ km ëª‡ mâ€™ì™€ â€˜ëª‡ mâ€™ë¡œ ë‹¤ì–‘í•˜ê²Œ í‘œí˜„í•  ìˆ˜ ìˆë‹¤. | |
| 3-4 | | | [4ìˆ˜03-17] ë“¤ì´ ë‹¨ìœ„ 1Lì™€ 1mLë¥¼ ì•Œê³ , ì´ë¥¼ ì´ìš©í•˜ì—¬ ë“¤ì´ë¥¼ ì¸¡ì •í•˜ê³  ì–´ë¦¼í•˜ë©° ìˆ˜í•™ì˜ ìœ ìš©ì„±ì„ ì¸ì‹í•  ìˆ˜ ìˆë‹¤. | |
| 3-4 | | | [4ìˆ˜03-18] 1Lì™€ 1mLì˜ ê´€ê³„ë¥¼ ì´í•´í•˜ê³ , ë“¤ì´ë¥¼ â€˜ëª‡ L ëª‡ mLâ€™ì™€ â€˜ëª‡ mLâ€™ë¡œ í‘œí˜„í•  ìˆ˜ ìˆë‹¤. | |
| 3-4 | | | [4ìˆ˜03-19] ì‹¤ìƒí™œ ë¬¸ì œ ìƒí™©ê³¼ ì—°ê²°í•˜ì—¬ ë“¤ì´ì˜ ë§ì…ˆê³¼ ëº„ì…ˆì„ í•  ìˆ˜ ìˆë‹¤. | |
| 3-4 | | | [4ìˆ˜03-20] ì‹¤ìƒí™œì—ì„œ ë¬´ê²Œë¥¼ ë‚˜íƒ€ë‚¼ ë•Œ ì‚¬ìš©í•˜ëŠ” ë‹¨ìœ„ 1gê³¼ 1kgì„ ì•Œê³ , ì´ë¥¼ ì´ìš©í•˜ì—¬ ë¬´ê²Œë¥¼ ì¸¡ì •í•˜ê³  ì–´ë¦¼í•˜ë©° ìˆ˜í•™ì˜ ìœ ìš©ì„±ì„ ì¸ì‹í•  ìˆ˜ ìˆë‹¤. | |
| 3-4 | | | [4ìˆ˜03-21] 1kgê³¼ 1gì˜ ê´€ê³„ë¥¼ ì´í•´í•˜ê³ , ë¬´ê²Œë¥¼ â€˜ëª‡ kg ëª‡ gâ€™ê³¼ â€˜ëª‡ gâ€™ìœ¼ë¡œ í‘œí˜„í•  ìˆ˜ ìˆë‹¤. | |
| 3-4 | | | [4ìˆ˜03-22] ì‹¤ìƒí™œì—ì„œ ë¬´ê²Œë¥¼ ë‚˜íƒ€ë‚¼ ë•Œ ì‚¬ìš©í•˜ëŠ” ë‹¨ìœ„ 1tì„ ì•Œê³ , 1tê³¼ 1kgì˜ ê´€ê³„ë¥¼ ì´í•´í•œë‹¤. | |
| 3-4 | | | [4ìˆ˜03-23] ì‹¤ìƒí™œ ë¬¸ì œ ìƒí™©ê³¼ ì—°ê²°í•˜ì—¬ ë¬´ê²Œì˜ ë§ì…ˆê³¼ ëº„ì…ˆì„ í•  ìˆ˜ ìˆë‹¤. | |
| 3-4 | | | [4ìˆ˜03-24] ê°ì˜ í¬ê¸°ì˜ ë‹¨ìœ„ì¸ 1ë„(Â°)ë¥¼ ì•Œê³ , ê°ë„ê¸°ë¥¼ ì´ìš©í•˜ì—¬ ê°ì˜ í¬ê¸°ë¥¼ ì¸¡ì •í•˜ê³  ì–´ë¦¼í•  ìˆ˜ ìˆë‹¤. | |
| 3-4 | | | [4ìˆ˜03-25] ì—¬ëŸ¬ ê°€ì§€ ë°©ë²•ìœ¼ë¡œ ì‚¼ê°í˜•ê³¼ ì‚¬ê°í˜•ì˜ ë‚´ê°ì˜ í¬ê¸°ì˜ í•©ì„ ì¶”ë¡ í•˜ê³ , ìì‹ ì˜ ì¶”ë¡  ê³¼ì •ì„ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. | |
| 5-6 | [6ìˆ˜01-01] ë§ì…ˆ, ëº„ì…ˆ, ê³±ì…ˆ, ë‚˜ëˆ—ì…ˆì˜ í˜¼í•© ê³„ì‚°ì—ì„œ ê³„ì‚°í•˜ëŠ” ìˆœì„œë¥¼ ì•Œê³ , í˜¼í•© ê³„ì‚°ì„ í•  ìˆ˜ ìˆë‹¤. | [6ìˆ˜02-01] í•œ ì–‘ì´ ë³€í•  ë•Œ ë‹¤ë¥¸ ì–‘ì´ ê·¸ì— ì¢…ì†í•˜ì—¬ ë³€í•˜ëŠ” ëŒ€ì‘ ê´€ê³„ë¥¼ ë‚˜íƒ€ë‚¸ í‘œì—ì„œ ê·œì¹™ì„ ì°¾ì•„ ì„¤ëª…í•˜ê³ , â–¡, â–³ ë“±ì„ ì‚¬ìš©í•˜ì—¬ ì‹ìœ¼ë¡œ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆë‹¤. | [6ìˆ˜03-01] ë„í˜•ì˜ í•©ë™ì„ ì´í•´í•˜ê³ , í•©ë™ì¸ ë„í˜•ì˜ ì„±ì§ˆì„ íƒêµ¬í•˜ê³  ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. | [6ìˆ˜04-01] í‰ê· ì˜ ì˜ë¯¸ë¥¼ ì•Œê³ , ìë£Œë¥¼ ìˆ˜ì§‘í•˜ì—¬ í‰ê· ì„ êµ¬í•˜ê³  í•´ì„í•  ìˆ˜ ìˆë‹¤. |
| 5-6 | [6ìˆ˜01-02] ì‹¤ìƒí™œê³¼ ì—°ê²°í•˜ì—¬ ì´ìƒ, ì´í•˜, ì´ˆê³¼, ë¯¸ë§Œì˜ ì˜ë¯¸ì™€ ì“°ì„ì„ ì•Œê³ , ì´ë¥¼ í™œìš©í•˜ì—¬ ìˆ˜ì˜ ë²”ìœ„ë¥¼ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆë‹¤. | [6ìˆ˜02-02] ë‘ ì–‘ì˜ í¬ê¸°ë¥¼ ë¹„êµí•˜ëŠ” ìƒí™©ì„ í†µí•´ ë¹„ì˜ ê°œë…ì„ ì´í•´í•˜ê³ , ë‘ ì–‘ì˜ ê´€ê³„ë¥¼ ë¹„ë¡œ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆë‹¤. | [6ìˆ˜03-02] ì‹¤ìƒí™œê³¼ ì—°ê²°í•˜ì—¬ ì„ ëŒ€ì¹­ë„í˜•ê³¼ ì ëŒ€ì¹­ë„í˜•ì„ ì´í•´í•˜ê³  ê·¸ë¦´ ìˆ˜ ìˆë‹¤. | [6ìˆ˜04-02] ìë£Œë¥¼ ìˆ˜ì§‘í•˜ì—¬ ë ê·¸ë˜í”„ë‚˜ ì›ê·¸ë˜í”„ë¡œ ë‚˜íƒ€ë‚´ê³  í•´ì„í•  ìˆ˜ ìˆë‹¤. |
| 5-6 | [6ìˆ˜01-03] ì–´ë¦¼ê°’ì„ êµ¬í•˜ê¸° ìœ„í•œ ë°©ë²•ìœ¼ë¡œ ì˜¬ë¦¼, ë²„ë¦¼, ë°˜ì˜¬ë¦¼ì˜ ì˜ë¯¸ì™€ í•„ìš”ì„±ì„ ì•Œê³ , ì´ë¥¼ ì‹¤ìƒí™œì— í™œìš©í•¨ìœ¼ë¡œì¨ ìˆ˜í•™ì˜ ìœ ìš©ì„±ì„ ì¸ì‹í•  ìˆ˜ ìˆë‹¤. | [6ìˆ˜02-03] ë¹„ìœ¨ì„ ì´í•´í•˜ê³ , ë¹„ìœ¨ì„ ë¶„ìˆ˜, ì†Œìˆ˜, ë°±ë¶„ìœ¨ë¡œ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆë‹¤. | [6ìˆ˜03-03] ì§ìœ¡ë©´ì²´ì™€ ì •ìœ¡ë©´ì²´ë¥¼ ì´í•´í•˜ê³ , êµ¬ì„± ìš”ì†Œì™€ ì„±ì§ˆì„ íƒêµ¬í•˜ê³  ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. | [6ìˆ˜04-03] íƒêµ¬ ë¬¸ì œë¥¼ ì„¤ì •í•˜ê³ , ê·¸ì— ë§ëŠ” ìë£Œë¥¼ ìˆ˜ì§‘, ì •ë¦¬í•˜ì—¬ ì ì ˆí•œ ê·¸ë˜í”„ë¡œ ë‚˜íƒ€ë‚´ê³  í•´ì„í•  ìˆ˜ ìˆë‹¤. |
| 5-6 | [6ìˆ˜01-04] ì•½ìˆ˜, ê³µì•½ìˆ˜, ìµœëŒ€ê³µì•½ìˆ˜ë¥¼ ì´í•´í•˜ê³  êµ¬í•  ìˆ˜ ìˆë‹¤. | [6ìˆ˜02-04] ë¹„ë¡€ì‹ì„ ì•Œê³ , ê·¸ ì„±ì§ˆì„ ì´í•´í•˜ë©°, ì´ë¥¼ í™œìš©í•˜ì—¬ ê°„ë‹¨í•œ ë¹„ë¡€ì‹ì„ í’€ ìˆ˜ ìˆë‹¤. | [6ìˆ˜03-04] ì§ìœ¡ë©´ì²´ì™€ ì •ìœ¡ë©´ì²´ì˜ ê²¨ëƒ¥ë„ì™€ ì „ê°œë„ë¥¼ ê·¸ë¦´ ìˆ˜ ìˆë‹¤. | [6ìˆ˜04-04] ì‚¬ê±´ì´ ì¼ì–´ë‚  ê°€ëŠ¥ì„±ì„ ë§ë¡œ í‘œí˜„í•˜ê³  ë¹„êµí•  ìˆ˜ ìˆë‹¤. |
| 5-6 | [6ìˆ˜01-05] ë°°ìˆ˜, ê³µë°°ìˆ˜, ìµœì†Œê³µë°°ìˆ˜ë¥¼ ì´í•´í•˜ê³  êµ¬í•  ìˆ˜ ìˆë‹¤. | [6ìˆ˜02-05] ë¹„ë¡€ë°°ë¶„ì„ ì•Œê³ , ì£¼ì–´ì§„ ì–‘ì„ ë¹„ë¡€ë°°ë¶„ í•  ìˆ˜ ìˆë‹¤. | [6ìˆ˜03-05] ê°ê¸°ë‘¥ê³¼ ê°ë¿”ì„ ì´í•´í•˜ê³ , êµ¬ì„± ìš”ì†Œì™€ ì„±ì§ˆì„ íƒêµ¬í•˜ê³  ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. | [6ìˆ˜04-05] ì‚¬ê±´ì´ ì¼ì–´ë‚  ê°€ëŠ¥ì„±ì„ ìˆ˜ë¡œ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆë‹¤. |
| 5-6 | [6ìˆ˜01-06] í¬ê¸°ê°€ ê°™ì€ ë¶„ìˆ˜ë¥¼ ë§Œë“œëŠ” ë°©ë²•ì„ ì´í•´í•˜ê³ , ë¶„ìˆ˜ë¥¼ ì•½ë¶„, í†µë¶„í•  ìˆ˜ ìˆë‹¤. | | [6ìˆ˜03-06] ê°ê¸°ë‘¥ì˜ ì „ê°œë„ë¥¼ ê·¸ë¦´ ìˆ˜ ìˆë‹¤. | [6ìˆ˜04-06] ìë£Œë¥¼ ì´ìš©í•˜ì—¬ ê°€ëŠ¥ì„±ì„ ì˜ˆìƒí•˜ê³ , ê°€ëŠ¥ì„±ì— ê·¼ê±°í•˜ì—¬ ì ì ˆí•œ íŒë‹¨ì„ ë‚´ë¦´ ìˆ˜ ìˆë‹¤. |
| 5-6 | [6ìˆ˜01-07] ë¶„ëª¨ê°€ ë‹¤ë¥¸ ë¶„ìˆ˜ì˜ í¬ê¸°ë¥¼ ë¹„êµí•˜ê³  ê·¸ ë°©ë²•ì„ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. | | [6ìˆ˜03-07] ì›ê¸°ë‘¥, ì›ë¿”, êµ¬ë¥¼ ì´í•´í•˜ê³ , êµ¬ì„± ìš”ì†Œì™€ ì„±ì§ˆì„ íƒêµ¬í•˜ê³  ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. | |
| 5-6 | [6ìˆ˜01-08] ë¶„ëª¨ê°€ ë‹¤ë¥¸ ë¶„ìˆ˜ì˜ ë§ì…ˆê³¼ ëº„ì…ˆì˜ ê³„ì‚° ì›ë¦¬ë¥¼ íƒêµ¬í•˜ê³  ê·¸ ê³„ì‚°ì„ í•  ìˆ˜ ìˆë‹¤. | | [6ìˆ˜03-08] ì›ê¸°ë‘¥ì˜ ì „ê°œë„ë¥¼ ê·¸ë¦´ ìˆ˜ ìˆë‹¤. | |
| 5-6 | [6ìˆ˜01-09] ë¶„ìˆ˜ì˜ ê³±ì…ˆì˜ ê³„ì‚° ì›ë¦¬ë¥¼ íƒêµ¬í•˜ê³  ê·¸ ê³„ì‚°ì„ í•  ìˆ˜ ìˆë‹¤. | | [6ìˆ˜03-09] ìŒ“ê¸°ë‚˜ë¬´ë¡œ ë§Œë“  ì…ì²´ë„í˜•ì„ ë³´ê³  ì‚¬ìš©ëœ ìŒ“ê¸°ë‚˜ë¬´ì˜ ê°œìˆ˜ë¥¼ êµ¬í•  ìˆ˜ ìˆë‹¤. | |
| 5-6 | [6ìˆ˜01-10] â€˜(ìì—°ìˆ˜) Ã· (ìì—°ìˆ˜)â€™ì—ì„œ ë‚˜ëˆ—ì…ˆì˜ ëª«ì„ ë¶„ìˆ˜ë¡œ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆë‹¤. | | [6ìˆ˜03-10] ìŒ“ê¸°ë‚˜ë¬´ë¡œ ë§Œë“  ì…ì²´ë„í˜•ì˜ ìœ„, ì•, ì˜†ì—ì„œ ë³¸ ëª¨ì–‘ì„ í‘œí˜„í•  ìˆ˜ ìˆê³ , ì´ëŸ¬í•œ í‘œí˜„ì„ ë³´ê³  ì…ì²´ë„í˜•ì˜ ëª¨ì–‘ì„ ì¶”ì¸¡í•  ìˆ˜ ìˆë‹¤. | |
| 5-6 | [6ìˆ˜01-11] ë¶„ìˆ˜ì˜ ë‚˜ëˆ—ì…ˆì˜ ê³„ì‚° ì›ë¦¬ë¥¼ íƒêµ¬í•˜ê³  ê·¸ ê³„ì‚°ì„ í•  ìˆ˜ ìˆë‹¤. | | [6ìˆ˜03-11] í‰ë©´ë„í˜•ì˜ ë‘˜ë ˆë¥¼ ì´í•´í•˜ê³ , ê¸°ë³¸ì ì¸ í‰ë©´ë„í˜•ì˜ ë‘˜ë ˆë¥¼ êµ¬í•  ìˆ˜ ìˆë‹¤. | |
| 5-6 | [6ìˆ˜01-12] ë¶„ìˆ˜ì™€ ì†Œìˆ˜ì˜ ê´€ê³„ë¥¼ ì´í•´í•˜ê³  í¬ê¸°ë¥¼ ë¹„êµí•˜ë©° ê·¸ ë°©ë²•ì„ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤. | | [6ìˆ˜03-12] ë„“ì´ ë‹¨ìœ„ 1cmÂ², 1mÂ², 1kmÂ²ë¥¼ ì•Œë©°, ê·¸ ê´€ê³„ë¥¼ ì´í•´í•œë‹¤. | |
| 5-6 | [6ìˆ˜01-13] ì†Œìˆ˜ì˜ ê³±ì…ˆì˜ ê³„ì‚° ì›ë¦¬ë¥¼ íƒêµ¬í•˜ê³  ê·¸ ê³„ì‚°ì„ í•  ìˆ˜ ìˆë‹¤. | | [6ìˆ˜03-13] ì§ì‚¬ê°í˜•ê³¼ ì •ì‚¬ê°í˜•ì˜ ë„“ì´ë¥¼ êµ¬í•˜ëŠ” ë°©ë²•ì„ ì´í•´í•˜ê³ , ì´ë¥¼ êµ¬í•  ìˆ˜ ìˆë‹¤. | |
| 5-6 | [6ìˆ˜01-14] â€˜(ìì—°ìˆ˜) Ã· (ìì—°ìˆ˜)â€™ì—ì„œ ë‚˜ëˆ—ì…ˆì˜ ëª«ì„ ì†Œìˆ˜ë¡œ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆë‹¤. | | [6ìˆ˜03-14] í‰í–‰ì‚¬ë³€í˜•, ì‚¼ê°í˜•, ì‚¬ë‹¤ë¦¬ê¼´, ë§ˆë¦„ëª¨ì˜ ë„“ì´ë¥¼ êµ¬í•˜ëŠ” ë°©ë²•ì„ ë‹¤ì–‘í•˜ê²Œ ì¶”ë¡ í•˜ê³ , ì´ì™€ ê´€ë ¨ëœ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆë‹¤. | |
| 5-6 | [6ìˆ˜01-15] ì†Œìˆ˜ì˜ ë‚˜ëˆ—ì…ˆì˜ ê³„ì‚° ì›ë¦¬ë¥¼ íƒêµ¬í•˜ê³  ê·¸ ê³„ì‚°ì„ í•  ìˆ˜ ìˆë‹¤. | | [6ìˆ˜03-15] ì—¬ëŸ¬ ê°€ì§€ ì› ëª¨ì–‘ ë¬¼ì²´ì˜ ì›ì£¼ì™€ ì§€ë¦„ì„ ì¸¡ì •í•˜ëŠ” í™œë™ì„ í†µí•˜ì—¬, ì›ì£¼ìœ¨ì´ ì¼ì •í•œ ê°’ì„ì„ ì•Œê³  ê·¸ ê·¼ì‚¿ê°’ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. | |
| 5-6 | | | [6ìˆ˜03-16] ì›ì£¼ì™€ ì›ì˜ ë„“ì´ë¥¼ êµ¬í•˜ëŠ” ë°©ë²•ì„ ì´í•´í•˜ê³ , ì´ë¥¼ êµ¬í•  ìˆ˜ ìˆë‹¤. | |
| 5-6 | | | [6ìˆ˜03-17] ì§ìœ¡ë©´ì²´ì™€ ì •ìœ¡ë©´ì²´ì˜ ê²‰ë„“ì´ë¥¼ êµ¬í•˜ëŠ” ë°©ë²•ì„ ì´í•´í•˜ê³ , ì´ë¥¼ êµ¬í•  ìˆ˜ ìˆë‹¤. | |
| 5-6 | | | [6ìˆ˜03-18] ë¶€í”¼ ë‹¨ìœ„ 1cmÂ³, 1mÂ³ë¥¼ ì•Œë©°, ê·¸ ê´€ê³„ë¥¼ ì´í•´í•œë‹¤. | |
| 5-6 | | | [6ìˆ˜03-19] ì§ìœ¡ë©´ì²´ì™€ ì •ìœ¡ë©´ì²´ì˜ ë¶€í”¼ë¥¼ êµ¬í•˜ëŠ” ë°©ë²•ì„ ì´í•´í•˜ê³ , ì´ë¥¼ êµ¬í•  ìˆ˜ ìˆë‹¤. | |
`
            }
        };

        function setActiveButton(container, value) {
            container.querySelectorAll('button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === value);
            });
        }

        function getActiveValue(container) {
            const active = container.querySelector('.active');
            return active ? active.dataset.value : null;
        }

        function markdownTableToHtml(md) {
            const lines = md.trim().split('\n');
            const headers = lines[0].split('|').slice(1, -1).map(s => s.trim());
            const rows = lines.slice(2).map(line => line.split('|').slice(1, -1).map(s => s.trim()));
            const firstColWidth = 20;
            const otherColWidth = headers.length > 1 ? (80 / (headers.length - 1)) : 80;
            const firstWidthStyle = `style="width: ${firstColWidth}%"`;
            const otherWidthStyle = headers.length > 1 ? `style="width: ${otherColWidth.toFixed(2)}%"` : '';
            let html = '<table class="min-w-full border border-gray-300 text-sm"><thead><tr>';
            headers.forEach((h, idx) => {
                const widthStyle = idx === 0 ? firstWidthStyle : otherWidthStyle;
                const widthAttr = widthStyle ? `${widthStyle} ` : '';
                html += `<th ${widthAttr}class="border px-2 py-1 bg-gray-100">${h.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')}</th>`;
            });
            html += '</tr></thead><tbody>';
            rows.forEach(row => {
                html += '<tr>';
                row.forEach((cell, cellIdx) => {
                    const widthStyle = cellIdx === 0 ? firstWidthStyle : otherWidthStyle;
                    const widthAttr = widthStyle ? `${widthStyle} ` : '';
                    html += `<td ${widthAttr}class="border px-2 py-1 align-top">${cell.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            return html;
        }

        function setButtonState(btn, state) {
            btn.dataset.state = state;
            btn.classList.remove('bg-yellow-200', 'bg-green-200', 'bg-opacity-50');
            if (state === 1) {
                btn.classList.add('bg-yellow-200', 'bg-opacity-50');
            } else if (state === 2) {
                btn.classList.add('bg-green-200', 'bg-opacity-50');
            }
        }

        function makeAchievementTableInteractive() {
            const table = achievementTableContainer.querySelector('table');
            if (!table) return;
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(tr => {
                for (let i = 1; i < tr.cells.length; i++) {
                    const cell = tr.cells[i];
                    const text = cell.textContent;
                    cell.innerHTML = `<button type="button" class="w-full text-left px-1 py-0.5 rounded" data-state="0">${text}</button>`;
                    const btn = cell.querySelector('button');
                    btn.addEventListener('click', () => {
                        let state = parseInt(btn.dataset.state);
                        state = (state + 1) % 3;
                        setButtonState(btn, state);
                    });
                }
            });
        }

        function applyAchievementStates() {
            const key = `${getActiveValue(levelButtons)}_${getActiveValue(subjectButtons)}`;
            const stateRows = currentAchievementData[key];
            if (!stateRows) return;
            const rows = achievementTableContainer.querySelectorAll('tbody tr');
            rows.forEach((tr, rowIdx) => {
                for (let i = 1; i < tr.cells.length; i++) {
                    const btn = tr.cells[i].querySelector('button');
                    const state = stateRows[rowIdx]?.[i - 1] || 0;
                    setButtonState(btn, state);
                }
            });
        }

        function applyGradeFilter() {
            const grade = getActiveValue(gradeButtons);
            const rows = achievementTableContainer.querySelectorAll('tbody tr');
            rows.forEach(tr => {
                const rowGrade = tr.cells[0].textContent.trim();
                tr.style.display = (grade === 'all' || rowGrade === grade) ? '' : 'none';
            });
        }

        function updateGradeButtons() {
            const level = getActiveValue(levelButtons);
            let options = [];
            if (level === 'elementary') {
                options = [
                    { value: 'all', label: 'ì „ì²´' },
                    { value: '1-2', label: '1-2í•™ë…„' },
                    { value: '3-4', label: '3-4í•™ë…„' },
                    { value: '5-6', label: '5-6í•™ë…„' },
                ];
            } else {
                options = [
                    { value: 'all', label: 'ì „ì²´' },
                    { value: '1', label: '1' },
                    { value: '2', label: '2' },
                    { value: '3', label: '3' },
                ];
            }
            gradeButtons.innerHTML = options.map(o => `<button data-value="${o.value}" class="tab-btn py-1 px-3 rounded">${o.label}</button>`).join('');
            gradeButtons.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => {
                    setActiveButton(gradeButtons, btn.dataset.value);
                    applyGradeFilter();
                });
            });
            setActiveButton(gradeButtons, 'all');
        }

        function loadAchievementTable() {
            const level = getActiveValue(levelButtons);
            const subject = getActiveValue(subjectButtons);
            const md = achievementTables[level]?.[subject];
            if (md) {
                achievementTableContainer.innerHTML = markdownTableToHtml(md);
                makeAchievementTableInteractive();
                applyAchievementStates();
                applyGradeFilter();
            } else {
                achievementTableContainer.innerHTML = '<p class="text-gray-500">ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</p>';
            }
        }

        async function openAchievementView(studentName) {
            const user = auth.currentUser;
            if (!user) return;
            currentAchievementStudent = studentName;
            const docRef = doc(db, 'users', user.uid, 'achievements', studentName);
            const snap = await getDoc(docRef);
            currentAchievementData = snap.exists() ? (snap.data().data || {}) : {};
            document.getElementById('achievement-student').textContent = `${studentName} í•™ìƒ`;
            setActiveButton(levelButtons, 'elementary');
            setActiveButton(subjectButtons, 'korean');
            updateGradeButtons();
            loadAchievementTable();
            switchView('achievement');
        }


        // --- IEP View Logic ---
        const iepStudentList = document.getElementById('iep-student-list');
        const iepOutputContainer = document.getElementById('iep-output');
        let currentIepStudent = '';
        let currentIepDocId = '';
        let isLoadingIepStudents = false;
        let lastKoreanList = [];
        let lastMathList = [];
        let currentIepSemester = 1;
        const lastSemesterGoals = {
            korean: [],
            math: []
        };
        const pageDescriptions = {
            'page-1': '1í˜ì´ì§€(í‘œì§€)',
            'page-2': '2í˜ì´ì§€(ì„±ì·¨ ê¸°ì¤€ - êµ­ì–´)',
            'page-3': '3í˜ì´ì§€(ì„±ì·¨ ê¸°ì¤€ - ìˆ˜í•™)',
            'page-4': '4í˜ì´ì§€(í•™ê¸°ë³„ êµìœ¡ ëª©í‘œ)',
            'page-5': '5í˜ì´ì§€(ì›”ë³„ êµìœ¡ ëª©í‘œ - êµ­ì–´)',
            'page-6': '6í˜ì´ì§€(ì›”ë³„ êµìœ¡ ëª©í‘œ - ìˆ˜í•™)',
            'page-7': '7í˜ì´ì§€(ì›”ë³„ êµìœ¡ ëª©í‘œ - êµ­ì–´)',
            'page-8': '8í˜ì´ì§€(ì›”ë³„ êµìœ¡ ëª©í‘œ - ìˆ˜í•™)',
            'page-9': '9í˜ì´ì§€(ì›”ë³„ êµìœ¡ ëª©í‘œ - êµ­ì–´)',
            'page-10': '10í˜ì´ì§€(ì›”ë³„ êµìœ¡ ëª©í‘œ - ìˆ˜í•™)',
            'page-11': '11í˜ì´ì§€(ì›”ë³„ êµìœ¡ ëª©í‘œ - êµ­ì–´)',
            'page-12': '12í˜ì´ì§€(ì›”ë³„ êµìœ¡ ëª©í‘œ - ìˆ˜í•™)',
            'page-13': '13í˜ì´ì§€(ì›”ë³„ êµìœ¡ ëª©í‘œ - êµ­ì–´)',
            'page-14': '14í˜ì´ì§€(ì›”ë³„ êµìœ¡ ëª©í‘œ - ìˆ˜í•™)',
            'page-15': '15í˜ì´ì§€(í•™ê¸° í‰ê°€)',
            'all': 'ì „ì²´'
        };

        function setBasePageDescriptions() {
            pageDescriptions['page-1'] = '1í˜ì´ì§€(í‘œì§€)';
            pageDescriptions['page-2'] = '2í˜ì´ì§€(ì„±ì·¨ ê¸°ì¤€ - êµ­ì–´)';
            pageDescriptions['page-3'] = '3í˜ì´ì§€(ì„±ì·¨ ê¸°ì¤€ - ìˆ˜í•™)';
            pageDescriptions['page-4'] = '4í˜ì´ì§€(í•™ê¸°ë³„ êµìœ¡ ëª©í‘œ)';
            Object.keys(pageDescriptions).forEach(key => {
                const match = key.match(/^page-(\d+)$/);
                if (!match) return;
                if (Number(match[1]) >= 5) {
                    delete pageDescriptions[key];
                }
            });
        }

        const modifyInput = document.getElementById('iep-modify-input');
        const modifyBtn = document.getElementById('iep-modify-btn');
        const modifyTargetsContainer = document.getElementById('iep-modify-targets');
        const generationSection = document.getElementById('iep-generation-section');
        const saveSection = document.getElementById('iep-save-section');
        const manualEditBtn = document.getElementById('iep-manual-edit-btn');
        const achievementButton = document.getElementById('iep-achievement-btn');
        const generateSemesterBtn = document.getElementById('generate-semester-goals-btn');
        const generateMonthlyBtn = document.getElementById('generate-monthly-plan-btn');
        const saveIepButton = document.getElementById('save-iep-btn');
        const savePdfButton = document.getElementById('save-pdf-btn');
        let currentModifyTarget = 'page-1';
        let manualEditMode = false;
        let manualEditNode = null;

        function getModifyTargetEntries() {
            const entries = [
                { value: 'page-1', label: 'í‘œì§€' },
                { value: 'page-2', label: 'ì„±ì·¨ê¸°ì¤€-êµ­ì–´' },
                { value: 'page-3', label: 'ì„±ì·¨ê¸°ì¤€-ìˆ˜í•™' },
                { value: 'page-4', label: 'í•™ê¸° êµìœ¡ëª©í‘œ' }
            ];
            const contentRoot = document.getElementById('iep-content');
            if (contentRoot) {
                const months = getSemesterMonths(currentIepSemester);
                const monthlyPages = Array.from(contentRoot.querySelectorAll('.iep-page[data-month-index]'));
                monthlyPages.sort((a, b) => {
                    const aPage = Number(a.getAttribute('data-page')) || 0;
                    const bPage = Number(b.getAttribute('data-page')) || 0;
                    return aPage - bPage;
                });
                monthlyPages.forEach(page => {
                    const pageValue = page.getAttribute('data-page');
                    if (!pageValue) return;
                    const monthIdx = Number(page.getAttribute('data-month-index')) || 0;
                    const subjectKey = page.getAttribute('data-subject') || 'korean';
                    const subjectLabel = subjectKey === 'math' ? 'ìˆ˜í•™' : 'êµ­ì–´';
                    const monthLabel = months[monthIdx]?.actual || `${monthIdx + 1}ì›”`;
                    entries.push({ value: `page-${pageValue}`, label: `ì›”(${monthLabel})-${subjectLabel}` });
                });
                const evaluationPage = contentRoot.querySelector('.iep-page[data-semester-evaluation="true"]');
                if (evaluationPage) {
                    const evalPageValue = evaluationPage.getAttribute('data-page');
                    if (evalPageValue) {
                        entries.push({ value: `page-${evalPageValue}`, label: 'í•™ê¸° í‰ê°€' });
                    }
                }
            }
            entries.push({ value: 'all', label: 'ì „ì²´' });
            const seen = new Set();
            return entries.filter(entry => {
                if (!entry.value || seen.has(entry.value)) return false;
                seen.add(entry.value);
                return true;
            });
        }

        function renderModifyTargetButtons() {
            if (!modifyTargetsContainer) return;
            const entries = getModifyTargetEntries();
            if (!entries.length) {
                modifyTargetsContainer.innerHTML = '';
                return;
            }
            if (!entries.some(entry => entry.value === currentModifyTarget)) {
                currentModifyTarget = entries[0].value;
            }
            modifyTargetsContainer.innerHTML = '';
            entries.forEach(entry => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'modify-target-btn';
                btn.dataset.target = entry.value;
                btn.textContent = entry.label;
                if (entry.value === currentModifyTarget) {
                    btn.classList.add('active');
                }
                btn.addEventListener('click', () => handleModifyTargetSelection(entry.value));
                modifyTargetsContainer.appendChild(btn);
            });
        }

        function updateModifyTargetActiveState() {
            if (!modifyTargetsContainer) return;
            modifyTargetsContainer.querySelectorAll('button').forEach(btn => {
                if (btn.dataset.target === currentModifyTarget) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function handleModifyTargetSelection(value) {
            if (manualEditMode) {
                alert('ìˆ˜ë™ í¸ì§‘ì„ ì™„ë£Œí•œ í›„ ë‹¤ë¥¸ í•­ëª©ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
                return;
            }
            currentModifyTarget = value;
            updateModifyTargetActiveState();
        }

        function exitManualEditMode(skipSync = false) {
            if (!manualEditMode) return;
            if (manualEditNode) {
                manualEditNode.removeAttribute('contenteditable');
                manualEditNode.classList.remove('manual-editing');
            }
            manualEditMode = false;
            manualEditNode = null;
            if (manualEditBtn) manualEditBtn.textContent = 'ìˆ˜ë™ í¸ì§‘';
            if (modifyBtn) modifyBtn.disabled = false;
            if (!skipSync) {
                normalizeIepPages(document.getElementById('iep-content'));
                updateMonthlyPageDisplays();
                extractSemesterGoalsFromDom();
            }
        }

        function startManualEdit() {
            if (manualEditMode) return;
            if (!currentModifyTarget) {
                alert('ìˆ˜ì •í•  í•­ëª©ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
                return;
            }
            const contentRoot = document.getElementById('iep-content');
            if (!contentRoot) {
                alert('í¸ì§‘í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            let targetNode = null;
            if (currentModifyTarget === 'all') {
                targetNode = contentRoot;
            } else {
                targetNode = findIepPageNode(currentModifyTarget);
            }
            if (!targetNode) {
                alert('ì„ íƒí•œ í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const editableNode = currentModifyTarget === 'all'
                ? targetNode
                : (targetNode.querySelector('.iep-page-inner') || targetNode);
            manualEditMode = true;
            manualEditNode = editableNode;
            editableNode.setAttribute('contenteditable', 'true');
            editableNode.classList.add('manual-editing');
            if (modifyBtn) modifyBtn.disabled = true;
            if (manualEditBtn) manualEditBtn.textContent = 'ì™„ë£Œ';
            setTimeout(() => {
                try {
                    editableNode.focus();
                } catch (err) {
                    console.warn('Unable to focus editable node', err);
                }
            }, 0);
        }

        manualEditBtn?.addEventListener('click', () => {
            if (manualEditMode) {
                exitManualEditMode();
            } else {
                startManualEdit();
            }
        });

        achievementButton?.addEventListener('click', () => {
            if (manualEditMode) {
                alert('ìˆ˜ë™ í¸ì§‘ì„ ì™„ë£Œí•œ í›„ ì´ë™í•´ ì£¼ì„¸ìš”.');
                return;
            }
            if (currentIepStudent) {
                openAchievementView(currentIepStudent);
            }
        });

        generateSemesterBtn?.addEventListener('click', async () => {
            if (manualEditMode) {
                alert('ìˆ˜ë™ í¸ì§‘ì„ ì™„ë£Œí•œ í›„ ìƒì„± ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.');
                return;
            }
            await generateSemesterGoals(lastKoreanList, lastMathList);
            generateMonthlyBtn?.classList.remove('hidden');
        });

        generateMonthlyBtn?.addEventListener('click', async () => {
            if (manualEditMode) {
                alert('ìˆ˜ë™ í¸ì§‘ì„ ì™„ë£Œí•œ í›„ ìƒì„± ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.');
                return;
            }
            await generateMonthlyPlans(lastKoreanList, lastMathList);
        });

        saveIepButton?.addEventListener('click', async () => {
            if (manualEditMode) {
                alert('ìˆ˜ë™ í¸ì§‘ì„ ì™„ë£Œí•œ í›„ ì €ì¥í•´ ì£¼ì„¸ìš”.');
                return;
            }
            try {
                await handleIepSave();
            } catch (error) {
                console.error('IEP ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
                alert('IEP ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        savePdfButton?.addEventListener('click', () => {
            if (manualEditMode) {
                alert('ìˆ˜ë™ í¸ì§‘ì„ ì™„ë£Œí•œ í›„ PDFë¥¼ ì €ì¥í•´ ì£¼ì„¸ìš”.');
                return;
            }
            saveIepPdf().catch(err => console.error('PDF ì €ì¥ ì‹¤íŒ¨', err));
        });

        async function loadIepStudents() {
            const user = auth.currentUser;
            if (!user || isLoadingIepStudents) return;
            isLoadingIepStudents = true;
            iepStudentList.innerHTML = '<p class="text-gray-500">ë¡œë”© ì¤‘...</p>';
            const classRef = doc(db, 'classes', user.uid);
            try {
                const classSnap = await getDoc(classRef);
                iepStudentList.innerHTML = '';
                if (!classSnap.exists()) {
                    iepStudentList.innerHTML = '<p class="text-gray-500">ìƒì„±ëœ í•™ê¸‰ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }
                const studentIds = classSnap.data().students || [];
                if (studentIds.length === 0) {
                    iepStudentList.innerHTML = '<p class="text-gray-500">í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    for (const sid of studentIds) {
                        try {
                            const sd = await getDoc(doc(db, 'users', sid));
                            if (sd.exists()) {
                                const s = sd.data();
                                const studentEl = document.createElement('div');
                                studentEl.className = 'p-3 border rounded-md cursor-pointer hover:bg-sky-50';
                                studentEl.textContent = s.name || sid;
                                studentEl.addEventListener('click', () => showIepList(s.name || sid));
                                iepStudentList.appendChild(studentEl);
                            }
                        } catch (err) {
                            console.error(err);
                        }
                    }
                }
            } catch (error) {
                iepStudentList.innerHTML = '<p class="text-red-500">í•™ê¸‰ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
            } finally {
                isLoadingIepStudents = false;
            }
        }

        function showModifySection() {
            const section = document.getElementById('iep-modify-section');
            section?.classList.remove('hidden');
            saveSection?.classList.remove('hidden');
            generationSection?.classList.remove('hidden');
            renderModifyTargetButtons();
            updateModifyTargetActiveState();
        }

        function hideModifySection() {
            const section = document.getElementById('iep-modify-section');
            section?.classList.add('hidden');
            saveSection?.classList.add('hidden');
            generationSection?.classList.add('hidden');
            generateMonthlyBtn?.classList.add('hidden');
            exitManualEditMode(true);
            currentModifyTarget = 'page-1';
            if (modifyTargetsContainer) {
                modifyTargetsContainer.innerHTML = '';
            }
        }

        async function showIepList(studentName) {
            currentIepStudent = studentName;
            currentIepDocId = '';
            hideModifySection();
            iepOutputContainer.innerHTML = '<p class="text-gray-500">ë¡œë”© ì¤‘...</p>';
            const user = auth.currentUser;
            if (!user) return;
            const iepRef = collection(db, 'users', user.uid, 'ieps');
            const q = query(iepRef, where('student', '==', studentName), orderBy('createdAt', 'desc'));
            const snap = await getDocs(q);
            let html = `<div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">${studentName} IEP ëª©ë¡</h3><button id="add-iep-btn" class="bg-sky-600 hover:bg-sky-700 text-white text-sm px-3 py-1 rounded">+ì¶”ê°€</button></div>`;
            if (snap.empty) {
                html += '<p class="text-gray-500">IEPê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                html += '<ul class="space-y-2">';
                snap.forEach(doc => {
                    const d = doc.data();
                    const date = d.createdAt?.toDate ? d.createdAt.toDate().toLocaleDateString() : '';
                    html += `<li class="p-2 border rounded flex justify-between items-center hover:bg-sky-50 cursor-pointer" data-id="${doc.id}">
                                <div class="flex flex-col flex-grow">
                                    <span class="iep-title">${d.title}</span>
                                    <span class="text-xs text-gray-500">${date}</span>
                                </div>
                                <div class="flex-shrink-0 space-x-1 ml-2">
                                    <button class="iep-rename-btn text-xs text-sky-600">ì´ë¦„ í¸ì§‘</button>
                                    <button class="iep-copy-btn text-xs text-green-600">ë³µì‚¬</button>
                                    <button class="iep-delete-btn text-xs text-red-600">ì‚­ì œ</button>
                                </div>
                              </li>`;
                });
                html += '</ul>';
            }
            iepOutputContainer.innerHTML = html;
            pageDescriptions['page-1'] = '1í˜ì´ì§€(í‘œì§€)';
            pageDescriptions['page-2'] = '2í˜ì´ì§€(ì„±ì·¨ ê¸°ì¤€ - êµ­ì–´)';
            pageDescriptions['page-3'] = '3í˜ì´ì§€(ì„±ì·¨ ê¸°ì¤€ - ìˆ˜í•™)';
            pageDescriptions['page-4'] = '4í˜ì´ì§€(í•™ê¸°ë³„ êµìœ¡ ëª©í‘œ)';
            document.getElementById('add-iep-btn').addEventListener('click', () => addIep(studentName));
            iepOutputContainer.querySelectorAll('li[data-id]').forEach(el => {
                el.addEventListener('click', (e) => {
                    if (e.target.closest('button')) return;
                    openIepDocument(el.dataset.id, studentName);
                });
            });
            iepOutputContainer.querySelectorAll('.iep-delete-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    const id = btn.closest('li').dataset.id;
                    deleteIep(id, studentName);
                });
            });
            iepOutputContainer.querySelectorAll('.iep-rename-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    const li = btn.closest('li');
                    const id = li.dataset.id;
                    const title = li.querySelector('.iep-title').textContent;
                    renameIep(id, studentName, title);
                });
            });
            iepOutputContainer.querySelectorAll('.iep-copy-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    const id = btn.closest('li').dataset.id;
                    copyIep(id, studentName);
                });
            });
        }

        async function addIep(studentName) {
            const user = auth.currentUser;
            if (!user) return;
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const semester = (month >= 8 || month <= 1) ? 2 : 1;
            const title = `${year}í•™ë…„ë„ ${semester}í•™ê¸° ê°œë³„í™”êµìœ¡ê³„íš(${studentName})`;
            const docRef = await addDoc(collection(db, 'users', user.uid, 'ieps'), {
                student: studentName,
                title,
                createdAt: serverTimestamp(),
                content: ''
            });
            showIepList(studentName);
            openIepDocument(docRef.id, studentName);
        }

        async function deleteIep(id, studentName) {
            const user = auth.currentUser;
            if (!user) return;
            if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            await deleteDoc(doc(db, 'users', user.uid, 'ieps', id));
            showIepList(studentName);
            showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        }

        async function renameIep(id, studentName, oldTitle) {
            const user = auth.currentUser;
            if (!user) return;
            const newTitle = prompt('ìƒˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', oldTitle);
            if (!newTitle || !newTitle.trim()) return;
            await updateDoc(doc(db, 'users', user.uid, 'ieps', id), { title: newTitle.trim() });
            showIepList(studentName);
            showToast('ì´ë¦„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤');
        }

        async function copyIep(id, studentName) {
            const user = auth.currentUser;
            if (!user) return;
            const docRef = doc(db, 'users', user.uid, 'ieps', id);
            const snap = await getDoc(docRef);
            if (!snap.exists()) return;
            const data = snap.data();
            const baseTitle = data.title;
            const iepRef = collection(db, 'users', user.uid, 'ieps');
            const q = query(iepRef, where('student', '==', studentName));
            const all = await getDocs(q);
            let maxCopy = 0;
            all.forEach(d => {
                const match = d.data().title.match(new RegExp(`^${baseTitle} - ë³µì‚¬ë³¸\\((\\d+)\\)$`));
                if (match) {
                    const num = parseInt(match[1]);
                    if (num > maxCopy) maxCopy = num;
                }
            });
            const newTitle = `${baseTitle} - ë³µì‚¬ë³¸(${maxCopy + 1})`;
            const newDoc = await addDoc(iepRef, {
                student: studentName,
                title: newTitle,
                createdAt: serverTimestamp(),
                content: data.content || ''
            });
            showIepList(studentName);
            openIepDocument(newDoc.id, studentName);
            showToast('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        async function openIepDocument(id, studentName) {
            const user = auth.currentUser;
            if (!user) return;
            currentIepDocId = id;
            const docRef = doc(db, 'users', user.uid, 'ieps', id);
            let snap = await getDoc(docRef);
            let data = snap.data();
            if (!data.content) {
                const content = await buildIepContent(studentName);
                await updateDoc(docRef, { content });
                snap = await getDoc(docRef);
                data = snap.data();
            }
            renderIepContent(id, studentName, data);
        }

        function renderIepContent(id, studentName, data) {
            showModifySection();
            currentIepSemester = determineSemesterFromData(data);
            lastSemesterGoals.korean = [];
            lastSemesterGoals.math = [];
            const titleMd = `| **${data.title}** |\n| --- |`;
            let titleHtml = markdownTableToHtml(titleMd)
                .replace('class="min-w-full border border-gray-300 text-sm"', 'class="mx-auto w-auto border border-gray-300 text-xl"')
                .replace('<th class="border px-2 py-1 bg-gray-100">', '<th class="border px-4 py-2 bg-gray-100 text-center text-2xl">');
            const tempWrapper = document.createElement('div');
            tempWrapper.innerHTML = data.content || '';
            tempWrapper.querySelectorAll('.iep-page[data-page="1"]').forEach(node => node.remove());
            upgradeLegacyIepStructure(tempWrapper);
            const storedPagesHtml = tempWrapper.innerHTML;
            const user = auth.currentUser;
            let teacherName = (user?.displayName || '').trim();
            if (!teacherName && user?.email) {
                teacherName = user.email.split('@')[0];
            }
            if (!teacherName) {
                teacherName = 'ë¯¸ê¸°ì¬';
            }
            const html = `
                <div class="iep-pages-wrapper">
                    <div class="iep-cover-actions" id="iep-cover-actions">
                        <button id="edit-iep-title" class="text-sm text-sky-600">í¸ì§‘</button>
                    </div>
                    <div id="iep-content" class="iep-page-collection">
                        <section class="iep-page iep-page-cover" data-page="1">
                            <div id="iep-title">${titleHtml}</div>
                            <div class="iep-cover-footer">íŠ¹ìˆ˜êµì‚¬: <span id="iep-teacher-name">${teacherName}</span></div>
                        </section>
                        ${storedPagesHtml}
                    </div>
                </div>`;
            iepOutputContainer.innerHTML = html;
            normalizeIepPages(document.getElementById('iep-content'));
            const teacherNameNode = document.getElementById('iep-teacher-name');
            if (teacherNameNode) {
                teacherNameNode.textContent = teacherName;
            }
            const months = getSemesterMonths(currentIepSemester);
            setBasePageDescriptions();
            updateMonthlyPageDisplays(months);
            extractSemesterGoalsFromDom();
            const monthlyBtn = document.getElementById('generate-monthly-plan-btn');
            if (monthlyBtn) {
                if (lastSemesterGoals.korean.length || lastSemesterGoals.math.length) {
                    monthlyBtn.classList.remove('hidden');
                } else {
                    monthlyBtn.classList.add('hidden');
                }
            }
            currentModifyTarget = 'page-1';
            updateModifyTargetActiveState();
            const editBtn = document.getElementById('edit-iep-title');
            editBtn.addEventListener('click', () => {
                const container = document.getElementById('iep-title');
                if (editBtn.textContent === 'í¸ì§‘') {
                    const current = container.textContent.trim();
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = current;
                    input.className = 'border rounded p-1 text-sm';
                    container.innerHTML = '';
                    container.appendChild(input);
                    editBtn.textContent = 'ì™„ë£Œ';
                    input.focus();
                    input.addEventListener('keydown', e => { if (e.key === 'Enter') editBtn.click(); });
                } else {
                    const input = container.querySelector('input');
                    const value = input.value.trim() || data.title;
                    const md = `| **${value}** |\n| --- |`;
                    container.innerHTML = markdownTableToHtml(md)
                        .replace('class="min-w-full border border-gray-300 text-sm"', 'class="mx-auto w-auto border border-gray-300 text-xl"')
                        .replace('<th class="border px-2 py-1 bg-gray-100">', '<th class="border px-4 py-2 bg-gray-100 text-center text-2xl">');
                    editBtn.textContent = 'í¸ì§‘';
                }
            });
        }

        async function handleIepSave() {
            const docId = currentIepDocId;
            const studentName = currentIepStudent;
            if (!docId || !studentName) {
                alert('ì €ì¥í•  IEPê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const user = auth.currentUser;
            if (!user) return;
            const titleNode = document.getElementById('iep-title');
            const contentNode = document.getElementById('iep-content');
            if (!titleNode || !contentNode) {
                alert('ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const docRef = doc(db, 'users', user.uid, 'ieps', docId);
            const title = titleNode.textContent.trim();
            const contentClone = contentNode.cloneNode(true);
            const coverPage = contentClone.querySelector('.iep-page-cover');
            if (coverPage) {
                coverPage.parentNode.removeChild(coverPage);
            }
            const content = contentClone.innerHTML;
            await updateDoc(docRef, { title, content });
            showIepList(studentName);
            openIepDocument(docId, studentName);
            alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        async function saveIepPdf() {
            const contentNode = document.getElementById('iep-content');
            if (!contentNode) {
                console.error('IEP ì½˜í…ì¸  ë…¸ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // --- UI ìš”ì†Œ ì¤€ë¹„ ---
            const saveBtn = document.getElementById('save-pdf-btn');
            const actionsContainer = document.getElementById('iep-cover-actions');
            const originalBtnText = saveBtn?.textContent;
            const titleText = document.getElementById('iep-title')?.textContent.trim() || 'ê°œë³„í™”êµìœ¡ê³„íš';
            const filename = `${sanitizeFileName(titleText)}.pdf`;
            const pages = contentNode.querySelectorAll('.iep-page');

            // --- PDF ìƒì„± ì „ ì²˜ë¦¬ ---
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.textContent = 'ì €ì¥ ì¤‘...';
            }
            // ë²„íŠ¼ ìˆ¨ê¸°ê¸° ë° ê·¸ë¦¼ì ì œê±° (PDFì— ë¶ˆí•„ìš”í•œ ìš”ì†Œ ì œê±°)
            if (actionsContainer) actionsContainer.style.display = 'none';
            pages.forEach(page => (page.style.boxShadow = 'none'));

            // --- html2pdf ì˜µì…˜ ì„¤ì • ---
            const opt = {
                margin: 0,
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, scrollY: -window.scrollY },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // --- PDF ìƒì„± ë° ì €ì¥ ---
            try {
                await html2pdf().from(contentNode).set(opt).save();
                showToast('PDF ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('PDF ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
                showToast('PDF ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                // --- PDF ìƒì„± í›„ ì²˜ë¦¬ (ìˆ¨ê²¼ë˜ ìš”ì†Œ ë³µì›) ---
                if (actionsContainer) actionsContainer.style.display = 'flex';
                pages.forEach(page => (page.style.boxShadow = '')); // ì›ë˜ ìŠ¤íƒ€ì¼ë¡œ ë³µì›

                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalBtnText;
                }
            }
        }

        async function applyModification() {
            const instruction = modifyInput.value.trim();
            if (manualEditMode) {
                alert('ìˆ˜ë™ í¸ì§‘ì„ ì™„ë£Œí•œ í›„ ìˆ˜ì • ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.');
                return;
            }
            const target = currentModifyTarget;
            const contentRoot = document.getElementById('iep-content');
            if (!instruction || !currentIepDocId || !contentRoot || !target) return;

            modifyInput.value = '';
            const button = modifyBtn;
            const originalBtnText = button?.textContent;
            if (button) {
                button.disabled = true;
                button.textContent = 'ìˆ˜ì • ì¤‘...';
            }

            try {
                if (target === 'all') {
                    const currentContent = contentRoot.innerHTML;
                    const prompt = `ë‹¤ìŒ ê°œë³„í™”êµìœ¡ê³„íš HTML ì „ì²´ë¥¼ ì‚¬ìš©ìì˜ ìˆ˜ì • ìš”êµ¬ì— ë§ê²Œ ìˆ˜ì •í•´ì¤˜. ì „ì²´ êµ¬ì¡°ì™€ í´ë˜ìŠ¤, data-* ì†ì„±, í‘œ êµ¬ì¡°ëŠ” ìœ ì§€í•˜ê³  ë‹¤ë¥¸ í˜ì´ì§€ê°€ ì‚­ì œë˜ê±°ë‚˜ ìˆœì„œê°€ ë°”ë€Œì§€ ì•Šë„ë¡ í•´ì¤˜.\n\nì›ë³¸:\n${currentContent}\n\nìˆ˜ì • ìš”êµ¬:${instruction}`;
                    let result = await callGemini(prompt);
                    const sanitized = sanitizeAiHtmlResponse(result, currentContent);
                    if (sanitized) {
                        contentRoot.innerHTML = sanitized;
                        normalizeIepPages(contentRoot);
                    }
                    updateMonthlyPageDisplays();
                    extractSemesterGoalsFromDom();
                    return;
                }

                const pageNode = findIepPageNode(target);
                if (!pageNode) {
                    alert('ì„ íƒí•œ í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                const targetText = pageDescriptions[target] || 'ì„ íƒí•œ ì˜ì—­';
                const originalOuter = pageNode.outerHTML;
                const prompt = `ë‹¤ìŒ HTMLì€ ê°œë³„í™”êµìœ¡ê³„íšì˜ '${targetText}' ì˜ì—­ì´ì•¼. HTML êµ¬ì¡°(íƒœê·¸, í´ë˜ìŠ¤, data-* ì†ì„±, id)ë¥¼ ìœ ì§€í•˜ë©´ì„œ ì‚¬ìš©ì ìš”êµ¬ì— ë§ê²Œ í•„ìš”í•œ ë¶€ë¶„ë§Œ ìˆ˜ì •í•´ì¤˜. ë‹¤ë¥¸ í˜ì´ì§€ ë‚´ìš©ì€ í¬í•¨í•˜ì§€ ë§ˆ.\n\nì›ë³¸:\n${originalOuter}\n\nìˆ˜ì • ìš”êµ¬:${instruction}\n\nì‘ë‹µì—ëŠ” ìˆ˜ì •ëœ HTMLë§Œ í¬í•¨í•´ì¤˜.`;
                let result = await callGemini(prompt);
                const sanitized = sanitizeAiHtmlResponse(result, originalOuter);
                if (!sanitized) {
                    return;
                }
                replaceIepPageWithHtml(pageNode, sanitized);
                updateMonthlyPageDisplays();
                extractSemesterGoalsFromDom();
            } catch (error) {
                console.error('ìˆ˜ì • ì ìš© ì¤‘ ì˜¤ë¥˜', error);
                alert('ìˆ˜ì • ë‚´ìš©ì„ ì ìš©í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
            } finally {
                if (button) {
                    button.disabled = false;
                    button.textContent = originalBtnText || 'ìˆ˜ì •';
                }
            }
        }

        function sanitizeAiHtmlResponse(response, fallback) {
            if (typeof response !== 'string') return fallback;
            let text = response.trim();
            text = text.replace(/^```(?:html)?\s*/i, '');
            text = text.replace(/```$/i, '');
            text = text.trim();
            if (!text) return fallback;
            const lines = text.split(/\n+/)
                .map(line => line.trim())
                .filter(line => line && !line.includes('ë‹¤ìŒì€') && !line.includes('ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤') && !line.includes('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤'));
            text = lines.join('\n').trim();
            return text || fallback;
        }

        function normalizeIepPages(root) {
            if (!root) return;
            Array.from(root.children).forEach(page => {
                if (!(page instanceof HTMLElement)) return;
                page.classList.add('iep-page');
                if (!page.classList.contains('iep-page-cover') && !page.querySelector('.iep-page-inner')) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'iep-page-inner';
                    while (page.firstChild) {
                        wrapper.appendChild(page.firstChild);
                    }
                    page.appendChild(wrapper);
                }
            });
        }

        function findIepPageNode(target) {
            if (!target || target === 'all') return null;
            const contentRoot = document.getElementById('iep-content');
            if (!contentRoot) return null;
            const match = target.match(/page-(\d+)/);
            if (!match) return null;
            return contentRoot.querySelector(`.iep-page[data-page="${match[1]}"]`);
        }

        function preservePageAttributes(source, target) {
            const sourceClasses = (source.getAttribute('class') || '').split(/\s+/).filter(Boolean);
            sourceClasses.forEach(cls => {
                if (!target.classList.contains(cls)) {
                    target.classList.add(cls);
                }
            });
            ['data-page', 'data-month-index', 'data-first-month', 'data-second-month', 'data-subject'].forEach(attr => {
                if (source.hasAttribute(attr)) {
                    target.setAttribute(attr, source.getAttribute(attr));
                }
            });
        }

        function replaceIepPageWithHtml(pageNode, html) {
            if (!pageNode || !html) return;
            const trimmed = html.trim();
            const template = document.createElement('template');
            template.innerHTML = trimmed;
            const newSection = template.content.querySelector('section');
            if (newSection) {
                preservePageAttributes(pageNode, newSection);
                pageNode.replaceWith(newSection);
                normalizeIepPages(document.getElementById('iep-content'));
                return;
            }
            pageNode.innerHTML = trimmed;
            normalizeIepPages(document.getElementById('iep-content'));
        }

        modifyBtn.addEventListener('click', applyModification);
        modifyInput.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                await applyModification();
            }
        });

        function sectionTitleTable(text) {
            const md = `| **${text}** |\n| --- |`;
            return markdownTableToHtml(md)
                .replace('class="min-w-full border border-gray-300 text-sm"', 'class="mx-auto w-auto border border-gray-300 text-base"')
                .replace('<th class="border px-2 py-1 bg-gray-100">', '<th class="border px-4 py-2 bg-gray-100 text-center text-lg">');
        }

        function upgradeLegacyIepStructure(wrapper) {
            if (!wrapper) return;
            const semesterPage = wrapper.querySelector('.iep-page[data-page="3"] #korean-goals')?.closest('.iep-page');
            const achievementPage = wrapper.querySelector('.iep-page[data-page="2"]');
            if (!semesterPage || !achievementPage) return;

            const achievementInner = achievementPage.querySelector('.iep-page-inner');
            if (!achievementInner) return;

            const findSubjectBlock = (label) => {
                return Array.from(achievementInner.children).find(child => {
                    if (!(child instanceof HTMLElement)) return false;
                    const heading = child.querySelector('h4');
                    return heading && heading.textContent.includes(label);
                });
            };

            let buttonContainer = achievementInner.querySelector('#iep-achievement-btn')?.parentElement;
            if (!buttonContainer) {
                buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex justify-end';
                const btn = document.createElement('button');
                btn.id = 'iep-achievement-btn';
                btn.className = 'text-sky-600 hover:underline text-sm';
                btn.textContent = 'ì„±ì·¨ ê¸°ì¤€ ì´ë™';
                buttonContainer.appendChild(btn);
            }

            const koreanBlock = findSubjectBlock('êµ­ì–´');
            const mathBlock = findSubjectBlock('ìˆ˜í•™');

            achievementInner.innerHTML = '';
            achievementInner.insertAdjacentHTML('beforeend', sectionTitleTable('1. í•™ìŠµì´ í•„ìš”í•œ ì„±ì·¨ ê¸°ì¤€ - êµ­ì–´'));
            achievementInner.appendChild(buttonContainer);

            if (koreanBlock) {
                const heading = koreanBlock.querySelector('h4');
                if (heading) heading.textContent = 'êµ­ì–´';
                achievementInner.appendChild(koreanBlock);
            } else {
                const fallback = document.createElement('div');
                fallback.innerHTML = '<h4 class="font-semibold">êµ­ì–´</h4><p class="text-gray-500">í•™ìŠµì´ í•„ìš”í•œ ì„±ì·¨ê¸°ì¤€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                achievementInner.appendChild(fallback);
            }

            const mathPage = document.createElement('section');
            mathPage.className = 'iep-page';
            mathPage.setAttribute('data-page', '3');
            const mathInner = document.createElement('div');
            mathInner.className = 'iep-page-inner';
            mathInner.insertAdjacentHTML('beforeend', sectionTitleTable('1. í•™ìŠµì´ í•„ìš”í•œ ì„±ì·¨ ê¸°ì¤€ - ìˆ˜í•™'));
            if (mathBlock) {
                const heading = mathBlock.querySelector('h4');
                if (heading) heading.textContent = 'ìˆ˜í•™';
                mathInner.appendChild(mathBlock);
            } else {
                const fallback = document.createElement('div');
                fallback.innerHTML = '<h4 class="font-semibold">ìˆ˜í•™</h4><p class="text-gray-500">í•™ìŠµì´ í•„ìš”í•œ ì„±ì·¨ê¸°ì¤€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                mathInner.appendChild(fallback);
            }
            mathPage.appendChild(mathInner);
            achievementPage.insertAdjacentElement('afterend', mathPage);

            semesterPage.setAttribute('data-page', '4');

            const monthlyPages = Array.from(wrapper.querySelectorAll('.iep-page[data-page]'))
                .filter(page => page !== semesterPage && Number(page.getAttribute('data-page')) >= 4)
                .sort((a, b) => Number(a.getAttribute('data-page')) - Number(b.getAttribute('data-page')));
            monthlyPages.forEach((page, idx) => {
                page.setAttribute('data-page', String(5 + idx));
            });
        }

        async function buildIepContent(studentName) {
            const user = auth.currentUser;
            if (!user) return '';
            const docRef = doc(db, 'users', user.uid, 'achievements', studentName);
            const snap = await getDoc(docRef);
            const data = snap.exists() ? (snap.data().data || {}) : {};
            const koreanList = collectYellowAchievements(data, 'korean');
            const mathList = collectYellowAchievements(data, 'math');
            lastKoreanList = koreanList;
            lastMathList = mathList;
            const now = new Date();
            const month = now.getMonth() + 1;
            const defaultSemester = (month >= 8 || month <= 1) ? 2 : 1;
            const months = getSemesterMonths(defaultSemester);
            const monthlyPages = months.map((info, idx) => {
                const monthDisplay = buildMonthlyDisplayText(info);
                const monthPrefix = monthDisplay ? `${monthDisplay} ` : '';
                const basePageNumber = 5 + idx * 2;
                const firstAttr = info.first ? ` data-first-month="${info.first}"` : '';
                const secondAttr = info.second ? ` data-second-month="${info.second}"` : '';
                const buildSubjectPage = (subjectKey, subjectLabel, pageNumber) => `
                <section class="iep-page" data-page="${pageNumber}" data-month-index="${idx}" data-subject="${subjectKey}"${firstAttr}${secondAttr}>
                    <div class="iep-page-inner">
                        <div class="iep-month-block" data-month-index="${idx}">
                            <div class="iep-month-subject" data-subject="${subjectKey}">
                                ${sectionTitleTable(`3. ì›”ë³„ êµìœ¡ëª©í‘œ - ${monthPrefix}${subjectLabel}`)}
                                <div id="monthly-plan-${idx}-${subjectKey}" class="iep-month-content mt-4"><p class="text-sm text-gray-500">ì›”ë³„ ê³„íšì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p></div>
                            </div>
                        </div>
                    </div>
                </section>`;
                return [
                    buildSubjectPage('korean', 'êµ­ì–´', basePageNumber),
                    buildSubjectPage('math', 'ìˆ˜í•™', basePageNumber + 1)
                ].join('');
            }).join('');
            const evaluationPageNumber = 5 + months.length * 2;
            const semesterEvaluationPage = `
                <section class="iep-page" data-page="${evaluationPageNumber}" data-semester-evaluation="true">
                    <div class="iep-page-inner">
                        ${sectionTitleTable('4. í•™ê¸° í‰ê°€')}
                        <div class="space-y-6">
                            <div class="iep-semester-evaluation-subject" data-subject="korean">
                                <h4 class="font-semibold">ê°€. êµ­ì–´</h4>
                                ${buildSemesterEvaluationTable()}
                            </div>
                            <div class="iep-semester-evaluation-subject" data-subject="math">
                                <h4 class="font-semibold">ë‚˜. ìˆ˜í•™</h4>
                                ${buildSemesterEvaluationTable()}
                            </div>
                        </div>
                    </div>
                </section>`;
            return `
                <section class="iep-page" data-page="2">
                    <div class="iep-page-inner">
                        ${sectionTitleTable('1. í•™ìŠµì´ í•„ìš”í•œ ì„±ì·¨ ê¸°ì¤€ - êµ­ì–´')}
                        <div>
                            <h4 class="font-semibold">êµ­ì–´</h4>
                            ${buildAchievementTable(koreanList)}
                        </div>
                    </div>
                </section>
                <section class="iep-page" data-page="3">
                    <div class="iep-page-inner">
                        ${sectionTitleTable('1. í•™ìŠµì´ í•„ìš”í•œ ì„±ì·¨ ê¸°ì¤€ - ìˆ˜í•™')}
                        <div>
                            <h4 class="font-semibold">ìˆ˜í•™</h4>
                            ${buildAchievementTable(mathList)}
                        </div>
                    </div>
                </section>
                <section class="iep-page" data-page="4">
                    <div class="iep-page-inner">
                        ${sectionTitleTable('2. í•™ê¸°ë³„ êµìœ¡ ëª©í‘œ')}
                        <div>
                            <h4 class="font-semibold">ê°€. êµ­ì–´</h4>
                            <div id="korean-goals"></div>
                        </div>
                        <div>
                            <h4 class="font-semibold">ë‚˜. ìˆ˜í•™</h4>
                            <div id="math-goals"></div>
                        </div>
                    </div>
                </section>
                ${monthlyPages}
                ${semesterEvaluationPage}
            `;
        }

        function buildAchievementTable(list) {
            if (!list.length) {
                return '<p class="text-gray-500">í•™ìŠµì´ í•„ìš”í•œ ì„±ì·¨ê¸°ì¤€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
            let html = '<table class="w-full border border-gray-300 text-sm"><thead><tr><th class="border px-2 py-1">í•™ë…„(êµ°)</th><th class="border px-2 py-1">ì„±ì·¨ê¸°ì¤€</th></tr></thead><tbody>';
            list.forEach(item => {
                html += `<tr><td class="border px-2 py-1">${item.grade}</td><td class="border px-2 py-1">${item.text}</td></tr>`;
            });
            html += '</tbody></table>';
            return html;
        }

        function collectYellowAchievements(data, subject) {
            const result = [];
            for (const level of Object.keys(achievementTables)) {
                const table = achievementTables[level]?.[subject];
                if (!table) continue;
                const key = `${level}_${subject}`;
                const states = data[key] || [];
                const temp = document.createElement('div');
                temp.innerHTML = markdownTableToHtml(table);
                const rows = temp.querySelectorAll('tbody tr');
                rows.forEach((tr, rowIdx) => {
                    const grade = tr.cells[0].textContent.trim();
                    for (let i = 1; i < tr.cells.length; i++) {
                        if (states[rowIdx]?.[i - 1] === 1) {
                            const text = tr.cells[i].textContent.trim();
                            result.push({ grade, text });
                        }
                    }
                });
            }
            return result;
        }

        async function callGemini(prompt, json = false) {
            const payload = { contents: [{ role: 'user', parts: [{ text: prompt }] }], generationConfig: json ? { responseMimeType: 'application/json' } : {} };
            try {
                const response = await fetch('/.netlify/functions/gemini-handler', { method: 'POST', body: JSON.stringify(payload) });
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || '';
                if (json) return JSON.parse(text);
                return text;
            } catch (e) {
                console.error('AI error', e);
                return json ? {} : '';
            }
        }

        function determineSemesterFromData(data) {
            let month = null;
            const createdAt = data?.createdAt;
            if (createdAt?.toDate) {
                month = createdAt.toDate().getMonth() + 1;
            } else if (createdAt?.seconds) {
                month = new Date(createdAt.seconds * 1000).getMonth() + 1;
            }
            if (!month) {
                const match = data?.title?.match(/([12])í•™ê¸°/);
                if (match) {
                    return parseInt(match[1], 10);
                }
                month = new Date().getMonth() + 1;
            }
            if (month >= 2 && month <= 7) return 1;
            return 2;
        }

        function getSemesterMonths(semester) {
            const templates = [
                { label: 'ê°€', first: '3ì›”', second: '8ì›”' },
                { label: 'ë‚˜', first: '4ì›”', second: '9ì›”' },
                { label: 'ë‹¤', first: '5ì›”', second: '10ì›”' },
                { label: 'ë¼', first: '6ì›”', second: '11ì›”' },
                { label: 'ë§ˆ', first: '7ì›”', second: '12ì›”' }
            ];
            const isFirstSemester = semester === 1;
            return templates.map(template => {
                const actual = isFirstSemester ? template.first : template.second;
                const alternate = isFirstSemester ? template.second : template.first;
                const displayText = actual || '';
                return { ...template, actual, alternate, displayText };
            });
        }

        function buildMonthlyDisplayText(info) {
            if (!info) return '';
            if (info.displayText) return info.displayText;
            return info.actual || '';
        }

        function updateMonthlyPageDisplays(monthsArg) {
            const months = Array.isArray(monthsArg) ? monthsArg : getSemesterMonths(currentIepSemester);
            const contentRoot = document.getElementById('iep-content');
            const subjects = [
                { key: 'korean', label: 'êµ­ì–´' },
                { key: 'math', label: 'ìˆ˜í•™' }
            ];
            setBasePageDescriptions();
            months.forEach((info, idx) => {
                const displayText = buildMonthlyDisplayText(info);
                const monthPrefix = displayText ? `${displayText} ` : '';
                subjects.forEach((subject, subjectIdx) => {
                    const pageNumber = 5 + idx * subjects.length + subjectIdx;
                    pageDescriptions[`page-${pageNumber}`] = `${pageNumber}í˜ì´ì§€(ì›”ë³„ êµìœ¡ ëª©í‘œ - ${monthPrefix}${subject.label})`;
                    if (!contentRoot) return;
                    const selector = `.iep-page[data-month-index="${idx}"][data-subject="${subject.key}"]`;
                    const monthSection = contentRoot.querySelector(selector);
                    if (!monthSection) return;
                    monthSection.setAttribute('data-page', String(pageNumber));
                    monthSection.setAttribute('data-month-index', String(idx));
                    monthSection.setAttribute('data-subject', subject.key);
                    if (info.first) {
                        monthSection.setAttribute('data-first-month', info.first);
                    } else {
                        monthSection.removeAttribute('data-first-month');
                    }
                    if (info.second) {
                        monthSection.setAttribute('data-second-month', info.second);
                    } else {
                        monthSection.removeAttribute('data-second-month');
                    }
                    const block = monthSection.querySelector('.iep-month-block');
                    if (block) {
                        block.setAttribute('data-month-index', String(idx));
                    }
                    const subjectSection = monthSection.querySelector('.iep-month-subject');
                    if (subjectSection) {
                        subjectSection.setAttribute('data-subject', subject.key);
                        const headingStrong = subjectSection.querySelector('table thead th strong');
                        if (headingStrong) {
                            headingStrong.textContent = `3. ì›”ë³„ êµìœ¡ëª©í‘œ - ${monthPrefix}${subject.label}`;
                        }
                        const content = subjectSection.querySelector('.iep-month-content');
                        if (content) {
                            const expectedId = `monthly-plan-${idx}-${subject.key}`;
                            if (content.id !== expectedId) {
                                content.id = expectedId;
                            }
                        }
                    }
                });
            });
            const evaluationPageNumber = 5 + months.length * subjects.length;
            pageDescriptions[`page-${evaluationPageNumber}`] = `${evaluationPageNumber}í˜ì´ì§€(í•™ê¸° í‰ê°€)`;
            renderModifyTargetButtons();
            updateModifyTargetActiveState();
        }

        function sanitizeFileName(text) {
            return (text || '').replace(/[\\/:*?"<>|]/g, ' ').replace(/\s+/g, ' ').trim();
        }

        async function generateSubjectMonthlyPlans(subject, months) {
            const semesterGoals = lastSemesterGoals[subject.key] || [];
            if (!semesterGoals.length) return [];
            const monthLabels = months.map(m => m.actual);
            const achievementText = subject.list.length
                ? subject.list.map((item, idx) => `${idx + 1}. ${item.text}`).join('\n')
                : 'ê´€ë ¨ ì„±ì·¨ê¸°ì¤€ ì •ë³´ ì—†ìŒ';
            const prompt = `ë„ˆëŠ” íŠ¹ìˆ˜êµìœ¡ êµì‚¬ë¥¼ ë•ëŠ” ì „ë¬¸ê°€ì•¼. ì•„ë˜ ì •ë³´ë¥¼ ì°¸ê³ í•˜ì—¬ ${subject.name} êµê³¼ì˜ ì›”ë³„ ê³„íšì„ JSON ë°°ì—´ë¡œ ì‘ì„±í•´ì¤˜.\n\n- í•™ê¸°: ${currentIepSemester}í•™ê¸°\n- ì›” ëª©ë¡: ${monthLabels.join(', ')}\n- í•™ê¸° êµìœ¡ëª©í‘œ:\n${semesterGoals.map((goal, idx) => `${idx + 1}. ${goal}`).join('\n')}\n- ì°¸ê³  ì„±ì·¨ê¸°ì¤€:\n${achievementText}\n\nìš”êµ¬ì‚¬í•­:\n1. í•™ê¸° êµìœ¡ëª©í‘œì˜ í•µì‹¬ì„ ìˆœì„œëŒ€ë¡œ ${monthLabels.length}ê°œì˜ ì›”ë³„ êµìœ¡ëª©í‘œë¡œ ë‚˜ëˆ„ì–´ ì œì‹œí•œë‹¤. í•„ìš”í•œ ê²½ìš° ë¬¸ì¥ì„ ë¶„í• í•˜ê±°ë‚˜ í†µí•©í•˜ë˜ ëª¨ë“  í•™ê¸° ëª©í‘œ ë‚´ìš©ì´ ì›”ë³„ ëª©í‘œì— ë°˜ì˜ë˜ì–´ì•¼ í•œë‹¤.\n2. ê° ì›”ë³„ ê³„íšì˜ goal, content, method ê°’ì€ ë¶ˆë¦¿ í¬ì¸íŠ¸ í˜•ì‹ì˜ ë¬¸ìì—´ë¡œ ì‘ì„±í•œë‹¤. ë¶ˆë¦¿ì€ ë°˜ë“œì‹œ 'â—‹ 'ë¡œ ì‹œì‘í•˜ê³  ë¬¸ì¥ë§ˆë‹¤ ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„í•œë‹¤.\n3. goal í•­ëª©ì€ 2ë¬¸ì¥ ì´ìƒ, contentì™€ method í•­ëª©ì€ ê°ê° 3ë¬¸ì¥ ì´ìƒìœ¼ë¡œ ì‘ì„±í•œë‹¤.\n4. evaluation í•­ëª©ì„ í¬í•¨í•˜ì—¬ ê° ì›” í‰ê°€ ê¸°ì¤€ì„ ì‘ì„±í•œë‹¤. í‰ê°€ í•­ëª©ì€ 3ë¬¸ì¥ìœ¼ë¡œ êµ¬ì„±í•˜ê³  ê° ë¬¸ì¥ì€ 'â—‹ 'ë¡œ ì‹œì‘í•˜ë©° ë¬¸ì¥ ëì€ ì°¨ë¡€ëŒ€ë¡œ '~ê°€', '~í•˜ëŠ”ê°€', '~ëŠ”ê°€'ë¡œ ëë‚˜ì•¼ í•œë‹¤.\n5. content í•­ëª©ì˜ ëª¨ë“  ë¬¸ì¥ì€ ë§ˆì¹¨í‘œ ì—†ì´ '~ê¸°' í˜•íƒœ(ì˜ˆ: ...í•˜ê¸°, ...ì“°ê¸°)ë¡œ ëë‚˜ë„ë¡ ì‘ì„±í•œë‹¤.\n6. ëª¨ë“  ë¬¸ì¥ì€ ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ë¡œ ì‘ì„±í•œë‹¤.\n7. ì‘ë‹µì€ ë°˜ë“œì‹œ JSON ë°°ì—´ë§Œìœ¼ë¡œ ì œê³µí•˜ê³  ë‹¤ë¥¸ ì„¤ëª…ì€ í¬í•¨í•˜ì§€ ì•ŠëŠ”ë‹¤.\n8. ë°°ì—´ì˜ ê° ìš”ì†ŒëŠ” {"month":"${monthLabels[0]}","goal":"...","content":"...","method":"...","evaluation":"..."} í˜•ì‹ì„ ë”°ë¥´ë©°, month ê°’ì€ ì›” ëª©ë¡ê³¼ ì •í™•íˆ ì¼ì¹˜í•˜ê³  ìˆœì„œë¥¼ ìœ ì§€í•´ì•¼ í•œë‹¤.`;
            const result = await callGemini(prompt, true);
            let plans = [];
            if (Array.isArray(result)) {
                plans = result;
            } else if (Array.isArray(result?.plans)) {
                plans = result.plans;
            }
            return monthLabels.map((month, idx) => {
                const plan = plans.find(p => p.month === month) || plans[idx] || {};
                return {
                    goal: formatMonthlyGoalText(plan.goal || ''),
                    content: formatMonthlyContentText(plan.content || ''),
                    method: formatMonthlyMethodText(plan.method || ''),
                    evaluation: formatMonthlyEvaluationText(plan.evaluation || '')
                };
            });
        }

        function buildMonthlyTables(month, subjectName, entry) {
            const goal = formatTableCell(entry.goal);
            const content = formatTableCell(entry.content);
            const method = formatTableCell(entry.method);
            const evaluation = formatTableCell(entry.evaluation || '');
            return `
                <table class="monthly-plan-table text-base">
                    <tbody>
                        <tr>
                            <th class="monthly-plan-title" colspan="2">${month} ${subjectName}</th>
                        </tr>
                        <tr>
                            <th class="monthly-plan-section-header">êµìœ¡ ëª©í‘œ</th>
                            <th class="monthly-plan-section-header">êµìœ¡ ë‚´ìš©</th>
                        </tr>
                        <tr>
                            <td class="data-cell">${goal}</td>
                            <td class="data-cell">${content}</td>
                        </tr>
                        <tr>
                            <th class="monthly-plan-section-header">êµìœ¡ ë°©ë²•</th>
                            <th class="monthly-plan-section-header">êµìœ¡ í‰ê°€</th>
                        </tr>
                        <tr>
                            <td class="data-cell">${method}</td>
                            <td class="data-cell">${evaluation}</td>
                        </tr>
                        <tr>
                            <th class="monthly-plan-footer" colspan="2">ì›” í‰ê°€</th>
                        </tr>
                        <tr>
                            <td class="monthly-plan-empty" colspan="2">&nbsp;</td>
                        </tr>
                    </tbody>
                </table>
            `.trim();
        }

        function buildSemesterEvaluationTable() {
            return `
                <table class="w-full border border-gray-300 text-sm semester-evaluation-table">
                    <thead>
                        <tr>
                            <th class="border px-2 py-2 bg-gray-100 text-center">í‰ê°€</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="border px-2 py-10 align-top">&nbsp;</td>
                        </tr>
                    </tbody>
                </table>
            `.trim();
        }

        function formatTableCell(text) {
            if (!text) return '&nbsp;';
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\n/g, '<br>');
        }

        function splitMonthlySentences(text) {
            if (!text) return [];
            const cleaned = text
                .replace(/\r/g, '\n')
                .replace(/^\s*[-*â€¢â—â—‹]\s*/gm, '')
                .replace(/^\s*\d+[.)]\s*/gm, '');
            const newlineParts = cleaned
                .split(/\n+/)
                .map(part => part.trim())
                .filter(Boolean);
            if (newlineParts.length > 1) {
                return newlineParts;
            }
            const normalized = cleaned.replace(/\s+/g, ' ').trim();
            if (!normalized) return [];
            const sentences = [];
            const regex = /[^.!?]+[.!?]?/g;
            let match;
            while ((match = regex.exec(normalized)) !== null) {
                const sentence = (match[0] || '').trim();
                if (sentence) sentences.push(sentence);
            }
            return sentences.length ? sentences : [normalized];
        }

        function ensureBulletString(text, { minCount = 1, endingMode = 'period' } = {}) {
            let sentences = splitMonthlySentences(text);
            if (sentences.length && sentences.length < minCount) {
                const expanded = [];
                sentences.forEach(sentence => {
                    const fragments = sentence
                        .split(/[,;Â·]/)
                        .map(fragment => fragment.trim())
                        .filter(fragment => fragment.length > 0);
                    if (fragments.length > 1) {
                        expanded.push(...fragments);
                    } else {
                        expanded.push(sentence);
                    }
                });
                if (expanded.length > sentences.length) {
                    sentences = expanded;
                }
            }
            const bullets = sentences.map(sentence => {
                let trimmed = sentence.trim();
                trimmed = trimmed.replace(/^[-*â€¢â—â—‹]\s*/, '').replace(/^\d+[.)]\s*/, '').trim();
                trimmed = trimmed.replace(/\s+/g, ' ');
                if (!trimmed) return null;
                if (endingMode === 'gerund') {
                    trimmed = trimmed.replace(/[.!?]\s*$/, '');
                    trimmed = trimmed.replace(/ê¸°\s*(?:í•œë‹¤|í•©ë‹ˆë‹¤|í•¨)?$/, 'ê¸°');
                    trimmed = trimmed.replace(/ê¸°\s*(?:í•œë‹¤|í•©ë‹ˆë‹¤|í•¨)?$/, 'ê¸°');
                    trimmed = trimmed.replace(/í•œë‹¤$/, 'í•œë‹¤').replace(/í•©ë‹ˆë‹¤$/, 'í•˜ê¸°');
                    trimmed = trimmed.trim();
                } else if (endingMode === 'none') {
                    trimmed = trimmed.replace(/[.!?]\s*$/, '');
                    trimmed = trimmed.trim();
                } else {
                    trimmed = trimmed.replace(/[.!?]\s*$/, '');
                    trimmed = `${trimmed}.`;
                }
                return `â—‹ ${trimmed}`;
            }).filter(Boolean);

            if (!bullets.length) {
                let fallback = (text || '').replace(/^\s*[-*â€¢â—â—‹]\s*/gm, '').trim();
                if (!fallback) return '';
                fallback = fallback.replace(/[.!?]\s*$/, '');
                fallback = fallback.replace(/\s+/g, ' ');
                if (endingMode === 'gerund') {
                    fallback = fallback.replace(/ê¸°\s*(?:í•œë‹¤|í•©ë‹ˆë‹¤|í•¨)?$/, 'ê¸°');
                    fallback = fallback.replace(/ê¸°\s*(?:í•œë‹¤|í•©ë‹ˆë‹¤|í•¨)?$/, 'ê¸°');
                    fallback = fallback.replace(/í•œë‹¤$/, 'í•œë‹¤').replace(/í•©ë‹ˆë‹¤$/, 'í•˜ê¸°');
                }
                const sentence = endingMode === 'gerund'
                    ? fallback
                    : endingMode === 'none'
                        ? fallback
                        : `${fallback}.`;
                const bulletLine = `â—‹ ${sentence}`;
                return Array.from({ length: Math.max(minCount, 1) }, () => bulletLine).join('\n');
            }

            if (bullets.length < minCount) {
                const last = bullets[bullets.length - 1];
                while (bullets.length < minCount) {
                    bullets.push(last);
                }
            }
            return bullets.join('\n');
        }

        function formatMonthlyGoalText(text) {
            return ensureBulletString(text, { minCount: 2, endingMode: 'period' });
        }

        function formatMonthlyContentText(text) {
            return ensureBulletString(text, { minCount: 3, endingMode: 'gerund' });
        }

        function formatMonthlyMethodText(text) {
            const bulletText = ensureBulletString(text, { minCount: 3, endingMode: 'period' });
            return enforceMethodSentenceEndings(bulletText);
        }

        function formatMonthlyEvaluationText(text) {
            const endings = ['ê°€', 'í•˜ëŠ”ê°€', 'ëŠ”ê°€'];
            const defaults = [
                'â—‹ í•™ìŠµ ëª©í‘œ ë‹¬ì„± ì—¬ë¶€ê°€',
                'â—‹ ìˆ˜ì—… ì°¸ì—¬ í–‰ë™ì„ ì§€ì†í•˜ëŠ”ê°€',
                'â—‹ í•™ìŠµ ë‚´ìš©ì„ ì‹¤ì œë¡œ ì´í•´í–ˆëŠ”ê°€'
            ];
            const bulletText = ensureBulletString(text, { minCount: endings.length, endingMode: 'none' });
            const lines = (bulletText ? bulletText.split('\n') : [])
                .map(line => line.trim())
                .filter(Boolean);
            const normalized = [];
            for (let i = 0; i < endings.length; i++) {
                const ending = endings[i];
                let sourceLine = lines[i] || lines[lines.length - 1] || '';
                if (!sourceLine) {
                    normalized.push(defaults[i] || `â—‹ í‰ê°€ ë¬¸ì¥${i + 1}${ending}`);
                    continue;
                }
                const match = sourceLine.match(/^(â—‹\s*)(.*)$/);
                const prefix = match ? match[1] : 'â—‹ ';
                let sentence = match ? match[2].trim() : sourceLine.replace(/^[-*â€¢â—]\s*/, '').trim();
                if (!sentence) {
                    normalized.push(defaults[i] || `â—‹ í‰ê°€ ë¬¸ì¥${i + 1}${ending}`);
                    continue;
                }
                sentence = sentence.replace(/[.!?]\s*$/, '');
                sentence = sentence.replace(/\s+/g, ' ').trim();
                if (!sentence.endsWith(ending)) {
                    sentence = sentence.replace(/(ì¸ê°€ìš”?|ì¸ê°€|ì¸ì§€|í•œê°€ìš”?|í•œê°€|í•˜ëŠ”ê°€ìš”?|í•˜ëŠ”ì§€|ëŠ”ê°€ìš”?|ëŠ”ì§€|ìˆ˜ ìˆëŠ”ê°€ìš”?|ìˆ˜ ìˆëŠ”ê°€|ìˆ˜ ìˆëŠ”ì§€|ê°€ëŠ¥í•œê°€ìš”?|ê°€ëŠ¥í•œê°€|ê°€ëŠ¥í•œì§€|ë  ìˆ˜ ìˆëŠ”ê°€|ë  ìˆ˜ ìˆëŠ”ì§€|ë˜ëŠ”ì§€)\s*$/, '').trim();
                    if (!sentence.endsWith(ending)) {
                        if (sentence.endsWith('ê°€') && ending !== 'ê°€') {
                            sentence = sentence.slice(0, -1);
                        }
                        sentence = `${sentence}${ending}`;
                    }
                }
                normalized.push(`${prefix}${sentence}`);
            }
            return normalized.join('\n');
        }

        function enforceMethodSentenceEndings(text) {
            if (!text) return text;
            const lines = text.split('\n');
            return lines.map(line => {
                const match = line.match(/^(\s*â—‹\s*)(.*)$/);
                if (!match) return line;
                const prefix = match[1];
                let sentence = match[2].trim();
                if (!sentence) return line;
                sentence = sentence.replace(/[.!?]\s*$/, '');
                sentence = sentence.replace(/ê¸°ë¡œ\s*(?:í•œë‹¤|í•©ë‹ˆë‹¤|í•¨|í•  ì˜ˆì •ì´ë‹¤|í•  ê³„íšì´ë‹¤|í•  ì˜ˆì •ì„|í•  ê³„íšì„)?$/, 'í•œë‹¤');
                sentence = sentence.replace(/ê¸°\s*(?:í•œë‹¤|í•©ë‹ˆë‹¤|í•¨|í•  ì˜ˆì •ì´ë‹¤|í•  ê³„íšì´ë‹¤|í•  ì˜ˆì •ì„|í•  ê³„íšì„)?$/, 'í•œë‹¤');
                sentence = sentence.replace(/í•˜ë„ë¡ ì§€ë„$/, 'í•˜ë„ë¡ ì§€ë„í•œë‹¤');
                sentence = sentence.replace(/ì§€ì›$/, 'ì§€ì›í•œë‹¤');
                sentence = sentence.replace(/ì§€ë„$/, 'ì§€ë„í•œë‹¤');
                if (!/ë‹¤$/.test(sentence)) {
                    sentence = sentence.replace(/í•˜$/, 'í•œë‹¤');
                }
                if (!/ë‹¤$/.test(sentence)) {
                    sentence += 'í•œë‹¤';
                }
                sentence = sentence.replace(/ë‹¤$/, 'ë‹¤.');
                return `${prefix}${sentence}`;
            }).join('\n');
        }

        function extractSemesterGoalsFromDom() {
            const subjects = [
                { key: 'korean', selector: '#korean-goals table tbody tr td' },
                { key: 'math', selector: '#math-goals table tbody tr td' }
            ];
            subjects.forEach(({ key, selector }) => {
                const cells = Array.from(document.querySelectorAll(selector));
                lastSemesterGoals[key] = cells.map(cell => cell.textContent.trim()).filter(Boolean);
            });
        }

        async function generateSemesterGoals(koreanList, mathList) {
            const subjects = [
                { name: 'êµ­ì–´', list: koreanList, targetId: 'korean-goals', key: 'korean' },
                { name: 'ìˆ˜í•™', list: mathList, targetId: 'math-goals', key: 'math' }
            ];
            for (const { name, list, targetId, key } of subjects) {
                const target = document.getElementById(targetId);
                lastSemesterGoals[key] = [];
                if (!list.length) {
                    target.innerHTML = '<p class="text-gray-500">í•™ìŠµì´ í•„ìš”í•œ ì„±ì·¨ê¸°ì¤€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    continue;
                }
                target.innerHTML = '<p class="text-gray-500">ìƒì„± ì¤‘...</p>';
                const prompt = `ë‹¤ìŒ ì„±ì·¨ê¸°ì¤€ì„ ë°”íƒ•ìœ¼ë¡œ ${name} êµê³¼ì˜ í•™ê¸° êµìœ¡ëª©í‘œë¥¼ 1~5ê°œì˜ ë¬¸ì¥ìœ¼ë¡œ ì‘ì„±í•´ì¤˜. ê° ë¬¸ì¥ì€ 'ë‹¤.' í˜¹ì€ 'í•œë‹¤.'ë¡œ ëë‚˜ë„ë¡ í•˜ê³  ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„í•´ì¤˜. ê° ë¬¸ì¥ ì•ì—ëŠ” ìˆ«ìë‚˜ ê¸°í˜¸ë¥¼ ë¶™ì´ì§€ ë§ˆ.\n\nì„±ì·¨ê¸°ì¤€:\n${list.map((item, idx) => `${idx + 1}. ${item.text}`).join('\n')}`;
                const result = await callGemini(prompt);
                const lines = result
                    .split(/\n+/)
                    .map(l => l.trim())
                    .filter(Boolean)
                    .filter(line => !line.startsWith('ë‹¤ìŒì€'))
                    .map(line => line.replace(/^[-â€¢\d]+[.)]?\s*/, ''))
                    .slice(0, 5);
                lastSemesterGoals[key] = lines;
                if (!lines.length) {
                    target.innerHTML = '<p class="text-gray-500">í•™ê¸° êµìœ¡ëª©í‘œë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</p>';
                    continue;
                }
                let md = `| ${name} í•™ê¸° êµìœ¡ëª©í‘œ |\n| --- |\n`;
                lines.forEach(line => { md += `| ${line} |\n`; });
                target.innerHTML = markdownTableToHtml(md);
            }
            document.querySelectorAll('.iep-month-content').forEach(node => {
                node.innerHTML = '<p class="text-gray-500 text-sm">ì›”ë³„ ê³„íšì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>';
            });
        }

        async function generateMonthlyPlans(koreanList, mathList) {
            const months = getSemesterMonths(currentIepSemester);
            updateMonthlyPageDisplays(months);
            if (!months.length) {
                document.querySelectorAll('.iep-month-content').forEach(node => {
                    node.innerHTML = '<p class="text-gray-500 text-sm">ì›” ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
                });
                return;
            }
            const subjects = [
                { name: 'êµ­ì–´', key: 'korean', list: koreanList },
                { name: 'ìˆ˜í•™', key: 'math', list: mathList }
            ];
            const containersByMonth = {};
            months.forEach((_, idx) => {
                containersByMonth[idx] = {};
                subjects.forEach(subject => {
                    const container = document.getElementById(`monthly-plan-${idx}-${subject.key}`);
                    if (container) {
                        containersByMonth[idx][subject.key] = container;
                        container.innerHTML = '<p class="text-gray-500 text-sm">ìƒì„± ì¤‘...</p>';
                    }
                });
            });

            const plansBySubject = {};
            for (const subject of subjects) {
                if (!(lastSemesterGoals[subject.key] || []).length) {
                    plansBySubject[subject.key] = null;
                    continue;
                }
                plansBySubject[subject.key] = await generateSubjectMonthlyPlans(subject, months);
            }

            months.forEach((monthInfo, idx) => {
                subjects.forEach(subject => {
                    const container = containersByMonth[idx]?.[subject.key];
                    if (!container) return;
                    const hasGoals = (lastSemesterGoals[subject.key] || []).length > 0;
                    const entry = plansBySubject[subject.key]?.[idx];
                    if (!hasGoals) {
                        container.innerHTML = '<p class="text-gray-500 text-sm">í•™ê¸° êµìœ¡ëª©í‘œë¥¼ ë¨¼ì € ìƒì„±í•´ ì£¼ì„¸ìš”.</p>';
                    } else if (!entry || (!entry.goal && !entry.content && !entry.method)) {
                        container.innerHTML = '<p class="text-gray-500 text-sm">ì›”ë³„ ê³„íšì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</p>';
                    } else {
                        container.innerHTML = buildMonthlyTables(monthInfo.actual, subject.name, entry);
                    }
                });
            });
        }

        // --- Behavior Intervention Logic ---
        const startObservationBtn = document.getElementById('start-observation-btn');
        const behaviorLoggingSection = document.getElementById('behavior-logging-section');
        const logBehaviorBtn = document.getElementById('log-behavior-btn');
        let currentObservation = null;

        startObservationBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if(!user) return;
            
            const studentName = document.getElementById('behavior-student-name').value;
            const behavior = document.getElementById('target-behavior').value;
            const type = document.querySelector('#behavior-type-buttons .active').dataset.value;
            
            if (!studentName || !behavior) {
                alert('í•™ìƒ ì´ë¦„ê³¼ ëª©í‘œ í–‰ë™ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // Check for existing observation
            const q = query(collection(db, "users", user.uid, "behaviors"), where("studentName", "==", studentName), where("behavior", "==", behavior));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                // Create new observation
                const docRef = await addDoc(collection(db, "users", user.uid, "behaviors"), {
                    studentName: studentName,
                    behavior: behavior,
                    type: type,
                    createdAt: serverTimestamp()
                });
                currentObservation = { id: docRef.id, studentName, behavior };
            } else {
                const doc = querySnapshot.docs[0];
                currentObservation = { id: doc.id, ...doc.data() };
            }
            
            document.getElementById('logging-student').textContent = studentName;
            document.getElementById('logging-behavior').textContent = behavior;
            behaviorLoggingSection.classList.remove('hidden');
            
            loadBehaviorLogs();
        });

        logBehaviorBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user || !currentObservation) return;
            
            await addDoc(collection(db, "users", user.uid, "behaviors", currentObservation.id, "logs"), {
                timestamp: serverTimestamp()
            });
            showToast(`${currentObservation.behavior} í–‰ë™ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            loadBehaviorLogs();
        });
        
        async function loadBehaviorLogs() {
            if (!currentObservation) return;
            const user = auth.currentUser;
            if(!user) return;
            
            const logsRef = collection(db, "users", user.uid, "behaviors", currentObservation.id, "logs");
            const q = query(logsRef, orderBy("timestamp", "asc"));
            const logSnapshot = await getDocs(q);
            
            const dailyCounts = {};
            logSnapshot.forEach(doc => {
                const date = doc.data().timestamp.toDate().toLocaleDateString();
                dailyCounts[date] = (dailyCounts[date] || 0) + 1;
            });
            
            const chartLabels = Object.keys(dailyCounts);
            const chartData = Object.values(dailyCounts);
            
            updateChart('behaviorChart', 'behaviorChartInstance', 'line', {
                labels: chartLabels,
                datasets: [{
                    label: `${currentObservation.behavior} ë°œìƒ ë¹ˆë„`,
                    data: chartData,
                    borderColor: '#0ea5e9',
                    backgroundColor: 'rgba(14, 165, 233, 0.1)',
                    fill: true,
                    tension: 0.1
                }]
            });
        }
        
        function initBehaviorChart() {
             updateChart('behaviorChart', 'behaviorChartInstance', 'line', {
                labels: [],
                datasets: [{ label: 'í–‰ë™ ë°œìƒ ë¹ˆë„', data: [] }]
            }, {
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
            });
        }

        // --- UTILITY FUNCTIONS ---
        function escapeHtml(text) {
            return (text || '').replace(/[&<>"']/g, (char) => {
                switch (char) {
                    case '&': return '&amp;';
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '"': return '&quot;';
                    case "'": return '&#39;';
                    default: return char;
                }
            });
        }

        function formatCellText(text) {
            return escapeHtml(text || '').replace(/\n/g, '<br>');
        }

        function showToast(message) {
            toast.textContent = message;
            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 2000);
        }

        function updateChart(canvasId, instanceVar, type, data, options = {}) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            if (window[instanceVar]) {
                window[instanceVar].destroy();
            }

            window[instanceVar] = new Chart(ctx, { type, data, options });
        }
        
        // Initial load
        window.addEventListener('hashchange', () => {
            const currentView = window.location.hash.replace('#', '') || 'home';
            switchView(currentView);
        });

    </script>
</body>
</html>

