<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>에이두 스페셜 - 특수교사 업무 보조</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Noto Sans KR', sans-serif; }
        .content-section {
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: white;
        }
        .content-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
        }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #0ea5e9; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .nav-link { padding: 0.5rem 1rem; border-radius: 0.375rem; transition: background-color 0.2s, color 0.2s; }
        .nav-link.active { background-color: #0284c7; color: white; }
        .nav-link:not(.active):hover { background-color: #f3f4f6; }
        .tab-btn {
             transition: all 0.2s;
             border: 2px solid transparent;
        }
        .tab-btn.active {
             background-color: #0ea5e9; /* sky-500 */
             color: white;
             border-color: #0284c7; /* sky-600 */
             font-weight: 600;
        }
        .tab-btn:not(.active) {
            background-color: #f1f5f9; /* slate-100 */
            color: #475569; /* slate-600 */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="app">
        <!-- Auth View (Login/Signup) -->
        <div id="auth-view" class="min-h-screen flex items-center justify-center bg-gray-100">
            <div class="w-full max-w-md bg-white rounded-lg shadow-md p-8">
                <h2 class="text-2xl font-bold text-center text-sky-600 mb-6">에이두 스페셜 시작하기</h2>
                <form id="auth-form" onsubmit="return false;">
                    <div class="mb-4">
                        <label for="email" class="block text-gray-700 text-sm font-bold mb-2">이메일</label>
                        <input type="email" id="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-gray-700 text-sm font-bold mb-2">비밀번호</label>
                        <input type="password" id="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <p id="auth-error" class="text-red-500 text-xs italic mb-4 hidden"></p>
                    <div class="flex items-center justify-between">
                        <button type="button" id="login-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">로그인</button>
                        <button type="button" id="signup-btn" class="inline-block align-baseline font-bold text-sm text-sky-600 hover:text-sky-800">계정이 없으신가요? 회원가입</button>
                    </div>
                    <div class="my-4 flex items-center">
                        <div class="flex-grow border-t border-gray-300"></div>
                        <span class="flex-shrink mx-4 text-gray-400 text-sm">또는</span>
                        <div class="flex-grow border-t border-gray-300"></div>
                    </div>
                    <button type="button" id="google-login-btn" class="w-full bg-white border border-gray-300 text-gray-700 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline flex items-center justify-center gap-2 hover:bg-gray-50 transition-colors">
                        <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                        Google 계정으로 로그인
                    </button>
                </form>
            </div>
        </div>

        <!-- Main App View -->
        <div id="main-app-view" class="hidden flex-col min-h-screen">
            <header class="bg-white shadow-md w-full sticky top-0 z-50">
                <div class="container mx-auto px-6 py-3 flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-sky-600"><a href="#home" id="home-link">📝 에이두 스페셜</a></h1>
                    <nav class="flex items-center gap-4">
                        <span id="user-email" class="text-sm text-gray-600"></span>
                        <a href="#home" id="nav-home" class="nav-link">홈</a>
                        <a href="#my-class" id="nav-my-class" class="nav-link">내 학급 관리</a>
                        <a href="#iep" id="nav-iep" class="nav-link">개별화교육계획</a>
                        <a href="#behavior" id="nav-behavior" class="nav-link">행동 중재</a>
                        <button id="logout-btn" class="text-sm bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-md transition-colors">로그아웃</button>
                    </nav>
                </div>
            </header>
            <main class="flex-grow container mx-auto p-6">
                <!-- Home View -->
                <div id="home-view">
                    <h2 class="text-3xl font-bold mb-6">홈</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-2">안녕하세요, <span id="home-user-email"></span> 선생님!</h3>
                            <p class="text-gray-600 mb-4">에이두 스페셜과 함께 특수학급 업무를 효율적으로 관리해보세요.</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-4">업무 통계</h3>
                             <div id="stats-chart-container" class="h-48 flex items-center justify-center">
                                <canvas id="statsChart"></canvas>
                            </div>
                        </div>
                        <div class="md:col-span-2 lg:col-span-3 bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-4">내 학급 목록</h3>
                            <div id="home-class-list" class="space-y-3">
                                <!-- Class list will be dynamically inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- My Class View -->
                <div id="my-class-view" class="hidden">
                    <h2 class="text-3xl font-bold mb-6">내 학급 관리</h2>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">학급 목록</h3>
                            <button id="add-class-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded">새 학급 추가</button>
                        </div>
                        <div id="class-list" class="space-y-4">
                            <!-- Class items will be dynamically inserted here -->
                        </div>
                    </div>
                </div>
                
                <!-- IEP View -->
                <div id="iep-view" class="hidden">
                     <h2 class="text-3xl font-bold mb-6">개별화교육계획(IEP) 수립</h2>
                     <div class="flex flex-col lg:flex-row gap-6">
                        <aside class="w-full lg:w-1/3 bg-white p-6 rounded-lg shadow-lg h-fit lg:sticky top-24">
                            <h3 class="text-lg font-semibold mb-4">학생 정보 입력</h3>
                            <form id="iep-form" class="space-y-4">
                                <div>
                                    <label for="student-name" class="block text-sm font-medium text-gray-700">학생 이름</label>
                                    <input type="text" id="student-name" class="mt-1 block w-full border border-gray-300 rounded-md p-2" required>
                                </div>
                                <div>
                                    <label for="student-grade" class="block text-sm font-medium text-gray-700">학년</label>
                                    <input type="text" id="student-grade" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                                </div>
                                <div>
                                    <label for="iep-period" class="block text-sm font-medium text-gray-700">계획 기간</label>
                                    <input type="text" id="iep-period" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="예: 2025.03.01 ~ 2026.02.28">
                                </div>
                                 <div>
                                    <label for="student-needs" class="block text-sm font-medium text-gray-700">학생 요구사항 및 강점</label>
                                    <textarea id="student-needs" rows="4" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="학생의 특별한 교육적 요구, 강점, 흥미 등을 입력하세요."></textarea>
                                </div>
                                <button type="submit" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-4 rounded-lg">AI 개별화교육계획 초안 생성</button>
                            </form>
                        </aside>
                        <section class="w-full lg:w-2/3">
                            <div id="iep-initial-message" class="bg-white p-8 rounded-lg shadow-lg text-center">
                                <h2 class="text-2xl font-bold text-gray-800">AI가 생성한 IEP 초안이 여기에 표시됩니다.</h2>
                                <p class="mt-2 text-gray-600">좌측에 학생 정보를 입력하고 생성 버튼을 눌러주세요.</p>
                            </div>
                             <div id="iep-loading" class="hidden flex-col items-center justify-center text-center py-16">
                                <div class="loader"></div>
                                <p class="mt-4 text-lg font-semibold text-gray-700">AI가 IEP 초안을 작성하고 있습니다...</p>
                            </div>
                            <div id="iep-output" class="hidden content-section">
                                <!-- IEP content will be injected here -->
                            </div>
                        </section>
                     </div>
                </div>

                <!-- Behavior Intervention View -->
                <div id="behavior-view" class="hidden">
                    <h2 class="text-3xl font-bold mb-6">행동 중재</h2>
                     <div class="flex flex-col lg:flex-row gap-6">
                        <aside class="w-full lg:w-1/3 bg-white p-6 rounded-lg shadow-lg h-fit lg:sticky top-24 space-y-6">
                            <div>
                                <h3 class="text-lg font-semibold mb-4">학생 및 행동 선택</h3>
                                <div class="space-y-4">
                                     <div>
                                        <label for="behavior-student-name" class="block text-sm font-medium text-gray-700">학생 이름</label>
                                        <input type="text" id="behavior-student-name" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="관찰할 학생 이름">
                                    </div>
                                    <div>
                                        <label for="target-behavior" class="block text-sm font-medium text-gray-700">목표 행동</label>
                                        <input type="text" id="target-behavior" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="예: 바르게 앉아 있기">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">행동 유형</label>
                                        <div id="behavior-type-buttons" class="grid grid-cols-2 gap-2">
                                            <button type="button" data-value="increase" class="tab-btn py-2 px-2 rounded text-sm active">증가시킬 행동</button>
                                            <button type="button" data-value="decrease" class="tab-btn py-2 px-2 rounded text-sm">감소시킬 행동</button>
                                        </div>
                                    </div>
                                    <button id="start-observation-btn" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg">관찰 시작</button>
                                </div>
                            </div>
                            <div id="behavior-logging-section" class="hidden">
                                <h3 class="text-lg font-semibold mb-4">행동 기록</h3>
                                <p class="text-sm text-gray-600 mb-1">학생: <span id="logging-student" class="font-bold"></span></p>
                                <p class="text-sm text-gray-600 mb-4">목표 행동: <span id="logging-behavior" class="font-bold"></span></p>
                                <button id="log-behavior-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-4 rounded-lg text-lg">행동 발생 (+1)</button>
                            </div>
                        </aside>
                        <section class="w-full lg:w-2/3">
                            <div class="content-section">
                                <h3 class="text-xl font-bold mb-4">행동 관찰 그래프</h3>
                                <div id="behavior-chart-container" class="h-96">
                                    <canvas id="behaviorChart"></canvas>
                                </div>
                            </div>
                        </section>
                     </div>
                </div>

            </main>
        </div>
        
        <!-- Toast Message -->
        <div id="toast" class="fixed bottom-10 right-10 bg-gray-900 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-300">
             복사되었습니다!
        </div>
    </div>

    <script type="module">
        // Firebase v10 SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, getDocs, doc, getDoc, deleteDoc, updateDoc, serverTimestamp, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            // Your web app's Firebase configuration
            apiKey: "AIzaSyDCeJPDQUNi-KmJ9DhkTRIu-9t2PGZCpt0",
            authDomain: "mansungcoin-c6e06.firebaseapp.com",
            projectId: "mansungcoin-c6e06",
            storageBucket: "mansungcoin-c6e06.appspot.com",
            messagingSenderId: "704809284946",
            appId: "1:704809284946:web:54e4788586e6c68de1768b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const authView = document.getElementById('auth-view');
        const mainAppView = document.getElementById('main-app-view');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const authError = document.getElementById('auth-error');
        const userEmailSpan = document.getElementById('user-email');
        const homeUserEmailSpan = document.getElementById('home-user-email');
        const toast = document.getElementById('toast');

        // Views and Navs
        const views = {
            home: document.getElementById('home-view'),
            'my-class': document.getElementById('my-class-view'),
            iep: document.getElementById('iep-view'),
            behavior: document.getElementById('behavior-view'),
        };
        const navLinks = {
            home: document.getElementById('nav-home'),
            'my-class': document.getElementById('nav-my-class'),
            iep: document.getElementById('nav-iep'),
            behavior: document.getElementById('nav-behavior'),
        };
        
        let statsChartInstance = null;
        let behaviorChartInstance = null;

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, user => {
            if (user) {
                authView.classList.add('hidden');
                mainAppView.classList.remove('hidden');
                mainAppView.classList.add('flex');
                userEmailSpan.textContent = user.email;
                homeUserEmailSpan.textContent = user.email;
                // Handle routing based on hash
                const currentView = window.location.hash.replace('#', '') || 'home';
                switchView(currentView);
            } else {
                authView.classList.remove('hidden');
                mainAppView.classList.add('hidden');
                mainAppView.classList.remove('flex');
            }
        });

        signupBtn.addEventListener('click', () => {
            createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value)
                .catch(error => authError.textContent = error.message);
        });

        loginBtn.addEventListener('click', () => {
            signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value)
                .catch(error => authError.textContent = error.message);
        });

        googleLoginBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                authError.textContent = error.message;
            }
        });

        logoutBtn.addEventListener('click', () => signOut(auth));

        // --- NAVIGATION ---
        const switchView = (view) => {
            Object.values(views).forEach(v => v.classList.add('hidden'));
            Object.values(navLinks).forEach(l => l.classList.remove('active'));
            if (views[view]) {
                views[view].classList.remove('hidden');
                navLinks[view].classList.add('active');
                window.location.hash = view;

                // Load data for the activated view
                if (view === 'home') {
                    loadHomeData();
                } else if (view === 'my-class') {
                    loadClasses();
                } else if (view === 'behavior') {
                    initBehaviorChart();
                }

            } else { // Fallback to home
                views.home.classList.remove('hidden');
                navLinks.home.classList.add('active');
                window.location.hash = 'home';
                loadHomeData();
            }
        };

        Object.entries(navLinks).forEach(([key, link]) => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                switchView(key);
            });
        });
        document.getElementById('home-link').addEventListener('click', (e) => {
             e.preventDefault();
             switchView('home');
        });

        // --- Home View Logic ---
        async function loadHomeData() {
            const user = auth.currentUser;
            if (!user) return;

            const classesRef = collection(db, "users", user.uid, "classes");
            const iepsRef = collection(db, "users", user.uid, "ieps");
            
            const [classSnap, iepSnap] = await Promise.all([getDocs(classesRef), getDocs(iepsRef)]);
            
            const classes = [];
            classSnap.forEach(doc => classes.push({ id: doc.id, ...doc.data() }));

            // Update home class list
            const homeClassList = document.getElementById('home-class-list');
            homeClassList.innerHTML = '';
             if (classes.length === 0) {
                 homeClassList.innerHTML = `<p class="text-gray-500">아직 추가된 학급이 없습니다. '내 학급 관리'에서 추가해주세요.</p>`;
             } else {
                classes.forEach(c => {
                    const classEl = document.createElement('div');
                    classEl.className = 'p-3 border rounded-md';
                    classEl.innerHTML = `<p class="font-semibold">${c.name} (${c.year}학년도)</p>`;
                    homeClassList.appendChild(classEl);
                });
            }


            // Update stats chart
            const statsData = {
                labels: ['학급', 'IEP'],
                datasets: [{
                    label: '업무 수',
                    data: [classSnap.size, iepSnap.size],
                    backgroundColor: ['#38bdf8', '#fbbf24'], // sky-400, amber-400
                    hoverOffset: 4
                }]
            };
            updateChart('statsChart', 'statsChartInstance', 'doughnut', statsData, {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            });
        }
        
        // --- My Class View Logic ---
        const addClassBtn = document.getElementById('add-class-btn');
        const classListContainer = document.getElementById('class-list');

        async function loadClasses() {
            const user = auth.currentUser;
            if (!user) return;
            const q = query(collection(db, "users", user.uid, "classes"), orderBy("createdAt", "desc"));
            const querySnapshot = await getDocs(q);
            classListContainer.innerHTML = '';
            if (querySnapshot.empty) {
                classListContainer.innerHTML = `<p class="text-gray-500">생성된 학급이 없습니다.</p>`;
                return;
            }
            querySnapshot.forEach(doc => {
                const classData = doc.data();
                const classEl = document.createElement('div');
                classEl.className = 'flex justify-between items-center p-4 border rounded-lg';
                classEl.innerHTML = `
                    <div>
                        <p class="text-lg font-bold">${classData.name}</p>
                        <p class="text-sm text-gray-500">${classData.year}학년도</p>
                    </div>
                    <div>
                        <button class="delete-class-btn text-red-500 hover:text-red-700" data-id="${doc.id}">삭제</button>
                    </div>
                `;
                classListContainer.appendChild(classEl);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-class-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const docId = e.target.dataset.id;
                    if(confirm('정말로 이 학급을 삭제하시겠습니까?')) {
                        await deleteDoc(doc(db, "users", user.uid, "classes", docId));
                        loadClasses(); // Refresh list
                    }
                });
            });
        }
        
        addClassBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) return;
            const className = prompt("새 학급의 이름을 입력하세요:");
            const classYear = prompt("학년도를 입력하세요 (예: 2025):");

            if (className && classYear) {
                await addDoc(collection(db, "users", user.uid, "classes"), {
                    name: className,
                    year: classYear,
                    createdAt: serverTimestamp()
                });
                loadClasses(); // Refresh list
            }
        });


        // --- IEP View Logic ---
        const iepForm = document.getElementById('iep-form');
        const iepOutputContainer = document.getElementById('iep-output');
        const iepInitialMessage = document.getElementById('iep-initial-message');
        const iepLoading = document.getElementById('iep-loading');

        iepForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;

            const studentName = document.getElementById('student-name').value;
            const studentNeeds = document.getElementById('student-needs').value;

            iepInitialMessage.classList.add('hidden');
            iepOutputContainer.classList.add('hidden');
            iepLoading.classList.remove('hidden');

            // Simplified prompt for generating IEP structure
            const prompt = `
                특수교육대상학생 '${studentName}'의 개별화교육계획(IEP) 초안을 작성해줘.
                학생의 요구사항 및 강점: ${studentNeeds}.
                
                다음 목차에 따라 구체적인 내용을 포함하여 작성해줘:
                1. 학생 인적사항
                2. 현재 학습 수행 수준 (학업, 신체, 의사소통, 사회성 등 영역별로 기술)
                3. 장기 교육 목표 (1년 단위)
                4. 단기 교육 목표 (학기 단위, 장기 목표와 연계)
                5. 평가 계획
                6. 특수교육 관련 서비스 (치료지원, 보조공학기기 등)

                각 항목은 h3 제목(###)으로 구분하고, 내용은 줄 바꿈과 글머리 기호를 사용해서 가독성 있게 작성해줘.
            `;
            
            // This is a placeholder for the actual API call.
            // In a real implementation, you would call your backend/serverless function here.
            setTimeout(() => {
                const mockResponse = `
                    ### 1. 학생 인적사항
                    - 성명: ${studentName}
                    - 학년: ${document.getElementById('student-grade').value || '미입력'}
                    - 계획 기간: ${document.getElementById('iep-period').value || '미입력'}

                    ### 2. 현재 학습 수행 수준
                    - **학업**: 기초적인 읽기 및 쓰기 가능. 두 자리 수 덧셈에 어려움을 보임.
                    - **의사소통**: 간단한 문장으로 자신의 의사를 표현할 수 있으나, 복잡한 대화 참여에 소극적임.
                    - **사회성**: 또래와 어울리고 싶어하지만, 관계 형성 기술이 미숙하여 도움이 필요함.

                    ### 3. 장기 교육 목표
                    - 1) 두 자리 수 덧셈과 뺄셈 문제를 80% 이상의 정확도로 해결할 수 있다.
                    - 2) 세 문장 이상의 연결된 문장으로 자신의 경험을 이야기할 수 있다.
                    - 3) 친구의 놀이 제안에 긍정적으로 반응하고, 5분 이상 놀이를 지속할 수 있다.

                    ### 4. 단기 교육 목표
                    - **1학기**:
                      - 가) 받아올림이 없는 두 자리 수 덧셈을 90% 정확도로 해결한다.
                      - 나) 그림을 보고 두 문장으로 상황을 설명할 수 있다.
                      - 다) 교사의 지원 하에 친구에게 놀이를 제안할 수 있다.
                    - **2학기**:
                      - 가) 받아내림이 없는 두 자리 수 뺄셈을 90% 정확도로 해결한다.
                      - 나) 질문에 두 문장 이상으로 대답할 수 있다.
                      - 다) 스스로 친구의 놀이에 참여하여 5분 이상 상호작용한다.

                    ### 5. 평가 계획
                    - **방법**: 관찰, 포트폴리오, 수행평가
                    - **시기**: 매월 말, 학기 말

                    ### 6. 특수교육 관련 서비스
                    - 언어치료: 주 2회 (회당 40분)
                    - 보조공학기기: 학습용 태블릿 PC 및 소리펜 지원
                `;
                iepOutputContainer.innerHTML = mockResponse.replace(/\n/g, '<br>');
                iepLoading.classList.add('hidden');
                iepOutputContainer.classList.remove('hidden');
                
                // Save to Firestore
                 addDoc(collection(db, "users", user.uid, "ieps"), {
                    studentName: studentName,
                    content: mockResponse,
                    createdAt: serverTimestamp()
                });

            }, 2000); // Simulating network delay
        });
        
        // --- Behavior Intervention Logic ---
        const startObservationBtn = document.getElementById('start-observation-btn');
        const behaviorLoggingSection = document.getElementById('behavior-logging-section');
        const logBehaviorBtn = document.getElementById('log-behavior-btn');
        let currentObservation = null;

        startObservationBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if(!user) return;
            
            const studentName = document.getElementById('behavior-student-name').value;
            const behavior = document.getElementById('target-behavior').value;
            const type = document.querySelector('#behavior-type-buttons .active').dataset.value;
            
            if (!studentName || !behavior) {
                alert('학생 이름과 목표 행동을 모두 입력해주세요.');
                return;
            }
            
            // Check for existing observation
            const q = query(collection(db, "users", user.uid, "behaviors"), where("studentName", "==", studentName), where("behavior", "==", behavior));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                // Create new observation
                const docRef = await addDoc(collection(db, "users", user.uid, "behaviors"), {
                    studentName: studentName,
                    behavior: behavior,
                    type: type,
                    createdAt: serverTimestamp()
                });
                currentObservation = { id: docRef.id, studentName, behavior };
            } else {
                const doc = querySnapshot.docs[0];
                currentObservation = { id: doc.id, ...doc.data() };
            }
            
            document.getElementById('logging-student').textContent = studentName;
            document.getElementById('logging-behavior').textContent = behavior;
            behaviorLoggingSection.classList.remove('hidden');
            
            loadBehaviorLogs();
        });

        logBehaviorBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user || !currentObservation) return;
            
            await addDoc(collection(db, "users", user.uid, "behaviors", currentObservation.id, "logs"), {
                timestamp: serverTimestamp()
            });
            showToast(`${currentObservation.behavior} 행동이 기록되었습니다.`);
            loadBehaviorLogs();
        });
        
        async function loadBehaviorLogs() {
            if (!currentObservation) return;
            const user = auth.currentUser;
            if(!user) return;
            
            const logsRef = collection(db, "users", user.uid, "behaviors", currentObservation.id, "logs");
            const q = query(logsRef, orderBy("timestamp", "asc"));
            const logSnapshot = await getDocs(q);
            
            const dailyCounts = {};
            logSnapshot.forEach(doc => {
                const date = doc.data().timestamp.toDate().toLocaleDateString();
                dailyCounts[date] = (dailyCounts[date] || 0) + 1;
            });
            
            const chartLabels = Object.keys(dailyCounts);
            const chartData = Object.values(dailyCounts);
            
            updateChart('behaviorChart', 'behaviorChartInstance', 'line', {
                labels: chartLabels,
                datasets: [{
                    label: `${currentObservation.behavior} 발생 빈도`,
                    data: chartData,
                    borderColor: '#0ea5e9',
                    backgroundColor: 'rgba(14, 165, 233, 0.1)',
                    fill: true,
                    tension: 0.1
                }]
            });
        }
        
        function initBehaviorChart() {
             updateChart('behaviorChart', 'behaviorChartInstance', 'line', {
                labels: [],
                datasets: [{ label: '행동 발생 빈도', data: [] }]
            }, {
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
            });
        }

        // --- UTILITY FUNCTIONS ---
        function showToast(message) {
            toast.textContent = message;
            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 2000);
        }

        function updateChart(canvasId, instanceVar, type, data, options = {}) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            if (window[instanceVar]) {
                window[instanceVar].destroy();
            }

            window[instanceVar] = new Chart(ctx, { type, data, options });
        }
        
        // Initial load
        window.addEventListener('hashchange', () => {
            const currentView = window.location.hash.replace('#', '') || 'home';
            switchView(currentView);
        });

    </script>
</body>
</html>

