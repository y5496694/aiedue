<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“š ì—ì´ë‘ ë¶ë©”ì´ì»¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap');
        body { font-family: 'Gowun Dodum', sans-serif; }
        .loader { border: 8px solid #f3f3f3; border-radius: 50%; width: 60px; height: 60px; animation: spin 2s linear infinite; border-top: 8px solid #10b981; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .book-viewer { aspect-ratio: 2 / 1.414; width: 100%; display: flex; }
        .book-page { position: relative; width: 50%; height: 100%; background-size: cover; background-position: center; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 2rem; box-sizing: border-box; }
        .book-spread { display: none; }
        .book-spread.active { display: flex; }
        .text-box { background-color: rgba(255, 255, 255, 0.85); border: 2px solid black; padding: 1rem; text-align: center; }
        .page-nav { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(0,0,0,0.5); color: white; border: none; border-radius: 9999px; width: 3rem; height: 3rem; font-size: 2rem; cursor: pointer; z-index: 10; }
        .page-number { position: absolute; bottom: 0.5rem; font-size: 0.875rem; color: #374151; }
        .manual-text-area { width: 100%; height: 80%; background: transparent; border: 2px dashed #ccc; border-radius: 8px; padding: 1rem; text-align: left; overflow-y: auto; font-size: 1.125rem; }
        .tts-word { cursor: pointer; transition: color 0.2s; }
        .tts-word:hover { color: #3b82f6; }
        #notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: #2c3e50; color: white; padding: 1rem 2rem; border-radius: 8px; z-index: 1000; transition: opacity 0.5s, transform 0.5s; opacity: 0; pointer-events: none; }
        #notification.show { opacity: 1; transform: translate(-50%, 10px); }
        .login-tab.active { border-bottom-color: #F59E0B; color: #F59E0B; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-input { transition: all 0.3s; }
        .form-input:focus { border-color: #F59E0B; box-shadow: 0 0 0 2px rgba(245,158,11,0.2); }
        .btn { transition: background-color 0.3s; }
        .btn-primary { background-color: #F59E0B; color: white; }
        .btn-primary:hover { background-color: #D97706; }
        .btn-secondary { background-color: #6B7280; color: white; }
        .btn-secondary:hover { background-color: #4B5563; }
        .btn-disabled { background-color: #D1D5DB; cursor: not-allowed; }
    </style>
</head>
<body class="p-2 md:p-8 bg-gray-100">

    <div id="book-login-view" class="max-w-md mx-auto mb-8 bg-white p-6 rounded-lg shadow-lg">
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                <button id="book-student-login-tab" class="login-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">ğŸ§‘â€ğŸ“ í•™ìƒ</button>
                <button id="book-teacher-login-tab" class="login-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">ğŸ§‘â€ğŸ« êµì‚¬</button>
            </nav>
        </div>
        <div id="book-student-login-content" class="tab-content pt-6">
            <div class="mb-4">
                <label for="book-student-code" class="block text-sm font-medium text-gray-700 mb-1">ê³ ìœ  ìˆ«ì ì½”ë“œ</label>
                <input type="text" id="book-student-code" class="w-full p-2 border border-gray-300 rounded-md form-input" placeholder="ë°œê¸‰ë°›ì€ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <button id="book-student-login-btn" class="w-full py-2 rounded-md btn btn-primary">í•™ìƒ ë¡œê·¸ì¸</button>
        </div>
        <div id="book-teacher-login-content" class="tab-content pt-6">
            <div class="mb-4">
                <label for="book-teacher-email" class="block text-sm font-medium text-gray-700 mb-1">ì´ë©”ì¼</label>
                <input type="email" id="book-teacher-email" class="w-full p-2 border border-gray-300 rounded-md form-input" placeholder="example@email.com">
            </div>
            <div class="mb-6">
                <label for="book-teacher-password" class="block text-sm font-medium text-gray-700 mb-1">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="book-teacher-password" class="w-full p-2 border border-gray-300 rounded-md form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <button id="book-teacher-login-btn" class="w-full py-2 rounded-md btn btn-primary">êµì‚¬ ë¡œê·¸ì¸</button>
            <button id="book-teacher-google-login-btn" class="w-full py-2 mt-2 rounded-md btn btn-secondary"><i class="fab fa-google mr-2"></i>Googleë¡œ ë¡œê·¸ì¸</button>
        </div>
        <div class="mt-6 text-center">
            <button id="book-show-student-register-btn" class="w-full text-center text-sm text-amber-600 hover:underline">ì²˜ìŒì´ì‹ ê°€ìš”? í•™ìƒ ë“±ë¡í•˜ê¸°</button>
        </div>
    </div>

    <div id="book-student-register-view" class="max-w-md mx-auto mb-8 bg-white p-6 rounded-lg shadow-lg hidden">
        <h2 class="text-2xl font-bold mb-6 text-center">ğŸ§‘â€ğŸ“ í•™ìƒ ë“±ë¡</h2>
        <div class="mb-4">
            <label for="book-student-name" class="block text-sm font-medium text-gray-700 mb-1">ì´ë¦„</label>
            <input type="text" id="book-student-name" class="w-full p-2 border border-gray-300 rounded-md form-input" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <button id="book-student-register-btn" class="w-full py-2 rounded-md btn btn-primary mb-4">ë“±ë¡í•˜ê³  ì½”ë“œ ë°›ê¸°</button>
        <button id="book-back-to-login-btn" class="w-full text-center text-sm text-gray-600 hover:underline">ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>

    <div id="book-content" class="hidden">
    <div class="max-w-7xl mx-auto mb-4 flex justify-between items-center">
        <h1 class="flex items-center gap-2 text-3xl font-extrabold text-amber-600">ğŸ“š <span>ì—ì´ë‘ ë¶ë©”ì´ì»¤</span></h1>
        <div class="flex items-center gap-3 bg-white border rounded-full px-4 py-2">
            <span id="role-badge" class="font-bold mr-1 hidden">êµì‚¬</span>
            <span id="display-user-name" class="font-bold"></span>
            <button id="token-give-btn" class="bg-purple-500 text-white px-2 py-1 rounded text-sm hidden">í† í° ì§€ê¸‰</button>
            <button id="my-class-btn" class="bg-amber-500 text-white px-2 py-1 rounded text-sm hidden">ë‚´ í•™ê¸‰</button>
            <span class="text-sm text-gray-700">ë‚´ ì§€ê°‘: <span id="display-user-tokens">0</span>í† í°</span>
            <button id="my-info-btn" class="text-sm text-gray-500 underline">ë‚´ ì •ë³´</button>
            <button id="book-logout-btn" class="text-sm text-gray-500 underline">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>
    <div id="book-list-section" class="max-w-7xl mx-auto mb-4">
        <div class="bg-white p-4 rounded-lg shadow">
            <div class="mb-4 flex gap-4 border-b">
                <button id="my-books-tab" class="pb-2 text-sm font-medium border-b-2 border-orange-500 text-orange-500">ë‚´ ì±…</button>
                <button id="library-tab" class="pb-2 text-sm font-medium border-b-2 border-transparent text-gray-500">ì—ì´ë‘ ë„ì„œê´€</button>
            </div>
            <div id="my-book-list" class="flex items-center gap-2 overflow-x-auto"></div>
            <div id="library-book-list" class="hidden flex items-center gap-2 overflow-x-auto"></div>
        </div>
    </div>
    <div id="book-viewer-page" class="page-content max-w-7xl mx-auto hidden">
        <div class="bg-white rounded-2xl shadow-lg p-4 md:p-6">
            <header class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                <div class="flex items-end gap-2">
                    <button id="back-to-list-btn" class="bg-gray-500 text-white px-3 py-1 rounded-lg">ëª©ë¡ìœ¼ë¡œ</button>
                    <h1 class="text-2xl md:text-4xl font-bold text-emerald-800 flex items-center gap-2">ğŸ“š <span class="book-title-sync">ì—ì´ë‘ ë¶ë©”ì´ì»¤</span></h1>
                    <span class="text-sm text-gray-600">ê¸€ì“´ì´: <span id="author-display" class="book-author-sync"></span></span>
                </div>
                <div id="viewer-controls" class="flex flex-wrap justify-center items-center gap-2">
                    <button id="generate-images-gpt-btn" onclick="completeManualBookGPT()" class="bg-pink-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-pink-700 disabled:bg-gray-400 disabled:cursor-not-allowed">GPT ì‚¬ì§„ ë§Œë“¤ê¸°/1í† í°</button>
                    <button id="generate-images-btn" onclick="completeManualBook()" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed">ê·¸ë¦¼ ìƒì„±í•˜ê¸°</button>
                    <button id="save-book-btn" onclick="saveBookDraft()" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed">ì €ì¥í•˜ê¸°</button>
                    <button id="save-book-pdf-btn" onclick="downloadBookAsPDF()" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 hidden">PDF ì €ì¥</button>
                    <button id="register-library-btn" onclick="registerToLibrary()" class="bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600 disabled:bg-gray-400 disabled:cursor-not-allowed hidden" disabled>ì±… ì™„ì„±</button>
                </div>
            </header>

            <div id="book-viewer" class="relative bg-gray-50 rounded-lg border-2 border-dashed mb-4">
                <!-- ì±… ë·°ì–´ê°€ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤. -->
            </div>

            <div id="page-prompt-wrapper" class="mt-4"></div>
        </div>
    </div>
    </div>

    <div id="notification"></div>

    <!-- ìƒˆ ì±… ì¶”ê°€ íŒì—… -->
    <div id="add-book-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-80">
            <h2 class="text-lg font-semibold mb-4">ìƒˆ ì±… ë§Œë“¤ê¸°</h2>
            <input type="text" id="new-book-title" class="w-full p-2 border border-gray-300 rounded mb-4" placeholder="ì±… ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" />
            <div class="flex justify-end gap-2">
                <button id="cancel-add-book" class="px-3 py-1 rounded bg-gray-300">ì·¨ì†Œ</button>
                <button id="confirm-add-book" class="px-3 py-1 rounded bg-blue-500 text-white">í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- ë‚´ í•™ê¸‰ íŒì—… -->
    <div id="my-class-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-80">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">ë‚´ í•™ê¸‰</h2>
                <button id="close-my-class-modal" class="text-xl">&times;</button>
            </div>
            <ul id="my-class-student-list" class="space-y-1 max-h-60 overflow-y-auto mb-4"></ul>
            <div class="text-right">
                <button id="add-my-class-student-btn" class="px-3 py-1 rounded bg-blue-500 text-white">í•™ìƒ ì¶”ê°€</button>
            </div>
        </div>
    </div>

    <!-- í•™ê¸‰ í•™ìƒ ì¶”ê°€ íŒì—… -->
    <div id="class-add-students-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-96">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">í•™ìƒ ì¶”ê°€</h2>
                <button id="close-class-add-students-btn" class="text-xl">&times;</button>
            </div>
            <div class="mb-2">
                <input type="text" id="class-student-search" class="w-full p-2 border rounded" placeholder="ì´ë¦„ ë˜ëŠ” ì½”ë“œë¡œ ê²€ìƒ‰..." />
            </div>
            <div id="class-student-list" class="space-y-2 max-h-60 overflow-y-auto border p-2 rounded mb-4"></div>
            <div class="text-right">
                <button id="class-add-students-confirm-btn" class="px-3 py-1 rounded bg-blue-500 text-white">ì¶”ê°€</button>
            </div>
        </div>
    </div>

    <!-- í† í° ì§€ê¸‰ íŒì—… -->
    <div id="token-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-96">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">í† í° ì§€ê¸‰</h2>
                <button id="close-token-modal" class="text-xl">&times;</button>
            </div>
            <label class="flex items-center space-x-2 mb-2"><input type="checkbox" id="token-select-class" class="h-4 w-4"><span>ë‚´ í•™ê¸‰ ì „ì²´ ì„ íƒ</span></label>
            <input type="text" id="token-user-search" class="w-full p-2 border rounded mb-2" placeholder="ì´ë¦„ ë˜ëŠ” ì½”ë“œë¡œ ê²€ìƒ‰..." />
            <div id="token-user-list" class="space-y-2 max-h-60 overflow-y-auto border p-2 rounded mb-4"></div>
            <input type="number" id="token-amount" class="w-full p-2 border rounded mb-4" placeholder="ì§€ê¸‰í•  í† í° ì–‘" />
            <div class="text-right">
                <button id="token-distribute-confirm" class="px-3 py-1 rounded bg-purple-500 text-white">ì§€ê¸‰í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ë‚´ ì •ë³´ íŒì—… -->
    <div id="my-info-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-80">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">ë‚´ ì •ë³´</h2>
                <button id="close-my-info-modal" class="text-xl">&times;</button>
            </div>
            <div class="mb-4">
                <label for="my-info-name" class="block text-sm font-medium text-gray-700 mb-1">ì´ë¦„</label>
                <input type="text" id="my-info-name" class="w-full p-2 border rounded" />
            </div>
            <div class="text-right">
                <button id="my-info-save-btn" class="px-3 py-1 rounded bg-blue-500 text-white">ë³€ê²½</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp, updateDoc, increment, collection, addDoc, getDocs, query, where, runTransaction, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref as storageRef, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // ì „ì—­ ë³€ìˆ˜
        let bookCurrentPage = 0;
        let totalBookSpreads = 0;
        let bookCode = null;
        let bookAuthorUid = null;
        let auth;
        let db;
        let storage;
        let userTokens = 0;
        let currentClassStudents = [];
        // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì´ë¦„ì„ ì €ì¥í•˜ê³  ì±…ì˜ ì €ì ì˜ì—­ì„ ë™ê¸°í™”í•©ë‹ˆë‹¤.
        window.authorName = '';
        window.syncBookAuthor = function() {
            document.querySelectorAll('.book-author-sync').forEach(el => el.textContent = window.authorName);
        };

        // TTS í•¨ìˆ˜
        function speak(text) {
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'ko-KR';
                u.rate = 0.9;
                window.speechSynthesis.speak(u);
            }
        }

        // ì•Œë¦¼ í•¨ìˆ˜
        function showNotification(message, duration = 3000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }

        async function loadUserBooks() {
            if (!bookAuthorUid) return;
            const listEl = document.getElementById('my-book-list');
            listEl.innerHTML = '';
            const snap = await getDocs(collection(db, `users/${bookAuthorUid}/myBooks`));
            snap.forEach(docSnap => {
                const data = docSnap.data();
                const item = document.createElement('button');
                const created = data.createdAt?.toDate ? data.createdAt.toDate().toLocaleDateString('ko-KR') : '';
                item.innerHTML = `<div class="font-semibold">${data.title || 'ì œëª©ì—†ìŒ'}</div>` +
                                  `<div class="text-xs text-gray-600">ìƒì„±ì¼: ${created}</div>` +
                                  `<div class="text-xs text-gray-600">ì½”ë“œ: ${data.bookId}</div>`;
                item.className = 'text-left px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 flex-shrink-0';
                item.addEventListener('click', () => loadBook(data.bookId));
                listEl.appendChild(item);
            });
            const addBtn = document.createElement('button');
            addBtn.id = 'add-book-btn';
            addBtn.className = 'text-left px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 flex-shrink-0';
            addBtn.textContent = '+ ì±… ì¶”ê°€/1í† í°';
            addBtn.addEventListener('click', () => {
                if (!bookAuthorUid) return;
                newBookTitleInput.value = '';
                addBookModal.classList.remove('hidden');
                newBookTitleInput.focus();
            });
            listEl.appendChild(addBtn);
        }

        async function loadLibraryBooks() {
            const listEl = document.getElementById('library-book-list');
            listEl.innerHTML = '';
            const q = query(collection(db, 'Book'), where('isPublic', '==', true));
            const snap = await getDocs(q);
            snap.forEach(docSnap => {
                const data = docSnap.data();
                const item = document.createElement('button');
                const created = data.createdAt?.toDate ? data.createdAt.toDate().toLocaleDateString('ko-KR') : '';
                item.innerHTML = `<div class="font-semibold">${data.title || 'ì œëª©ì—†ìŒ'}</div>` +
                                  `<div class="text-xs text-gray-600">ê¸€ì“´ì´: ${data.author || ''}</div>` +
                                  `<div class="text-xs text-gray-600">ì½”ë“œ: ${docSnap.id}</div>`;
                item.className = 'text-left px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 flex-shrink-0';
                item.addEventListener('click', () => loadBook(docSnap.id));
                listEl.appendChild(item);
            });
        }

        async function loadBook(id) {
            const bookRef = doc(db, 'Book', id);
            const bookDoc = await getDoc(bookRef);
            if (!bookDoc.exists()) {
                alert('ì±…ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            bookCode = id;
            const data = bookDoc.data();
            buildBookViewer();

            for (let i = 1; i < (data.characterSpreadCount || 1); i++) {
                addCharacterPage();
            }
            for (let i = 1; i < (data.storySpreadCount || 1); i++) {
                addManualPage();
            }

            const coverSpread = document.querySelector('#spread-0');
            if (coverSpread && data.coverPrompt !== undefined) {
                coverSpread.dataset.prompt = data.coverPrompt || '';
            }

            document.querySelectorAll('.book-title-sync').forEach(el => {
                el.textContent = data.title || '';
            });
            window.authorName = data.author || window.authorName;
            window.syncBookAuthor();

            if (data.coverImage) {
                const url = await getDownloadURL(storageRef(storage, `Book/${bookCode}/${data.coverImage}`));
                const coverPage = document.querySelector('#spread-0 .book-page:nth-child(2)');
                coverPage.style.backgroundImage = `url('${url}')`;
                coverPage.dataset.imageName = data.coverImage;
            }

            const charPages = document.querySelectorAll('.book-spread[data-page-type="character"] .book-page');
            for (let i = 0; i < charPages.length; i++) {
                const idx = i + 1;
                const page = charPages[i];
                const imgName = data[`character${idx}Image`];
                if (imgName) {
                    const url = await getDownloadURL(storageRef(storage, `Book/${bookCode}/${imgName}`));
                    const box = page.querySelector('.character-image-box');
                    box.style.backgroundImage = `url('${url}')`;
                    box.dataset.imageName = imgName;
                    box.textContent = '';
                }
                const nameVal = data[`character${idx}Name`];
                if (nameVal) page.querySelector('.editable-text').textContent = nameVal;
                const descVal = data[`character${idx}Desc`];
                if (descVal) page.querySelector('textarea.manual-text-area').value = descVal;
            }

            const charSpreads = document.querySelectorAll('.book-spread[data-page-type="character"]');
            charSpreads.forEach((spread, idx) => {
                const base = idx * 2 + 1;
                const leftPrompt = data[`character${base}Prompt`];
                const rightPrompt = data[`character${base + 1}Prompt`];
                if (leftPrompt !== undefined) spread.dataset.promptLeft = leftPrompt;
                if (rightPrompt !== undefined) spread.dataset.promptRight = rightPrompt;
            });

            const storySpreads = document.querySelectorAll('.book-spread[data-page-type="story"]');
            for (let i = 0; i < storySpreads.length; i++) {
                const idx = i + 1;
                const spread = storySpreads[i];
                const imgName = data[`story${idx}Image`];
                if (imgName) {
                    const url = await getDownloadURL(storageRef(storage, `Book/${bookCode}/${imgName}`));
                    const imagePage = spread.querySelector('.book-page:first-child');
                    const pageNumHTML = imagePage.querySelector('.page-number')?.outerHTML || '';
                    imagePage.style.backgroundImage = `url('${url}')`;
                    imagePage.innerHTML = pageNumHTML;
                    imagePage.dataset.imageName = imgName;
                }
                const textVal = data[`story${idx}Text`];
                if (textVal) spread.querySelector('.book-page:last-child textarea.manual-text-area').value = textVal;
                const promptVal = data[`story${idx}Prompt`];
                if (promptVal !== undefined) spread.dataset.prompt = promptVal;
            }

            document.getElementById('book-viewer-page').classList.remove('hidden');
            document.getElementById('book-list-section').classList.add('hidden');
            bookCurrentPage = 0;
            updateBookView();
        }

        async function updateUserInfo() {
            if (!bookAuthorUid) return;
            const userRef = doc(db, 'users', bookAuthorUid);
            const userDoc = await getDoc(userRef);
            const data = userDoc.data() || {};
            window.authorName = data.name || '';
            userTokens = Number(data.aeduTokens) || 0;
            document.getElementById('display-user-name').textContent = window.authorName;
            document.getElementById('display-user-tokens').textContent = `${userTokens}`;
            const roleBadgeEl = document.getElementById('role-badge');
            const myClassBtn = document.getElementById('my-class-btn');
            const tokenGiveBtn = document.getElementById('token-give-btn');
            if (data.role === 'teacher') {
                roleBadgeEl.classList.remove('hidden');
                roleBadgeEl.textContent = 'êµì‚¬';
                myClassBtn.classList.remove('hidden');
                tokenGiveBtn.classList.remove('hidden');
            } else {
                roleBadgeEl.classList.add('hidden');
                myClassBtn.classList.add('hidden');
                tokenGiveBtn.classList.add('hidden');
            }
            window.syncBookAuthor();
        }

        /**
         * ì´ë¯¸ì§€ ìƒì„± APIë¥¼ ëª¨ë°©í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.
         * ì‹¤ì œë¡œëŠ” ì„œë²„ì— ìš”ì²­ì„ ë³´ë‚´ì•¼ í•˜ì§€ë§Œ, ì—¬ê¸°ì„œëŠ” í”Œë ˆì´ìŠ¤í™€ë” ì´ë¯¸ì§€ URLì„ ë°˜í™˜í•©ë‹ˆë‹¤.
         */
        async function translateToEnglish(text) {
            try {
                const payload = {
                    contents: [{ role: 'user', parts: [{ text: `Translate the following text to English:\n${text}` }] }]
                };
                const res = await fetch('/.netlify/functions/gemini-handler', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error?.message || 'Gemini API Error');
                return data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || text;
            } catch (error) {
                console.error('Translation failed:', error);
                return text;
            }
        }

        async function generateImageForParagraph(text, context = "") {
            const basePrompt = `${text}\n${context}`.trim();
            const englishPrompt = await translateToEnglish(basePrompt);
            const finalPrompt = `${englishPrompt}, bright, child-friendly, storybook style`;
            const res = await fetch('/.netlify/functions/stability-handler', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    type: 'stability',
                    payload: {
                        text_prompts: [{ text: finalPrompt }],
                        cfg_scale: 7,
                        height: 1024,
                        width: 1024,
                        samples: 1,
                        steps: 30,
                        output_format: 'webp'
                    }
                })
            });

            let data;
            try {
                data = await res.json();
            } catch (_) {
                throw new Error('ì„œë²„ ì‘ë‹µì„ íŒŒì‹±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            }

            if (!res.ok) {
                const message = data.error?.message || data.error || 'Stability API Error';
                throw new Error(message);
            }

            const base64 = data.image || data.artifacts?.[0]?.base64;
            if (!base64) {
                throw new Error('ì´ë¯¸ì§€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }

            return `data:image/webp;base64,${base64}`;
        }

        async function generateImageForParagraphGPT(text, context = "") {
            const basePrompt = `${text}\n${context}`.trim();
            const englishPrompt = await translateToEnglish(basePrompt);
            const finalPrompt = `${englishPrompt}, bright, child-friendly, storybook style`;
            const res = await fetch('/.netlify/functions/gpt-handler', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ prompt: finalPrompt })
            });

            let data;
            try {
                data = await res.json();
            } catch (_) {
                throw new Error('ì„œë²„ ì‘ë‹µì„ íŒŒì‹±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            }

            if (!res.ok) {
                const message = data.error?.message || data.error || 'GPT Image API Error';
                throw new Error(message);
            }

            const base64 = data.data?.[0]?.b64_json;
            if (!base64) {
                throw new Error('ì´ë¯¸ì§€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }

            return `data:image/webp;base64,${base64}`;
        }

        // ìˆ˜ë™ ì±… ë§Œë“¤ê¸° ì‹œì‘
        function startManualBookCreation() {
            buildBookViewer();
            document.getElementById('book-viewer-page').classList.remove('hidden');
        }

        // ì±… ë·°ì–´ UI êµ¬ì„±
        function buildBookViewer() {
            const viewer = document.getElementById("book-viewer");
            viewer.innerHTML = ""; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”

            totalBookSpreads = 3; // ê¸°ë³¸ 3ì¥ (í‘œì§€, ë“±ì¥ì¸ë¬¼, ì´ì•¼ê¸° ì‹œì‘)
            
            // 0. í‘œì§€ í˜ì´ì§€
            const spread0 = `
                <div id="spread-0" class="book-spread book-viewer" data-page-type="cover">
                    <div class="book-page bg-white border-r border-gray-300">
                        <div style="width: 80%; text-align: center;">
                            <div class="text-box mb-4">
                                <h1 class="text-3xl font-bold editable-text book-title-sync" contenteditable="true">ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”</h1>
                            </div>
                            <div class="text-box inline-block">
                                <p class="book-author-sync" contenteditable="false">ê¸€ì“´ì´</p>
                            </div>
                        </div>
                    </div>
                    <div class="book-page bg-gray-200">
                        <div class="absolute top-6 left-6">
                            <div class="text-sm font-semibold mb-1 text-gray-600">ì œëª©</div>
                            <div class="text-xl p-2 bg-white bg-opacity-80 rounded shadow editable-text book-title-sync" contenteditable="true">ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”</div>
                        </div>
                        <div class="absolute bottom-4 right-4 text-box">
                            <p class="book-author-sync" contenteditable="false">ê¸€ì“´ì´</p>
                        </div>
                    </div>
                </div>
            `;

            // 1. ë“±ì¥ì¸ë¬¼ ì†Œê°œ í˜ì´ì§€
            const spread1 = `
                <div id="spread-1" class="book-spread book-viewer" data-page-type="character">
                    <!-- ì™¼ìª½ í˜ì´ì§€ (1) -->
                    <div class="book-page bg-white border-r border-gray-300">
                        <h2 class="absolute top-6 text-2xl font-bold text-gray-700">ë“±ì¥ì¸ë¬¼ ì†Œê°œ</h2>
                        <div class="w-full h-full flex flex-col items-center justify-center pt-16">
                           <div class="w-full h-1/2 bg-gray-200 mb-4 rounded flex items-center justify-center text-gray-400 character-image-box" style="background-size: cover; background-position: center;">ê·¸ë¦¼ 1</div>
                           <div class="editable-text text-xl font-bold" contenteditable="true">ì´ë¦„ 1</div>
                           <textarea class="manual-text-area mt-2 h-1/4 text-sm" placeholder="ì–´ë–¤ ì¸ë¬¼ì¸ì§€ ì„¤ëª…í•´ì£¼ì„¸ìš”."></textarea>
                        </div>
                        <div class="page-number" style="left: 0.5rem;">1</div>
                    </div>
                    <!-- ì˜¤ë¥¸ìª½ í˜ì´ì§€ (2) -->
                    <div class="book-page bg-white">
                         <h2 class="absolute top-6 text-2xl font-bold text-gray-700 opacity-0">ë“±ì¥ì¸ë¬¼ ì†Œê°œ</h2>
                         <div class="w-full h-full flex flex-col items-center justify-center pt-16">
                           <div class="w-full h-1/2 bg-gray-200 mb-4 rounded flex items-center justify-center text-gray-400 character-image-box" style="background-size: cover; background-position: center;">ê·¸ë¦¼ 2</div>
                           <div class="editable-text text-xl font-bold" contenteditable="true">ì´ë¦„ 2</div>
                           <textarea class="manual-text-area mt-2 h-1/4 text-sm" placeholder="ì–´ë–¤ ì¸ë¬¼ì¸ì§€ ì„¤ëª…í•´ì£¼ì„¸ìš”."></textarea>
                        </div>
                        <div class="page-number" style="right: 0.5rem;">2</div>
                    </div>
                </div>
            `;
            
            // 2. ì´ì•¼ê¸° ì‹œì‘ í˜ì´ì§€
            const spread2 = `
                 <div id="spread-2" class="book-spread book-viewer" data-page-type="story">
                    <!-- ì™¼ìª½ í˜ì´ì§€ (3) -->
                    <div class="book-page bg-gray-200 border-r border-gray-300 flex items-center justify-center">
                        <span class="text-gray-400">ê·¸ë¦¼ì´ ìƒì„±ë  ê³³</span>
                        <div class="page-number" style="left: 0.5rem;">3</div>
                    </div>
                    <!-- ì˜¤ë¥¸ìª½ í˜ì´ì§€ (4) -->
                    <div class="book-page bg-white">
                        <textarea class="manual-text-area" placeholder="ì—¬ê¸°ì— ì´ì•¼ê¸°ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                        <div class="page-number" style="right: 0.5rem;">4</div>
                    </div>
                </div>
            `;

            // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ë° í˜ì´ì§€ ì•¡ì…˜ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ
            const navButtons = `
                <button id="prev-page-btn" onclick="changeBookPage(-1)" class="page-nav left-2">â€¹</button>
                <button id="next-page-btn" onclick="changeBookPage(1)" class="page-nav right-2">â€º</button>
                <div id="page-action-buttons" class="absolute top-4 right-4 flex gap-2 z-10"></div>
            `;

            viewer.innerHTML = spread0 + spread1 + spread2 + navButtons;

            bookCurrentPage = 0;
            document.getElementById('spread-0').classList.add('active'); // ì²« í˜ì´ì§€ í™œì„±í™”
            updateBookView();
            // ë¹Œë“œ í›„ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ì´ë¦„ì„ ì €ì ì˜ì—­ì— ë°˜ì˜í•©ë‹ˆë‹¤.
            window.syncBookAuthor();
        }
        
        // ID ë° í˜ì´ì§€ ë²ˆí˜¸ ì¬ì •ë ¬
        function updatePageNumbersAndIDs() {
            const spreads = document.querySelectorAll("#book-viewer .book-spread");
            spreads.forEach((spread, index) => {
                spread.id = `spread-${index}`;

                // í‘œì§€(index 0)ì—ëŠ” í˜ì´ì§€ ë²ˆí˜¸ ì—†ìŒ
                if (index > 0) {
                    const leftPageNumEl = spread.querySelector('.page-number[style*="left"]');
                    const rightPageNumEl = spread.querySelector('.page-number[style*="right"]');

                    if (leftPageNumEl) {
                        leftPageNumEl.textContent = (index - 1) * 2 + 1;
                    }
                    if (rightPageNumEl) {
                        rightPageNumEl.textContent = (index - 1) * 2 + 2;
                    }
                }
            });
        }
        
        // ë“±ì¥ì¸ë¬¼ í˜ì´ì§€ ì¶”ê°€
        function addCharacterPage() {
            const viewer = document.getElementById("book-viewer");
            const characterSpreads = viewer.querySelectorAll('.book-spread[data-page-type="character"]');

            const existingCharacters = viewer.querySelectorAll('.character-image-box').length;
            const charNum1 = existingCharacters + 1;
            const charNum2 = existingCharacters + 2;

            const newSpread = document.createElement("div");
            newSpread.className = "book-spread book-viewer";
            newSpread.dataset.pageType = "character";

            newSpread.innerHTML = `
                <div class="book-page bg-white border-r border-gray-300">
                    <h2 class="absolute top-6 text-2xl font-bold text-gray-700">ë“±ì¥ì¸ë¬¼ ì†Œê°œ</h2>
                    <div class="w-full h-full flex flex-col items-center justify-center pt-16">
                       <div class="w-full h-1/2 bg-gray-200 mb-4 rounded flex items-center justify-center text-gray-400 character-image-box" style="background-size: cover; background-position: center;">ê·¸ë¦¼ ${charNum1}</div>
                       <div class="editable-text text-xl font-bold" contenteditable="true">ì´ë¦„ ${charNum1}</div>
                       <textarea class="manual-text-area mt-2 h-1/4 text-sm" placeholder="ì–´ë–¤ ì¸ë¬¼ì¸ì§€ ì„¤ëª…í•´ì£¼ì„¸ìš”."></textarea>
                    </div>
                    <div class="page-number" style="left: 0.5rem;"></div>
                </div>
                <div class="book-page bg-white">
                     <h2 class="absolute top-6 text-2xl font-bold text-gray-700 opacity-0">ë“±ì¥ì¸ë¬¼ ì†Œê°œ</h2>
                     <div class="w-full h-full flex flex-col items-center justify-center pt-16">
                       <div class="w-full h-1/2 bg-gray-200 mb-4 rounded flex items-center justify-center text-gray-400 character-image-box" style="background-size: cover; background-position: center;">ê·¸ë¦¼ ${charNum2}</div>
                       <div class="editable-text text-xl font-bold" contenteditable="true">ì´ë¦„ ${charNum2}</div>
                       <textarea class="manual-text-area mt-2 h-1/4 text-sm" placeholder="ì–´ë–¤ ì¸ë¬¼ì¸ì§€ ì„¤ëª…í•´ì£¼ì„¸ìš”."></textarea>
                    </div>
                    <div class="page-number" style="right: 0.5rem;"></div>
                </div>
            `;

            if (characterSpreads.length === 0) {
                const cover = document.getElementById('spread-0');
                cover.after(newSpread);
            } else {
                const lastCharacterSpread = characterSpreads[characterSpreads.length - 1];
                lastCharacterSpread.after(newSpread);
            }
            totalBookSpreads++;
            
            updatePageNumbersAndIDs();
            
            const newPageIndex = Array.from(viewer.querySelectorAll('.book-spread')).indexOf(newSpread);
            bookCurrentPage = newPageIndex;
            updateBookView();
        }

        // ì´ì•¼ê¸° í˜ì´ì§€ ì¶”ê°€
        function addManualPage() {
            const viewer = document.getElementById("book-viewer");
            const newSpread = document.createElement("div");
            newSpread.className = "book-spread book-viewer";
            newSpread.dataset.pageType = 'story';
            
            newSpread.innerHTML = `
                <div class="book-page bg-gray-200 border-r border-gray-300 flex items-center justify-center">
                    <span class="text-gray-400">ê·¸ë¦¼ì´ ìƒì„±ë  ê³³</span>
                    <div class="page-number" style="left: 0.5rem;"></div>
                </div>
                <div class="book-page bg-white">
                    <textarea class="manual-text-area" placeholder="ì—¬ê¸°ì— ì´ì•¼ê¸°ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                    <div class="page-number" style="right: 0.5rem;"></div>
                </div>
            `;
            
            const prevButton = document.getElementById('prev-page-btn');
            viewer.insertBefore(newSpread, prevButton);

            totalBookSpreads++;
            updatePageNumbersAndIDs();
            
            bookCurrentPage = totalBookSpreads - 1;
            updateBookView();
        }

        // í˜„ì¬ í˜ì´ì§€ ì‚­ì œ
        function deleteCurrentPage() {
            const currentSpread = document.getElementById(`spread-${bookCurrentPage}`);
            if (!currentSpread) return;
            const type = currentSpread.dataset.pageType;
            if (type === 'cover') {
                showNotification("í‘œì§€ëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            if (type === 'character') {
                // ë“±ì¥ì¸ë¬¼ í˜ì´ì§€ëŠ” ëª¨ë‘ ì‚­ì œ ê°€ëŠ¥
            }
            if (type === 'story') {
                const storySpreads = Array.from(document.querySelectorAll('#book-viewer .book-spread[data-page-type="story"]'));
                if (storySpreads.indexOf(currentSpread) === 0) {
                    showNotification("ê¸°ë³¸ ì¤„ê±°ë¦¬ í˜ì´ì§€ëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }
            }
            currentSpread.remove();
            totalBookSpreads--;
            bookCurrentPage = Math.max(0, Math.min(bookCurrentPage, totalBookSpreads - 1));
            updatePageNumbersAndIDs();
            updateBookView();
            showNotification("í˜ì´ì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        // ì±… ì´ˆì•ˆ ì €ì¥
        async function saveBookDraft() {
            if (!bookCode || !auth?.currentUser) {
                showNotification("ì½”ë“œê°€ ì—†ì–´ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            const btn = document.getElementById('save-book-btn');
            btn.disabled = true;
            btn.textContent = 'ì €ì¥ ì¤‘...';
            try {
                const data = {
                    title: document.querySelector('#spread-0 .book-title-sync')?.textContent.trim() || '',
                    author: window.authorName || '',
                    updatedAt: serverTimestamp(),
                    totalSpreads: document.querySelectorAll('#book-viewer .book-spread').length,
                    characterSpreadCount: document.querySelectorAll('#book-viewer .book-spread[data-page-type="character"]').length,
                    storySpreadCount: document.querySelectorAll('#book-viewer .book-spread[data-page-type="story"]').length,
                };

                  const uploads = [];

                  // í‘œì§€ ì´ë¯¸ì§€ (1ì¥ ì˜¤ë¥¸ìª½ ë°°ê²½)
                  const coverPage = document.querySelector('#spread-0 .book-page:nth-child(2)');
                  if (coverPage) {
                    const bg = coverPage.style.backgroundImage;
                    const match = bg.match(/url\(["']?(data:image\/[^"')]+)["']?\)/);
                    if (match) {
                        if (!coverPage.dataset.imageName) {
                            coverPage.dataset.imageName = `cover-${Date.now()}.webp`;
                        }
                        const imgRef = storageRef(storage, `Book/${bookCode}/${coverPage.dataset.imageName}`);
                        uploads.push(uploadString(imgRef, match[1], 'data_url'));
                        data.coverImage = coverPage.dataset.imageName;
                    } else if (coverPage.dataset.imageName) {
                        data.coverImage = coverPage.dataset.imageName;
                    }
                  }

                const coverSpread = document.querySelector('#spread-0');
                if (coverSpread) {
                    data.coverPrompt = coverSpread.dataset.prompt || '';
                }

                  // ë“±ì¥ì¸ë¬¼ ì •ë³´ ì €ì¥
                  const characterPages = document.querySelectorAll('.book-spread[data-page-type="character"] .book-page');
                  characterPages.forEach((page, idx) => {
                      const charIndex = idx + 1;
                      const imgBox = page.querySelector('.character-image-box');
                      if (imgBox) {
                          const bg = imgBox.style.backgroundImage;
                          const match = bg.match(/url\(["']?(data:image\/[^"')]+)["']?\)/);
                          if (match) {
                              if (!imgBox.dataset.imageName) {
                                  imgBox.dataset.imageName = `character-${charIndex}-${Date.now()}.webp`;
                              }
                              const imgRef = storageRef(storage, `Book/${bookCode}/${imgBox.dataset.imageName}`);
                              uploads.push(uploadString(imgRef, match[1], 'data_url'));
                              data[`character${charIndex}Image`] = imgBox.dataset.imageName;
                          } else if (imgBox.dataset.imageName) {
                              data[`character${charIndex}Image`] = imgBox.dataset.imageName;
                          }
                      }

                      const nameEl = page.querySelector('.editable-text');
                      if (nameEl) {
                          data[`character${charIndex}Name`] = nameEl.textContent.trim();
                      }
                      const descEl = page.querySelector('textarea.manual-text-area');
                      if (descEl) {
                          data[`character${charIndex}Desc`] = descEl.value;
                      }
                  });

                  const characterSpreads = document.querySelectorAll('.book-spread[data-page-type="character"]');
                  characterSpreads.forEach((spread, idx) => {
                      const base = idx * 2 + 1;
                      data[`character${base}Prompt`] = spread.dataset.promptLeft || '';
                      data[`character${base + 1}Prompt`] = spread.dataset.promptRight || '';
                  });

                  // ì¤„ê±°ë¦¬ ì €ì¥
                  const storySpreads = document.querySelectorAll('.book-spread[data-page-type="story"]');
                  storySpreads.forEach((spread, idx) => {
                      const storyIndex = idx + 1;
                    const imagePage = spread.querySelector('.book-page:first-child');
                    if (imagePage) {
                        const bg = imagePage.style.backgroundImage;
                        const match = bg.match(/url\(["']?(data:image\/[^"')]+)["']?\)/);
                        if (match) {
                            if (!imagePage.dataset.imageName) {
                                imagePage.dataset.imageName = `story-${storyIndex}-${Date.now()}.webp`;
                            }
                            const imgRef = storageRef(storage, `Book/${bookCode}/${imagePage.dataset.imageName}`);
                            uploads.push(uploadString(imgRef, match[1], 'data_url'));
                            data[`story${storyIndex}Image`] = imagePage.dataset.imageName;
                        } else if (imagePage.dataset.imageName) {
                            data[`story${storyIndex}Image`] = imagePage.dataset.imageName;
                        }
                    }
                      const textPage = spread.querySelector('.book-page:last-child textarea.manual-text-area');
                      if (textPage) {
                          data[`story${storyIndex}Text`] = textPage.value;
                      }
                      data[`story${storyIndex}Prompt`] = spread.dataset.prompt || '';
                  });

                await Promise.all(uploads);

                await setDoc(doc(db, 'Book', bookCode), data, { merge: true });

                const myBooksRef = collection(db, `users/${bookAuthorUid}/myBooks`);
                const q = query(myBooksRef, where('bookId', '==', bookCode));
                const snap = await getDocs(q);
                snap.forEach(docSnap => updateDoc(docSnap.ref, { title: data.title }));

                showNotification('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (err) {
                console.error(err);
                showNotification('ì €ì¥ ì‹¤íŒ¨: ' + err.message);
            } finally {
                btn.textContent = 'ì €ì¥í•˜ê¸°';
                btn.disabled = false;
            }
        }

        // ë„ì„œê´€ ë“±ë¡
        async function registerToLibrary() {
            if (!bookCode || !auth?.currentUser) {
                showNotification('ë“±ë¡í•  ì±…ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const btn = document.getElementById('register-library-btn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'ë“±ë¡ ì¤‘...';

            try {
                await updateDoc(doc(db, 'Book', bookCode), {
                    isPublic: true,
                    publishedAt: serverTimestamp()
                });
                showNotification('ë„ì„œê´€ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                await loadLibraryBooks();
            } catch (error) {
                console.error('ë„ì„œê´€ ë“±ë¡ ì‹¤íŒ¨:', error);
                showNotification('ë„ì„œê´€ ë“±ë¡ ì‹¤íŒ¨: ' + error.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // ì±… ì™„ì„± (ê·¸ë¦¼ ìƒì„±)
        async function completeManualBook() {
            const generateBtn = document.getElementById("generate-images-btn");
            const registerBtn = document.getElementById('register-library-btn');
            const savePdfBtn = document.getElementById('save-book-pdf-btn');
            
            const originalGenerateText = "ê·¸ë¦¼ ìƒì„±í•˜ê¸°";

            generateBtn.textContent = "ìƒì„± ì¤‘...";
            generateBtn.disabled = true;

            try {
                // ë“±ì¥ì¸ë¬¼ ì»¨í…ìŠ¤íŠ¸ ìˆ˜ì§‘ ë° ì´ë¯¸ì§€ ìƒì„±
                const charSpreads = document.querySelectorAll('.book-spread[data-page-type="character"]');
                const contextParts = [];
                for (const charSpread of charSpreads) {
                    const charImageBoxes = charSpread.querySelectorAll('.character-image-box');
                    const prompts = [charSpread.dataset.promptLeft, charSpread.dataset.promptRight];
                    const charDescriptions = charSpread.querySelectorAll('textarea');
                    const charNames = charSpread.querySelectorAll('.editable-text');

                    for (let i = 0; i < charImageBoxes.length; i++) {
                        let prompt = prompts[i];
                        if (!prompt) {
                            const desc = charDescriptions[i]?.value || '';
                            const name = charNames[i]?.textContent || '';
                            if (desc || name) {
                                prompt = `${name}, ${desc}`.trim();
                            }
                        }
                        if (prompt) {
                            contextParts.push(prompt);
                            const charPrompt = `${prompt}, white background, single character`;
                            const charImage = await generateImageForParagraph(charPrompt, '');
                            charImageBoxes[i].style.backgroundImage = `url('${charImage}')`;
                            charImageBoxes[i].textContent = '';
                        }
                    }
                }
                const context = contextParts.join('\n');

                // í‘œì§€ ì´ë¯¸ì§€ ìƒì„±
                const coverSpread = document.querySelector('#spread-0');
                const coverPrompt = coverSpread?.dataset.prompt || document.querySelector("#spread-0 .book-title-sync").textContent;
                const coverImage = await generateImageForParagraph(coverPrompt, '');
                document.querySelector("#spread-0 .book-page:last-child").style.backgroundImage = `url('${coverImage}')`;

                // ê° ì´ì•¼ê¸° í˜ì´ì§€ ì´ë¯¸ì§€ ìƒì„±
                const storySpreads = document.querySelectorAll('.book-spread[data-page-type="story"]');
                for (const spread of storySpreads) {
                    const storyText = spread.querySelector("textarea").value;
                    const extra = spread.dataset.prompt || '';
                    const prompt = `${storyText}\n${extra}`.trim();
                    if (prompt) {
                        const imageUrl = await generateImageForParagraph(prompt, context);
                        const imagePage = spread.querySelector(".book-page:first-child");
                        const pageNumHTML = imagePage.querySelector('.page-number')?.outerHTML || '';
                        imagePage.style.backgroundImage = `url('${imageUrl}')`;
                        imagePage.innerHTML = pageNumHTML;
                    }
                }
                showNotification("ì±…ì´ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ì´ì œ ë„ì„œê´€ì— ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                
                // ê·¸ë¦¼ ìƒì„± ë²„íŠ¼ì€ ì˜êµ¬ì ìœ¼ë¡œ ë¹„í™œì„±í™”
                generateBtn.disabled = true;
                
                // PDF ì €ì¥ ë° ë„ì„œê´€ ë“±ë¡ ë²„íŠ¼ ë³´ì´ê¸° ë° í™œì„±í™”
                if(savePdfBtn) {
                    savePdfBtn.classList.remove('hidden');
                }
                if(registerBtn) {
                    registerBtn.classList.remove('hidden');
                    registerBtn.disabled = false;
                }

            } catch (error) {
                console.error("ìˆ˜ë™ ì±… ì™„ì„± ì˜¤ë¥˜:", error);
                showNotification(`ê·¸ë¦¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                
                // ì‹¤íŒ¨ ì‹œ ê·¸ë¦¼ ìƒì„± ë²„íŠ¼ ì›ìƒ ë³µêµ¬
                generateBtn.textContent = originalGenerateText;
                generateBtn.disabled = false;
            }
        }

        async function completeManualBookGPT() {
            const gptBtn = document.getElementById("generate-images-gpt-btn");
            const stabilityBtn = document.getElementById("generate-images-btn");
            const registerBtn = document.getElementById('register-library-btn');
            const savePdfBtn = document.getElementById('save-book-pdf-btn');

            const originalText = "GPT ì‚¬ì§„ ë§Œë“¤ê¸°/1í† í°";

            gptBtn.textContent = "ìƒì„± ì¤‘...";
            gptBtn.disabled = true;
            if (stabilityBtn) stabilityBtn.disabled = true;

            try {
                const userRef = doc(db, 'users', bookAuthorUid);
                const userDoc = await getDoc(userRef);
                const tokens = Number(userDoc.data()?.aeduTokens) || 0;
                if (tokens < 1) {
                    alert('ì—ì´ë‘ í† í°ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.');
                    gptBtn.textContent = originalText;
                    gptBtn.disabled = false;
                    if (stabilityBtn) stabilityBtn.disabled = false;
                    return;
                }
                await updateDoc(userRef, { aeduTokens: increment(-1) });
                await updateUserInfo();

                // ë“±ì¥ì¸ë¬¼ ì»¨í…ìŠ¤íŠ¸ ìˆ˜ì§‘ ë° ì´ë¯¸ì§€ ìƒì„±
                const charSpreads = document.querySelectorAll('.book-spread[data-page-type="character"]');
                const contextParts = [];
                for (const charSpread of charSpreads) {
                    const charImageBoxes = charSpread.querySelectorAll('.character-image-box');
                    const prompts = [charSpread.dataset.promptLeft, charSpread.dataset.promptRight];
                    const charDescriptions = charSpread.querySelectorAll('textarea');
                    const charNames = charSpread.querySelectorAll('.editable-text');

                    for (let i = 0; i < charImageBoxes.length; i++) {
                        let prompt = prompts[i];
                        if (!prompt) {
                            const desc = charDescriptions[i]?.value || '';
                            const name = charNames[i]?.textContent || '';
                            if (desc || name) {
                                prompt = `${name}, ${desc}`.trim();
                            }
                        }
                        if (prompt) {
                            contextParts.push(prompt);
                            const charPrompt = `${prompt}, white background, single character`;
                            const charImage = await generateImageForParagraphGPT(charPrompt, '');
                            charImageBoxes[i].style.backgroundImage = `url('${charImage}')`;
                            charImageBoxes[i].textContent = '';
                        }
                    }
                }
                const context = contextParts.join('\n');

                // í‘œì§€ ì´ë¯¸ì§€ ìƒì„±
                const coverSpread = document.querySelector('#spread-0');
                const coverPrompt = coverSpread?.dataset.prompt || document.querySelector("#spread-0 .book-title-sync").textContent;
                const coverImage = await generateImageForParagraphGPT(coverPrompt, '');
                document.querySelector("#spread-0 .book-page:last-child").style.backgroundImage = `url('${coverImage}')`;

                // ê° ì´ì•¼ê¸° í˜ì´ì§€ ì´ë¯¸ì§€ ìƒì„±
                const storySpreads = document.querySelectorAll('.book-spread[data-page-type="story"]');
                for (const spread of storySpreads) {
                    const storyText = spread.querySelector("textarea").value;
                    const extra = spread.dataset.prompt || '';
                    const prompt = `${storyText}\n${extra}`.trim();
                    if (prompt) {
                        const imageUrl = await generateImageForParagraphGPT(prompt, context);
                        const imagePage = spread.querySelector(".book-page:first-child");
                        const pageNumHTML = imagePage.querySelector('.page-number')?.outerHTML || '';
                        imagePage.style.backgroundImage = `url('${imageUrl}')`;
                        imagePage.innerHTML = pageNumHTML;
                    }
                }
                showNotification("ì±…ì´ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ì´ì œ ë„ì„œê´€ì— ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");

                gptBtn.disabled = true;

                if (savePdfBtn) {
                    savePdfBtn.classList.remove('hidden');
                }
                if (registerBtn) {
                    registerBtn.classList.remove('hidden');
                    registerBtn.disabled = false;
                }

            } catch (error) {
                console.error("ìˆ˜ë™ ì±… ì™„ì„± ì˜¤ë¥˜:", error);
                showNotification(`ê·¸ë¦¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);

                gptBtn.textContent = originalText;
                gptBtn.disabled = false;
                if (stabilityBtn) stabilityBtn.disabled = false;
            }
        }
        
        // í˜ì´ì§€ ë„˜ê¸°ê¸°
        function changeBookPage(direction) {
            bookCurrentPage = Math.max(0, Math.min(bookCurrentPage + direction, totalBookSpreads - 1));
            updateBookView();
        }

        function renderPromptArea(spread) {
            const wrapper = document.getElementById('page-prompt-wrapper');
            if (!wrapper) return;
            wrapper.innerHTML = '';
            if (!spread) return;

            const type = spread.dataset.pageType;

            if (type === 'cover') {
                wrapper.innerHTML = `
            <label class="block text-lg font-semibold text-gray-700 mb-2">í‘œì§€ ì‚¬ì§„ì„ ì–´ë–»ê²Œ ë§Œë“¤ê¹Œìš”?</label>
            <textarea id="page-prompt-input" class="w-full p-3 border border-gray-300 rounded-lg" rows="3"></textarea>
        `;
                const input = wrapper.querySelector('#page-prompt-input');
                input.value = spread.dataset.prompt || '';
                input.addEventListener('input', (e) => {
                    spread.dataset.prompt = e.target.value;
                });
            } else if (type === 'character') {
                wrapper.innerHTML = `
            <div class="flex gap-4">
                <div class="flex-1">
                    <label class="block text-lg font-semibold text-gray-700 mb-2 text-left">ë“±ì¥ì¸ë¬¼ì„ ì–´ë–»ê²Œ ë§Œë“¤ê¹Œìš”?</label>
                    <textarea id="page-prompt-left" class="w-full p-3 border border-gray-300 rounded-lg" rows="2"></textarea>
                </div>
                <div class="flex-1 text-right">
                    <label class="block text-lg font-semibold text-gray-700 mb-2 text-right">ë“±ì¥ì¸ë¬¼ì„ ì–´ë–»ê²Œ ë§Œë“¤ê¹Œìš”?</label>
                    <textarea id="page-prompt-right" class="w-full p-3 border border-gray-300 rounded-lg" rows="2"></textarea>
                </div>
            </div>
        `;
                const left = wrapper.querySelector('#page-prompt-left');
                const right = wrapper.querySelector('#page-prompt-right');
                left.value = spread.dataset.promptLeft || '';
                right.value = spread.dataset.promptRight || '';
                left.addEventListener('input', (e) => {
                    spread.dataset.promptLeft = e.target.value;
                });
                right.addEventListener('input', (e) => {
                    spread.dataset.promptRight = e.target.value;
                });
            } else if (type === 'story') {
                wrapper.innerHTML = `
            <label class="block text-lg font-semibold text-gray-700 mb-2">ì´ í˜ì´ì§€ì˜ ì¤„ê±°ë¦¬ ì‚¬ì§„ì„ ì–´ë–»ê²Œ ë§Œë“¤ê¹Œìš”?</label>
            <textarea id="page-prompt-input" class="w-full p-3 border border-gray-300 rounded-lg" rows="3"></textarea>
        `;
                const input = wrapper.querySelector('#page-prompt-input');
                input.value = spread.dataset.prompt || '';
                input.addEventListener('input', (e) => {
                    spread.dataset.prompt = e.target.value;
                });
            }
        }

        function updateBookView() {
    document.querySelectorAll(".book-spread").forEach((spread, index) => {
        spread.classList.toggle("active", index === bookCurrentPage);
    });
    document.getElementById("prev-page-btn").style.display = bookCurrentPage === 0 ? "none" : "block";
    document.getElementById("next-page-btn").style.display = bookCurrentPage >= totalBookSpreads - 1 ? "none" : "block";

    const actionContainer = document.getElementById('page-action-buttons');
    actionContainer.innerHTML = '';
    const currentSpread = document.getElementById(`spread-${bookCurrentPage}`);
    if (!currentSpread) return;
    const type = currentSpread.dataset.pageType;

    if (type === 'story') {
        const storySpreads = Array.from(document.querySelectorAll('#book-viewer .book-spread[data-page-type="story"]'));
        const storyIndex = storySpreads.indexOf(currentSpread);
        const charSpreads = document.querySelectorAll('#book-viewer .book-spread[data-page-type="character"]');
        let buttons = '';
        if (charSpreads.length === 0) {
            buttons += `<button onclick="addCharacterPage()" class="bg-sky-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-600">+ ë“±ì¥ì¸ë¬¼ ì¶”ê°€</button>`;
        }
        buttons += `<button onclick="addManualPage()" class="bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-600">+ í˜ì´ì§€ ì¶”ê°€</button>`;
        if (storyIndex > 0) {
            buttons += `<button onclick="deleteCurrentPage()" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600">í˜ì´ì§€ ì‚­ì œ</button>`;
        }
        actionContainer.innerHTML = buttons;
    } else if (type === 'character') {
        let buttons = `<button onclick="addCharacterPage()" class="bg-sky-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-600">+ ë“±ì¥ì¸ë¬¼ ì¶”ê°€</button>`;
        buttons += `<button onclick="deleteCurrentPage()" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600">í˜ì´ì§€ ì‚­ì œ</button>`;
        actionContainer.innerHTML = buttons;
    } else if (type === 'cover') {
        const charSpreads = document.querySelectorAll('#book-viewer .book-spread[data-page-type="character"]');
        if (charSpreads.length === 0) {
            actionContainer.innerHTML = `<button onclick="addCharacterPage()" class="bg-sky-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-600">+ ë“±ì¥ì¸ë¬¼ ì¶”ê°€</button>`;
        }
    }
    renderPromptArea(currentSpread);
}

        // PDFë¡œ ë‹¤ìš´ë¡œë“œ
        async function downloadBookAsPDF() {
            const button = document.getElementById('save-book-pdf-btn');
            button.textContent = "PDF ìƒì„± ì¤‘...";
            button.disabled = true;

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: "landscape", unit: "mm", format: "a4" });
            const spreads = document.querySelectorAll(".book-spread");
            const originalPage = bookCurrentPage;

            for (let i = 0; i < spreads.length; i++) {
                if (i > 0) pdf.addPage("a4", "l");
                
                // í˜„ì¬ í˜ì´ì§€ë§Œ ë³´ì´ê²Œ ì„¤ì •
                document.querySelectorAll(".book-spread").forEach(s => s.classList.remove("active"));
                spreads[i].classList.add("active");
                
                // ë Œë”ë§ ì‹œê°„ í™•ë³´
                await new Promise(res => setTimeout(res, 100));

                const canvas = await html2canvas(spreads[i], {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: "#ffffff"
                });
                pdf.addImage(canvas.toDataURL("image/png"), "PNG", 0, 0, 297, 210);
            }

            pdf.save("ë‚˜ë§Œì˜_ë™í™”ì±….pdf");
            
            // ì›ë˜ í˜ì´ì§€ë¡œ ë³µêµ¬
            document.querySelectorAll(".book-spread").forEach(s => s.classList.remove("active"));
            if (spreads[originalPage]) spreads[originalPage].classList.add("active");
            
            button.textContent = "PDF ì €ì¥";
            button.disabled = false;
        }

        // ì œëª© ë° ê¸€ì“´ì´ ë™ê¸°í™” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.addEventListener('input', e => {
            const target = e.target;
            if (target.classList.contains('book-title-sync')) {
                const newContent = target.textContent;
                document.querySelectorAll('.book-title-sync').forEach(el => {
                    if (el !== target) {
                        el.textContent = newContent;
                    }
                });
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”ëŠ” ì¸ì¦ í›„ ì²˜ë¦¬ë©ë‹ˆë‹¤.
        
        // ë‹¨ì–´ í´ë¦­ ì‹œ TTS ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.addEventListener("click", e => {
            if (e.target.classList.contains("tts-word")) {
                speak(e.target.textContent.trim());
            }
        });

        const firebaseConfig = {
            apiKey: "AIzaSyDCeJPDQUNi-KmJ9DhkTRIu-9t2PGZCpt0",
            authDomain: "mansungcoin-c6e06.firebaseapp.com",
            projectId: "mansungcoin-c6e06",
            storageBucket: "mansungcoin-c6e06.firebasestorage.app",
            messagingSenderId: "704809284946",
            appId: "1:704809284946:web:3e71d98f38810577e1768b"
        };

        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        storage = getStorage(app);
        const studentLoginTab = document.getElementById('book-student-login-tab');
        const teacherLoginTab = document.getElementById('book-teacher-login-tab');
        const studentLoginContent = document.getElementById('book-student-login-content');
        const teacherLoginContent = document.getElementById('book-teacher-login-content');

        function switchLoginTab(tab) {
            if (tab === 'student') {
                studentLoginTab.classList.add('active');
                teacherLoginTab.classList.remove('active');
                studentLoginContent.classList.add('active');
                teacherLoginContent.classList.remove('active');
            } else {
                teacherLoginTab.classList.add('active');
                studentLoginTab.classList.remove('active');
                teacherLoginContent.classList.add('active');
                studentLoginContent.classList.remove('active');
            }
        }

        studentLoginTab.addEventListener('click', () => switchLoginTab('student'));
        teacherLoginTab.addEventListener('click', () => switchLoginTab('teacher'));
        switchLoginTab('student');

        const registerView = document.getElementById('book-student-register-view');
        const showRegisterBtn = document.getElementById('book-show-student-register-btn');
        const backToLoginBtn = document.getElementById('book-back-to-login-btn');

        showRegisterBtn.addEventListener('click', () => {
            document.getElementById('book-login-view').classList.add('hidden');
            registerView.classList.remove('hidden');
        });

        backToLoginBtn.addEventListener('click', () => {
            registerView.classList.add('hidden');
            document.getElementById('book-login-view').classList.remove('hidden');
        });

        document.getElementById('book-student-register-btn').addEventListener('click', async () => {
            const name = document.getElementById('book-student-name').value.trim();
            if (!name) { alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

            try {
                const counterRef = doc(db, 'metadata', 'counters');
                const newCode = await runTransaction(db, async (transaction) => {
                    const counterDoc = await transaction.get(counterRef);
                    let nextCode = 1;
                    if (counterDoc.exists() && counterDoc.data().lastUserCode) {
                        nextCode = counterDoc.data().lastUserCode + 1;
                    }
                    transaction.set(counterRef, { lastUserCode: nextCode }, { merge: true });
                    return nextCode;
                });

                const email = `${newCode}@abc.com`;
                const password = `${newCode}qwerty`;
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);

                await setDoc(doc(db, 'users', userCredential.user.uid), {
                    uid: userCredential.user.uid,
                    name: name,
                    email: email,
                    userCode: newCode,
                    role: 'student',
                    coins: 0,
                    balance: 0,
                    portfolio: {},
                    createdAt: serverTimestamp()
                });

                await addDoc(collection(db, 'signupLog'), {
                    name: name,
                    userCode: newCode,
                    role: 'student',
                    signedUpAt: serverTimestamp()
                });

                alert(`í™˜ì˜í•©ë‹ˆë‹¤, ${name} í•™ìƒ! ê³ ìœ  ì½”ë“œëŠ” ${newCode} ì…ë‹ˆë‹¤.`);
                registerView.classList.add('hidden');
                document.getElementById('book-login-view').classList.remove('hidden');
            } catch (e) {
                console.error('Error adding document: ', e);
                alert('í•™ìƒ ë“±ë¡ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        const addBookModal = document.getElementById('add-book-modal');
        const cancelAddBookBtn = document.getElementById('cancel-add-book');
        const confirmAddBookBtn = document.getElementById('confirm-add-book');
        const newBookTitleInput = document.getElementById('new-book-title');
        const bookLogoutBtn = document.getElementById('book-logout-btn');
        const myInfoBtn = document.getElementById('my-info-btn');
        const myInfoModal = document.getElementById('my-info-modal');
        const myInfoNameInput = document.getElementById('my-info-name');
        const myInfoSaveBtn = document.getElementById('my-info-save-btn');
        const closeMyInfoModalBtn = document.getElementById('close-my-info-modal');
        const myBooksTab = document.getElementById('my-books-tab');
        const libraryTab = document.getElementById('library-tab');
        const myBookListEl = document.getElementById('my-book-list');
        const libraryBookListEl = document.getElementById('library-book-list');

        myBooksTab.addEventListener('click', () => {
            myBooksTab.classList.add('border-orange-500', 'text-orange-500');
            libraryTab.classList.remove('border-orange-500', 'text-orange-500');
            myBookListEl.classList.remove('hidden');
            libraryBookListEl.classList.add('hidden');
            loadUserBooks();
        });

        libraryTab.addEventListener('click', () => {
            libraryTab.classList.add('border-orange-500', 'text-orange-500');
            myBooksTab.classList.remove('border-orange-500', 'text-orange-500');
            libraryBookListEl.classList.remove('hidden');
            myBookListEl.classList.add('hidden');
            loadLibraryBooks();
        });

        bookLogoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Error signing out:', error);
            }
        });

        myInfoBtn.addEventListener('click', () => {
            if (!bookAuthorUid) return;
            myInfoNameInput.value = window.authorName || '';
            myInfoModal.classList.remove('hidden');
            myInfoNameInput.focus();
        });
        closeMyInfoModalBtn.addEventListener('click', () => myInfoModal.classList.add('hidden'));
        myInfoSaveBtn.addEventListener('click', async () => {
            const newName = myInfoNameInput.value.trim();
            if (!newName) { showNotification('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
            try {
                await updateDoc(doc(db, 'users', bookAuthorUid), { name: newName });
                showNotification('ì´ë¦„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                myInfoModal.classList.add('hidden');
                await updateUserInfo();
            } catch (err) {
                console.error('Error updating name:', err);
                showNotification('ì´ë¦„ ë³€ê²½ ì‹¤íŒ¨: ' + err.message);
            }
        });

        cancelAddBookBtn.addEventListener('click', () => {
            addBookModal.classList.add('hidden');
        });

        confirmAddBookBtn.addEventListener('click', async () => {
            if (!bookAuthorUid) return;
            const title = newBookTitleInput.value.trim();
            if (!title) { alert('ì±… ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }

            try {
                const userRef = doc(db, 'users', bookAuthorUid);
                const userDoc = await getDoc(userRef);
                const tokens = Number(userDoc.data()?.aeduTokens) || 0;
                if (tokens < 1) { alert('ì—ì´ë‘ í† í°ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.'); return; }
                await updateDoc(userRef, { aeduTokens: increment(-1) });
                await updateUserInfo();
                const newBookCode = `book${Date.now()}`;
                await setDoc(doc(db, 'Book', newBookCode), {
                    author: window.authorName || '',
                    authorId: bookAuthorUid,
                    owner: bookAuthorUid,
                    createdAt: serverTimestamp(),
                    title,
                    isPublic: false
                });
                await addDoc(collection(db, `users/${bookAuthorUid}/myBooks`), {
                    bookId: newBookCode,
                    title,
                    createdAt: serverTimestamp()
                });
                await loadUserBooks();
                addBookModal.classList.add('hidden');
            } catch (error) {
                console.error('Error adding book:', error);
                alert('ì±…ì„ ì¶”ê°€í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        });

        // --- My Class and Token Features ---
        const myClassBtn = document.getElementById('my-class-btn');
        const myClassModal = document.getElementById('my-class-modal');
        const myClassStudentList = document.getElementById('my-class-student-list');
        const addMyClassStudentBtn = document.getElementById('add-my-class-student-btn');
        const closeMyClassModalBtn = document.getElementById('close-my-class-modal');

        const classAddStudentsModal = document.getElementById('class-add-students-modal');
        const classStudentList = document.getElementById('class-student-list');
        const classStudentSearch = document.getElementById('class-student-search');
        const classAddStudentsConfirmBtn = document.getElementById('class-add-students-confirm-btn');
        const closeClassAddStudentsBtn = document.getElementById('close-class-add-students-btn');

        const tokenGiveBtn = document.getElementById('token-give-btn');
        const tokenModal = document.getElementById('token-modal');
        const tokenUserList = document.getElementById('token-user-list');
        const tokenSelectClass = document.getElementById('token-select-class');
        const tokenUserSearch = document.getElementById('token-user-search');
        const tokenSelectClassLabel = tokenSelectClass.parentElement;
        const tokenAmountInput = document.getElementById('token-amount');
        const tokenDistributeConfirm = document.getElementById('token-distribute-confirm');
        const closeTokenModalBtn = document.getElementById('close-token-modal');

        myClassBtn.addEventListener('click', openMyClassModal);
        closeMyClassModalBtn.addEventListener('click', () => myClassModal.classList.add('hidden'));
        addMyClassStudentBtn.addEventListener('click', openAddStudentsModal);
        closeClassAddStudentsBtn.addEventListener('click', () => classAddStudentsModal.classList.add('hidden'));
        classAddStudentsConfirmBtn.addEventListener('click', confirmAddStudents);

        tokenGiveBtn.addEventListener('click', () => openTokenModal());
        closeTokenModalBtn.addEventListener('click', () => tokenModal.classList.add('hidden'));
        tokenSelectClass.addEventListener('change', () => {
            document.querySelectorAll('#token-user-list input[data-inclass="1"]').forEach(cb => cb.checked = tokenSelectClass.checked);
        });
        tokenDistributeConfirm.addEventListener('click', distributeTokens);

        async function openMyClassModal() {
            myClassModal.classList.remove('hidden');
            myClassStudentList.innerHTML = 'ë¡œë”© ì¤‘...';
            try {
                const classDoc = await getDoc(doc(db, 'classes', bookAuthorUid));
                if (!classDoc.exists()) {
                    myClassStudentList.innerHTML = '<li class="text-sm text-gray-500">í•™ê¸‰ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                    currentClassStudents = [];
                    return;
                }
                currentClassStudents = classDoc.data().students || [];
                let html = '';
                for (const sid of currentClassStudents) {
                    try {
                        const sdoc = await getDoc(doc(db, 'users', sid));
                        if (sdoc.exists()) {
                            const sdata = sdoc.data();
                            html += `<li class="flex justify-between items-center py-1 border-b border-dotted border-gray-300 last:border-b-0"><span>${sdata.name} (ì½”ë“œ: ${sdata.userCode})</span><button class="give-token-btn bg-purple-500 text-white px-2 py-1 rounded text-xs" data-uid="${sdoc.id}">í† í° ì§€ê¸‰</button></li>`;
                        }
                    } catch (_) {}
                }
                myClassStudentList.innerHTML = html || '<li class="text-sm text-gray-500">í•™ìƒ ì—†ìŒ</li>';
                myClassStudentList.querySelectorAll('.give-token-btn').forEach(btn => {
                    btn.addEventListener('click', () => openTokenModal([btn.dataset.uid]));
                });
            } catch (err) {
                myClassStudentList.innerHTML = `<li class="text-red-500">ì˜¤ë¥˜: ${err.message}</li>`;
            }
        }

        async function openAddStudentsModal() {
            classAddStudentsModal.classList.remove('hidden');
            classStudentList.innerHTML = 'í•™ìƒ ëª©ë¡ ë¡œë”© ì¤‘...';
            try {
                const usersSnapshot = await getDocs(query(collection(db, 'users'), where('role', '==', 'student')));
                classStudentList.innerHTML = usersSnapshot.docs.map(d => {
                    const s = { id: d.id, ...d.data() };
                    const checked = currentClassStudents.includes(s.id) ? 'checked disabled' : '';
                    return `<label class="flex items-center space-x-2 p-1"><input type="checkbox" data-studentid="${s.id}" ${checked}><span>${s.name} (ì½”ë“œ: ${s.userCode})</span></label>`;
                }).join('');
            } catch (err) {
                classStudentList.innerHTML = `<p class="text-red-500 text-center">í•™ìƒ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>`;
            }
            classStudentSearch.value = '';
            classStudentSearch.oninput = e => {
                const term = e.target.value.toLowerCase();
                document.querySelectorAll('#class-student-list label').forEach(lbl => {
                    lbl.style.display = lbl.textContent.toLowerCase().includes(term) ? 'flex' : 'none';
                });
            };
        }

        async function confirmAddStudents() {
            const selected = Array.from(document.querySelectorAll('#class-student-list input:checked:not(:disabled)')).map(i => i.dataset.studentid);
            if (selected.length > 0) {
                try {
                    await updateDoc(doc(db, 'classes', bookAuthorUid), { students: arrayUnion(...selected) });
                } catch (_) {}
            }
            classAddStudentsModal.classList.add('hidden');
            openMyClassModal();
        }

        async function openTokenModal(targetUserIds = null) {
            tokenModal.classList.remove('hidden');
            tokenUserList.innerHTML = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
            const restrict = Array.isArray(targetUserIds) && targetUserIds.length > 0;
            tokenSelectClassLabel.classList.toggle('hidden', restrict);
            tokenUserSearch.classList.toggle('hidden', restrict);
            tokenSelectClass.checked = false;
            try {
                const classDoc = await getDoc(doc(db, 'classes', bookAuthorUid));
                currentClassStudents = classDoc.exists() ? (classDoc.data().students || []) : [];
                const usersSnap = await getDocs(collection(db, 'users'));
                tokenUserList.innerHTML = usersSnap.docs.map(d => {
                    const u = { id: d.id, ...d.data() };
                    const inClass = currentClassStudents.includes(u.id) ? '1' : '0';
                    const checked = restrict && targetUserIds.includes(u.id) ? 'checked' : '';
                    const display = !restrict || targetUserIds.includes(u.id) ? 'flex' : 'none';
                    const code = u.userCode || '';
                    return `<label class="flex items-center space-x-2 p-1" data-name="${u.name}" data-code="${code}" style="display:${display}"><input type="checkbox" class="token-user-checkbox" data-inclass="${inClass}" value="${u.id}" ${checked}><span>${u.name} (ì½”ë“œ: ${code})</span></label>`;
                }).join('');
            } catch (err) {
                tokenUserList.innerHTML = `<p class="text-red-500 text-center">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>`;
            }
            tokenUserSearch.value = '';
            tokenUserSearch.oninput = e => {
                const term = e.target.value.toLowerCase();
                document.querySelectorAll('#token-user-list label').forEach(lbl => {
                    const name = (lbl.dataset.name || '').toLowerCase();
                    const code = String(lbl.dataset.code || '').toLowerCase();
                    lbl.style.display = name.includes(term) || code.includes(term) ? 'flex' : 'none';
                });
            };
        }

        async function distributeTokens() {
            const amount = Number(tokenAmountInput.value);
            if (isNaN(amount) || amount <= 0) { showNotification('í† í° ì–‘ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
            const selected = Array.from(document.querySelectorAll('.token-user-checkbox:checked')).map(i => i.value);
            if (selected.length === 0) { showNotification('í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”'); return; }
            try {
                for (const uid of selected) {
                    await updateDoc(doc(db, 'users', uid), { aeduTokens: increment(amount) });
                }
                showNotification('í† í° ì§€ê¸‰ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (err) {
                showNotification(`í† í° ì§€ê¸‰ ì‹¤íŒ¨: ${err.message}`);
            }
            tokenAmountInput.value = '';
            tokenModal.classList.add('hidden');
        }

        document.getElementById('back-to-list-btn').addEventListener('click', () => {
            document.getElementById('book-viewer-page').classList.add('hidden');
            document.getElementById('book-list-section').classList.remove('hidden');
        });

        document.getElementById('book-student-login-btn').addEventListener('click', async () => {
            const codeInput = document.getElementById('book-student-code').value.trim();
            const normalizedCode = codeInput.replace(/[\uFF10-\uFF19]/g, m => String.fromCharCode(m.charCodeAt(0) - 0xFEE0));
            if (!normalizedCode || !/^\d+$/.test(normalizedCode)) { alert('ìœ íš¨í•œ ìˆ«ì ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            const codeAsInt = parseInt(normalizedCode, 10);
            const email = `${codeAsInt}@abc.com`;
            const password = `${codeAsInt}qwerty`;
            try { await signInWithEmailAndPassword(auth, email, password); } catch (_) { alert('ë¡œê·¸ì¸ ì‹¤íŒ¨'); }
        });

        document.getElementById('book-teacher-login-btn').addEventListener('click', async () => {
            const email = document.getElementById('book-teacher-email').value;
            const password = document.getElementById('book-teacher-password').value;
            if (!email || !password) { alert('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            try { await signInWithEmailAndPassword(auth, email, password); } catch (_) { alert('ë¡œê·¸ì¸ ì‹¤íŒ¨'); }
        });

        document.getElementById('book-teacher-google-login-btn').addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try { await signInWithPopup(auth, provider); } catch (_) { alert('ë¡œê·¸ì¸ ì‹¤íŒ¨'); }
        });

        onAuthStateChanged(auth, async (user) => {
            const loginView = document.getElementById('book-login-view');
            const contentView = document.getElementById('book-content');
            const viewerPage = document.getElementById('book-viewer-page');
            const listSection = document.getElementById('book-list-section');
            if (user) {
                loginView.classList.add('hidden');
                registerView.classList.add('hidden');
                contentView.classList.remove('hidden');
                viewerPage.classList.add('hidden');
                listSection.classList.remove('hidden');
                bookAuthorUid = user.uid;
                await updateUserInfo();
                await loadUserBooks();
                await loadLibraryBooks();
            } else {
                loginView.classList.remove('hidden');
                registerView.classList.add('hidden');
                contentView.classList.add('hidden');
            }
        });

        window.addCharacterPage = addCharacterPage;
        window.addManualPage = addManualPage;
        window.deleteCurrentPage = deleteCurrentPage;
        window.changeBookPage = changeBookPage;
        window.completeManualBook = completeManualBook;
        window.completeManualBookGPT = completeManualBookGPT;
        window.saveBookDraft = saveBookDraft;
        window.downloadBookAsPDF = downloadBookAsPDF;
        window.registerToLibrary = registerToLibrary;
    </script>
</body>
</html>


