<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ì±… ë§Œë“¤ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap');
        body { font-family: 'Gowun Dodum', sans-serif; }
        .loader { border: 8px solid #f3f3f3; border-radius: 50%; width: 60px; height: 60px; animation: spin 2s linear infinite; border-top: 8px solid #10b981; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .book-viewer { aspect-ratio: 2 / 1.414; width: 100%; display: flex; }
        .book-page { position: relative; width: 50%; height: 100%; background-size: cover; background-position: center; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 2rem; box-sizing: border-box; }
        .book-spread { display: none; }
        .book-spread.active { display: flex; }
        .text-box { background-color: rgba(255, 255, 255, 0.85); border: 2px solid black; padding: 1rem; text-align: center; }
        .page-nav { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(0,0,0,0.5); color: white; border: none; border-radius: 9999px; width: 3rem; height: 3rem; font-size: 2rem; cursor: pointer; z-index: 10; }
        .page-number { position: absolute; bottom: 0.5rem; font-size: 0.875rem; color: #374151; }
        .manual-text-area { width: 100%; height: 80%; background: transparent; border: 2px dashed #ccc; border-radius: 8px; padding: 1rem; text-align: left; overflow-y: auto; font-size: 1.125rem; }
        .tts-word { cursor: pointer; transition: color 0.2s; }
        .tts-word:hover { color: #3b82f6; }
        #notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: #2c3e50; color: white; padding: 1rem 2rem; border-radius: 8px; z-index: 1000; transition: opacity 0.5s, transform 0.5s; opacity: 0; pointer-events: none; }
        #notification.show { opacity: 1; transform: translate(-50%, 10px); }
    </style>
</head>
<body class="p-2 md:p-8 bg-gray-100">

    <div id="book-viewer-page" class="page-content max-w-7xl mx-auto">
        <div class="bg-white rounded-2xl shadow-lg p-4 md:p-6">
            <header class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                <div class="flex items-end gap-2">
                    <h1 class="text-2xl md:text-4xl font-bold text-emerald-800">AI ì±… ë§Œë“¤ê¸°</h1>
                    <span class="text-sm text-gray-600">ê¸€ì“´ì´: <span id="author-display" class="book-author-sync"></span></span>
                </div>
                <div id="viewer-controls" class="flex flex-wrap justify-center items-center gap-2">
                    <button id="generate-images-btn" onclick="completeManualBook()" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed">ê·¸ë¦¼ ìƒì„±í•˜ê¸°</button>
                    <button id="save-book-btn" onclick="saveBookDraft()" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed">ì €ì¥í•˜ê¸°</button>
                    <button id="save-book-pdf-btn" onclick="downloadBookAsPDF()" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 hidden">PDF ì €ì¥</button>
                    <button id="register-library-btn" onclick="registerToLibrary()" class="bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600 disabled:bg-gray-400 disabled:cursor-not-allowed hidden" disabled>ë„ì„œê´€ ë“±ë¡í•˜ê¸°</button>
                </div>
            </header>

            <div id="book-viewer" class="relative bg-gray-50 rounded-lg border-2 border-dashed mb-4">
                <!-- ì±… ë·°ì–´ê°€ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤. -->
            </div>

            <div id="manual-book-context-wrapper" class="mt-4">
                <label for="manual-book-context" class="block text-lg font-semibold text-gray-700 mb-2">ğŸ¨ ê·¸ë¦¼ ìƒì„± AIì—ê²Œ ì•Œë ¤ì¤„ ë‚´ìš©</label>
                <textarea id="manual-book-context" class="w-full p-3 border border-gray-300 rounded-lg" rows="3" placeholder="ì˜ˆ: ì£¼ì¸ê³µ í† ë¼ëŠ” í•­ìƒ ë¹¨ê°„ìƒ‰ ë‚˜ë¹„ë„¥íƒ€ì´ë¥¼ ë§¤ê³  ìˆì–´."></textarea>
            </div>
        </div>
    </div>
    
    <div id="notification"></div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref as storageRef, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // ì „ì—­ ë³€ìˆ˜
        let bookCurrentPage = 0;
        let totalBookSpreads = 0;
        let bookCode = null;
        let auth;
        let db;
        let storage;
        // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì´ë¦„ì„ ì €ì¥í•˜ê³  ì±…ì˜ ì €ì ì˜ì—­ì„ ë™ê¸°í™”í•©ë‹ˆë‹¤.
        window.authorName = '';
        window.syncBookAuthor = function() {
            document.querySelectorAll('.book-author-sync').forEach(el => el.textContent = window.authorName);
        };

        // TTS í•¨ìˆ˜
        function speak(text) {
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'ko-KR';
                u.rate = 0.9;
                window.speechSynthesis.speak(u);
            }
        }

        // ì•Œë¦¼ í•¨ìˆ˜
        function showNotification(message, duration = 3000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }

        /**
         * ì´ë¯¸ì§€ ìƒì„± APIë¥¼ ëª¨ë°©í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.
         * ì‹¤ì œë¡œëŠ” ì„œë²„ì— ìš”ì²­ì„ ë³´ë‚´ì•¼ í•˜ì§€ë§Œ, ì—¬ê¸°ì„œëŠ” í”Œë ˆì´ìŠ¤í™€ë” ì´ë¯¸ì§€ URLì„ ë°˜í™˜í•©ë‹ˆë‹¤.
         */
        async function generateImageForParagraph(text, context = "") {
            const prompt = `${text}\n${context}`;
            const res = await fetch('/.netlify/functions/stability-handler', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    type: 'stability',
                    payload: {
                        text_prompts: [{ text: prompt }],
                        cfg_scale: 7,
                        height: 1024,
                        width: 1024,
                        samples: 1,
                        steps: 30
                    }
                })
            });

            let data;
            try {
                data = await res.json();
            } catch (_) {
                throw new Error('ì„œë²„ ì‘ë‹µì„ íŒŒì‹±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            }

            if (!res.ok) {
                const message = data.error?.message || data.error || 'Stability API Error';
                throw new Error(message);
            }

            const base64 = data.image || data.artifacts?.[0]?.base64;
            if (!base64) {
                throw new Error('ì´ë¯¸ì§€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }

            return `data:image/png;base64,${base64}`;
        }

        // ìˆ˜ë™ ì±… ë§Œë“¤ê¸° ì‹œì‘
        function startManualBookCreation() {
            buildBookViewer();
        }

        // ì±… ë·°ì–´ UI êµ¬ì„±
        function buildBookViewer() {
            const viewer = document.getElementById("book-viewer");
            viewer.innerHTML = ""; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”

            totalBookSpreads = 3; // ê¸°ë³¸ 3ì¥ (í‘œì§€, ë“±ì¥ì¸ë¬¼, ì´ì•¼ê¸° ì‹œì‘)
            
            // 0. í‘œì§€ í˜ì´ì§€
            const spread0 = `
                <div id="spread-0" class="book-spread book-viewer" data-page-type="cover">
                    <div class="book-page bg-white border-r border-gray-300">
                        <div style="width: 80%; text-align: center;">
                            <div class="text-box mb-4">
                                <h1 class="text-3xl font-bold editable-text book-title-sync" contenteditable="true">ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”</h1>
                            </div>
                            <div class="text-box inline-block">
                                <p class="book-author-sync" contenteditable="false">ê¸€ì“´ì´</p>
                            </div>
                        </div>
                    </div>
                    <div class="book-page bg-gray-200">
                        <div class="absolute top-6 left-6">
                            <div class="text-sm font-semibold mb-1 text-gray-600">ì œëª©</div>
                            <div class="text-xl p-2 bg-white bg-opacity-80 rounded shadow editable-text book-title-sync" contenteditable="true">ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”</div>
                        </div>
                        <div class="absolute bottom-4 right-4 text-box">
                            <p class="book-author-sync" contenteditable="false">ê¸€ì“´ì´</p>
                        </div>
                    </div>
                </div>
            `;

            // 1. ë“±ì¥ì¸ë¬¼ ì†Œê°œ í˜ì´ì§€
            const spread1 = `
                <div id="spread-1" class="book-spread book-viewer" data-page-type="character">
                    <!-- ì™¼ìª½ í˜ì´ì§€ (1) -->
                    <div class="book-page bg-white border-r border-gray-300">
                        <h2 class="absolute top-6 text-2xl font-bold text-gray-700">ë“±ì¥ì¸ë¬¼ ì†Œê°œ</h2>
                        <div class="w-full h-full flex flex-col items-center justify-center pt-16">
                           <div class="w-full h-1/2 bg-gray-200 mb-4 rounded flex items-center justify-center text-gray-400 character-image-box" style="background-size: cover; background-position: center;">ê·¸ë¦¼ 1</div>
                           <div class="editable-text text-xl font-bold" contenteditable="true">ì´ë¦„ 1</div>
                           <textarea class="manual-text-area mt-2 h-1/4 text-sm" placeholder="ì–´ë–¤ ì¸ë¬¼ì¸ì§€ ì„¤ëª…í•´ì£¼ì„¸ìš”."></textarea>
                        </div>
                        <div class="page-number" style="left: 0.5rem;">1</div>
                    </div>
                    <!-- ì˜¤ë¥¸ìª½ í˜ì´ì§€ (2) -->
                    <div class="book-page bg-white">
                         <h2 class="absolute top-6 text-2xl font-bold text-gray-700 opacity-0">ë“±ì¥ì¸ë¬¼ ì†Œê°œ</h2>
                         <div class="w-full h-full flex flex-col items-center justify-center pt-16">
                           <div class="w-full h-1/2 bg-gray-200 mb-4 rounded flex items-center justify-center text-gray-400 character-image-box" style="background-size: cover; background-position: center;">ê·¸ë¦¼ 2</div>
                           <div class="editable-text text-xl font-bold" contenteditable="true">ì´ë¦„ 2</div>
                           <textarea class="manual-text-area mt-2 h-1/4 text-sm" placeholder="ì–´ë–¤ ì¸ë¬¼ì¸ì§€ ì„¤ëª…í•´ì£¼ì„¸ìš”."></textarea>
                        </div>
                        <div class="page-number" style="right: 0.5rem;">2</div>
                    </div>
                </div>
            `;
            
            // 2. ì´ì•¼ê¸° ì‹œì‘ í˜ì´ì§€
            const spread2 = `
                 <div id="spread-2" class="book-spread book-viewer" data-page-type="story">
                    <!-- ì™¼ìª½ í˜ì´ì§€ (3) -->
                    <div class="book-page bg-gray-200 border-r border-gray-300 flex items-center justify-center">
                        <span class="text-gray-400">ê·¸ë¦¼ì´ ìƒì„±ë  ê³³</span>
                        <div class="page-number" style="left: 0.5rem;">3</div>
                    </div>
                    <!-- ì˜¤ë¥¸ìª½ í˜ì´ì§€ (4) -->
                    <div class="book-page bg-white">
                        <textarea class="manual-text-area" placeholder="ì—¬ê¸°ì— ì´ì•¼ê¸°ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                        <div class="page-number" style="right: 0.5rem;">4</div>
                    </div>
                </div>
            `;

            // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ë° í˜ì´ì§€ ì•¡ì…˜ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ
            const navButtons = `
                <button id="prev-page-btn" onclick="changeBookPage(-1)" class="page-nav left-2">â€¹</button>
                <button id="next-page-btn" onclick="changeBookPage(1)" class="page-nav right-2">â€º</button>
                <div id="page-action-buttons" class="absolute top-4 right-4 flex gap-2 z-10"></div>
            `;

            viewer.innerHTML = spread0 + spread1 + spread2 + navButtons;

            bookCurrentPage = 0;
            document.getElementById('spread-0').classList.add('active'); // ì²« í˜ì´ì§€ í™œì„±í™”
            updateBookView();
            // ë¹Œë“œ í›„ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ì´ë¦„ì„ ì €ì ì˜ì—­ì— ë°˜ì˜í•©ë‹ˆë‹¤.
            window.syncBookAuthor();
        }
        
        // ID ë° í˜ì´ì§€ ë²ˆí˜¸ ì¬ì •ë ¬
        function updatePageNumbersAndIDs() {
            const spreads = document.querySelectorAll("#book-viewer .book-spread");
            spreads.forEach((spread, index) => {
                spread.id = `spread-${index}`;

                // í‘œì§€(index 0)ì—ëŠ” í˜ì´ì§€ ë²ˆí˜¸ ì—†ìŒ
                if (index > 0) {
                    const leftPageNumEl = spread.querySelector('.page-number[style*="left"]');
                    const rightPageNumEl = spread.querySelector('.page-number[style*="right"]');

                    if (leftPageNumEl) {
                        leftPageNumEl.textContent = (index - 1) * 2 + 1;
                    }
                    if (rightPageNumEl) {
                        rightPageNumEl.textContent = (index - 1) * 2 + 2;
                    }
                }
            });
        }
        
        // ë“±ì¥ì¸ë¬¼ í˜ì´ì§€ ì¶”ê°€
        function addCharacterPage() {
            const viewer = document.getElementById("book-viewer");
            const characterSpreads = viewer.querySelectorAll('.book-spread[data-page-type="character"]');
            const lastCharacterSpread = characterSpreads[characterSpreads.length - 1];
            
            if (!lastCharacterSpread) {
                showNotification("ì˜¤ë¥˜: ë§ˆì§€ë§‰ ë“±ì¥ì¸ë¬¼ í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            const existingCharacters = viewer.querySelectorAll('.character-image-box').length;
            const charNum1 = existingCharacters + 1;
            const charNum2 = existingCharacters + 2;

            const newSpread = document.createElement("div");
            newSpread.className = "book-spread book-viewer";
            newSpread.dataset.pageType = "character";

            newSpread.innerHTML = `
                <div class="book-page bg-white border-r border-gray-300">
                    <h2 class="absolute top-6 text-2xl font-bold text-gray-700">ë“±ì¥ì¸ë¬¼ ì†Œê°œ</h2>
                    <div class="w-full h-full flex flex-col items-center justify-center pt-16">
                       <div class="w-full h-1/2 bg-gray-200 mb-4 rounded flex items-center justify-center text-gray-400 character-image-box" style="background-size: cover; background-position: center;">ê·¸ë¦¼ ${charNum1}</div>
                       <div class="editable-text text-xl font-bold" contenteditable="true">ì´ë¦„ ${charNum1}</div>
                       <textarea class="manual-text-area mt-2 h-1/4 text-sm" placeholder="ì–´ë–¤ ì¸ë¬¼ì¸ì§€ ì„¤ëª…í•´ì£¼ì„¸ìš”."></textarea>
                    </div>
                    <div class="page-number" style="left: 0.5rem;"></div>
                </div>
                <div class="book-page bg-white">
                     <h2 class="absolute top-6 text-2xl font-bold text-gray-700 opacity-0">ë“±ì¥ì¸ë¬¼ ì†Œê°œ</h2>
                     <div class="w-full h-full flex flex-col items-center justify-center pt-16">
                       <div class="w-full h-1/2 bg-gray-200 mb-4 rounded flex items-center justify-center text-gray-400 character-image-box" style="background-size: cover; background-position: center;">ê·¸ë¦¼ ${charNum2}</div>
                       <div class="editable-text text-xl font-bold" contenteditable="true">ì´ë¦„ ${charNum2}</div>
                       <textarea class="manual-text-area mt-2 h-1/4 text-sm" placeholder="ì–´ë–¤ ì¸ë¬¼ì¸ì§€ ì„¤ëª…í•´ì£¼ì„¸ìš”."></textarea>
                    </div>
                    <div class="page-number" style="right: 0.5rem;"></div>
                </div>
            `;

            lastCharacterSpread.after(newSpread);
            totalBookSpreads++;
            
            updatePageNumbersAndIDs();
            
            const newPageIndex = Array.from(viewer.querySelectorAll('.book-spread')).indexOf(newSpread);
            bookCurrentPage = newPageIndex;
            updateBookView();
        }

        // ì´ì•¼ê¸° í˜ì´ì§€ ì¶”ê°€
        function addManualPage() {
            const viewer = document.getElementById("book-viewer");
            const newSpread = document.createElement("div");
            newSpread.className = "book-spread book-viewer";
            newSpread.dataset.pageType = 'story';
            
            newSpread.innerHTML = `
                <div class="book-page bg-gray-200 border-r border-gray-300 flex items-center justify-center">
                    <span class="text-gray-400">ê·¸ë¦¼ì´ ìƒì„±ë  ê³³</span>
                    <div class="page-number" style="left: 0.5rem;"></div>
                </div>
                <div class="book-page bg-white">
                    <textarea class="manual-text-area" placeholder="ì—¬ê¸°ì— ì´ì•¼ê¸°ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                    <div class="page-number" style="right: 0.5rem;"></div>
                </div>
            `;
            
            const prevButton = document.getElementById('prev-page-btn');
            viewer.insertBefore(newSpread, prevButton);

            totalBookSpreads++;
            updatePageNumbersAndIDs();
            
            bookCurrentPage = totalBookSpreads - 1;
            updateBookView();
        }

        // í˜„ì¬ í˜ì´ì§€ ì‚­ì œ
        function deleteCurrentPage() {
            const currentSpread = document.getElementById(`spread-${bookCurrentPage}`);
            if (!currentSpread) return;
            const type = currentSpread.dataset.pageType;
            if (type === 'cover') {
                showNotification("í‘œì§€ëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            if (type === 'character') {
                const charSpreads = Array.from(document.querySelectorAll('#book-viewer .book-spread[data-page-type="character"]'));
                if (charSpreads.indexOf(currentSpread) === 0) {
                    showNotification("ê¸°ë³¸ ë“±ì¥ì¸ë¬¼ í˜ì´ì§€ëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }
            }
            if (type === 'story') {
                const storySpreads = Array.from(document.querySelectorAll('#book-viewer .book-spread[data-page-type="story"]'));
                if (storySpreads.indexOf(currentSpread) === 0) {
                    showNotification("ê¸°ë³¸ ì¤„ê±°ë¦¬ í˜ì´ì§€ëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }
            }
            currentSpread.remove();
            totalBookSpreads--;
            bookCurrentPage = Math.max(0, Math.min(bookCurrentPage, totalBookSpreads - 1));
            updatePageNumbersAndIDs();
            updateBookView();
            showNotification("í˜ì´ì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        // ì±… ì´ˆì•ˆ ì €ì¥
        async function saveBookDraft() {
            if (!bookCode || !auth?.currentUser) {
                showNotification("ì½”ë“œê°€ ì—†ì–´ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            const btn = document.getElementById('save-book-btn');
            btn.disabled = true;
            btn.textContent = 'ì €ì¥ ì¤‘...';
            try {
                const pages = document.querySelectorAll('#book-viewer .book-page');
                const images = {};
                const texts = {};
                const uploads = [];

                pages.forEach((page, idx) => {
                    const bg = page.style.backgroundImage;
                    const match = bg.match(/url\(["']?(data:image\/[^"')]+)["']?\)/);
                    if (match) {
                        if (!page.dataset.imageName) {
                            page.dataset.imageName = `page-${idx}-${Date.now()}.png`;
                        }
                        const imgRef = storageRef(storage, `users/${auth.currentUser.uid}/bookDrafts/${bookCode}/${page.dataset.imageName}`);
                        uploads.push(uploadString(imgRef, match[1], 'data_url'));
                        images[idx] = page.dataset.imageName;
                    } else if (page.dataset.imageName) {
                        images[idx] = page.dataset.imageName;
                    }

                    const textarea = page.querySelector('.manual-text-area');
                    if (textarea) {
                        texts[idx] = textarea.value;
                    } else {
                        const textBox = page.querySelector('.text-box');
                        if (textBox) texts[idx] = textBox.textContent.trim();
                    }
                });

                await Promise.all(uploads);

                const viewerHtml = document.getElementById('book-viewer').innerHTML;
                const context = document.getElementById('manual-book-context').value;

                await setDoc(doc(db, 'users', auth.currentUser.uid, 'bookDrafts', bookCode), {
                    viewerHtml,
                    context,
                    images,
                    texts,
                    updatedAt: serverTimestamp()
                }, { merge: true });

                showNotification('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (err) {
                console.error(err);
                showNotification('ì €ì¥ ì‹¤íŒ¨: ' + err.message);
            } finally {
                btn.textContent = 'ì €ì¥í•˜ê¸°';
                btn.disabled = false;
            }
        }

        // ë„ì„œê´€ ë“±ë¡ (êµ¬í˜„ ì˜ˆì •)
        function registerToLibrary() {
            showNotification("ë„ì„œê´€ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! (êµ¬í˜„ ì˜ˆì •)");
            // ì‹¤ì œ êµ¬í˜„ ì‹œ, ì´ ê³³ì—ì„œ ë„ì„œê´€ ì‚¬ì´íŠ¸ë¡œ ë°ì´í„°ë¥¼ ì „ì†¡í•˜ê±°ë‚˜
            // ë¯¸ë‹ˆ ë·°ì–´ë¥¼ ì—¬ëŠ” ë¡œì§ì´ ë“¤ì–´ê°‘ë‹ˆë‹¤.
            // ì˜ˆ: window.open(`https://mylibrary.com/viewer?bookId=SOME_UNIQUE_ID`);
        }

        // ì±… ì™„ì„± (ê·¸ë¦¼ ìƒì„±)
        async function completeManualBook() {
            const generateBtn = document.getElementById("generate-images-btn");
            const registerBtn = document.getElementById('register-library-btn');
            const savePdfBtn = document.getElementById('save-book-pdf-btn');
            
            const originalGenerateText = "ê·¸ë¦¼ ìƒì„±í•˜ê¸°";

            generateBtn.textContent = "ìƒì„± ì¤‘...";
            generateBtn.disabled = true;

            const context = document.getElementById("manual-book-context").value;

            try {
                // í‘œì§€ ì´ë¯¸ì§€ ìƒì„±
                const titleText = document.querySelector("#spread-0 .book-title-sync").textContent;
                const coverImage = await generateImageForParagraph(titleText, context);
                document.querySelector("#spread-0 .book-page:last-child").style.backgroundImage = `url('${coverImage}')`;
                
                // ë“±ì¥ì¸ë¬¼ ì´ë¯¸ì§€ ìƒì„±
                const charSpreads = document.querySelectorAll('.book-spread[data-page-type="character"]');
                for(const charSpread of charSpreads) {
                    const charDescriptions = charSpread.querySelectorAll('textarea');
                    const charImageBoxes = charSpread.querySelectorAll('.character-image-box');
                    const charNames = charSpread.querySelectorAll('.editable-text');
                    
                    if (charDescriptions[0] && (charDescriptions[0].value || charNames[0].textContent)) {
                        const char1Text = charNames[0].textContent + ", " + charDescriptions[0].value;
                        const char1Image = await generateImageForParagraph(char1Text, context);
                        charImageBoxes[0].style.backgroundImage = `url('${char1Image}')`;
                        charImageBoxes[0].textContent = '';
                    }
                    if (charDescriptions[1] && (charDescriptions[1].value || charNames[1].textContent)) {
                        const char2Text = charNames[1].textContent + ", " + charDescriptions[1].value;
                        const char2Image = await generateImageForParagraph(char2Text, context);
                        charImageBoxes[1].style.backgroundImage = `url('${char2Image}')`;
                        charImageBoxes[1].textContent = '';
                    }
                }

                // ê° ì´ì•¼ê¸° í˜ì´ì§€ ì´ë¯¸ì§€ ìƒì„±
                const storySpreads = document.querySelectorAll('.book-spread[data-page-type="story"]');
                for (const spread of storySpreads) {
                    const text = spread.querySelector("textarea").value;
                    if (text) {
                        const imageUrl = await generateImageForParagraph(text, context);
                        const imagePage = spread.querySelector(".book-page:first-child");
                        const pageNumHTML = imagePage.querySelector('.page-number')?.outerHTML || '';
                        imagePage.style.backgroundImage = `url('${imageUrl}')`;
                        imagePage.innerHTML = pageNumHTML;
                    }
                }
                showNotification("ì±…ì´ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ì´ì œ ë„ì„œê´€ì— ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                
                // ê·¸ë¦¼ ìƒì„± ë²„íŠ¼ì€ ì˜êµ¬ì ìœ¼ë¡œ ë¹„í™œì„±í™”
                generateBtn.disabled = true;
                
                // PDF ì €ì¥ ë° ë„ì„œê´€ ë“±ë¡ ë²„íŠ¼ ë³´ì´ê¸° ë° í™œì„±í™”
                if(savePdfBtn) {
                    savePdfBtn.classList.remove('hidden');
                }
                if(registerBtn) {
                    registerBtn.classList.remove('hidden');
                    registerBtn.disabled = false;
                }

            } catch (error) {
                console.error("ìˆ˜ë™ ì±… ì™„ì„± ì˜¤ë¥˜:", error);
                showNotification(`ê·¸ë¦¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                
                // ì‹¤íŒ¨ ì‹œ ê·¸ë¦¼ ìƒì„± ë²„íŠ¼ ì›ìƒ ë³µêµ¬
                generateBtn.textContent = originalGenerateText;
                generateBtn.disabled = false;
            }
        }
        
        // í˜ì´ì§€ ë„˜ê¸°ê¸°
        function changeBookPage(direction) {
            bookCurrentPage = Math.max(0, Math.min(bookCurrentPage + direction, totalBookSpreads - 1));
            updateBookView();
        }

        function updateBookView() {
    document.querySelectorAll(".book-spread").forEach((spread, index) => {
        spread.classList.toggle("active", index === bookCurrentPage);
    });
    document.getElementById("prev-page-btn").style.display = bookCurrentPage === 0 ? "none" : "block";
    document.getElementById("next-page-btn").style.display = bookCurrentPage >= totalBookSpreads - 1 ? "none" : "block";

    const actionContainer = document.getElementById('page-action-buttons');
    actionContainer.innerHTML = '';
    const currentSpread = document.getElementById(`spread-${bookCurrentPage}`);
    if (!currentSpread) return;
    const type = currentSpread.dataset.pageType;

    if (type === 'story') {
        const storySpreads = Array.from(document.querySelectorAll('#book-viewer .book-spread[data-page-type="story"]'));
        const storyIndex = storySpreads.indexOf(currentSpread);
        let buttons = `<button onclick="addManualPage()" class="bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-600">+ í˜ì´ì§€ ì¶”ê°€</button>`;
        if (storyIndex > 0) {
            buttons += `<button onclick="deleteCurrentPage()" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600">í˜ì´ì§€ ì‚­ì œ</button>`;
        }
        actionContainer.innerHTML = buttons;
    } else if (type === 'character') {
        const charSpreads = Array.from(document.querySelectorAll('#book-viewer .book-spread[data-page-type="character"]'));
        const charIndex = charSpreads.indexOf(currentSpread);
        let buttons = `<button onclick="addCharacterPage()" class="bg-sky-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-600">+ ë“±ì¥ì¸ë¬¼ ì¶”ê°€</button>`;
        if (charIndex > 0) {
            buttons += `<button onclick="deleteCurrentPage()" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600">í˜ì´ì§€ ì‚­ì œ</button>`;
        }
        actionContainer.innerHTML = buttons;
    }
}

        // PDFë¡œ ë‹¤ìš´ë¡œë“œ
        async function downloadBookAsPDF() {
            const button = document.getElementById('save-book-pdf-btn');
            button.textContent = "PDF ìƒì„± ì¤‘...";
            button.disabled = true;

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: "landscape", unit: "mm", format: "a4" });
            const spreads = document.querySelectorAll(".book-spread");
            const originalPage = bookCurrentPage;

            for (let i = 0; i < spreads.length; i++) {
                if (i > 0) pdf.addPage("a4", "l");
                
                // í˜„ì¬ í˜ì´ì§€ë§Œ ë³´ì´ê²Œ ì„¤ì •
                document.querySelectorAll(".book-spread").forEach(s => s.classList.remove("active"));
                spreads[i].classList.add("active");
                
                // ë Œë”ë§ ì‹œê°„ í™•ë³´
                await new Promise(res => setTimeout(res, 100));

                const canvas = await html2canvas(spreads[i], {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: "#ffffff"
                });
                pdf.addImage(canvas.toDataURL("image/png"), "PNG", 0, 0, 297, 210);
            }

            pdf.save("ë‚˜ë§Œì˜_ë™í™”ì±….pdf");
            
            // ì›ë˜ í˜ì´ì§€ë¡œ ë³µêµ¬
            document.querySelectorAll(".book-spread").forEach(s => s.classList.remove("active"));
            if (spreads[originalPage]) spreads[originalPage].classList.add("active");
            
            button.textContent = "PDF ì €ì¥";
            button.disabled = false;
        }

        // ì œëª© ë° ê¸€ì“´ì´ ë™ê¸°í™” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.addEventListener('input', e => {
            const target = e.target;
            if (target.classList.contains('book-title-sync')) {
                const newContent = target.textContent;
                document.querySelectorAll('.book-title-sync').forEach(el => {
                    if (el !== target) {
                        el.textContent = newContent;
                    }
                });
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”ëŠ” ì¸ì¦ í›„ ì²˜ë¦¬ë©ë‹ˆë‹¤.
        
        // ë‹¨ì–´ í´ë¦­ ì‹œ TTS ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.addEventListener("click", e => {
            if (e.target.classList.contains("tts-word")) {
                speak(e.target.textContent.trim());
            }
        });

        const firebaseConfig = {
            apiKey: "AIzaSyDCeJPDQUNi-KmJ9DhkTRIu-9t2PGZCpt0",
            authDomain: "mansungcoin-c6e06.firebaseapp.com",
            projectId: "mansungcoin-c6e06",
            storageBucket: "mansungcoin-c6e06.appspot.com",
            messagingSenderId: "704809284946",
            appId: "1:704809284946:web:3e71d98f38810577e1768b"
        };

        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        storage = getStorage(app);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                window.authorName = userDoc.data()?.name || '';
                window.syncBookAuthor();

                const params = new URLSearchParams(window.location.search);
                bookCode = params.get('code');
                if (bookCode) {
                    const draftRef = doc(db, 'users', user.uid, 'bookDrafts', bookCode);
                    const draftSnap = await getDoc(draftRef);
                    if (draftSnap.exists()) {
                        const data = draftSnap.data();
                        document.getElementById('book-viewer').innerHTML = data.viewerHtml || '';
                        document.getElementById('manual-book-context').value = data.context || '';
                        totalBookSpreads = document.querySelectorAll('#book-viewer .book-spread').length;
                        const spreads = Array.from(document.querySelectorAll('#book-viewer .book-spread'));
                        const activeIdx = spreads.findIndex(s => s.classList.contains('active'));
                        bookCurrentPage = activeIdx >= 0 ? activeIdx : 0;

                        // í…ìŠ¤íŠ¸ ë³µì›
                        if (data.texts) {
                            const pages = document.querySelectorAll('#book-viewer .book-page');
                            Object.entries(data.texts).forEach(([idx, text]) => {
                                const page = pages[idx];
                                if (!page) return;
                                const textarea = page.querySelector('.manual-text-area');
                                if (textarea) {
                                    textarea.value = text;
                                } else {
                                    const textBox = page.querySelector('.text-box');
                                    if (textBox) textBox.textContent = text;
                                }
                            });
                        }

                        // ì´ë¯¸ì§€ ë³µì›
                        if (data.images) {
                            const pages = document.querySelectorAll('#book-viewer .book-page');
                            await Promise.all(Object.entries(data.images).map(async ([idx, name]) => {
                                const page = pages[idx];
                                if (!page) return;
                                page.dataset.imageName = name;
                                const imgRef = storageRef(storage, `users/${user.uid}/bookDrafts/${bookCode}/${name}`);
                                const url = await getDownloadURL(imgRef);
                                page.style.backgroundImage = `url('${url}')`;
                            }));
                        }

                        updateBookView();
                        window.syncBookAuthor();
                    } else {
                        startManualBookCreation();
                    }
                } else {
                    startManualBookCreation();
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        window.addCharacterPage = addCharacterPage;
        window.addManualPage = addManualPage;
        window.deleteCurrentPage = deleteCurrentPage;
        window.changeBookPage = changeBookPage;
        window.completeManualBook = completeManualBook;
        window.saveBookDraft = saveBookDraft;
        window.downloadBookAsPDF = downloadBookAsPDF;
        window.registerToLibrary = registerToLibrary;
    </script>
</body>
</html>


