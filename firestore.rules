rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // êµì‚¬ ì—­í•  í™•ì¸
    function isTeacher() {
      return request.auth != null &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher';
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ì‚¬ìš©ì ì •ë³´ ë° í•˜ìœ„ ë°ì´í„°
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    match /users/{userId} {
      allow get: if request.auth.uid == userId || isTeacher();
      allow update: if request.auth.uid == userId || isTeacher();
      allow delete: if isTeacher();
      allow create: if true;
      allow list: if isTeacher();

      // í•™ìƒ ê°œì¸ì´ ë°°ë¶€ë°›ì€ ìˆ™ì œ
      match /assignedHomework/{homeworkId} {
        allow read, write: if request.auth.uid == userId || isTeacher();
      }

      // í•™ìƒ ê°œì¸ì´ ë°°ë¶€ë°›ì€ ìƒí™œ ê·œì¹™
      match /assignedLifeRules/{ruleId} {
        allow read, write: if request.auth.uid == userId || isTeacher();
      }

      // âœ¨ [ìŠ¤ì¼€ì¹˜ë³´ë“œ]
      match /sketches/{sketchId} {
        allow read, write, delete, create:
          if request.auth != null && request.auth.uid == userId;
      }

      // âœ¨ [ìŠ¤ì¿¨í”Œëœ AI]
      match /plans/{planId} {
        allow read, write, create, delete:
          if request.auth != null && request.auth.uid == userId;
      }

      // âœ¨ [í•œê¸€ í‘œ ë§Œë“¤ê¸°]
      match /tables/{tableId} {
        allow read, write, create, delete:
          if request.auth != null && request.auth.uid == userId;
      }

      // âœ¨ [ê³µë¬¸ì„œ]
      match /officials/{officialId} {
        allow read, write, create, delete:
          if request.auth != null && request.auth.uid == userId;
      }

      // âœ¨ [ê°€ì •í†µì‹ ë¬¸]
      match /letters/{letterId} {
        allow read, write, create, delete:
          if request.auth != null && request.auth.uid == userId;
      }

      // âœ¨ [ğŸ“š ì—ì´ë‘ ë¶ë©”ì´ì»¤] ì‚¬ìš©ì ì „ìš© ì±… ì´ˆì•ˆ
      match /bookDrafts/{draftId} {
        allow read, write, create, delete:
          if request.auth != null && request.auth.uid == userId;
      }

      // âœ¨ [ğŸ“š ì—ì´ë‘ ë¶ë©”ì´ì»¤] ì‚¬ìš©ì ë³´ìœ  ì±… ëª©ë¡
      match /myBooks/{bookId} {
        allow read, write:
          if request.auth.uid == userId || isTeacher();
      }

      // âœ¨ [ì—ì´ë‘ ìŠ¤í˜ì…œ] í•™ê¸‰ ê´€ë¦¬
      match /classes/{classId} {
        allow read, write: if request.auth.uid == userId && isTeacher();
      }

      // âœ¨ [ì—ì´ë‘ ìŠ¤í˜ì…œ] ê°œë³„í™”êµìœ¡ê³„íš(IEP)
      match /ieps/{iepId} {
        allow read, write: if request.auth.uid == userId && isTeacher();
      }

      // âœ¨ [ì—ì´ë‘ ìŠ¤í˜ì…œ] ì„±ì·¨ ê¸°ì¤€ ê¸°ë¡
      match /achievements/{achievementId} {
        allow read, write: if request.auth.uid == userId && isTeacher();
      }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // âœ¨ [ğŸ“š ì—ì´ë‘ ë¶ë©”ì´ì»¤] ì‹¤ì œ ì±… ë¬¸ì„œ (ì±… ì½”ë“œ ê¸°ë°˜)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    match /Book/{bookId} {
      // ìƒˆ ë¬¸ì„œ ìƒì„± ì‹œ authorId í•„ë“œê°€ í˜„ì¬ ì‚¬ìš©ì UIDì™€ ì¼ì¹˜í•´ì•¼ í•¨
      allow create: if request.auth != null &&
                    request.resource.data.authorId == request.auth.uid;

      // ì½ê¸°: ê³µê°œ ì±…ì€ ëª¨ë‘, ë¹„ê³µê°œëŠ” ì‘ì„±ì ë˜ëŠ” êµì‚¬ë§Œ
      allow read: if request.auth != null &&
                  (resource.data.isPublic == true ||
                   resource.data.authorId == request.auth.uid || isTeacher());

      // ìˆ˜ì •: ì‘ì„±ì ë˜ëŠ” êµì‚¬ì´ë©°, authorIdë¥¼ ë³€ê²½í•  ìˆ˜ ì—†ìŒ
      // ë˜í•œ, ì¢‹ì•„ìš”/ëŒ“ê¸€ ìˆ˜ ì¦ê°€ë¥¼ ìœ„í•´ likesCount ë˜ëŠ” commentsCount ë¥¼
      // +1ë§Œí¼ ì¦ê°€ì‹œí‚¤ëŠ” ì—…ë°ì´íŠ¸ëŠ” ëª¨ë“  ì¸ì¦ëœ ì‚¬ìš©ìì—ê²Œ í—ˆìš©
      allow update: if request.auth != null &&
        (
          (resource.data.authorId == request.auth.uid &&
           request.resource.data.authorId == request.auth.uid)
          || isTeacher()
          || (
            request.resource.data.diff(resource.data).changedKeys().hasOnly(['likesCount']) &&
            request.resource.data.likesCount == resource.data.likesCount + 1
          )
          || (
            request.resource.data.diff(resource.data).changedKeys().hasOnly(['commentsCount']) &&
            request.resource.data.commentsCount == resource.data.commentsCount + 1
          )
        );

      // ì‚­ì œ: ì‘ì„±ì ë˜ëŠ” êµì‚¬ë§Œ ê°€ëŠ¥
      allow delete: if request.auth != null &&
        (resource.data.authorId == request.auth.uid || isTeacher());

      // ì±…ì— ëŒ€í•œ ì¢‹ì•„ìš” ì •ë³´
      match /likes/{userId} {
        allow read: if request.auth != null;
        allow create, delete: if request.auth != null && request.auth.uid == userId;
      }

      // ì±…ì— ëŒ€í•œ ëŒ“ê¸€ ë° ëŒ“ê¸€ ì¢‹ì•„ìš”
      match /comments/{commentId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null;

        // ëŒ“ê¸€ ìˆ˜ì •ì€ ì‘ì„±ì ë˜ëŠ” êµì‚¬ë§Œ ê°€ëŠ¥
        // ë‹¨, likesCount ë¥¼ +1 ì¦ê°€ì‹œí‚¤ëŠ” ì—…ë°ì´íŠ¸ëŠ” ëˆ„êµ¬ë‚˜ ê°€ëŠ¥
        allow update: if request.auth != null && (
          resource.data.authorUid == request.auth.uid ||
          isTeacher() ||
          (
            request.resource.data.diff(resource.data).changedKeys().hasOnly(['likesCount']) &&
            request.resource.data.likesCount == resource.data.likesCount + 1
          )
        );

        // ëŒ“ê¸€ ì‚­ì œ: ì‘ì„±ì ë˜ëŠ” êµì‚¬ë§Œ ê°€ëŠ¥
        allow delete: if request.auth != null && (
          resource.data.authorUid == request.auth.uid || isTeacher()
        );

        match /likes/{userId} {
          allow read: if request.auth != null;
          allow create, delete: if request.auth != null && request.auth.uid == userId;
        }
      }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ê·¸ ë°–ì˜ ê¸°ì¡´ ì»¬ë ‰ì…˜ ê·œì¹™ (ë³€ê²½ ì—†ìŒ)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    match /stocks/{stockId} {
      allow read: if request.auth != null;
      allow write: if isTeacher();
    }

    match /shopItems/{itemId} {
      allow read: if request.auth != null;
      allow write: if isTeacher();
    }

    match /learningProblems/{problemId} {
      allow read: if request.auth != null;
      allow write: if isTeacher();
    }

    match /lifeRules/{ruleId} {
      allow read: if request.auth != null;
      allow write: if isTeacher();
    }

    // ğŸ“š [Reading Logs]
    match /readingLogs/{logId} {
      allow read, write: if request.auth != null;
    }

    match /metadata/{docId} {
      allow read, write: if docId == 'counters' || isTeacher();
    }

    match /purchaseLog/{logId} {
      allow create: if request.auth != null;
      allow read, list: if isTeacher();
    }

    match /classes/{teacherId} {
      allow read, write: if request.auth.uid == teacherId && isTeacher();
    }

    // 'IEP ì—ì´ë‘' ì•± ê·œì¹™
    match /artifacts/{appId}/users/{userId}/{documents=**} {
      allow read, write, create, delete:
        if request.auth != null && request.auth.uid == userId;
    }

    // ìˆ™ì œ ì¦ëª… ì½”ë“œ ì‹œìŠ¤í…œ
    match /proofCodes/{codeId} {
      allow read: if isTeacher();
      allow write: if false;
    }
  }
}
